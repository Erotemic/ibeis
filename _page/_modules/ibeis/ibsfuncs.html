

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ibeis.ibsfuncs &mdash; ibeis 1.4.4 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="ibeis 1.4.4 documentation" href="../../index.html"/>
        <link rel="up" title="ibeis" href="../ibeis.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../index.html" class="fa fa-home"> ibeis</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../ibeis.html">ibeis package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../ibeis.html#subpackages">Subpackages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ibeis.html#submodules">Submodules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ibeis.html#module-ibeis.__main__">ibeis.__main__ module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ibeis.html#module-ibeis.all_imports">ibeis.all_imports module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ibeis.html#module-ibeis.constants">ibeis.constants module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ibeis.html#module-ibeis.ibsfuncs">ibeis.ibsfuncs module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ibeis.html#module-ibeis.main_module">ibeis.main_module module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ibeis.html#module-ibeis.params">ibeis.params module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ibeis.html#module-ibeis.species">ibeis.species module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ibeis.html#module-ibeis">Module contents</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ibeis</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
          <li><a href="../ibeis.html">ibeis</a> &raquo;</li>
      
    <li>ibeis.ibsfuncs</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <h1>Source code for ibeis.ibsfuncs</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">developer convenience functions for ibs</span>

<span class="sd">TODO: need to split up into sub modules:</span>
<span class="sd">    consistency_checks</span>
<span class="sd">    feasibility_fixes</span>
<span class="sd">    move the export stuff to dbio</span>

<span class="sd">    then there are also convineience functions that need to be ordered at least</span>
<span class="sd">    within this file</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">zip</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">map</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">split</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">exists</span>
<span class="c">#import vtool.image as gtool</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">utool._internal.meta_util_six</span> <span class="kn">import</span> <span class="n">get_funcname</span><span class="p">,</span> <span class="n">get_imfunc</span><span class="p">,</span> <span class="n">set_funcname</span>
<span class="c">#from vtool import linalg, geometry, image</span>
<span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">ibeis</span>
<span class="c">#from ibeis import params</span>
<span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">detecttools.pypascalmarkup</span> <span class="kn">import</span> <span class="n">PascalVOC_Markup_Annotation</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="s">&#39;COMMIT TO DETECTTOOLS&#39;</span><span class="p">)</span>
    <span class="k">pass</span>
<span class="kn">from</span> <span class="nn">ibeis.control</span> <span class="kn">import</span> <span class="n">accessor_decors</span>

<span class="c"># Inject utool functions</span>
<span class="p">(</span><span class="k">print</span><span class="p">,</span> <span class="n">print_</span><span class="p">,</span> <span class="n">printDBG</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span>
    <span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;[ibsfuncs]&#39;</span><span class="p">,</span> <span class="n">DEBUG</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="c"># Try to work around circular import</span>
<span class="c">#from ibeis.control.IBEISControl import IBEISController  # Must import class before injection</span>
<span class="n">CLASS_INJECT_KEY</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;IBEISController&#39;</span><span class="p">,</span> <span class="s">&#39;ibsfuncs&#39;</span><span class="p">)</span>
<span class="n">__injectable</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_class_method_decorator</span><span class="p">(</span><span class="n">CLASS_INJECT_KEY</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="fix_zero_features"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_zero_features">[docs]</a><span class="k">def</span> <span class="nf">fix_zero_features</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">nfeat_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_num_feats</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">haszero_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">nfeat</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">nfeat</span> <span class="ow">in</span> <span class="n">nfeat_list</span><span class="p">]</span>
    <span class="n">haszero_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">haszero_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_annot_chips</span><span class="p">(</span><span class="n">haszero_aids</span><span class="p">)</span>

</div>
<span class="nd">@ut.make_class_postinject_decorator</span><span class="p">(</span><span class="n">CLASS_INJECT_KEY</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span>
<div class="viewcode-block" id="postinject_func"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.postinject_func">[docs]</a><span class="k">def</span> <span class="nf">postinject_func</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-postinject_func</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs.delete_empty_nids()  # a test run before this forgot to do this</span>
<span class="sd">        &gt;&gt;&gt; aids_list = ibs.get_name_aids(ibs.get_valid_nids())</span>
<span class="sd">        &gt;&gt;&gt; # indirectly test postinject_func</span>
<span class="sd">        &gt;&gt;&gt; thetas_list = ibs.get_unflat_annot_thetas(aids_list)</span>
<span class="sd">        &gt;&gt;&gt; result = str(thetas_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [[0.0, 0.0], [0.0, 0.0], [0.0], [0.0], [0.0], [0.0], [0.0]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># List of getters to _unflatten</span>
    <span class="n">to_unflatten</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">flat_getter</span> <span class="ow">in</span> <span class="n">to_unflatten</span><span class="p">:</span>
        <span class="n">unflat_getter</span> <span class="o">=</span> <span class="n">_make_unflat_getter_func</span><span class="p">(</span><span class="n">flat_getter</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">inject_func_as_method</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">unflat_getter</span><span class="p">,</span> <span class="n">allow_override</span><span class="o">=</span><span class="n">ibs</span><span class="o">.</span><span class="n">allow_override</span><span class="p">)</span>
    <span class="c"># very hacky, but useful</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span> <span class="o">=</span> <span class="n">unflat_map</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="refresh"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.refresh">[docs]</a><span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">ibsfuncs</span>
    <span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">all_imports</span>
    <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">rrr</span><span class="p">()</span>
    <span class="n">all_imports</span><span class="o">.</span><span class="n">reload_all</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">rrr</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="export_to_xml"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.export_to_xml">[docs]</a><span class="k">def</span> <span class="nf">export_to_xml</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">enforce_yaw</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">target_size</span> <span class="o">=</span> <span class="mi">900</span>
    <span class="n">information</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;database_name&#39;</span> <span class="p">:</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_ibsdb</span> <span class="o">+</span> <span class="s">&#39;/LearningData/&#39;</span>
    <span class="n">imagedir</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s">&#39;JPEGImages/&#39;</span>
    <span class="n">annotdir</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s">&#39;Annotations/&#39;</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">datadir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">imagedir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">annotdir</span><span class="p">)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Exporting </span><span class="si">%d</span><span class="s"> images&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),))</span>
    <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">gid_list</span><span class="p">:</span>
        <span class="n">yawed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="n">image_uri</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uris</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fulldir</span> <span class="o">=</span> <span class="n">image_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">fulldir</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c"># NOQA</span>
            <span class="n">out_name</span> <span class="o">=</span> <span class="s">&quot;2015_</span><span class="si">%06d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">offset</span>
            <span class="n">out_img</span> <span class="o">=</span> <span class="n">out_name</span> <span class="o">+</span> <span class="s">&quot;.jpg&quot;</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="s">&quot;IBEIS&quot;</span>

            <span class="n">_image</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">_image</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">height</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="n">width</span>
                <span class="n">decrease</span> <span class="o">=</span> <span class="n">target_size</span> <span class="o">/</span> <span class="n">width</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">target_size</span>
                <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_size</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">height</span>
                <span class="n">decrease</span> <span class="o">=</span> <span class="n">target_size</span> <span class="o">/</span> <span class="n">height</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">target_size</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_size</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>

            <span class="n">dst_img</span> <span class="o">=</span> <span class="n">imagedir</span> <span class="o">+</span> <span class="n">out_img</span>
            <span class="n">_image</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">_image</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">dst_img</span><span class="p">,</span> <span class="n">_image</span><span class="p">)</span>

            <span class="n">annotation</span> <span class="o">=</span> <span class="n">PascalVOC_Markup_Annotation</span><span class="p">(</span><span class="n">dst_img</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">out_img</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">image_uri</span><span class="p">,</span> <span class="o">**</span><span class="n">information</span><span class="p">)</span>
            <span class="n">bbox_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="n">theta_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">theta</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">):</span>
                <span class="c"># Transformation matrix</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">rotation_around_bbox_mat3x3</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">bbox</span><span class="p">)</span>
                <span class="c"># Get verticies of the annotation polygon</span>
                <span class="n">verts</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">verts_from_bbox</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="c"># Rotate and transform vertices</span>
                <span class="n">xyz_pts</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">add_homogenous_coordinate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="n">trans_pts</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">remove_homogenous_coordinate</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xyz_pts</span><span class="p">))</span>
                <span class="n">new_verts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">trans_pts</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">x_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">new_verts</span><span class="p">]</span>
                <span class="n">y_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">new_verts</span><span class="p">]</span>
                <span class="n">xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">decrease</span><span class="p">)</span>
                <span class="n">xmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">decrease</span><span class="p">)</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">y_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">decrease</span><span class="p">)</span>
                <span class="n">ymax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">y_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">decrease</span><span class="p">)</span>
                <span class="c">#TODO: Change species_name to getter in IBEISControl once implemented</span>
                <span class="c">#species_name = &#39;grevys_zebra&#39;</span>
                <span class="n">species_name</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                <span class="n">yaw</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaws</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">yaw</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">yaw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">[</span><span class="s">&#39;pose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%0.6f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">yaw</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">yawed</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;UNVIEWPOINTED: </span><span class="si">%d</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">gid</span><span class="p">)</span>
                <span class="n">annotation</span><span class="o">.</span><span class="n">add_object</span><span class="p">(</span><span class="n">species_name</span><span class="p">,</span> <span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">),</span> <span class="o">**</span><span class="n">info</span><span class="p">)</span>
            <span class="n">dst_annot</span> <span class="o">=</span> <span class="n">annotdir</span> <span class="o">+</span> <span class="n">out_name</span>  <span class="o">+</span> <span class="s">&#39;.xml&#39;</span>
            <span class="c"># Write XML</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">enforce_yaw</span> <span class="ow">or</span> <span class="n">yawed</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Copying:</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">dst_img</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="p">))</span>
                <span class="n">xml_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dst_annot</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">xml_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">xml</span><span class="p">())</span>
                <span class="n">xml_data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Skipping:</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="export_to_hotspotter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.export_to_hotspotter">[docs]</a><span class="k">def</span> <span class="nf">export_to_hotspotter</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.dbio</span> <span class="kn">import</span> <span class="n">export_hsdb</span>
    <span class="n">export_hsdb</span><span class="o">.</span><span class="n">export_ibeis_to_hotspotter</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>


<span class="c">#def export_image_subset(ibs, gid_list, dst_fpath=None):</span>
<span class="c">#    dst_fpath = ut.truepath(&#39;~&#39;)</span>
<span class="c">#    #gid_list = [692, 693, 680, 781, 751, 753, 754, 755, 756]</span>
<span class="c">#    gpath_list = ibs.get_image_paths(gid_list)</span>
<span class="c">#    gname_list = [join(dst_fpath, gname) for gname in ibs.get_image_gnames(gid_list)]</span>
<span class="c">#    ut.copy_files_to(gpath_list, dst_fpath_list=gname_list)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="mark_annot_pair_as_reviewed"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.mark_annot_pair_as_reviewed">[docs]</a><span class="k">def</span> <span class="nf">mark_annot_pair_as_reviewed</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; denote that this match was reviewed and keep whatever status it is given &quot;&quot;&quot;</span>
    <span class="n">isunknown1</span><span class="p">,</span> <span class="n">isunknown2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_aid_unknown</span><span class="p">([</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">isunknown1</span> <span class="ow">or</span> <span class="n">isunknown2</span><span class="p">:</span>
        <span class="n">truth</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">TRUTH_UNKNOWN</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">((</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">))</span>
        <span class="n">truth</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">TRUTH_UNKNOWN</span> <span class="k">if</span> <span class="p">(</span><span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span><span class="p">)</span> <span class="k">else</span> <span class="n">const</span><span class="o">.</span><span class="n">TRUTH_NOT_MATCH</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">add_or_update_annotmatch</span><span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">,</span> <span class="n">truth</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">])</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="add_or_update_annotmatch"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.add_or_update_annotmatch">[docs]</a><span class="k">def</span> <span class="nf">add_or_update_annotmatch</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">,</span> <span class="n">truth</span><span class="p">,</span> <span class="n">confidence</span><span class="p">):</span>
    <span class="n">annotmatch_rowid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_rowid_from_superkey</span><span class="p">([</span><span class="n">aid1</span><span class="p">],</span> <span class="p">[</span><span class="n">aid2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c"># TODO: sql add or update?</span>
    <span class="k">if</span> <span class="n">annotmatch_rowid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_annotmatch_truth</span><span class="p">([</span><span class="n">annotmatch_rowid</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_annotmatch_confidence</span><span class="p">([</span><span class="n">annotmatch_rowid</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">add_annotmatch</span><span class="p">([</span><span class="n">aid1</span><span class="p">],</span> <span class="p">[</span><span class="n">aid2</span><span class="p">],</span> <span class="n">annotmatch_truth_list</span><span class="o">=</span><span class="p">[</span><span class="n">truth</span><span class="p">],</span> <span class="n">annotmatch_confidence_list</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">])</span>


<span class="c"># AUTOGENED CONSTANTS:</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_has_reviewed_matching_aids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_has_reviewed_matching_aids">[docs]</a><span class="k">def</span> <span class="nf">get_annot_has_reviewed_matching_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">num_reviewed_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_num_reviewed_matching_aids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">has_reviewed_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">num_reviewed</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">num_reviewed</span> <span class="ow">in</span> <span class="n">num_reviewed_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">has_reviewed_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_num_reviewed_matching_aids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_num_reviewed_matching_aids">[docs]</a><span class="k">def</span> <span class="nf">get_annot_num_reviewed_matching_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1_list</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>
<span class="sd">        eager (bool):</span>
<span class="sd">        nInput (None):</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: num_annot_reviewed_list</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_annot_num_reviewed_matching_aids</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb2&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid1_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; eager = True</span>
<span class="sd">        &gt;&gt;&gt; nInput = None</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; num_annot_reviewed_list = get_annot_num_reviewed_matching_aids(ibs, aid_list, eager, nInput)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = str(num_annot_reviewed_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_reviewed_matching_aids</span><span class="p">(</span><span class="n">aid1_list</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="n">nInput</span><span class="p">)</span>
    <span class="n">num_annot_reviewed_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">num_annot_reviewed_list</span>

</div>
<div class="viewcode-block" id="get_annotmatch_rowids_from_aid1"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annotmatch_rowids_from_aid1">[docs]</a><span class="k">def</span> <span class="nf">get_annotmatch_rowids_from_aid1</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1_list</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of the aids that were reviewed as candidate matches to the input aid</span>

<span class="sd">    aid_list = ibs.get_valid_aids()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ANNOT_ROWID1</span> <span class="o">=</span> <span class="s">&#39;annot_rowid1&#39;</span>
    <span class="n">params_iter</span> <span class="o">=</span> <span class="p">[(</span><span class="n">aid1</span><span class="p">,)</span> <span class="k">for</span> <span class="n">aid1</span> <span class="ow">in</span> <span class="n">aid1_list</span><span class="p">]</span>
    <span class="n">colnames</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;annotmatch_rowid&#39;</span><span class="p">,)</span>
    <span class="n">andwhere_colnames</span> <span class="o">=</span> <span class="p">(</span><span class="n">ANNOT_ROWID1</span><span class="p">,)</span>
    <span class="n">annotmach_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_where2</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span>
        <span class="n">andwhere_colnames</span><span class="o">=</span><span class="n">andwhere_colnames</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span> <span class="n">unpack_scalars</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="n">nInput</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">annotmach_rowid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_reviewed_matching_aids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_reviewed_matching_aids">[docs]</a><span class="k">def</span> <span class="nf">get_annot_reviewed_matching_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of the aids that were reviewed as candidate matches to the input aid</span>

<span class="sd">    aid_list = ibs.get_valid_aids()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ANNOT_ROWID1</span> <span class="o">=</span> <span class="s">&#39;annot_rowid1&#39;</span>
    <span class="n">ANNOT_ROWID2</span> <span class="o">=</span> <span class="s">&#39;annot_rowid2&#39;</span>
    <span class="c">#params_iter = [(aid, aid) for aid in aid_list]</span>
    <span class="c">#[(aid, aid) for aid in aid_list]</span>
    <span class="c">#colnames = (ANNOT_ROWID1, ANNOT_ROWID2)</span>
    <span class="c">#where_colnames = (ANNOT_ROWID1, ANNOT_ROWID2)</span>
    <span class="n">params_iter</span> <span class="o">=</span> <span class="p">[(</span><span class="n">aid</span><span class="p">,)</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">aid_list</span><span class="p">]</span>
    <span class="n">colnames</span> <span class="o">=</span> <span class="p">(</span><span class="n">ANNOT_ROWID2</span><span class="p">,)</span>
    <span class="n">andwhere_colnames</span> <span class="o">=</span> <span class="p">(</span><span class="n">ANNOT_ROWID1</span><span class="p">,)</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_where2</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span>
                                  <span class="n">params_iter</span><span class="p">,</span>
                                  <span class="n">andwhere_colnames</span><span class="o">=</span><span class="n">andwhere_colnames</span><span class="p">,</span>
                                  <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span> <span class="n">unpack_scalars</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                  <span class="n">nInput</span><span class="o">=</span><span class="n">nInput</span><span class="p">)</span>
    <span class="c">#logicop = &#39;OR&#39;</span>
    <span class="c">#aids_list = ibs.db.get_where3(</span>
    <span class="c">#    const.ANNOTMATCH_TABLE, colnames, params_iter,</span>
    <span class="c">#    where_colnames=where_colnames, logicop=logicop, eager=eager,</span>
    <span class="c">#    unpack_scalars=False, nInput=nInput)</span>
    <span class="k">return</span> <span class="n">aids_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_pair_truth"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_pair_truth">[docs]</a><span class="k">def</span> <span class="nf">get_annot_pair_truth</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1_list</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CAREFUL: uses annot match table for truth, so only works if reviews have happend</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotmatch_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_rowid_from_superkey</span><span class="p">(</span><span class="n">aid1_list</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">)</span>
    <span class="n">annotmatch_truth_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_truth</span><span class="p">(</span><span class="n">annotmatch_rowid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">annotmatch_truth_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_pair_is_reviewed"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_pair_is_reviewed">[docs]</a><span class="k">def</span> <span class="nf">get_annot_pair_is_reviewed</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1_list</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid1_list (list):</span>
<span class="sd">        aid2_list (list):</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: annotmatch_reviewed_list</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_annot_pair_is_reviewed</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb2&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; pairs = list(ut.product(aid_list, aid_list))</span>
<span class="sd">        &gt;&gt;&gt; aid1_list = ut.get_list_column(pairs, 0)</span>
<span class="sd">        &gt;&gt;&gt; aid2_list = ut.get_list_column(pairs, 1)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; annotmatch_reviewed_list = get_annot_pair_is_reviewed(ibs, aid1_list, aid2_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; reviewed_pairs = ut.list_compress(pairs, annotmatch_reviewed_list)</span>
<span class="sd">        &gt;&gt;&gt; result = len(reviewed_pairs)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        104</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flag_non_None_items</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">list_</span><span class="p">:</span> <span class="p">(</span><span class="n">item_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">item_</span> <span class="ow">in</span> <span class="n">list_</span><span class="p">)</span>
    <span class="n">annotmatch_truth_list1</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_pair_truth</span><span class="p">(</span><span class="n">aid1_list</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">)</span>
    <span class="n">annotmatch_truth_list2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_pair_truth</span><span class="p">(</span><span class="n">aid2_list</span><span class="p">,</span> <span class="n">aid1_list</span><span class="p">)</span>
    <span class="n">annotmatch_truth_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">or_lists</span><span class="p">(</span>
        <span class="n">flag_non_None_items</span><span class="p">(</span><span class="n">annotmatch_truth_list1</span><span class="p">),</span>
        <span class="n">flag_non_None_items</span><span class="p">(</span><span class="n">annotmatch_truth_list2</span><span class="p">))</span>
    <span class="c">#annotmatch_reviewed_list = [truth is not None for truth in annotmatch_truth_list]</span>
    <span class="k">return</span> <span class="n">annotmatch_truth_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_image_time_statstr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_image_time_statstr">[docs]</a><span class="k">def</span> <span class="nf">get_image_time_statstr</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">unixtime_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">utvalid_list</span>   <span class="o">=</span> <span class="p">[</span><span class="n">time</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">unixtime_list_</span><span class="p">]</span>
    <span class="n">unixtime_list</span>  <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">unixtime_list_</span><span class="p">,</span> <span class="n">utvalid_list</span><span class="p">)</span>
    <span class="n">unixtime_statstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_timestats_str</span><span class="p">(</span><span class="n">unixtime_list</span><span class="p">,</span> <span class="n">newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unixtime_statstr</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_image_annotation_bboxes"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_image_annotation_bboxes">[docs]</a><span class="k">def</span> <span class="nf">get_image_annotation_bboxes</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">bboxes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annotation_bboxes</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bboxes_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_image_annotation_thetas"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_image_annotation_thetas">[docs]</a><span class="k">def</span> <span class="nf">get_image_annotation_thetas</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">thetas_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annotation_thetas</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thetas_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="filter_junk_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_junk_annotations">[docs]</a><span class="k">def</span> <span class="nf">filter_junk_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    remove junk annotations from a list</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: filtered_aid_list</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-filter_junk_annotations</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; filtered_aid_list = filter_junk_annotations(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = str(filtered_aid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">isjunk_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_isjunk</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">filtered_aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">isjunk_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered_aid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="compute_all_chips"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_all_chips">[docs]</a><span class="k">def</span> <span class="nf">compute_all_chips</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes lazy evaluation of all chips</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] compute_all_chips&#39;</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_annot_chips</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="compute_all_features"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_all_features">[docs]</a><span class="k">def</span> <span class="nf">compute_all_features</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes lazy evaluation of all chips and features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">compute_all_chips</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] compute_all_features&#39;</span><span class="p">)</span>
    <span class="n">fid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_chip_feats</span><span class="p">(</span><span class="n">cid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="compute_all_featweights"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_all_featweights">[docs]</a><span class="k">def</span> <span class="nf">compute_all_featweights</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes lazy evaluation of all chips and features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">compute_all_features</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] compute_all_featweights&#39;</span><span class="p">)</span>
    <span class="n">featweight_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_feat_featweights</span><span class="p">(</span><span class="n">fid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">featweight_rowid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="precompute_all_annot_dependants"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.precompute_all_annot_dependants">[docs]</a><span class="k">def</span> <span class="nf">precompute_all_annot_dependants</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">compute_all_featweights</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="recompute_fgweights"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.recompute_fgweights">[docs]</a><span class="k">def</span> <span class="nf">recompute_fgweights</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; delete all feature weights and then recompute them &quot;&quot;&quot;</span>
    <span class="c"># Delete all featureweights</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
        <span class="n">featweight_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_featweight_rowids</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">featweight_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_featweight_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_featweight</span><span class="p">(</span><span class="n">featweight_rowid_list</span><span class="p">)</span>
    <span class="c">#ibs.delete_annot_featweight(aid_list)</span>
    <span class="c"># Recompute current featureweights</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_fgweights</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="ensure_annotation_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.ensure_annotation_data">[docs]</a><span class="k">def</span> <span class="nf">ensure_annotation_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">chips</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">feats</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">featweights</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">chips</span> <span class="ow">or</span> <span class="n">feats</span> <span class="ow">or</span> <span class="n">featweights</span><span class="p">:</span>
        <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_annot_chips</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">feats</span> <span class="ow">or</span> <span class="n">featweights</span><span class="p">:</span>
        <span class="n">fid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_chip_feats</span><span class="p">(</span><span class="n">cid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">featweights</span><span class="p">:</span>
        <span class="n">featweight_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_feat_featweights</span><span class="p">(</span><span class="n">fid_list</span><span class="p">)</span>  <span class="c"># NOQA</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="convert_empty_images_to_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.convert_empty_images_to_annotations">[docs]</a><span class="k">def</span> <span class="nf">convert_empty_images_to_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; images without chips are given an ANNOTATION over the entire image &quot;&quot;&quot;</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_empty_gids</span><span class="p">()</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">use_images_as_annotations</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="use_images_as_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.use_images_as_annotations">[docs]</a><span class="k">def</span> <span class="nf">use_images_as_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">name_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                              <span class="n">notes_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">adjust_percent</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adds an annotation the size of the entire image to each image.</span>
<span class="sd">    adjust_percent - shrinks the ANNOTATION by percentage on each side</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pct</span> <span class="o">=</span> <span class="n">adjust_percent</span>  <span class="c"># Alias</span>
    <span class="n">gsize_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_sizes</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="c"># Build bounding boxes as images size minus padding</span>
    <span class="n">bbox_list</span>  <span class="o">=</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span> <span class="mi">0</span> <span class="o">+</span> <span class="p">(</span><span class="n">gw</span> <span class="o">*</span> <span class="n">pct</span><span class="p">)),</span>
                   <span class="nb">int</span><span class="p">(</span> <span class="mi">0</span> <span class="o">+</span> <span class="p">(</span><span class="n">gh</span> <span class="o">*</span> <span class="n">pct</span><span class="p">)),</span>
                   <span class="nb">int</span><span class="p">(</span><span class="n">gw</span> <span class="o">-</span> <span class="p">(</span><span class="n">gw</span> <span class="o">*</span> <span class="n">pct</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span>
                   <span class="nb">int</span><span class="p">(</span><span class="n">gh</span> <span class="o">-</span> <span class="p">(</span><span class="n">gh</span> <span class="o">*</span> <span class="n">pct</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                  <span class="k">for</span> <span class="p">(</span><span class="n">gw</span><span class="p">,</span> <span class="n">gh</span><span class="p">)</span> <span class="ow">in</span> <span class="n">gsize_list</span><span class="p">]</span>
    <span class="n">theta_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gsize_list</span><span class="p">))]</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_annots</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">,</span>
                                   <span class="n">name_list</span><span class="o">=</span><span class="n">name_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="o">=</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">notes_list</span><span class="o">=</span><span class="n">notes_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="assert_valid_species_texts"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_valid_species_texts">[docs]</a><span class="k">def</span> <span class="nf">assert_valid_species_texts</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">species_list</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">isvalid_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">species</span> <span class="ow">in</span> <span class="n">const</span><span class="o">.</span><span class="n">VALID_SPECIES</span>  <span class="c"># or species == const.UNKNOWN</span>
            <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_list</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">isvalid_list</span><span class="p">),</span> <span class="s">&#39;invalid species found in </span><span class="si">%r</span><span class="s">: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">get_caller_name</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">species_list</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">),)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="n">iswarning</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iswarning</span><span class="p">:</span>
            <span class="k">raise</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="assert_singleton_relationship"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_singleton_relationship">[docs]</a><span class="k">def</span> <span class="nf">assert_singleton_relationship</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">alrids_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">alrids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">alrids</span> <span class="ow">in</span> <span class="n">alrids_list</span><span class="p">]),</span>\
            <span class="s">&#39;must only have one relationship of a type&#39;</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">parent_locals</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_parent_locals</span><span class="p">()</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;parent_locals=&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">parent_locals</span><span class="p">),</span> <span class="n">key_list</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;alrids_list&#39;</span><span class="p">,</span> <span class="p">])</span>
        <span class="k">raise</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="assert_valid_aids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_valid_aids">[docs]</a><span class="k">def</span> <span class="nf">assert_valid_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">veryverbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">valid_aids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">())</span>
    <span class="c">#invalid_aids = [aid for aid in aid_list if aid not in valid_aids]</span>
    <span class="n">isinvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">aid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_aids</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">aid_list</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">isinvalid_list</span><span class="p">),</span> <span class="s">&#39;invalid aids: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">isinvalid_list</span><span class="p">),)</span>
        <span class="n">isinvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">VALID_INT_TYPES</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">aid_list</span><span class="p">]</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">isinvalid_list</span><span class="p">),</span> <span class="s">&#39;invalidly typed aids: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">isinvalid_list</span><span class="p">),)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;dbname = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()))</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="c">#ut.embed()</span>
        <span class="k">raise</span>
    <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;passed assert_valid_aids&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="assert_images_exist"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_images_exist">[docs]</a><span class="k">def</span> <span class="nf">assert_images_exist</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;checking images exist&#39;</span><span class="p">)</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">exists_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">exists</span><span class="p">,</span> <span class="n">gpath_list</span><span class="p">))</span>
    <span class="n">bad_gids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">exists_list</span><span class="p">)</span>
    <span class="n">num_bad_gids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_gids</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">bad_gpaths</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">,</span> <span class="n">exists_list</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Bad Gpaths:&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">truncate_str</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">bad_gpaths</span><span class="p">),</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">500</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">num_bad_gids</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s"> images dont exist&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_bad_gids</span><span class="p">,)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[check] checked </span><span class="si">%d</span><span class="s"> images exist&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="assert_valid_names"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_valid_names">[docs]</a><span class="k">def</span> <span class="nf">assert_valid_names</span><span class="p">(</span><span class="n">name_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Asserts that user specified names do not conflict with</span>
<span class="sd">    the standard unknown name &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">def</span> <span class="nf">isconflict</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="n">valid_namecheck</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="n">isconflict</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">valid_namecheck</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;A name conflicts with UKNONWN Name. -- &#39;</span>
                                  <span class="s">&#39;cannot start a name with four underscores&#39;</span><span class="p">)</span>

</div>
<span class="nd">@ut.on_exception_report_input</span>
<div class="viewcode-block" id="assert_lblannot_rowids_are_type"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_lblannot_rowids_are_type">[docs]</a><span class="k">def</span> <span class="nf">assert_lblannot_rowids_are_type</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">lblannot_rowid_list</span><span class="p">,</span> <span class="n">valid_lbltype_rowid</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">lbltype_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_lblannot_lbltypes_rowids</span><span class="p">(</span><span class="n">lblannot_rowid_list</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># HACK: the unknown_lblannot_rowid will have a None type</span>
        <span class="c"># the unknown lblannot_rowid should be handled more gracefully</span>
        <span class="c"># this should just check the first condition (get rid of the or)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">assert_same_len</span><span class="p">(</span><span class="n">lbltype_rowid_list</span><span class="p">,</span> <span class="n">lbltype_rowid_list</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">assert_scalar_list</span><span class="p">(</span><span class="n">lblannot_rowid_list</span><span class="p">)</span>
        <span class="n">validtype_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">lbltype_rowid</span> <span class="o">==</span> <span class="n">valid_lbltype_rowid</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">lbltype_rowid</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">lblannot_rowid</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN_LBLANNOT_ROWID</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">lbltype_rowid</span><span class="p">,</span> <span class="n">lblannot_rowid</span> <span class="ow">in</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">lbltype_rowid_list</span><span class="p">,</span> <span class="n">lblannot_rowid_list</span><span class="p">)]</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">validtype_list</span><span class="p">),</span> <span class="s">&#39;not all types match valid type&#39;</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">tup_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lbltype_rowid_list</span><span class="p">,</span> <span class="n">lblannot_rowid_list</span><span class="p">))))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[!!!] (lbltype_rowid, lblannot_rowid) = : &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">indentjoin</span><span class="p">(</span><span class="n">tup_list</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[!!!] valid_lbltype_rowid: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">valid_lbltype_rowid</span><span class="p">,))</span>

        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;not all types match valid type&#39;</span><span class="p">,</span>
                      <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;valid_lbltype_rowid&#39;</span><span class="p">,</span> <span class="s">&#39;lblannot_rowid_list&#39;</span><span class="p">])</span>
        <span class="k">raise</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="check_image_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_image_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_image_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c"># TODO: more consistency checks</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;check image consistency. len(gid_list)=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">assert_images_exist</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)</span>
    <span class="n">image_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">image_uuid_list</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="c">#check_image_uuid_consistency(ibs, gid_list)</span>

</div>
<div class="viewcode-block" id="check_image_uuid_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_image_uuid_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_image_uuid_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks to make sure image uuids are computed detemenistically</span>
<span class="sd">    by recomputing all guuids and checking that they are equal to</span>
<span class="sd">    what is already there.</span>

<span class="sd">    VERY SLOW</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-check_image_uuid_consistency --db=PZ_Master0</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-check_image_uuid_consistency</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; # Check for very large files</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; gid_list_ = ibs.get_valid_gids()</span>
<span class="sd">        &gt;&gt;&gt; gpath_list_ = ibs.get_image_paths(gid_list_)</span>
<span class="sd">        &gt;&gt;&gt; bytes_list_ = [ut.get_file_nBytes(path) for path in gpath_list_]</span>
<span class="sd">        &gt;&gt;&gt; sortx = ut.list_argsort(bytes_list_, reverse=True)[0:10]</span>
<span class="sd">        &gt;&gt;&gt; gpath_list = ut.list_take(gpath_list_, sortx)</span>
<span class="sd">        &gt;&gt;&gt; bytes_list = ut.list_take(bytes_list_, sortx)</span>
<span class="sd">        &gt;&gt;&gt; gid_list   = ut.list_take(gid_list_, sortx)</span>
<span class="sd">        &gt;&gt;&gt; ibeis.ibsfuncs.check_image_uuid_consistency(ibs, gid_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;checking image uuid consistency&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">ibeis.model.preproc.preproc_image</span> <span class="kn">as</span> <span class="nn">preproc_image</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">guuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgressIter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">))):</span>
        <span class="n">gpath</span> <span class="o">=</span> <span class="n">gpath_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">guuid_stored</span> <span class="o">=</span> <span class="n">guuid_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">param_tup</span> <span class="o">=</span> <span class="n">preproc_image</span><span class="o">.</span><span class="n">parse_imageinfo</span><span class="p">(</span><span class="n">gpath</span><span class="p">)</span>
        <span class="n">guuid_computed</span> <span class="o">=</span> <span class="n">param_tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">guuid_stored</span> <span class="o">==</span> <span class="n">guuid_computed</span><span class="p">,</span> <span class="s">&#39;image ix=</span><span class="si">%d</span><span class="s"> had a bad uuid&#39;</span> <span class="o">%</span> <span class="n">ix</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="check_annot_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_annot_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_annot_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs      (IBEISController):</span>
<span class="sd">        aid_list (list):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-check_annot_consistency</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; result = check_annot_consistency(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># TODO: more consistency checks</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;check annot consistency. len(aid_list)=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
    <span class="n">annot_gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">num_None_annot_gids</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flag_None_items</span><span class="p">(</span><span class="n">annot_gid_list</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;num_None_annot_gids = </span><span class="si">%r</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_None_annot_gids</span><span class="p">,))</span>
    <span class="k">assert</span> <span class="n">num_None_annot_gids</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="c">#print(ut.dict_str(dict(ut.debug_duplicate_items(annot_gid_list))))</span>
    <span class="n">assert_images_exist</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">annot_gid_list</span><span class="p">)</span>
    <span class="n">unique_gids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">annot_gid_list</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;num_unique_images=</span><span class="si">%r</span><span class="s"> / </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_gids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">annot_gid_list</span><span class="p">)))</span>
    <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chip_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">cfpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_chip_fpath</span><span class="p">(</span><span class="n">cid_list</span><span class="p">)</span>
    <span class="n">valid_chip_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">cfpath</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">exists</span><span class="p">(</span><span class="n">cfpath</span><span class="p">)</span> <span class="k">for</span> <span class="n">cfpath</span> <span class="ow">in</span> <span class="n">cfpath_list</span><span class="p">]</span>
    <span class="n">invalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag</span> <span class="ow">is</span> <span class="bp">False</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">valid_chip_list</span><span class="p">]</span>
    <span class="n">invalid_cids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">cid_list</span><span class="p">,</span> <span class="n">invalid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_cids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;found </span><span class="si">%d</span><span class="s"> inconsistent chips attempting to fix&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_cids</span><span class="p">))</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_chips</span><span class="p">(</span><span class="n">invalid_cids</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">check_chip_existence</span><span class="p">(</span><span class="n">aid_list</span><span class="o">=</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">visual_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">exemplar_flag</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_exemplar_flags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">is_unknown</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_aid_unknown</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="c"># Exemplars should all be known</span>
    <span class="n">unknown_exemplar_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">exemplar_flag</span><span class="p">,</span> <span class="n">is_unknown</span><span class="p">)</span>
    <span class="n">is_error</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="n">flag</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">unknown_exemplar_flags</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">is_error</span><span class="p">),</span> <span class="s">&#39;Unknown annotations are set as exemplars&#39;</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">visual_uuid_list</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="check_name_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_name_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_name_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        nid_list (list):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-check_name_consistency</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nid_list = ibs._get_all_known_nids()</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = check_name_consistency(ibs, nid_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#aids_list = ibs.get_name_aids(nid_list)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;check name consistency. len(nid_list)=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">))</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Checking that all annotations of a name have the same species&#39;</span><span class="p">)</span>
    <span class="n">species_rowids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_rowids</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="n">error_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">aids</span><span class="p">,</span> <span class="n">sids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aids_list</span><span class="p">,</span> <span class="n">species_rowids_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_allsame</span><span class="p">(</span><span class="n">sids</span><span class="p">):</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s">&#39;aids=</span><span class="si">%r</span><span class="s"> have the same name, but belong to multiple species=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_texts</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unique_keep_order2</span><span class="p">(</span><span class="n">sids</span><span class="p">)))</span>
            <span class="k">print</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="n">error_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;A total of </span><span class="si">%d</span><span class="s"> names failed check_name_consistency&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">error_list</span><span class="p">)))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="check_name_mapping_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_name_mapping_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_name_mapping_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nx2_aids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    checks that all the aids grouped in a name ahave the same name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># DEBUGGING CODE</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">ibsfuncs</span>
        <span class="n">_nids_list</span> <span class="o">=</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">,</span> <span class="n">nx2_aids</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_allsame</span><span class="p">,</span> <span class="n">_nids_list</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="c"># THESE SHOULD BE CONSISTENT BUT THEY ARE NOT!!?</span>
        <span class="c">#name_annots = [ibs.get_annot_name_rowids(aids) for aids in nx2_aids]</span>
        <span class="n">bad</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">good</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">huh</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">nx</span><span class="p">,</span> <span class="n">aids</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nx2_aids</span><span class="p">):</span>
            <span class="n">nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="n">nids</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_allsame</span><span class="p">(</span><span class="n">nids</span><span class="p">):</span>
                    <span class="n">good</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">huh</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bad</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;good&#39;</span><span class="p">,</span> <span class="s">&#39;bad&#39;</span><span class="p">,</span> <span class="s">&#39;huh&#39;</span><span class="p">])</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="check_annot_size"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_annot_size">[docs]</a><span class="k">def</span> <span class="nf">check_annot_size</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Checking annot sizes&#39;</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">desc_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">kpts_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_kpts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">vert_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_verts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(aid_list) = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(vert_list) = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">vert_list</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(uuid_list) = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">uuid_list</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(desc_list) = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">desc_list</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(kpts_list) = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">kpts_list</span><span class="p">)))</span>

</div>
<div class="viewcode-block" id="check_exif_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_exif_data">[docs]</a><span class="k">def</span> <span class="nf">check_exif_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; TODO CALL SCRIPT &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool.exif</span> <span class="kn">as</span> <span class="nn">exif</span>
    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">mark_</span><span class="p">,</span> <span class="n">end_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">log_progress</span><span class="p">(</span><span class="s">&#39;checking exif: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">))</span>
    <span class="n">exif_dict_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">)):</span>
        <span class="n">mark_</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
        <span class="n">gpath</span> <span class="o">=</span> <span class="n">gpath_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">pil_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gpath</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">exif_dict</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">get_exif_dict</span><span class="p">(</span><span class="n">pil_img</span><span class="p">)</span>
        <span class="n">exif_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">)</span>
        <span class="c">#if len(exif_dict) &gt; 0:</span>
        <span class="c">#    break</span>

    <span class="n">has_latlon</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">exif_dict</span> <span class="ow">in</span> <span class="n">exif_dict_list</span><span class="p">:</span>
        <span class="n">latlon</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">get_lat_lon</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">latlon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">has_latlon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_latlon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s"> / </span><span class="si">%d</span><span class="s"> have gps info&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">has_latlon</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">has_latlon</span><span class="p">),))</span>

    <span class="n">key2_freq</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">num_tags_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">exif_dict</span> <span class="ow">in</span> <span class="n">exif_dict_list</span><span class="p">:</span>
        <span class="n">exif_dict2</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">make_exif_dict_human_readable</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">)</span>
        <span class="n">num_tags_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">exif_dict2</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">key2_freq</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">print_stats</span><span class="p">(</span><span class="n">num_tags_list</span><span class="p">,</span> <span class="s">&#39;num tags per image&#39;</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;tag frequency&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">key2_freq</span><span class="p">))</span>

    <span class="n">end_</span><span class="p">()</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="run_integrity_checks"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.run_integrity_checks">[docs]</a><span class="k">def</span> <span class="nf">run_integrity_checks</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">embed</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function to run all database consistency checks &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] Checking consistency&#39;</span><span class="p">)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">()</span>
    <span class="n">check_annot_size</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>
    <span class="n">check_image_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)</span>
    <span class="n">check_annot_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
    <span class="n">check_name_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>
    <span class="n">check_annotmatch_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>
    <span class="c"># Very slow check</span>
    <span class="n">check_image_uuid_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">embed</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">embed</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] Finshed consistency check&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="check_annotmatch_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_annotmatch_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_annotmatch_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">annomatch_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_annotmatch_rowids</span><span class="p">()</span>
    <span class="n">aid1_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_aid1</span><span class="p">(</span><span class="n">annomatch_rowids</span><span class="p">)</span>
    <span class="n">aid2_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_aid2</span><span class="p">(</span><span class="n">annomatch_rowids</span><span class="p">)</span>
    <span class="n">exists1_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">check_rowid_exists</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="n">aid1_list</span><span class="p">)</span>
    <span class="n">exists2_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">check_rowid_exists</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">)</span>
    <span class="n">invalid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">and_lists</span><span class="p">(</span><span class="n">exists1_list</span><span class="p">,</span> <span class="n">exists2_list</span><span class="p">))</span>
    <span class="n">invalid_annotmatch_rowids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">annomatch_rowids</span><span class="p">,</span> <span class="n">invalid_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;There are </span><span class="si">%d</span><span class="s"> invalid annotmatch rowids&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_annotmatch_rowids</span><span class="p">),))</span>
    <span class="k">return</span> <span class="n">invalid_annotmatch_rowids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="fix_invalid_annotmatches"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_invalid_annotmatches">[docs]</a><span class="k">def</span> <span class="nf">fix_invalid_annotmatches</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Fixing invalid annotmatches&#39;</span><span class="p">)</span>
    <span class="n">invalid_annotmatch_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">check_annotmatch_consistency</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_annotmatch</span><span class="p">(</span><span class="n">invalid_annotmatch_rowids</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="fix_remove_visual_dupliate_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_remove_visual_dupliate_annotations">[docs]</a><span class="k">def</span> <span class="nf">fix_remove_visual_dupliate_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    depricate because duplicate visual_uuids</span>
<span class="sd">    are no longer allowed to be duplicates</span>

<span class="sd">    Add to clean database?</span>

<span class="sd">    removes visually duplicate annotations</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;GZ_ALL&#39;)</span>
<span class="sd">        &gt;&gt;&gt; fix_remove_visual_dupliate_annotations(ibs)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">visual_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs_dup_annots</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">visual_uuid_list</span><span class="p">)</span>
    <span class="n">dupaids_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibs_dup_annots</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">dupxs</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">ibs_dup_annots</span><span class="p">):</span>
            <span class="n">aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">dupxs</span><span class="p">)</span>
            <span class="n">dupaids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aids</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="n">toremove_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">dupaids_list</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;About to delete toremove_aids=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">toremove_aids</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">are_you_sure</span><span class="p">():</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">delete_annots</span><span class="p">(</span><span class="n">toremove_aids</span><span class="p">)</span>

            <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
            <span class="n">visual_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="n">ibs_dup_annots</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">visual_uuid_list</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibs_dup_annots</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>


<span class="c">#@__injectable</span>
<span class="c">#def vacuum_and_clean_databases(ibs):</span>
<span class="c">#    # Add to duct tape? or DEPRICATE</span>
<span class="c">#    #ibs.vdd()</span>
<span class="c">#    print(ibs.db.get_table_names())</span>
<span class="c">#    # Removes all lblannots and lblannot relations as we are not using them</span>
<span class="c">#    if False:</span>
<span class="c">#        print(ibs.db.get_table_csv(const.NAME_TABLE))</span>
<span class="c">#        print(ibs.db.get_table_csv(const.ANNOTATION_TABLE))</span>
<span class="c">#        print(ibs.db.get_table_csv(const.LBLTYPE_TABLE))</span>
<span class="c">#        print(ibs.db.get_table_csv(const.LBLANNOT_TABLE))</span>
<span class="c">#        print(ibs.db.get_table_csv(const.AL_RELATION_TABLE))</span>
<span class="c">#    if False:</span>
<span class="c">#        # We deleted these all at one point, but its not a good operation to</span>
<span class="c">#        # repeat</span>
<span class="c">#        # Get old table indexes</span>
<span class="c">#        #lbltype_rowids = ibs.db.get_all_rowids(const.LBLTYPE_TABLE)</span>
<span class="c">#        lblannot_rowids = ibs.db.get_all_rowids(const.LBLANNOT_TABLE)</span>
<span class="c">#        alr_rowids = ibs.db.get_all_rowids(const.AL_RELATION_TABLE)</span>
<span class="c">#        # delete those tables</span>
<span class="c">#        #ibs.db.delete_rowids(const.LBLTYPE_TABLE, lbltype_rowids)</span>
<span class="c">#        ibs.db.delete_rowids(const.LBLANNOT_TABLE, lblannot_rowids)</span>
<span class="c">#        ibs.db.delete_rowids(const.AL_RELATION_TABLE, alr_rowids)</span>
<span class="c">#    ibs.db.vacuum()</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="fix_and_clean_database"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_and_clean_database">[docs]</a><span class="k">def</span> <span class="nf">fix_and_clean_database</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function to run all database cleanup scripts</span>

<span class="sd">    Rename to run_cleanup_scripts</span>

<span class="sd">    Break into two funcs:</span>
<span class="sd">        run_cleanup_scripts</span>
<span class="sd">        run_fixit_scripts</span>

<span class="sd">    CONSITENCY CHECKS TODO:</span>
<span class="sd">        * check that annotmatches marked as False do not have the same name for similar viewpoints.</span>
<span class="sd">        * check that photobombs are have different names</span>
<span class="sd">        * warn if scenery matches have the same name</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#TODO: Call more stuff, maybe rename to &#39;apply duct tape&#39;</span>
    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s">&#39;[FIX_AND_CLEAN]&#39;</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;starting fixes and consistency checks&#39;</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">fix_unknown_exemplars</span><span class="p">()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">fix_invalid_name_texts</span><span class="p">()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">fix_invalid_nids</span><span class="p">()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">fix_invalid_annotmatches</span><span class="p">()</span>
        <span class="n">fix_zero_features</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">update_annot_visual_uuids</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">())</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_empty_nids</span><span class="p">()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_empty_eids</span><span class="p">()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">vacuum</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;finished fixes and consistency checks</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="fix_exif_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_exif_data">[docs]</a><span class="k">def</span> <span class="nf">fix_exif_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; TODO CALL SCRIPT &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool.exif</span> <span class="kn">as</span> <span class="nn">exif</span>
    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">mark_</span><span class="p">,</span> <span class="n">end_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">log_progress</span><span class="p">(</span><span class="s">&#39;checking exif: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">))</span>
    <span class="n">exif_dict_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">)):</span>
        <span class="n">mark_</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
        <span class="n">gpath</span> <span class="o">=</span> <span class="n">gpath_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">pil_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gpath</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">exif_dict</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">get_exif_dict</span><span class="p">(</span><span class="n">pil_img</span><span class="p">)</span>
        <span class="n">exif_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">)</span>
        <span class="c">#if len(exif_dict) &gt; 0:</span>
        <span class="c">#    break</span>
    <span class="n">end_</span><span class="p">()</span>

    <span class="n">latlon_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">exif</span><span class="o">.</span><span class="n">get_lat_lon</span><span class="p">(</span><span class="n">_dict</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">_dict</span> <span class="ow">in</span> <span class="n">exif_dict_list</span><span class="p">]</span>
    <span class="n">haslatlon_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">latlon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">latlon</span> <span class="ow">in</span> <span class="n">latlon_list</span><span class="p">]</span>

    <span class="n">latlon_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">latlon_list</span><span class="p">,</span> <span class="n">haslatlon_list</span><span class="p">)</span>
    <span class="n">gid_list_</span>    <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">haslatlon_list</span><span class="p">)</span>

    <span class="n">gps_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_gps</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span>
    <span class="n">needsupdate_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gps</span> <span class="o">==</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">gps</span> <span class="ow">in</span> <span class="n">gps_list</span><span class="p">]</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s"> / </span><span class="si">%d</span><span class="s"> need gps update&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">needsupdate_list</span><span class="p">),</span>
                                       <span class="nb">len</span><span class="p">(</span><span class="n">needsupdate_list</span><span class="p">)))</span>

    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">needsupdate_list</span><span class="p">)</span>  <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">sum</span><span class="p">(</span><span class="n">needsupdate_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">needsupdate_list</span><span class="p">),</span> <span class="s">&#39;safety. remove and evaluate if hit&#39;</span>
        <span class="c">#ibs.set_image_enctext(gid_list_, [&#39;HASGPS&#39;] * len(gid_list_))</span>
        <span class="n">latlon_list__</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">latlon_list_</span><span class="p">,</span> <span class="n">needsupdate_list</span><span class="p">)</span>
        <span class="n">gid_list__</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">,</span> <span class="n">needsupdate_list</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_gps</span><span class="p">(</span><span class="n">gid_list__</span><span class="p">,</span> <span class="n">latlon_list__</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="fix_invalid_nids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_invalid_nids">[docs]</a><span class="k">def</span> <span class="nf">fix_invalid_nids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Make sure that all rowids are greater than 0</span>

<span class="sd">    We can only handle there being a name with rowid 0 if it is UNKNOWN. In this</span>
<span class="sd">    case we safely delete it, but anything more complicated needs to be handled</span>
<span class="sd">    anually</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-fix_invalid_nids</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = fix_invalid_nids(ibs)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] fixing invalid nids (nids that are &lt;= ibs.UKNOWN_NAME_ROWID)&#39;</span><span class="p">)</span>
    <span class="c"># Get actual rowids from sql database (no postprocessing)</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_known_name_rowids</span><span class="p">()</span>
    <span class="c"># Get actual names from sql database (no postprocessing)</span>
    <span class="n">name_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">apply_fix</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">is_invalid_nid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">nid</span> <span class="o">&lt;=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">UNKNOWN_NAME_ROWID</span> <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nid_list</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_invalid_nid_list</span><span class="p">):</span>
        <span class="n">invalid_nids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">is_invalid_nid_list</span><span class="p">)</span>
        <span class="n">invalid_texts</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">name_text_list</span><span class="p">,</span> <span class="n">is_invalid_nid_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_nids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span>
              <span class="n">invalid_nids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ibs</span><span class="o">.</span><span class="n">UNKNOWN_NAME_ROWID</span> <span class="ow">and</span>
              <span class="n">invalid_texts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] found bad name rowids = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">invalid_nids</span><span class="p">,))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] found bad name texts  = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">invalid_texts</span><span class="p">,))</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">delete_names</span><span class="p">([</span><span class="n">ibs</span><span class="o">.</span><span class="n">UNKNOWN_NAME_ROWID</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errmsg</span> <span class="o">=</span> <span class="s">&#39;Unfixable error: Found invalid (nid, text) pairs: &#39;</span>
            <span class="n">errmsg</span> <span class="o">+=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">invalid_nids</span><span class="p">,</span> <span class="n">invalid_texts</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="fix_invalid_name_texts"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_invalid_name_texts">[docs]</a><span class="k">def</span> <span class="nf">fix_invalid_name_texts</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Ensure  that no name text is empty or &#39;____&#39;</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-fix_invalid_names</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = fix_invalid_name_texts(ibs)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>

<span class="sd">    ibs.set_name_texts(nid_list[3], &#39;____&#39;)</span>
<span class="sd">    ibs.set_name_texts(nid_list[2], &#39;&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;checking for invalid name texts&#39;</span><span class="p">)</span>
    <span class="c"># Get actual rowids from sql database (no postprocessing)</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_known_name_rowids</span><span class="p">()</span>
    <span class="c"># Get actual names from sql database (no postprocessing)</span>
    <span class="n">name_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">apply_fix</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">invalid_name_set</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">}</span>
    <span class="n">is_invalid_name_text_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">name_text</span> <span class="ow">in</span> <span class="n">invalid_name_set</span>
                                 <span class="k">for</span> <span class="n">name_text</span> <span class="ow">in</span> <span class="n">name_text_list</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_invalid_name_text_list</span><span class="p">):</span>
        <span class="n">invalid_nids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">is_invalid_name_text_list</span><span class="p">)</span>
        <span class="n">invalid_texts</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">name_text_list</span><span class="p">,</span> <span class="n">is_invalid_name_text_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="n">invalid_nid</span><span class="p">,</span> <span class="n">invalid_text</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">invalid_nids</span><span class="p">,</span> <span class="n">invalid_texts</span><span class="p">)):</span>
            <span class="n">conflict_set</span> <span class="o">=</span> <span class="n">invalid_name_set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">apply_fix</span><span class="o">=</span><span class="bp">False</span><span class="p">)))</span>
            <span class="n">base_str</span> <span class="o">=</span> <span class="s">&#39;fixedname</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">invalid_text</span>
            <span class="n">new_text</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_nonconflicting_string</span><span class="p">(</span><span class="n">base_str</span><span class="p">,</span> <span class="n">conflict_set</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Fixing name </span><span class="si">%r</span><span class="s"> -&gt; </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">invalid_text</span><span class="p">,</span> <span class="n">new_text</span><span class="p">))</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">set_name_texts</span><span class="p">((</span><span class="n">invalid_nid</span><span class="p">,),</span> <span class="p">(</span><span class="n">new_text</span><span class="p">,))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Fixed </span><span class="si">%d</span><span class="s"> name texts&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_nids</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;all names seem valid&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="copy_encounters"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.copy_encounters">[docs]</a><span class="k">def</span> <span class="nf">copy_encounters</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        eid_list (list):</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: new_eid_list</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-copy_encounters</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs.delete_all_encounters()</span>
<span class="sd">        &gt;&gt;&gt; ibs.compute_encounters()</span>
<span class="sd">        &gt;&gt;&gt; eid_list = ibs.get_valid_eids()</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; new_eid_list = copy_encounters(ibs, eid_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = str(ibs.get_encounter_text(new_eid_list))</span>
<span class="sd">        &gt;&gt;&gt; assert [2] == list(set(map(len, ibs.get_image_eids(ibs.get_valid_gids()))))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        &gt;&gt;&gt; ibs.delete_all_encounters()</span>
<span class="sd">        &gt;&gt;&gt; ibs.compute_encounters()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_enctext_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_text</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_eids</span><span class="p">())</span>
    <span class="n">enctext_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_text</span><span class="p">(</span><span class="n">eid_list</span><span class="p">)</span>
    <span class="n">new_enctext_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">get_nonconflicting_string</span><span class="p">(</span><span class="n">enctext</span> <span class="o">+</span> <span class="s">&#39;_Copy(</span><span class="si">%d</span><span class="s">)&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_enctext_list</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">enctext</span> <span class="ow">in</span> <span class="n">enctext_list</span>
    <span class="p">]</span>
    <span class="n">new_eid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_encounters</span><span class="p">(</span><span class="n">new_enctext_list</span><span class="p">)</span>
    <span class="n">gids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_gids</span><span class="p">(</span><span class="n">eid_list</span><span class="p">)</span>
    <span class="c">#new_eid_list =</span>
    <span class="k">for</span> <span class="n">gids</span><span class="p">,</span> <span class="n">new_eid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gids_list</span><span class="p">,</span> <span class="n">new_eid_list</span><span class="p">):</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">(</span><span class="n">gids</span><span class="p">,</span> <span class="p">[</span><span class="n">new_eid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">gids</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">new_eid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="fix_unknown_exemplars"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_unknown_exemplars">[docs]</a><span class="k">def</span> <span class="nf">fix_unknown_exemplars</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Goes through all of the annotations, and sets their exemplar flag to 0 if it</span>
<span class="sd">    is associated with an unknown annotation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="c">#nid_list = ibs.get_annot_nids(aid_list, distinguish_unknowns=False)</span>
    <span class="n">flag_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_exemplar_flags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">unknown_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_aid_unknown</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="c"># Exemplars should all be known</span>
    <span class="n">unknown_exemplar_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">flag_list</span><span class="p">,</span> <span class="n">unknown_list</span><span class="p">)</span>
    <span class="n">unknown_aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">unknown_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Fixing </span><span class="si">%d</span><span class="s"> unknown annotations set as exemplars&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">unknown_exemplar_flags</span><span class="p">),))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_exemplar_flags</span><span class="p">(</span><span class="n">unknown_aid_list</span><span class="p">,</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown_aid_list</span><span class="p">))</span>
    <span class="c">#is_error = [not flag for flag in unknown_exemplar_flags]</span>
    <span class="c">#new_annots = [flag if nid != const.UNKNOWN_NAME_ROWID else 0</span>
    <span class="c">#              for nid, flag in</span>
    <span class="c">#              zip(nid_list, flag_list)]</span>
    <span class="c">#ibs.set_annot_exemplar_flags(aid_list, new_annots)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_all_recomputable_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_recomputable_data">[docs]</a><span class="k">def</span> <span class="nf">delete_all_recomputable_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete all cached data including chips and encounters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_recomputable_data&#39;</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_cachedir</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_all_chips</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_all_encounters</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_recomputable_data&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_cache"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_cache">[docs]</a><span class="k">def</span> <span class="nf">delete_cache</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">delete_chips</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">delete_encounters</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the cache directory in the database directory.</span>
<span class="sd">    Can specify to delete encoutners and chips as well.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">ensure_directories</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_cachedir</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">ensure_directories</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">delete_chips</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_all_chips</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">delete_encounters</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_all_encounters</span><span class="p">()</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_cachedir"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_cachedir">[docs]</a><span class="k">def</span> <span class="nf">delete_cachedir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the cache directory in the database directory.</span>

<span class="sd">    (does not remove chips)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_cachedir&#39;</span><span class="p">)</span>
    <span class="c"># Need to close dbcache before restarting</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">_close_sqldbcache</span><span class="p">()</span>
    <span class="n">cachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_cachedir</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] cachedir=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cachedir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete cachedir&#39;</span><span class="p">)</span>
    <span class="c"># Reinit cache</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">ensure_directories</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">_init_sqldbcache</span><span class="p">()</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_qres_cache"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_qres_cache">[docs]</a><span class="k">def</span> <span class="nf">delete_qres_cache</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete delete_qres_cache&#39;</span><span class="p">)</span>
    <span class="n">qreq_cachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_qres_cachedir</span><span class="p">()</span>
    <span class="n">qreq_bigcachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_big_cachedir</span><span class="p">()</span>
    <span class="c"># Preliminary-ensure</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">qreq_bigcachedir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">qreq_cachedir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">qreq_cachedir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">qreq_bigcachedir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="c"># Re-ensure</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">qreq_bigcachedir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">qreq_cachedir</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_qres_cache&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_all_features"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_features">[docs]</a><span class="k">def</span> <span class="nf">delete_all_features</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_features&#39;</span><span class="p">)</span>
    <span class="n">all_fids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_fids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_features</span><span class="p">(</span><span class="n">all_fids</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_features&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_all_chips"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_chips">[docs]</a><span class="k">def</span> <span class="nf">delete_all_chips</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_chips&#39;</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">chipdir</span><span class="p">)</span>
    <span class="n">all_cids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_chip_rowids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_chips</span><span class="p">(</span><span class="n">all_cids</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">chipdir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">chipdir</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_chips&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_all_encounters"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_encounters">[docs]</a><span class="k">def</span> <span class="nf">delete_all_encounters</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_encounters&#39;</span><span class="p">)</span>
    <span class="n">all_eids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_eids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_encounters</span><span class="p">(</span><span class="n">all_eids</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_encounters&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_all_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_annotations">[docs]</a><span class="k">def</span> <span class="nf">delete_all_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Carefull with this function. Annotations are not recomputable &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_annotations&#39;</span><span class="p">)</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">moves</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s">&#39;Are you sure you want to delete all annotations?&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ans</span> <span class="o">!=</span> <span class="s">&#39;yes&#39;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">all_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_aids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_annots</span><span class="p">(</span><span class="n">all_aids</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_annotations&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_thumbnails"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_thumbnails">[docs]</a><span class="k">def</span> <span class="nf">delete_thumbnails</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">remove_files_in_dir</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_thumbdir</span><span class="p">())</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_flann_cachedir"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_flann_cachedir">[docs]</a><span class="k">def</span> <span class="nf">delete_flann_cachedir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_flann_cachedir&#39;</span><span class="p">)</span>
    <span class="n">flann_cachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_flann_cachedir</span><span class="p">()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">remove_files_in_dir</span><span class="p">(</span><span class="n">flann_cachedir</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="delete_ibeis_database"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_ibeis_database">[docs]</a><span class="k">def</span> <span class="nf">delete_ibeis_database</span><span class="p">(</span><span class="n">dbdir</span><span class="p">):</span>
    <span class="n">_ibsdb</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dbdir</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">PATH_NAMES</span><span class="o">.</span><span class="n">_ibsdb</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] DELETEING: _ibsdb=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">_ibsdb</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">_ibsdb</span><span class="p">):</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">_ibsdb</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="print_flann_cachedir"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_flann_cachedir">[docs]</a><span class="k">def</span> <span class="nf">print_flann_cachedir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">flann_cachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_flann_cachedir</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">flann_cachedir</span><span class="p">)))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="vd"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.vd">[docs]</a><span class="k">def</span> <span class="nf">vd</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">view_dbdir</span><span class="p">()</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="view_dbdir"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.view_dbdir">[docs]</a><span class="k">def</span> <span class="nf">view_dbdir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">view_directory</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbdir</span><span class="p">())</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_empty_gids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_empty_gids">[docs]</a><span class="k">def</span> <span class="nf">get_empty_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns gid list without any chips &quot;&quot;&quot;</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">(</span><span class="n">eid</span><span class="o">=</span><span class="n">eid</span><span class="p">)</span>
    <span class="n">nRois_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_num_annotations</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">empty_gids</span> <span class="o">=</span> <span class="p">[</span><span class="n">gid</span> <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">nRois</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">nRois_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">nRois</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">empty_gids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_vecs_cache"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_vecs_cache">[docs]</a><span class="k">def</span> <span class="nf">get_annot_vecs_cache</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; When you have a list with duplicates and you dont want to copy data</span>
<span class="sd">    creates a reference to each data object indexed by a dict &quot;&quot;&quot;</span>
    <span class="n">unique_aids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aids</span><span class="p">))</span>
    <span class="n">unique_desc</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">(</span><span class="n">unique_aids</span><span class="p">)</span>
    <span class="n">desc_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_aids</span><span class="p">,</span> <span class="n">unique_desc</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">desc_cache</span>


<span class="c"># TODO: move to const</span>
</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_is_hard"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_is_hard">[docs]</a><span class="k">def</span> <span class="nf">get_annot_is_hard</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CmdLine:</span>
<span class="sd">        ./dev.py --cmd --db PZ_Mothers</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>
<span class="sd">        aid_list (list):</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: is_hard_list</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()[0::2]</span>
<span class="sd">        &gt;&gt;&gt; is_hard_list = get_annot_is_hard(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; result = str(is_hard_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [False, False, False, False, False, False, False]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">is_hard_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">HARD_NOTE_TAG</span> <span class="ow">in</span> <span class="n">notes</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="p">(</span><span class="n">notes</span><span class="p">)</span>
                    <span class="ow">in</span> <span class="n">notes_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">is_hard_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_hard_annot_rowids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_hard_annot_rowids">[docs]</a><span class="k">def</span> <span class="nf">get_hard_annot_rowids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">valid_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">hard_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_is_hard</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">hard_aids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_easy_annot_rowids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_easy_annot_rowids">[docs]</a><span class="k">def</span> <span class="nf">get_easy_annot_rowids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">hard_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_hard_annot_rowids</span><span class="p">()</span>
    <span class="n">easy_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff_ordered</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(),</span> <span class="n">hard_aids</span><span class="p">)</span>
    <span class="n">easy_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">easy_aids</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_has_groundtruth</span><span class="p">(</span><span class="n">easy_aids</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">easy_aids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="set_annot_is_hard"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_annot_is_hard">[docs]</a><span class="k">def</span> <span class="nf">set_annot_is_hard</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hack to mark hard cases in the notes column</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; pz_mothers_hard_aids = [27, 43, 44, 49, 50, 51, 54, 66, 89, 97]</span>
<span class="sd">        &gt;&gt;&gt; aid_list = pz_mothers_hard_aids</span>
<span class="sd">        &gt;&gt;&gt; flag_list = [True] * len(aid_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">is_hard_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">HARD_NOTE_TAG</span> <span class="ow">in</span> <span class="n">notes</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="p">(</span><span class="n">notes</span><span class="p">)</span> <span class="ow">in</span> <span class="n">notes_list</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">hack_notes</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">is_hard</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="s">&quot; Adds or removes hard tag if needed &quot;</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="ow">and</span> <span class="n">is_hard</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">flag</span> <span class="ow">or</span> <span class="n">is_hard</span><span class="p">):</span>
            <span class="c"># do nothing</span>
            <span class="k">return</span> <span class="n">notes</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_hard</span> <span class="ow">and</span> <span class="n">flag</span><span class="p">:</span>
            <span class="c"># need to add flag</span>
            <span class="k">return</span> <span class="n">const</span><span class="o">.</span><span class="n">HARD_NOTE_TAG</span> <span class="o">+</span> <span class="s">&#39; &#39;</span>  <span class="o">+</span> <span class="n">notes</span>
        <span class="k">elif</span> <span class="n">is_hard</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">:</span>
            <span class="c"># need to remove flag</span>
            <span class="k">return</span> <span class="n">notes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">HARD_NOTE_TAG</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;impossible state&#39;</span><span class="p">)</span>

    <span class="n">new_notes_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">hack_notes</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">is_hard</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span> <span class="k">for</span> <span class="n">notes</span><span class="p">,</span> <span class="n">is_hard</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">notes_list</span><span class="p">,</span> <span class="n">is_hard_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)]</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_notes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">new_notes_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">is_hard_list</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@accessor_decors.getter_1to1</span>
<div class="viewcode-block" id="is_nid_unknown"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.is_nid_unknown">[docs]</a><span class="k">def</span> <span class="nf">is_nid_unknown</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span> <span class="n">nid</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nid_list</span><span class="p">]</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="set_annot_names_to_next_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_annot_names_to_next_name">[docs]</a><span class="k">def</span> <span class="nf">set_annot_names_to_next_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">next_name</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_name</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_names</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">next_name</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<span class="k">def</span> <span class="nf">_overwrite_annot_species_to_plains</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">Species</span><span class="o">.</span><span class="n">ZEB_PLAIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)</span>


<span class="nd">@__injectable</span>
<span class="k">def</span> <span class="nf">_overwrite_annot_species_to_grevys</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">Species</span><span class="o">.</span><span class="n">ZEB_GREVY</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)</span>


<span class="nd">@__injectable</span>
<span class="k">def</span> <span class="nf">_overwrite_annot_species_to_giraffe</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">Species</span><span class="o">.</span><span class="n">GIR</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)</span>


<span class="nd">@__injectable</span>
<span class="k">def</span> <span class="nf">_overwrite_all_annot_species_to</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">species</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; THIS OVERWRITES A LOT OF INFO &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">const</span><span class="o">.</span><span class="n">VALID_SPECIES</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">species</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;is not in &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">VALID_SPECIES</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)</span>


<span class="c"># Use new invertible flatten functions</span>
<span class="n">_invertible_flatten</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">invertible_flatten2</span>
<span class="n">_unflatten</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unflatten2</span>


<div class="viewcode-block" id="unflat_map"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.unflat_map">[docs]</a><span class="k">def</span> <span class="nf">unflat_map</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">unflat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses an ibeis lookup function with a non-flat rowid list.</span>
<span class="sd">    In essence this is equivilent to map(method, unflat_rowids).</span>
<span class="sd">    The utility of this function is that it only calls method once.</span>
<span class="sd">    This is more efficient for calls that can take a list of inputs</span>

<span class="sd">    Args:</span>
<span class="sd">        method        (method):  ibeis controller method</span>
<span class="sd">        unflat_rowids (list): list of rowid lists</span>

<span class="sd">    Returns:</span>
<span class="sd">        list of values: unflat_vals</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-unflat_map</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; method = ibs.get_annot_name_rowids</span>
<span class="sd">        &gt;&gt;&gt; unflat_rowids = ibs.get_name_aids(ibs.get_valid_nids())</span>
<span class="sd">        &gt;&gt;&gt; unflat_vals = unflat_map(method, unflat_rowids)</span>
<span class="sd">        &gt;&gt;&gt; result = str(unflat_vals)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [[1, 1], [2, 2], [3], [4], [5], [6], [7]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#ut.assert_unflat_level(unflat_rowids, level=1, basetype=(int, uuid.UUID))</span>
    <span class="c"># First flatten the list, and remember the original dimensions</span>
    <span class="n">flat_rowids</span><span class="p">,</span> <span class="n">reverse_list</span> <span class="o">=</span> <span class="n">_invertible_flatten</span><span class="p">(</span><span class="n">unflat_rowids</span><span class="p">)</span>
    <span class="c"># Then preform the lookup / implicit mapping</span>
    <span class="n">flat_vals</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">flat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_vals</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_rowids</span><span class="p">),</span> <span class="p">(</span>
            <span class="s">&#39;flat lens not the same, len(flat_vals)=</span><span class="si">%d</span><span class="s"> len(flat_rowids)=</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flat_vals</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_rowids</span><span class="p">),))</span>

    <span class="c"># Then _unflatten the results to the original input dimensions</span>
    <span class="n">unflat_vals</span> <span class="o">=</span> <span class="n">_unflatten</span><span class="p">(</span><span class="n">flat_vals</span><span class="p">,</span> <span class="n">reverse_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">unflat_vals</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">unflat_rowids</span><span class="p">),</span> <span class="p">(</span>
            <span class="s">&#39;unflat lens not the same, len(unflat_vals)=</span><span class="si">%d</span><span class="s"> len(unflat_rowids)=</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unflat_vals</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">unflat_rowids</span><span class="p">),))</span>

    <span class="k">return</span> <span class="n">unflat_vals</span>

</div>
<div class="viewcode-block" id="unflat_multimap"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.unflat_multimap">[docs]</a><span class="k">def</span> <span class="nf">unflat_multimap</span><span class="p">(</span><span class="n">method_list</span><span class="p">,</span> <span class="n">unflat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; unflat_map, but allows multiple methods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># First flatten the list, and remember the original dimensions</span>
    <span class="n">flat_rowids</span><span class="p">,</span> <span class="n">reverse_list</span> <span class="o">=</span> <span class="n">_invertible_flatten</span><span class="p">(</span><span class="n">unflat_rowids</span><span class="p">)</span>
    <span class="c"># Then preform the lookup / implicit mapping</span>
    <span class="n">flat_vals_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">method</span><span class="p">(</span><span class="n">flat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">method_list</span><span class="p">]</span>
    <span class="c"># Then _unflatten the results to the original input dimensions</span>
    <span class="n">unflat_vals_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_unflatten</span><span class="p">(</span><span class="n">flat_vals</span><span class="p">,</span> <span class="n">reverse_list</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">flat_vals</span> <span class="ow">in</span> <span class="n">flat_vals_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">unflat_vals_list</span>

</div>
<span class="k">def</span> <span class="nf">_make_unflat_getter_func</span><span class="p">(</span><span class="n">flat_getter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    makes an unflat version of an ibeis getter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flat_getter</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">):</span>
        <span class="c"># Unwrap fmethods</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">get_imfunc</span><span class="p">(</span><span class="n">flat_getter</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">flat_getter</span>
    <span class="n">funcname</span> <span class="o">=</span> <span class="n">get_funcname</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">funcname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;get_&#39;</span><span class="p">),</span> <span class="s">&#39;only works on getters, not: &#39;</span> <span class="o">+</span> <span class="n">funcname</span>
    <span class="c"># Create new function</span>
    <span class="k">def</span> <span class="nf">unflat_getter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unflat_rowids</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># First flatten the list</span>
        <span class="n">flat_rowids</span><span class="p">,</span> <span class="n">reverse_list</span> <span class="o">=</span> <span class="n">_invertible_flatten</span><span class="p">(</span><span class="n">unflat_rowids</span><span class="p">)</span>
        <span class="c"># Then preform the lookup</span>
        <span class="n">flat_vals</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flat_rowids</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c"># Then _unflatten the list</span>
        <span class="n">unflat_vals</span> <span class="o">=</span> <span class="n">_unflatten</span><span class="p">(</span><span class="n">flat_vals</span><span class="p">,</span> <span class="n">reverse_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unflat_vals</span>
    <span class="n">set_funcname</span><span class="p">(</span><span class="n">unflat_getter</span><span class="p">,</span> <span class="n">funcname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;get_&#39;</span><span class="p">,</span> <span class="s">&#39;get_unflat_&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">unflat_getter</span>


<div class="viewcode-block" id="ensure_unix_gpaths"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.ensure_unix_gpaths">[docs]</a><span class="k">def</span> <span class="nf">ensure_unix_gpaths</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asserts that all paths are given with forward slashes.</span>
<span class="sd">    If not it fixes them</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#if ut.NO_ASSERTS:</span>
    <span class="c">#    return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;gpath_list must be in unix format (no backslashes).&#39;</span>
               <span class="s">&#39;Failed on </span><span class="si">%d</span><span class="s">-th gpath=</span><span class="si">%r</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">gpath</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">gpath</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">gpath</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">gpath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unixpath</span><span class="p">,</span> <span class="n">gpath_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gpath_list</span>

</div>
<div class="viewcode-block" id="aidstr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.aidstr">[docs]</a><span class="k">def</span> <span class="nf">aidstr</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Helper to make a string from an RID &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">notes</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;aid</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">name</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_names</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;aid</span><span class="si">%d</span><span class="s">-</span><span class="si">%r</span><span class="s">-</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">notes</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="vsstr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.vsstr">[docs]</a><span class="k">def</span> <span class="nf">vsstr</span><span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">lite</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">lite</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">-vs-</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">aid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;qaid</span><span class="si">%d</span><span class="s">-vs-aid</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">aid</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@ut.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_exemplar_special_encounter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_exemplar_special_encounter">[docs]</a><span class="k">def</span> <span class="nf">update_exemplar_special_encounter</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">exemplar_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">EXEMPLAR_ENCTEXT</span><span class="p">)</span>
    <span class="c">#ibs.delete_encounters(exemplar_eid)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_egr_encounter_relations</span><span class="p">(</span><span class="n">exemplar_eid</span><span class="p">)</span>
    <span class="c">#aid_list = ibs.get_valid_aids(is_exemplar=True)</span>
    <span class="c">#gid_list = ut.unique_ordered(ibs.get_annot_gids(aid_list))</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_get_exemplar_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">)))</span>
    <span class="c">#ibs.set_image_enctext(gid_list, [const.EXEMPLAR_ENCTEXT] * len(gid_list))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">exemplar_eid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@ut.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_reviewed_unreviewed_image_special_encounter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_reviewed_unreviewed_image_special_encounter">[docs]</a><span class="k">def</span> <span class="nf">update_reviewed_unreviewed_image_special_encounter</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates encounter of images that have not been reviewed</span>
<span class="sd">    and that have been reviewed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">unreviewed_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">UNREVIEWED_IMAGE_ENCTEXT</span><span class="p">)</span>
    <span class="n">reviewed_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">REVIEWED_IMAGE_ENCTEXT</span><span class="p">)</span>
    <span class="c">#ibs.delete_encounters(eid)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_egr_encounter_relations</span><span class="p">(</span><span class="n">unreviewed_eid</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_egr_encounter_relations</span><span class="p">(</span><span class="n">reviewed_eid</span><span class="p">)</span>
    <span class="c">#gid_list = ibs.get_valid_gids(reviewed=False)</span>
    <span class="c">#ibs.set_image_enctext(gid_list, [const.UNREVIEWED_IMAGE_ENCTEXT] * len(gid_list))</span>
    <span class="n">unreviewed_gids</span> <span class="o">=</span> <span class="n">_get_unreviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>  <span class="c"># hack</span>
    <span class="n">reviewed_gids</span>   <span class="o">=</span> <span class="n">_get_reviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>  <span class="c"># hack</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">(</span><span class="n">unreviewed_gids</span><span class="p">,</span> <span class="p">[</span><span class="n">unreviewed_eid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">unreviewed_gids</span><span class="p">))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">(</span><span class="n">reviewed_gids</span><span class="p">,</span> <span class="p">[</span><span class="n">reviewed_eid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">reviewed_gids</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@ut.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_all_image_special_encounter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_all_image_special_encounter">[docs]</a><span class="k">def</span> <span class="nf">update_all_image_special_encounter</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">allimg_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ALL_IMAGE_ENCTEXT</span><span class="p">)</span>
    <span class="c">#ibs.delete_encounters(allimg_eid)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="c">#ibs.set_image_enctext(gid_list, [const.ALL_IMAGE_ENCTEXT] * len(gid_list))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">allimg_eid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_special_eids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_special_eids">[docs]</a><span class="k">def</span> <span class="nf">get_special_eids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">get_enctext_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span>
    <span class="n">special_enctext_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">const</span><span class="o">.</span><span class="n">UNGROUPED_IMAGES_ENCTEXT</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ALL_IMAGE_ENCTEXT</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">UNREVIEWED_IMAGE_ENCTEXT</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">REVIEWED_IMAGE_ENCTEXT</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">EXEMPLAR_ENCTEXT</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">special_eids_</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_enctext_eid</span><span class="p">(</span><span class="n">enctext</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">enctext</span> <span class="ow">in</span> <span class="n">special_enctext_list</span><span class="p">]</span>
    <span class="n">special_eids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">special_eids_</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">special_eids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_ungrouped_gids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_ungrouped_gids">[docs]</a><span class="k">def</span> <span class="nf">get_ungrouped_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_ungrouped_gids</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs.delete_all_encounters()</span>
<span class="sd">        &gt;&gt;&gt; ibs.compute_encounters()</span>
<span class="sd">        &gt;&gt;&gt; ibs.update_special_encounters()</span>
<span class="sd">        &gt;&gt;&gt; # Now we want to remove some images from a non-special encounter</span>
<span class="sd">        &gt;&gt;&gt; nonspecial_eids = [i for i in ibs.get_valid_eids() if i not in ibs.get_special_eids()]</span>
<span class="sd">        &gt;&gt;&gt; print(&quot;Nonspecial EIDs %r&quot; % nonspecial_eids)</span>
<span class="sd">        &gt;&gt;&gt; images_to_remove = ibs.get_encounter_gids(nonspecial_eids[0:1])[0][0:1]</span>
<span class="sd">        &gt;&gt;&gt; print(&quot;Removing %r&quot; % images_to_remove)</span>
<span class="sd">        &gt;&gt;&gt; ibs.unrelate_images_and_encounters(images_to_remove,nonspecial_eids[0:1] * len(images_to_remove))</span>
<span class="sd">        &gt;&gt;&gt; ibs.update_special_encounters()</span>
<span class="sd">        &gt;&gt;&gt; ungr_eid = ibs.get_encounter_eids_from_text(const.UNGROUPED_IMAGES_ENCTEXT)</span>
<span class="sd">        &gt;&gt;&gt; print(&quot;Ungrouped gids %r&quot; % ibs.get_ungrouped_gids())</span>
<span class="sd">        &gt;&gt;&gt; print(&quot;Ungrouped eid %d contains %r&quot; % (ungr_eid, ibs.get_encounter_gids([ungr_eid])))</span>
<span class="sd">        &gt;&gt;&gt; ungr_gids = ibs.get_encounter_gids([ungr_eid])[0]</span>
<span class="sd">        &gt;&gt;&gt; assert(sorted(images_to_remove) == sorted(ungr_gids))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">special_eids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_special_eids</span><span class="p">(</span><span class="n">ibs</span><span class="p">))</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">eids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_eids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">has_eids</span> <span class="o">=</span> <span class="p">[</span><span class="n">special_eids</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">eids</span><span class="p">))</span> <span class="k">for</span> <span class="n">eids</span> <span class="ow">in</span> <span class="n">eids_list</span><span class="p">]</span>
    <span class="n">ungrouped_gids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">has_eids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ungrouped_gids</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@ut.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_ungrouped_special_encounter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_ungrouped_special_encounter">[docs]</a><span class="k">def</span> <span class="nf">update_ungrouped_special_encounter</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-update_ungrouped_special_encounter</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb9&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = update_ungrouped_special_encounter(ibs)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># FIXME SLOW</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] update_ungrouped_special_encounter.1&#39;</span><span class="p">)</span>
    <span class="n">ungrouped_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">UNGROUPED_IMAGES_ENCTEXT</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] update_ungrouped_special_encounter.2&#39;</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_egr_encounter_relations</span><span class="p">(</span><span class="n">ungrouped_eid</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] update_ungrouped_special_encounter.3&#39;</span><span class="p">)</span>
    <span class="n">ungrouped_gids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_ungrouped_gids</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] update_ungrouped_special_encounter.4&#39;</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">(</span><span class="n">ungrouped_gids</span><span class="p">,</span> <span class="p">[</span><span class="n">ungrouped_eid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ungrouped_gids</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] update_ungrouped_special_encounter.5&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@ut.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_special_encounters"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_special_encounters">[docs]</a><span class="k">def</span> <span class="nf">update_special_encounters</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">USE_MORE_SPECIAL_ENCOUNTERS</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">ensure_attr</span><span class="p">(</span><span class="s">&#39;use_more_special_encounters&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">USE_MORE_SPECIAL_ENCOUNTERS</span><span class="p">:</span>
        <span class="c">#ibs.update_reviewed_unreviewed_image_special_encounter()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">update_exemplar_special_encounter</span><span class="p">()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">update_all_image_special_encounter</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">update_ungrouped_special_encounter</span><span class="p">()</span>

</div>
<span class="k">def</span> <span class="nf">_get_unreviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># hack</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {IMAGE_TABLE}</span>
<span class="sd">        WHERE</span>
<span class="sd">        image_toggle_reviewed=0</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">const</span><span class="o">.</span><span class="n">__dict__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="k">def</span> <span class="nf">_get_reviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># hack</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {IMAGE_TABLE}</span>
<span class="sd">        WHERE</span>
<span class="sd">        image_toggle_reviewed=1</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">const</span><span class="o">.</span><span class="n">__dict__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="k">def</span> <span class="nf">_get_gids_in_eid</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid</span><span class="p">):</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {EG_RELATION_TABLE}</span>
<span class="sd">        WHERE</span>
<span class="sd">            encounter_rowid==?</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">const</span><span class="o">.</span><span class="n">__dict__</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">eid</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="k">def</span> <span class="nf">_get_dirty_reviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid</span><span class="p">):</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {EG_RELATION_TABLE}</span>
<span class="sd">        WHERE</span>
<span class="sd">            encounter_rowid==? AND</span>
<span class="sd">            image_rowid NOT IN (SELECT rowid FROM {IMAGE_TABLE} WHERE image_toggle_reviewed=1)</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">const</span><span class="o">.</span><span class="n">__dict__</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">eid</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="k">def</span> <span class="nf">_get_exemplar_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {ANNOTATION_TABLE}</span>
<span class="sd">        WHERE annot_exemplar_flag=1</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">const</span><span class="o">.</span><span class="n">__dict__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_stats"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_stats">[docs]</a><span class="k">def</span> <span class="nf">print_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.dev</span> <span class="kn">import</span> <span class="n">dbinfo</span>
    <span class="n">dbinfo</span><span class="o">.</span><span class="n">dbstats</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_dbinfo"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_dbinfo">[docs]</a><span class="k">def</span> <span class="nf">print_dbinfo</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.dev</span> <span class="kn">import</span> <span class="n">dbinfo</span>
    <span class="n">dbinfo</span><span class="o">.</span><span class="n">get_dbinfo</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">*</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_infostr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_infostr">[docs]</a><span class="k">def</span> <span class="nf">print_infostr</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_infostr</span><span class="p">())</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_annotation_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_annotation_table">[docs]</a><span class="k">def</span> <span class="nf">print_annotation_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dumps annotation table to stdout</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>
<span class="sd">        verbosity (int):</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; verbosity = 1</span>
<span class="sd">        &gt;&gt;&gt; print_annotation_table(ibs, verbosity)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exclude_columns</span> <span class="o">=</span> <span class="n">exclude_columns</span><span class="p">[:]</span>
    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;annot_uuid&#39;</span><span class="p">,</span> <span class="s">&#39;annot_verts&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="s">&#39;annot_xtl&#39;</span><span class="p">,</span> <span class="s">&#39;annot_ytl&#39;</span><span class="p">,</span> <span class="s">&#39;annot_width&#39;</span><span class="p">,</span> <span class="s">&#39;annot_height&#39;</span><span class="p">,</span>
            <span class="s">&#39;annot_theta&#39;</span><span class="p">,</span> <span class="s">&#39;annot_yaw&#39;</span><span class="p">,</span> <span class="s">&#39;annot_detect_confidence&#39;</span><span class="p">,</span>
            <span class="s">&#39;annot_note&#39;</span><span class="p">,</span> <span class="s">&#39;annot_parent_rowid&#39;</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_chip_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_chip_table">[docs]</a><span class="k">def</span> <span class="nf">print_chip_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">CHIP_TABLE</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_feat_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_feat_table">[docs]</a><span class="k">def</span> <span class="nf">print_feat_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">FEATURE_TABLE</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span>
        <span class="s">&#39;feature_keypoints&#39;</span><span class="p">,</span> <span class="s">&#39;feature_vecs&#39;</span><span class="p">]))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_image_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_image_table">[docs]</a><span class="k">def</span> <span class="nf">print_image_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="c">#, exclude_columns=[&#39;image_rowid&#39;]))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_party_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_party_table">[docs]</a><span class="k">def</span> <span class="nf">print_party_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">PARTY_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="c">#, exclude_columns=[&#39;image_rowid&#39;]))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_lblannot_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_lblannot_table">[docs]</a><span class="k">def</span> <span class="nf">print_lblannot_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps lblannot table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">LBLANNOT_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_name_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_name_table">[docs]</a><span class="k">def</span> <span class="nf">print_name_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps name table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">NAME_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_species_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_species_table">[docs]</a><span class="k">def</span> <span class="nf">print_species_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps species table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">SPECIES_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_alr_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_alr_table">[docs]</a><span class="k">def</span> <span class="nf">print_alr_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps alr table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">AL_RELATION_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_config_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_config_table">[docs]</a><span class="k">def</span> <span class="nf">print_config_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps config table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">CONFIG_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_encounter_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_encounter_table">[docs]</a><span class="k">def</span> <span class="nf">print_encounter_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps encounter table to stdout</span>

<span class="sd">    Kwargs:</span>
<span class="sd">        exclude_columns (list):</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ENCOUNTER_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_egpairs_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_egpairs_table">[docs]</a><span class="k">def</span> <span class="nf">print_egpairs_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps egpairs table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">EG_RELATION_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_tables"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_tables">[docs]</a><span class="k">def</span> <span class="nf">print_tables</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude_tables</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">exclude_columns</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">exclude_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;annot_uuid&#39;</span><span class="p">,</span> <span class="s">&#39;lblannot_uuid&#39;</span><span class="p">,</span> <span class="s">&#39;annot_verts&#39;</span><span class="p">,</span> <span class="s">&#39;feature_keypoints&#39;</span><span class="p">,</span>
                           <span class="s">&#39;feature_vecs&#39;</span><span class="p">,</span> <span class="s">&#39;image_uuid&#39;</span><span class="p">,</span> <span class="s">&#39;image_uri&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">exclude_tables</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">exclude_tables</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;masks&#39;</span><span class="p">,</span> <span class="s">&#39;recognitions&#39;</span><span class="p">,</span> <span class="s">&#39;chips&#39;</span><span class="p">,</span> <span class="s">&#39;features&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">exclude_tables</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">))</span>
    <span class="c">#ibs.print_image_table()</span>
    <span class="c">#ibs.print_annotation_table()</span>
    <span class="c">#ibs.print_lblannots_table()</span>
    <span class="c">#ibs.print_alr_table()</span>
    <span class="c">#ibs.print_config_table()</span>
    <span class="c">#ibs.print_chip_table()</span>
    <span class="c">#ibs.print_feat_table()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_contributor_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_contributor_table">[docs]</a><span class="k">def</span> <span class="nf">print_contributor_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dumps annotation table to stdout</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>
<span class="sd">        verbosity (int):</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; verbosity = 1</span>
<span class="sd">        &gt;&gt;&gt; print_contributor_table(ibs, verbosity)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exclude_columns</span> <span class="o">=</span> <span class="n">exclude_columns</span><span class="p">[:]</span>
    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;contributor_uuid&#39;</span><span class="p">]</span>
        <span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;contributor_location_city&#39;</span><span class="p">]</span>
        <span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;contributor_location_state&#39;</span><span class="p">]</span>
        <span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;contributor_location_country&#39;</span><span class="p">]</span>
        <span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;contributor_location_zip&#39;</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">CONTRIBUTOR_TABLE</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="is_aid_unknown"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.is_aid_unknown">[docs]</a><span class="k">def</span> <span class="nf">is_aid_unknown</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="make_enctext_list"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.make_enctext_list">[docs]</a><span class="k">def</span> <span class="nf">make_enctext_list</span><span class="p">(</span><span class="n">eid_list</span><span class="p">,</span> <span class="n">enc_cfgstr</span><span class="p">):</span>
    <span class="c"># DEPRICATE</span>
    <span class="n">enctext_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span> <span class="o">+</span> <span class="n">enc_cfgstr</span> <span class="k">for</span> <span class="n">eid</span> <span class="ow">in</span> <span class="n">eid_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">enctext_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="batch_rename_consecutive_via_species"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.batch_rename_consecutive_via_species">[docs]</a><span class="k">def</span> <span class="nf">batch_rename_consecutive_via_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; actually sets the new consectuive names&quot;&quot;&quot;</span>
    <span class="n">new_nid_list</span><span class="p">,</span> <span class="n">new_name_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_consecutive_newname_list_via_species</span><span class="p">(</span><span class="n">eid</span><span class="o">=</span><span class="n">eid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_conflict_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">new_nid_list</span><span class="p">,</span> <span class="n">new_name_list</span><span class="p">):</span>
        <span class="n">other_nid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_nid_list</span><span class="p">))</span>
        <span class="n">other_names</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">other_nid_list</span><span class="p">)</span>
        <span class="n">conflict_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">other_names</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new_name_list</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">conflict_names</span>

    <span class="k">def</span> <span class="nf">_assert_no_name_conflicts</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">new_nid_list</span><span class="p">,</span> <span class="n">new_name_list</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;checking for conflicting names&#39;</span><span class="p">)</span>
        <span class="n">conflit_names</span> <span class="o">=</span> <span class="n">get_conflict_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">new_nid_list</span><span class="p">,</span> <span class="n">new_name_list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">conflit_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;conflit_names=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">conflit_names</span><span class="p">,)</span>

    <span class="c"># Check to make sure new names dont conflict with other names</span>
    <span class="n">_assert_no_name_conflicts</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">new_nid_list</span><span class="p">,</span> <span class="n">new_name_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_name_texts</span><span class="p">(</span><span class="n">new_nid_list</span><span class="p">,</span> <span class="n">new_name_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">NOT_QUIET</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_consecutive_newname_list_via_species"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_consecutive_newname_list_via_species">[docs]</a><span class="k">def</span> <span class="nf">get_consecutive_newname_list_via_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Just creates the nams, but does not set them</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_consecutive_newname_list_via_species</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; eid = None</span>
<span class="sd">        &gt;&gt;&gt; new_nid_list, new_name_list = get_consecutive_newname_list_via_species(ibs, eid=eid)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.list_str((new_nid_list, new_name_list))</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        (</span>
<span class="sd">            [1, 2, 3, 4, 5, 6, 7],</span>
<span class="sd">            [&#39;IBEIS_PZ_0001&#39;, &#39;IBEIS_PZ_0002&#39;, &#39;IBEIS_UNKNOWN_0001&#39;, &#39;IBEIS_UNKNOWN_0002&#39;, &#39;IBEIS_GZ_0001&#39;, &#39;IBEIS_PB_0001&#39;, &#39;IBEIS_UNKNOWN_0003&#39;],</span>
<span class="sd">        )</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs.delete_all_encounters()</span>
<span class="sd">        &gt;&gt;&gt; ibs.compute_encounters()</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; eid = ibs.get_valid_eids()[1]</span>
<span class="sd">        &gt;&gt;&gt; new_nid_list, new_name_list = get_consecutive_newname_list_via_species(ibs, eid=eid)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.list_str((new_nid_list, new_name_list))</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        (</span>
<span class="sd">            [4, 5, 6, 7],</span>
<span class="sd">            [u&#39;IBEIS_UNKNOWN_Encounter_1_0001&#39;, u&#39;IBEIS_GZ_Encounter_1_0001&#39;, u&#39;IBEIS_PB_Encounter_1_0001&#39;, u&#39;IBEIS_UNKNOWN_Encounter_1_0002&#39;],</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] get_consecutive_newname_list_via_species&#39;</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_empty_nids</span><span class="p">()</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">(</span><span class="n">eid</span><span class="o">=</span><span class="n">eid</span><span class="p">)</span>
    <span class="c">#name_list = ibs.get_name_texts(nid_list)</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">species_rowids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_rowids</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="n">unique_species_rowids_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unique_keep_order2</span><span class="p">,</span> <span class="n">species_rowids_list</span><span class="p">))</span>
    <span class="c"># TODO: ibs.duplicate_map</span>
    <span class="n">unique_species_texts_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_species_texts</span><span class="p">,</span> <span class="n">unique_species_rowids_list</span><span class="p">)</span>
    <span class="n">species_codes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">get_species_code</span><span class="p">,</span> <span class="n">texts</span><span class="p">))</span> <span class="k">for</span> <span class="n">texts</span> <span class="ow">in</span> <span class="n">unique_species_texts_list</span><span class="p">]</span>
    <span class="n">code_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span> <span class="k">for</span> <span class="n">codes</span> <span class="ow">in</span> <span class="n">species_codes</span><span class="p">]</span>

    <span class="n">_code2_count</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_next_index</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
        <span class="n">_code2_count</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">_code2_count</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>

    <span class="n">location_text</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">location_for_names</span>
    <span class="k">if</span> <span class="n">eid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">enc_text</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_text</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
        <span class="n">enc_text</span> <span class="o">=</span> <span class="n">enc_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">new_name_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%04d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">location_text</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">enc_text</span><span class="p">,</span> <span class="n">get_next_index</span><span class="p">(</span><span class="n">code</span><span class="p">))</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">code_list</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_name_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%04d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">location_text</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">get_next_index</span><span class="p">(</span><span class="n">code</span><span class="p">))</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">code_list</span><span class="p">]</span>
    <span class="n">new_nid_list</span> <span class="o">=</span> <span class="n">nid_list</span>
    <span class="k">return</span> <span class="n">new_nid_list</span><span class="p">,</span> <span class="n">new_name_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="set_annot_names_to_same_new_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_annot_names_to_same_new_name">[docs]</a><span class="k">def</span> <span class="nf">set_annot_names_to_same_new_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">new_nid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_nids</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Setting aid_list={aid_list} to have new_nid={new_nid}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">aid_list</span><span class="o">=</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">new_nid</span><span class="o">=</span><span class="n">new_nid</span><span class="p">))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">new_nid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="set_annot_names_to_different_new_names"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_annot_names_to_different_new_names">[docs]</a><span class="k">def</span> <span class="nf">set_annot_names_to_different_new_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">new_nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_nids</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Setting aid_list={aid_list} to have new_nid_list={new_nid_list}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">aid_list</span><span class="o">=</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">new_nid_list</span><span class="o">=</span><span class="n">new_nid_list</span><span class="p">))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">new_nid_list</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="make_next_nids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.make_next_nids">[docs]</a><span class="k">def</span> <span class="nf">make_next_nids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    makes name and adds it to the database returning the newly added name rowid(s)</span>

<span class="sd">    CAUTION; changes database state</span>

<span class="sd">    SeeAlso:</span>
<span class="sd">        make_next_name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">next_names</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_name</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">next_nids</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_names</span><span class="p">(</span><span class="n">next_names</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">next_nids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="make_next_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.make_next_name">[docs]</a><span class="k">def</span> <span class="nf">make_next_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">str_format</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">species_text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">location_text</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Creates a number of names which are not in the database, but does not</span>
<span class="sd">    add them</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        num (None):</span>
<span class="sd">        str_format (int): either 1 or 2</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: next_name</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-make_next_name</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs1 = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs2 = ibeis.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs3 = ibeis.opendb(&#39;NAUT_test&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #ibs5 = ibeis.opendb(&#39;GIR_Tanya&#39;)</span>
<span class="sd">        &gt;&gt;&gt; num = None</span>
<span class="sd">        &gt;&gt;&gt; str_format = 2</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; next_name1 = make_next_name(ibs1, num, str_format)</span>
<span class="sd">        &gt;&gt;&gt; next_name2 = make_next_name(ibs2, num, str_format)</span>
<span class="sd">        &gt;&gt;&gt; next_name3 = make_next_name(ibs3, num, str_format)</span>
<span class="sd">        &gt;&gt;&gt; next_name4 = make_next_name(ibs1, num, str_format, const.Species.ZEB_GREVY)</span>
<span class="sd">        &gt;&gt;&gt; name_list = [next_name1, next_name2, next_name3, next_name4]</span>
<span class="sd">        &gt;&gt;&gt; next_name_list1 = make_next_name(ibs2, 5, str_format)</span>
<span class="sd">        &gt;&gt;&gt; temp_nids = ibs2.add_names([&#39;IBEIS_PZ_0045&#39;, &#39;IBEIS_PZ_0048&#39;])</span>
<span class="sd">        &gt;&gt;&gt; next_name_list2 = make_next_name(ibs2, 5, str_format)</span>
<span class="sd">        &gt;&gt;&gt; ibs2.delete_names(temp_nids)</span>
<span class="sd">        &gt;&gt;&gt; next_name_list3 = make_next_name(ibs2, 5, str_format)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; # FIXME: nautiluses are not working right</span>
<span class="sd">        &gt;&gt;&gt; result = ut.list_str((name_list, next_name_list1, next_name_list2, next_name_list3))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        (</span>
<span class="sd">            [&#39;IBEIS_UNKNOWN_0008&#39;, &#39;IBEIS_PZ_0042&#39;, &#39;IBEIS_GZ_0004&#39;, &#39;IBEIS_GZ_0008&#39;],</span>
<span class="sd">            [&#39;IBEIS_PZ_0042&#39;, &#39;IBEIS_PZ_0043&#39;, &#39;IBEIS_PZ_0044&#39;, &#39;IBEIS_PZ_0045&#39;, &#39;IBEIS_PZ_0046&#39;],</span>
<span class="sd">            [&#39;IBEIS_PZ_0044&#39;, &#39;IBEIS_PZ_0046&#39;, &#39;IBEIS_PZ_0047&#39;, &#39;IBEIS_PZ_0049&#39;, &#39;IBEIS_PZ_0050&#39;],</span>
<span class="sd">            [&#39;IBEIS_PZ_0042&#39;, &#39;IBEIS_PZ_0043&#39;, &#39;IBEIS_PZ_0044&#39;, &#39;IBEIS_PZ_0045&#39;, &#39;IBEIS_PZ_0046&#39;],</span>
<span class="sd">        )</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># HACK TO FORCE TIMESTAMPS FOR NEW NAMES</span>
    <span class="c">#str_format = 1</span>
    <span class="k">if</span> <span class="n">species_text</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># TODO: optionally specify qreq_ or qparams?</span>
        <span class="n">species_text</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">detect_cfg</span><span class="o">.</span><span class="n">species_text</span>
    <span class="k">if</span> <span class="n">location_text</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">location_text</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">location_for_names</span>
    <span class="k">if</span> <span class="n">num</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">num_</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_</span> <span class="o">=</span> <span class="n">num</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_known_name_rowids</span><span class="p">()</span>
    <span class="n">names_used_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">nid_list</span><span class="p">))</span>
    <span class="n">base_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">next_name_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_name_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_</span><span class="p">:</span>
        <span class="n">base_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">str_format</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">userid</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_user_name</span><span class="p">()</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">(</span><span class="s">&#39;tag&#39;</span><span class="p">)</span>
            <span class="c">#timestamp_suffix = &#39;_TMP_&#39;</span>
            <span class="n">timestamp_suffix</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span>
            <span class="n">timestamp_prefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">name_prefix</span> <span class="o">=</span> <span class="n">timestamp_prefix</span> <span class="o">+</span> <span class="n">timestamp</span> <span class="o">+</span> <span class="n">timestamp_suffix</span> <span class="o">+</span> <span class="n">userid</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span>
        <span class="k">elif</span> <span class="n">str_format</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">species_code</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">get_species_code</span><span class="p">(</span><span class="n">species_text</span><span class="p">)</span>
            <span class="n">name_prefix</span> <span class="o">=</span> <span class="n">location_text</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">species_code</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Invalid str_format supplied&#39;</span><span class="p">)</span>
        <span class="n">next_name</span> <span class="o">=</span> <span class="n">name_prefix</span> <span class="o">+</span> <span class="s">&#39;</span><span class="si">%04d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">base_index</span>
        <span class="k">if</span> <span class="n">next_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names_used_list</span><span class="p">:</span>
            <span class="c">#names_used_list.add(next_name)</span>
            <span class="n">next_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_name</span><span class="p">)</span>
    <span class="c"># Return a list or a string</span>
    <span class="k">if</span> <span class="n">num</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">next_name_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">next_name_list</span>

</div>
<div class="viewcode-block" id="hack"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.hack">[docs]</a><span class="k">def</span> <span class="nf">hack</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c">#ibs.get_encounter_text(eid_list)</span>
    <span class="c">#eid = ibs.get_encounter_eids_from_text(&quot;NNP GZC Car &#39;1PURPLE&#39;&quot;)</span>

    <span class="k">def</span> <span class="nf">get_name_linked_encounters_by_eid</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
        <span class="c">#gid_list = ibs.get_encounter_gids(eid)</span>
        <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_aids</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_aid_unknown</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">))</span>

        <span class="c">#all(ibs.db.check_rowid_exists(const.ANNOTATION_TABLE, aid_list))</span>
        <span class="c">#aids_list2 = ibs.get_image_aids(gid_list)</span>
        <span class="c">#assert ut.flatten(aids_list2) == aids_list1</span>
        <span class="n">nid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="bp">False</span><span class="p">)))</span>
        <span class="c"># remove unknown annots</span>
        <span class="n">name_eids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_eids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
        <span class="n">name_enctexts</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_text</span><span class="p">(</span><span class="n">name_eids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name_enctexts</span>

    <span class="n">eid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_eids</span><span class="p">()</span>
    <span class="n">linked_enctexts</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_name_linked_encounters_by_eid</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid</span><span class="p">)</span> <span class="k">for</span> <span class="n">eid</span> <span class="ow">in</span> <span class="n">eid_list</span><span class="p">]</span>
    <span class="n">enctext_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_text</span><span class="p">(</span><span class="n">eid_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">eid_list</span><span class="p">,</span> <span class="n">linked_enctexts</span><span class="p">))))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">enctext_list</span><span class="p">,</span> <span class="n">linked_enctexts</span><span class="p">))),</span> <span class="s">&#39;:&#39;</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">enctext_list</span><span class="p">,</span> <span class="n">eid_list</span><span class="p">)),</span> <span class="n">sorted_</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="s">&#39;:&#39;</span><span class="p">))</span>

    <span class="c">#if False:</span>
    <span class="c">#    eids_with_bad_names = [6, 7, 16]</span>
    <span class="c">#    bad_nids = ut.unique_keep_order2(ut.flatten(ibs.get_encounter_nids(eids_with_bad_names)))</span>

</div>
<div class="viewcode-block" id="draw_thumb_helper"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.draw_thumb_helper">[docs]</a><span class="k">def</span> <span class="nf">draw_thumb_helper</span><span class="p">(</span><span class="n">tup</span><span class="p">):</span>
    <span class="n">thumb_path</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">,</span> <span class="n">gpath</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span> <span class="o">=</span> <span class="n">tup</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">gpath</span><span class="p">)</span>  <span class="c"># time consuming</span>
    <span class="p">(</span><span class="n">gh</span><span class="p">,</span> <span class="n">gw</span><span class="p">)</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">img_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">gw</span><span class="p">,</span> <span class="n">gh</span><span class="p">)</span>
    <span class="n">max_dsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">thumbsize</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">)</span>
    <span class="n">dsize</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">resized_clamped_thumb_dims</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">max_dsize</span><span class="p">)</span>
    <span class="n">new_verts_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">scaled_verts_from_bbox_gen</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">))</span>
    <span class="c">#thumb = vt.resize_thumb(img, max_dsize)</span>
    <span class="c"># -----------------</span>
    <span class="c"># Actual computation</span>
    <span class="n">thumb</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dsize</span><span class="p">)</span>
    <span class="n">orange_bgr</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">new_verts</span> <span class="ow">in</span> <span class="n">new_verts_list</span><span class="p">:</span>
        <span class="n">thumb</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">draw_verts</span><span class="p">(</span><span class="n">thumb</span><span class="p">,</span> <span class="n">new_verts</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">orange_bgr</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">,</span> <span class="n">thumb</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#return (thumb_path, thumb)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="preprocess_image_thumbs"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.preprocess_image_thumbs">[docs]</a><span class="k">def</span> <span class="nf">preprocess_image_thumbs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                            <span class="n">draw_annots</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">thumbsize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes thumbs of images in parallel based on kwargs &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">thumbsize</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_thumbsize</span><span class="p">(</span><span class="n">thumbsize</span><span class="p">,</span> <span class="n">draw_annots</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] preprocess_image_thumbs(use_cache=</span><span class="si">%r</span><span class="s">, thumbsize=</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">use_cache</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">))</span>
    <span class="n">thumbpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_thumbpath_</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span>
                                              <span class="n">draw_annots</span><span class="o">=</span><span class="n">draw_annots</span><span class="p">,</span>
                                              <span class="n">thumbsize</span><span class="o">=</span><span class="n">thumbsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
        <span class="c"># Filter out paths gids that already have existing thumb paths</span>
        <span class="n">exists_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">exists</span><span class="p">,</span> <span class="n">thumbpath_list</span><span class="p">))</span>
        <span class="n">gid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">exists_list</span><span class="p">)</span>
        <span class="n">thumbpath_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">thumbpath_list</span><span class="p">,</span> <span class="n">exists_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gid_list_</span> <span class="o">=</span> <span class="n">gid_list</span>
        <span class="n">thumbpath_list_</span> <span class="o">=</span> <span class="n">thumbpath_list</span>

    <span class="n">compute_image_thumbs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list_</span><span class="p">,</span> <span class="n">thumbpath_list_</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">,</span> <span class="n">draw_annots</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thumbpath_list</span>

</div>
<div class="viewcode-block" id="compute_image_thumbs"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_image_thumbs">[docs]</a><span class="k">def</span> <span class="nf">compute_image_thumbs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list_</span><span class="p">,</span> <span class="n">thumbpath_list_</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">,</span> <span class="n">draw_annots</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parallel work function. Computes image thumbnails. Overwrites anything that exists.</span>
<span class="sd">    Does not use any caching</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">draw_annots</span><span class="p">:</span>
        <span class="n">bboxes_list</span> <span class="o">=</span> <span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
        <span class="n">thetas_list</span> <span class="o">=</span> <span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bboxes_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list</span> <span class="p">]</span>
        <span class="n">thetas_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list</span> <span class="p">]</span>
    <span class="n">args_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">thumb_path</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">,</span> <span class="n">gpath</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">thumb_path</span><span class="p">,</span> <span class="n">gpath</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span> <span class="ow">in</span>
                 <span class="nb">zip</span><span class="p">(</span><span class="n">thumbpath_list_</span><span class="p">,</span> <span class="n">gpath_list</span><span class="p">,</span> <span class="n">bboxes_list</span><span class="p">,</span> <span class="n">thetas_list</span><span class="p">)]</span>

    <span class="c"># Execute all tasks in parallel</span>
    <span class="n">genkw</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;ordered&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&#39;chunksize&#39;</span><span class="p">:</span> <span class="n">chunksize</span><span class="p">,</span>
        <span class="c">#&#39;force_serial&#39;: True,</span>
    <span class="p">}</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">draw_thumb_helper</span><span class="p">,</span> <span class="n">args_list</span><span class="p">,</span> <span class="n">nTasks</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">args_list</span><span class="p">),</span> <span class="o">**</span><span class="n">genkw</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">evaluate_generator</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="group_annots_by_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.group_annots_by_name">[docs]</a><span class="k">def</span> <span class="nf">group_annots_by_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    This function is probably the fastest of its siblings</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (list):</span>
<span class="sd">        distinguish_unknowns (bool):</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: grouped_aids_, unique_nids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-group_annots_by_name</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; distinguish_unknowns = True</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; grouped_aids_, unique_nids = group_annots_by_name(ibs, aid_list, distinguish_unknowns)</span>
<span class="sd">        &gt;&gt;&gt; result = str([aids.tolist() for aids in grouped_aids_])</span>
<span class="sd">        &gt;&gt;&gt; result += &#39;\n&#39; + str(unique_nids.tolist())</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [[11], [9], [4], [1], [2, 3], [5, 6], [7], [8], [10], [12], [13]]</span>
<span class="sd">        [-11, -9, -4, -1, 1, 2, 3, 4, 5, 6, 7]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="n">distinguish_unknowns</span><span class="p">))</span>
    <span class="n">unique_nids</span><span class="p">,</span> <span class="n">groupxs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">grouped_aids_</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="n">groupxs_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">grouped_aids_</span><span class="p">,</span> <span class="n">unique_nids</span>

</div>
<div class="viewcode-block" id="group_annots_by_known_names_nochecks"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.group_annots_by_known_names_nochecks">[docs]</a><span class="k">def</span> <span class="nf">group_annots_by_known_names_nochecks</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">nid2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">nid2_aids</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="group_annots_by_known_names"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.group_annots_by_known_names">[docs]</a><span class="k">def</span> <span class="nf">group_annots_by_known_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">checks</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    FIXME; rectify this</span>
<span class="sd">    #&gt;&gt;&gt; import ibeis  # NOQA</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-group_annots_by_known_names</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(db=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13]</span>
<span class="sd">        &gt;&gt;&gt; known_aids_list, unknown_aids = group_annots_by_known_names(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; result = str(known_aids_list) + &#39;\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; result += str(unknown_aids)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [[2, 3], [5, 6], [7], [8], [10], [12], [13]]</span>
<span class="sd">        [11, 9, 4, 1]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">nid2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>
    <span class="n">aid_gen</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">)</span>
    <span class="n">isunknown_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">))</span>
    <span class="n">known_aids_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ifilterfalse_items</span><span class="p">(</span><span class="n">aid_gen</span><span class="p">(),</span> <span class="n">isunknown_list</span><span class="p">))</span>
    <span class="n">unknown_aids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iflatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ifilter_items</span><span class="p">(</span><span class="n">aid_gen</span><span class="p">(),</span> <span class="n">isunknown_list</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
        <span class="c"># References:</span>
        <span class="c">#     http://stackoverflow.com/questions/482014/how-would-you-do-the-equivalent-of-preprocessor-directives-in-python</span>
        <span class="n">nidgroup_list</span> <span class="o">=</span> <span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">,</span> <span class="n">known_aids_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nidgroup</span> <span class="ow">in</span> <span class="n">nidgroup_list</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_allsame</span><span class="p">(</span><span class="n">nidgroup</span><span class="p">),</span> <span class="s">&#39;bad name grouping&#39;</span>
    <span class="k">return</span> <span class="n">known_aids_list</span><span class="p">,</span> <span class="n">unknown_aids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_upsize_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_upsize_data">[docs]</a><span class="k">def</span> <span class="nf">get_upsize_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">num_samp</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">clamp_gt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">clamp_gf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns qaids and a corresponding list of lists for true matches and false</span>
<span class="sd">    matches to try.</span>

<span class="sd">    each item in the zip(*upsizetup) is qaid, true_aids, false_aids_samples</span>
<span class="sd">    which corresponds to a query aid and a list of true aids and false aids</span>
<span class="sd">    to try it as a query against.</span>

<span class="sd">    get_upsize_data</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>
<span class="sd">        qaid_list (int): query annotation id</span>
<span class="sd">        daid_list (list):</span>
<span class="sd">        num_samp (int):</span>
<span class="sd">        clamp_gt (int):</span>
<span class="sd">        clamp_gf (int):</span>
<span class="sd">        seed (int): if False seed is random else seeds numpy random num gen</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: upsizetup</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_upsize_data</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; qaid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; daid_list = None</span>
<span class="sd">        &gt;&gt;&gt; num_samp = 5</span>
<span class="sd">        &gt;&gt;&gt; clamp_gt = 1</span>
<span class="sd">        &gt;&gt;&gt; clamp_gf = 1</span>
<span class="sd">        &gt;&gt;&gt; seed = 143039</span>
<span class="sd">        &gt;&gt;&gt; upsizetup = get_upsize_data(ibs, qaid_list, daid_list, num_samp, clamp_gt, clamp_gf, seed)</span>
<span class="sd">        &gt;&gt;&gt; (qaid_list, qaid_trues_list, qaid_false_samples_list, nTotal) = upsizetup</span>
<span class="sd">        &gt;&gt;&gt; ut.assert_eq(len(qaid_list), 119, var1_name=&#39;len(qaid_list)&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ut.assert_eq(len(qaid_trues_list), 119, var1_name=&#39;len(qaid_trues_list)&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ut.assert_eq(len(qaid_false_samples_list), 119, var1_name=&#39;len(qaid_false_samples_list)&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ut.assert_eq(nTotal, 525, var1_name=&#39;nTotal&#39;)</span>
<span class="sd">        &gt;&gt;&gt; qaid, true_aids, false_aids_samples = six.next(zip(qaid_list, qaid_trues_list, qaid_false_samples_list))</span>
<span class="sd">        &gt;&gt;&gt; result = ut.hashstr(str(upsizetup))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        objl8qnhyics@0cr</span>

<span class="sd">    b9lvi3nz&amp;ld9u8rg</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
        <span class="c"># Determanism</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">daid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">daid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="c"># List of database sizes to test</span>
    <span class="n">samp_min</span><span class="p">,</span> <span class="n">samp_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_num_names</span><span class="p">())</span>
    <span class="n">dbsamplesize_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sample_domain</span><span class="p">(</span><span class="n">samp_min</span><span class="p">,</span> <span class="n">samp_max</span><span class="p">,</span> <span class="n">num_samp</span><span class="p">)</span>
    <span class="c">#</span>
    <span class="c"># Sample true and false matches for every query annotation</span>
    <span class="n">qaid_trues_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_groundtruth_sample</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">per_name</span><span class="o">=</span><span class="n">clamp_gt</span><span class="p">,</span> <span class="n">isexemplar</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">qaid_falses_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_groundfalse_sample</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">per_name</span><span class="o">=</span><span class="n">clamp_gf</span><span class="p">)</span>
    <span class="c">#</span>
    <span class="c"># Vary the size of the falses</span>
    <span class="k">def</span> <span class="nf">generate_varied_falses</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">false_aids</span> <span class="ow">in</span> <span class="n">qaid_falses_list</span><span class="p">:</span>
            <span class="n">false_sample_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">dbsize</span> <span class="ow">in</span> <span class="n">dbsamplesize_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dbsize</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">false_aids</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">false_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">false_aids</span><span class="p">,</span> <span class="n">dbsize</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">false_sample_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">false_sample</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">false_sample_list</span>
    <span class="n">qaid_false_samples_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">generate_varied_falses</span><span class="p">())</span>

    <span class="c">#</span>
    <span class="c"># Get a rough idea of how many queries will be run</span>
    <span class="n">nTotal</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">false_aids_samples</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_aids</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">true_aids</span><span class="p">,</span> <span class="n">false_aids_samples</span>
                  <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qaid_false_samples_list</span><span class="p">,</span> <span class="n">qaid_trues_list</span><span class="p">)])</span>
    <span class="n">upsizetup</span> <span class="o">=</span> <span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">qaid_trues_list</span><span class="p">,</span> <span class="n">qaid_false_samples_list</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">upsizetup</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_rowid_sample"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_rowid_sample">[docs]</a><span class="k">def</span> <span class="nf">get_annot_rowid_sample</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">per_name</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_ngt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                           <span class="n">stagger_names</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Gets a sampling of annotations</span>

<span class="sd">    Args:</span>
<span class="sd">        per_name (int): number of annotations per name</span>
<span class="sd">        min_ngt (int): any name with less than this number of annotation is filtered out</span>
<span class="sd">        seed (int): random seed</span>
<span class="sd">        aid_list (list): base aid_list to start with. If None</span>
<span class="sd">        get_valid_aids(nojunk=True) is used stagger_names (bool): if True</span>
<span class="sd">        staggers the order of the returned sample</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: sample_aids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_annot_rowid_sample</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; per_name = 3</span>
<span class="sd">        &gt;&gt;&gt; min_ngt = 2</span>
<span class="sd">        &gt;&gt;&gt; seed = 0</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; sample_aid_list = ibs.get_annot_rowid_sample(per_name, min_ngt, seed)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.hashstr_arr(sample_aid_list)</span>
<span class="sd">        arr((66)crj9l5jde@@hdmlp)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#qaids = ibs.get_easy_annot_rowids()</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">nojunk</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
    <span class="n">grouped_aids_</span><span class="p">,</span> <span class="n">unique_nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="n">distinguish_unknowns</span><span class="p">)</span>
    <span class="n">grouped_aids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_ngt</span><span class="p">,</span> <span class="n">grouped_aids_</span><span class="p">))</span>
    <span class="n">sample_aids_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sample_lists</span><span class="p">(</span><span class="n">grouped_aids</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">per_name</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stagger_names</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="n">zip_longest</span>
        <span class="n">sample_aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_Nones</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iflatten</span><span class="p">(</span><span class="n">zip_longest</span><span class="p">(</span><span class="o">*</span><span class="n">sample_aids_list</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sample_aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">sample_aids_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sample_aid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_groundfalse_sample"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_groundfalse_sample">[docs]</a><span class="k">def</span> <span class="nf">get_annot_groundfalse_sample</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">per_name</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get_annot_groundfalse_sample</span>

<span class="sd">    FIXME</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>
<span class="sd">        aid_list (list):</span>
<span class="sd">        per_name (int): number of groundfalse per name</span>
<span class="sd">        seed (bool or int): if False no seed, otherwise seeds numpy randgen</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: gf_aids_list</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()[::4]</span>
<span class="sd">        &gt;&gt;&gt; per_name = 1</span>
<span class="sd">        &gt;&gt;&gt; seed = 42</span>
<span class="sd">        &gt;&gt;&gt; sample_trues_list = get_annot_groundfalse_sample(ibs, aid_list, per_name, seed)</span>
<span class="sd">        &gt;&gt;&gt; #result = str(sample_trues_list)</span>
<span class="sd">        &gt;&gt;&gt; #print(result)</span>

<span class="sd">    [[3, 5, 7, 8, 10, 12, 13], [3, 7, 8, 10, 12, 13], [3, 6, 7, 8, 10, 12, 13], [2, 6, 7, 8, 10, 12]]</span>
<span class="sd">    [[2, 6, 7, 8, 10, 12, 13], [2, 7, 8, 10, 12, 13], [2, 5, 7, 8, 10, 12, 13], [2, 6, 7, 8, 10, 12]]</span>
<span class="sd">    [[2, 5, 7, 8, 10, 12, 13], [3, 7, 8, 10, 12, 13], [2, 5, 7, 8, 10, 12, 13], [3, 5, 7, 8, 10, 12]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
        <span class="c"># Determanism</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="c"># Get valid names</span>
    <span class="n">valid_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">valid_nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">)</span>
    <span class="n">nid2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">,</span> <span class="n">valid_nids</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nid2_aids</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">nid</span><span class="p">):</span>
            <span class="c"># Remove unknown</span>
            <span class="k">del</span> <span class="n">nid2_aids</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="c"># Cast into numpy arrays</span>
        <span class="n">aids</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">[</span><span class="n">nid</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Remove empties</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] name with 0 aids. need to clean database&#39;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">nid2_aids</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="n">nid2_aids</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">aids</span>
        <span class="c"># Shuffle known annotations in each name</span>
        <span class="c">#np.random.shuffle(aids)</span>
    <span class="c"># Get not beloning to input names</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sample</span><span class="p">(</span><span class="n">nid_</span><span class="p">):</span>
        <span class="n">aids_iter</span> <span class="o">=</span> <span class="p">(</span><span class="n">aids</span> <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">)</span> <span class="k">if</span> <span class="n">nid</span> <span class="o">!=</span> <span class="n">nid_</span><span class="p">)</span>
        <span class="n">sample_gf_aids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">per_name</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_iter</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">sample_gf_aids</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">gf_aids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_sample</span><span class="p">(</span><span class="n">nid_</span><span class="p">)</span> <span class="k">for</span> <span class="n">nid_</span> <span class="ow">in</span> <span class="n">nid_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">gf_aids_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_groundtruth_sample"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_groundtruth_sample">[docs]</a><span class="k">def</span> <span class="nf">get_annot_groundtruth_sample</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">per_name</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isexemplar</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    get_annot_groundtruth_sample</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>
<span class="sd">        aid_list (list):</span>
<span class="sd">        per_name (int):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_annot_groundtruth_sample --verbose-class</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_annot_groundtruth_sample:1</span>

<span class="sd">    Example0:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()[::2]</span>
<span class="sd">        &gt;&gt;&gt; per_name = 1</span>
<span class="sd">        &gt;&gt;&gt; result = get_annot_groundtruth_sample(ibs, aid_list, per_name)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [[], [2], [6], [], [], [], []]</span>

<span class="sd">    Example2:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(ut.get_argval(&#39;--db&#39;, str, &#39;testdb1&#39;))</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; per_name = 1</span>
<span class="sd">        &gt;&gt;&gt; result = get_annot_groundtruth_sample(ibs, aid_list, per_name)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_trues_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_groundtruth</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">noself</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">is_exemplar</span><span class="o">=</span><span class="n">isexemplar</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">random_choice</span><span class="p">(</span><span class="n">aids</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="n">per_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">sample_trues_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">random_choice</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">all_trues_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sample_trues_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_one_annot_per_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_one_annot_per_name">[docs]</a><span class="k">def</span> <span class="nf">get_one_annot_per_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;rand&#39;</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_one_annot_per_name --db PZ_Master0</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_one_annot_per_name --db PZ_MTEST</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_one_annot_per_name --dbdir /raid/work2/Turk/GIR_Master</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = get_one_annot_per_name(ibs)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#nid_list = ibs.get_valid_nids()</span>
    <span class="c">#aids_list = ibs.get_name_aids(nid_list)</span>
    <span class="c">#num_annots_list = list(map(len, aids_list))</span>
    <span class="c">#aids_list = ut.sortedby(aids_list, num_annots_list, reverse=True)</span>
    <span class="c">#aid_list = ut.get_list_column(aids_list, 0)</span>
    <span class="c"># Keep only a certain number of annots for distinctiveness mapping</span>
    <span class="c">#aid_list_ = ut.listclip(aid_list, max_annots)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">aids_list</span><span class="p">,</span> <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s">&#39;rand&#39;</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">random_choice</span><span class="p">(</span><span class="n">aids</span><span class="p">):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">random_choice</span><span class="p">(</span><span class="n">aids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">aids_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">allow_unnamed</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_unnamed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;fixme&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s">&#39;rand&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list</span>

</div>
<div class="viewcode-block" id="get_dominant_species"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_dominant_species">[docs]</a><span class="k">def</span> <span class="nf">get_dominant_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_dominant_species</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; result = get_dominant_species(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        zebra_plains</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hist_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">hist_</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">hist_</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="n">species_text</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">list_argmax</span><span class="p">(</span><span class="n">vals</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">species_text</span>

</div>
<div class="viewcode-block" id="get_two_annots_per_name_and_singletons"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_two_annots_per_name_and_singletons">[docs]</a><span class="k">def</span> <span class="nf">get_two_annots_per_name_and_singletons</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">onlygt</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    makes controlled subset of data</span>

<span class="sd">    CONTROLLED TEST DATA</span>

<span class="sd">    Build data for experiment that tries to rule out</span>
<span class="sd">    as much bad data as possible</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_two_annots_per_name_and_singletons</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_two_annots_per_name_and_singletons --db GZ_ALL</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_two_annots_per_name_and_singletons --db PZ_Master0 --onlygt</span>

<span class="sd">    Ignore:</span>
<span class="sd">        sys.argv.extend([&#39;--db&#39;, &#39;PZ_MTEST&#39;])</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;PZ_Master0&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_subset = get_two_annots_per_name_and_singletons(ibs, onlygt=ut.get_argflag(&#39;--onlygt&#39;))</span>
<span class="sd">        &gt;&gt;&gt; ibeis.dev.dbinfo.get_dbinfo(ibs, aid_list=aid_subset, with_contrib=False)</span>
<span class="sd">        &gt;&gt;&gt; result = str(aid_subset)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">species</span> <span class="o">=</span> <span class="n">get_dominant_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">())</span>
    <span class="c">#aid_list = ibs.get_valid_aids(species=ibs.const.Species.ZEB_PLAIN, is_known=True)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span> <span class="n">is_known</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># FILTER OUT UNUSABLE ANNOTATIONS</span>
    <span class="c"># Get annots with timestamps</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">filter_aids_without_timestamps</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
    <span class="n">minqual</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">QUALITY_TEXT_TO_INT</span><span class="p">[</span><span class="s">&#39;poor&#39;</span><span class="p">]</span>
    <span class="c">#valid_yaws = {&#39;left&#39;, &#39;frontleft&#39;, &#39;backleft&#39;}</span>
    <span class="k">if</span> <span class="n">species</span> <span class="o">==</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">Species</span><span class="o">.</span><span class="n">ZEB_PLAIN</span><span class="p">:</span>
        <span class="n">valid_yawtexts</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;left&#39;</span><span class="p">,</span> <span class="s">&#39;frontleft&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="o">==</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">Species</span><span class="o">.</span><span class="n">ZEB_GREVY</span><span class="p">:</span>
        <span class="n">valid_yawtexts</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;right&#39;</span><span class="p">,</span> <span class="s">&#39;frontright&#39;</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">valid_yawtexts</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;left&#39;</span><span class="p">,</span> <span class="s">&#39;frontleft&#39;</span><span class="p">}</span>
    <span class="n">flags_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_quality_viewpoint_filterflags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">minqual</span><span class="p">,</span> <span class="n">valid_yawtexts</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">)</span>
    <span class="c">#print(&#39;print subset info&#39;)</span>
    <span class="c">#print(ut.dict_hist(ibs.get_annot_yaw_texts(aid_list)))</span>
    <span class="c">#print(ut.dict_hist(ibs.get_annot_quality_texts(aid_list)))</span>
    <span class="n">singletons</span><span class="p">,</span> <span class="n">multitons</span> <span class="o">=</span> <span class="n">partition_annots_into_singleton_multiton</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
    <span class="c"># process multitons</span>
    <span class="n">hourdists_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annots_hourdists_list</span><span class="p">(</span><span class="n">multitons</span><span class="p">)</span>
    <span class="c">#pairxs_list = [vt.pdist_argsort(x) for x in hourdists_list]</span>
    <span class="c"># Get the pictures taken the furthest appart of each gt case</span>
    <span class="n">best_pairx_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">vt</span><span class="o">.</span><span class="n">pdist_argsort</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hourdists_list</span><span class="p">]</span>

    <span class="n">best_multitons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">multitons</span><span class="p">,</span> <span class="n">best_pairx_list</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">onlygt</span><span class="p">:</span>
        <span class="n">aid_subset</span> <span class="o">=</span> <span class="n">best_multitons</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aid_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">best_multitons</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">singletons</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
    <span class="n">aid_subset</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    if False:</span>
<span class="sd">        qaids = aid_subset</span>
<span class="sd">        daids = aid_list</span>
<span class="sd">        def get_close_groundfalse_pairs(qaids, daids):</span>
<span class="sd">            valid_daids_list = [ibs.get_annot_groundfalse(qaid, daid_list=daids) for qaid in qaids]</span>
<span class="sd">            for qaid, valid_daids in zip(qaids, valid_daids_list):</span>
<span class="sd">                query_unixtime = ibs.get_annot_image_unixtimes(qaid)</span>
<span class="sd">                valid_data_unixtimes = np.array(ibs.get_annot_image_unixtimes(valid_daids))</span>
<span class="sd">                hourdiffs = ut.unixtime_hourdiff(query_unixtime, valid_data_unixtimes)</span>
<span class="sd">                valid_daids[hourdiffs.argmin()]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">#best_hourdists_list = ut.flatten(ibs.get_unflat_annots_hourdists_list(best_multitons))</span>
    <span class="c">#assert len(best_hourdists_list) == len(best_multitons)</span>
    <span class="c">#best_multitons_sortx = np.array(best_hourdists_list).argsort()[::-1]</span>
    <span class="c">#best_pairs = ut.list_take(best_multitons, best_multitons_sortx)</span>
    <span class="c">#best_multis = ut.flatten(best_pairs)</span>

    <span class="c"># process singletons</span>
    <span class="c">#[aids for aids in zip(aids, hour_dists_list]</span>
    <span class="k">return</span> <span class="n">aid_subset</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_aids_with_groundtruth"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_aids_with_groundtruth">[docs]</a><span class="k">def</span> <span class="nf">get_aids_with_groundtruth</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns aids with valid groundtruth &quot;&quot;&quot;</span>
    <span class="n">valid_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">has_gt_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_has_groundtruth</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">)</span>
    <span class="n">hasgt_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">,</span> <span class="n">has_gt_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hasgt_aids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_dbnotes_fpath"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_dbnotes_fpath">[docs]</a><span class="k">def</span> <span class="nf">get_dbnotes_fpath</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">notes_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_ibsdir</span><span class="p">(),</span> <span class="s">&#39;dbnotes.txt&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ensure</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbnotes_fpath</span><span class="p">()):</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_dbnotes</span><span class="p">(</span><span class="s">&#39;None&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">notes_fpath</span>

</div>
<span class="nd">@profile</span>
<div class="viewcode-block" id="get_yaw_viewtexts"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_yaw_viewtexts">[docs]</a><span class="k">def</span> <span class="nf">get_yaw_viewtexts</span><span class="p">(</span><span class="n">yaw_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        yaw (?):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_yaw_viewtexts</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; yaw_list = [0.0, np.pi / 2, np.pi / 4, np.pi, 3.15, -.4, -8, .2, 4, 7, 20, None]</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; text_list = get_yaw_viewtexts(yaw_list)</span>
<span class="sd">        &gt;&gt;&gt; result = str(text_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [&#39;right&#39;, &#39;front&#39;, &#39;frontright&#39;, &#39;left&#39;, &#39;left&#39;, &#39;backright&#39;, &#39;back&#39;, &#39;right&#39;, &#39;backleft&#39;, &#39;frontright&#39;, &#39;frontright&#39;, None]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#import vtool as vt</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">six</span>
    <span class="n">stdlblyaw_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">VIEWTEXT_TO_YAW_RADIANS</span><span class="p">))</span>
    <span class="n">stdlbl_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">stdlblyaw_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ALTERNATE</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">ALTERNATE</span><span class="p">:</span>
        <span class="c">#with ut.Timer(&#39;fdsa&#39;):</span>
        <span class="n">TAU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">binsize</span> <span class="o">=</span> <span class="n">TAU</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">VIEWTEXT_TO_YAW_RADIANS</span><span class="p">)</span>
        <span class="n">yaw_list_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">yaw</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">yaw</span> <span class="k">for</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="n">yaw_list</span><span class="p">])</span>
        <span class="n">index_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span> <span class="o">+</span> <span class="p">(</span><span class="n">yaw_list_</span> <span class="o">%</span> <span class="n">TAU</span><span class="p">)</span> <span class="o">/</span> <span class="n">binsize</span><span class="p">)</span>
        <span class="n">text_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">else</span> <span class="n">stdlbl_list</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">index_list</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c">#with ut.Timer(&#39;fdsa&#39;):</span>
        <span class="n">stdyaw_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">stdlblyaw_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">textdists_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">yaw</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">vt</span><span class="o">.</span><span class="n">ori_distance</span><span class="p">(</span><span class="n">stdyaw_list</span><span class="p">,</span> <span class="n">yaw</span><span class="p">)</span> <span class="k">for</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="n">yaw_list</span><span class="p">]</span>
        <span class="n">index_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">dists</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">dists</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="k">for</span> <span class="n">dists</span> <span class="ow">in</span> <span class="n">textdists_list</span><span class="p">]</span>
        <span class="n">text_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">stdlbl_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">index_list</span><span class="p">]</span>
        <span class="c">#yaw_list_ / binsize</span>
    <span class="c">#errors = [&#39;%.2f&#39; % dists[index] for dists, index in zip(textdists_list, index_list)]</span>
    <span class="c">#return list(zip(yaw_list, errors, text_list))</span>
    <span class="k">return</span> <span class="n">text_list</span>

</div>
<div class="viewcode-block" id="get_species_dbs"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_species_dbs">[docs]</a><span class="k">def</span> <span class="nf">get_species_dbs</span><span class="p">(</span><span class="n">species_prefix</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.init</span> <span class="kn">import</span> <span class="n">sysres</span>
    <span class="n">ibs_dblist</span> <span class="o">=</span> <span class="n">sysres</span><span class="o">.</span><span class="n">get_ibsdb_list</span><span class="p">()</span>
    <span class="n">isvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">species_prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">ibs_dblist</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">ibs_dblist</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_bbox_area"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_bbox_area">[docs]</a><span class="k">def</span> <span class="nf">get_annot_bbox_area</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">bbox_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">area_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="n">bbox_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">area_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_match_text"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_match_text">[docs]</a><span class="k">def</span> <span class="nf">get_match_text</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">):</span>
    <span class="n">truth</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_match_truth</span><span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">TRUTH_INT_TO_TEXT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">truth</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_database_species"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_database_species">[docs]</a><span class="k">def</span> <span class="nf">get_database_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_database_species</span>

<span class="sd">    Example1:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = ibs.get_database_species()</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [&#39;____&#39;, u&#39;bear_polar&#39;, u&#39;zebra_grevys&#39;, u&#39;zebra_plains&#39;]</span>

<span class="sd">    Example2:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = ibs.get_database_species()</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [u&#39;zebra_plains&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">unique_species</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">species_list</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">unique_species</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_database_species_count"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_database_species_count">[docs]</a><span class="k">def</span> <span class="nf">get_database_species_count</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_database_species_count</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; #print(ut.dict_str(ibeis.opendb(&#39;PZ_Master0&#39;).get_database_species_count()))</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = ibs.get_database_species_count()</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        {u&#39;zebra_plains&#39;: 6, &#39;____&#39;: 3, u&#39;zebra_grevys&#39;: 2, u&#39;bear_polar&#39;: 2}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">species_count_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">item_hist</span><span class="p">(</span><span class="n">species_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">species_count_dict</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_match_truth"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_match_truth">[docs]</a><span class="k">def</span> <span class="nf">get_match_truth</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">):</span>
    <span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">((</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">))</span>
    <span class="n">isunknown_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">((</span><span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">isunknown_list</span><span class="p">):</span>
        <span class="n">truth</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c"># Unknown</span>
    <span class="k">elif</span> <span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span><span class="p">:</span>
        <span class="n">truth</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c"># True</span>
    <span class="k">elif</span> <span class="n">nid1</span> <span class="o">!=</span> <span class="n">nid2</span><span class="p">:</span>
        <span class="n">truth</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c"># False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;invalid_unknown_truth_state&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">truth</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_aidpair_truths"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_aidpair_truths">[docs]</a><span class="k">def</span> <span class="nf">get_aidpair_truths</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1_list</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Uses NIDS to verify truth</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid1_list (list):</span>
<span class="sd">        aid2_list (list):</span>

<span class="sd">    Returns:</span>
<span class="sd">        ?: truth</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_aidpair_truths</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid1_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; aid2_list = ut.list_roll(ibs.get_valid_aids(), -1)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; truth = get_aidpair_truths(ibs, aid1_list, aid2_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = str(truth)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nid1_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid1_list</span><span class="p">))</span>
    <span class="n">nid2_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid2_list</span><span class="p">))</span>
    <span class="n">isunknown1_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">nid1_list</span><span class="p">))</span>
    <span class="n">isunknown2_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">nid2_list</span><span class="p">))</span>
    <span class="n">any_unknown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">isunknown1_list</span><span class="p">,</span> <span class="n">isunknown2_list</span><span class="p">)</span>
    <span class="n">truth_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">nid1_list</span> <span class="o">==</span> <span class="n">nid2_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">truth_list</span><span class="p">[</span><span class="n">any_unknown</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">TRUTH_UNKNOWN</span>
    <span class="k">return</span> <span class="n">truth_list</span>

</div>
<div class="viewcode-block" id="get_title"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_title">[docs]</a><span class="k">def</span> <span class="nf">get_title</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;IBEIS - No Database Directory Open&#39;</span>
    <span class="k">elif</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbdir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;IBEIS - !! INVALID DATABASE !!&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dbdir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbdir</span><span class="p">()</span>
        <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;IBEIS - </span><span class="si">%r</span><span class="s"> - Database Directory = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">)</span>
        <span class="n">wb_target</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">WILDBOOK_TARGET</span>
        <span class="c">#params.args.wildbook_target</span>
        <span class="k">if</span> <span class="n">wb_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> - Wildbook Target = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">wb_target</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">title</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_dbinfo_str"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_dbinfo_str">[docs]</a><span class="k">def</span> <span class="nf">get_dbinfo_str</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.dev</span> <span class="kn">import</span> <span class="n">dbinfo</span>
    <span class="k">return</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">get_dbinfo</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="s">&#39;info_str&#39;</span><span class="p">]</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_infostr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_infostr">[docs]</a><span class="k">def</span> <span class="nf">get_infostr</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns sort printable database information</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: infostr</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.dev</span> <span class="kn">import</span> <span class="n">dbinfo</span>
    <span class="k">return</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">get_short_infostr</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_dbnotes"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_dbnotes">[docs]</a><span class="k">def</span> <span class="nf">get_dbnotes</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; sets notes for an entire database &quot;&quot;&quot;</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">read_from</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbnotes_fpath</span><span class="p">(),</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">notes</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_dbnotes</span><span class="p">(</span><span class="s">&#39;None&#39;</span><span class="p">)</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">read_from</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbnotes_fpath</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">notes</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="set_dbnotes"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_dbnotes">[docs]</a><span class="k">def</span> <span class="nf">set_dbnotes</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">notes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; sets notes for an entire database &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">IBEISControl</span><span class="o">.</span><span class="n">IBEISController</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbnotes_fpath</span><span class="p">(),</span> <span class="n">notes</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="annotstr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.annotstr">[docs]</a><span class="k">def</span> <span class="nf">annotstr</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;aid=</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">aid</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="redownload_detection_models"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.redownload_detection_models">[docs]</a><span class="k">def</span> <span class="nf">redownload_detection_models</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -c &quot;from ibeis.model.detect import grabmodels; grabmodels.redownload_models()&quot;</span>
<span class="sd">        python -c &quot;import utool, ibeis.model; utool.view_directory(ibeis.model.detect.grabmodels._expand_modeldir())&quot;</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = redownload_detection_models(ibs)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] redownload_detection_models&#39;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">ibeis.model.detect</span> <span class="kn">import</span> <span class="n">grabmodels</span>
    <span class="n">modeldir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_detect_modeldir</span><span class="p">()</span>
    <span class="n">grabmodels</span><span class="o">.</span><span class="n">redownload_models</span><span class="p">(</span><span class="n">modeldir</span><span class="o">=</span><span class="n">modeldir</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="view_model_dir"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.view_model_dir">[docs]</a><span class="k">def</span> <span class="nf">view_model_dir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] redownload_detection_models&#39;</span><span class="p">)</span>
    <span class="n">modeldir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_detect_modeldir</span><span class="p">()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">view_directory</span><span class="p">(</span><span class="n">modeldir</span><span class="p">)</span>
    <span class="c">#grabmodels.redownload_models(modeldir=modeldir)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="merge_names"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.merge_names">[docs]</a><span class="k">def</span> <span class="nf">merge_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">merge_name</span><span class="p">,</span> <span class="n">other_names</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        merge_name (str):</span>
<span class="sd">        other_names (list):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-merge_names</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; merge_name = &#39;zebra&#39;</span>
<span class="sd">        &gt;&gt;&gt; other_names = [&#39;occl&#39;, &#39;jeff&#39;]</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = merge_names(ibs, merge_name, other_names)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        &gt;&gt;&gt; ibs.print_names_table()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] merging other_names=</span><span class="si">%r</span><span class="s"> into merge_name=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">other_names</span><span class="p">,</span> <span class="n">merge_name</span><span class="p">))</span>
    <span class="n">other_nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_rowids_from_text</span><span class="p">(</span><span class="n">other_names</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_name_alias_texts</span><span class="p">(</span><span class="n">other_nid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">merge_name</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_nid_list</span><span class="p">))</span>
    <span class="n">other_aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">other_nid_list</span><span class="p">)</span>
    <span class="n">other_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">other_aids_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] ... </span><span class="si">%r</span><span class="s"> annotations are being merged into merge_name=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other_aids</span><span class="p">),</span> <span class="n">merge_name</span><span class="p">))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_names</span><span class="p">(</span><span class="n">other_aids</span><span class="p">,</span> <span class="p">[</span><span class="n">merge_name</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_aids</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="inspect_nonzero_yaws"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.inspect_nonzero_yaws">[docs]</a><span class="k">def</span> <span class="nf">inspect_nonzero_yaws</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    python dev.py --dbdir /raid/work2/Turk/PZ_Master --cmd --show</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.viz</span> <span class="kn">import</span> <span class="n">viz_chip</span>
    <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
    <span class="n">aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">yaws</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaws</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
    <span class="n">isnone_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">yaw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="n">yaws</span><span class="p">]</span>
    <span class="n">aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">isnone_list</span><span class="p">)</span>
    <span class="n">yaws</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">yaws</span><span class="p">,</span> <span class="n">isnone_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">yaws</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">yaw</span><span class="p">)</span>
        <span class="c"># We seem to be storing FULL paths in</span>
        <span class="c"># the probchip table</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_annot_chips</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">viz_chip</span><span class="o">.</span><span class="n">show_chip</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">annote</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">show_if_requested</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="detect_false_positives"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.detect_false_positives">[docs]</a><span class="k">def</span> <span class="nf">detect_false_positives</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO: this function should detect problems in the database</span>
<span class="sd">    It should execute queries for annotations with groundtruth</span>

<span class="sd">    then if the groundtruth is no in the top results it is given to the user who</span>
<span class="sd">    should try and rectify the problem.</span>

<span class="sd">    If the top ranked match is not a groundtruth then it is a true error or hard</span>
<span class="sd">    case for the system. To prevent having to review this &quot;hard case&quot; again an</span>
<span class="sd">    explicit negative link should be made between the offending annotation pair.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
    <span class="c">#qaid_list = ibs.get_valid_aids(nojunk=True, isknown=True)</span>
    <span class="c">#qres_list = ibs.query_annots(qaid_list)</span>
    <span class="c">#for qres in qres_list:</span>
    <span class="c">#    top_aids = qres.get_top_aids(num=2)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="set_exemplars_from_quality_and_viewpoint"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_exemplars_from_quality_and_viewpoint">[docs]</a><span class="k">def</span> <span class="nf">set_exemplars_from_quality_and_viewpoint</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exemplars_per_view</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">eid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Automatic exemplar selection algorithm based on viewpoint and quality</span>

<span class="sd">    Ignore:</span>
<span class="sd">        # We want to choose the minimum per-item weight w such that</span>
<span class="sd">        # we can&#39;t pack more than N w&#39;s into the knapsack</span>
<span class="sd">        w * (N + 1) &gt; N</span>
<span class="sd">        # and w &lt; 1.0, so we can have wiggle room for preferences</span>
<span class="sd">        # so</span>
<span class="sd">        w * (N + 1) &gt; N</span>
<span class="sd">        w &gt; N / (N + 1)</span>
<span class="sd">        EPS = 1E-9</span>
<span class="sd">        w = N / (N + 1) + EPS</span>

<span class="sd">        # Preference denomiantor should not make any choice of</span>
<span class="sd">        # feasible items infeasible, but give more weight to a few.</span>
<span class="sd">        # delta_w is the wiggle room we have, but we need to choose a number</span>
<span class="sd">        # much less than it.</span>
<span class="sd">        prefdenom = N ** 2</span>
<span class="sd">        maybe its just N + EPS?</span>
<span class="sd">        N ** 2 should work though. Figure out correct value later</span>
<span class="sd">        delta_w = (1 - w)</span>
<span class="sd">        prefdenom = delta_w / N</span>
<span class="sd">        N - (w * N)</span>

<span class="sd">        N = 3</span>
<span class="sd">        EPS = 1E-9</span>
<span class="sd">        w = N / (N + 1) + EPS</span>
<span class="sd">        pref_decimator = N ** 2</span>
<span class="sd">        num_teir1_levels = 3</span>
<span class="sd">        pref_teir1 = w / (num_teir1_levels * pref_decimator)</span>
<span class="sd">        pref_teir2 = pref_teir1 / pref_decimator</span>
<span class="sd">        pref_teir3 = pref_teir2 / pref_decimator</span>

<span class="sd">    References:</span>
<span class="sd">        # implement maximum diversity approximation instead</span>
<span class="sd">        http://www.csbio.unc.edu/mcmillan/pubs/ICDM07_Pan.pdf</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-set_exemplars_from_quality_and_viewpoint</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-set_exemplars_from_quality_and_viewpoint:1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; #ibs = ibeis.opendb(&#39;PZ_MUGU_19&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; dry_run = True</span>
<span class="sd">        &gt;&gt;&gt; verbose = False</span>
<span class="sd">        &gt;&gt;&gt; old_sum = sum(ibs.get_annot_exemplar_flags(ibs.get_valid_aids()))</span>
<span class="sd">        &gt;&gt;&gt; new_aid_list, new_flag_list = ibs.set_exemplars_from_quality_and_viewpoint(dry_run=dry_run)</span>
<span class="sd">        &gt;&gt;&gt; new_sum = sum(new_flag_list)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;old_sum = %r&#39; % (old_sum,))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;new_sum = %r&#39; % (new_sum,))</span>
<span class="sd">        &gt;&gt;&gt; zero_aid_list, zero_flag_list = ibs.set_exemplars_from_quality_and_viewpoint(exemplars_per_view=0, dry_run=dry_run)</span>
<span class="sd">        &gt;&gt;&gt; assert sum(zero_flag_list) == 0</span>
<span class="sd">        &gt;&gt;&gt; result = new_sum</span>

<span class="sd">    Example1:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; dry_run = True</span>
<span class="sd">        &gt;&gt;&gt; verbose = False</span>
<span class="sd">        &gt;&gt;&gt; old_sum = sum(ibs.get_annot_exemplar_flags(ibs.get_valid_aids()))</span>
<span class="sd">        &gt;&gt;&gt; new_aid_list, new_flag_list = ibs.set_exemplars_from_quality_and_viewpoint(dry_run=dry_run)</span>
<span class="sd">        &gt;&gt;&gt; assert len(new_aid_list) == len(new_flag_list)</span>
<span class="sd">        &gt;&gt;&gt; # 2 of the 11 annots are unknown and should not be exemplars</span>
<span class="sd">        &gt;&gt;&gt; ut.assert_eq(len(new_aid_list), 9)</span>

<span class="sd">    Example2:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb2&#39;)</span>
<span class="sd">        &gt;&gt;&gt; dry_run = True</span>
<span class="sd">        &gt;&gt;&gt; verbose = False</span>
<span class="sd">        &gt;&gt;&gt; eid = None</span>
<span class="sd">        &gt;&gt;&gt; new_aid_list, new_flag_list = ibs.set_exemplars_from_quality_and_viewpoint(dry_run=dry_run)</span>
<span class="sd">        &gt;&gt;&gt; old_flag_list = ibs.get_annot_exemplar_flags(new_aid_list)</span>
<span class="sd">        &gt;&gt;&gt; new_exemplar_aids = ut.filter_items(new_aid_list, new_flag_list)</span>
<span class="sd">        &gt;&gt;&gt; new_exemplar_qualtexts = ibs.get_annot_quality_texts(new_exemplar_aids)</span>
<span class="sd">        &gt;&gt;&gt; assert &#39;junk&#39; not in new_exemplar_qualtexts, &#39;should not have junk exemplars&#39;</span>
<span class="sd">        &gt;&gt;&gt; assert &#39;poor&#39; not in new_exemplar_qualtexts, &#39;should not have poor exemplars&#39;</span>
<span class="sd">        &gt;&gt;&gt; #assert len(new_aid_list) == len(new_flag_list)</span>
<span class="sd">        &gt;&gt;&gt; # 2 of the 11 annots are unknown and should not be exemplars</span>
<span class="sd">        &gt;&gt;&gt; #ut.assert_eq(len(new_aid_list), 9)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># General params</span>
    <span class="c">#PREFER_GOOD_OVER_OLDFLAG = True</span>
    <span class="c">#verbose = False</span>
    <span class="c">#dry_run = False</span>
    <span class="c">##</span>
    <span class="c">## Params for knapsack</span>
    <span class="c">#def make_knapsack_params(N, levels_per_tier_list):</span>
    <span class="c">#    &quot;&quot;&quot;</span>
    <span class="c">#    Args:</span>
    <span class="c">#        N (int): the integral maximum number of items</span>
    <span class="c">#        levels_per_tier_list (list): list of number of distinctions possible</span>
    <span class="c">#        per tier.</span>

    <span class="c">#    Returns:</span>
    <span class="c">#        per-item weights, weights go group items into several tiers, and an</span>
    <span class="c">#        infeasible weight</span>
    <span class="c">#    &quot;&quot;&quot;</span>
    <span class="c">#    EPS = 1E-9</span>
    <span class="c">#    # Solve for the minimum per-item weight</span>
    <span class="c">#    # to allow for preference wiggle room</span>
    <span class="c">#    w = N / (N + 1) + EPS</span>
    <span class="c">#    # level1 perference augmentation</span>
    <span class="c">#    # TODO: figure out mathematically ellegant value</span>
    <span class="c">#    pref_decimator = max(1, (N + EPS)) ** 2  # max is a hack for N = 0</span>
    <span class="c">#    # we want space to specify two levels of tier1 preference</span>
    <span class="c">#    tier_w_list = []</span>
    <span class="c">#    last_w = w</span>
    <span class="c">#    for num_levels in levels_per_tier_list:</span>
    <span class="c">#        last_w = tier_w = last_w / (num_levels * pref_decimator)</span>
    <span class="c">#        tier_w_list.append(tier_w)</span>
    <span class="c">#    infeasible_w = max(9001, N + 1)</span>
    <span class="c">#    return w, tier_w_list, infeasible_w</span>
    <span class="c">#N = exemplars_per_view</span>
    <span class="c">#levels_per_tier_list = [3, 1, 1]</span>
    <span class="c">#w, tier_w_list, infeasible_w = make_knapsack_params(N, levels_per_tier_list)</span>

    <span class="c">#qual2_weight = {</span>
    <span class="c">#    const.QUAL_EXCELLENT : w + tier_w_list[0] + tier_w_list[1],</span>
    <span class="c">#    const.QUAL_GOOD      : w + tier_w_list[0],</span>
    <span class="c">#    const.QUAL_OK        : w + tier_w_list[1],</span>
    <span class="c">#    const.QUAL_UNKNOWN   : w + tier_w_list[1],</span>
    <span class="c">#    const.QUAL_POOR      : w + tier_w_list[2],</span>
    <span class="c">#    const.QUAL_JUNK      : infeasible_w,</span>
    <span class="c">#}</span>
    <span class="c">## this probably broke with the introduction of 2 more tiers</span>
    <span class="c">#oldflag_offset = (</span>
    <span class="c">#    # always prefer good over ok</span>
    <span class="c">#    tier_w_list[0] - tier_w_list[1]</span>
    <span class="c">#    if PREFER_GOOD_OVER_OLDFLAG else</span>
    <span class="c">#    # prefer ok over good when ok has oldflag</span>
    <span class="c">#    tier_w_list[0] + tier_w_list[1]</span>
    <span class="c">#)</span>

    <span class="c">#def choose_exemplars(aids):</span>
    <span class="c">#    qualtexts = ibs.get_annot_quality_texts(aids)</span>
    <span class="c">#    oldflags = ibs.get_annot_exemplar_flags(aids)</span>
    <span class="c">#    # We like good more than ok, and junk is infeasible We prefer items that</span>
    <span class="c">#    # had previously been exemplars Build input for knapsack</span>
    <span class="c">#    weights = [qual2_weight[qual] + oldflag_offset * oldflag</span>
    <span class="c">#               for qual, oldflag in zip(qualtexts, oldflags)]</span>
    <span class="c">#    #values = [1] * len(weights)</span>
    <span class="c">#    values = weights</span>
    <span class="c">#    indices = list(range(len(weights)))</span>
    <span class="c">#    items = list(zip(values, weights, indices))</span>
    <span class="c">#    total_value, chosen_items = ut.knapsack(items, N)</span>
    <span class="c">#    chosen_indices = ut.get_list_column(chosen_items, 2)</span>
    <span class="c">#    new_flags = [False] * len(aids)</span>
    <span class="c">#    for index in chosen_indices:</span>
    <span class="c">#        new_flags[index] = True</span>
    <span class="c">#    return new_flags</span>

    <span class="c">#def get_changed_infostr(yawtext, aids, new_flags):</span>
    <span class="c">#    old_flags = ibs.get_annot_exemplar_flags(aids)</span>
    <span class="c">#    quals = ibs.get_annot_quality_texts(aids)</span>
    <span class="c">#    ischanged = ut.xor_lists(old_flags, new_flags)</span>
    <span class="c">#    changed_list = [&#39;***&#39; if flag else &#39;&#39;</span>
    <span class="c">#                    for flag in ischanged]</span>
    <span class="c">#    infolist = list(zip(aids, quals, old_flags, new_flags, changed_list))</span>
    <span class="c">#    infostr = (&#39;yawtext=%r:\n&#39; % (yawtext,)) + ut.list_str(infolist)</span>
    <span class="c">#    return infostr</span>

    <span class="c">#aid_list = ibs.get_valid_aids()</span>
    <span class="c">#aids_list, unique_nids  = ibs.group_annots_by_name(aid_list)</span>
    <span class="c">## for final settings because I&#39;m too lazy to write</span>
    <span class="c">## this correctly using group_indicies instead of group_items</span>
    <span class="c">#new_aid_list = []</span>
    <span class="c">#new_flag_list = []</span>
    <span class="c">#_iter = ut.ProgressIter(zip(aids_list, unique_nids), nTotal=len(aids_list), lbl=&#39;Optimizing name exemplars&#39;)</span>
    <span class="c">#for aids_, nid in _iter:</span>
    <span class="c">#    if ibs.is_nid_unknown(nid):</span>
    <span class="c">#        # do not change unknown animals</span>
    <span class="c">#        continue</span>
    <span class="c">#    yawtexts  = ibs.get_annot_yaw_texts(aids_)</span>
    <span class="c">#    yawtext2_aids = ut.group_items(aids_, yawtexts)</span>
    <span class="c">#    if verbose:</span>
    <span class="c">#        print(&#39;+ ---&#39;)</span>
    <span class="c">#        print(&#39;  nid=%r&#39; % (nid))</span>
    <span class="c">#    for yawtext, aids in six.iteritems(yawtext2_aids):</span>
    <span class="c">#        new_flags = choose_exemplars(aids)</span>
    <span class="c">#        if verbose:</span>
    <span class="c">#            print(ut.indent(get_changed_infostr(yawtext, aids, new_flags)))</span>
    <span class="c">#        new_aid_list.extend(aids)</span>
    <span class="c">#        new_flag_list.extend(new_flags)</span>
    <span class="c">#    if verbose:</span>
    <span class="c">#        print(&#39;L ___&#39;)</span>
    <span class="k">if</span> <span class="n">exemplars_per_view</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">exemplars_per_view</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">exemplars_per_view</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">eid</span><span class="o">=</span><span class="n">eid</span><span class="p">)</span>
    <span class="n">HACK</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">enable_custom_filter</span>
    <span class="c">#True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HACK</span><span class="p">:</span>
        <span class="n">new_aid_list</span><span class="p">,</span> <span class="n">new_flag_list</span> <span class="o">=</span> <span class="n">get_annot_quality_viewpoint_subset</span><span class="p">(</span>
            <span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">annots_per_view</span><span class="o">=</span><span class="n">exemplars_per_view</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># HACK</span>
        <span class="n">new_exemplar_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_prioritized_name_subset</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">exemplars_per_view</span><span class="p">)</span>
        <span class="n">new_nonexemplar_aids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_exemplar_aids</span><span class="p">))</span>
        <span class="n">new_aid_list</span> <span class="o">=</span> <span class="n">new_nonexemplar_aids</span> <span class="o">+</span> <span class="n">new_exemplar_aids</span>
        <span class="n">new_flag_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_nonexemplar_aids</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_exemplar_aids</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_exemplar_flags</span><span class="p">(</span><span class="n">new_aid_list</span><span class="p">,</span> <span class="n">new_flag_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_aid_list</span><span class="p">,</span> <span class="n">new_flag_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_prioritized_name_subset"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_prioritized_name_subset">[docs]</a><span class="k">def</span> <span class="nf">get_prioritized_name_subset</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">annots_per_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO: this needs to be integrated more cleanly with a nonhacky way of</span>
<span class="sd">    getting a subset of exemplars. Currently ther is duplicate code in guiback</span>
<span class="sd">    and here to use left side only when custom filter is on.</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_prioritized_name_subset</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb2&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; annots_per_name = 2</span>
<span class="sd">        &gt;&gt;&gt; aid_subset = get_prioritized_name_subset(ibs, aid_list, annots_per_name)</span>
<span class="sd">        &gt;&gt;&gt; qualtexts = ibs.get_annot_quality_texts(aid_subset)</span>
<span class="sd">        &gt;&gt;&gt; yawtexts = ibs.get_annot_yaw_texts(aid_subset)</span>
<span class="sd">        &gt;&gt;&gt; assert &#39;junk&#39; not in qualtexts</span>
<span class="sd">        &gt;&gt;&gt; assert &#39;right&#39; not in yawtexts</span>
<span class="sd">        &gt;&gt;&gt; result = len(aid_subset)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        28</span>

<span class="sd">    Exeample:</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb2&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ut.list_compress(aid_list, ibs.is_aid_unknown(aid_list))</span>
<span class="sd">        &gt;&gt;&gt; annots_per_name = 2</span>
<span class="sd">        &gt;&gt;&gt; aid_subset = get_prioritized_name_subset(ibs, aid_list, annots_per_name)</span>
<span class="sd">        &gt;&gt;&gt; qualtexts = ibs.get_annot_quality_texts(aid_list)</span>
<span class="sd">        &gt;&gt;&gt; yawtexts = ibs.get_annot_yaw_texts(aid_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">annots_per_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">annots_per_name</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">prioritized_subset_annots_per_name</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>

    <span class="c"># Paramaterize?</span>
    <span class="n">qualtext2_weight</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_EXCELLENT</span> <span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_GOOD</span>      <span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_OK</span>        <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_POOR</span>      <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_UNKNOWN</span>   <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_JUNK</span>      <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">yawtext2_weight</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;right&#39;</span>      <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">&#39;frontright&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">&#39;front&#39;</span>      <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">&#39;frontleft&#39;</span>  <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s">&#39;left&#39;</span>       <span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s">&#39;backleft&#39;</span>   <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">&#39;back&#39;</span>       <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">&#39;backright&#39;</span>  <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="bp">None</span>         <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">weight_thresh</span> <span class="o">=</span> <span class="mi">7</span>

    <span class="n">qualtext_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">yawtext_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>

    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
    <span class="n">unique_nids</span><span class="p">,</span> <span class="n">groupxs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">grouped_aids_</span>     <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="n">groupxs_list</span><span class="p">)</span>
    <span class="n">grouped_qualtexts</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qualtext_list</span><span class="p">),</span> <span class="n">groupxs_list</span><span class="p">)</span>
    <span class="n">grouped_yawtexts</span>  <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yawtext_list</span><span class="p">),</span> <span class="n">groupxs_list</span><span class="p">)</span>
    <span class="n">yaw_weights_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">yawtext2_weight</span><span class="p">,</span> <span class="n">yawtexts</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">yawtexts</span> <span class="ow">in</span> <span class="n">grouped_yawtexts</span>
    <span class="p">]</span>
    <span class="n">qual_weights_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">qualtext2_weight</span><span class="p">,</span> <span class="n">yawtexts</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">yawtexts</span> <span class="ow">in</span> <span class="n">grouped_qualtexts</span>
    <span class="p">]</span>
    <span class="n">weights_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">yaw_weights</span> <span class="o">+</span> <span class="n">qual_weights</span>
        <span class="k">for</span> <span class="n">yaw_weights</span><span class="p">,</span> <span class="n">qual_weights</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">yaw_weights_list</span><span class="p">,</span> <span class="n">qual_weights_list</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">sortx_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">weights</span> <span class="ow">in</span> <span class="n">weights_list</span>
    <span class="p">]</span>

    <span class="n">sorted_weight_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">weights</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights_list</span><span class="p">,</span> <span class="n">sortx_list</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">sorted_aids_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">aids</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">aids</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grouped_aids_</span><span class="p">,</span> <span class="n">sortx_list</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">passed_thresh_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">weights</span> <span class="o">&gt;</span> <span class="n">weight_thresh</span>
        <span class="k">for</span> <span class="n">weights</span> <span class="ow">in</span> <span class="n">sorted_weight_list</span>
    <span class="p">]</span>

    <span class="n">valid_ordered_aids_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">aids</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">passed</span><span class="p">),</span> <span class="n">annots_per_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">aids</span><span class="p">,</span> <span class="n">passed</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sorted_aids_list</span><span class="p">,</span> <span class="n">passed_thresh_list</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">aid_subset</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">valid_ordered_aids_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_subset</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_quality_viewpoint_subset"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_quality_viewpoint_subset">[docs]</a><span class="k">def</span> <span class="nf">get_annot_quality_viewpoint_subset</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">annots_per_view</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb2&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; annots_per_view = 2</span>
<span class="sd">        &gt;&gt;&gt; new_aid_list, new_flag_list = get_annot_quality_viewpoint_subset(ibs)</span>
<span class="sd">        &gt;&gt;&gt; result = sum(new_flag_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        38</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>

    <span class="n">PREFER_GOOD_EXEMPLAR_OVER_EXCELLENT</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># Params for knapsack</span>
    <span class="k">def</span> <span class="nf">make_knapsack_params</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">levels_per_tier_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            N (int): the integral maximum number of items</span>
<span class="sd">            levels_per_tier_list (list): list of number of distinctions possible</span>
<span class="sd">            per tier.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (w, tier_w_list, infeasible_w)</span>
<span class="sd">                w            - is the base weight of all items</span>
<span class="sd">                tier_w_list  - is a list of w offsets per tier that does not bring it over 1</span>
<span class="sd">                                but suggest a preference for that item.</span>
<span class="sd">                infeasible_w - weight of impossible items</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">EPS</span> <span class="o">=</span> <span class="mf">1E-9</span>
        <span class="c"># Solve for the minimum per-item weight</span>
        <span class="c"># to allow for preference wiggle room</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">EPS</span>
        <span class="c"># level1 perference augmentation</span>
        <span class="c"># TODO: figure out mathematically ellegant value</span>
        <span class="n">pref_decimator</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="n">EPS</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c"># max is a hack for N = 0</span>
        <span class="c"># we want space to specify two levels of tier1 preference</span>
        <span class="n">tier_w_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last_w</span> <span class="o">=</span> <span class="n">w</span>
        <span class="k">for</span> <span class="n">num_levels</span> <span class="ow">in</span> <span class="n">levels_per_tier_list</span><span class="p">:</span>
            <span class="n">last_w</span> <span class="o">=</span> <span class="n">tier_w</span> <span class="o">=</span> <span class="n">last_w</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_levels</span> <span class="o">*</span> <span class="n">pref_decimator</span><span class="p">)</span>
            <span class="n">tier_w_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tier_w</span><span class="p">)</span>
        <span class="n">infeasible_w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">9001</span><span class="p">,</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">tier_w_list</span><span class="p">,</span> <span class="n">infeasible_w</span>
    <span class="n">levels_per_tier_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">tier_w_list</span><span class="p">,</span> <span class="n">infeasible_w</span> <span class="o">=</span> <span class="n">make_knapsack_params</span><span class="p">(</span><span class="n">annots_per_view</span><span class="p">,</span> <span class="n">levels_per_tier_list</span><span class="p">)</span>

    <span class="n">qual2_weight</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_EXCELLENT</span> <span class="p">:</span> <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_GOOD</span>      <span class="p">:</span> <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_OK</span>        <span class="p">:</span> <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_UNKNOWN</span>   <span class="p">:</span> <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_POOR</span>      <span class="p">:</span> <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_JUNK</span>      <span class="p">:</span> <span class="n">infeasible_w</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">exemplar_offset</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c"># always prefer good over ok</span>
        <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">PREFER_GOOD_EXEMPLAR_OVER_EXCELLENT</span> <span class="k">else</span>
        <span class="c"># prefer ok over good when ok has oldflag</span>
        <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c"># this probably broke with the introduction of 2 more tiers</span>

    <span class="k">def</span> <span class="nf">get_knapsack_flags</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="c">#values = [1] * len(weights)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)))</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">indices</span><span class="p">))</span>
        <span class="n">total_value</span><span class="p">,</span> <span class="n">chosen_items</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">knapsack</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">annots_per_view</span><span class="p">)</span>
        <span class="n">chosen_indices</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">chosen_items</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">chosen_indices</span><span class="p">:</span>
            <span class="n">flags</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">flags</span>

    <span class="k">def</span> <span class="nf">get_chosen_flags</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">annots_per_view</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">qual2_weight</span><span class="p">,</span> <span class="n">exemplar_offset</span><span class="p">):</span>
        <span class="n">qualtexts</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
        <span class="n">isexemplar_flags</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_exemplar_flags</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
        <span class="c"># base weight plug preference offsets</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="o">+</span> <span class="n">qual2_weight</span><span class="p">[</span><span class="n">qual</span><span class="p">]</span> <span class="o">+</span> <span class="n">exemplar_offset</span> <span class="o">*</span> <span class="n">isexemplar</span>
                   <span class="k">for</span> <span class="n">qual</span><span class="p">,</span> <span class="n">isexemplar</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qualtexts</span><span class="p">,</span> <span class="n">isexemplar_flags</span><span class="p">)]</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">annots_per_view</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">get_knapsack_flags</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="c"># We like good more than ok, and junk is infeasible We prefer items that</span>
        <span class="c"># had previously been exemplars Build input for knapsack</span>
        <span class="k">return</span> <span class="n">flags</span>

    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
    <span class="n">unique_nids</span><span class="p">,</span> <span class="n">groupxs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">grouped_aids_</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="n">groupxs_list</span><span class="p">)</span>
    <span class="c">#aids = grouped_aids_[-6]</span>
    <span class="c"># for final settings because I&#39;m too lazy to write</span>
    <span class="n">new_aid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_flag_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgressIter</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">grouped_aids_</span><span class="p">,</span> <span class="n">unique_nids</span><span class="p">),</span> <span class="n">nTotal</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_nids</span><span class="p">),</span> <span class="n">lbl</span><span class="o">=</span><span class="s">&#39;Picking best annots per viewpoint&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">aids_</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">_iter</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">nid</span><span class="p">):</span>
            <span class="c"># do not change unknown animals</span>
            <span class="k">continue</span>
        <span class="c"># subgroup the names by viewpoints</span>
        <span class="n">yawtexts</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">aids_</span><span class="p">)</span>
        <span class="n">yawtext2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">aids_</span><span class="p">,</span> <span class="n">yawtexts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">yawtext</span><span class="p">,</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">yawtext2_aids</span><span class="p">):</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">get_chosen_flags</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">annots_per_view</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">qual2_weight</span><span class="p">,</span> <span class="n">exemplar_offset</span><span class="p">)</span>
            <span class="n">new_aid_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
            <span class="n">new_flag_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;L ___&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_aid_list</span><span class="p">,</span> <span class="n">new_flag_list</span>


<span class="c">#@__injectable</span>
<span class="c">#def query_enc_names_vs_exemplars(ibs, exemplars_per_view=2, eid=None):</span>
<span class="c">#    &quot;&quot;&quot;</span>

<span class="c">#    &quot;&quot;&quot;</span>
<span class="c">#    aid_list = ibs.get_valid_aids(eid=eid)</span>
<span class="c">#    new_aid_list, new_flag_list = get_annot_quality_viewpoint_subset(</span>
<span class="c">#        ibs, aid_list=aid_list, annots_per_view=exemplars_per_view)</span>
<span class="c">#    qaids = ut.filter_items(new_aid_list, new_flag_list)</span>
<span class="c">#    daids = ibs.get_valid_aids(is_exemplar=True, nojunk=True)</span>
<span class="c">#    cfgdict = dict(can_match_samename=False)</span>
<span class="c">#    #, use_k_padding=True)</span>
<span class="c">#    qreq_ = ibs.new_query_request(qaids, daids, cfgdict)</span>
<span class="c">#    qres_list = ibs.query_chips(qreq_=qreq_)</span>
<span class="c">#    return qres_list</span>

</div>
<div class="viewcode-block" id="detect_join_cases"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.detect_join_cases">[docs]</a><span class="k">def</span> <span class="nf">detect_join_cases</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    Returns:</span>
<span class="sd">        QueryResult: qres_list -  object of feature correspondences and scores</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-detect_join_cases --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; qres_list = detect_join_cases(ibs)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; #result = str(qres_list)</span>
<span class="sd">        &gt;&gt;&gt; #print(result)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; import guitool</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.gui import inspect_gui</span>
<span class="sd">        &gt;&gt;&gt; guitool.ensure_qapp()</span>
<span class="sd">        &gt;&gt;&gt; qaid2_qres = {qres.qaid: qres for qres in qres_list}</span>
<span class="sd">        &gt;&gt;&gt; qres_wgt = inspect_gui.QueryResultsWidget(ibs, qaid2_qres, filter_reviewed=False)</span>
<span class="sd">        &gt;&gt;&gt; qres_wgt.show()</span>
<span class="sd">        &gt;&gt;&gt; qres_wgt.raise_()</span>
<span class="sd">        &gt;&gt;&gt; guitool.qtapp_loop(qres_wgt)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qaids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">is_exemplar</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nojunk</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">daids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">is_exemplar</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nojunk</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">cfgdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">can_match_samename</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_k_padding</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">qreq_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">new_query_request</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">)</span>
    <span class="n">qres_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">query_chips</span><span class="p">(</span><span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qres_list</span>
    <span class="c">#return qres_list</span>

</div>
<span class="k">def</span> <span class="nf">_split_car_contrib_tag</span><span class="p">(</span><span class="n">contrib_tag</span><span class="p">,</span> <span class="n">distinguish_invalids</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">contrib_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="s">&#39;NNP GZC Car&#39;</span> <span class="ow">in</span> <span class="n">contrib_tag</span><span class="p">:</span>
            <span class="n">contrib_tag_split</span> <span class="o">=</span> <span class="n">contrib_tag</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contrib_tag_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">contrib_tag</span> <span class="o">=</span> <span class="n">contrib_tag_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">distinguish_invalids</span><span class="p">:</span>
            <span class="n">contrib_tag</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">contrib_tag</span>


<span class="nd">@__injectable</span>
<div class="viewcode-block" id="report_sightings"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.report_sightings">[docs]</a><span class="k">def</span> <span class="nf">report_sightings</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">complete</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">sanitize_list</span><span class="p">(</span><span class="n">data_list</span><span class="p">):</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;COMMA&gt;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">return_str</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_list</span><span class="p">))</span>
        <span class="n">return_str</span> <span class="o">=</span> <span class="n">return_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,None,&#39;</span><span class="p">,</span> <span class="s">&#39;,UNKNOWN,&#39;</span><span class="p">)</span>
        <span class="n">return_str</span> <span class="o">=</span> <span class="n">return_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,</span><span class="si">%s</span><span class="s">,&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">,</span> <span class="p">)</span> <span class="p">,</span> <span class="s">&#39;,UNKNOWN,&#39;</span><span class="p">)</span>
        <span class="n">return_str</span> <span class="o">=</span> <span class="n">return_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,-1,&#39;</span><span class="p">,</span> <span class="s">&#39;,UNKNOWN,&#39;</span><span class="p">)</span>
        <span class="n">return_str</span> <span class="o">=</span> <span class="n">return_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,-1,&#39;</span><span class="p">,</span> <span class="s">&#39;,UNKNOWN,&#39;</span><span class="p">)</span>
        <span class="n">return_str</span> <span class="o">=</span> <span class="n">return_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,-1.0,&#39;</span><span class="p">,</span> <span class="s">&#39;,UNKNOWN,&#39;</span><span class="p">)</span>
        <span class="n">return_str</span> <span class="o">=</span> <span class="n">return_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,-1.0,&#39;</span><span class="p">,</span> <span class="s">&#39;,UNKNOWN,&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_str</span>
    <span class="c"># Grab primitives</span>
    <span class="k">if</span> <span class="n">complete</span><span class="p">:</span>
        <span class="n">aid_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aid_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_count</span><span class="p">(</span><span class="n">pre_unixtime_sort</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">gid_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">species_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">viewpoint_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">quality_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">contrib_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_contributor_tag</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">car_list</span>       <span class="o">=</span> <span class="p">[</span> <span class="n">_split_car_contrib_tag</span><span class="p">(</span><span class="n">contrib_tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">contrib_tag</span> <span class="ow">in</span> <span class="n">contrib_list</span> <span class="p">]</span>
    <span class="n">uri_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uris</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">sex_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_sex_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">age_min_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_age_months_est_min</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">age_max_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_age_months_est_max</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">name_list</span>      <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_names</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">unixtime_list</span>      <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">datetime_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">unixtime_to_datetime</span><span class="p">(</span><span class="n">unixtime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unixtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span>
        <span class="s">&#39;UNKNOWN&#39;</span>
        <span class="k">for</span> <span class="n">unixtime</span> <span class="ow">in</span> <span class="n">unixtime_list</span>
    <span class="p">]</span>
    <span class="n">datetime_split_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">datetime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">datetime</span> <span class="ow">in</span> <span class="n">datetime_list</span> <span class="p">]</span>
    <span class="n">date_list</span>      <span class="o">=</span> <span class="p">[</span> <span class="n">datetime_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datetime_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s">&#39;UNKNOWN&#39;</span> <span class="k">for</span> <span class="n">datetime_split</span> <span class="ow">in</span> <span class="n">datetime_split_list</span> <span class="p">]</span>
    <span class="n">time_list</span>      <span class="o">=</span> <span class="p">[</span> <span class="n">datetime_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datetime_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s">&#39;UNKNOWN&#39;</span> <span class="k">for</span> <span class="n">datetime_split</span> <span class="ow">in</span> <span class="n">datetime_split_list</span> <span class="p">]</span>
    <span class="n">lat_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_lat</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">lon_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_lon</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">marked_list</span>    <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">flag_aids_count</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">seen_list</span>      <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen_set</span>       <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_set</span><span class="p">:</span>
            <span class="n">seen_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">seen_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">seen_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">complete</span><span class="p">:</span>
        <span class="n">cols_list</span>      <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;annotation_id&#39;</span><span class="p">,</span>        <span class="n">aid_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;annotation_species&#39;</span><span class="p">,</span>   <span class="n">species_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;annotation_viewpoint&#39;</span><span class="p">,</span> <span class="n">viewpoint_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;annotation_qualities&#39;</span><span class="p">,</span> <span class="n">quality_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;annotation_sex&#39;</span><span class="p">,</span>       <span class="n">sex_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;annotation_age_min&#39;</span><span class="p">,</span>   <span class="n">age_min_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;annotation_age_max&#39;</span><span class="p">,</span>   <span class="n">age_max_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;annotation_name&#39;</span><span class="p">,</span>      <span class="n">name_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;image_id&#39;</span><span class="p">,</span>             <span class="n">gid_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;image_contributor&#39;</span><span class="p">,</span>    <span class="n">contrib_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;image_car&#39;</span><span class="p">,</span>            <span class="n">car_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;image_filename&#39;</span><span class="p">,</span>       <span class="n">uri_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;image_unixtime&#39;</span><span class="p">,</span>       <span class="n">unixtime_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;image_time_str&#39;</span><span class="p">,</span>       <span class="n">time_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;image_date_str&#39;</span><span class="p">,</span>       <span class="n">date_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;image_lat&#39;</span><span class="p">,</span>            <span class="n">lat_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;image_lon&#39;</span><span class="p">,</span>            <span class="n">lon_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;flag_first_seen&#39;</span><span class="p">,</span>      <span class="n">seen_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;flag_marked&#39;</span><span class="p">,</span>          <span class="n">marked_list</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cols_list</span>      <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;annotation_id&#39;</span><span class="p">,</span>        <span class="n">aid_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;image_time_str&#39;</span><span class="p">,</span>       <span class="n">time_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;image_date_str&#39;</span><span class="p">,</span>       <span class="n">date_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;flag_first_seen&#39;</span><span class="p">,</span>      <span class="n">seen_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;image_lat&#39;</span><span class="p">,</span>            <span class="n">lat_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;image_lon&#39;</span><span class="p">,</span>            <span class="n">lon_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;image_car&#39;</span><span class="p">,</span>            <span class="n">car_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;annotation_age_min&#39;</span><span class="p">,</span>   <span class="n">age_min_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;annotation_age_max&#39;</span><span class="p">,</span>   <span class="n">age_max_list</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;annotation_sex&#39;</span><span class="p">,</span>       <span class="n">sex_list</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="n">header_list</span>    <span class="o">=</span> <span class="p">[[</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">cols</span> <span class="ow">in</span> <span class="n">cols_list</span> <span class="p">]]</span>
    <span class="n">data_list</span>      <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">cols</span> <span class="ow">in</span> <span class="n">cols_list</span> <span class="p">])</span>
    <span class="n">line_list</span>      <span class="o">=</span> <span class="p">[</span> <span class="n">sanitize_list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">header_list</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span> <span class="p">]</span>
    <span class="k">return</span> <span class="n">line_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="report_sightings_str"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.report_sightings_str">[docs]</a><span class="k">def</span> <span class="nf">report_sightings_str</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">complete</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">line_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">report_sightings</span><span class="p">(</span><span class="n">complete</span><span class="o">=</span><span class="n">complete</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line_list</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="check_chip_existence"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_chip_existence">[docs]</a><span class="k">def</span> <span class="nf">check_chip_existence</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chip_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">chip_fpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_chip_fpath</span><span class="p">(</span><span class="n">cid_list</span><span class="p">)</span>
    <span class="n">flag_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="bp">True</span> <span class="k">if</span> <span class="n">chip_fpath</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">exists</span><span class="p">(</span><span class="n">chip_fpath</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chip_fpath</span> <span class="ow">in</span> <span class="n">chip_fpath_list</span>
    <span class="p">]</span>
    <span class="n">cid_kill_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">cid_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cid_kill_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;found </span><span class="si">%d</span><span class="s"> inconsistent chips attempting to fix&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">cid_kill_list</span><span class="p">))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_chips</span><span class="p">(</span><span class="n">cid_kill_list</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="is_special_encounter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.is_special_encounter">[docs]</a><span class="k">def</span> <span class="nf">is_special_encounter</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid_list</span><span class="p">):</span>
    <span class="n">enctext_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_text</span><span class="p">(</span><span class="n">eid_list</span><span class="p">)</span>
    <span class="n">isspecial_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">enctext</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">SPECIAL_ENCOUNTER_LABELS</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">enctext</span> <span class="ow">in</span> <span class="n">enctext_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">isspecial_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_quality_viewpoint_filterflags"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_quality_viewpoint_filterflags">[docs]</a><span class="k">def</span> <span class="nf">get_quality_viewpoint_filterflags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">minqual</span><span class="p">,</span> <span class="n">valid_yaws</span><span class="p">):</span>
    <span class="n">qual_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_qualities</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">yaw_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">qual_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">qual</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">qual</span> <span class="o">&gt;</span> <span class="n">minqual</span> <span class="k">for</span> <span class="n">qual</span> <span class="ow">in</span> <span class="n">qual_list</span><span class="p">)</span>
    <span class="n">yaw_flags</span>  <span class="o">=</span> <span class="p">(</span><span class="n">yaw</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="n">valid_yaws</span> <span class="k">for</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="n">yaw_list</span><span class="p">)</span>
    <span class="n">flags_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">and_iters</span><span class="p">(</span><span class="n">qual_flags</span><span class="p">,</span> <span class="n">yaw_flags</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">flags_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_custom_filterflags"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_custom_filterflags">[docs]</a><span class="k">def</span> <span class="nf">get_annot_custom_filterflags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">enable_custom_filter</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">minqual</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">QUALITY_TEXT_TO_INT</span><span class="p">[</span><span class="s">&#39;poor&#39;</span><span class="p">]</span>
    <span class="c">#valid_yaws = {&#39;left&#39;, &#39;frontleft&#39;, &#39;backleft&#39;}</span>
    <span class="n">valid_yawtexts</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;left&#39;</span><span class="p">,</span> <span class="s">&#39;frontleft&#39;</span><span class="p">}</span>
    <span class="n">flags_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_quality_viewpoint_filterflags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">minqual</span><span class="p">,</span> <span class="n">valid_yawtexts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flags_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="filter_aids_custom"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_aids_custom">[docs]</a><span class="k">def</span> <span class="nf">filter_aids_custom</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: aid_list_</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-filter_aids_custom</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb2&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; aid_list_ = filter_aids_custom(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = str(aid_list_)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">enable_custom_filter</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">aid_list</span>
    <span class="n">flags_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_custom_filterflags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ifilter_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">))</span>
    <span class="c">#aid_list_ = list(ut.list_compress(aid_list, flags_list))</span>
    <span class="k">return</span> <span class="n">aid_list_</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="flag_aids_count"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.flag_aids_count">[docs]</a><span class="k">def</span> <span class="nf">flag_aids_count</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>
<span class="sd">        pre_unixtime_sort (bool):</span>

<span class="sd">    Returns:</span>
<span class="sd">        ?:</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-flag_aids_count</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; gzc_flag_list = flag_aids_count(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; result = gzc_flag_list</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [False, True, False, False, True, False, True, True, False, True, False, True, True]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Get primitives</span>
    <span class="n">unixtime_list</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">index_list</span>     <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_argsort</span><span class="p">(</span><span class="n">unixtime_list</span><span class="p">)</span>
    <span class="n">aid_list</span>       <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">unixtime_list</span><span class="p">)</span>
    <span class="n">gid_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">nid_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">contrib_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_contributor_tag</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="c"># Get filter flags for aids</span>
    <span class="n">flag_list</span>      <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_custom_filterflags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">isunknown_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_aid_unknown</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">flag_list</span>      <span class="o">=</span> <span class="p">[</span> <span class="ow">not</span> <span class="n">unknown</span> <span class="ow">and</span> <span class="n">flag</span> <span class="k">for</span> <span class="n">unknown</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">isunknown_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span> <span class="p">]</span>
    <span class="c"># Filter by seen and car</span>
    <span class="n">flag_list_</span>     <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen_dict</span>      <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
    <span class="c"># Mark the first annotation (for each name) seen per car</span>
    <span class="n">values_list</span>    <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">,</span> <span class="n">contrib_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">contrib</span> <span class="ow">in</span> <span class="n">values_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">contrib_</span> <span class="o">=</span> <span class="n">_split_car_contrib_tag</span><span class="p">(</span><span class="n">contrib</span><span class="p">,</span> <span class="n">distinguish_invalids</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_dict</span><span class="p">[</span><span class="n">contrib_</span><span class="p">]:</span>
                <span class="n">seen_dict</span><span class="p">[</span><span class="n">contrib_</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
                <span class="n">flag_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="n">flag_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="c"># Take the inverse of the sorted</span>
    <span class="n">gzc_flag_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_inverse_take</span><span class="p">(</span><span class="n">flag_list_</span><span class="p">,</span> <span class="n">index_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gzc_flag_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="filter_aids_count"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_aids_count">[docs]</a><span class="k">def</span> <span class="nf">filter_aids_count</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pre_unixtime_sort</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># Get all aids and pre-sort by unixtime</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pre_unixtime_sort</span><span class="p">:</span>
            <span class="n">unixtime_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
            <span class="n">aid_list</span>      <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">unixtime_list</span><span class="p">)</span>
    <span class="n">flags_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">flag_aids_count</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">aid_list_</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ifilter_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">aid_list_</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="filterflags_unflat_aids_custom"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filterflags_unflat_aids_custom">[docs]</a><span class="k">def</span> <span class="nf">filterflags_unflat_aids_custom</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">some</span><span class="p">(</span><span class="n">flags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; like any, but some at least one must be True &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
    <span class="n">filtered_aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_custom_filterflags</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="n">isvalid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">some</span><span class="p">,</span> <span class="n">filtered_aids_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">isvalid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="filter_nids_custom"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_nids_custom">[docs]</a><span class="k">def</span> <span class="nf">filter_nids_custom</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">isvalid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filterflags_unflat_aids_custom</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="n">filtered_nid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered_nid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="filter_gids_custom"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_gids_custom">[docs]</a><span class="k">def</span> <span class="nf">filter_gids_custom</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">isvalid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filterflags_unflat_aids_custom</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="n">filtered_gid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered_gid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_name_gps_tracks"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_name_gps_tracks">[docs]</a><span class="k">def</span> <span class="nf">get_name_gps_tracks</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_name_gps_tracks</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; #ibs = ibeis.opendb(&#39;PZ_Master0&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #nid_list = ibs.get_valid_nids()</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; nid_list, gps_track_list, aid_track_list = ibs.get_name_gps_tracks(aid_list=aid_list)</span>
<span class="sd">        &gt;&gt;&gt; nonempty_list = list(map(lambda x: len(x) &gt; 0, gps_track_list))</span>
<span class="sd">        &gt;&gt;&gt; ut.list_compress(nid_list, nonempty_list)</span>
<span class="sd">        &gt;&gt;&gt; ut.list_compress(gps_track_list, nonempty_list)</span>
<span class="sd">        &gt;&gt;&gt; ut.list_compress(aid_track_list, nonempty_list)</span>
<span class="sd">        &gt;&gt;&gt; result = str(aid_track_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [[11], [], [4], [1], [2, 3], [5, 6], [7], [8], [10], [12], [13]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">nid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;only specify one please&#39;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aids_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aids_list_</span><span class="p">,</span> <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes</span><span class="p">(</span><span class="n">aids</span><span class="p">))</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list_</span><span class="p">]</span>
    <span class="n">gids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="n">gpss_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_image_gps</span><span class="p">,</span> <span class="n">gids_list</span><span class="p">)</span>

    <span class="n">isvalids_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">gps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="ow">or</span> <span class="n">gps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="k">for</span> <span class="n">gps</span> <span class="ow">in</span> <span class="n">gpss</span><span class="p">]</span> <span class="k">for</span> <span class="n">gpss</span> <span class="ow">in</span> <span class="n">gpss_list</span><span class="p">]</span>
    <span class="n">gps_track_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">list_compress</span><span class="p">(</span><span class="n">gpss</span><span class="p">,</span> <span class="n">isvalids</span><span class="p">)</span> <span class="k">for</span> <span class="n">gpss</span><span class="p">,</span> <span class="n">isvalids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gpss_list</span><span class="p">,</span> <span class="n">isvalids_list</span><span class="p">)]</span>
    <span class="n">aid_track_list</span>  <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">list_compress</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">isvalids</span><span class="p">)</span> <span class="k">for</span> <span class="n">aids</span><span class="p">,</span> <span class="n">isvalids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aids_list</span><span class="p">,</span> <span class="n">isvalids_list</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">nid_list</span><span class="p">,</span> <span class="n">gps_track_list</span><span class="p">,</span> <span class="n">aid_track_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_unflat_annots_kmdists_list"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_unflat_annots_kmdists_list">[docs]</a><span class="k">def</span> <span class="nf">get_unflat_annots_kmdists_list</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">):</span>
    <span class="c">#ibs.check_name_mapping_consistency(aids_list)</span>
    <span class="n">latlons_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_gps</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="n">latlon_arrs</span>   <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">latlons</span><span class="p">)</span> <span class="k">for</span> <span class="n">latlons</span> <span class="ow">in</span> <span class="n">latlons_list</span><span class="p">]</span>
    <span class="n">km_dists_list</span>   <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">safe_pdist</span><span class="p">(</span><span class="n">latlon_arr</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">haversine</span><span class="p">)</span> <span class="k">for</span> <span class="n">latlon_arr</span> <span class="ow">in</span> <span class="n">latlon_arrs</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">km_dists_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_unflat_annots_hourdists_list"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_unflat_annots_hourdists_list">[docs]</a><span class="k">def</span> <span class="nf">get_unflat_annots_hourdists_list</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = testdata_ibs(&#39;NNP_Master3&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nid_list = get_valid_multiton_nids_custom(ibs)</span>
<span class="sd">        &gt;&gt;&gt; aids_list_ = ibs.get_name_aids(nid_list)</span>
<span class="sd">        &gt;&gt;&gt; aids_list = [ibs.filter_aids_custom(aids) for aids in aids_list_]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">isunique</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)))</span>
    <span class="n">unixtimes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="c">#assert all(list(map(ut.isunique, unixtimes_list)))</span>
    <span class="n">unixtime_arrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unixtimes</span><span class="p">)[:,</span> <span class="bp">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">unixtimes</span> <span class="ow">in</span> <span class="n">unixtimes_list</span><span class="p">]</span>
    <span class="n">hour_dists_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">safe_pdist</span><span class="p">(</span><span class="n">unixtime_arr</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">unixtime_hourdiff</span><span class="p">)</span> <span class="k">for</span> <span class="n">unixtime_arr</span> <span class="ow">in</span> <span class="n">unixtime_arrs</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">hour_dists_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_unflat_annots_speeds_list"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_unflat_annots_speeds_list">[docs]</a><span class="k">def</span> <span class="nf">get_unflat_annots_speeds_list</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">):</span>
    <span class="n">km_dists_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annots_kmdists_list</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="n">hour_dists_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annots_hourdists_list</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="n">speeds_list</span>     <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">safe_div</span><span class="p">(</span><span class="n">km_dists</span><span class="p">,</span> <span class="n">hours_dists</span><span class="p">)</span> <span class="k">for</span> <span class="n">km_dists</span><span class="p">,</span> <span class="n">hours_dists</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">km_dists_list</span><span class="p">,</span> <span class="n">hour_dists_list</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">speeds_list</span>

</div>
<div class="viewcode-block" id="testdata_ibs"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.testdata_ibs">[docs]</a><span class="k">def</span> <span class="nf">testdata_ibs</span><span class="p">(</span><span class="n">defaultdb</span><span class="o">=</span><span class="s">&#39;testdb1&#39;</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">ibeis</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="n">defaultdb</span><span class="o">=</span><span class="n">defaultdb</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ibs</span>

</div>
<div class="viewcode-block" id="get_valid_multiton_nids_custom"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_valid_multiton_nids_custom">[docs]</a><span class="k">def</span> <span class="nf">get_valid_multiton_nids_custom</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">nid_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_known_nids</span><span class="p">()</span>
    <span class="n">ismultiton_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_custom</span><span class="p">(</span><span class="n">aids</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list_</span><span class="p">)]</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_compress</span><span class="p">(</span><span class="n">nid_list_</span><span class="p">,</span> <span class="n">ismultiton_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_name_speeds"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_name_speeds">[docs]</a><span class="k">def</span> <span class="nf">get_name_speeds</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_name_speeds</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = testdata_ibs(&#39;NNP_Master3&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nid_list = get_valid_multiton_nids_custom(ibs)</span>
<span class="sd">        &gt;&gt;&gt; speeds_list = get_name_speeds(ibs, nid_list)</span>
<span class="sd">        &gt;&gt;&gt; result = str(speeds_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aids_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="c">#ibs.check_name_mapping_consistency(aids_list_)</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_custom</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list_</span><span class="p">]</span>
    <span class="n">speeds_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annots_speeds_list</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">speeds_list</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@accessor_decors.getter</span>
<div class="viewcode-block" id="get_name_hourdiffs"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_name_hourdiffs">[docs]</a><span class="k">def</span> <span class="nf">get_name_hourdiffs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_name_hourdiffs</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = testdata_ibs(&#39;NNP_Master3&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nid_list = ibs.filter_nids_custom(ibs._get_all_known_nids())</span>
<span class="sd">        &gt;&gt;&gt; hourdiffs_list = ibs.get_name_hourdiffs(nid_list)</span>
<span class="sd">        &gt;&gt;&gt; result = hourdiffs_list</span>
<span class="sd">        &gt;&gt;&gt; print(hourdiffs_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aids_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="c">#ibs.check_name_mapping_consistency(aids_list_)</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_custom</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list_</span><span class="p">]</span>
    <span class="n">hourdiffs_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annots_hourdists_list</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hourdiffs_list</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@accessor_decors.getter</span>
<div class="viewcode-block" id="get_name_max_hourdiff"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_name_max_hourdiff">[docs]</a><span class="k">def</span> <span class="nf">get_name_max_hourdiff</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="n">hourdiffs_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_hourdiffs</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">maxhourdiff_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">safe_max</span><span class="p">,</span> <span class="n">hourdiffs_list</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">maxhourdiff_list</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@accessor_decors.getter</span>
<div class="viewcode-block" id="get_name_max_speed"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_name_max_speed">[docs]</a><span class="k">def</span> <span class="nf">get_name_max_speed</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_name_max_speed</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = testdata_ibs(&#39;NNP_Master3&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nid_list = ibs.filter_nids_custom(ibs._get_all_known_nids())</span>
<span class="sd">        &gt;&gt;&gt; maxspeed_list = ibs.get_name_max_speed(nid_list)</span>
<span class="sd">        &gt;&gt;&gt; result = maxspeed_list</span>
<span class="sd">        &gt;&gt;&gt; print(maxspeed_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">speeds_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_speeds</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">maxspeed_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">safe_max</span><span class="p">,</span> <span class="n">speeds_list</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">maxspeed_list</span>

</div>
<div class="viewcode-block" id="get_fastest_names"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_fastest_names">[docs]</a><span class="k">def</span> <span class="nf">get_fastest_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_fastest_names</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = testdata_ibs(&#39;NNP_Master3&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nid_list = None</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; nid_list_, maxspeed_list_ = get_fastest_names(ibs, nid_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = str(list(zip(nid_list_, maxspeed_list_))[0:10])</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_known_nids</span><span class="p">()</span>
    <span class="n">maxspeed_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_max_speed</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="c"># filter nans</span>
    <span class="n">notnan_flags</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">maxspeed_list</span><span class="p">)</span>
    <span class="n">maxspeed_list__</span> <span class="o">=</span> <span class="n">maxspeed_list</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">notnan_flags</span><span class="p">)</span>
    <span class="n">nid_list__</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">notnan_flags</span><span class="p">)</span>
    <span class="c"># sort by speed</span>
    <span class="n">sortx</span> <span class="o">=</span> <span class="n">maxspeed_list__</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nid_list_</span>      <span class="o">=</span> <span class="n">nid_list__</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">)</span>
    <span class="n">maxspeed_list_</span> <span class="o">=</span> <span class="n">maxspeed_list__</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nid_list_</span><span class="p">,</span> <span class="n">maxspeed_list_</span>

</div>
<div class="viewcode-block" id="find_location_disparate_splits"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.find_location_disparate_splits">[docs]</a><span class="k">def</span> <span class="nf">find_location_disparate_splits</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-find_location_disparate_splits</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;NNP_Master3&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; offending_nids = find_location_disparate_splits(ibs)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;offending_nids = %r&#39; % (offending_nids,))</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">as</span> <span class="nn">spdist</span>
    <span class="kn">import</span> <span class="nn">functools</span>
    <span class="c">#aid_list_count = ibs.get_valid_aids()</span>
    <span class="n">aid_list_count</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_count</span><span class="p">()</span>
    <span class="n">nid_list</span><span class="p">,</span> <span class="n">gps_track_list</span><span class="p">,</span> <span class="n">aid_track_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_gps_tracks</span><span class="p">(</span><span class="n">aid_list</span><span class="o">=</span><span class="n">aid_list_count</span><span class="p">)</span>

    <span class="c"># Filter to only multitons</span>
    <span class="n">has_multiple_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">gps_track</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">gps_track</span> <span class="ow">in</span> <span class="n">gps_track_list</span><span class="p">]</span>
    <span class="n">gps_track_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_compress</span><span class="p">(</span><span class="n">gps_track_list</span><span class="p">,</span> <span class="n">has_multiple_list</span><span class="p">)</span>
    <span class="n">aid_track_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_compress</span><span class="p">(</span><span class="n">aid_track_list</span><span class="p">,</span> <span class="n">has_multiple_list</span><span class="p">)</span>
    <span class="n">nid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_compress</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">has_multiple_list</span><span class="p">)</span>

    <span class="c"># Other properties</span>
    <span class="n">unixtime_track_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes</span><span class="p">,</span> <span class="n">aid_track_list_</span><span class="p">)</span>

    <span class="c"># Move into arrays</span>
    <span class="n">gpsarr_track_list_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">gps_track_list_</span><span class="p">))</span>
    <span class="n">unixtimearr_track_list_</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unixtimes</span><span class="p">)[:,</span> <span class="bp">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">unixtimes</span> <span class="ow">in</span> <span class="n">unixtime_track_list_</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">unixtime_hourdiff</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">haversin_pdist</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">spdist</span><span class="o">.</span><span class="n">pdist</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">haversine</span><span class="p">)</span>
    <span class="n">unixtime_pdist</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">spdist</span><span class="o">.</span><span class="n">pdist</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">unixtime_hourdiff</span><span class="p">)</span>
    <span class="c"># Get distances</span>
    <span class="n">gpsdist_vector_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">haversin_pdist</span><span class="p">,</span> <span class="n">gpsarr_track_list_</span><span class="p">))</span>
    <span class="n">hourdist_vector_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">unixtime_pdist</span><span class="p">,</span> <span class="n">unixtimearr_track_list_</span><span class="p">))</span>

    <span class="c"># Get the speed in kilometers per hour for each animal</span>
    <span class="n">speed_vector_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gpsdist</span> <span class="o">/</span> <span class="n">hourdist</span> <span class="k">for</span> <span class="n">gpsdist</span><span class="p">,</span> <span class="n">hourdist</span> <span class="ow">in</span>
                         <span class="nb">zip</span><span class="p">(</span><span class="n">gpsdist_vector_list</span><span class="p">,</span> <span class="n">hourdist_vector_list</span><span class="p">)]</span>

    <span class="c">#maxhourdist_list = np.array([hourdist_vector.max() for hourdist_vector in hourdist_vector_list])</span>
    <span class="n">maxgpsdist_list</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">gpsdist_vector</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">gpsdist_vector</span> <span class="ow">in</span> <span class="n">gpsdist_vector_list</span><span class="p">])</span>
    <span class="n">maxspeed_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">speed_vector</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">speed_vector</span> <span class="ow">in</span> <span class="n">speed_vector_list</span><span class="p">])</span>
    <span class="n">sortx</span>  <span class="o">=</span> <span class="n">maxspeed_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">sorted_maxspeed_list</span> <span class="o">=</span> <span class="n">maxspeed_list</span><span class="p">[</span><span class="n">sortx</span><span class="p">]</span>
    <span class="c">#sorted_nid_list = np.array(ut.list_take(nid_list_, sortx))</span>

    <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sorted_maxspeed_list</span><span class="p">)</span>
        <span class="n">allgpsdist_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">gpsdist_vector_list</span><span class="p">))</span>
        <span class="n">alltimedist_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">hourdist_vector_list</span><span class="p">))</span>

        <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">doclf</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">docla</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">alltime_sortx</span> <span class="o">=</span> <span class="n">alltimedist_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">allgpsdist_list</span><span class="p">[</span><span class="n">alltime_sortx</span><span class="p">])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alltimedist_list</span><span class="p">[</span><span class="n">alltime_sortx</span><span class="p">])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">iup</span><span class="p">()</span>

        <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum1</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">doclf</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">docla</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">allgps_sortx</span> <span class="o">=</span> <span class="n">allgpsdist_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">allgpsdist_list</span><span class="p">[</span><span class="n">allgps_sortx</span><span class="p">])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alltimedist_list</span><span class="p">[</span><span class="n">allgps_sortx</span><span class="p">])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">iup</span><span class="p">()</span>

        <span class="c">#maxgps_sortx = maxgpsdist_list.argsort()</span>
        <span class="c">#pt.plot(maxgpsdist_list[maxgps_sortx])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">iup</span><span class="p">()</span>

    <span class="n">maxgps_sortx</span> <span class="o">=</span> <span class="n">maxgpsdist_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">gpsdist_thresh</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">sorted_maxgps_list</span> <span class="o">=</span> <span class="n">maxgpsdist_list</span><span class="p">[</span><span class="n">maxgps_sortx</span><span class="p">]</span>
    <span class="n">offending_sortx</span> <span class="o">=</span> <span class="n">maxgps_sortx</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">sorted_maxgps_list</span> <span class="o">&gt;</span> <span class="n">gpsdist_thresh</span><span class="p">)</span>

    <span class="n">speed_thresh_kph</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c"># kilometers per hour</span>
    <span class="n">offending_sortx</span> <span class="o">=</span> <span class="n">sortx</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">sorted_maxspeed_list</span> <span class="o">&gt;</span> <span class="n">speed_thresh_kph</span><span class="p">)</span>
    <span class="c">#sorted_isoffending = sorted_maxspeed_list &gt; speed_thresh_kph</span>
    <span class="c">#offending_nids = sorted_nid_list.compress(sorted_isoffending)</span>
    <span class="n">offending_nids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">nid_list_</span><span class="p">,</span> <span class="n">offending_sortx</span><span class="p">)</span>
    <span class="c">#offending_speeds = ut.list_take(maxspeed_list, offending_sortx)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;offending_nids = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">offending_nids</span><span class="p">,))</span>

    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">offending_sortx</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">--- Offender index=</span><span class="si">%d</span><span class="s"> ---&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>
        <span class="c"># Inspect a specific index</span>
        <span class="n">aids</span> <span class="o">=</span> <span class="n">aid_track_list_</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">nid</span> <span class="o">=</span> <span class="n">nid_list_</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aids</span><span class="p">))</span> <span class="o">==</span> <span class="n">nid</span><span class="p">)</span>

        <span class="n">aid1_list</span><span class="p">,</span> <span class="n">aid2_list</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">aids</span><span class="p">)))</span>
        <span class="n">annotmatch_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_rowid_from_superkey</span><span class="p">(</span><span class="n">aid1_list</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">)</span>
        <span class="n">annotmatch_truth_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_truth</span><span class="p">(</span><span class="n">annotmatch_rowid_list</span><span class="p">)</span>
        <span class="n">annotmatch_truth_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">replace_nones</span><span class="p">(</span><span class="n">annotmatch_truth_list</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">truth_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">annotmatch_truth_list</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)))</span>

        <span class="n">contrib_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_contributor_rowid</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aids</span><span class="p">))</span>
        <span class="n">contrib_tags</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_contributor_tag</span><span class="p">(</span><span class="n">contrib_rowids</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;nid = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nid</span><span class="p">,))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;maxspeed = </span><span class="si">%.2f</span><span class="s"> km/h&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxspeed_list</span><span class="p">[</span><span class="n">index</span><span class="p">],))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;aids = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aids</span><span class="p">,))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;gpss = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">gps_track_list_</span><span class="p">[</span><span class="n">index</span><span class="p">]),))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;contribs = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">contrib_tags</span><span class="p">),))</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;speedist_mat = </span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">numpy_str</span><span class="p">(</span><span class="n">spdist</span><span class="o">.</span><span class="n">squareform</span><span class="p">(</span><span class="n">speed_vector_list</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">truth_mat_str</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">numpy_str</span><span class="p">(</span><span class="n">truth_mat</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">truth_mat_str</span> <span class="o">=</span> <span class="n">truth_mat_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-1&#39;</span> <span class="p">,</span> <span class="s">&#39; _&#39;</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;truth_mat = </span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">truth_mat_str</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;gpsdist_mat  = </span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">numpy_str</span><span class="p">(</span><span class="n">spdist</span><span class="o">.</span><span class="n">squareform</span><span class="p">(</span><span class="n">gpsdist_vector_list</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;hourdist_mat = </span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">numpy_str</span><span class="p">(</span><span class="n">spdist</span><span class="o">.</span><span class="n">squareform</span><span class="p">(</span><span class="n">hourdist_vector_list</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">offending_nids</span>

    <span class="c">#gpsdist_matrix_list = list(map(spdist.squareform, gpsdist_vector_list))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="find_offending_contributors"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.find_offending_contributors">[docs]</a><span class="k">def</span> <span class="nf">find_offending_contributors</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">lat_min</span><span class="p">,</span> <span class="n">lon_min</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.340726</span><span class="p">,</span> <span class="mf">36.792234</span><span class="p">)</span>
    <span class="n">lat_max</span><span class="p">,</span> <span class="n">lon_max</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.341633</span><span class="p">,</span> <span class="mf">36.793340</span><span class="p">)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">gps_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_gps</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>

    <span class="n">gid_list_filtered</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">gid</span>
        <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">gps_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lat_min</span> <span class="o">&gt;=</span> <span class="n">lat</span> <span class="ow">and</span> <span class="n">lat</span> <span class="o">&gt;=</span> <span class="n">lat_max</span>  <span class="ow">and</span> <span class="n">lon_min</span> <span class="o">&lt;=</span> <span class="n">lon</span> <span class="ow">and</span> <span class="n">lon</span> <span class="o">&lt;=</span> <span class="n">lon_max</span>
    <span class="p">]</span>
    <span class="n">contrib_list_filtered</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_contributor_tag</span><span class="p">(</span><span class="n">gid_list_filtered</span><span class="p">)</span>

    <span class="n">contribs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">contrib</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gid_list_filtered</span><span class="p">,</span> <span class="n">contrib_list_filtered</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">contrib</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">contribs</span><span class="p">:</span>
            <span class="n">contribs</span><span class="p">[</span><span class="n">contrib</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">contribs</span><span class="p">[</span><span class="n">contrib</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>

    <span class="n">lengths_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">contribs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="p">[</span> <span class="nb">len</span><span class="p">(</span><span class="n">contribs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">contribs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">]))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">lengths_list</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="export_nnp_master3_subset"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.export_nnp_master3_subset">[docs]</a><span class="k">def</span> <span class="nf">export_nnp_master3_subset</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-export_nnp_master3_subset</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;NNP_Master3&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = export_nnp_master3_subset(ibs)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Get the subset of the dataset marked as difficult</span>
    <span class="n">annotmatch_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_annotmatch_rowids</span><span class="p">()</span>
    <span class="n">ishard_list</span>         <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_is_hard</span><span class="p">(</span><span class="n">annotmatch_rowid_list</span><span class="p">)</span>
    <span class="n">isphotobomb_list</span>    <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_is_photobomb</span><span class="p">(</span><span class="n">annotmatch_rowid_list</span><span class="p">)</span>
    <span class="n">isscenerymatch_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_is_scenerymatch</span><span class="p">(</span><span class="n">annotmatch_rowid_list</span><span class="p">)</span>
    <span class="n">isnondistinct_list</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_is_nondistinct</span><span class="p">(</span><span class="n">annotmatch_rowid_list</span><span class="p">)</span>
    <span class="n">hards</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">replace_nones</span><span class="p">(</span><span class="n">ishard_list</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
    <span class="n">photobombs</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">replace_nones</span><span class="p">(</span><span class="n">isphotobomb_list</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
    <span class="n">scenerys</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">replace_nones</span><span class="p">(</span><span class="n">isscenerymatch_list</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
    <span class="n">nondistincts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">replace_nones</span><span class="p">(</span><span class="n">isnondistinct_list</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">and_lists</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">or_lists</span><span class="p">(</span><span class="n">hards</span><span class="p">,</span> <span class="n">nondistincts</span><span class="p">),</span> <span class="o">~</span><span class="n">photobombs</span><span class="p">,</span> <span class="o">~</span><span class="n">scenerys</span><span class="p">)</span>
    <span class="n">annotmatch_rowid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_compress</span><span class="p">(</span><span class="n">annotmatch_rowid_list</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

    <span class="n">aid1_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_aid1</span><span class="p">(</span><span class="n">annotmatch_rowid_list_</span><span class="p">)</span>
    <span class="n">aid2_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_aid2</span><span class="p">(</span><span class="n">annotmatch_rowid_list_</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aid1_list</span> <span class="o">+</span> <span class="n">aid2_list</span><span class="p">)))</span>
    <span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">dbio</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))))</span>
    <span class="n">dbio</span><span class="o">.</span><span class="n">export_subset</span><span class="o">.</span><span class="n">export_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">new_dbpath</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_workdir</span><span class="p">(),</span> <span class="s">&#39;testdb3&#39;</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="mark_annot_pair_as_positive_match"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.mark_annot_pair_as_positive_match">[docs]</a><span class="k">def</span> <span class="nf">mark_annot_pair_as_positive_match</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">on_nontrivial_merge</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO: ELEVATE THIS FUNCTION</span>
<span class="sd">    Change into make_task_mark_annot_pair_as_positive_match and it returns what</span>
<span class="sd">    needs to be done.</span>

<span class="sd">    Need to test several cases:</span>
<span class="sd">        uknown, unknown</span>
<span class="sd">        knownA, knownA</span>
<span class="sd">        knownB, knownA</span>
<span class="sd">        unknown, knownA</span>
<span class="sd">        knownA, unknown</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid1 (int):  query annotation id</span>
<span class="sd">        aid2 (int):  matching annotation id</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.gui.inspect_gui --test-mark_annot_pair_as_positive_match</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.gui.inspect_gui import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid1, aid2 = ibs.get_valid_aids()[0:2]</span>
<span class="sd">        &gt;&gt;&gt; dryrun = True</span>
<span class="sd">        &gt;&gt;&gt; status = mark_annot_pair_as_positive_match(ibs, aid1, aid2, dryrun)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(status)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_set_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">QUIET</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;... _set_annot_name_rowids(aids=</span><span class="si">%r</span><span class="s">, nids=</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;... names = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">),</span> <span class="s">&#39;list must correspond&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dryrun</span><span class="p">:</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">mark_annot_pair_as_reviewed</span><span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span>
            <span class="c">#ibs.add_or_update_annotmatch(aid1, aid2, const.TRUTH_MATCH, [1.0])</span>
        <span class="c"># Return the new annots in this name</span>
        <span class="n">_aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
        <span class="n">_combo_aids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_aids</span> <span class="o">+</span> <span class="p">[</span><span class="n">aid</span><span class="p">]</span> <span class="k">for</span> <span class="n">_aids</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_aids_list</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)]</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">_combo_aids_list</span>
        <span class="k">return</span> <span class="n">status</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[marking_match] aid1 = </span><span class="si">%r</span><span class="s">, aid2 = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">))</span>

    <span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">([</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;...images already matched&#39;</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">mark_annot_pair_as_reviewed</span><span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">isunknown1</span><span class="p">,</span> <span class="n">isunknown2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_aid_unknown</span><span class="p">([</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">isunknown1</span> <span class="ow">and</span> <span class="n">isunknown2</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;...match unknown1 to unknown2 into 1 new name&#39;</span><span class="p">)</span>
            <span class="n">next_nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_nids</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span>  <span class="n">_set_annot_name_rowids</span><span class="p">([</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">],</span> <span class="n">next_nids</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">isunknown1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isunknown2</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;...merge known1 into known2&#39;</span><span class="p">)</span>
            <span class="n">aid1_and_groundtruth</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_groundtruth</span><span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">noself</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">aid2_and_groundtruth</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_groundtruth</span><span class="p">(</span><span class="n">aid2</span><span class="p">,</span> <span class="n">noself</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">trivial_merge</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid1_and_groundtruth</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid2_and_groundtruth</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">trivial_merge</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">on_nontrivial_merge</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;no function is set up to handle nontrivial merges!&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">on_nontrivial_merge</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span>  <span class="n">_set_annot_name_rowids</span><span class="p">(</span><span class="n">aid1_and_groundtruth</span><span class="p">,</span> <span class="p">[</span><span class="n">nid2</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid1_and_groundtruth</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">isunknown2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isunknown1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;...match unknown2 into known1&#39;</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span>  <span class="n">_set_annot_name_rowids</span><span class="p">([</span><span class="n">aid2</span><span class="p">],</span> <span class="p">[</span><span class="n">nid1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">isunknown1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isunknown2</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;...match unknown1 into known2&#39;</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span>  <span class="n">_set_annot_name_rowids</span><span class="p">([</span><span class="n">aid1</span><span class="p">],</span> <span class="p">[</span><span class="n">nid2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;impossible state&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="mark_annot_pair_as_negative_match"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.mark_annot_pair_as_negative_match">[docs]</a><span class="k">def</span> <span class="nf">mark_annot_pair_as_negative_match</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">on_nontrivial_split</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO: ELEVATE THIS FUNCTION</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid1 (int):  annotation id</span>
<span class="sd">        aid2 (int):  annotation id</span>
<span class="sd">        dryrun (bool):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.gui.inspect_gui --test-mark_annot_pair_as_negative_match</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.gui.inspect_gui import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid1, aid2 = ibs.get_valid_aids()[0:2]</span>
<span class="sd">        &gt;&gt;&gt; dryrun = True</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = mark_annot_pair_as_negative_match(ibs, aid1, aid2, dryrun)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_set_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;... _set_annot_name_rowids(</span><span class="si">%r</span><span class="s">, </span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dryrun</span><span class="p">:</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">mark_annot_pair_as_reviewed</span><span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span>
            <span class="c">#ibs.add_or_update_annotmatch(aid1, aid2, const.TRUTH_NOT_MATCH, [1.0])</span>
    <span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">([</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;images are marked as having the same name... we must tread carefully&#39;</span><span class="p">)</span>
        <span class="n">aid1_groundtruth</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_groundtruth</span><span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">noself</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid1_groundtruth</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">aid1_groundtruth</span> <span class="o">==</span> <span class="p">[</span><span class="n">aid2</span><span class="p">]:</span>
            <span class="c"># this is the only safe case for same name split</span>
            <span class="c"># Change so the names are not the same</span>
            <span class="n">next_nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_nids</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span>  <span class="n">_set_annot_name_rowids</span><span class="p">([</span><span class="n">aid1</span><span class="p">],</span> <span class="n">next_nids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">on_nontrivial_split</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;no function is set up to handle nontrivial splits!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">on_nontrivial_split</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">isunknown1</span><span class="p">,</span> <span class="n">isunknown2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_aid_unknown</span><span class="p">([</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">isunknown1</span> <span class="ow">and</span> <span class="n">isunknown2</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;...nonmatch unknown1 and unknown2 into 2 new names&#39;</span><span class="p">)</span>
            <span class="n">next_nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_nids</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span>  <span class="n">_set_annot_name_rowids</span><span class="p">([</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">],</span> <span class="n">next_nids</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">isunknown1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isunknown2</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;...nonmatch known1 and known2... nothing to do (yet)&#39;</span><span class="p">)</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">mark_annot_pair_as_reviewed</span><span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">isunknown2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isunknown1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;...nonmatch unknown2 -&gt; newname and known1&#39;</span><span class="p">)</span>
            <span class="n">next_nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_nids</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span>  <span class="n">_set_annot_name_rowids</span><span class="p">([</span><span class="n">aid2</span><span class="p">],</span> <span class="n">next_nids</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">isunknown1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isunknown2</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;...nonmatch unknown1 -&gt; newname and known2&#39;</span><span class="p">)</span>
            <span class="n">next_nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_nids</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span>  <span class="n">_set_annot_name_rowids</span><span class="p">([</span><span class="n">aid1</span><span class="p">],</span> <span class="n">next_nids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;impossible state&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="make_next_encounter_text"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.make_next_encounter_text">[docs]</a><span class="k">def</span> <span class="nf">make_next_encounter_text</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates what the next encounter name would be but does not add it to the database</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-make_next_encounter_text</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; new_enctext = make_next_encounter_text(ibs)</span>
<span class="sd">        &gt;&gt;&gt; result = new_enctext</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        New Encounter 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_eids</span><span class="p">()</span>
    <span class="n">old_enctext_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_text</span><span class="p">(</span><span class="n">eid_list</span><span class="p">)</span>
    <span class="n">new_enctext</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_nonconflicting_string</span><span class="p">(</span><span class="s">&#39;New Encounter </span><span class="si">%d</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">old_enctext_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_enctext</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="add_next_encounter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.add_next_encounter">[docs]</a><span class="k">def</span> <span class="nf">add_next_encounter</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a new encounter to the database</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_enctext</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_encounter_text</span><span class="p">()</span>
    <span class="p">(</span><span class="n">new_eid</span><span class="p">,)</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_encounters</span><span class="p">([</span><span class="n">new_enctext</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">new_eid</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="create_new_encounter_from_images"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.create_new_encounter_from_images">[docs]</a><span class="k">def</span> <span class="nf">create_new_encounter_from_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">eid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        gid_list (list):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-create_new_encounter_from_images</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; gid_list = ibs.get_valid_gids()[::2]</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; new_eid = create_new_encounter_from_images(ibs, gid_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = new_eid</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_eid</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">eid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">new_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_next_encounter</span><span class="p">()</span>
        <span class="n">eid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_eid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">eid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_eid</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="create_new_encounter_from_names"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.create_new_encounter_from_names">[docs]</a><span class="k">def</span> <span class="nf">create_new_encounter_from_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        nid_list (list):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-create_new_encounter_from_names</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nid_list = ibs._get_all_known_nids()[0:2]</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; new_eid = ibs.create_new_encounter_from_names(nid_list)</span>
<span class="sd">        &gt;&gt;&gt; # clean up</span>
<span class="sd">        &gt;&gt;&gt; ibs.delete_encounters(new_eid)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = new_eid</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">gids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">gids_list</span><span class="p">)</span>
    <span class="n">new_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">create_new_encounter_from_images</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_eid</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="prepare_annotgroup_review"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.prepare_annotgroup_review">[docs]</a><span class="k">def</span> <span class="nf">prepare_annotgroup_review</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (src_ag_rowid, dst_ag_rowid) - source and dest annot groups</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-prepare_annotgroup_review</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; result = prepare_annotgroup_review(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Build new names for source and dest annot groups</span>
    <span class="n">all_annotgroup_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_annotgroup_rowids</span><span class="p">()</span>
    <span class="n">all_annotgroup_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotgroup_text</span><span class="p">(</span><span class="n">all_annotgroup_rowid_list</span><span class="p">)</span>
    <span class="n">new_grouptext_src</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_nonconflicting_string</span><span class="p">(</span><span class="s">&#39;Source Group </span><span class="si">%d</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">all_annotgroup_text_list</span><span class="p">)</span>
    <span class="n">all_annotgroup_text_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">new_grouptext_src</span><span class="p">]</span>
    <span class="n">new_grouptext_dst</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_nonconflicting_string</span><span class="p">(</span><span class="s">&#39;Dest Group </span><span class="si">%d</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">all_annotgroup_text_list</span><span class="p">)</span>
    <span class="c"># Add new empty groups</span>
    <span class="n">annotgroup_text_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_grouptext_src</span><span class="p">,</span> <span class="n">new_grouptext_dst</span><span class="p">]</span>
    <span class="n">annotgroup_uuid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">hashable_to_uuid</span><span class="p">,</span> <span class="n">annotgroup_text_list</span><span class="p">))</span>
    <span class="n">annotgroup_note_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">]</span>
    <span class="n">src_ag_rowid</span><span class="p">,</span> <span class="n">dst_ag_rowid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_annotgroup</span><span class="p">(</span><span class="n">annotgroup_uuid_list</span><span class="p">,</span>
                                                    <span class="n">annotgroup_text_list</span><span class="p">,</span>
                                                    <span class="n">annotgroup_note_list</span><span class="p">)</span>
    <span class="c"># Relate the annotations with the source group</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">add_gar</span><span class="p">([</span><span class="n">src_ag_rowid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="n">aid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">src_ag_rowid</span><span class="p">,</span> <span class="n">dst_ag_rowid</span>

</div>
<div class="viewcode-block" id="remove_rfdetect"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.remove_rfdetect">[docs]</a><span class="k">def</span> <span class="nf">remove_rfdetect</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">search_annot_notes</span><span class="p">(</span><span class="s">&#39;rfdetect&#39;</span><span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
    <span class="n">newnotes</span> <span class="o">=</span> <span class="p">[</span><span class="n">note</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;rfdetect&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">notes</span><span class="p">]</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_notes</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">newnotes</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="search_annot_notes"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.search_annot_notes">[docs]</a><span class="k">def</span> <span class="nf">search_annot_notes</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;PZ_Master0&#39;)</span>
<span class="sd">        &gt;&gt;&gt; pattern = [&#39;gash&#39;, &#39;injury&#39;, &#39;scar&#39;, &#39;wound&#39;]</span>
<span class="sd">        &gt;&gt;&gt; valid_aid_list = ibs.search_annot_notes(pattern)</span>
<span class="sd">        &gt;&gt;&gt; print(valid_aid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(ibs.get_annot_notes(valid_aid_list))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">notes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="c"># convert a list of patterns into an or statement</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="s">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">pat</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">])</span>
    <span class="n">valid_index_list</span><span class="p">,</span> <span class="n">valid_match_list</span> <span class="o">=</span> <span class="n">search_list</span><span class="p">(</span><span class="n">notes_list</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="c">#[match.group() for match in valid_match_list]</span>
    <span class="n">valid_aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">valid_index_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">valid_aid_list</span>

</div>
<div class="viewcode-block" id="search_list"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.search_list">[docs]</a><span class="k">def</span> <span class="nf">search_list</span><span class="p">(</span><span class="n">text_list</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-search_list</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; text_list = [&#39;ham&#39;, &#39;jam&#39;, &#39;eggs&#39;, &#39;spam&#39;]</span>
<span class="sd">        &gt;&gt;&gt; pattern = &#39;.am&#39;</span>
<span class="sd">        &gt;&gt;&gt; flags = 0</span>
<span class="sd">        &gt;&gt;&gt; (valid_index_list, valid_match_list) = search_list(text_list, pattern, flags)</span>
<span class="sd">        &gt;&gt;&gt; result = str(valid_index_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [0, 1, 3]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">match_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">text_list</span><span class="p">]</span>
    <span class="n">valid_index_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">match</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">match_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
    <span class="n">valid_match_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">match_list</span><span class="p">,</span> <span class="n">valid_index_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">valid_index_list</span><span class="p">,</span> <span class="n">valid_match_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_pair_timdelta"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_pair_timdelta">[docs]</a><span class="k">def</span> <span class="nf">get_annot_pair_timdelta</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list1</span><span class="p">,</span> <span class="n">aid_list2</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list1 (int):  list of annotation ids</span>
<span class="sd">        aid_list2 (int):  list of annotation ids</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: timedelta_list</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_annot_pair_timdelta</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; from six.moves import filter</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids(hasgt=True)</span>
<span class="sd">        &gt;&gt;&gt; unixtimes = ibs.get_annot_image_unixtimes(aid_list)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ut.list_compress(aid_list, np.array(unixtimes) != -1)</span>
<span class="sd">        &gt;&gt;&gt; gt_aids_list = ibs.get_annot_groundtruth(aid_list, daid_list=aid_list)</span>
<span class="sd">        &gt;&gt;&gt; aid_list1 = [aid for aid, gt_aids in zip(aid_list, gt_aids_list) if len(gt_aids) &gt; 0][0:5]</span>
<span class="sd">        &gt;&gt;&gt; aid_list2 = [gt_aids[0] for gt_aids in gt_aids_list if len(gt_aids) &gt; 0][0:5]</span>
<span class="sd">        &gt;&gt;&gt; timedelta_list = ibs.get_annot_pair_timdelta(aid_list1, aid_list2)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.numpy_str(timedelta_list, precision=2)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        np.array([  7.57e+07,   7.57e+07,   2.41e+06,   1.98e+08,   9.69e+07], dtype=np.float64)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unixtime_list1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes</span><span class="p">(</span><span class="n">aid_list1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">unixtime_list2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes</span><span class="p">(</span><span class="n">aid_list2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">unixtime_list1</span><span class="p">[</span><span class="n">unixtime_list1</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">unixtime_list2</span><span class="p">[</span><span class="n">unixtime_list2</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">timedelta_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">unixtime_list1</span> <span class="o">-</span> <span class="n">unixtime_list2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timedelta_list</span>

</div>
<div class="viewcode-block" id="filter_aids_without_timestamps"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_aids_without_timestamps">[docs]</a><span class="k">def</span> <span class="nf">filter_aids_without_timestamps</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    aid_list = ibs.get_valid_aids()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unixtime_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">flag_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">unixtime</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">unixtime</span> <span class="ow">in</span> <span class="n">unixtime_list</span><span class="p">]</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list_</span>

</div>
<div class="viewcode-block" id="partition_annots_into_singleton_multiton"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.partition_annots_into_singleton_multiton">[docs]</a><span class="k">def</span> <span class="nf">partition_annots_into_singleton_multiton</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    aid_list = aid_list_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">singletons</span> <span class="o">=</span> <span class="p">[</span><span class="n">aids</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">multitons</span> <span class="o">=</span> <span class="p">[</span><span class="n">aids</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">singletons</span><span class="p">,</span> <span class="n">multitons</span>

</div>
<div class="viewcode-block" id="make_temporally_distinct_blind_test"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.make_temporally_distinct_blind_test">[docs]</a><span class="k">def</span> <span class="nf">make_temporally_distinct_blind_test</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">challenge_num</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-make_temporally_distinct_blind_test --challenge-num=1</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-make_temporally_distinct_blind_test --challenge-num=2</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-make_temporally_distinct_blind_test --challenge-num=3</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-make_temporally_distinct_blind_test --challenge-num=4</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-make_temporally_distinct_blind_test --challenge-num=5</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-make_temporally_distinct_blind_test --challenge-num=6</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-make_temporally_distinct_blind_test --challenge-num=7</span>

<span class="sd">    Ignore:</span>
<span class="sd">        challenge_pdfs = ut.glob(&#39;.&#39;, &#39;pair_*_compressed.pdf&#39;, recursive=True)</span>
<span class="sd">        dname = &#39;localdata/all_challenges&#39;</span>
<span class="sd">        ut.ensuredir(dname)</span>
<span class="sd">        ut.copy(challenge_pdfs, dname)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;Elephants_drop1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = make_temporally_distinct_blind_test(ibs)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Parameters</span>
    <span class="k">if</span> <span class="n">challenge_num</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">challenge_num</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argval</span><span class="p">(</span><span class="s">&#39;--challenge-num&#39;</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">num_repeats</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">num_singles</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="c"># Filter out ones from previous challenges</span>
    <span class="n">all_aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_challenge_aids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">):</span>
        <span class="c"># Get annots with timestamps</span>
        <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">filter_aids_without_timestamps</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
        <span class="n">singletons</span><span class="p">,</span> <span class="n">multitons</span> <span class="o">=</span> <span class="n">partition_annots_into_singleton_multiton</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list_</span><span class="p">)</span>
        <span class="c"># process multitons</span>
        <span class="n">hourdists_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annots_hourdists_list</span><span class="p">(</span><span class="n">multitons</span><span class="p">)</span>
        <span class="n">best_pairx_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">vt</span><span class="o">.</span><span class="n">pdist_argsort</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hourdists_list</span><span class="p">]</span>
        <span class="n">best_multitons</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">multitons</span><span class="p">,</span> <span class="n">best_pairx_list</span><span class="p">)</span>
        <span class="n">best_hourdists_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annots_hourdists_list</span><span class="p">(</span><span class="n">best_multitons</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_hourdists_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_multitons</span><span class="p">)</span>
        <span class="n">best_multitons_sortx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">best_hourdists_list</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">best_pairs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">best_multitons</span><span class="p">,</span> <span class="n">best_multitons_sortx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num_repeats</span><span class="p">])</span>
        <span class="n">best_multis</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">best_pairs</span><span class="p">)</span>

        <span class="c"># process singletons</span>
        <span class="n">best_singles</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">singletons</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">random_indexes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">singletons</span><span class="p">),</span> <span class="n">num_singles</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">best_singles</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">best_singles</span><span class="p">)</span>

        <span class="n">chosen_aids_</span> <span class="o">=</span> <span class="n">best_multis</span> <span class="o">+</span> <span class="n">best_singles</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_multis</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_repeats</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;len(best_multis)=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">best_multis</span><span class="p">),)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_singles</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_singles</span><span class="p">,</span> <span class="s">&#39;len(best_singles)=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">best_singles</span><span class="p">),)</span>
        <span class="k">return</span> <span class="n">chosen_aids_</span>
        <span class="c">#return best_multis, best_singles</span>

    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">all_aid_list</span>
    <span class="c"># Define invalid aids recusrively, so challenges are dijsoint</span>
    <span class="n">invalid_aids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">challenge_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">prev_chosen_aids_</span> <span class="o">=</span> <span class="n">get_challenge_aids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
        <span class="n">invalid_aids</span> <span class="o">+=</span> <span class="n">prev_chosen_aids_</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff_ordered</span><span class="p">(</span><span class="n">all_aid_list</span><span class="p">,</span> <span class="n">invalid_aids</span><span class="p">)</span>

    <span class="n">chosen_aids_</span> <span class="o">=</span> <span class="n">get_challenge_aids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">chosen_nids_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">chosen_aids_</span><span class="p">)</span>

    <span class="c"># Randomize order of chosen aids and nids</span>
    <span class="n">shufflx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">random_indexes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chosen_aids_</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="mi">432</span><span class="p">)</span>
    <span class="n">chosen_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">chosen_aids_</span><span class="p">,</span> <span class="n">shufflx</span><span class="p">)</span>
    <span class="n">chosen_nids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">chosen_nids_</span><span class="p">,</span> <span class="n">shufflx</span><span class="p">)</span>
    <span class="n">choosex_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chosen_aids</span><span class="p">))</span>

    <span class="c"># ----------------------------------</span>
    <span class="c"># SAMPLE A SET OF PAIRS TO PRESNET</span>
    <span class="kn">import</span> <span class="nn">itertools</span>
    <span class="c">#nid_pair_list   = list(itertools.combinations(chosen_nids, 2))</span>

    <span class="k">def</span> <span class="nf">index2d_take</span><span class="p">(</span><span class="n">list_</span><span class="p">,</span> <span class="n">indexes_list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">list_</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span> <span class="k">for</span> <span class="n">xs</span> <span class="ow">in</span> <span class="n">indexes_list</span><span class="p">]</span>

    <span class="n">choosex_pair_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">choosex_list</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">nid_pair_list</span> <span class="o">=</span> <span class="n">index2d_take</span><span class="p">(</span><span class="n">chosen_nids</span><span class="p">,</span> <span class="n">choosex_pair_list</span><span class="p">)</span>
    <span class="c"># Do not choose any correct pairs</span>
    <span class="n">is_correct</span> <span class="o">=</span> <span class="p">[</span><span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span> <span class="k">for</span> <span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span> <span class="ow">in</span> <span class="n">nid_pair_list</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">is_correct</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">/=</span> <span class="n">p</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">random_pair_sample</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="c"># Randomly remove nonmatch pairs</span>
    <span class="n">pairx_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choosex_pair_list</span><span class="p">))</span>
    <span class="n">num_remove</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairx_list</span><span class="p">)</span> <span class="o">-</span> <span class="n">random_pair_sample</span>
    <span class="n">randstate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">remove_xs</span> <span class="o">=</span> <span class="n">randstate</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">pairx_list</span><span class="p">,</span> <span class="n">num_remove</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
    <span class="n">keep_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">index_to_boolmask</span><span class="p">(</span><span class="n">remove_xs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairx_list</span><span class="p">)))</span>
    <span class="n">sample_choosex_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">choosex_pair_list</span><span class="p">)[</span><span class="n">keep_mask</span><span class="p">]</span>

    <span class="c"># One last shuffle of pairs</span>
    <span class="c">#ut.random_indexes(len(chosen_aids), seed=10)</span>
    <span class="n">randstate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">randstate</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">sample_choosex_list</span><span class="p">)</span>

    <span class="c"># Print out info</span>
    <span class="n">avuuids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">(</span><span class="n">chosen_aids</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;avuuids_list=</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">avuuids_list</span><span class="p">))</span>
    <span class="n">chosen_avuuids_list</span> <span class="o">=</span> <span class="n">index2d_take</span><span class="p">(</span><span class="n">avuuids_list</span><span class="p">,</span> <span class="n">sample_choosex_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="n">avuuid1</span><span class="p">,</span> <span class="n">avuuid2</span><span class="p">)</span>  <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chosen_avuuids_list</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;pair </span><span class="si">%3d</span><span class="s">: </span><span class="si">%s</span><span class="s"> - vs - </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">avuuid1</span><span class="p">,</span> <span class="n">avuuid2</span><span class="p">))</span>
    <span class="c"># Print</span>
    <span class="n">best_times</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annots_hourdists_list</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">chosen_aids_</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;best_times = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">best_times</span><span class="p">,))</span>

    <span class="c"># -------------------------</span>
    <span class="c"># WRITE CHOSEN AIDS TO DISK</span>
    <span class="kn">import</span> <span class="nn">ibeis.viz</span>
    <span class="c">#fname = &#39;aidchallenge_&#39; + ibs.get_dbname() + &#39;_&#39; + str(challenge_num)</span>
    <span class="n">challengename</span> <span class="o">=</span> <span class="s">&#39;pair_challenge&#39;</span>  <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">challenge_num</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_dbname=&#39;</span> <span class="o">+</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span>
    <span class="n">output_dirname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;localdata&#39;</span><span class="p">,</span> <span class="n">challengename</span><span class="p">))</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">output_dirname</span><span class="p">)</span>
    <span class="c">#aid = chosen_aids[0]</span>
    <span class="c">#ibeis.viz.viz_chip.show_many_chips(ibs, chosen_aids)</span>

    <span class="k">def</span> <span class="nf">dump_challenge_fig</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">output_dirname</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">title_suffix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">(</span><span class="n">aid</span><span class="p">))</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">show_chip</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">annote</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_aidstr</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_name</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_num_gt</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">title_suffix</span><span class="o">=</span><span class="n">title_suffix</span><span class="p">)</span>
        <span class="c">#fig.show()</span>
        <span class="c">#pt.iup()</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">output_dirname</span><span class="p">,</span> <span class="s">&#39;avuuid</span><span class="si">%s</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title_suffix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),)))</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">save_figure</span><span class="p">(</span><span class="n">fpath_strict</span><span class="o">=</span><span class="n">fpath</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">clipwhite_ondisk</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">fpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fpath</span>

    <span class="n">orig_fpath_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">dump_challenge_fig</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">output_dirname</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">chosen_aids</span><span class="p">]</span>
    <span class="c">#fpath_pair_list = index2d_take(orig_fpath_list, choosex_pair_list)</span>
    <span class="c">#fpath_pair_list_ = ut.list_compress(fpath_pair_list, keep_mask)</span>
    <span class="n">fpath_pair_list_</span> <span class="o">=</span> <span class="n">index2d_take</span><span class="p">(</span><span class="n">orig_fpath_list</span><span class="p">,</span> <span class="n">sample_choosex_list</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">vd</span><span class="p">(</span><span class="n">output_dirname</span><span class="p">)</span>

    <span class="c"># ----- DUMP TO LATEX ---</span>

    <span class="c"># Randomize pair ordering</span>
    <span class="c">#randstate = np.random.RandomState(seed=10)</span>
    <span class="c">##ut.random_indexes(len(chosen_aids))</span>
    <span class="c">#randstate.shuffle(fpath_pair_list_)</span>

    <span class="c">#latex_blocks = [ut.get_latex_figure_str(fpath_pair, width_str=&#39;2.4in&#39;, nCols=2, dpath=output_dirname) for fpath_pair in fpath_pair_list_]</span>
    <span class="n">latex_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">get_latex_figure_str</span><span class="p">(</span><span class="n">fpath_pair</span><span class="p">,</span> <span class="n">width_str</span><span class="o">=</span><span class="s">&#39;.5</span><span class="se">\\</span><span class="s">textwidth&#39;</span><span class="p">,</span> <span class="n">nCols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="n">output_dirname</span><span class="p">,</span> <span class="n">caption_str</span><span class="o">=</span><span class="s">&#39;pair </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,))</span>
                    <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">fpath_pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fpath_pair_list_</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">latex_text</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">latex_blocks</span><span class="p">)</span>
    <span class="c">#print(latex_text)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">challengename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span>
    <span class="n">pdf_fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compile_latex_text</span><span class="p">(</span><span class="n">latex_text</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="n">output_dirname</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">challengename</span><span class="p">,</span> <span class="n">silence</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="n">output_pdf_fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress_pdf</span><span class="p">(</span><span class="n">pdf_fpath</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">output_pdf_fpath</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    import ibeis</span>
<span class="sd">    ibs = ibeis.opendb(&#39;Elephants_drop1&#39;)</span>

<span class="sd">    Guesses:</span>
<span class="sd">        def verify_guesses(partial_pairs):</span>
<span class="sd">            aids_lists = ibs.unflat_map(ibs.get_annot_rowids_from_partial_vuuids, partial_pairs)</span>
<span class="sd">            aid_pairs = list(map(ut.flatten, aids_lists))</span>
<span class="sd">            aids1 = ut.get_list_column(aid_pairs, 0)</span>
<span class="sd">            aids2 = ut.get_list_column(aid_pairs, 1)</span>
<span class="sd">            truth = ibs.get_aidpair_truths(aids1, aids2)</span>
<span class="sd">            return truth</span>

<span class="sd">        # Chuck: 2, 6   --</span>
<span class="sd">        partial_pairs = [(&#39;fc4fcc&#39;, &#39;47622&#39;), (&#39;981ef476&#39;, &#39;73721a95&#39;)]</span>
<span class="sd">        print(verify_guesses(partial_pairs))</span>
<span class="sd">        # Mine: 1, 14   --</span>
<span class="sd">        partial_pairs = [(&#39;fc4f&#39;, &#39;f0d32&#39;), (&#39;73721&#39;, &#39;47622&#39;)]</span>
<span class="sd">        print(verify_guesses(partial_pairs))</span>
<span class="sd">        # Hendrik: 3, X --</span>
<span class="sd">        partial_pairs = [(&#39;476225&#39;, &#39;4c383f&#39;), (&#39;48c1&#39;, &#39;981ef&#39;)]</span>
<span class="sd">        # Hendrik2: 3, 13 --</span>
<span class="sd">        partial_pairs = [(&#39;476225&#39;, &#39;4c383f&#39;), (&#39;fc4fcc&#39;, &#39;24a50bb&#39;)]</span>
<span class="sd">        print(verify_guesses(partial_pairs))</span>
<span class="sd">        # Tanya:</span>
<span class="sd">        partial_pairs = [(&#39;476225&#39;, &#39;fc4fcc48&#39;), (&#39;73721a&#39;, &#39;981ef476&#39;)]</span>

<span class="sd">        partial_vuuid_strs = ut.flatten(partial_pairs)</span>

<span class="sd">        get_annots_from_partial_vuuids</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#else:</span>
    <span class="c">#    def format_challenge_pairs():</span>
    <span class="c">#        # -------------------------</span>
    <span class="c">#        # EMBED INTO A PDF</span>
    <span class="c">#        #from utool.util_latex import *  # NOQA</span>
    <span class="c">#        import utool as ut</span>
    <span class="c">#        import vtool as vt</span>
    <span class="c">#        #verbose = True</span>
    <span class="c">#        dpath = &#39;/home/joncrall/code/ibeis/aidchallenge&#39;</span>
    <span class="c">#        # Read images</span>
    <span class="c">#        orig_fpath_list = ut.list_images(dpath, fullpath=True)</span>
    <span class="c">#        # Clip white out</span>
    <span class="c">#        clipped_fpath_list = [vt.clipwhite_ondisk(fpath) for fpath in orig_fpath_list]</span>
    <span class="c">#        # move into temporary figure dir with hashed names</span>
    <span class="c">#        fpath_list = []</span>
    <span class="c">#        figdpath = join(dpath, &#39;figures&#39;)</span>
    <span class="c">#        ut.ensuredir(figdpath)</span>
    <span class="c">#        from os.path import splitext, basename, dirname</span>
    <span class="c">#        for fpath in clipped_fpath_list:</span>
    <span class="c">#            fname, ext = splitext(basename(fpath))</span>
    <span class="c">#            fname_ = ut.hashstr(fname, alphabet=ut.ALPHABET_16) + ext</span>
    <span class="c">#            fpath_ = join(figdpath, fname_)</span>
    <span class="c">#            ut.move(fpath, fpath_)</span>
    <span class="c">#            fpath_list.append(fpath_)</span>

    <span class="c">#            figure_str = ut.get_latex_figure_str(fpath_list, width_str=&#39;2.4in&#39;, nCols=2, dpath=dirname(figdpath))</span>
    <span class="c">#            input_text = figure_str</span>
    <span class="c">#            pdf_fpath = ut.compile_latex_text(input_text, dpath=dpath, verbose=False, quiet=True)  # NOQA</span>

    <span class="c">#        #output_pdf_fpath = ut.compress_pdf(pdf_fpath)</span>

    <span class="c">#        #fpath_list</span>
    <span class="c">#        ## Weirdness</span>
    <span class="c">#        #new_rel_fpath_list = [ut.relpath_unix(fpath_, dpath) for fpath_ in new_fpath_list]</span>

    <span class="c">#    #for fpath_pair in fpath_pair_list:</span>
    <span class="c">#    #    print(fpath_pair)</span>

    <span class="c">#    # -------------------------</span>
    <span class="c">#    # EMBED INTO A PDF</span>
    <span class="c">#if False:</span>
    <span class="c">#    # TODO: quadratic programmming optimization</span>
    <span class="c">#    # Actually its a quadratically constrained quadratic integer program</span>
    <span class="c">#    def get_assignment_mat(ibs, aid_list):</span>
    <span class="c">#        #import scipy.spatial.distance as spdist</span>
    <span class="c">#        #nid_list = ibs.get_annot_nids(aid_list)</span>
    <span class="c">#        aid1_list, aid2_list = list(zip(*ut.iprod(aid_list, aid_list)))</span>
    <span class="c">#        truths = ibs.get_aidpair_truths(aid1_list, aid2_list)</span>
    <span class="c">#        assignment_mat = truths.reshape(len(aid_list), len(aid_list))</span>
    <span class="c">#        assignment_mat[np.diag_indices(assignment_mat.shape[0])] = 0</span>
    <span class="c">#        return assignment_mat</span>
    <span class="c">#    import scipy.spatial.distance as spdist</span>
    <span class="c">#    pairwise_times = ibs.get_unflat_annots_hourdists_list([aid_list])[0]</span>
    <span class="c">#    ptime_utri = np.triu(spdist.squareform(pairwise_times))  # NOQA</span>
    <span class="c">#    assignment_utri = np.triu(get_assignment_mat(ibs, aid_list))  # NOQA</span>
    <span class="c">#    nassign_utri = np.triu((1 - assignment_utri) - np.eye(len(assignment_utri)))  # NOQA</span>

    <span class="c">#    r&quot;&quot;&quot;</span>
    <span class="c">#    Let d be number of annots</span>
    <span class="c">#    Let x \in {0, 1}^d be an assignment vector</span>

    <span class="c">#    let l = num matching pairs = 2</span>
    <span class="c">#    let m = num nonmatching pairs = 2</span>

    <span class="c">#    # maximize total time delta</span>
    <span class="c">#    min 1/2 x^T (-ptime_utri) x</span>
    <span class="c">#    s.t.</span>
    <span class="c">#    # match constraint</span>
    <span class="c">#     .5 * x.T @ A @ x - l &lt;= 0</span>
    <span class="c">#    -.5 * x.T @ A @ x + l &lt;= 0</span>
    <span class="c">#    # nonmatch constraint</span>
    <span class="c">#     .5 * x.T @ \bar{A} @ x - l &lt;= 0</span>
    <span class="c">#    -.5 * x.T @ \bar{A} @ x + l &lt;= 0</span>
    <span class="c">#    &quot;&quot;&quot;</span>

    <span class="c">#maxhourdists = np.array(list(map(ut.safe_max, hourdists_list)))</span>
    <span class="c">#top_multi_indexes = maxhourdists.argsort()[::-1][:num_repeats]</span>
    <span class="c">#top_multitons = ut.list_take(multitons, top_multi_indexes)</span>

    <span class="c">#</span>
    <span class="c">#scipy.optimize.linprog</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="dans_lists"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.dans_lists">[docs]</a><span class="k">def</span> <span class="nf">dans_lists</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">positives</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">negatives</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">shuffle</span>

    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">yaw_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">qua_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">sex_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_sex_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">age_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_age_months_est</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>

    <span class="n">positive_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">aid</span>
        <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">yaw</span><span class="p">,</span> <span class="n">qua</span><span class="p">,</span> <span class="n">sex</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">yaw_list</span><span class="p">,</span> <span class="n">qua_list</span><span class="p">,</span> <span class="n">sex_list</span><span class="p">,</span> <span class="n">age_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yaw</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;LEFT&#39;</span> <span class="ow">and</span> <span class="n">qua</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;OK&#39;</span><span class="p">,</span> <span class="s">&#39;GOOD&#39;</span><span class="p">,</span> <span class="s">&#39;EXCELLENT&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sex</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;MALE&#39;</span><span class="p">,</span> <span class="s">&#39;FEMALE&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">]</span>

    <span class="n">negative_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">aid</span>
        <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">yaw</span><span class="p">,</span> <span class="n">qua</span><span class="p">,</span> <span class="n">sex</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">yaw_list</span><span class="p">,</span> <span class="n">qua_list</span><span class="p">,</span> <span class="n">sex_list</span><span class="p">,</span> <span class="n">age_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yaw</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;LEFT&#39;</span> <span class="ow">and</span> <span class="n">qua</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;OK&#39;</span><span class="p">,</span> <span class="s">&#39;GOOD&#39;</span><span class="p">,</span> <span class="s">&#39;EXCELLENT&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sex</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;UNKNOWN SEX&#39;</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">]</span>

    <span class="n">shuffle</span><span class="p">(</span><span class="n">positive_list</span><span class="p">)</span>
    <span class="n">shuffle</span><span class="p">(</span><span class="n">negative_list</span><span class="p">)</span>

    <span class="n">positive_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">positive_list</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">negative_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">negative_list</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">pos_yaw_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">positive_list</span><span class="p">)</span>
        <span class="n">pos_qua_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">positive_list</span><span class="p">)</span>
        <span class="n">pos_sex_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_sex_texts</span><span class="p">(</span><span class="n">positive_list</span><span class="p">)</span>
        <span class="n">pos_age_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_age_months_est</span><span class="p">(</span><span class="n">positive_list</span><span class="p">)</span>
        <span class="n">pos_chip_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chip_fpath</span><span class="p">(</span><span class="n">positive_list</span><span class="p">)</span>

        <span class="n">neg_yaw_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">negative_list</span><span class="p">)</span>
        <span class="n">neg_qua_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">negative_list</span><span class="p">)</span>
        <span class="n">neg_sex_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_sex_texts</span><span class="p">(</span><span class="n">negative_list</span><span class="p">)</span>
        <span class="n">neg_age_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_age_months_est</span><span class="p">(</span><span class="n">negative_list</span><span class="p">)</span>
        <span class="n">neg_chip_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chip_fpath</span><span class="p">(</span><span class="n">negative_list</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;positive_aid_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">positive_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;positive_yaw_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos_yaw_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;positive_qua_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos_qua_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;positive_sex_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos_sex_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;positive_age_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos_age_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;positive_chip_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos_chip_list</span><span class="p">,</span> <span class="p">))</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">90</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;negative_aid_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">negative_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;negative_yaw_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">neg_yaw_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;negative_qua_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">neg_qua_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;negative_sex_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">neg_sex_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;negative_age_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">neg_age_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;negative_chip_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">neg_chip_list</span><span class="p">,</span> <span class="p">))</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;mkdir ~/Desktop/chips&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pos_chip</span> <span class="ow">in</span> <span class="n">pos_chip_list</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;cp &quot;</span><span class="si">%s</span><span class="s">&quot; ~/Desktop/chips/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos_chip</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">for</span> <span class="n">neg_chip</span> <span class="ow">in</span> <span class="n">neg_chip_list</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;cp &quot;</span><span class="si">%s</span><span class="s">&quot; ~/Desktop/chips/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">neg_chip</span><span class="p">,</span> <span class="p">))</span>

    <span class="k">return</span> <span class="n">positive_list</span><span class="p">,</span> <span class="n">negative_list</span>

</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs</span>
<span class="sd">        python -m ibeis.ibsfuncs --allexamples</span>
<span class="sd">        python -m ibeis.ibsfuncs --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c"># for win32</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Jon Crall.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.4.4',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>