

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ibeis.ibsfuncs &mdash; ibeis 1.5.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ibeis 1.5.1 documentation" href="../../index.html"/>
        <link rel="up" title="ibeis" href="../ibeis.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> ibeis
          

          
          </a>

          
            
            
              <div class="version">
                1.5.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../ibeis.html">ibeis package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ibeis</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
          <li><a href="../ibeis.html">ibeis</a> &raquo;</li>
      
    <li>ibeis.ibsfuncs</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ibeis.ibsfuncs</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">developer convenience functions for ibs</span>

<span class="sd">TODO: need to split up into sub modules:</span>
<span class="sd">    consistency_checks</span>
<span class="sd">    feasibility_fixes</span>
<span class="sd">    move the export stuff to dbio</span>

<span class="sd">    then there are also convineience functions that need to be ordered at least</span>
<span class="sd">    within this file</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">zip</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">map</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">split</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">exists</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
<span class="kn">from</span> <span class="nn">utool._internal.meta_util_six</span> <span class="kn">import</span> <span class="n">get_funcname</span><span class="p">,</span> <span class="n">get_imfunc</span><span class="p">,</span> <span class="n">set_funcname</span>
<span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">detecttools.pypascalmarkup</span> <span class="kn">import</span> <span class="n">PascalVOC_Markup_Annotation</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="s">&#39;COMMIT TO DETECTTOOLS&#39;</span><span class="p">)</span>
    <span class="k">pass</span>
<span class="kn">from</span> <span class="nn">ibeis.control</span> <span class="kn">import</span> <span class="n">accessor_decors</span>
<span class="kn">from</span> <span class="nn">ibeis.control</span> <span class="kn">import</span> <span class="n">controller_inject</span>
<span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">annotmatch_funcs</span>  <span class="c"># NOQA</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="kn">as</span> <span class="nn">ET</span>

<span class="c"># Inject utool functions</span>
<span class="p">(</span><span class="k">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;[ibsfuncs]&#39;</span><span class="p">)</span>


<span class="c"># Must import class before injection</span>
<span class="n">CLASS_INJECT_KEY</span><span class="p">,</span> <span class="n">register_ibs_method</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">controller_inject</span><span class="o">.</span><span class="n">make_ibs_register_decorator</span><span class="p">(</span><span class="n">__name__</span><span class="p">))</span>


<span class="nd">@ut.make_class_postinject_decorator</span><span class="p">(</span><span class="n">CLASS_INJECT_KEY</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span>
<div class="viewcode-block" id="postinject_func"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.postinject_func">[docs]</a><span class="k">def</span> <span class="nf">postinject_func</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-postinject_func</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs.delete_empty_nids()  # a test run before this forgot to do this</span>
<span class="sd">        &gt;&gt;&gt; aids_list = ibs.get_name_aids(ibs.get_valid_nids())</span>
<span class="sd">        &gt;&gt;&gt; # indirectly test postinject_func</span>
<span class="sd">        &gt;&gt;&gt; thetas_list = ibs.get_unflat_annot_thetas(aids_list)</span>
<span class="sd">        &gt;&gt;&gt; result = str(thetas_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [[0.0, 0.0], [0.0, 0.0], [0.0], [0.0], [0.0], [0.0], [0.0]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># List of getters to ut.unflatten2</span>
    <span class="n">to_unflatten</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">flat_getter</span> <span class="ow">in</span> <span class="n">to_unflatten</span><span class="p">:</span>
        <span class="n">unflat_getter</span> <span class="o">=</span> <span class="n">_make_unflat_getter_func</span><span class="p">(</span><span class="n">flat_getter</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">inject_func_as_method</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">unflat_getter</span><span class="p">,</span>
                                 <span class="n">allow_override</span><span class="o">=</span><span class="n">ibs</span><span class="o">.</span><span class="n">allow_override</span><span class="p">)</span>
    <span class="c"># very hacky, but useful</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span> <span class="o">=</span> <span class="n">unflat_map</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="refresh"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.refresh">[docs]</a><span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DEPRICATE</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">ibsfuncs</span>
    <span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">all_imports</span>
    <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">rrr</span><span class="p">()</span>
    <span class="n">all_imports</span><span class="o">.</span><span class="n">reload_all</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">rrr</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="export_to_xml"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.export_to_xml">[docs]</a><span class="k">def</span> <span class="nf">export_to_xml</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span> <span class="n">enforce_yaw</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">target_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">purge</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
    <span class="n">current_year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
    <span class="c"># target_size = 900</span>
    <span class="n">information</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;database_name&#39;</span> <span class="p">:</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_ibsdb</span> <span class="o">+</span> <span class="s">&#39;/LearningData/&#39;</span>
    <span class="n">imagedir</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s">&#39;JPEGImages/&#39;</span>
    <span class="n">annotdir</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s">&#39;Annotations/&#39;</span>
    <span class="n">setsdir</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s">&#39;ImageSets/&#39;</span>
    <span class="n">mainsetsdir</span> <span class="o">=</span> <span class="n">setsdir</span> <span class="o">+</span> <span class="s">&#39;Main/&#39;</span>
    <span class="k">if</span> <span class="n">purge</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">datadir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">datadir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">imagedir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">annotdir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">setsdir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">mainsetsdir</span><span class="p">)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">sets_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;test&#39;</span>     <span class="p">:</span> <span class="p">[],</span>
        <span class="s">&#39;train&#39;</span>    <span class="p">:</span> <span class="p">[],</span>
        <span class="s">&#39;trainval&#39;</span> <span class="p">:</span> <span class="p">[],</span>
        <span class="s">&#39;val&#39;</span>      <span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">offset</span> <span class="o">==</span> <span class="s">&#39;auto&#39;</span> <span class="k">else</span> <span class="n">offset</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Exporting </span><span class="si">%d</span><span class="s"> images&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),))</span>
    <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">gid_list</span><span class="p">:</span>
        <span class="n">yawed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="n">image_uri</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uris</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fulldir</span> <span class="o">=</span> <span class="n">image_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">fulldir</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c"># NOQA</span>
            <span class="n">out_name</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">_</span><span class="si">%06d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_year</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">)</span>
            <span class="n">out_img</span> <span class="o">=</span> <span class="n">out_name</span> <span class="o">+</span> <span class="s">&quot;.jpg&quot;</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="s">&quot;IBEIS&quot;</span>

            <span class="n">_image</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">_image</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">height</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="n">width</span>
                <span class="n">decrease</span> <span class="o">=</span> <span class="n">target_size</span> <span class="o">/</span> <span class="n">width</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">target_size</span>
                <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_size</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">height</span>
                <span class="n">decrease</span> <span class="o">=</span> <span class="n">target_size</span> <span class="o">/</span> <span class="n">height</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">target_size</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_size</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>

            <span class="n">dst_img</span> <span class="o">=</span> <span class="n">imagedir</span> <span class="o">+</span> <span class="n">out_img</span>
            <span class="n">_image</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">_image</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">dst_img</span><span class="p">,</span> <span class="n">_image</span><span class="p">)</span>

            <span class="n">annotation</span> <span class="o">=</span> <span class="n">PascalVOC_Markup_Annotation</span><span class="p">(</span><span class="n">dst_img</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">out_img</span><span class="p">,</span>
                                                     <span class="n">source</span><span class="o">=</span><span class="n">image_uri</span><span class="p">,</span>
                                                     <span class="o">**</span><span class="n">information</span><span class="p">)</span>
            <span class="n">bbox_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="n">theta_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">theta</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">):</span>
                <span class="c"># Transformation matrix</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">rotation_around_bbox_mat3x3</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">bbox</span><span class="p">)</span>
                <span class="c"># Get verticies of the annotation polygon</span>
                <span class="n">verts</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">verts_from_bbox</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="c"># Rotate and transform vertices</span>
                <span class="n">xyz_pts</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">add_homogenous_coordinate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="n">trans_pts</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">remove_homogenous_coordinate</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xyz_pts</span><span class="p">))</span>
                <span class="n">new_verts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">trans_pts</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">x_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">new_verts</span><span class="p">]</span>
                <span class="n">y_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">new_verts</span><span class="p">]</span>
                <span class="n">xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">decrease</span><span class="p">)</span>
                <span class="n">xmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">decrease</span><span class="p">)</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">y_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">decrease</span><span class="p">)</span>
                <span class="n">ymax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">y_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">decrease</span><span class="p">)</span>
                <span class="c">#TODO: Change species_name to getter in IBEISControl once</span>
                <span class="c">#implemented</span>
                <span class="c">#species_name = &#39;grevys_zebra&#39;</span>
                <span class="n">species_name</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                <span class="n">yaw</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaws</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">yaw</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">yaw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">[</span><span class="s">&#39;pose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%0.6f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">yaw</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">yawed</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;UNVIEWPOINTED: </span><span class="si">%d</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">gid</span><span class="p">)</span>
                <span class="n">annotation</span><span class="o">.</span><span class="n">add_object</span><span class="p">(</span>
                    <span class="n">species_name</span><span class="p">,</span> <span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">),</span> <span class="o">**</span><span class="n">info</span><span class="p">)</span>
            <span class="n">dst_annot</span> <span class="o">=</span> <span class="n">annotdir</span> <span class="o">+</span> <span class="n">out_name</span>  <span class="o">+</span> <span class="s">&#39;.xml&#39;</span>

            <span class="c"># Update sets</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">state</span> <span class="o">&lt;=</span> <span class="mf">0.50</span><span class="p">:</span>
                <span class="n">sets_dict</span><span class="p">[</span><span class="s">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">state</span> <span class="o">&lt;=</span> <span class="mf">0.75</span><span class="p">:</span>
                <span class="n">sets_dict</span><span class="p">[</span><span class="s">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_name</span><span class="p">)</span>
                <span class="n">sets_dict</span><span class="p">[</span><span class="s">&#39;trainval&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sets_dict</span><span class="p">[</span><span class="s">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_name</span><span class="p">)</span>
                <span class="n">sets_dict</span><span class="p">[</span><span class="s">&#39;trainval&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_name</span><span class="p">)</span>

            <span class="c"># Write XML</span>
            <span class="k">if</span> <span class="bp">True</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">enforce_yaw</span> <span class="ow">or</span> <span class="n">yawed</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Copying:</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">image_path</span><span class="p">,</span> <span class="n">dst_img</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="p">))</span>
                <span class="n">xml_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dst_annot</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">xml_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">xml</span><span class="p">())</span>
                <span class="n">xml_data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">exists</span><span class="p">(</span><span class="n">dst_annot</span><span class="p">):</span>
                    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">offset</span> <span class="o">!=</span> <span class="s">&#39;auto&#39;</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">out_name</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">_</span><span class="si">%06d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_year</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="p">)</span>
                    <span class="n">dst_annot</span> <span class="o">=</span> <span class="n">annotdir</span> <span class="o">+</span> <span class="n">out_name</span>  <span class="o">+</span> <span class="s">&#39;.xml&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Skipping:</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="p">))</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sets_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mainsetsdir</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&#39;.txt&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_</span><span class="p">:</span>
            <span class="n">sets_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">sets_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">content</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;...completed&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">datadir</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="export_to_hotspotter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.export_to_hotspotter">[docs]</a><span class="k">def</span> <span class="nf">export_to_hotspotter</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.dbio</span> <span class="kn">import</span> <span class="n">export_hsdb</span>
    <span class="n">export_hsdb</span><span class="o">.</span><span class="n">export_ibeis_to_hotspotter</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>


<span class="c">#def export_image_subset(ibs, gid_list, dst_fpath=None):</span>
<span class="c">#    dst_fpath = ut.truepath(&#39;~&#39;)</span>
<span class="c">#    #gid_list = [692, 693, 680, 781, 751, 753, 754, 755, 756]</span>
<span class="c">#    gpath_list = ibs.get_image_paths(gid_list)</span>
<span class="c">#    gname_list = [join(dst_fpath, gname) for gname in</span>
<span class="c">#    ibs.get_image_gnames(gid_list)]</span>
<span class="c">#    ut.copy_files_to(gpath_list, dst_fpath_list=gname_list)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_image_time_statstr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_image_time_statstr">[docs]</a><span class="k">def</span> <span class="nf">get_image_time_statstr</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">unixtime_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">utvalid_list</span>   <span class="o">=</span> <span class="p">[</span><span class="n">time</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">unixtime_list_</span><span class="p">]</span>
    <span class="n">unixtime_list</span>  <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">unixtime_list_</span><span class="p">,</span> <span class="n">utvalid_list</span><span class="p">)</span>
    <span class="n">unixtime_statstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_timestats_str</span><span class="p">(</span><span class="n">unixtime_list</span><span class="p">,</span> <span class="n">newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unixtime_statstr</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_image_annotation_bboxes"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_image_annotation_bboxes">[docs]</a><span class="k">def</span> <span class="nf">get_image_annotation_bboxes</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">bboxes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annotation_bboxes</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bboxes_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_image_annotation_thetas"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_image_annotation_thetas">[docs]</a><span class="k">def</span> <span class="nf">get_image_annotation_thetas</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">thetas_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annotation_thetas</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thetas_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="filter_junk_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_junk_annotations">[docs]</a><span class="k">def</span> <span class="nf">filter_junk_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    remove junk annotations from a list</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: filtered_aid_list</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-filter_junk_annotations</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; filtered_aid_list = filter_junk_annotations(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = str(filtered_aid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">isjunk_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_isjunk</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">filtered_aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">isjunk_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered_aid_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="compute_all_chips"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_all_chips">[docs]</a><span class="k">def</span> <span class="nf">compute_all_chips</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes lazy evaluation of all chips</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] compute_all_chips&#39;</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_annot_chips</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cid_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="compute_all_features"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_all_features">[docs]</a><span class="k">def</span> <span class="nf">compute_all_features</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes lazy evaluation of all chips and features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">compute_all_chips</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] compute_all_features&#39;</span><span class="p">)</span>
    <span class="n">fid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_chip_feat</span><span class="p">(</span><span class="n">cid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fid_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="compute_all_featweights"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_all_featweights">[docs]</a><span class="k">def</span> <span class="nf">compute_all_featweights</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes lazy evaluation of all chips and features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">compute_all_features</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] compute_all_featweights&#39;</span><span class="p">)</span>
    <span class="n">featweight_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_feat_featweights</span><span class="p">(</span><span class="n">fid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">featweight_rowid_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="precompute_all_annot_dependants"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.precompute_all_annot_dependants">[docs]</a><span class="k">def</span> <span class="nf">precompute_all_annot_dependants</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">compute_all_featweights</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="recompute_fgweights"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.recompute_fgweights">[docs]</a><span class="k">def</span> <span class="nf">recompute_fgweights</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; delete all feature weights and then recompute them &quot;&quot;&quot;</span>
    <span class="c"># Delete all featureweights</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
        <span class="n">featweight_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_featweight_rowids</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">featweight_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_featweight_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_featweight</span><span class="p">(</span><span class="n">featweight_rowid_list</span><span class="p">)</span>
    <span class="c">#ibs.delete_annot_featweight(aid_list)</span>
    <span class="c"># Recompute current featureweights</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_fgweights</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="ensure_annotation_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.ensure_annotation_data">[docs]</a><span class="k">def</span> <span class="nf">ensure_annotation_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">chips</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">feats</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                           <span class="n">featweights</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">chips</span> <span class="ow">or</span> <span class="n">feats</span> <span class="ow">or</span> <span class="n">featweights</span><span class="p">:</span>
        <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_annot_chips</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">feats</span> <span class="ow">or</span> <span class="n">featweights</span><span class="p">:</span>
        <span class="n">fid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_chip_feat</span><span class="p">(</span><span class="n">cid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">featweights</span><span class="p">:</span>
        <span class="n">featweight_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_feat_featweights</span><span class="p">(</span><span class="n">fid_list</span><span class="p">)</span>  <span class="c"># NOQA</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="convert_empty_images_to_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.convert_empty_images_to_annotations">[docs]</a><span class="k">def</span> <span class="nf">convert_empty_images_to_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; images without chips are given an ANNOTATION over the entire image &quot;&quot;&quot;</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_empty_gids</span><span class="p">()</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">use_images_as_annotations</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="use_images_as_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.use_images_as_annotations">[docs]</a><span class="k">def</span> <span class="nf">use_images_as_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">name_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                              <span class="n">notes_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">adjust_percent</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adds an annotation the size of the entire image to each image.</span>
<span class="sd">    adjust_percent - shrinks the ANNOTATION by percentage on each side</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pct</span> <span class="o">=</span> <span class="n">adjust_percent</span>  <span class="c"># Alias</span>
    <span class="n">gsize_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_sizes</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="c"># Build bounding boxes as images size minus padding</span>
    <span class="n">bbox_list</span>  <span class="o">=</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span> <span class="mi">0</span> <span class="o">+</span> <span class="p">(</span><span class="n">gw</span> <span class="o">*</span> <span class="n">pct</span><span class="p">)),</span>
                   <span class="nb">int</span><span class="p">(</span> <span class="mi">0</span> <span class="o">+</span> <span class="p">(</span><span class="n">gh</span> <span class="o">*</span> <span class="n">pct</span><span class="p">)),</span>
                   <span class="nb">int</span><span class="p">(</span><span class="n">gw</span> <span class="o">-</span> <span class="p">(</span><span class="n">gw</span> <span class="o">*</span> <span class="n">pct</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span>
                   <span class="nb">int</span><span class="p">(</span><span class="n">gh</span> <span class="o">-</span> <span class="p">(</span><span class="n">gh</span> <span class="o">*</span> <span class="n">pct</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                  <span class="k">for</span> <span class="p">(</span><span class="n">gw</span><span class="p">,</span> <span class="n">gh</span><span class="p">)</span> <span class="ow">in</span> <span class="n">gsize_list</span><span class="p">]</span>
    <span class="n">theta_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gsize_list</span><span class="p">))]</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_annots</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">,</span>
                              <span class="n">name_list</span><span class="o">=</span><span class="n">name_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="o">=</span><span class="n">nid_list</span><span class="p">,</span>
                              <span class="n">notes_list</span><span class="o">=</span><span class="n">notes_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_been_adjusted"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_been_adjusted">[docs]</a><span class="k">def</span> <span class="nf">get_annot_been_adjusted</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns if a bounding box has been adjusted from defaults set in</span>
<span class="sd">    use_images_as_annotations Very hacky very heurstic.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bbox_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ori_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
    <span class="n">size_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_sizes</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>

    <span class="n">been_ori_adjusted</span> <span class="o">=</span> <span class="n">ori_list</span> <span class="o">!=</span> <span class="mi">0</span>

    <span class="n">adjusted_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">gw</span><span class="p">,</span>
         <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">gh</span><span class="p">,</span>
         <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">gw</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
         <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">gh</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,)</span>
        <span class="k">for</span> <span class="n">bbox</span><span class="p">,</span> <span class="p">(</span><span class="n">gw</span><span class="p">,</span> <span class="n">gh</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">,</span> <span class="n">size_list</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c"># Has the bounding box been moved past the default value?</span>
    <span class="n">been_bbox_adjusted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iprod</span><span class="p">(</span><span class="n">pcts</span><span class="p">,</span> <span class="n">pcts</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1e-2</span>
        <span class="k">for</span> <span class="n">pcts</span> <span class="ow">in</span> <span class="n">adjusted_list</span>
    <span class="p">])</span>

    <span class="n">been_adjusted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">been_ori_adjusted</span><span class="p">,</span> <span class="n">been_bbox_adjusted</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">been_adjusted</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="assert_valid_species_texts"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_valid_species_texts">[docs]</a><span class="k">def</span> <span class="nf">assert_valid_species_texts</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">species_list</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">valid_species</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_all_species_texts</span><span class="p">()</span>
        <span class="n">isvalid_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">species</span> <span class="ow">in</span> <span class="n">valid_species</span>  <span class="c"># or species == const.UNKNOWN</span>
            <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_list</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">isvalid_list</span><span class="p">),</span> <span class="s">&#39;invalid species found in </span><span class="si">%r</span><span class="s">: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">get_caller_name</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span>
                <span class="n">species_list</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">),)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="n">iswarning</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iswarning</span><span class="p">:</span>
            <span class="k">raise</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="assert_singleton_relationship"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_singleton_relationship">[docs]</a><span class="k">def</span> <span class="nf">assert_singleton_relationship</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">alrids_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">alrids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">alrids</span> <span class="ow">in</span> <span class="n">alrids_list</span><span class="p">]),</span> <span class="p">(</span>
            <span class="s">&#39;must only have one relationship of a type&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">parent_locals</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_parent_locals</span><span class="p">()</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;parent_locals=&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">parent_locals</span><span class="p">),</span>
                   <span class="n">key_list</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;alrids_list&#39;</span><span class="p">,</span> <span class="p">])</span>
        <span class="k">raise</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="assert_valid_gids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_valid_gids">[docs]</a><span class="k">def</span> <span class="nf">assert_valid_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">veryverbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">isinvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gid</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_gid</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">isinvalid_list</span><span class="p">),</span> <span class="s">&#39;invalid gids: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">isinvalid_list</span><span class="p">),)</span>
        <span class="n">isinvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">VALID_INT_TYPES</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">gid_list</span><span class="p">]</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">isinvalid_list</span><span class="p">),</span> <span class="s">&#39;invalidly typed gids: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">isinvalid_list</span><span class="p">),)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;dbname = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()))</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;passed assert_valid_gids&#39;</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="assert_valid_aids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_valid_aids">[docs]</a><span class="k">def</span> <span class="nf">assert_valid_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">veryverbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">auuid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>
<span class="sd">        verbose (bool):  verbosity flag(default = False)</span>
<span class="sd">        veryverbose (bool): (default = False)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-assert_valid_aids</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; verbose = False</span>
<span class="sd">        &gt;&gt;&gt; veryverbose = False</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;Asserting multiple&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = assert_valid_aids(ibs, aid_list, verbose, veryverbose)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;Asserting single&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = assert_valid_aids(ibs, aid_list[0:1], verbose, veryverbose)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;Asserting multiple incorrect&#39;)</span>
<span class="sd">        &gt;&gt;&gt; auuid_list = ibs.get_annot_uuids(aid_list) + [None]</span>
<span class="sd">        &gt;&gt;&gt; try:</span>
<span class="sd">        &gt;&gt;&gt;    result = assert_valid_aids(ibs, aid_list + [0], verbose, veryverbose, auuid_list=auuid_list)</span>
<span class="sd">        &gt;&gt;&gt; except AssertionError:</span>
<span class="sd">        &gt;&gt;&gt;    print(&#39;Correctly got assertion&#39;)</span>
<span class="sd">        &gt;&gt;&gt; else:</span>
<span class="sd">        &gt;&gt;&gt;    assert False, &#39;should have failed&#39;</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;Asserting single incorrect&#39;)</span>
<span class="sd">        &gt;&gt;&gt; try:</span>
<span class="sd">        &gt;&gt;&gt;    result = assert_valid_aids(ibs, [0], verbose, veryverbose)</span>
<span class="sd">        &gt;&gt;&gt; except AssertionError:</span>
<span class="sd">        &gt;&gt;&gt;    print(&#39;Correctly got assertion&#39;)</span>
<span class="sd">        &gt;&gt;&gt; else:</span>
<span class="sd">        &gt;&gt;&gt;    assert False, &#39;should have failed&#39;</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#if ut.NO_ASSERTS and not force:</span>
    <span class="c">#    return</span>
    <span class="c">#valid_aids = set(ibs.get_valid_aids())</span>
    <span class="c">#invalid_aids = [aid for aid in aid_list if aid not in valid_aids]</span>
    <span class="c">#isinvalid_list = [aid not in valid_aids for aid in aid_list]</span>
    <span class="n">isinvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">aid</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_aid</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)]</span>
    <span class="c">#isinvalid_list = [aid not in valid_aids for aid in aid_list]</span>
    <span class="n">invalid_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">isinvalid_list</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">isinvalid_list</span><span class="p">),</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s"> invalid aids: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">isinvalid_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="n">invalid_aids</span><span class="p">,)</span>
        <span class="n">isinvalid_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_int</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">aid_list</span><span class="p">]</span>
        <span class="n">invalid_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">isinvalid_list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">isinvalid_list</span><span class="p">),</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s"> invalidly typed aids: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">isinvalid_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="n">invalid_aids</span><span class="p">,)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">auuid_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">auuid_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">):</span>
            <span class="n">invalid_auuids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">auuid_list</span><span class="p">,</span> <span class="n">isinvalid_list</span><span class="p">)</span>  <span class="c"># NOQA</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">invalid_auuids</span> <span class="o">=</span> <span class="s">&#39;not-available&#39;</span>
        <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span>  <span class="c"># NOQA</span>
        <span class="n">locals_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dbname</span><span class="o">=</span><span class="n">dbname</span><span class="p">,</span> <span class="n">invalid_auuids</span><span class="o">=</span><span class="n">invalid_auuids</span><span class="p">,</span> <span class="n">invalid_aids</span><span class="o">=</span><span class="n">invalid_aids</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span>
            <span class="n">ex</span><span class="p">,</span> <span class="s">&#39;assert_valid_aids: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">,</span>
            <span class="n">locals_</span><span class="o">=</span><span class="n">locals_</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;invalid_aids&#39;</span><span class="p">,</span> <span class="s">&#39;invalid_auuids&#39;</span><span class="p">,</span> <span class="s">&#39;dbname&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;passed assert_valid_aids&#39;</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_missing_gids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_missing_gids">[docs]</a><span class="k">def</span> <span class="nf">get_missing_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Finds gids with broken links to the original data.</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        gid_list (list): (default = None)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_missing_gids --db GZ_Master1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #ibs = ibeis.opendb(&#39;GZ_Master1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; gid_list = ibs.get_valid_gids()</span>
<span class="sd">        &gt;&gt;&gt; bad_gids = ibs.get_missing_gids(gid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;#bad_gids = %r / %r&#39; % (len(bad_gids), len(gid_list)))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">exists_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">exists</span><span class="p">,</span> <span class="n">gpath_list</span><span class="p">))</span>
    <span class="n">bad_gids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">exists_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bad_gids</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="assert_images_exist"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_images_exist">[docs]</a><span class="k">def</span> <span class="nf">assert_images_exist</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;checking images exist&#39;</span><span class="p">)</span>
    <span class="n">bad_gids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_missing_gids</span><span class="p">()</span>
    <span class="n">num_bad_gids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_gids</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">bad_gpaths</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">bad_gids</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Bad Gpaths:&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">truncate_str</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">bad_gpaths</span><span class="p">),</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">500</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">num_bad_gids</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s"> images dont exist&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_bad_gids</span><span class="p">,)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[check] checked </span><span class="si">%d</span><span class="s"> images exist&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="assert_valid_names"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_valid_names">[docs]</a><span class="k">def</span> <span class="nf">assert_valid_names</span><span class="p">(</span><span class="n">name_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Asserts that user specified names do not conflict with</span>
<span class="sd">    the standard unknown name &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">def</span> <span class="nf">isconflict</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="n">valid_namecheck</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="n">isconflict</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">valid_namecheck</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;A name conflicts with UKNONWN Name. -- &#39;</span>
                                  <span class="s">&#39;cannot start a name with four underscores&#39;</span><span class="p">)</span>

</div>
<span class="nd">@ut.on_exception_report_input</span>
<div class="viewcode-block" id="assert_lblannot_rowids_are_type"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_lblannot_rowids_are_type">[docs]</a><span class="k">def</span> <span class="nf">assert_lblannot_rowids_are_type</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">lblannot_rowid_list</span><span class="p">,</span>
                                    <span class="n">valid_lbltype_rowid</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">lbltype_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_lblannot_lbltypes_rowids</span><span class="p">(</span><span class="n">lblannot_rowid_list</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># HACK: the unknown_lblannot_rowid will have a None type</span>
        <span class="c"># the unknown lblannot_rowid should be handled more gracefully</span>
        <span class="c"># this should just check the first condition (get rid of the or)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">assert_same_len</span><span class="p">(</span><span class="n">lbltype_rowid_list</span><span class="p">,</span> <span class="n">lbltype_rowid_list</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">assert_scalar_list</span><span class="p">(</span><span class="n">lblannot_rowid_list</span><span class="p">)</span>
        <span class="n">validtype_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">lbltype_rowid</span> <span class="o">==</span> <span class="n">valid_lbltype_rowid</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">lbltype_rowid</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
             <span class="n">lblannot_rowid</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN_LBLANNOT_ROWID</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">lbltype_rowid</span><span class="p">,</span> <span class="n">lblannot_rowid</span> <span class="ow">in</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">lbltype_rowid_list</span><span class="p">,</span> <span class="n">lblannot_rowid_list</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">validtype_list</span><span class="p">),</span> <span class="s">&#39;not all types match valid type&#39;</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">tup_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">lbltype_rowid_list</span><span class="p">,</span> <span class="n">lblannot_rowid_list</span><span class="p">))))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[!!!] (lbltype_rowid, lblannot_rowid) = : &#39;</span> <span class="o">+</span>
              <span class="n">ut</span><span class="o">.</span><span class="n">indentjoin</span><span class="p">(</span><span class="n">tup_list</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[!!!] valid_lbltype_rowid: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">valid_lbltype_rowid</span><span class="p">,))</span>

        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;not all types match valid type&#39;</span><span class="p">,</span>
                      <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;valid_lbltype_rowid&#39;</span><span class="p">,</span> <span class="s">&#39;lblannot_rowid_list&#39;</span><span class="p">])</span>
        <span class="k">raise</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="check_image_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_image_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_image_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        gid_list (list): (default = None)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-check_image_consistency  --db=GZ_Master1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; gid_list = None</span>
<span class="sd">        &gt;&gt;&gt; result = check_image_consistency(ibs, gid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># TODO: more consistency checks</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;check image consistency. len(gid_list)=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">assert_images_exist</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)</span>
    <span class="n">image_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">image_uuid_list</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="c">#check_image_uuid_consistency(ibs, gid_list)</span>

</div>
<div class="viewcode-block" id="check_image_uuid_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_image_uuid_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_image_uuid_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks to make sure image uuids are computed detemenistically</span>
<span class="sd">    by recomputing all guuids and checking that they are equal to</span>
<span class="sd">    what is already there.</span>

<span class="sd">    VERY SLOW</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-check_image_uuid_consistency --db=PZ_Master0</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-check_image_uuid_consistency --db=GZ_Master1</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-check_image_uuid_consistency</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-check_image_uuid_consistency --db lynx</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; # Check for very large files</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; gid_list_ = ibs.get_valid_gids()</span>
<span class="sd">        &gt;&gt;&gt; gpath_list_ = ibs.get_image_paths(gid_list_)</span>
<span class="sd">        &gt;&gt;&gt; bytes_list_ = [ut.get_file_nBytes(path) for path in gpath_list_]</span>
<span class="sd">        &gt;&gt;&gt; sortx = ut.list_argsort(bytes_list_, reverse=True)[0:10]</span>
<span class="sd">        &gt;&gt;&gt; gpath_list = ut.take(gpath_list_, sortx)</span>
<span class="sd">        &gt;&gt;&gt; bytes_list = ut.take(bytes_list_, sortx)</span>
<span class="sd">        &gt;&gt;&gt; gid_list   = ut.take(gid_list_, sortx)</span>
<span class="sd">        &gt;&gt;&gt; ibeis.ibsfuncs.check_image_uuid_consistency(ibs, gid_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;checking image uuid consistency&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">ibeis.algo.preproc.preproc_image</span> <span class="kn">as</span> <span class="nn">preproc_image</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">guuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgressIter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">))):</span>
        <span class="n">gpath</span> <span class="o">=</span> <span class="n">gpath_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">guuid_stored</span> <span class="o">=</span> <span class="n">guuid_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">param_tup</span> <span class="o">=</span> <span class="n">preproc_image</span><span class="o">.</span><span class="n">parse_imageinfo</span><span class="p">(</span><span class="n">gpath</span><span class="p">)</span>
        <span class="n">guuid_computed</span> <span class="o">=</span> <span class="n">param_tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">guuid_stored</span> <span class="o">==</span> <span class="n">guuid_computed</span><span class="p">,</span> <span class="s">&#39;image ix=</span><span class="si">%d</span><span class="s"> had a bad uuid&#39;</span> <span class="o">%</span> <span class="n">ix</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="check_annot_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_annot_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_annot_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs      (IBEISController):</span>
<span class="sd">        aid_list (list):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-check_annot_consistency</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; result = check_annot_consistency(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># TODO: more consistency checks</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;check annot consistency. len(aid_list)=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
    <span class="n">annot_gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">num_None_annot_gids</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flag_None_items</span><span class="p">(</span><span class="n">annot_gid_list</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;num_None_annot_gids = </span><span class="si">%r</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_None_annot_gids</span><span class="p">,))</span>
    <span class="k">assert</span> <span class="n">num_None_annot_gids</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="c">#print(ut.dict_str(dict(ut.debug_duplicate_items(annot_gid_list))))</span>
    <span class="n">assert_images_exist</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">annot_gid_list</span><span class="p">)</span>
    <span class="n">unique_gids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">annot_gid_list</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;num_unique_images=</span><span class="si">%r</span><span class="s"> / </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_gids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">annot_gid_list</span><span class="p">)))</span>
    <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chip_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">cfpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_chip_fpath</span><span class="p">(</span><span class="n">cid_list</span><span class="p">)</span>
    <span class="n">valid_chip_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">cfpath</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">exists</span><span class="p">(</span><span class="n">cfpath</span><span class="p">)</span> <span class="k">for</span> <span class="n">cfpath</span> <span class="ow">in</span> <span class="n">cfpath_list</span><span class="p">]</span>
    <span class="n">invalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag</span> <span class="ow">is</span> <span class="bp">False</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">valid_chip_list</span><span class="p">]</span>
    <span class="n">invalid_cids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">cid_list</span><span class="p">,</span> <span class="n">invalid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_cids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;found </span><span class="si">%d</span><span class="s"> inconsistent chips attempting to fix&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_cids</span><span class="p">))</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_chips</span><span class="p">(</span><span class="n">invalid_cids</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">check_chip_existence</span><span class="p">(</span><span class="n">aid_list</span><span class="o">=</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">visual_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">exemplar_flag</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_exemplar_flags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">is_unknown</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_aid_unknown</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="c"># Exemplars should all be known</span>
    <span class="n">unknown_exemplar_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">exemplar_flag</span><span class="p">,</span> <span class="n">is_unknown</span><span class="p">)</span>
    <span class="n">is_error</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="n">flag</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">unknown_exemplar_flags</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">is_error</span><span class="p">),</span> <span class="s">&#39;Unknown annotations are set as exemplars&#39;</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">visual_uuid_list</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="check_annot_corrupt_uuids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_annot_corrupt_uuids">[docs]</a><span class="k">def</span> <span class="nf">check_annot_corrupt_uuids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    # del dtool.__SQLITE__.converters[&#39;UUID&#39;]</span>
<span class="sd">    # import uuid</span>
<span class="sd">    # del dtool.__SQLITE__.adapters[(uuid.UUID, dtool.__SQLITE__.PrepareProtocol)]</span>

<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; check_annot_corrupt_uuids(ibs, aid_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">failed_aids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">aid_list</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">failed_aids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;failed_aids = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">failed_aids</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">failed_aids</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;uuids do not seem to be corrupt&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="check_name_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_name_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_name_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        nid_list (list):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-check_name_consistency</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nid_list = ibs._get_all_known_nids()</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = check_name_consistency(ibs, nid_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#aids_list = ibs.get_name_aids(nid_list)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;check name consistency. len(nid_list)=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">))</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Checking that all annotations of a name have the same species&#39;</span><span class="p">)</span>
    <span class="n">species_rowids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_rowids</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="n">error_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">aids</span><span class="p">,</span> <span class="n">sids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aids_list</span><span class="p">,</span> <span class="n">species_rowids_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">sids</span><span class="p">):</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s">&#39;aids=</span><span class="si">%r</span><span class="s"> have the same name, but belong to multiple species=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">aids</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_texts</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unique_ordered</span><span class="p">(</span><span class="n">sids</span><span class="p">)))</span>
            <span class="k">print</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="n">error_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;A total of </span><span class="si">%d</span><span class="s"> names failed check_name_consistency&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">error_list</span><span class="p">)))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="check_name_mapping_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_name_mapping_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_name_mapping_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nx2_aids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    checks that all the aids grouped in a name ahave the same name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># DEBUGGING CODE</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">ibsfuncs</span>
        <span class="n">_nids_list</span> <span class="o">=</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">,</span> <span class="n">nx2_aids</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">,</span> <span class="n">_nids_list</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="c"># THESE SHOULD BE CONSISTENT BUT THEY ARE NOT!!?</span>
        <span class="c">#name_annots = [ibs.get_annot_name_rowids(aids) for aids in nx2_aids]</span>
        <span class="n">bad</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">good</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">huh</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">nx</span><span class="p">,</span> <span class="n">aids</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nx2_aids</span><span class="p">):</span>
            <span class="n">nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="n">nids</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">nids</span><span class="p">):</span>
                    <span class="n">good</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">huh</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bad</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;good&#39;</span><span class="p">,</span> <span class="s">&#39;bad&#39;</span><span class="p">,</span> <span class="s">&#39;huh&#39;</span><span class="p">])</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="check_annot_size"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_annot_size">[docs]</a><span class="k">def</span> <span class="nf">check_annot_size</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Checking annot sizes&#39;</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">desc_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">kpts_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_kpts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">vert_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_verts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(aid_list) = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(vert_list) = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">vert_list</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(uuid_list) = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">uuid_list</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(desc_list) = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">desc_list</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(kpts_list) = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">kpts_list</span><span class="p">)))</span>

</div>
<div class="viewcode-block" id="check_exif_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_exif_data">[docs]</a><span class="k">def</span> <span class="nf">check_exif_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; TODO CALL SCRIPT &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool.exif</span> <span class="kn">as</span> <span class="nn">exif</span>
    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">exif_dict_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgressIter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">)),</span> <span class="n">lbl</span><span class="o">=</span><span class="s">&#39;checking exif: &#39;</span><span class="p">):</span>
        <span class="n">gpath</span> <span class="o">=</span> <span class="n">gpath_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">pil_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gpath</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">exif_dict</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">get_exif_dict</span><span class="p">(</span><span class="n">pil_img</span><span class="p">)</span>
        <span class="n">exif_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">)</span>
        <span class="c">#if len(exif_dict) &gt; 0:</span>
        <span class="c">#    break</span>

    <span class="n">has_latlon</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">exif_dict</span> <span class="ow">in</span> <span class="n">exif_dict_list</span><span class="p">:</span>
        <span class="n">latlon</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">get_lat_lon</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">latlon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">has_latlon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_latlon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s"> / </span><span class="si">%d</span><span class="s"> have gps info&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">has_latlon</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">has_latlon</span><span class="p">),))</span>

    <span class="n">key2_freq</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">num_tags_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">exif_dict</span> <span class="ow">in</span> <span class="n">exif_dict_list</span><span class="p">:</span>
        <span class="n">exif_dict2</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">make_exif_dict_human_readable</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">)</span>
        <span class="n">num_tags_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">exif_dict2</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">key2_freq</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">print_stats</span><span class="p">(</span><span class="n">num_tags_list</span><span class="p">,</span> <span class="s">&#39;num tags per image&#39;</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;tag frequency&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">key2_freq</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="run_integrity_checks"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.run_integrity_checks">[docs]</a><span class="k">def</span> <span class="nf">run_integrity_checks</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">embed</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function to run all database consistency checks &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] Checking consistency&#39;</span><span class="p">)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">()</span>
    <span class="n">check_annot_size</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>
    <span class="n">check_image_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)</span>
    <span class="n">check_annot_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
    <span class="n">check_name_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>
    <span class="n">check_annotmatch_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>
    <span class="c"># Very slow check</span>
    <span class="n">check_image_uuid_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">embed</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">embed</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] Finshed consistency check&#39;</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="check_annotmatch_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_annotmatch_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_annotmatch_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">annomatch_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_annotmatch_rowids</span><span class="p">()</span>
    <span class="n">aid1_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_aid1</span><span class="p">(</span><span class="n">annomatch_rowids</span><span class="p">)</span>
    <span class="n">aid2_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_aid2</span><span class="p">(</span><span class="n">annomatch_rowids</span><span class="p">)</span>
    <span class="n">exists1_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">check_rowid_exists</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="n">aid1_list</span><span class="p">)</span>
    <span class="n">exists2_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">check_rowid_exists</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">)</span>
    <span class="n">invalid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">and_lists</span><span class="p">(</span><span class="n">exists1_list</span><span class="p">,</span> <span class="n">exists2_list</span><span class="p">))</span>
    <span class="n">invalid_annotmatch_rowids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">annomatch_rowids</span><span class="p">,</span> <span class="n">invalid_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;There are </span><span class="si">%d</span><span class="s"> invalid annotmatch rowids&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_annotmatch_rowids</span><span class="p">),))</span>
    <span class="k">return</span> <span class="n">invalid_annotmatch_rowids</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="fix_invalid_annotmatches"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_invalid_annotmatches">[docs]</a><span class="k">def</span> <span class="nf">fix_invalid_annotmatches</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Fixing invalid annotmatches&#39;</span><span class="p">)</span>
    <span class="n">invalid_annotmatch_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">check_annotmatch_consistency</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_annotmatch</span><span class="p">(</span><span class="n">invalid_annotmatch_rowids</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="fix_remove_visual_dupliate_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_remove_visual_dupliate_annotations">[docs]</a><span class="k">def</span> <span class="nf">fix_remove_visual_dupliate_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    depricate because duplicate visual_uuids</span>
<span class="sd">    are no longer allowed to be duplicates</span>

<span class="sd">    Add to clean database?</span>

<span class="sd">    removes visually duplicate annotations</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;GZ_ALL&#39;)</span>
<span class="sd">        &gt;&gt;&gt; fix_remove_visual_dupliate_annotations(ibs)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">visual_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs_dup_annots</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">visual_uuid_list</span><span class="p">)</span>
    <span class="n">dupaids_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibs_dup_annots</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">dupxs</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">ibs_dup_annots</span><span class="p">):</span>
            <span class="n">aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">dupxs</span><span class="p">)</span>
            <span class="n">dupaids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aids</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="n">toremove_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">dupaids_list</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;About to delete toremove_aids=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">toremove_aids</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">are_you_sure</span><span class="p">():</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">delete_annots</span><span class="p">(</span><span class="n">toremove_aids</span><span class="p">)</span>

            <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
            <span class="n">visual_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="n">ibs_dup_annots</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">visual_uuid_list</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibs_dup_annots</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

</div>
<div class="viewcode-block" id="fix_zero_features"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_zero_features">[docs]</a><span class="k">def</span> <span class="nf">fix_zero_features</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">nfeat_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_num_feats</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">haszero_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">nfeat</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">nfeat</span> <span class="ow">in</span> <span class="n">nfeat_list</span><span class="p">]</span>
    <span class="n">haszero_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">haszero_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_annot_chips</span><span class="p">(</span><span class="n">haszero_aids</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="fix_and_clean_database"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_and_clean_database">[docs]</a><span class="k">def</span> <span class="nf">fix_and_clean_database</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function to run all database cleanup scripts</span>

<span class="sd">    Rename to run_cleanup_scripts</span>

<span class="sd">    Break into two funcs:</span>
<span class="sd">        run_cleanup_scripts</span>
<span class="sd">        run_fixit_scripts</span>

<span class="sd">    CONSITENCY CHECKS TODO:</span>
<span class="sd">        * check that annotmatches marked as False do not have the</span>
<span class="sd">          same name for similar viewpoints.</span>
<span class="sd">        * check that photobombs are have different names</span>
<span class="sd">        * warn if scenery matches have the same name</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#TODO: Call more stuff, maybe rename to &#39;apply duct tape&#39;</span>
    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s">&#39;[FIX_AND_CLEAN]&#39;</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;starting fixes and consistency checks&#39;</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">fix_unknown_exemplars</span><span class="p">()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">fix_invalid_name_texts</span><span class="p">()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">fix_invalid_nids</span><span class="p">()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">fix_invalid_annotmatches</span><span class="p">()</span>
        <span class="n">fix_zero_features</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">update_annot_visual_uuids</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">())</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_empty_nids</span><span class="p">()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_empty_imgsetids</span><span class="p">()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">vacuum</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;finished fixes and consistency checks</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="fix_exif_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_exif_data">[docs]</a><span class="k">def</span> <span class="nf">fix_exif_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; TODO CALL SCRIPT</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        gid_list (list): list of image ids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-fix_exif_data</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;lynx&#39;)</span>
<span class="sd">        &gt;&gt;&gt; gid_list = ibs.get_valid_gids()</span>
<span class="sd">        &gt;&gt;&gt; result = fix_exif_data(ibs, gid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>

    <span class="n">pil_img_gen</span> <span class="o">=</span> <span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gpath</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">gpath</span> <span class="ow">in</span> <span class="n">gpath_list</span><span class="p">)</span>

    <span class="n">exif_dict_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">get_exif_dict</span><span class="p">(</span><span class="n">pil_img</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pil_img</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgressIter</span><span class="p">(</span>
            <span class="n">pil_img_gen</span><span class="p">,</span> <span class="n">nTotal</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">),</span> <span class="n">lbl</span><span class="o">=</span><span class="s">&#39;reading exif: &#39;</span><span class="p">,</span>
            <span class="n">adjust</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">fix_property</span><span class="p">(</span><span class="n">exif_getter</span><span class="p">,</span> <span class="n">ibs_getter</span><span class="p">,</span> <span class="n">ibs_setter</span><span class="p">,</span> <span class="n">dirty_ibs_val</span><span class="p">,</span> <span class="n">propname</span><span class="o">=</span><span class="s">&#39;property&#39;</span><span class="p">):</span>
        <span class="n">exif_prop_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">exif_getter</span><span class="p">(</span><span class="n">_dict</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">_dict</span> <span class="ow">in</span> <span class="n">exif_dict_list</span><span class="p">]</span>
        <span class="n">hasprop_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">prop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">exif_prop_list</span><span class="p">]</span>

        <span class="n">exif_prop_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">exif_prop_list</span><span class="p">,</span> <span class="n">hasprop_list</span><span class="p">)</span>
        <span class="n">gid_list_</span>       <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">hasprop_list</span><span class="p">)</span>
        <span class="n">ibs_prop_list</span>   <span class="o">=</span> <span class="n">ibs_getter</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span>
        <span class="n">isdirty_list</span>    <span class="o">=</span> <span class="p">[</span><span class="n">prop</span> <span class="o">==</span> <span class="n">dirty_ibs_val</span> <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">ibs_prop_list</span><span class="p">]</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s"> / </span><span class="si">%d</span><span class="s"> need </span><span class="si">%s</span><span class="s"> update&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">isdirty_list</span><span class="p">),</span>
                                          <span class="nb">len</span><span class="p">(</span><span class="n">isdirty_list</span><span class="p">),</span> <span class="n">propname</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">False</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="n">isdirty_list</span><span class="p">)</span>  <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">sum</span><span class="p">(</span><span class="n">isdirty_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">isdirty_list</span><span class="p">),</span> <span class="s">&#39;safety. remove and evaluate if hit&#39;</span>
            <span class="c">#ibs.set_image_imagesettext(gid_list_, [&#39;HASGPS&#39;] * len(gid_list_))</span>
            <span class="n">new_exif_prop_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">exif_prop_list_</span><span class="p">,</span> <span class="n">isdirty_list</span><span class="p">)</span>
            <span class="n">dirty_gid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">,</span> <span class="n">isdirty_list</span><span class="p">)</span>
            <span class="n">ibs_setter</span><span class="p">(</span><span class="n">dirty_gid_list</span><span class="p">,</span> <span class="n">new_exif_prop_list</span><span class="p">)</span>

    <span class="n">FIX_GPS</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">FIX_GPS</span><span class="p">:</span>
        <span class="n">fix_property</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">get_lat_lon</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_gps</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_gps</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s">&#39;gps&#39;</span><span class="p">)</span>
        <span class="c">#latlon_list = [vt.get_lat_lon(_dict, None) for _dict in exif_dict_list]</span>
        <span class="c">#hasprop_list = [latlon is not None for latlon in latlon_list]</span>

        <span class="c">#latlon_list_ = ut.compress(latlon_list, hasprop_list)</span>
        <span class="c">#gid_list_    = ut.compress(gid_list, hasprop_list)</span>
        <span class="c">#gps_list = ibs.get_image_gps(gid_list_)</span>
        <span class="c">#isdirty_list = [gps == (-1, -1) for gps in gps_list]</span>

        <span class="c">#print(&#39;%d / %d need gps update&#39; % (sum(isdirty_list),</span>
        <span class="c">#                                   len(isdirty_list)))</span>

        <span class="c">#if False and sum(isdirty_list)  &gt; 0:</span>
        <span class="c">#    assert sum(isdirty_list) == len(isdirty_list), (</span>
        <span class="c">#        &#39;safety. remove and evaluate if hit&#39;)</span>
        <span class="c">#    #ibs.set_image_imagesettext(gid_list_, [&#39;HASGPS&#39;] * len(gid_list_))</span>
        <span class="c">#    latlon_list__ = ut.compress(latlon_list_, isdirty_list)</span>
        <span class="c">#    gid_list__ = ut.compress(gid_list_, isdirty_list)</span>
        <span class="c">#    ibs.set_image_gps(gid_list__, latlon_list__)</span>

    <span class="n">FIX_UNIXTIME</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">FIX_UNIXTIME</span><span class="p">:</span>
        <span class="n">dirty_ibs_val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">propname</span> <span class="o">=</span> <span class="s">&#39;unixtime&#39;</span>
        <span class="n">exif_getter</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">get_unixtime</span>
        <span class="n">ibs_getter</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span>
        <span class="n">ibs_setter</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_unixtime</span>
        <span class="n">fix_property</span><span class="p">(</span><span class="n">exif_getter</span><span class="p">,</span> <span class="n">ibs_getter</span><span class="p">,</span> <span class="n">ibs_setter</span><span class="p">,</span> <span class="n">dirty_ibs_val</span><span class="p">,</span> <span class="n">propname</span><span class="p">)</span>
        <span class="c">#exif_prop_list = [vt.get_unixtime(_dict, None) for _dict in exif_dict_list]</span>
        <span class="c">#hasprop_list = [prop is not None for prop in exif_prop_list]</span>

        <span class="c">#exif_prop_list_ = ut.compress(exif_prop_list, hasprop_list)</span>
        <span class="c">#gid_list_       = ut.compress(gid_list, hasprop_list)</span>
        <span class="c">#ibs_prop_list   = ibs.get_image_unixtime(gid_list_)</span>
        <span class="c">#isdirty_list    = [prop == dirty_ibs_val for prop in ibs_prop_list]</span>

        <span class="c">#print(&#39;%d / %d need time update&#39; % (sum(isdirty_list),</span>
        <span class="c">#                                    len(isdirty_list)))</span>

        <span class="c">#if False and sum(isdirty_list)  &gt; 0:</span>
        <span class="c">#    assert sum(isdirty_list) == len(isdirty_list), &#39;safety. remove and evaluate if hit&#39;</span>
        <span class="c">#    #ibs.set_image_imagesettext(gid_list_, [&#39;HASGPS&#39;] * len(gid_list_))</span>
        <span class="c">#    new_exif_prop_list = ut.compress(exif_prop_list_, isdirty_list)</span>
        <span class="c">#    dirty_gid_list = ut.compress(gid_list_, isdirty_list)</span>
        <span class="c">#    ibs.set_image_unixtime(dirty_gid_list, new_exif_prop_list)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="fix_invalid_nids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_invalid_nids">[docs]</a><span class="k">def</span> <span class="nf">fix_invalid_nids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Make sure that all rowids are greater than 0</span>

<span class="sd">    We can only handle there being a name with rowid 0 if it is UNKNOWN. In this</span>
<span class="sd">    case we safely delete it, but anything more complicated needs to be handled</span>
<span class="sd">    anually</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-fix_invalid_nids</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = fix_invalid_nids(ibs)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] fixing invalid nids (nids that are &lt;= ibs.UKNOWN_NAME_ROWID)&#39;</span><span class="p">)</span>
    <span class="c"># Get actual rowids from sql database (no postprocessing)</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_known_name_rowids</span><span class="p">()</span>
    <span class="c"># Get actual names from sql database (no postprocessing)</span>
    <span class="n">name_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">apply_fix</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">is_invalid_nid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">nid</span> <span class="o">&lt;=</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN_NAME_ROWID</span> <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nid_list</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_invalid_nid_list</span><span class="p">):</span>
        <span class="n">invalid_nids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">is_invalid_nid_list</span><span class="p">)</span>
        <span class="n">invalid_texts</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">name_text_list</span><span class="p">,</span> <span class="n">is_invalid_nid_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_nids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span>
              <span class="n">invalid_nids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN_NAME_ROWID</span> <span class="ow">and</span>
              <span class="n">invalid_texts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] found bad name rowids = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">invalid_nids</span><span class="p">,))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] found bad name texts  = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">invalid_texts</span><span class="p">,))</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">delete_names</span><span class="p">([</span><span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN_NAME_ROWID</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errmsg</span> <span class="o">=</span> <span class="s">&#39;Unfixable error: Found invalid (nid, text) pairs: &#39;</span>
            <span class="n">errmsg</span> <span class="o">+=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">invalid_nids</span><span class="p">,</span> <span class="n">invalid_texts</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="fix_invalid_name_texts"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_invalid_name_texts">[docs]</a><span class="k">def</span> <span class="nf">fix_invalid_name_texts</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Ensure  that no name text is empty or &#39;____&#39;</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-fix_invalid_names</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = fix_invalid_name_texts(ibs)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>

<span class="sd">    ibs.set_name_texts(nid_list[3], &#39;____&#39;)</span>
<span class="sd">    ibs.set_name_texts(nid_list[2], &#39;&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;checking for invalid name texts&#39;</span><span class="p">)</span>
    <span class="c"># Get actual rowids from sql database (no postprocessing)</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_known_name_rowids</span><span class="p">()</span>
    <span class="c"># Get actual names from sql database (no postprocessing)</span>
    <span class="n">name_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">apply_fix</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">invalid_name_set</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">}</span>
    <span class="n">is_invalid_name_text_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">name_text</span> <span class="ow">in</span> <span class="n">invalid_name_set</span>
                                 <span class="k">for</span> <span class="n">name_text</span> <span class="ow">in</span> <span class="n">name_text_list</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_invalid_name_text_list</span><span class="p">):</span>
        <span class="n">invalid_nids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">is_invalid_name_text_list</span><span class="p">)</span>
        <span class="n">invalid_texts</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">name_text_list</span><span class="p">,</span> <span class="n">is_invalid_name_text_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="n">invalid_nid</span><span class="p">,</span> <span class="n">invalid_text</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">invalid_nids</span><span class="p">,</span> <span class="n">invalid_texts</span><span class="p">)):</span>
            <span class="n">conflict_set</span> <span class="o">=</span> <span class="n">invalid_name_set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">apply_fix</span><span class="o">=</span><span class="bp">False</span><span class="p">)))</span>
            <span class="n">base_str</span> <span class="o">=</span> <span class="s">&#39;fixedname</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">invalid_text</span>
            <span class="n">new_text</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_nonconflicting_string</span><span class="p">(</span><span class="n">base_str</span><span class="p">,</span> <span class="n">conflict_set</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Fixing name </span><span class="si">%r</span><span class="s"> -&gt; </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">invalid_text</span><span class="p">,</span> <span class="n">new_text</span><span class="p">))</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">set_name_texts</span><span class="p">((</span><span class="n">invalid_nid</span><span class="p">,),</span> <span class="p">(</span><span class="n">new_text</span><span class="p">,))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Fixed </span><span class="si">%d</span><span class="s"> name texts&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_nids</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;all names seem valid&#39;</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="copy_imagesets"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.copy_imagesets">[docs]</a><span class="k">def</span> <span class="nf">copy_imagesets</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">imgsetid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        imgsetid_list (list):</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: new_imgsetid_list</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-copy_imagesets</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs.delete_all_imagesets()</span>
<span class="sd">        &gt;&gt;&gt; ibs.compute_occurrences()</span>
<span class="sd">        &gt;&gt;&gt; imgsetid_list = ibs.get_valid_imgsetids()</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; new_imgsetid_list = copy_imagesets(ibs, imgsetid_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = str(ibs.get_imageset_text(new_imgsetid_list))</span>
<span class="sd">        &gt;&gt;&gt; assert [2] == list(set(map(len, ibs.get_image_imgsetids(ibs.get_valid_gids()))))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        &gt;&gt;&gt; ibs.delete_all_imagesets()</span>
<span class="sd">        &gt;&gt;&gt; ibs.compute_occurrences()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_imagesettext_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_imgsetids</span><span class="p">())</span>
    <span class="n">imagesettext_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid_list</span><span class="p">)</span>
    <span class="n">new_imagesettext_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">get_nonconflicting_string</span><span class="p">(</span><span class="n">imagesettext</span> <span class="o">+</span> <span class="s">&#39;_Copy(</span><span class="si">%d</span><span class="s">)&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_imagesettext_list</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">imagesettext</span> <span class="ow">in</span> <span class="n">imagesettext_list</span>
    <span class="p">]</span>
    <span class="n">new_imgsetid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_imagesets</span><span class="p">(</span><span class="n">new_imagesettext_list</span><span class="p">)</span>
    <span class="n">gids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_gids</span><span class="p">(</span><span class="n">imgsetid_list</span><span class="p">)</span>
    <span class="c">#new_imgsetid_list =</span>
    <span class="k">for</span> <span class="n">gids</span><span class="p">,</span> <span class="n">new_imgsetid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gids_list</span><span class="p">,</span> <span class="n">new_imgsetid_list</span><span class="p">):</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_imgsetids</span><span class="p">(</span><span class="n">gids</span><span class="p">,</span> <span class="p">[</span><span class="n">new_imgsetid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">gids</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">new_imgsetid_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="fix_unknown_exemplars"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_unknown_exemplars">[docs]</a><span class="k">def</span> <span class="nf">fix_unknown_exemplars</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Goes through all of the annotations, and sets their exemplar flag to 0 if it</span>
<span class="sd">    is associated with an unknown annotation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="c">#nid_list = ibs.get_annot_nids(aid_list, distinguish_unknowns=False)</span>
    <span class="n">flag_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_exemplar_flags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">unknown_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_aid_unknown</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="c"># Exemplars should all be known</span>
    <span class="n">unknown_exemplar_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flag_list</span><span class="p">,</span> <span class="n">unknown_list</span><span class="p">)</span>
    <span class="n">unknown_aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">unknown_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Fixing </span><span class="si">%d</span><span class="s"> unknown annotations set as exemplars&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">unknown_exemplar_flags</span><span class="p">),))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_exemplar_flags</span><span class="p">(</span><span class="n">unknown_aid_list</span><span class="p">,</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown_aid_list</span><span class="p">))</span>
    <span class="c">#is_error = [not flag for flag in unknown_exemplar_flags]</span>
    <span class="c">#new_annots = [flag if nid != const.UNKNOWN_NAME_ROWID else 0</span>
    <span class="c">#              for nid, flag in</span>
    <span class="c">#              zip(nid_list, flag_list)]</span>
    <span class="c">#ibs.set_annot_exemplar_flags(aid_list, new_annots)</span>
    <span class="k">pass</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="delete_all_recomputable_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_recomputable_data">[docs]</a><span class="k">def</span> <span class="nf">delete_all_recomputable_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete all cached data including chips and imagesets</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_recomputable_data&#39;</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_cachedir</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_all_chips</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_all_imagesets</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_recomputable_data&#39;</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="delete_cache"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_cache">[docs]</a><span class="k">def</span> <span class="nf">delete_cache</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">delete_chips</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">delete_imagesets</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the cache directory in the database directory.</span>
<span class="sd">    Can specify to delete encoutners and chips as well.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">ensure_directories</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_cachedir</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">ensure_directories</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">delete_chips</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_all_chips</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">delete_imagesets</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_all_imagesets</span><span class="p">()</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="delete_cachedir"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_cachedir">[docs]</a><span class="k">def</span> <span class="nf">delete_cachedir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the cache directory in the database directory.</span>

<span class="sd">    (does not remove chips)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_cachedir&#39;</span><span class="p">)</span>
    <span class="c"># Need to close dbcache before restarting</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">_close_sqldbcache</span><span class="p">()</span>
    <span class="n">cachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_cachedir</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] cachedir=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cachedir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete cachedir&#39;</span><span class="p">)</span>
    <span class="c"># Reinit cache</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">ensure_directories</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">_init_sqldbcache</span><span class="p">()</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="delete_qres_cache"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_qres_cache">[docs]</a><span class="k">def</span> <span class="nf">delete_qres_cache</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis --tf delete_qres_cache</span>
<span class="sd">        python -m ibeis --tf delete_qres_cache --db PZ_MTEST</span>
<span class="sd">        python -m ibeis --tf delete_qres_cache --db PZ_Master1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = delete_qres_cache(ibs)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete delete_qres_cache&#39;</span><span class="p">)</span>
    <span class="n">qreq_cachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_qres_cachedir</span><span class="p">()</span>
    <span class="n">qreq_bigcachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_big_cachedir</span><span class="p">()</span>
    <span class="c"># Preliminary-ensure</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">qreq_bigcachedir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">qreq_cachedir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">qreq_cachedir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">qreq_bigcachedir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="c"># Re-ensure</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">qreq_bigcachedir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">qreq_cachedir</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_qres_cache&#39;</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="delete_neighbor_cache"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_neighbor_cache">[docs]</a><span class="k">def</span> <span class="nf">delete_neighbor_cache</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete neighbor_cache&#39;</span><span class="p">)</span>
    <span class="n">neighbor_cachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_neighbor_cachedir</span><span class="p">()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">neighbor_cachedir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">neighbor_cachedir</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete neighbor_cache&#39;</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="delete_all_features"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_features">[docs]</a><span class="k">def</span> <span class="nf">delete_all_features</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_features&#39;</span><span class="p">)</span>
    <span class="n">all_fids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_fids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_features</span><span class="p">(</span><span class="n">all_fids</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_features&#39;</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="delete_all_chips"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_chips">[docs]</a><span class="k">def</span> <span class="nf">delete_all_chips</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_chips&#39;</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">chipdir</span><span class="p">)</span>
    <span class="n">all_cids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_chip_rowids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_chips</span><span class="p">(</span><span class="n">all_cids</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">chipdir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">chipdir</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_chips&#39;</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="delete_all_imagesets"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_imagesets">[docs]</a><span class="k">def</span> <span class="nf">delete_all_imagesets</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_imagesets&#39;</span><span class="p">)</span>
    <span class="n">all_imgsetids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_imgsetids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_imagesets</span><span class="p">(</span><span class="n">all_imgsetids</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_imagesets&#39;</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="delete_all_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_annotations">[docs]</a><span class="k">def</span> <span class="nf">delete_all_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Carefull with this function. Annotations are not recomputable &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_annotations&#39;</span><span class="p">)</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">moves</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s">&#39;Are you sure you want to delete all annotations?&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ans</span> <span class="o">!=</span> <span class="s">&#39;yes&#39;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">all_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_aids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_annots</span><span class="p">(</span><span class="n">all_aids</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_annotations&#39;</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="delete_thumbnails"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_thumbnails">[docs]</a><span class="k">def</span> <span class="nf">delete_thumbnails</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">remove_files_in_dir</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_thumbdir</span><span class="p">())</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="delete_flann_cachedir"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_flann_cachedir">[docs]</a><span class="k">def</span> <span class="nf">delete_flann_cachedir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_flann_cachedir&#39;</span><span class="p">)</span>
    <span class="n">flann_cachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_flann_cachedir</span><span class="p">()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">remove_files_in_dir</span><span class="p">(</span><span class="n">flann_cachedir</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="delete_ibeis_database"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_ibeis_database">[docs]</a><span class="k">def</span> <span class="nf">delete_ibeis_database</span><span class="p">(</span><span class="n">dbdir</span><span class="p">):</span>
    <span class="n">_ibsdb</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dbdir</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">PATH_NAMES</span><span class="o">.</span><span class="n">_ibsdb</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] DELETEING: _ibsdb=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">_ibsdb</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">_ibsdb</span><span class="p">):</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">_ibsdb</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="print_flann_cachedir"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_flann_cachedir">[docs]</a><span class="k">def</span> <span class="nf">print_flann_cachedir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">flann_cachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_flann_cachedir</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">flann_cachedir</span><span class="p">)))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="vd"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.vd">[docs]</a><span class="k">def</span> <span class="nf">vd</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">view_dbdir</span><span class="p">()</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="view_dbdir"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.view_dbdir">[docs]</a><span class="k">def</span> <span class="nf">view_dbdir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">view_directory</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbdir</span><span class="p">())</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_empty_gids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_empty_gids">[docs]</a><span class="k">def</span> <span class="nf">get_empty_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">imgsetid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns gid list without any chips &quot;&quot;&quot;</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">(</span><span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">)</span>
    <span class="n">nRois_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_num_annotations</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">empty_gids</span> <span class="o">=</span> <span class="p">[</span><span class="n">gid</span> <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">nRois</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">nRois_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">nRois</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">empty_gids</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_vecs_cache"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_vecs_cache">[docs]</a><span class="k">def</span> <span class="nf">get_annot_vecs_cache</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    When you have a list with duplicates and you dont want to copy data</span>
<span class="sd">    creates a reference to each data object indexed by a dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unique_aids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aids</span><span class="p">))</span>
    <span class="n">unique_desc</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">(</span><span class="n">unique_aids</span><span class="p">)</span>
    <span class="n">desc_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_aids</span><span class="p">,</span> <span class="n">unique_desc</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">desc_cache</span>


<span class="c"># TODO: move to const</span>
</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_is_hard"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_is_hard">[docs]</a><span class="k">def</span> <span class="nf">get_annot_is_hard</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CmdLine:</span>
<span class="sd">        ./dev.py --cmd --db PZ_Mothers</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>
<span class="sd">        aid_list (list):</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: is_hard_list</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()[0::2]</span>
<span class="sd">        &gt;&gt;&gt; is_hard_list = get_annot_is_hard(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; result = str(is_hard_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [False, False, False, False, False, False, False]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">is_hard_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">HARD_NOTE_TAG</span> <span class="ow">in</span> <span class="n">notes</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="p">(</span><span class="n">notes</span><span class="p">)</span>
                    <span class="ow">in</span> <span class="n">notes_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">is_hard_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_hard_annot_rowids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_hard_annot_rowids">[docs]</a><span class="k">def</span> <span class="nf">get_hard_annot_rowids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">valid_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">hard_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_is_hard</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">hard_aids</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_easy_annot_rowids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_easy_annot_rowids">[docs]</a><span class="k">def</span> <span class="nf">get_easy_annot_rowids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">hard_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_hard_annot_rowids</span><span class="p">()</span>
    <span class="n">easy_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff_ordered</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(),</span> <span class="n">hard_aids</span><span class="p">)</span>
    <span class="n">easy_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">easy_aids</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_has_groundtruth</span><span class="p">(</span><span class="n">easy_aids</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">easy_aids</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="set_annot_is_hard"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_annot_is_hard">[docs]</a><span class="k">def</span> <span class="nf">set_annot_is_hard</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hack to mark hard cases in the notes column</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; pz_mothers_hard_aids = [27, 43, 44, 49, 50, 51, 54, 66, 89, 97]</span>
<span class="sd">        &gt;&gt;&gt; aid_list = pz_mothers_hard_aids</span>
<span class="sd">        &gt;&gt;&gt; flag_list = [True] * len(aid_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">is_hard_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">HARD_NOTE_TAG</span> <span class="ow">in</span> <span class="n">notes</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="p">(</span><span class="n">notes</span><span class="p">)</span> <span class="ow">in</span> <span class="n">notes_list</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">hack_notes</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">is_hard</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds or removes hard tag if needed &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="ow">and</span> <span class="n">is_hard</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">flag</span> <span class="ow">or</span> <span class="n">is_hard</span><span class="p">):</span>
            <span class="c"># do nothing</span>
            <span class="k">return</span> <span class="n">notes</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_hard</span> <span class="ow">and</span> <span class="n">flag</span><span class="p">:</span>
            <span class="c"># need to add flag</span>
            <span class="k">return</span> <span class="n">const</span><span class="o">.</span><span class="n">HARD_NOTE_TAG</span> <span class="o">+</span> <span class="s">&#39; &#39;</span>  <span class="o">+</span> <span class="n">notes</span>
        <span class="k">elif</span> <span class="n">is_hard</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">:</span>
            <span class="c"># need to remove flag</span>
            <span class="k">return</span> <span class="n">notes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">HARD_NOTE_TAG</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;impossible state&#39;</span><span class="p">)</span>

    <span class="n">new_notes_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">hack_notes</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">is_hard</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">notes</span><span class="p">,</span> <span class="n">is_hard</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">notes_list</span><span class="p">,</span> <span class="n">is_hard_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)]</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_notes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">new_notes_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">is_hard_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<span class="nd">@accessor_decors.getter_1to1</span>
<div class="viewcode-block" id="is_nid_unknown"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.is_nid_unknown">[docs]</a><span class="k">def</span> <span class="nf">is_nid_unknown</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span> <span class="n">nid</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nid_list</span><span class="p">]</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="set_annot_names_to_next_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_annot_names_to_next_name">[docs]</a><span class="k">def</span> <span class="nf">set_annot_names_to_next_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">next_name</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_name</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_names</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">next_name</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">_overwrite_annot_species_to_plains</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;zebra_plains&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)</span>


<span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">_overwrite_annot_species_to_grevys</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;zebra_grevys&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)</span>


<span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">_overwrite_annot_species_to_giraffe</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;giraffe_reticulated&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)</span>


<span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">_overwrite_all_annot_species_to</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">species</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; THIS OVERWRITES A LOT OF INFO &quot;&quot;&quot;</span>
    <span class="n">valid_species</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_all_species_texts</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">valid_species</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">species</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;is not in &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">valid_species</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)</span>


<div class="viewcode-block" id="unflat_map"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.unflat_map">[docs]</a><span class="k">def</span> <span class="nf">unflat_map</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">unflat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses an ibeis lookup function with a non-flat rowid list.</span>
<span class="sd">    In essence this is equivilent to map(method, unflat_rowids).</span>
<span class="sd">    The utility of this function is that it only calls method once.</span>
<span class="sd">    This is more efficient for calls that can take a list of inputs</span>

<span class="sd">    Args:</span>
<span class="sd">        method        (method):  ibeis controller method</span>
<span class="sd">        unflat_rowids (list): list of rowid lists</span>

<span class="sd">    Returns:</span>
<span class="sd">        list of values: unflat_vals</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-unflat_map</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; method = ibs.get_annot_name_rowids</span>
<span class="sd">        &gt;&gt;&gt; unflat_rowids = ibs.get_name_aids(ibs.get_valid_nids())</span>
<span class="sd">        &gt;&gt;&gt; unflat_vals = unflat_map(method, unflat_rowids)</span>
<span class="sd">        &gt;&gt;&gt; result = str(unflat_vals)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [[1, 1], [2, 2], [3], [4], [5], [6], [7]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#ut.assert_unflat_level(unflat_rowids, level=1, basetype=(int, uuid.UUID))</span>
    <span class="c"># First flatten the list, and remember the original dimensions</span>
    <span class="n">flat_rowids</span><span class="p">,</span> <span class="n">reverse_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">invertible_flatten2</span><span class="p">(</span><span class="n">unflat_rowids</span><span class="p">)</span>
    <span class="c"># Then preform the lookup / implicit mapping</span>
    <span class="n">flat_vals</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">flat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_vals</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_rowids</span><span class="p">),</span> <span class="p">(</span>
            <span class="s">&#39;flat lens not the same, len(flat_vals)=</span><span class="si">%d</span><span class="s"> len(flat_rowids)=</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flat_vals</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_rowids</span><span class="p">),))</span>
    <span class="c"># Then ut.unflatten2 the results to the original input dimensions</span>
    <span class="n">unflat_vals</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unflatten2</span><span class="p">(</span><span class="n">flat_vals</span><span class="p">,</span> <span class="n">reverse_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">unflat_vals</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">unflat_rowids</span><span class="p">),</span> <span class="p">(</span>
            <span class="s">&#39;unflat lens not the same, len(unflat_vals)=</span><span class="si">%d</span><span class="s"> len(unflat_rowids)=</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unflat_vals</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">unflat_rowids</span><span class="p">),))</span>
    <span class="k">return</span> <span class="n">unflat_vals</span>


<span class="c">#def unflat_filter(method, unflat_rowids, **kwargs):</span>
    <span class="c"># does not seem possible with this input</span>

</div>
<div class="viewcode-block" id="unflat_dict_map"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.unflat_dict_map">[docs]</a><span class="k">def</span> <span class="nf">unflat_dict_map</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">dict_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; maps dictionaries of rowids to a function &quot;&quot;&quot;</span>
    <span class="n">key_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_rowids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">unflat_rowids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_rowids</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">unflat_vals</span> <span class="o">=</span> <span class="n">unflat_map</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">unflat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">keyval_iter</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">key_list</span><span class="p">,</span> <span class="n">unflat_vals</span><span class="p">)</span>
    <span class="c">#_dict_cls = type(dict_rowids)</span>
    <span class="c">#if isinstance(dict_rowids, ut.ddict):</span>
    <span class="c">#    _dict_cls_args = (dict_rowids.default_factory, keyval_iter)</span>
    <span class="c">#else:</span>
    <span class="c">#    _dict_cls_args = (keyval_iter,)</span>
    <span class="c">#dict_vals = _dict_cls(*_dict_cls_args)</span>
    <span class="n">dict_vals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">keyval_iter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dict_vals</span>

</div>
<div class="viewcode-block" id="unflat_multimap"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.unflat_multimap">[docs]</a><span class="k">def</span> <span class="nf">unflat_multimap</span><span class="p">(</span><span class="n">method_list</span><span class="p">,</span> <span class="n">unflat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; unflat_map, but allows multiple methods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># First flatten the list, and remember the original dimensions</span>
    <span class="n">flat_rowids</span><span class="p">,</span> <span class="n">reverse_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">invertible_flatten2</span><span class="p">(</span><span class="n">unflat_rowids</span><span class="p">)</span>
    <span class="c"># Then preform the lookup / implicit mapping</span>
    <span class="n">flat_vals_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">method</span><span class="p">(</span><span class="n">flat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">method_list</span><span class="p">]</span>
    <span class="c"># Then ut.unflatten2 the results to the original input dimensions</span>
    <span class="n">unflat_vals_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">unflatten2</span><span class="p">(</span><span class="n">flat_vals</span><span class="p">,</span> <span class="n">reverse_list</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">flat_vals</span> <span class="ow">in</span> <span class="n">flat_vals_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">unflat_vals_list</span>

</div>
<span class="k">def</span> <span class="nf">_make_unflat_getter_func</span><span class="p">(</span><span class="n">flat_getter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    makes an unflat version of an ibeis getter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flat_getter</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">):</span>
        <span class="c"># Unwrap fmethods</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">get_imfunc</span><span class="p">(</span><span class="n">flat_getter</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">flat_getter</span>
    <span class="n">funcname</span> <span class="o">=</span> <span class="n">get_funcname</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">funcname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;get_&#39;</span><span class="p">),</span> <span class="s">&#39;only works on getters, not: &#39;</span> <span class="o">+</span> <span class="n">funcname</span>
    <span class="c"># Create new function</span>
    <span class="k">def</span> <span class="nf">unflat_getter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unflat_rowids</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># First flatten the list</span>
        <span class="n">flat_rowids</span><span class="p">,</span> <span class="n">reverse_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">invertible_flatten2</span><span class="p">(</span><span class="n">unflat_rowids</span><span class="p">)</span>
        <span class="c"># Then preform the lookup</span>
        <span class="n">flat_vals</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flat_rowids</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c"># Then ut.unflatten2 the list</span>
        <span class="n">unflat_vals</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unflatten2</span><span class="p">(</span><span class="n">flat_vals</span><span class="p">,</span> <span class="n">reverse_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unflat_vals</span>
    <span class="n">set_funcname</span><span class="p">(</span><span class="n">unflat_getter</span><span class="p">,</span> <span class="n">funcname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;get_&#39;</span><span class="p">,</span> <span class="s">&#39;get_unflat_&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">unflat_getter</span>


<div class="viewcode-block" id="ensure_unix_gpaths"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.ensure_unix_gpaths">[docs]</a><span class="k">def</span> <span class="nf">ensure_unix_gpaths</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asserts that all paths are given with forward slashes.</span>
<span class="sd">    If not it fixes them</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#if ut.NO_ASSERTS:</span>
    <span class="c">#    return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;gpath_list must be in unix format (no backslashes).&#39;</span>
               <span class="s">&#39;Failed on </span><span class="si">%d</span><span class="s">-th gpath=</span><span class="si">%r</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">gpath</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">gpath</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">gpath</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">gpath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unixpath</span><span class="p">,</span> <span class="n">gpath_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gpath_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<span class="nd">@accessor_decors.getter_1to1</span>
<div class="viewcode-block" id="get_annot_info"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_info">[docs]</a><span class="k">def</span> <span class="nf">get_annot_info</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">reference_aid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (list):  list of annotation rowids</span>
<span class="sd">        default (bool): (default = False)</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: infodict_list</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_annot_info --tb</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()[0:2]</span>
<span class="sd">        &gt;&gt;&gt; default = True</span>
<span class="sd">        &gt;&gt;&gt; infodict_list = ibs.get_annot_info(1, default)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;infodict_list = %s&#39; % (ut.obj_str(infodict_list, nl=4),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># TODO rectify and combine with viz_helpers.get_annot_texts</span>
    <span class="n">key_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vals_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c">#if len(aid_list) == 0:</span>
    <span class="c">#    return []</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;aid&#39;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span> <span class="ow">or</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">vals_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">aid_list</span><span class="p">]</span>
        <span class="n">key_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;notes&#39;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="n">vals_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)]</span>
        <span class="n">key_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;case_tags&#39;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="n">vals_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_case_tags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)]</span>
        <span class="n">key_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;match_tags&#39;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="n">vals_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_annotmatch_tags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)]</span>
        <span class="n">key_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;name&#39;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="n">vals_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_names</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)]</span>
        <span class="n">key_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;nid&#39;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="n">vals_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)]</span>
        <span class="n">key_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;num_gt&#39;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="n">vals_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_num_groundtruth</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)]</span>
        <span class="n">key_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;gname&#39;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="n">vals_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_names</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)]</span>
        <span class="n">key_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;yawtext&#39;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="n">vals_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)]</span>
        <span class="n">key_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;time&#39;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="n">vals_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)]</span>
        <span class="n">key_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;timedelta&#39;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span> <span class="ow">and</span> <span class="n">reference_aid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes_asfloat</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
        <span class="n">ref_time</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes_asfloat</span><span class="p">(</span><span class="n">reference_aid</span><span class="p">)</span>
        <span class="n">vals_list</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">times</span> <span class="o">-</span> <span class="n">ref_time</span><span class="p">)]</span>
        <span class="n">key_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;quality_text&#39;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="n">vals_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)]</span>
        <span class="n">key_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;exemplar&#39;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="n">vals_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_exemplar_flags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)]</span>
        <span class="n">key_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">infodict_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="n">key_</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">key_list</span><span class="p">,</span> <span class="n">vals</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">vals_list</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">infodict_list</span>

</div>
<div class="viewcode-block" id="aidstr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.aidstr">[docs]</a><span class="k">def</span> <span class="nf">aidstr</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Helper to make a string from an aid &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">notes</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;aid</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">name</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_names</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;aid</span><span class="si">%d</span><span class="s">-</span><span class="si">%r</span><span class="s">-</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">notes</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="vsstr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.vsstr">[docs]</a><span class="k">def</span> <span class="nf">vsstr</span><span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">lite</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">lite</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">-vs-</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">aid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;qaid</span><span class="si">%d</span><span class="s">-vs-aid</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">aid</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<span class="nd">@ut.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_exemplar_special_imageset"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_exemplar_special_imageset">[docs]</a><span class="k">def</span> <span class="nf">update_exemplar_special_imageset</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">exemplar_imgsetid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_imgsetids_from_text</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">EXEMPLAR_IMAGESETTEXT</span><span class="p">)</span>
    <span class="c">#ibs.delete_imagesets(exemplar_imgsetid)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_gsgr_imageset_relations</span><span class="p">(</span><span class="n">exemplar_imgsetid</span><span class="p">)</span>
    <span class="c">#aid_list = ibs.get_valid_aids(is_exemplar=True)</span>
    <span class="c">#gid_list = ut.unique_ordered(ibs.get_annot_gids(aid_list))</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_get_exemplar_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">)))</span>
    <span class="c">#ibs.set_image_imagesettext(gid_list, [const.EXEMPLAR_IMAGESETTEXT] * len(gid_list))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_imgsetids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">exemplar_imgsetid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<span class="nd">@ut.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_reviewed_unreviewed_image_special_imageset"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_reviewed_unreviewed_image_special_imageset">[docs]</a><span class="k">def</span> <span class="nf">update_reviewed_unreviewed_image_special_imageset</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates imageset of images that have not been reviewed</span>
<span class="sd">    and that have been reviewed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">unreviewed_imgsetid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_imgsetids_from_text</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">UNREVIEWED_IMAGE_IMAGESETTEXT</span><span class="p">)</span>
    <span class="n">reviewed_imgsetid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_imgsetids_from_text</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">REVIEWED_IMAGE_IMAGESETTEXT</span><span class="p">)</span>
    <span class="c">#ibs.delete_imagesets(imgsetid)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_gsgr_imageset_relations</span><span class="p">(</span><span class="n">unreviewed_imgsetid</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_gsgr_imageset_relations</span><span class="p">(</span><span class="n">reviewed_imgsetid</span><span class="p">)</span>
    <span class="c">#gid_list = ibs.get_valid_gids(reviewed=False)</span>
    <span class="c">#ibs.set_image_imagesettext(gid_list, [const.UNREVIEWED_IMAGE_IMAGESETTEXT] * len(gid_list))</span>
    <span class="n">unreviewed_gids</span> <span class="o">=</span> <span class="n">_get_unreviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>  <span class="c"># hack</span>
    <span class="n">reviewed_gids</span>   <span class="o">=</span> <span class="n">_get_reviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>  <span class="c"># hack</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_imgsetids</span><span class="p">(</span><span class="n">unreviewed_gids</span><span class="p">,</span> <span class="p">[</span><span class="n">unreviewed_imgsetid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">unreviewed_gids</span><span class="p">))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_imgsetids</span><span class="p">(</span><span class="n">reviewed_gids</span><span class="p">,</span> <span class="p">[</span><span class="n">reviewed_imgsetid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">reviewed_gids</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<span class="nd">@ut.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_all_image_special_imageset"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_all_image_special_imageset">[docs]</a><span class="k">def</span> <span class="nf">update_all_image_special_imageset</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">allimg_imgsetid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_imgsetids_from_text</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ALL_IMAGE_IMAGESETTEXT</span><span class="p">)</span>
    <span class="c">#ibs.delete_imagesets(allimg_imgsetid)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="c">#ibs.set_image_imagesettext(gid_list, [const.ALL_IMAGE_IMAGESETTEXT] * len(gid_list))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_imgsetids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">allimg_imgsetid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_special_imgsetids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_special_imgsetids">[docs]</a><span class="k">def</span> <span class="nf">get_special_imgsetids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">get_imagesettext_imgsetid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_imgsetids_from_text</span>
    <span class="n">special_imagesettext_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">const</span><span class="o">.</span><span class="n">UNGROUPED_IMAGES_IMAGESETTEXT</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ALL_IMAGE_IMAGESETTEXT</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">UNREVIEWED_IMAGE_IMAGESETTEXT</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">REVIEWED_IMAGE_IMAGESETTEXT</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">EXEMPLAR_IMAGESETTEXT</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">special_imgsetids_</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_imagesettext_imgsetid</span><span class="p">(</span><span class="n">imagesettext</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">imagesettext</span> <span class="ow">in</span> <span class="n">special_imagesettext_list</span><span class="p">]</span>
    <span class="n">special_imgsetids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">special_imgsetids_</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">special_imgsetids</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_ungrouped_gids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_ungrouped_gids">[docs]</a><span class="k">def</span> <span class="nf">get_ungrouped_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_ungrouped_gids</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs.delete_all_imagesets()</span>
<span class="sd">        &gt;&gt;&gt; ibs.compute_occurrences()</span>
<span class="sd">        &gt;&gt;&gt; ibs.update_special_imagesets()</span>
<span class="sd">        &gt;&gt;&gt; # Now we want to remove some images from a non-special imageset</span>
<span class="sd">        &gt;&gt;&gt; nonspecial_imgsetids = [i for i in ibs.get_valid_imgsetids() if i not in ibs.get_special_imgsetids()]</span>
<span class="sd">        &gt;&gt;&gt; print(&quot;Nonspecial EIDs %r&quot; % nonspecial_imgsetids)</span>
<span class="sd">        &gt;&gt;&gt; images_to_remove = ibs.get_imageset_gids(nonspecial_imgsetids[0:1])[0][0:1]</span>
<span class="sd">        &gt;&gt;&gt; print(&quot;Removing %r&quot; % images_to_remove)</span>
<span class="sd">        &gt;&gt;&gt; ibs.unrelate_images_and_imagesets(images_to_remove,nonspecial_imgsetids[0:1] * len(images_to_remove))</span>
<span class="sd">        &gt;&gt;&gt; ibs.update_special_imagesets()</span>
<span class="sd">        &gt;&gt;&gt; ungr_imgsetid = ibs.get_imageset_imgsetids_from_text(const.UNGROUPED_IMAGES_IMAGESETTEXT)</span>
<span class="sd">        &gt;&gt;&gt; print(&quot;Ungrouped gids %r&quot; % ibs.get_ungrouped_gids())</span>
<span class="sd">        &gt;&gt;&gt; print(&quot;Ungrouped imgsetid %d contains %r&quot; % (ungr_imgsetid, ibs.get_imageset_gids([ungr_imgsetid])))</span>
<span class="sd">        &gt;&gt;&gt; ungr_gids = ibs.get_imageset_gids([ungr_imgsetid])[0]</span>
<span class="sd">        &gt;&gt;&gt; assert(sorted(images_to_remove) == sorted(ungr_gids))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">special_imgsetids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_special_imgsetids</span><span class="p">(</span><span class="n">ibs</span><span class="p">))</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">imgsetids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_imgsetids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">has_imgsetids</span> <span class="o">=</span> <span class="p">[</span><span class="n">special_imgsetids</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">imgsetids</span><span class="p">))</span> <span class="k">for</span> <span class="n">imgsetids</span> <span class="ow">in</span> <span class="n">imgsetids_list</span><span class="p">]</span>
    <span class="n">ungrouped_gids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">has_imgsetids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ungrouped_gids</span>

</div>
<span class="nd">@register_ibs_method</span>
<span class="c">#@ut.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_ungrouped_special_imageset"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_ungrouped_special_imageset">[docs]</a><span class="k">def</span> <span class="nf">update_ungrouped_special_imageset</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-update_ungrouped_special_imageset</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb9&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = update_ungrouped_special_imageset(ibs)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># FIXME SLOW</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] update_ungrouped_special_imageset.1&#39;</span><span class="p">)</span>
    <span class="n">ungrouped_imgsetid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_imgsetids_from_text</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">UNGROUPED_IMAGES_IMAGESETTEXT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] update_ungrouped_special_imageset.2&#39;</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_gsgr_imageset_relations</span><span class="p">(</span><span class="n">ungrouped_imgsetid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] update_ungrouped_special_imageset.3&#39;</span><span class="p">)</span>
    <span class="n">ungrouped_gids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_ungrouped_gids</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] update_ungrouped_special_imageset.4&#39;</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_imgsetids</span><span class="p">(</span><span class="n">ungrouped_gids</span><span class="p">,</span> <span class="p">[</span><span class="n">ungrouped_imgsetid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ungrouped_gids</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] update_ungrouped_special_imageset.5&#39;</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<span class="nd">@ut.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_special_imagesets"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_special_imagesets">[docs]</a><span class="k">def</span> <span class="nf">update_special_imagesets</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--readonly-mode&#39;</span><span class="p">):</span>
        <span class="c"># SUPER HACK</span>
        <span class="k">return</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">USE_MORE_SPECIAL_IMAGESETS</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">ensure_attr</span><span class="p">(</span>
        <span class="s">&#39;use_more_special_imagesets&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">USE_MORE_SPECIAL_IMAGESETS</span><span class="p">:</span>
        <span class="c">#ibs.update_reviewed_unreviewed_image_special_imageset()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">update_exemplar_special_imageset</span><span class="p">()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">update_all_image_special_imageset</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">update_ungrouped_special_imageset</span><span class="p">()</span>

</div>
<span class="k">def</span> <span class="nf">_get_unreviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># hack</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {IMAGE_TABLE}</span>
<span class="sd">        WHERE</span>
<span class="sd">        image_toggle_reviewed=0</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">const</span><span class="o">.</span><span class="n">__dict__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="k">def</span> <span class="nf">_get_reviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># hack</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {IMAGE_TABLE}</span>
<span class="sd">        WHERE</span>
<span class="sd">        image_toggle_reviewed=1</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">const</span><span class="o">.</span><span class="n">__dict__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="k">def</span> <span class="nf">_get_gids_in_imgsetid</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">imgsetid</span><span class="p">):</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {GSG_RELATION_TABLE}</span>
<span class="sd">        WHERE</span>
<span class="sd">            imageset_rowid==?</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">const</span><span class="o">.</span><span class="n">__dict__</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="k">def</span> <span class="nf">_get_dirty_reviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">imgsetid</span><span class="p">):</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {GSG_RELATION_TABLE}</span>
<span class="sd">        WHERE</span>
<span class="sd">            imageset_rowid==? AND</span>
<span class="sd">            image_rowid NOT IN (SELECT rowid FROM {IMAGE_TABLE} WHERE image_toggle_reviewed=1)</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">const</span><span class="o">.</span><span class="n">__dict__</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="k">def</span> <span class="nf">_get_exemplar_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {ANNOTATION_TABLE}</span>
<span class="sd">        WHERE annot_exemplar_flag=1</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">const</span><span class="o">.</span><span class="n">__dict__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="c">#@register_ibs_method</span>
<span class="c">#def print_stats(ibs):</span>
    <span class="c">#from ibeis.other import dbinfo</span>
    <span class="c">#dbinfo.dbstats(ibs)</span>


<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_dbinfo"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_dbinfo">[docs]</a><span class="k">def</span> <span class="nf">print_dbinfo</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.other</span> <span class="kn">import</span> <span class="n">dbinfo</span>
    <span class="n">dbinfo</span><span class="o">.</span><span class="n">get_dbinfo</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">*</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_infostr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_infostr">[docs]</a><span class="k">def</span> <span class="nf">print_infostr</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_infostr</span><span class="p">())</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_annotation_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_annotation_table">[docs]</a><span class="k">def</span> <span class="nf">print_annotation_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[],</span> <span class="n">include_columns</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dumps annotation table to stdout</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>
<span class="sd">        verbosity (int):</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; verbosity = 1</span>
<span class="sd">        &gt;&gt;&gt; print_annotation_table(ibs, verbosity)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exclude_columns</span> <span class="o">=</span> <span class="n">exclude_columns</span><span class="p">[:]</span>
    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;annot_uuid&#39;</span><span class="p">,</span> <span class="s">&#39;annot_verts&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="s">&#39;annot_xtl&#39;</span><span class="p">,</span> <span class="s">&#39;annot_ytl&#39;</span><span class="p">,</span> <span class="s">&#39;annot_width&#39;</span><span class="p">,</span> <span class="s">&#39;annot_height&#39;</span><span class="p">,</span>
            <span class="s">&#39;annot_theta&#39;</span><span class="p">,</span> <span class="s">&#39;annot_yaw&#39;</span><span class="p">,</span> <span class="s">&#39;annot_detect_confidence&#39;</span><span class="p">,</span>
            <span class="s">&#39;annot_note&#39;</span><span class="p">,</span> <span class="s">&#39;annot_parent_rowid&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">include_columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exclude_columns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_annotmatch_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_annotmatch_table">[docs]</a><span class="k">def</span> <span class="nf">print_annotmatch_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dumps annotation match table to stdout</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-print_annotmatch_table</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-print_annotmatch_table --db PZ_Master1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = print_annotmatch_table(ibs)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">exclude_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;annotmatch_confidence&#39;</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_chip_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_chip_table">[docs]</a><span class="k">def</span> <span class="nf">print_chip_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">CHIP_TABLE</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_feat_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_feat_table">[docs]</a><span class="k">def</span> <span class="nf">print_feat_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">FEATURE_TABLE</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span>
        <span class="s">&#39;feature_keypoints&#39;</span><span class="p">,</span> <span class="s">&#39;feature_vecs&#39;</span><span class="p">]))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_image_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_image_table">[docs]</a><span class="k">def</span> <span class="nf">print_image_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="c">#, exclude_columns=[&#39;image_rowid&#39;]))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_party_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_party_table">[docs]</a><span class="k">def</span> <span class="nf">print_party_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">PARTY_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="c">#, exclude_columns=[&#39;image_rowid&#39;]))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_lblannot_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_lblannot_table">[docs]</a><span class="k">def</span> <span class="nf">print_lblannot_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps lblannot table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">LBLANNOT_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_name_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_name_table">[docs]</a><span class="k">def</span> <span class="nf">print_name_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps name table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">NAME_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_species_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_species_table">[docs]</a><span class="k">def</span> <span class="nf">print_species_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps species table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">SPECIES_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_alr_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_alr_table">[docs]</a><span class="k">def</span> <span class="nf">print_alr_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps alr table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">AL_RELATION_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_config_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_config_table">[docs]</a><span class="k">def</span> <span class="nf">print_config_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps config table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">CONFIG_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_imageset_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_imageset_table">[docs]</a><span class="k">def</span> <span class="nf">print_imageset_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps imageset table to stdout</span>

<span class="sd">    Kwargs:</span>
<span class="sd">        exclude_columns (list):</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">IMAGESET_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_egpairs_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_egpairs_table">[docs]</a><span class="k">def</span> <span class="nf">print_egpairs_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps egpairs table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">GSG_RELATION_TABLE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_tables"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_tables">[docs]</a><span class="k">def</span> <span class="nf">print_tables</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude_tables</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">exclude_columns</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">exclude_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;annot_uuid&#39;</span><span class="p">,</span> <span class="s">&#39;lblannot_uuid&#39;</span><span class="p">,</span> <span class="s">&#39;annot_verts&#39;</span><span class="p">,</span> <span class="s">&#39;feature_keypoints&#39;</span><span class="p">,</span>
                           <span class="s">&#39;feature_vecs&#39;</span><span class="p">,</span> <span class="s">&#39;image_uuid&#39;</span><span class="p">,</span> <span class="s">&#39;image_uri&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">exclude_tables</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">exclude_tables</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;masks&#39;</span><span class="p">,</span> <span class="s">&#39;recognitions&#39;</span><span class="p">,</span> <span class="s">&#39;chips&#39;</span><span class="p">,</span> <span class="s">&#39;features&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">exclude_tables</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">))</span>
    <span class="c">#ibs.print_image_table()</span>
    <span class="c">#ibs.print_annotation_table()</span>
    <span class="c">#ibs.print_lblannots_table()</span>
    <span class="c">#ibs.print_alr_table()</span>
    <span class="c">#ibs.print_config_table()</span>
    <span class="c">#ibs.print_chip_table()</span>
    <span class="c">#ibs.print_feat_table()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_contributor_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_contributor_table">[docs]</a><span class="k">def</span> <span class="nf">print_contributor_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dumps annotation table to stdout</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>
<span class="sd">        verbosity (int):</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; verbosity = 1</span>
<span class="sd">        &gt;&gt;&gt; print_contributor_table(ibs, verbosity)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exclude_columns</span> <span class="o">=</span> <span class="n">exclude_columns</span><span class="p">[:]</span>
    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;contributor_uuid&#39;</span><span class="p">]</span>
        <span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;contributor_location_city&#39;</span><span class="p">]</span>
        <span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;contributor_location_state&#39;</span><span class="p">]</span>
        <span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;contributor_location_country&#39;</span><span class="p">]</span>
        <span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;contributor_location_zip&#39;</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">CONTRIBUTOR_TABLE</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="is_aid_unknown"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.is_aid_unknown">[docs]</a><span class="k">def</span> <span class="nf">is_aid_unknown</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns if an annotation has been given a name (even if that name is temporary)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="make_imagesettext_list"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.make_imagesettext_list">[docs]</a><span class="k">def</span> <span class="nf">make_imagesettext_list</span><span class="p">(</span><span class="n">imgsetid_list</span><span class="p">,</span> <span class="n">occur_cfgstr</span><span class="p">):</span>
    <span class="c"># DEPRICATE</span>
    <span class="n">imagesettext_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span> <span class="o">+</span> <span class="n">occur_cfgstr</span> <span class="k">for</span> <span class="n">imgsetid</span> <span class="ow">in</span> <span class="n">imgsetid_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">imagesettext_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="batch_rename_consecutive_via_species"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.batch_rename_consecutive_via_species">[docs]</a><span class="k">def</span> <span class="nf">batch_rename_consecutive_via_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">imgsetid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; actually sets the new consectuive names&quot;&quot;&quot;</span>
    <span class="n">new_nid_list</span><span class="p">,</span> <span class="n">new_name_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_consecutive_newname_list_via_species</span><span class="p">(</span><span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_conflict_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">new_nid_list</span><span class="p">,</span> <span class="n">new_name_list</span><span class="p">):</span>
        <span class="n">other_nid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_nid_list</span><span class="p">))</span>
        <span class="n">other_names</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">other_nid_list</span><span class="p">)</span>
        <span class="n">conflict_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">other_names</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new_name_list</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">conflict_names</span>

    <span class="k">def</span> <span class="nf">_assert_no_name_conflicts</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">new_nid_list</span><span class="p">,</span> <span class="n">new_name_list</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;checking for conflicting names&#39;</span><span class="p">)</span>
        <span class="n">conflit_names</span> <span class="o">=</span> <span class="n">get_conflict_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">new_nid_list</span><span class="p">,</span> <span class="n">new_name_list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">conflit_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;conflit_names=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">conflit_names</span><span class="p">,)</span>

    <span class="c"># Check to make sure new names dont conflict with other names</span>
    <span class="n">_assert_no_name_conflicts</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">new_nid_list</span><span class="p">,</span> <span class="n">new_name_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_name_texts</span><span class="p">(</span><span class="n">new_nid_list</span><span class="p">,</span> <span class="n">new_name_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">NOT_QUIET</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_consecutive_newname_list_via_species"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_consecutive_newname_list_via_species">[docs]</a><span class="k">def</span> <span class="nf">get_consecutive_newname_list_via_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">imgsetid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Just creates the nams, but does not set them</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_consecutive_newname_list_via_species</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs._clean_species()</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; imgsetid = None</span>
<span class="sd">        &gt;&gt;&gt; new_nid_list, new_name_list = get_consecutive_newname_list_via_species(ibs, imgsetid=imgsetid)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.list_str((new_nid_list, new_name_list))</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        (</span>
<span class="sd">            [1, 2, 3, 4, 5, 6, 7],</span>
<span class="sd">            [&#39;IBEIS_PZ_0001&#39;, &#39;IBEIS_PZ_0002&#39;, &#39;IBEIS_UNKNOWN_0001&#39;, &#39;IBEIS_UNKNOWN_0002&#39;, &#39;IBEIS_GZ_0001&#39;, &#39;IBEIS_PB_0001&#39;, &#39;IBEIS_UNKNOWN_0003&#39;],</span>
<span class="sd">        )</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs._clean_species()</span>
<span class="sd">        &gt;&gt;&gt; ibs.delete_all_imagesets()</span>
<span class="sd">        &gt;&gt;&gt; ibs.compute_occurrences()</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; imgsetid = ibs.get_valid_imgsetids()[1]</span>
<span class="sd">        &gt;&gt;&gt; new_nid_list, new_name_list = get_consecutive_newname_list_via_species(ibs, imgsetid=imgsetid)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.list_str((new_nid_list, new_name_list))</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        (</span>
<span class="sd">            [4, 5, 6, 7],</span>
<span class="sd">            [&#39;IBEIS_UNKNOWN_Occurrence_1_0001&#39;, &#39;IBEIS_GZ_Occurrence_1_0001&#39;, &#39;IBEIS_PB_Occurrence_1_0001&#39;, &#39;IBEIS_UNKNOWN_Occurrence_1_0002&#39;],</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] get_consecutive_newname_list_via_species&#39;</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_empty_nids</span><span class="p">()</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">(</span><span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">)</span>
    <span class="c">#name_list = ibs.get_name_texts(nid_list)</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">species_rowids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_rowids</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="n">unique_species_rowids_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unique_ordered</span><span class="p">,</span> <span class="n">species_rowids_list</span><span class="p">))</span>
    <span class="n">code_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_codes</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">unique_species_rowids_list</span><span class="p">))</span>

    <span class="n">_code2_count</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_next_index</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
        <span class="n">_code2_count</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">_code2_count</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>

    <span class="n">location_text</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">location_for_names</span>
    <span class="k">if</span> <span class="n">imgsetid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">imgset_text</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>
        <span class="n">imgset_text</span> <span class="o">=</span> <span class="n">imgset_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">new_name_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%04d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">location_text</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">imgset_text</span><span class="p">,</span> <span class="n">get_next_index</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">code_list</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_name_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%04d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">location_text</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">get_next_index</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">code_list</span><span class="p">]</span>
    <span class="n">new_nid_list</span> <span class="o">=</span> <span class="n">nid_list</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_nid_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_name_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_nid_list</span><span class="p">,</span> <span class="n">new_name_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="set_annot_names_to_same_new_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_annot_names_to_same_new_name">[docs]</a><span class="k">def</span> <span class="nf">set_annot_names_to_same_new_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">new_nid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_nids</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Setting aid_list={aid_list} to have new_nid={new_nid}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">aid_list</span><span class="o">=</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">new_nid</span><span class="o">=</span><span class="n">new_nid</span><span class="p">))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">new_nid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="set_annot_names_to_different_new_names"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_annot_names_to_different_new_names">[docs]</a><span class="k">def</span> <span class="nf">set_annot_names_to_different_new_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">new_nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_nids</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Setting aid_list={aid_list} to have new_nid_list={new_nid_list}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">aid_list</span><span class="o">=</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">new_nid_list</span><span class="o">=</span><span class="n">new_nid_list</span><span class="p">))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">new_nid_list</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="make_next_nids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.make_next_nids">[docs]</a><span class="k">def</span> <span class="nf">make_next_nids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    makes name and adds it to the database returning the newly added name rowid(s)</span>

<span class="sd">    CAUTION; changes database state</span>

<span class="sd">    SeeAlso:</span>
<span class="sd">        make_next_name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">next_names</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_name</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">next_nids</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_names</span><span class="p">(</span><span class="n">next_names</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">next_nids</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="make_next_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.make_next_name">[docs]</a><span class="k">def</span> <span class="nf">make_next_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">str_format</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">species_text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">location_text</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Creates a number of names which are not in the database, but does not</span>
<span class="sd">    add them</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        num (None):</span>
<span class="sd">        str_format (int): either 1 or 2</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: next_name</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-make_next_name</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs1 = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs2 = ibeis.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs3 = ibeis.opendb(&#39;NAUT_test&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #ibs5 = ibeis.opendb(&#39;GIR_Tanya&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs1._clean_species()</span>
<span class="sd">        &gt;&gt;&gt; ibs2._clean_species()</span>
<span class="sd">        &gt;&gt;&gt; ibs3._clean_species()</span>
<span class="sd">        &gt;&gt;&gt; num = None</span>
<span class="sd">        &gt;&gt;&gt; str_format = 2</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; next_name1 = make_next_name(ibs1, num, str_format)</span>
<span class="sd">        &gt;&gt;&gt; next_name2 = make_next_name(ibs2, num, str_format)</span>
<span class="sd">        &gt;&gt;&gt; next_name3 = make_next_name(ibs3, num, str_format)</span>
<span class="sd">        &gt;&gt;&gt; next_name4 = make_next_name(ibs1, num, str_format, const.TEST_SPECIES.ZEB_GREVY)</span>
<span class="sd">        &gt;&gt;&gt; name_list = [next_name1, next_name2, next_name3, next_name4]</span>
<span class="sd">        &gt;&gt;&gt; next_name_list1 = make_next_name(ibs2, 5, str_format)</span>
<span class="sd">        &gt;&gt;&gt; temp_nids = ibs2.add_names([&#39;IBEIS_PZ_0045&#39;, &#39;IBEIS_PZ_0048&#39;])</span>
<span class="sd">        &gt;&gt;&gt; next_name_list2 = make_next_name(ibs2, 5, str_format)</span>
<span class="sd">        &gt;&gt;&gt; ibs2.delete_names(temp_nids)</span>
<span class="sd">        &gt;&gt;&gt; next_name_list3 = make_next_name(ibs2, 5, str_format)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; # FIXME: nautiluses are not working right</span>
<span class="sd">        &gt;&gt;&gt; result = ut.list_str((name_list, next_name_list1, next_name_list2, next_name_list3))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        (</span>
<span class="sd">            [&#39;IBEIS_UNKNOWN_0008&#39;, &#39;IBEIS_PZ_0042&#39;, &#39;IBEIS_UNKNOWN_0004&#39;, &#39;IBEIS_GZ_0008&#39;],</span>
<span class="sd">            [&#39;IBEIS_PZ_0042&#39;, &#39;IBEIS_PZ_0043&#39;, &#39;IBEIS_PZ_0044&#39;, &#39;IBEIS_PZ_0045&#39;, &#39;IBEIS_PZ_0046&#39;],</span>
<span class="sd">            [&#39;IBEIS_PZ_0044&#39;, &#39;IBEIS_PZ_0046&#39;, &#39;IBEIS_PZ_0047&#39;, &#39;IBEIS_PZ_0049&#39;, &#39;IBEIS_PZ_0050&#39;],</span>
<span class="sd">            [&#39;IBEIS_PZ_0042&#39;, &#39;IBEIS_PZ_0043&#39;, &#39;IBEIS_PZ_0044&#39;, &#39;IBEIS_PZ_0045&#39;, &#39;IBEIS_PZ_0046&#39;],</span>
<span class="sd">        )</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># HACK TO FORCE TIMESTAMPS FOR NEW NAMES</span>
    <span class="c">#str_format = 1</span>
    <span class="k">if</span> <span class="n">species_text</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># TODO: optionally specify qreq_ or qparams?</span>
        <span class="n">species_text</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">detect_cfg</span><span class="o">.</span><span class="n">species_text</span>
    <span class="k">if</span> <span class="n">location_text</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">location_text</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">location_for_names</span>
    <span class="k">if</span> <span class="n">num</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">num_</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_</span> <span class="o">=</span> <span class="n">num</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_known_name_rowids</span><span class="p">()</span>
    <span class="n">names_used_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">nid_list</span><span class="p">))</span>
    <span class="n">base_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">next_name_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_name_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_</span><span class="p">:</span>
        <span class="n">base_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">str_format</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">userid</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_user_name</span><span class="p">()</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">(</span><span class="s">&#39;tag&#39;</span><span class="p">)</span>
            <span class="c">#timestamp_suffix = &#39;_TMP_&#39;</span>
            <span class="n">timestamp_suffix</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span>
            <span class="n">timestamp_prefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">name_prefix</span> <span class="o">=</span> <span class="n">timestamp_prefix</span> <span class="o">+</span> <span class="n">timestamp</span> <span class="o">+</span> <span class="n">timestamp_suffix</span> <span class="o">+</span> <span class="n">userid</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span>
        <span class="k">elif</span> <span class="n">str_format</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">species_rowid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_rowids_from_text</span><span class="p">(</span><span class="n">species_text</span><span class="p">)</span>
            <span class="n">species_code</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_codes</span><span class="p">(</span><span class="n">species_rowid</span><span class="p">)</span>
            <span class="n">name_prefix</span> <span class="o">=</span> <span class="n">location_text</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">species_code</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Invalid str_format supplied&#39;</span><span class="p">)</span>
        <span class="n">next_name</span> <span class="o">=</span> <span class="n">name_prefix</span> <span class="o">+</span> <span class="s">&#39;</span><span class="si">%04d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">base_index</span>
        <span class="k">if</span> <span class="n">next_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names_used_list</span><span class="p">:</span>
            <span class="c">#names_used_list.add(next_name)</span>
            <span class="n">next_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_name</span><span class="p">)</span>
    <span class="c"># Return a list or a string</span>
    <span class="k">if</span> <span class="n">num</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">next_name_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">next_name_list</span>

</div>
<div class="viewcode-block" id="draw_thumb_helper"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.draw_thumb_helper">[docs]</a><span class="k">def</span> <span class="nf">draw_thumb_helper</span><span class="p">(</span><span class="n">tup</span><span class="p">):</span>
    <span class="n">thumb_path</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">,</span> <span class="n">gpath</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span> <span class="o">=</span> <span class="n">tup</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">gpath</span><span class="p">)</span>  <span class="c"># time consuming</span>
    <span class="p">(</span><span class="n">gh</span><span class="p">,</span> <span class="n">gw</span><span class="p">)</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">img_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">gw</span><span class="p">,</span> <span class="n">gh</span><span class="p">)</span>
    <span class="n">max_dsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">thumbsize</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">)</span>
    <span class="n">dsize</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">resized_clamped_thumb_dims</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">max_dsize</span><span class="p">)</span>
    <span class="n">new_verts_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">scaled_verts_from_bbox_gen</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">))</span>
    <span class="c">#thumb = vt.resize_thumb(img, max_dsize)</span>
    <span class="c"># -----------------</span>
    <span class="c"># Actual computation</span>
    <span class="n">thumb</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dsize</span><span class="p">)</span>
    <span class="n">orange_bgr</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">new_verts</span> <span class="ow">in</span> <span class="n">new_verts_list</span><span class="p">:</span>
        <span class="n">thumb</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">draw_verts</span><span class="p">(</span><span class="n">thumb</span><span class="p">,</span> <span class="n">new_verts</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">orange_bgr</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">,</span> <span class="n">thumb</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#return (thumb_path, thumb)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="preprocess_image_thumbs"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.preprocess_image_thumbs">[docs]</a><span class="k">def</span> <span class="nf">preprocess_image_thumbs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                            <span class="n">draw_annots</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">thumbsize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes thumbs of images in parallel based on kwargs</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        gid_list (list): (default = None)</span>
<span class="sd">        use_cache (bool):  turns on disk based caching(default = True)</span>
<span class="sd">        chunksize (int): (default = 8)</span>
<span class="sd">        draw_annots (bool): (default = True)</span>
<span class="sd">        thumbsize (None): (default = None)</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: thumbpath_list</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-preprocess_image_thumbs --db GZ_Master1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; gid_list = None</span>
<span class="sd">        &gt;&gt;&gt; use_cache = True</span>
<span class="sd">        &gt;&gt;&gt; chunksize = 8</span>
<span class="sd">        &gt;&gt;&gt; draw_annots = True</span>
<span class="sd">        &gt;&gt;&gt; thumbsize = None</span>
<span class="sd">        &gt;&gt;&gt; thumbpath_list = preprocess_image_thumbs(ibs, gid_list, use_cache, chunksize, draw_annots, thumbsize)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;thumbpath_list = %s&#39; % (str(thumbpath_list),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">thumbsize</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_thumbsize</span><span class="p">(</span><span class="n">thumbsize</span><span class="p">,</span> <span class="n">draw_annots</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] preprocess_image_thumbs(use_cache=</span><span class="si">%r</span><span class="s">, thumbsize=</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">use_cache</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">))</span>
    <span class="n">thumbpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_thumbpath_</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span>
                                              <span class="n">draw_annots</span><span class="o">=</span><span class="n">draw_annots</span><span class="p">,</span>
                                              <span class="n">thumbsize</span><span class="o">=</span><span class="n">thumbsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
        <span class="c"># Filter out paths gids that already have existing thumb paths</span>
        <span class="n">exists_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">exists</span><span class="p">,</span> <span class="n">thumbpath_list</span><span class="p">))</span>
        <span class="n">gid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">exists_list</span><span class="p">)</span>
        <span class="n">thumbpath_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">thumbpath_list</span><span class="p">,</span> <span class="n">exists_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gid_list_</span> <span class="o">=</span> <span class="n">gid_list</span>
        <span class="n">thumbpath_list_</span> <span class="o">=</span> <span class="n">thumbpath_list</span>

    <span class="n">compute_image_thumbs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list_</span><span class="p">,</span> <span class="n">thumbpath_list_</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">,</span> <span class="n">draw_annots</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thumbpath_list</span>

</div>
<div class="viewcode-block" id="compute_image_thumbs"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_image_thumbs">[docs]</a><span class="k">def</span> <span class="nf">compute_image_thumbs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list_</span><span class="p">,</span> <span class="n">thumbpath_list_</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">,</span> <span class="n">draw_annots</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parallel work function. Computes image thumbnails. Overwrites anything that exists.</span>
<span class="sd">    Does not use any caching</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">draw_annots</span><span class="p">:</span>
        <span class="n">bboxes_list</span> <span class="o">=</span> <span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
        <span class="n">thetas_list</span> <span class="o">=</span> <span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bboxes_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list</span> <span class="p">]</span>
        <span class="n">thetas_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list</span> <span class="p">]</span>
    <span class="n">args_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">thumb_path</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">,</span> <span class="n">gpath</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">thumb_path</span><span class="p">,</span> <span class="n">gpath</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span> <span class="ow">in</span>
                 <span class="nb">zip</span><span class="p">(</span><span class="n">thumbpath_list_</span><span class="p">,</span> <span class="n">gpath_list</span><span class="p">,</span> <span class="n">bboxes_list</span><span class="p">,</span> <span class="n">thetas_list</span><span class="p">)]</span>

    <span class="c"># Execute all tasks in parallel</span>
    <span class="n">genkw</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;ordered&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&#39;chunksize&#39;</span><span class="p">:</span> <span class="n">chunksize</span><span class="p">,</span>
        <span class="s">&#39;freq&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="c">#&#39;adjust&#39;: True,</span>
        <span class="c">#&#39;force_serial&#39;: True,</span>
    <span class="p">}</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">draw_thumb_helper</span><span class="p">,</span> <span class="n">args_list</span><span class="p">,</span> <span class="n">nTasks</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">args_list</span><span class="p">),</span> <span class="o">**</span><span class="n">genkw</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">evaluate_generator</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="group_annots_by_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.group_annots_by_name">[docs]</a><span class="k">def</span> <span class="nf">group_annots_by_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    This function is probably the fastest of its siblings</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (list):</span>
<span class="sd">        distinguish_unknowns (bool):</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: grouped_aids_, unique_nids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-group_annots_by_name</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; distinguish_unknowns = True</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; grouped_aids_, unique_nids = group_annots_by_name(ibs, aid_list, distinguish_unknowns)</span>
<span class="sd">        &gt;&gt;&gt; result = str([aids.tolist() for aids in grouped_aids_])</span>
<span class="sd">        &gt;&gt;&gt; result += &#39;\n&#39; + str(unique_nids.tolist())</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [[11], [9], [4], [1], [2, 3], [5, 6], [7], [8], [10], [12], [13]]</span>
<span class="sd">        [-11, -9, -4, -1, 1, 2, 3, 4, 5, 6, 7]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span>
            <span class="n">aid_list</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="n">distinguish_unknowns</span><span class="p">))</span>
    <span class="n">unique_nids</span><span class="p">,</span> <span class="n">groupxs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">grouped_aids_</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="n">groupxs_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">grouped_aids_</span><span class="p">,</span> <span class="n">unique_nids</span>

</div>
<div class="viewcode-block" id="group_annots_by_known_names_nochecks"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.group_annots_by_known_names_nochecks">[docs]</a><span class="k">def</span> <span class="nf">group_annots_by_known_names_nochecks</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">nid2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">nid2_aids</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="group_annots_by_known_names"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.group_annots_by_known_names">[docs]</a><span class="k">def</span> <span class="nf">group_annots_by_known_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">checks</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    FIXME; rectify this</span>
<span class="sd">    #&gt;&gt;&gt; import ibeis  # NOQA</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-group_annots_by_known_names</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(db=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13]</span>
<span class="sd">        &gt;&gt;&gt; known_aids_list, unknown_aids = group_annots_by_known_names(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; result = str(known_aids_list) + &#39;\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; result += str(unknown_aids)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [[2, 3], [5, 6], [7], [8], [10], [12], [13]]</span>
<span class="sd">        [11, 9, 4, 1]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">nid2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">aid_gen</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">)</span>
    <span class="n">isunknown_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">))</span>
    <span class="n">known_aids_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ifilterfalse_items</span><span class="p">(</span><span class="n">aid_gen</span><span class="p">(),</span> <span class="n">isunknown_list</span><span class="p">))</span>
    <span class="n">unknown_aids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iflatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iter_compress</span><span class="p">(</span><span class="n">aid_gen</span><span class="p">(),</span> <span class="n">isunknown_list</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
        <span class="c"># References:</span>
        <span class="c">#     http://stackoverflow.com/questions/482014/how-would-you-do-the-equivalent-of-preprocessor-directives-in-python</span>
        <span class="n">nidgroup_list</span> <span class="o">=</span> <span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">,</span> <span class="n">known_aids_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nidgroup</span> <span class="ow">in</span> <span class="n">nidgroup_list</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">nidgroup</span><span class="p">),</span> <span class="s">&#39;bad name grouping&#39;</span>
    <span class="k">return</span> <span class="n">known_aids_list</span><span class="p">,</span> <span class="n">unknown_aids</span>

</div>
<div class="viewcode-block" id="get_primary_species_viewpoint"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_primary_species_viewpoint">[docs]</a><span class="k">def</span> <span class="nf">get_primary_species_viewpoint</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">plus</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        species (?):</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: primary_viewpoint</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_primary_species_viewpoint</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; species = ibeis.const.TEST_SPECIES.ZEB_PLAIN</span>
<span class="sd">        &gt;&gt;&gt; aid_subset = get_primary_species_viewpoint(species, 0)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;aid_subset = %s&#39; % (str(aid_subset),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        aid_subset = left</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">species</span> <span class="o">==</span> <span class="s">&#39;zebra_plains&#39;</span><span class="p">:</span>
        <span class="n">primary_viewpoint</span> <span class="o">=</span> <span class="s">&#39;left&#39;</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="o">==</span> <span class="s">&#39;zebra_grevys&#39;</span><span class="p">:</span>
        <span class="n">primary_viewpoint</span> <span class="o">=</span> <span class="s">&#39;right&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">primary_viewpoint</span> <span class="o">=</span> <span class="s">&#39;left&#39;</span>
    <span class="k">if</span> <span class="n">plus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c"># return an augmented primary viewpoint</span>
        <span class="n">primary_viewpoint</span> <span class="o">=</span> <span class="n">get_extended_viewpoints</span><span class="p">(</span><span class="n">primary_viewpoint</span><span class="p">,</span> <span class="n">num1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">num2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">include_base</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">primary_viewpoint</span>

</div>
<div class="viewcode-block" id="get_extended_viewpoints"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_extended_viewpoints">[docs]</a><span class="k">def</span> <span class="nf">get_extended_viewpoints</span><span class="p">(</span><span class="n">base_yaw_text</span><span class="p">,</span> <span class="n">towards</span><span class="o">=</span><span class="s">&#39;front&#39;</span><span class="p">,</span> <span class="n">num1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">num2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">include_base</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a viewpoint returns the acceptable viewpoints around it</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; yaw_text_list = [&#39;left&#39;, &#39;right&#39;, &#39;back&#39;, &#39;front&#39;]</span>
<span class="sd">        &gt;&gt;&gt; towards = &#39;front&#39;</span>
<span class="sd">        &gt;&gt;&gt; num1 = 1</span>
<span class="sd">        &gt;&gt;&gt; num2 = 0</span>
<span class="sd">        &gt;&gt;&gt; include_base = False</span>
<span class="sd">        &gt;&gt;&gt; extended_yaws_list = [get_extended_viewpoints(base_yaw_text, towards, num1, num2, include_base)</span>
<span class="sd">        &gt;&gt;&gt;                       for base_yaw_text in yaw_text_list]</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;extended_yaws_list = %s&#39; % (ut.list_str(extended_yaws_list),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
    <span class="n">ori1</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">VIEWTEXT_TO_YAW_RADIANS</span><span class="p">[</span><span class="n">base_yaw_text</span><span class="p">]</span>
    <span class="n">ori2</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">VIEWTEXT_TO_YAW_RADIANS</span><span class="p">[</span><span class="n">towards</span><span class="p">]</span>
    <span class="c"># Find which direction to go to get closer to `towards`</span>
    <span class="n">yawdist</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">signed_ori_distance</span><span class="p">(</span><span class="n">ori1</span><span class="p">,</span> <span class="n">ori2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">yawdist</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c"># break ties</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;warning extending viewpoint yaws from the same position as towards&#39;</span><span class="p">)</span>
        <span class="n">yawdist</span> <span class="o">+=</span> <span class="mf">1E-3</span>
    <span class="k">if</span> <span class="n">num1</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">num1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">num2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">num2</span> <span class="o">=</span> <span class="n">num1</span>
    <span class="k">assert</span> <span class="n">num1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;must specify positive num&#39;</span>
    <span class="k">assert</span> <span class="n">num2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;must specify positive num&#39;</span>
    <span class="n">yawtext_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">VIEWTEXT_TO_YAW_RADIANS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">yawtext_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">base_yaw_text</span><span class="p">)</span>
    <span class="n">other_index_list1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">((</span><span class="n">index</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">yawdist</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">))</span> <span class="o">%</span>
                             <span class="nb">len</span><span class="p">(</span><span class="n">yawtext_list</span><span class="p">))</span>
                         <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="n">other_index_list2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">((</span><span class="n">index</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">yawdist</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">))</span> <span class="o">%</span>
                             <span class="nb">len</span><span class="p">(</span><span class="n">yawtext_list</span><span class="p">))</span>
                         <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">include_base</span><span class="p">:</span>
        <span class="n">extended_index_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">other_index_list1</span> <span class="o">+</span> <span class="n">other_index_list2</span> <span class="o">+</span> <span class="p">[</span><span class="n">index</span><span class="p">])))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">extended_index_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">other_index_list1</span> <span class="o">+</span> <span class="n">other_index_list2</span><span class="p">)))</span>
    <span class="n">extended_yaws</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">yawtext_list</span><span class="p">,</span> <span class="n">extended_index_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">extended_yaws</span>

</div>
<div class="viewcode-block" id="get_two_annots_per_name_and_singletons"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_two_annots_per_name_and_singletons">[docs]</a><span class="k">def</span> <span class="nf">get_two_annots_per_name_and_singletons</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">onlygt</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    makes controlled subset of data</span>

<span class="sd">    DEPRICATE</span>

<span class="sd">    CONTROLLED TEST DATA</span>

<span class="sd">    Build data for experiment that tries to rule out</span>
<span class="sd">    as much bad data as possible</span>


<span class="sd">    Returns a controlled set of annotations that conforms to</span>
<span class="sd">      * number of annots per name</span>
<span class="sd">      * uniform species</span>
<span class="sd">      * viewpoint restrictions</span>
<span class="sd">      * quality restrictions</span>
<span class="sd">      * time delta restrictions</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_two_annots_per_name_and_singletons</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_two_annots_per_name_and_singletons --db GZ_ALL</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_two_annots_per_name_and_singletons --db PZ_Master0 --onlygt</span>

<span class="sd">    Ignore:</span>
<span class="sd">        sys.argv.extend([&#39;--db&#39;, &#39;PZ_MTEST&#39;])</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;PZ_Master0&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_subset = get_two_annots_per_name_and_singletons(ibs, onlygt=ut.get_argflag(&#39;--onlygt&#39;))</span>
<span class="sd">        &gt;&gt;&gt; ibeis.other.dbinfo.get_dbinfo(ibs, aid_list=aid_subset, with_contrib=False)</span>
<span class="sd">        &gt;&gt;&gt; result = str(aid_subset)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">species</span> <span class="o">=</span> <span class="n">get_primary_database_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">())</span>
    <span class="c">#aid_list = ibs.get_valid_aids(species=&#39;zebra_plains&#39;, is_known=True)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span> <span class="n">is_known</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># FILTER OUT UNUSABLE ANNOTATIONS</span>
    <span class="c"># Get annots with timestamps</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">filter_aids_without_timestamps</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
    <span class="n">minqual</span> <span class="o">=</span> <span class="s">&#39;ok&#39;</span>
    <span class="c">#valid_yaws = {&#39;left&#39;, &#39;frontleft&#39;, &#39;backleft&#39;}</span>
    <span class="k">if</span> <span class="n">species</span> <span class="o">==</span> <span class="s">&#39;zebra_plains&#39;</span><span class="p">:</span>
        <span class="n">valid_yawtexts</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;left&#39;</span><span class="p">,</span> <span class="s">&#39;frontleft&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="o">==</span> <span class="s">&#39;zebra_grevys&#39;</span><span class="p">:</span>
        <span class="n">valid_yawtexts</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;right&#39;</span><span class="p">,</span> <span class="s">&#39;frontright&#39;</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">valid_yawtexts</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;left&#39;</span><span class="p">,</span> <span class="s">&#39;frontleft&#39;</span><span class="p">}</span>
    <span class="n">flags_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_quality_viewpoint_filterflags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">minqual</span><span class="p">,</span> <span class="n">valid_yawtexts</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">)</span>
    <span class="c">#print(&#39;print subset info&#39;)</span>
    <span class="c">#print(ut.dict_hist(ibs.get_annot_yaw_texts(aid_list)))</span>
    <span class="c">#print(ut.dict_hist(ibs.get_annot_quality_texts(aid_list)))</span>
    <span class="n">singletons</span><span class="p">,</span> <span class="n">multitons</span> <span class="o">=</span> <span class="n">partition_annots_into_singleton_multiton</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
    <span class="c"># process multitons</span>
    <span class="n">hourdists_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annots_hourdists_list</span><span class="p">(</span><span class="n">multitons</span><span class="p">)</span>
    <span class="c">#pairxs_list = [vt.pdist_argsort(x) for x in hourdists_list]</span>
    <span class="c"># Get the pictures taken the furthest appart of each gt case</span>
    <span class="n">best_pairx_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">vt</span><span class="o">.</span><span class="n">pdist_argsort</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hourdists_list</span><span class="p">]</span>

    <span class="n">best_multitons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">multitons</span><span class="p">,</span> <span class="n">best_pairx_list</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">onlygt</span><span class="p">:</span>
        <span class="n">aid_subset</span> <span class="o">=</span> <span class="n">best_multitons</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aid_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">best_multitons</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">singletons</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
    <span class="n">aid_subset</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">aid_subset</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_num_annots_per_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_num_annots_per_name">[docs]</a><span class="k">def</span> <span class="nf">get_num_annots_per_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the number of annots per name (IN THIS LIST)</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_num_annots_per_name</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_num_annots_per_name --db PZ_Master1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # UNSTABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids(is_known=True)</span>
<span class="sd">        &gt;&gt;&gt; num_annots_per_name, unique_nids = get_num_annots_per_name(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; per_name_hist = ut.dict_hist(num_annots_per_name)</span>
<span class="sd">        &gt;&gt;&gt; items = per_name_hist.items()</span>
<span class="sd">        &gt;&gt;&gt; items = sorted(items)[::-1]</span>
<span class="sd">        &gt;&gt;&gt; key_list = ut.get_list_column(items, 0)</span>
<span class="sd">        &gt;&gt;&gt; val_list = ut.get_list_column(items, 1)</span>
<span class="sd">        &gt;&gt;&gt; min_per_name = dict(zip(key_list, np.cumsum(val_list)))</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;per_name_hist = %s&#39; % (ut.dict_str(per_name_hist),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;min_per_name = %s&#39; % (ut.dict_str(min_per_name),))</span>
<span class="sd">        per_name_hist = {</span>
<span class="sd">            1: 5,</span>
<span class="sd">            2: 2,</span>
<span class="sd">        }</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aids_list</span><span class="p">,</span> <span class="n">unique_nids</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">num_annots_per_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">num_annots_per_name</span><span class="p">,</span> <span class="n">unique_nids</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annots_per_name_stats"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annots_per_name_stats">[docs]</a><span class="k">def</span> <span class="nf">get_annots_per_name_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">stats_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">use_nan</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">stats_kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_num_annots_per_name</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">stats_kw</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_aids_with_groundtruth"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_aids_with_groundtruth">[docs]</a><span class="k">def</span> <span class="nf">get_aids_with_groundtruth</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns aids with valid groundtruth &quot;&quot;&quot;</span>
    <span class="n">valid_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">has_gt_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_has_groundtruth</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">)</span>
    <span class="n">hasgt_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">,</span> <span class="n">has_gt_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hasgt_aids</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_dbnotes_fpath"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_dbnotes_fpath">[docs]</a><span class="k">def</span> <span class="nf">get_dbnotes_fpath</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">notes_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_ibsdir</span><span class="p">(),</span> <span class="s">&#39;dbnotes.txt&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ensure</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbnotes_fpath</span><span class="p">()):</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_dbnotes</span><span class="p">(</span><span class="s">&#39;None&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">notes_fpath</span>

</div>
<span class="nd">@profile</span>
<div class="viewcode-block" id="get_yaw_viewtexts"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_yaw_viewtexts">[docs]</a><span class="k">def</span> <span class="nf">get_yaw_viewtexts</span><span class="p">(</span><span class="n">yaw_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        yaw_list (list of angles):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_yaw_viewtexts</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; yaw_list = [0.0, np.pi / 2, np.pi / 4, np.pi, 3.15, -.4, -8, .2, 4, 7, 20, None]</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; text_list = get_yaw_viewtexts(yaw_list)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.list_str(text_list, nl=False)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [&#39;right&#39;, &#39;front&#39;, &#39;frontright&#39;, &#39;left&#39;, &#39;left&#39;, &#39;backright&#39;, &#39;back&#39;, &#39;right&#39;, &#39;backleft&#39;, &#39;frontright&#39;, &#39;frontright&#39;, None]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#import vtool as vt</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">six</span>
    <span class="n">stdlblyaw_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">VIEWTEXT_TO_YAW_RADIANS</span><span class="p">))</span>
    <span class="n">stdlbl_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">stdlblyaw_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ALTERNATE</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">ALTERNATE</span><span class="p">:</span>
        <span class="c">#with ut.Timer(&#39;fdsa&#39;):</span>
        <span class="n">TAU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">binsize</span> <span class="o">=</span> <span class="n">TAU</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">VIEWTEXT_TO_YAW_RADIANS</span><span class="p">)</span>
        <span class="n">yaw_list_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">yaw</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">yaw</span> <span class="k">for</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="n">yaw_list</span><span class="p">])</span>
        <span class="n">index_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span> <span class="o">+</span> <span class="p">(</span><span class="n">yaw_list_</span> <span class="o">%</span> <span class="n">TAU</span><span class="p">)</span> <span class="o">/</span> <span class="n">binsize</span><span class="p">)</span>
        <span class="n">text_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">else</span> <span class="n">stdlbl_list</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">index_list</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c">#with ut.Timer(&#39;fdsa&#39;):</span>
        <span class="n">stdyaw_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">stdlblyaw_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">textdists_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">yaw</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span>
                          <span class="n">vt</span><span class="o">.</span><span class="n">ori_distance</span><span class="p">(</span><span class="n">stdyaw_list</span><span class="p">,</span> <span class="n">yaw</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="n">yaw_list</span><span class="p">]</span>
        <span class="n">index_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">dists</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">dists</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
                      <span class="k">for</span> <span class="n">dists</span> <span class="ow">in</span> <span class="n">textdists_list</span><span class="p">]</span>
        <span class="n">text_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">stdlbl_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">index_list</span><span class="p">]</span>
        <span class="c">#yaw_list_ / binsize</span>
    <span class="c">#errors = [&#39;%.2f&#39; % dists[index] for dists, index in zip(textdists_list, index_list)]</span>
    <span class="c">#return list(zip(yaw_list, errors, text_list))</span>
    <span class="k">return</span> <span class="n">text_list</span>

</div>
<div class="viewcode-block" id="get_species_dbs"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_species_dbs">[docs]</a><span class="k">def</span> <span class="nf">get_species_dbs</span><span class="p">(</span><span class="n">species_prefix</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.init</span> <span class="kn">import</span> <span class="n">sysres</span>
    <span class="n">ibs_dblist</span> <span class="o">=</span> <span class="n">sysres</span><span class="o">.</span><span class="n">get_ibsdb_list</span><span class="p">()</span>
    <span class="n">isvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">species_prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">ibs_dblist</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">ibs_dblist</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_bbox_area"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_bbox_area">[docs]</a><span class="k">def</span> <span class="nf">get_annot_bbox_area</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">bbox_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">area_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="n">bbox_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">area_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_match_text"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_match_text">[docs]</a><span class="k">def</span> <span class="nf">get_match_text</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">):</span>
    <span class="n">truth</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_match_truth</span><span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">TRUTH_INT_TO_TEXT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">truth</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_database_species"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_database_species">[docs]</a><span class="k">def</span> <span class="nf">get_database_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_database_species</span>

<span class="sd">    Example1:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.list_str(ibs.get_database_species(), nl=False)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [&#39;____&#39;, &#39;bear_polar&#39;, &#39;zebra_grevys&#39;, &#39;zebra_plains&#39;]</span>

<span class="sd">    Example2:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.list_str(ibs.get_database_species(), nl=False)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [&#39;zebra_plains&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">unique_species</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">species_list</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">unique_species</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_primary_database_species"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_primary_database_species">[docs]</a><span class="k">def</span> <span class="nf">get_primary_database_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        aid_list (list):  list of annotation ids (default = None)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_primary_database_species</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = None</span>
<span class="sd">        &gt;&gt;&gt; primary_species = get_primary_database_species(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; result = primary_species</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;primary_species = %r&#39; % (primary_species,))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        zebra_plains</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SPEED_HACK</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">SPEED_HACK</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;PZ_MTEST&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;zebra_plains&#39;</span>
        <span class="k">elif</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;PZ_Master0&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;zebra_plains&#39;</span>
        <span class="k">elif</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;NNP_Master&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;zebra_plains&#39;</span>
        <span class="k">elif</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;GZ_ALL&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;zebra_grevys&#39;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">species_hist</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">species_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_hist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">primary_species</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frequent_species</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">species_hist</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">primary_species</span> <span class="o">=</span> <span class="n">frequent_species</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">primary_species</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_dominant_species"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_dominant_species">[docs]</a><span class="k">def</span> <span class="nf">get_dominant_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_dominant_species</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; result = get_dominant_species(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        zebra_plains</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hist_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">hist_</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">hist_</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="n">species_text</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">list_argmax</span><span class="p">(</span><span class="n">vals</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">species_text</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_database_species_count"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_database_species_count">[docs]</a><span class="k">def</span> <span class="nf">get_database_species_count</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_database_species_count</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; #print(ut.dict_str(ibeis.opendb(&#39;PZ_Master0&#39;).get_database_species_count()))</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.dict_str(ibs.get_database_species_count(), nl=False)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        {&#39;____&#39;: 3, &#39;bear_polar&#39;: 2, &#39;zebra_grevys&#39;: 2, &#39;zebra_plains&#39;: 6}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">species_count_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">item_hist</span><span class="p">(</span><span class="n">species_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">species_count_dict</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_match_truth"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_match_truth">[docs]</a><span class="k">def</span> <span class="nf">get_match_truth</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">):</span>
    <span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">((</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">))</span>
    <span class="n">isunknown_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">((</span><span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">isunknown_list</span><span class="p">):</span>
        <span class="n">truth</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c"># Unknown</span>
    <span class="k">elif</span> <span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span><span class="p">:</span>
        <span class="n">truth</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c"># True</span>
    <span class="k">elif</span> <span class="n">nid1</span> <span class="o">!=</span> <span class="n">nid2</span><span class="p">:</span>
        <span class="n">truth</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c"># False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;invalid_unknown_truth_state&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">truth</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_aidpair_truths"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_aidpair_truths">[docs]</a><span class="k">def</span> <span class="nf">get_aidpair_truths</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1_list</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Uses NIDS to verify truth</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid1_list (list):</span>
<span class="sd">        aid2_list (list):</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[bool]: truth</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_aidpair_truths</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid1_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; aid2_list = ut.list_roll(ibs.get_valid_aids(), -1)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; truth = get_aidpair_truths(ibs, aid1_list, aid2_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = str(truth)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nid1_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid1_list</span><span class="p">))</span>
    <span class="n">nid2_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid2_list</span><span class="p">))</span>
    <span class="n">isunknown1_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">nid1_list</span><span class="p">))</span>
    <span class="n">isunknown2_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">nid2_list</span><span class="p">))</span>
    <span class="n">any_unknown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">isunknown1_list</span><span class="p">,</span> <span class="n">isunknown2_list</span><span class="p">)</span>
    <span class="n">truth_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">nid1_list</span> <span class="o">==</span> <span class="n">nid2_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">truth_list</span><span class="p">[</span><span class="n">any_unknown</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">TRUTH_UNKNOWN</span>
    <span class="k">return</span> <span class="n">truth_list</span>

</div>
<div class="viewcode-block" id="get_title"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_title">[docs]</a><span class="k">def</span> <span class="nf">get_title</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;IBEIS - No Database Directory Open&#39;</span>
    <span class="k">elif</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbdir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;IBEIS - !! INVALID DATABASE !!&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dbdir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbdir</span><span class="p">()</span>
        <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;IBEIS - </span><span class="si">%r</span><span class="s"> - Database Directory = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">)</span>
        <span class="n">wb_target</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_wildbook_target</span><span class="p">()</span>
        <span class="c">#params.args.wildbook_target</span>
        <span class="k">if</span> <span class="n">wb_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> - Wildbook Target = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">wb_target</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">title</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_dbinfo_str"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_dbinfo_str">[docs]</a><span class="k">def</span> <span class="nf">get_dbinfo_str</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.other</span> <span class="kn">import</span> <span class="n">dbinfo</span>
    <span class="k">return</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">get_dbinfo</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="s">&#39;info_str&#39;</span><span class="p">]</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_infostr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_infostr">[docs]</a><span class="k">def</span> <span class="nf">get_infostr</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns sort printable database information</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: infostr</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.other</span> <span class="kn">import</span> <span class="n">dbinfo</span>
    <span class="k">return</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">get_short_infostr</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_dbnotes"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_dbnotes">[docs]</a><span class="k">def</span> <span class="nf">get_dbnotes</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; sets notes for an entire database &quot;&quot;&quot;</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">read_from</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbnotes_fpath</span><span class="p">(),</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">notes</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_dbnotes</span><span class="p">(</span><span class="s">&#39;None&#39;</span><span class="p">)</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">read_from</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbnotes_fpath</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">notes</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="set_dbnotes"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_dbnotes">[docs]</a><span class="k">def</span> <span class="nf">set_dbnotes</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">notes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; sets notes for an entire database &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">ibeis</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">IBEISControl</span><span class="o">.</span><span class="n">IBEISController</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbnotes_fpath</span><span class="p">(),</span> <span class="n">notes</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="annotstr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.annotstr">[docs]</a><span class="k">def</span> <span class="nf">annotstr</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;aid=</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">aid</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="redownload_detection_models"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.redownload_detection_models">[docs]</a><span class="k">def</span> <span class="nf">redownload_detection_models</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -c &quot;from ibeis.algo.detect import grabmodels; grabmodels.redownload_models()&quot;</span>
<span class="sd">        python -c &quot;import utool, ibeis.algo; utool.view_directory(ibeis.algo.detect.grabmodels._expand_modeldir())&quot;</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = redownload_detection_models(ibs)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] redownload_detection_models&#39;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">ibeis.algo.detect</span> <span class="kn">import</span> <span class="n">grabmodels</span>
    <span class="n">modeldir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_detect_modeldir</span><span class="p">()</span>
    <span class="n">grabmodels</span><span class="o">.</span><span class="n">redownload_models</span><span class="p">(</span><span class="n">modeldir</span><span class="o">=</span><span class="n">modeldir</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="view_model_dir"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.view_model_dir">[docs]</a><span class="k">def</span> <span class="nf">view_model_dir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] redownload_detection_models&#39;</span><span class="p">)</span>
    <span class="n">modeldir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_detect_modeldir</span><span class="p">()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">view_directory</span><span class="p">(</span><span class="n">modeldir</span><span class="p">)</span>
    <span class="c">#grabmodels.redownload_models(modeldir=modeldir)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="merge_names"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.merge_names">[docs]</a><span class="k">def</span> <span class="nf">merge_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">merge_name</span><span class="p">,</span> <span class="n">other_names</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        merge_name (str):</span>
<span class="sd">        other_names (list):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-merge_names</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; merge_name = &#39;zebra&#39;</span>
<span class="sd">        &gt;&gt;&gt; other_names = [&#39;occl&#39;, &#39;jeff&#39;]</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = merge_names(ibs, merge_name, other_names)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        &gt;&gt;&gt; ibs.print_names_table()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] merging other_names=</span><span class="si">%r</span><span class="s"> into merge_name=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">other_names</span><span class="p">,</span> <span class="n">merge_name</span><span class="p">))</span>
    <span class="n">other_nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_rowids_from_text</span><span class="p">(</span><span class="n">other_names</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_name_alias_texts</span><span class="p">(</span><span class="n">other_nid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">merge_name</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_nid_list</span><span class="p">))</span>
    <span class="n">other_aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">other_nid_list</span><span class="p">)</span>
    <span class="n">other_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">other_aids_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] ... </span><span class="si">%r</span><span class="s"> annotations are being merged into merge_name=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other_aids</span><span class="p">),</span> <span class="n">merge_name</span><span class="p">))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_names</span><span class="p">(</span><span class="n">other_aids</span><span class="p">,</span> <span class="p">[</span><span class="n">merge_name</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_aids</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="inspect_nonzero_yaws"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.inspect_nonzero_yaws">[docs]</a><span class="k">def</span> <span class="nf">inspect_nonzero_yaws</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    python dev.py --dbdir /raid/work2/Turk/PZ_Master --cmd --show</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.viz</span> <span class="kn">import</span> <span class="n">viz_chip</span>
    <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
    <span class="n">aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">yaws</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaws</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
    <span class="n">isnone_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">yaw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="n">yaws</span><span class="p">]</span>
    <span class="n">aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">isnone_list</span><span class="p">)</span>
    <span class="n">yaws</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">yaws</span><span class="p">,</span> <span class="n">isnone_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">yaws</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">yaw</span><span class="p">)</span>
        <span class="c"># We seem to be storing FULL paths in</span>
        <span class="c"># the probchip table</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_annot_chips</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">viz_chip</span><span class="o">.</span><span class="n">show_chip</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">annote</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">show_if_requested</span><span class="p">()</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="set_exemplars_from_quality_and_viewpoint"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_exemplars_from_quality_and_viewpoint">[docs]</a><span class="k">def</span> <span class="nf">set_exemplars_from_quality_and_viewpoint</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                             <span class="n">exemplars_per_view</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">imgsetid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                             <span class="n">dry_run</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Automatic exemplar selection algorithm based on viewpoint and quality</span>

<span class="sd">    Ignore:</span>
<span class="sd">        # We want to choose the minimum per-item weight w such that</span>
<span class="sd">        # we can&#39;t pack more than N w&#39;s into the knapsack</span>
<span class="sd">        w * (N + 1) &gt; N</span>
<span class="sd">        # and w &lt; 1.0, so we can have wiggle room for preferences</span>
<span class="sd">        # so</span>
<span class="sd">        w * (N + 1) &gt; N</span>
<span class="sd">        w &gt; N / (N + 1)</span>
<span class="sd">        EPS = 1E-9</span>
<span class="sd">        w = N / (N + 1) + EPS</span>

<span class="sd">        # Preference denomiantor should not make any choice of</span>
<span class="sd">        # feasible items infeasible, but give more weight to a few.</span>
<span class="sd">        # delta_w is the wiggle room we have, but we need to choose a number</span>
<span class="sd">        # much less than it.</span>
<span class="sd">        prefdenom = N ** 2</span>
<span class="sd">        maybe its just N + EPS?</span>
<span class="sd">        N ** 2 should work though. Figure out correct value later</span>
<span class="sd">        delta_w = (1 - w)</span>
<span class="sd">        prefdenom = delta_w / N</span>
<span class="sd">        N - (w * N)</span>

<span class="sd">        N = 3</span>
<span class="sd">        EPS = 1E-9</span>
<span class="sd">        w = N / (N + 1) + EPS</span>
<span class="sd">        pref_decimator = N ** 2</span>
<span class="sd">        num_teir1_levels = 3</span>
<span class="sd">        pref_teir1 = w / (num_teir1_levels * pref_decimator)</span>
<span class="sd">        pref_teir2 = pref_teir1 / pref_decimator</span>
<span class="sd">        pref_teir3 = pref_teir2 / pref_decimator</span>

<span class="sd">    References:</span>
<span class="sd">        # implement maximum diversity approximation instead</span>
<span class="sd">        http://www.csbio.unc.edu/mcmillan/pubs/ICDM07_Pan.pdf</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-set_exemplars_from_quality_and_viewpoint</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-set_exemplars_from_quality_and_viewpoint:1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; #ibs = ibeis.opendb(&#39;PZ_MUGU_19&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; dry_run = True</span>
<span class="sd">        &gt;&gt;&gt; verbose = False</span>
<span class="sd">        &gt;&gt;&gt; old_sum = sum(ibs.get_annot_exemplar_flags(ibs.get_valid_aids()))</span>
<span class="sd">        &gt;&gt;&gt; new_aid_list, new_flag_list = ibs.set_exemplars_from_quality_and_viewpoint(dry_run=dry_run)</span>
<span class="sd">        &gt;&gt;&gt; new_sum = sum(new_flag_list)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;old_sum = %r&#39; % (old_sum,))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;new_sum = %r&#39; % (new_sum,))</span>
<span class="sd">        &gt;&gt;&gt; zero_aid_list, zero_flag_list = ibs.set_exemplars_from_quality_and_viewpoint(exemplars_per_view=0, dry_run=dry_run)</span>
<span class="sd">        &gt;&gt;&gt; assert sum(zero_flag_list) == 0</span>
<span class="sd">        &gt;&gt;&gt; result = new_sum</span>

<span class="sd">    Example1:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; dry_run = True</span>
<span class="sd">        &gt;&gt;&gt; verbose = False</span>
<span class="sd">        &gt;&gt;&gt; old_sum = sum(ibs.get_annot_exemplar_flags(ibs.get_valid_aids()))</span>
<span class="sd">        &gt;&gt;&gt; new_aid_list, new_flag_list = ibs.set_exemplars_from_quality_and_viewpoint(dry_run=dry_run)</span>
<span class="sd">        &gt;&gt;&gt; assert len(new_aid_list) == len(new_flag_list)</span>
<span class="sd">        &gt;&gt;&gt; # 2 of the 11 annots are unknown and should not be exemplars</span>
<span class="sd">        &gt;&gt;&gt; ut.assert_eq(len(new_aid_list), 9)</span>

<span class="sd">    Example2:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb2&#39;)</span>
<span class="sd">        &gt;&gt;&gt; dry_run = True</span>
<span class="sd">        &gt;&gt;&gt; verbose = False</span>
<span class="sd">        &gt;&gt;&gt; imgsetid = None</span>
<span class="sd">        &gt;&gt;&gt; new_aid_list, new_flag_list = ibs.set_exemplars_from_quality_and_viewpoint(dry_run=dry_run)</span>
<span class="sd">        &gt;&gt;&gt; old_flag_list = ibs.get_annot_exemplar_flags(new_aid_list)</span>
<span class="sd">        &gt;&gt;&gt; new_exemplar_aids = ut.compress(new_aid_list, new_flag_list)</span>
<span class="sd">        &gt;&gt;&gt; new_exemplar_qualtexts = ibs.get_annot_quality_texts(new_exemplar_aids)</span>
<span class="sd">        &gt;&gt;&gt; assert &#39;junk&#39; not in new_exemplar_qualtexts, &#39;should not have junk exemplars&#39;</span>
<span class="sd">        &gt;&gt;&gt; assert &#39;poor&#39; not in new_exemplar_qualtexts, &#39;should not have poor exemplars&#39;</span>
<span class="sd">        &gt;&gt;&gt; #assert len(new_aid_list) == len(new_flag_list)</span>
<span class="sd">        &gt;&gt;&gt; # 2 of the 11 annots are unknown and should not be exemplars</span>
<span class="sd">        &gt;&gt;&gt; #ut.assert_eq(len(new_aid_list), 9)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">exemplars_per_view</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">exemplars_per_view</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">exemplars_per_view</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">)</span>
    <span class="n">HACK</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">enable_custom_filter</span>
    <span class="c">#True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HACK</span><span class="p">:</span>
        <span class="n">new_aid_list</span><span class="p">,</span> <span class="n">new_flag_list</span> <span class="o">=</span> <span class="n">get_annot_quality_viewpoint_subset</span><span class="p">(</span>
            <span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">annots_per_view</span><span class="o">=</span><span class="n">exemplars_per_view</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># HACK</span>
        <span class="n">new_exemplar_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_prioritized_name_subset</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">exemplars_per_view</span><span class="p">)</span>
        <span class="n">new_nonexemplar_aids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_exemplar_aids</span><span class="p">))</span>
        <span class="n">new_aid_list</span> <span class="o">=</span> <span class="n">new_nonexemplar_aids</span> <span class="o">+</span> <span class="n">new_exemplar_aids</span>
        <span class="n">new_flag_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_nonexemplar_aids</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_exemplar_aids</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_exemplar_flags</span><span class="p">(</span><span class="n">new_aid_list</span><span class="p">,</span> <span class="n">new_flag_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_aid_list</span><span class="p">,</span> <span class="n">new_flag_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_prioritized_name_subset"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_prioritized_name_subset">[docs]</a><span class="k">def</span> <span class="nf">get_prioritized_name_subset</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">annots_per_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO: this needs to be integrated more cleanly with a nonhacky way of</span>
<span class="sd">    getting a subset of exemplars. Currently ther is duplicate code in guiback</span>
<span class="sd">    and here to use left side only when custom filter is on.</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_prioritized_name_subset</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb2&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; annots_per_name = 2</span>
<span class="sd">        &gt;&gt;&gt; aid_subset = get_prioritized_name_subset(ibs, aid_list, annots_per_name)</span>
<span class="sd">        &gt;&gt;&gt; qualtexts = ibs.get_annot_quality_texts(aid_subset)</span>
<span class="sd">        &gt;&gt;&gt; yawtexts = ibs.get_annot_yaw_texts(aid_subset)</span>
<span class="sd">        &gt;&gt;&gt; assert &#39;junk&#39; not in qualtexts</span>
<span class="sd">        &gt;&gt;&gt; assert &#39;right&#39; not in yawtexts</span>
<span class="sd">        &gt;&gt;&gt; result = len(aid_subset)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        28</span>

<span class="sd">    Exeample:</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb2&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ut.compress(aid_list, ibs.is_aid_unknown(aid_list))</span>
<span class="sd">        &gt;&gt;&gt; annots_per_name = 2</span>
<span class="sd">        &gt;&gt;&gt; aid_subset = get_prioritized_name_subset(ibs, aid_list, annots_per_name)</span>
<span class="sd">        &gt;&gt;&gt; qualtexts = ibs.get_annot_quality_texts(aid_list)</span>
<span class="sd">        &gt;&gt;&gt; yawtexts = ibs.get_annot_yaw_texts(aid_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">annots_per_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">annots_per_name</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">prioritized_subset_annots_per_name</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>

    <span class="c"># Paramaterize?</span>
    <span class="n">qualtext2_weight</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_EXCELLENT</span> <span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_GOOD</span>      <span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_OK</span>        <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_POOR</span>      <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_UNKNOWN</span>   <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_JUNK</span>      <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">yawtext2_weight</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;right&#39;</span>      <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">&#39;frontright&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">&#39;front&#39;</span>      <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">&#39;frontleft&#39;</span>  <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s">&#39;left&#39;</span>       <span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s">&#39;backleft&#39;</span>   <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">&#39;back&#39;</span>       <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">&#39;backright&#39;</span>  <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="bp">None</span>         <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">weight_thresh</span> <span class="o">=</span> <span class="mi">7</span>

    <span class="n">qualtext_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">yawtext_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>

    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
    <span class="n">unique_nids</span><span class="p">,</span> <span class="n">groupxs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">grouped_aids_</span>     <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="n">groupxs_list</span><span class="p">)</span>
    <span class="n">grouped_qualtexts</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qualtext_list</span><span class="p">),</span> <span class="n">groupxs_list</span><span class="p">)</span>
    <span class="n">grouped_yawtexts</span>  <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yawtext_list</span><span class="p">),</span> <span class="n">groupxs_list</span><span class="p">)</span>
    <span class="n">yaw_weights_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">yawtext2_weight</span><span class="p">,</span> <span class="n">yawtexts</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">yawtexts</span> <span class="ow">in</span> <span class="n">grouped_yawtexts</span>
    <span class="p">]</span>
    <span class="n">qual_weights_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">qualtext2_weight</span><span class="p">,</span> <span class="n">yawtexts</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">yawtexts</span> <span class="ow">in</span> <span class="n">grouped_qualtexts</span>
    <span class="p">]</span>
    <span class="n">weights_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">yaw_weights</span> <span class="o">+</span> <span class="n">qual_weights</span>
        <span class="k">for</span> <span class="n">yaw_weights</span><span class="p">,</span> <span class="n">qual_weights</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">yaw_weights_list</span><span class="p">,</span> <span class="n">qual_weights_list</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">sortx_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">weights</span> <span class="ow">in</span> <span class="n">weights_list</span>
    <span class="p">]</span>

    <span class="n">sorted_weight_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">weights</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights_list</span><span class="p">,</span> <span class="n">sortx_list</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">sorted_aids_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">aids</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">aids</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grouped_aids_</span><span class="p">,</span> <span class="n">sortx_list</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">passed_thresh_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">weights</span> <span class="o">&gt;</span> <span class="n">weight_thresh</span>
        <span class="k">for</span> <span class="n">weights</span> <span class="ow">in</span> <span class="n">sorted_weight_list</span>
    <span class="p">]</span>

    <span class="n">valid_ordered_aids_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">aids</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">passed</span><span class="p">),</span> <span class="n">annots_per_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">aids</span><span class="p">,</span> <span class="n">passed</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sorted_aids_list</span><span class="p">,</span> <span class="n">passed_thresh_list</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">aid_subset</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">valid_ordered_aids_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_subset</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_quality_viewpoint_subset"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_quality_viewpoint_subset">[docs]</a><span class="k">def</span> <span class="nf">get_annot_quality_viewpoint_subset</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">annots_per_view</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_annot_quality_viewpoint_subset --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb2&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; annots_per_view = 2</span>
<span class="sd">        &gt;&gt;&gt; new_aid_list, new_flag_list = get_annot_quality_viewpoint_subset(ibs)</span>
<span class="sd">        &gt;&gt;&gt; result = sum(new_flag_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        38</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>

    <span class="n">PREFER_GOOD_EXEMPLAR_OVER_EXCELLENT</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># Params for knapsack</span>
    <span class="k">def</span> <span class="nf">make_knapsack_params</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">levels_per_tier_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            N (int): the integral maximum number of items</span>
<span class="sd">            levels_per_tier_list (list): list of number of distinctions possible</span>
<span class="sd">            per tier.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (w, tier_w_list, infeasible_w)</span>
<span class="sd">                w            - is the base weight of all items</span>
<span class="sd">                tier_w_list  - is a list of w offsets per tier that does not bring it over 1</span>
<span class="sd">                                but suggest a preference for that item.</span>
<span class="sd">                infeasible_w - weight of impossible items</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">EPS</span> <span class="o">=</span> <span class="mf">1E-9</span>
        <span class="c"># Solve for the minimum per-item weight</span>
        <span class="c"># to allow for preference wiggle room</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">EPS</span>
        <span class="c"># level1 perference augmentation</span>
        <span class="c"># TODO: figure out mathematically ellegant value</span>
        <span class="n">pref_decimator</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="n">EPS</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c"># max is a hack for N = 0</span>
        <span class="c"># we want space to specify two levels of tier1 preference</span>
        <span class="n">tier_w_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last_w</span> <span class="o">=</span> <span class="n">w</span>
        <span class="k">for</span> <span class="n">num_levels</span> <span class="ow">in</span> <span class="n">levels_per_tier_list</span><span class="p">:</span>
            <span class="n">last_w</span> <span class="o">=</span> <span class="n">tier_w</span> <span class="o">=</span> <span class="n">last_w</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_levels</span> <span class="o">*</span> <span class="n">pref_decimator</span><span class="p">)</span>
            <span class="n">tier_w_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tier_w</span><span class="p">)</span>
        <span class="n">infeasible_w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">9001</span><span class="p">,</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">tier_w_list</span><span class="p">,</span> <span class="n">infeasible_w</span>
    <span class="n">levels_per_tier_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">tier_w_list</span><span class="p">,</span> <span class="n">infeasible_w</span> <span class="o">=</span> <span class="n">make_knapsack_params</span><span class="p">(</span><span class="n">annots_per_view</span><span class="p">,</span> <span class="n">levels_per_tier_list</span><span class="p">)</span>

    <span class="n">qual2_weight</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_EXCELLENT</span> <span class="p">:</span> <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_GOOD</span>      <span class="p">:</span> <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_OK</span>        <span class="p">:</span> <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_UNKNOWN</span>   <span class="p">:</span> <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_POOR</span>      <span class="p">:</span> <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="n">const</span><span class="o">.</span><span class="n">QUAL_JUNK</span>      <span class="p">:</span> <span class="n">infeasible_w</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">exemplar_offset</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c"># always prefer good over ok</span>
        <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">PREFER_GOOD_EXEMPLAR_OVER_EXCELLENT</span> <span class="k">else</span>
        <span class="c"># prefer ok over good when ok has oldflag</span>
        <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tier_w_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c"># this probably broke with the introduction of 2 more tiers</span>

    <span class="k">def</span> <span class="nf">get_knapsack_flags</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="c">#values = [1] * len(weights)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)))</span>
        <span class="c"># round to 3 decimal places to avoid np-hardness</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">indices</span><span class="p">))</span>
        <span class="n">total_value</span><span class="p">,</span> <span class="n">chosen_items</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">knapsack</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">annots_per_view</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;iterative&#39;</span><span class="p">)</span>
        <span class="c">#total_value, chosen_items = ut.knapsack(items, annots_per_view, method=&#39;recursive&#39;)</span>
        <span class="n">chosen_indices</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">chosen_items</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">chosen_indices</span><span class="p">:</span>
            <span class="n">flags</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">flags</span>

    <span class="k">def</span> <span class="nf">get_chosen_flags</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">annots_per_view</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">qual2_weight</span><span class="p">,</span> <span class="n">exemplar_offset</span><span class="p">):</span>
        <span class="n">qualtexts</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
        <span class="n">isexemplar_flags</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_exemplar_flags</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
        <span class="c"># base weight plug preference offsets</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="o">+</span> <span class="n">qual2_weight</span><span class="p">[</span><span class="n">qual</span><span class="p">]</span> <span class="o">+</span> <span class="n">exemplar_offset</span> <span class="o">*</span> <span class="n">isexemplar</span>
                   <span class="k">for</span> <span class="n">qual</span><span class="p">,</span> <span class="n">isexemplar</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qualtexts</span><span class="p">,</span> <span class="n">isexemplar_flags</span><span class="p">)]</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">annots_per_view</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">get_knapsack_flags</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="c"># We like good more than ok, and junk is infeasible We prefer items that</span>
        <span class="c"># had previously been exemplars Build input for knapsack</span>
        <span class="k">return</span> <span class="n">flags</span>

    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
    <span class="n">unique_nids</span><span class="p">,</span> <span class="n">groupxs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">grouped_aids_</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="n">groupxs_list</span><span class="p">)</span>
    <span class="c">#aids = grouped_aids_[-6]</span>
    <span class="c"># for final settings because I&#39;m too lazy to write</span>
    <span class="n">new_aid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_flag_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgressIter</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">grouped_aids_</span><span class="p">,</span> <span class="n">unique_nids</span><span class="p">),</span>
                            <span class="n">nTotal</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_nids</span><span class="p">),</span>
                            <span class="n">lbl</span><span class="o">=</span><span class="s">&#39;Picking best annots per viewpoint&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">aids_</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">_iter</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">nid</span><span class="p">):</span>
            <span class="c"># do not change unknown animals</span>
            <span class="k">continue</span>
        <span class="c"># subgroup the names by viewpoints</span>
        <span class="n">yawtexts</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">aids_</span><span class="p">)</span>
        <span class="n">yawtext2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">aids_</span><span class="p">,</span> <span class="n">yawtexts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">yawtext</span><span class="p">,</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">yawtext2_aids</span><span class="p">):</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">get_chosen_flags</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">annots_per_view</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">qual2_weight</span><span class="p">,</span> <span class="n">exemplar_offset</span><span class="p">)</span>
            <span class="n">new_aid_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
            <span class="n">new_flag_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;L ___&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_aid_list</span><span class="p">,</span> <span class="n">new_flag_list</span>

</div>
<div class="viewcode-block" id="detect_join_cases"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.detect_join_cases">[docs]</a><span class="k">def</span> <span class="nf">detect_join_cases</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    Returns:</span>
<span class="sd">        QueryResult: qres_list -  object of feature correspondences and scores</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-detect_join_cases --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; cm_list = detect_join_cases(ibs)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; #result = str(qres_list)</span>
<span class="sd">        &gt;&gt;&gt; #print(result)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; import guitool</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.gui import inspect_gui</span>
<span class="sd">        &gt;&gt;&gt; guitool.ensure_qapp()</span>
<span class="sd">        &gt;&gt;&gt; qres_wgt = inspect_gui.launch_review_matches_interface(qreq_, cm_list, filter_reviewed=False)</span>
<span class="sd">        &gt;&gt;&gt; qres_wgt.show()</span>
<span class="sd">        &gt;&gt;&gt; qres_wgt.raise_()</span>
<span class="sd">        &gt;&gt;&gt; guitool.qtapp_loop(qres_wgt)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qaids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">is_exemplar</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">minqual</span><span class="o">=</span><span class="s">&#39;poor&#39;</span><span class="p">)</span>
    <span class="n">daids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">is_exemplar</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">minqual</span><span class="o">=</span><span class="s">&#39;poor&#39;</span><span class="p">)</span>
    <span class="n">cfgdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">can_match_samename</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_k_padding</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">qreq_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">new_query_request</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">)</span>
    <span class="n">cm_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">query_chips</span><span class="p">(</span><span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">return_cm</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cm_list</span>
    <span class="c">#return qres_list</span>

</div>
<span class="k">def</span> <span class="nf">_split_car_contrib_tag</span><span class="p">(</span><span class="n">contrib_tag</span><span class="p">,</span> <span class="n">distinguish_invalids</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">contrib_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="s">&#39;NNP GZC Car&#39;</span> <span class="ow">in</span> <span class="n">contrib_tag</span><span class="p">:</span>
            <span class="n">contrib_tag_split</span> <span class="o">=</span> <span class="n">contrib_tag</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contrib_tag_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">contrib_tag</span> <span class="o">=</span> <span class="n">contrib_tag_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">distinguish_invalids</span><span class="p">:</span>
            <span class="n">contrib_tag</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">contrib_tag</span>


<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="report_sightings"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.report_sightings">[docs]</a><span class="k">def</span> <span class="nf">report_sightings</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">complete</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">include_images</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">sanitize_list</span><span class="p">(</span><span class="n">data_list</span><span class="p">):</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;COMMA&gt;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">return_str</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_list</span><span class="p">))</span>
        <span class="n">return_str</span> <span class="o">=</span> <span class="n">return_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,None,&#39;</span><span class="p">,</span> <span class="s">&#39;,NONE,&#39;</span><span class="p">)</span>
        <span class="n">return_str</span> <span class="o">=</span> <span class="n">return_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,</span><span class="si">%s</span><span class="s">,&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">,</span> <span class="p">)</span> <span class="p">,</span> <span class="s">&#39;,UNKNOWN,&#39;</span><span class="p">)</span>
        <span class="n">return_str</span> <span class="o">=</span> <span class="n">return_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,-1,&#39;</span><span class="p">,</span> <span class="s">&#39;,UNKNOWN,&#39;</span><span class="p">)</span>
        <span class="n">return_str</span> <span class="o">=</span> <span class="n">return_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,-1,&#39;</span><span class="p">,</span> <span class="s">&#39;,UNKNOWN,&#39;</span><span class="p">)</span>
        <span class="n">return_str</span> <span class="o">=</span> <span class="n">return_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,-1.0,&#39;</span><span class="p">,</span> <span class="s">&#39;,UNKNOWN,&#39;</span><span class="p">)</span>
        <span class="n">return_str</span> <span class="o">=</span> <span class="n">return_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,-1.0,&#39;</span><span class="p">,</span> <span class="s">&#39;,UNKNOWN,&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_str</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">complete</span><span class="p">:</span>
            <span class="n">cols_list</span>      <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s">&#39;annotation_id&#39;</span><span class="p">,</span>        <span class="n">aid_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;annotation_xtl&#39;</span><span class="p">,</span>       <span class="n">xtl_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;annotation_ytl&#39;</span><span class="p">,</span>       <span class="n">ytl_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;annotation_width&#39;</span><span class="p">,</span>     <span class="n">width_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;annotation_height&#39;</span><span class="p">,</span>    <span class="n">height_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;annotation_species&#39;</span><span class="p">,</span>   <span class="n">species_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;annotation_viewpoint&#39;</span><span class="p">,</span> <span class="n">viewpoint_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;annotation_qualities&#39;</span><span class="p">,</span> <span class="n">quality_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;annotation_sex&#39;</span><span class="p">,</span>       <span class="n">sex_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;annotation_age_min&#39;</span><span class="p">,</span>   <span class="n">age_min_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;annotation_age_max&#39;</span><span class="p">,</span>   <span class="n">age_max_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;annotation_name&#39;</span><span class="p">,</span>      <span class="n">name_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;image_id&#39;</span><span class="p">,</span>             <span class="n">gid_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;image_contributor&#39;</span><span class="p">,</span>    <span class="n">contrib_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;image_car&#39;</span><span class="p">,</span>            <span class="n">car_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;image_filename&#39;</span><span class="p">,</span>       <span class="n">uri_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;image_unixtime&#39;</span><span class="p">,</span>       <span class="n">unixtime_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;image_time_str&#39;</span><span class="p">,</span>       <span class="n">time_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;image_date_str&#39;</span><span class="p">,</span>       <span class="n">date_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;image_lat&#39;</span><span class="p">,</span>            <span class="n">lat_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;image_lon&#39;</span><span class="p">,</span>            <span class="n">lon_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;flag_first_seen&#39;</span><span class="p">,</span>      <span class="n">seen_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;flag_marked&#39;</span><span class="p">,</span>          <span class="n">marked_list</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols_list</span>      <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s">&#39;annotation_id&#39;</span><span class="p">,</span>        <span class="n">aid_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;image_time_str&#39;</span><span class="p">,</span>       <span class="n">time_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;image_date_str&#39;</span><span class="p">,</span>       <span class="n">date_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;flag_first_seen&#39;</span><span class="p">,</span>      <span class="n">seen_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;image_lat&#39;</span><span class="p">,</span>            <span class="n">lat_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;image_lon&#39;</span><span class="p">,</span>            <span class="n">lon_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;image_car&#39;</span><span class="p">,</span>            <span class="n">car_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;annotation_age_min&#39;</span><span class="p">,</span>   <span class="n">age_min_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;annotation_age_max&#39;</span><span class="p">,</span>   <span class="n">age_max_list</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;annotation_sex&#39;</span><span class="p">,</span>       <span class="n">sex_list</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="n">header_list</span>    <span class="o">=</span> <span class="p">[</span> <span class="n">sanitize_list</span><span class="p">([</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">cols</span> <span class="ow">in</span> <span class="n">cols_list</span> <span class="p">])</span> <span class="p">]</span>
        <span class="n">data_list</span>      <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">cols</span> <span class="ow">in</span> <span class="n">cols_list</span> <span class="p">])</span>
        <span class="n">line_list</span>      <span class="o">=</span> <span class="p">[</span> <span class="n">sanitize_list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">return</span> <span class="n">header_list</span><span class="p">,</span> <span class="n">line_list</span>

    <span class="c"># Grab primitives</span>
    <span class="k">if</span> <span class="n">complete</span><span class="p">:</span>
        <span class="n">aid_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aid_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_count</span><span class="p">(</span><span class="n">pre_unixtime_sort</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">gid_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">bbox_list</span>      <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">xtl_list</span>       <span class="o">=</span> <span class="p">[</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="n">bbox_list</span> <span class="p">]</span>
    <span class="n">ytl_list</span>       <span class="o">=</span> <span class="p">[</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="n">bbox_list</span> <span class="p">]</span>
    <span class="n">width_list</span>     <span class="o">=</span> <span class="p">[</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="n">bbox_list</span> <span class="p">]</span>
    <span class="n">height_list</span>    <span class="o">=</span> <span class="p">[</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="n">bbox_list</span> <span class="p">]</span>
    <span class="n">species_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">viewpoint_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">quality_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">contrib_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_contributor_tag</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">car_list</span>       <span class="o">=</span> <span class="p">[</span> <span class="n">_split_car_contrib_tag</span><span class="p">(</span><span class="n">contrib_tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">contrib_tag</span> <span class="ow">in</span> <span class="n">contrib_list</span> <span class="p">]</span>
    <span class="n">uri_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uris</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">sex_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_sex_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">age_min_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_age_months_est_min</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">age_max_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_age_months_est_max</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">name_list</span>      <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_names</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">unixtime_list</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">datetime_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">unixtime_to_datetimestr</span><span class="p">(</span><span class="n">unixtime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unixtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span>
        <span class="s">&#39;UNKNOWN&#39;</span>
        <span class="k">for</span> <span class="n">unixtime</span> <span class="ow">in</span> <span class="n">unixtime_list</span>
    <span class="p">]</span>
    <span class="n">datetime_split_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">datetime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">datetime</span> <span class="ow">in</span> <span class="n">datetime_list</span> <span class="p">]</span>
    <span class="n">date_list</span>      <span class="o">=</span> <span class="p">[</span>
        <span class="n">datetime_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datetime_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s">&#39;UNKNOWN&#39;</span>
        <span class="k">for</span> <span class="n">datetime_split</span> <span class="ow">in</span> <span class="n">datetime_split_list</span> <span class="p">]</span>
    <span class="n">time_list</span>      <span class="o">=</span> <span class="p">[</span>
        <span class="n">datetime_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datetime_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s">&#39;UNKNOWN&#39;</span>
        <span class="k">for</span> <span class="n">datetime_split</span> <span class="ow">in</span> <span class="n">datetime_split_list</span> <span class="p">]</span>
    <span class="n">lat_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_lat</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">lon_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_lon</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">marked_list</span>    <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">flag_aids_count</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">seen_list</span>      <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen_set</span>       <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_set</span><span class="p">:</span>
            <span class="n">seen_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">seen_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">seen_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">return_list</span><span class="p">,</span> <span class="n">line_list</span> <span class="o">=</span> <span class="n">construct</span><span class="p">()</span>
    <span class="n">return_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">line_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">include_images</span><span class="p">:</span>
        <span class="n">all_gid_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">())</span>
        <span class="n">gid_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">missing_gid_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">all_gid_set</span> <span class="o">-</span> <span class="n">gid_set</span><span class="p">))</span>
        <span class="n">filler</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_gid_list</span><span class="p">)</span>

        <span class="n">aid_list</span>       <span class="o">=</span> <span class="n">filler</span>
        <span class="n">species_list</span>   <span class="o">=</span> <span class="n">filler</span>
        <span class="n">viewpoint_list</span> <span class="o">=</span> <span class="n">filler</span>
        <span class="n">quality_list</span>   <span class="o">=</span> <span class="n">filler</span>
        <span class="n">sex_list</span>       <span class="o">=</span> <span class="n">filler</span>
        <span class="n">age_min_list</span>   <span class="o">=</span> <span class="n">filler</span>
        <span class="n">age_max_list</span>   <span class="o">=</span> <span class="n">filler</span>
        <span class="n">name_list</span>      <span class="o">=</span> <span class="n">filler</span>
        <span class="n">gid_list</span>       <span class="o">=</span> <span class="n">missing_gid_list</span>
        <span class="n">contrib_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_contributor_tag</span><span class="p">(</span><span class="n">missing_gid_list</span><span class="p">)</span>
        <span class="n">car_list</span>       <span class="o">=</span> <span class="p">[</span> <span class="n">_split_car_contrib_tag</span><span class="p">(</span><span class="n">contrib_tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">contrib_tag</span> <span class="ow">in</span> <span class="n">contrib_list</span> <span class="p">]</span>
        <span class="n">uri_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uris</span><span class="p">(</span><span class="n">missing_gid_list</span><span class="p">)</span>
        <span class="n">unixtime_list</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">missing_gid_list</span><span class="p">)</span>
        <span class="n">datetime_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">unixtime_to_datetimestr</span><span class="p">(</span><span class="n">unixtime</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unixtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span>
            <span class="s">&#39;UNKNOWN&#39;</span>
            <span class="k">for</span> <span class="n">unixtime</span> <span class="ow">in</span> <span class="n">unixtime_list</span>
        <span class="p">]</span>
        <span class="n">datetime_split_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">datetime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">datetime</span> <span class="ow">in</span> <span class="n">datetime_list</span> <span class="p">]</span>
        <span class="n">date_list</span>      <span class="o">=</span> <span class="p">[</span>
            <span class="n">datetime_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datetime_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s">&#39;UNKNOWN&#39;</span>
            <span class="k">for</span> <span class="n">datetime_split</span> <span class="ow">in</span> <span class="n">datetime_split_list</span> <span class="p">]</span>
        <span class="n">time_list</span>      <span class="o">=</span> <span class="p">[</span>
            <span class="n">datetime_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datetime_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s">&#39;UNKNOWN&#39;</span>
            <span class="k">for</span> <span class="n">datetime_split</span> <span class="ow">in</span> <span class="n">datetime_split_list</span> <span class="p">]</span>
        <span class="n">lat_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_lat</span><span class="p">(</span><span class="n">missing_gid_list</span><span class="p">)</span>
        <span class="n">lon_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_lon</span><span class="p">(</span><span class="n">missing_gid_list</span><span class="p">)</span>
        <span class="n">seen_list</span>      <span class="o">=</span> <span class="n">filler</span>
        <span class="n">marked_list</span>    <span class="o">=</span> <span class="n">filler</span>

        <span class="n">header_list</span><span class="p">,</span> <span class="n">line_list</span> <span class="o">=</span> <span class="n">construct</span><span class="p">()</span>  <span class="c"># NOTE: discard the header list returned here</span>
        <span class="n">return_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">line_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">return_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="report_sightings_str"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.report_sightings_str">[docs]</a><span class="k">def</span> <span class="nf">report_sightings_str</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">line_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">report_sightings</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line_list</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="check_chip_existence"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_chip_existence">[docs]</a><span class="k">def</span> <span class="nf">check_chip_existence</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chip_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">chip_fpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_chip_fpath</span><span class="p">(</span><span class="n">cid_list</span><span class="p">)</span>
    <span class="n">flag_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="bp">True</span> <span class="k">if</span> <span class="n">chip_fpath</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">exists</span><span class="p">(</span><span class="n">chip_fpath</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chip_fpath</span> <span class="ow">in</span> <span class="n">chip_fpath_list</span>
    <span class="p">]</span>
    <span class="n">cid_kill_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">cid_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cid_kill_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;found </span><span class="si">%d</span><span class="s"> inconsistent chips attempting to fix&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">cid_kill_list</span><span class="p">))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_chips</span><span class="p">(</span><span class="n">cid_kill_list</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="is_special_imageset"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.is_special_imageset">[docs]</a><span class="k">def</span> <span class="nf">is_special_imageset</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">imgsetid_list</span><span class="p">):</span>
    <span class="n">imagesettext_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid_list</span><span class="p">)</span>
    <span class="n">isspecial_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">imagesettext</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">SPECIAL_IMAGESET_LABELS</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">imagesettext</span> <span class="ow">in</span> <span class="n">imagesettext_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">isspecial_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_quality_filterflags"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_quality_filterflags">[docs]</a><span class="k">def</span> <span class="nf">get_quality_filterflags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">minqual</span><span class="p">,</span> <span class="n">unknown_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>
<span class="sd">        minqual (str): qualtext</span>
<span class="sd">        unknown_ok (bool): (default = False)</span>

<span class="sd">    Returns:</span>
<span class="sd">        iter: qual_flags</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_quality_filterflags</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()[0:20]</span>
<span class="sd">        &gt;&gt;&gt; minqual = &#39;junk&#39;</span>
<span class="sd">        &gt;&gt;&gt; unknown_ok = False</span>
<span class="sd">        &gt;&gt;&gt; qual_flags = list(get_quality_filterflags(ibs, aid_list, minqual, unknown_ok))</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;qual_flags = %s&#39; % (str(qual_flags),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">minqual_int</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">QUALITY_TEXT_TO_INT</span><span class="p">[</span><span class="n">minqual</span><span class="p">]</span>
    <span class="n">qual_int_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_qualities</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="c">#print(&#39;qual_int_list = %r&#39; % (qual_int_list,))</span>
    <span class="k">if</span> <span class="n">unknown_ok</span><span class="p">:</span>
        <span class="n">qual_flags</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">qual_int</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">qual_int</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">qual_int</span> <span class="o">&gt;=</span> <span class="n">minqual_int</span>
            <span class="k">for</span> <span class="n">qual_int</span> <span class="ow">in</span> <span class="n">qual_int_list</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">qual_flags</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">qual_int</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">qual_int</span> <span class="o">&gt;=</span> <span class="n">minqual_int</span>
            <span class="k">for</span> <span class="n">qual_int</span> <span class="ow">in</span> <span class="n">qual_int_list</span>
        <span class="p">)</span>
    <span class="n">qual_flags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">qual_flags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qual_flags</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_viewpoint_filterflags"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_viewpoint_filterflags">[docs]</a><span class="k">def</span> <span class="nf">get_viewpoint_filterflags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">valid_yaws</span><span class="p">,</span> <span class="n">unknown_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>
<span class="sd">        valid_yaws (?):</span>
<span class="sd">        unknown_ok (bool): (default = True)</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: aid_list -  list of annotation ids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_viewpoint_filterflags</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_viewpoint_filterflags --db NNP_Master3</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()[0:20]</span>
<span class="sd">        &gt;&gt;&gt; valid_yaws = None</span>
<span class="sd">        &gt;&gt;&gt; unknown_ok = False</span>
<span class="sd">        &gt;&gt;&gt; yaw_flags = list(get_viewpoint_filterflags(ibs, aid_list, valid_yaws, unknown_ok))</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;yaw_flags = %s&#39; % (str(yaw_flags),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">valid_yaws</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)),</span> <span class="s">&#39;valid_yaws is not a container&#39;</span>
    <span class="n">yaw_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">unknown_ok</span><span class="p">:</span>
        <span class="n">yaw_flags</span>  <span class="o">=</span> <span class="p">(</span><span class="n">yaw</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="n">valid_yaws</span> <span class="k">for</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="n">yaw_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">yaw_flags</span>  <span class="o">=</span> <span class="p">(</span><span class="n">yaw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="n">valid_yaws</span> <span class="k">for</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="n">yaw_list</span><span class="p">)</span>
    <span class="n">yaw_flags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">yaw_flags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">yaw_flags</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_quality_viewpoint_filterflags"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_quality_viewpoint_filterflags">[docs]</a><span class="k">def</span> <span class="nf">get_quality_viewpoint_filterflags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">minqual</span><span class="p">,</span> <span class="n">valid_yaws</span><span class="p">):</span>
    <span class="n">qual_flags</span> <span class="o">=</span> <span class="n">get_quality_filterflags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">minqual</span><span class="p">)</span>
    <span class="n">yaw_flags</span> <span class="o">=</span> <span class="n">get_viewpoint_filterflags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">valid_yaws</span><span class="p">)</span>
    <span class="c">#qual_list = ibs.get_annot_qualities(aid_list)</span>
    <span class="c">#yaw_list = ibs.get_annot_yaw_texts(aid_list)</span>
    <span class="c">#qual_flags = (qual is None or qual &gt; minqual for qual in qual_list)</span>
    <span class="c">#yaw_flags  = (yaw is None or yaw in valid_yaws for yaw in yaw_list)</span>
    <span class="n">flags_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">and_iters</span><span class="p">(</span><span class="n">qual_flags</span><span class="p">,</span> <span class="n">yaw_flags</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">flags_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_custom_filterflags"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_custom_filterflags">[docs]</a><span class="k">def</span> <span class="nf">get_annot_custom_filterflags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">enable_custom_filter</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="c">#minqual = const.QUALITY_TEXT_TO_INT[&#39;poor&#39;]</span>
    <span class="n">minqual</span> <span class="o">=</span> <span class="s">&#39;ok&#39;</span>
    <span class="c">#valid_yaws = {&#39;left&#39;, &#39;frontleft&#39;, &#39;backleft&#39;}</span>
    <span class="n">valid_yawtexts</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;left&#39;</span><span class="p">,</span> <span class="s">&#39;frontleft&#39;</span><span class="p">}</span>
    <span class="n">flags_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_quality_viewpoint_filterflags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">minqual</span><span class="p">,</span> <span class="n">valid_yawtexts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flags_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="filter_aids_custom"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_aids_custom">[docs]</a><span class="k">def</span> <span class="nf">filter_aids_custom</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: aid_list_</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-filter_aids_custom</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb2&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; aid_list_ = filter_aids_custom(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = str(aid_list_)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">enable_custom_filter</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">aid_list</span>
    <span class="n">flags_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_custom_filterflags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iter_compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">))</span>
    <span class="c">#aid_list_ = list(ut.compress(aid_list, flags_list))</span>
    <span class="k">return</span> <span class="n">aid_list_</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="flag_aids_count"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.flag_aids_count">[docs]</a><span class="k">def</span> <span class="nf">flag_aids_count</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>
<span class="sd">        pre_unixtime_sort (bool):</span>

<span class="sd">    Returns:</span>
<span class="sd">        list:</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-flag_aids_count</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; gzc_flag_list = flag_aids_count(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; result = gzc_flag_list</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [False, True, False, False, True, False, True, True, False, True, False, True, True]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Get primitives</span>
    <span class="n">unixtime_list</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">index_list</span>     <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_argsort</span><span class="p">(</span><span class="n">unixtime_list</span><span class="p">)</span>
    <span class="n">aid_list</span>       <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">unixtime_list</span><span class="p">)</span>
    <span class="n">gid_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">nid_list</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">contrib_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_contributor_tag</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="c"># Get filter flags for aids</span>
    <span class="n">flag_list</span>      <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_custom_filterflags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">isunknown_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_aid_unknown</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">flag_list</span>      <span class="o">=</span> <span class="p">[</span> <span class="ow">not</span> <span class="n">unknown</span> <span class="ow">and</span> <span class="n">flag</span> <span class="k">for</span> <span class="n">unknown</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">isunknown_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span> <span class="p">]</span>
    <span class="c"># Filter by seen and car</span>
    <span class="n">flag_list_</span>     <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen_dict</span>      <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
    <span class="c"># Mark the first annotation (for each name) seen per car</span>
    <span class="n">values_list</span>    <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">,</span> <span class="n">contrib_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">contrib</span> <span class="ow">in</span> <span class="n">values_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">contrib_</span> <span class="o">=</span> <span class="n">_split_car_contrib_tag</span><span class="p">(</span><span class="n">contrib</span><span class="p">,</span> <span class="n">distinguish_invalids</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_dict</span><span class="p">[</span><span class="n">contrib_</span><span class="p">]:</span>
                <span class="n">seen_dict</span><span class="p">[</span><span class="n">contrib_</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
                <span class="n">flag_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="n">flag_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="c"># Take the inverse of the sorted</span>
    <span class="n">gzc_flag_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_inverse_take</span><span class="p">(</span><span class="n">flag_list_</span><span class="p">,</span> <span class="n">index_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gzc_flag_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="filter_aids_count"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_aids_count">[docs]</a><span class="k">def</span> <span class="nf">filter_aids_count</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pre_unixtime_sort</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># Get all aids and pre-sort by unixtime</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pre_unixtime_sort</span><span class="p">:</span>
            <span class="n">unixtime_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
            <span class="n">aid_list</span>      <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">unixtime_list</span><span class="p">)</span>
    <span class="n">flags_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">flag_aids_count</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">aid_list_</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iter_compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">aid_list_</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="filterflags_unflat_aids_custom"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filterflags_unflat_aids_custom">[docs]</a><span class="k">def</span> <span class="nf">filterflags_unflat_aids_custom</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">some</span><span class="p">(</span><span class="n">flags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; like any, but some at least one must be True &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
    <span class="n">filtered_aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_custom_filterflags</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="n">isvalid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">some</span><span class="p">,</span> <span class="n">filtered_aids_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">isvalid_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="filter_nids_custom"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_nids_custom">[docs]</a><span class="k">def</span> <span class="nf">filter_nids_custom</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">isvalid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filterflags_unflat_aids_custom</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="n">filtered_nid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered_nid_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="filter_gids_custom"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_gids_custom">[docs]</a><span class="k">def</span> <span class="nf">filter_gids_custom</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">isvalid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filterflags_unflat_aids_custom</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="n">filtered_gid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered_gid_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_name_gps_tracks"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_name_gps_tracks">[docs]</a><span class="k">def</span> <span class="nf">get_name_gps_tracks</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_name_gps_tracks</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; #ibs = ibeis.opendb(&#39;PZ_Master0&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #nid_list = ibs.get_valid_nids()</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; nid_list, gps_track_list, aid_track_list = ibs.get_name_gps_tracks(aid_list=aid_list)</span>
<span class="sd">        &gt;&gt;&gt; nonempty_list = list(map(lambda x: len(x) &gt; 0, gps_track_list))</span>
<span class="sd">        &gt;&gt;&gt; ut.compress(nid_list, nonempty_list)</span>
<span class="sd">        &gt;&gt;&gt; ut.compress(gps_track_list, nonempty_list)</span>
<span class="sd">        &gt;&gt;&gt; ut.compress(aid_track_list, nonempty_list)</span>
<span class="sd">        &gt;&gt;&gt; result = str(aid_track_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [[11], [], [4], [1], [2, 3], [5, 6], [7], [8], [10], [12], [13]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">nid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;only specify one please&#39;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aids_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aids_list_</span><span class="p">,</span> <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes</span><span class="p">(</span><span class="n">aids</span><span class="p">))</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list_</span><span class="p">]</span>
    <span class="n">gids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="n">gpss_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_image_gps</span><span class="p">,</span> <span class="n">gids_list</span><span class="p">)</span>

    <span class="n">isvalids_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">gps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="ow">or</span> <span class="n">gps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="k">for</span> <span class="n">gps</span> <span class="ow">in</span> <span class="n">gpss</span><span class="p">]</span>
                     <span class="k">for</span> <span class="n">gpss</span> <span class="ow">in</span> <span class="n">gpss_list</span><span class="p">]</span>
    <span class="n">gps_track_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">gpss</span><span class="p">,</span> <span class="n">isvalids</span><span class="p">)</span> <span class="k">for</span> <span class="n">gpss</span><span class="p">,</span> <span class="n">isvalids</span> <span class="ow">in</span>
                      <span class="nb">zip</span><span class="p">(</span><span class="n">gpss_list</span><span class="p">,</span> <span class="n">isvalids_list</span><span class="p">)]</span>
    <span class="n">aid_track_list</span>  <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">isvalids</span><span class="p">)</span> <span class="k">for</span> <span class="n">aids</span><span class="p">,</span> <span class="n">isvalids</span> <span class="ow">in</span>
                       <span class="nb">zip</span><span class="p">(</span><span class="n">aids_list</span><span class="p">,</span> <span class="n">isvalids_list</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">nid_list</span><span class="p">,</span> <span class="n">gps_track_list</span><span class="p">,</span> <span class="n">aid_track_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_unflat_annots_kmdists_list"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_unflat_annots_kmdists_list">[docs]</a><span class="k">def</span> <span class="nf">get_unflat_annots_kmdists_list</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">):</span>
    <span class="c">#ibs.check_name_mapping_consistency(aids_list)</span>
    <span class="n">latlons_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_gps</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="n">latlon_arrs</span>   <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">latlons</span><span class="p">)</span> <span class="k">for</span> <span class="n">latlons</span> <span class="ow">in</span> <span class="n">latlons_list</span><span class="p">]</span>
    <span class="n">km_dists_list</span>   <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">safe_pdist</span><span class="p">(</span><span class="n">latlon_arr</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">vt</span><span class="o">.</span><span class="n">haversine</span><span class="p">)</span> <span class="k">for</span> <span class="n">latlon_arr</span> <span class="ow">in</span> <span class="n">latlon_arrs</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">km_dists_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_unflat_annots_hourdists_list"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_unflat_annots_hourdists_list">[docs]</a><span class="k">def</span> <span class="nf">get_unflat_annots_hourdists_list</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = testdata_ibs(&#39;NNP_Master3&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nid_list = get_valid_multiton_nids_custom(ibs)</span>
<span class="sd">        &gt;&gt;&gt; aids_list_ = ibs.get_name_aids(nid_list)</span>
<span class="sd">        &gt;&gt;&gt; aids_list = [ibs.filter_aids_custom(aids) for aids in aids_list_]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">isunique</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)))</span>
    <span class="n">unixtimes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="c">#assert all(list(map(ut.isunique, unixtimes_list)))</span>
    <span class="n">unixtime_arrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unixtimes</span><span class="p">)[:,</span> <span class="bp">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">unixtimes</span> <span class="ow">in</span> <span class="n">unixtimes_list</span><span class="p">]</span>
    <span class="n">hour_dists_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">safe_pdist</span><span class="p">(</span><span class="n">unixtime_arr</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">unixtime_hourdiff</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">unixtime_arr</span> <span class="ow">in</span> <span class="n">unixtime_arrs</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">hour_dists_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_unflat_annots_timedelta_list"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_unflat_annots_timedelta_list">[docs]</a><span class="k">def</span> <span class="nf">get_unflat_annots_timedelta_list</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = testdata_ibs(&#39;NNP_Master3&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nid_list = get_valid_multiton_nids_custom(ibs)</span>
<span class="sd">        &gt;&gt;&gt; aids_list_ = ibs.get_name_aids(nid_list)</span>
<span class="sd">        &gt;&gt;&gt; aids_list = [ibs.filter_aids_custom(aids) for aids in aids_list_]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">isunique</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)))</span>
    <span class="n">unixtimes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes_asfloat</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="c">#assert all(list(map(ut.isunique, unixtimes_list)))</span>
    <span class="n">unixtime_arrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unixtimes</span><span class="p">)[:,</span> <span class="bp">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">unixtimes</span> <span class="ow">in</span> <span class="n">unixtimes_list</span><span class="p">]</span>
    <span class="n">timedelta_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">safe_pdist</span><span class="p">(</span><span class="n">unixtime_arr</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">absdiff</span><span class="p">)</span> <span class="k">for</span>
                      <span class="n">unixtime_arr</span> <span class="ow">in</span> <span class="n">unixtime_arrs</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">timedelta_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_unflat_annots_speeds_list"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_unflat_annots_speeds_list">[docs]</a><span class="k">def</span> <span class="nf">get_unflat_annots_speeds_list</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">):</span>
    <span class="n">km_dists_list</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annots_kmdists_list</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="n">hour_dists_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annots_hourdists_list</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="n">speeds_list</span>     <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">safe_div</span><span class="p">(</span><span class="n">km_dists</span><span class="p">,</span> <span class="n">hours_dists</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">km_dists</span><span class="p">,</span> <span class="n">hours_dists</span> <span class="ow">in</span>
                       <span class="nb">zip</span><span class="p">(</span><span class="n">km_dists_list</span><span class="p">,</span> <span class="n">hour_dists_list</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">speeds_list</span>

</div>
<div class="viewcode-block" id="testdata_ibs"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.testdata_ibs">[docs]</a><span class="k">def</span> <span class="nf">testdata_ibs</span><span class="p">(</span><span class="n">defaultdb</span><span class="o">=</span><span class="s">&#39;testdb1&#39;</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">ibeis</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="n">defaultdb</span><span class="o">=</span><span class="n">defaultdb</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ibs</span>

</div>
<div class="viewcode-block" id="get_valid_multiton_nids_custom"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_valid_multiton_nids_custom">[docs]</a><span class="k">def</span> <span class="nf">get_valid_multiton_nids_custom</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">nid_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_known_nids</span><span class="p">()</span>
    <span class="n">ismultiton_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_custom</span><span class="p">(</span><span class="n">aids</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span>
                       <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list_</span><span class="p">)]</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">nid_list_</span><span class="p">,</span> <span class="n">ismultiton_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nid_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_name_speeds"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_name_speeds">[docs]</a><span class="k">def</span> <span class="nf">get_name_speeds</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_name_speeds</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = testdata_ibs(&#39;NNP_Master3&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nid_list = get_valid_multiton_nids_custom(ibs)</span>
<span class="sd">        &gt;&gt;&gt; speeds_list = get_name_speeds(ibs, nid_list)</span>
<span class="sd">        &gt;&gt;&gt; result = str(speeds_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aids_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="c">#ibs.check_name_mapping_consistency(aids_list_)</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_custom</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list_</span><span class="p">]</span>
    <span class="n">speeds_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annots_speeds_list</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">speeds_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<span class="nd">@accessor_decors.getter</span>
<div class="viewcode-block" id="get_name_hourdiffs"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_name_hourdiffs">[docs]</a><span class="k">def</span> <span class="nf">get_name_hourdiffs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_name_hourdiffs</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = testdata_ibs(&#39;NNP_Master3&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nid_list = ibs.filter_nids_custom(ibs._get_all_known_nids())</span>
<span class="sd">        &gt;&gt;&gt; hourdiffs_list = ibs.get_name_hourdiffs(nid_list)</span>
<span class="sd">        &gt;&gt;&gt; result = hourdiffs_list</span>
<span class="sd">        &gt;&gt;&gt; print(hourdiffs_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aids_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="c">#ibs.check_name_mapping_consistency(aids_list_)</span>
    <span class="c"># HACK FILTERING SHOULD NOT OCCUR HERE</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_custom</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list_</span><span class="p">]</span>
    <span class="n">hourdiffs_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annots_hourdists_list</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hourdiffs_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<span class="nd">@accessor_decors.getter</span>
<div class="viewcode-block" id="get_name_max_hourdiff"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_name_max_hourdiff">[docs]</a><span class="k">def</span> <span class="nf">get_name_max_hourdiff</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="n">hourdiffs_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_hourdiffs</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">maxhourdiff_list_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">safe_max</span><span class="p">,</span> <span class="n">hourdiffs_list</span><span class="p">))</span>
    <span class="n">maxhourdiff_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">maxhourdiff_list_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">maxhourdiff_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<span class="nd">@accessor_decors.getter</span>
<div class="viewcode-block" id="get_name_max_speed"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_name_max_speed">[docs]</a><span class="k">def</span> <span class="nf">get_name_max_speed</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_name_max_speed</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = testdata_ibs(&#39;NNP_Master3&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nid_list = ibs.filter_nids_custom(ibs._get_all_known_nids())</span>
<span class="sd">        &gt;&gt;&gt; maxspeed_list = ibs.get_name_max_speed(nid_list)</span>
<span class="sd">        &gt;&gt;&gt; result = maxspeed_list</span>
<span class="sd">        &gt;&gt;&gt; print(maxspeed_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">speeds_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_speeds</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">maxspeed_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">safe_max</span><span class="p">,</span> <span class="n">speeds_list</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">maxspeed_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="make_next_imageset_text"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.make_next_imageset_text">[docs]</a><span class="k">def</span> <span class="nf">make_next_imageset_text</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates what the next imageset name would be but does not add it to the database</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-make_next_imageset_text</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; new_imagesettext = make_next_imageset_text(ibs)</span>
<span class="sd">        &gt;&gt;&gt; result = new_imagesettext</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        New ImageSet 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_imgsetids</span><span class="p">()</span>
    <span class="n">old_imagesettext_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid_list</span><span class="p">)</span>
    <span class="n">new_imagesettext</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_nonconflicting_string</span><span class="p">(</span><span class="s">&#39;New ImageSet </span><span class="si">%d</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">old_imagesettext_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_imagesettext</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="add_next_imageset"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.add_next_imageset">[docs]</a><span class="k">def</span> <span class="nf">add_next_imageset</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a new imageset to the database</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_imagesettext</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_imageset_text</span><span class="p">()</span>
    <span class="p">(</span><span class="n">new_imgsetid</span><span class="p">,)</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_imagesets</span><span class="p">([</span><span class="n">new_imagesettext</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">new_imgsetid</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="create_new_imageset_from_images"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.create_new_imageset_from_images">[docs]</a><span class="k">def</span> <span class="nf">create_new_imageset_from_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">new_imgsetid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        gid_list (list):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-create_new_imageset_from_images</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; gid_list = ibs.get_valid_gids()[::2]</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; new_imgsetid = create_new_imageset_from_images(ibs, gid_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = new_imgsetid</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">new_imgsetid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">new_imgsetid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_next_imageset</span><span class="p">()</span>
    <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_imgsetid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_imgsetids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">imgsetid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_imgsetid</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="new_imagesets_from_images"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.new_imagesets_from_images">[docs]</a><span class="k">def</span> <span class="nf">new_imagesets_from_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gids_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        gids_list (list):</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">create_new_imageset_from_images</span><span class="p">(</span><span class="n">gids</span><span class="p">)</span> <span class="k">for</span> <span class="n">gids</span> <span class="ow">in</span> <span class="n">gids_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">imgsetid_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="create_new_imageset_from_names"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.create_new_imageset_from_names">[docs]</a><span class="k">def</span> <span class="nf">create_new_imageset_from_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        nid_list (list):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-create_new_imageset_from_names</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nid_list = ibs._get_all_known_nids()[0:2]</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; new_imgsetid = ibs.create_new_imageset_from_names(nid_list)</span>
<span class="sd">        &gt;&gt;&gt; # clean up</span>
<span class="sd">        &gt;&gt;&gt; ibs.delete_imagesets(new_imgsetid)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = new_imgsetid</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">gids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">gids_list</span><span class="p">)</span>
    <span class="n">new_imgsetid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">create_new_imageset_from_images</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_imgsetid</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="prepare_annotgroup_review"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.prepare_annotgroup_review">[docs]</a><span class="k">def</span> <span class="nf">prepare_annotgroup_review</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (src_ag_rowid, dst_ag_rowid) - source and dest annot groups</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-prepare_annotgroup_review</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; result = prepare_annotgroup_review(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Build new names for source and dest annot groups</span>
    <span class="n">all_annotgroup_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_annotgroup_rowids</span><span class="p">()</span>
    <span class="n">all_annotgroup_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotgroup_text</span><span class="p">(</span><span class="n">all_annotgroup_rowid_list</span><span class="p">)</span>
    <span class="n">new_grouptext_src</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_nonconflicting_string</span><span class="p">(</span><span class="s">&#39;Source Group </span><span class="si">%d</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">all_annotgroup_text_list</span><span class="p">)</span>
    <span class="n">all_annotgroup_text_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">new_grouptext_src</span><span class="p">]</span>
    <span class="n">new_grouptext_dst</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_nonconflicting_string</span><span class="p">(</span><span class="s">&#39;Dest Group </span><span class="si">%d</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">all_annotgroup_text_list</span><span class="p">)</span>
    <span class="c"># Add new empty groups</span>
    <span class="n">annotgroup_text_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_grouptext_src</span><span class="p">,</span> <span class="n">new_grouptext_dst</span><span class="p">]</span>
    <span class="n">annotgroup_uuid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">hashable_to_uuid</span><span class="p">,</span> <span class="n">annotgroup_text_list</span><span class="p">))</span>
    <span class="n">annotgroup_note_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">]</span>
    <span class="n">src_ag_rowid</span><span class="p">,</span> <span class="n">dst_ag_rowid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_annotgroup</span><span class="p">(</span><span class="n">annotgroup_uuid_list</span><span class="p">,</span>
                                                    <span class="n">annotgroup_text_list</span><span class="p">,</span>
                                                    <span class="n">annotgroup_note_list</span><span class="p">)</span>
    <span class="c"># Relate the annotations with the source group</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">add_gar</span><span class="p">([</span><span class="n">src_ag_rowid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="n">aid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">src_ag_rowid</span><span class="p">,</span> <span class="n">dst_ag_rowid</span>

</div>
<div class="viewcode-block" id="remove_rfdetect"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.remove_rfdetect">[docs]</a><span class="k">def</span> <span class="nf">remove_rfdetect</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">search_annot_notes</span><span class="p">(</span><span class="s">&#39;rfdetect&#39;</span><span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
    <span class="n">newnotes</span> <span class="o">=</span> <span class="p">[</span><span class="n">note</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;rfdetect&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">notes</span><span class="p">]</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_notes</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">newnotes</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="remove_groundtrue_aids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.remove_groundtrue_aids">[docs]</a><span class="k">def</span> <span class="nf">remove_groundtrue_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">ref_aid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; removes any aids that are known to match &quot;&quot;&quot;</span>
    <span class="n">ref_nids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">ref_aid_list</span><span class="p">))</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">flag_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">nid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ref_nids</span> <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nid_list</span><span class="p">]</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list_</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="search_annot_notes"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.search_annot_notes">[docs]</a><span class="k">def</span> <span class="nf">search_annot_notes</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;PZ_Master0&#39;)</span>
<span class="sd">        &gt;&gt;&gt; pattern = [&#39;gash&#39;, &#39;injury&#39;, &#39;scar&#39;, &#39;wound&#39;]</span>
<span class="sd">        &gt;&gt;&gt; valid_aid_list = ibs.search_annot_notes(pattern)</span>
<span class="sd">        &gt;&gt;&gt; print(valid_aid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(ibs.get_annot_notes(valid_aid_list))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">notes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="c"># convert a list of patterns into an or statement</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="s">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">pat</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">])</span>
    <span class="n">valid_index_list</span><span class="p">,</span> <span class="n">valid_match_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">search_list</span><span class="p">(</span><span class="n">notes_list</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="c">#[match.group() for match in valid_match_list]</span>
    <span class="n">valid_aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">valid_index_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">valid_aid_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="filter_aids_to_quality"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_aids_to_quality">[docs]</a><span class="k">def</span> <span class="nf">filter_aids_to_quality</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">minqual</span><span class="p">,</span> <span class="n">unknown_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">qual_flags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_quality_filterflags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">minqual</span><span class="p">,</span> <span class="n">unknown_ok</span><span class="o">=</span><span class="n">unknown_ok</span><span class="p">))</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">qual_flags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list_</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="filter_aids_to_viewpoint"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_aids_to_viewpoint">[docs]</a><span class="k">def</span> <span class="nf">filter_aids_to_viewpoint</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">valid_yaws</span><span class="p">,</span> <span class="n">unknown_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes aids that do not have a valid yaw</span>

<span class="sd">    TODO: rename to valid_viewpoint because this func uses category labels</span>

<span class="sd">    valid_yaws = [&#39;primary&#39;, &#39;primary1&#39;, &#39;primary-1&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">rectify_view_category</span><span class="p">(</span><span class="n">view</span><span class="p">):</span>
        <span class="nd">@ut.memoize</span>
        <span class="k">def</span> <span class="nf">_primary_species</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_primary_database_species</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;primary&#39;</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">get_primary_species_viewpoint</span><span class="p">(</span><span class="n">_primary_species</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;primary1&#39;</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">get_primary_species_viewpoint</span><span class="p">(</span><span class="n">_primary_species</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;primary-1&#39;</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">get_primary_species_viewpoint</span><span class="p">(</span><span class="n">_primary_species</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">view</span>

    <span class="n">valid_yaws</span> <span class="o">=</span> <span class="p">[</span><span class="n">rectify_view_category</span><span class="p">(</span><span class="n">view</span><span class="p">)</span> <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">valid_yaws</span><span class="p">]</span>

    <span class="n">yaw_flags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_viewpoint_filterflags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">valid_yaws</span><span class="p">,</span> <span class="n">unknown_ok</span><span class="o">=</span><span class="n">unknown_ok</span><span class="p">))</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">yaw_flags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list_</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="remove_aids_of_viewpoint"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.remove_aids_of_viewpoint">[docs]</a><span class="k">def</span> <span class="nf">remove_aids_of_viewpoint</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">invalid_yaws</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes aids that do not have a valid yaw</span>

<span class="sd">    TODO; rename to valid_viewpoint because this func uses category labels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notyaw_flags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_viewpoint_filterflags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">invalid_yaws</span><span class="p">,</span> <span class="n">unknown_ok</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
    <span class="n">yaw_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">notyaw_flags</span><span class="p">)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">yaw_flags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list_</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="filter_aids_without_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_aids_without_name">[docs]</a><span class="k">def</span> <span class="nf">filter_aids_without_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove aids without names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
        <span class="n">flag_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_aid_unknown</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flag_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">is_aid_unknown</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list_</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="filter_annots_using_minimum_timedelta"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_annots_using_minimum_timedelta">[docs]</a><span class="k">def</span> <span class="nf">filter_annots_using_minimum_timedelta</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">min_timedelta</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Uses a dynamic program to find the maximum number of annotations that are</span>
<span class="sd">    above the minimum timedelta requirement.</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (?):</span>
<span class="sd">        min_timedelta (?):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-filter_annots_using_minimum_timedelta</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-filter_annots_using_minimum_timedelta --db PZ_Master1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.filter_aids_without_timestamps(aid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;Before&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs.print_annot_stats(aid_list, min_name_hourdist=True)</span>
<span class="sd">        &gt;&gt;&gt; min_timedelta = 60 * 60 * 24</span>
<span class="sd">        &gt;&gt;&gt; filtered_aids = filter_annots_using_minimum_timedelta(ibs, aid_list, min_timedelta)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;After&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs.print_annot_stats(filtered_aids, min_name_hourdist=True)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; ibeis.other.dbinfo.hackshow_names(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; ibeis.other.dbinfo.hackshow_names(ibs, filtered_aids)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
    <span class="c">#min_timedelta = 60 * 60 * 24</span>
    <span class="c">#min_timedelta = 60 * 10</span>
    <span class="n">grouped_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">unixtimes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes_asfloat</span><span class="p">,</span> <span class="n">grouped_aids</span><span class="p">)</span>
    <span class="n">chosen_idxs_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c"># Find the maximum size subset such that all timedeltas are less than a given value</span>
    <span class="k">for</span> <span class="n">unixtimes</span> <span class="ow">in</span> <span class="n">unixtimes_list</span><span class="p">:</span>
        <span class="n">chosen_idxs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">maximin_distance_subset1d</span><span class="p">(</span><span class="n">unixtimes</span><span class="p">,</span> <span class="n">min_thresh</span><span class="o">=</span><span class="n">min_timedelta</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c">#chsoen_idxs = ut.max_size_max_distance_subset(unixtimes, min_thresh=min_timedelta)</span>
        <span class="n">chosen_idxs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chosen_idxs</span><span class="p">)</span>
    <span class="n">filtered_groups</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">grouped_aids</span><span class="p">,</span> <span class="n">chosen_idxs_list</span><span class="p">)</span>
    <span class="n">filtered_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">filtered_groups</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">DEBUG2</span><span class="p">:</span>
        <span class="n">timedeltas</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annots_timedelta_list</span><span class="p">(</span><span class="n">filtered_groups</span><span class="p">)</span>
        <span class="n">min_timedeltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">dists</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span> <span class="k">for</span> <span class="n">dists</span> <span class="ow">in</span> <span class="n">timedeltas</span><span class="p">])</span>
        <span class="n">min_name_timedelta_stats</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">min_timedeltas</span><span class="p">,</span> <span class="n">use_nan</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;min_name_timedelta_stats = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">min_name_timedelta_stats</span><span class="p">),))</span>
    <span class="k">return</span> <span class="n">filtered_aids</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="filter_aids_without_timestamps"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_aids_without_timestamps">[docs]</a><span class="k">def</span> <span class="nf">filter_aids_without_timestamps</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes aids without timestamps</span>
<span class="sd">    aid_list = ibs.get_valid_aids()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unixtime_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">flag_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">unixtime</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">unixtime</span> <span class="ow">in</span> <span class="n">unixtime_list</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
        <span class="n">flag_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">flag_list</span><span class="p">)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list_</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="filter_aids_to_species"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.filter_aids_to_species">[docs]</a><span class="k">def</span> <span class="nf">filter_aids_to_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">species</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>
<span class="sd">        species (?):</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: aid_list_</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-filter_aids_to_species</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; species = ibeis.const.TEST_SPECIES.ZEB_GREVY</span>
<span class="sd">        &gt;&gt;&gt; aid_list_ = filter_aids_to_species(ibs, aid_list, species)</span>
<span class="sd">        &gt;&gt;&gt; result = &#39;aid_list_ = %r&#39; % (aid_list_,)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        aid_list_ = [9, 10]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">species_rowid</span>      <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_rowids_from_text</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
    <span class="n">species_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">is_valid_species</span>   <span class="o">=</span> <span class="p">[</span><span class="n">sid</span> <span class="o">==</span> <span class="n">species_rowid</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">species_rowid_list</span><span class="p">]</span>
    <span class="n">aid_list_</span>           <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">is_valid_species</span><span class="p">)</span>
    <span class="c">#flag_list = [species == species_text for species_text in ibs.get_annot_species(aid_list)]</span>
    <span class="c">#aid_list_ = ut.compress(aid_list, flag_list)</span>
    <span class="k">return</span> <span class="n">aid_list_</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="partition_annots_into_singleton_multiton"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.partition_annots_into_singleton_multiton">[docs]</a><span class="k">def</span> <span class="nf">partition_annots_into_singleton_multiton</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    aid_list = aid_list_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">singletons</span> <span class="o">=</span> <span class="p">[</span><span class="n">aids</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">multitons</span> <span class="o">=</span> <span class="p">[</span><span class="n">aids</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">singletons</span><span class="p">,</span> <span class="n">multitons</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="partition_annots_into_corresponding_groups"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.partition_annots_into_corresponding_groups">[docs]</a><span class="k">def</span> <span class="nf">partition_annots_into_corresponding_groups</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list1</span><span class="p">,</span> <span class="n">aid_list2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used for grouping one-vs-one training pairs and corerspondence filtering</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (ibeis.control.IBEISControl.IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list1 (int):  list of annotation ids</span>
<span class="sd">        aid_list2 (int):  list of annotation ids</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: 4 lists of lists. In the first two each list is a list of aids</span>
<span class="sd">            grouped by names and the names correspond with each other. In the</span>
<span class="sd">            last two are the annots that did not correspond with anything in</span>
<span class="sd">            the other list.</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-partition_annots_into_corresponding_groups</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; grouped_aids = list(map(list, ibs.group_annots_by_name(ibs.get_valid_aids())[0]))</span>
<span class="sd">        &gt;&gt;&gt; grouped_aids = [aids for aids in grouped_aids if len(aids) &gt; 3]</span>
<span class="sd">        &gt;&gt;&gt; # Get some overlapping groups</span>
<span class="sd">        &gt;&gt;&gt; import copy</span>
<span class="sd">        &gt;&gt;&gt; aids_group1 = copy.deepcopy((ut.get_list_column_slice(grouped_aids[0:5], slice(0, 2))))</span>
<span class="sd">        &gt;&gt;&gt; aids_group2 = copy.deepcopy((ut.get_list_column_slice(grouped_aids[2:7], slice(2, None))))</span>
<span class="sd">        &gt;&gt;&gt; # Ensure there is a singleton in each</span>
<span class="sd">        &gt;&gt;&gt; ut.delete_items_by_index(aids_group1[0], [0])</span>
<span class="sd">        &gt;&gt;&gt; ut.delete_items_by_index(aids_group2[-1], [0])</span>
<span class="sd">        &gt;&gt;&gt; aid_list1 = ut.flatten(aids_group1)</span>
<span class="sd">        &gt;&gt;&gt; aid_list2 = ut.flatten(aids_group2)</span>
<span class="sd">        &gt;&gt;&gt; #aid_list1 = [1, 2, 8, 9, 60]</span>
<span class="sd">        &gt;&gt;&gt; #aid_list2 = [3, 7, 20]</span>
<span class="sd">        &gt;&gt;&gt; groups = partition_annots_into_corresponding_groups(ibs, aid_list1, aid_list2)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.list_str(groups, label_list=[&#39;gt_grouped_aids1&#39;, &#39;gt_grouped_aids2&#39;, &#39;gf_grouped_aids1&#39;, &#39;gf_gropued_aids2&#39;])</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        gt_grouped_aids1 = [[10, 11], [17, 18], [22, 23]]</span>
<span class="sd">        gt_grouped_aids2 = [[12, 13, 14, 15], [19, 20, 21], [24, 25, 26]]</span>
<span class="sd">        gf_grouped_aids1 = [[2], [5, 6]]</span>
<span class="sd">        gf_gropued_aids2 = [[29, 30, 31, 32], [49]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#ibs.</span>
    <span class="kn">import</span> <span class="nn">ibeis.control.IBEISControl</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">IBEISControl</span><span class="o">.</span><span class="n">IBEISController</span><span class="p">)</span>
    <span class="c">#ibs</span>
    <span class="c">#ibs.get_ann</span>

    <span class="n">grouped_aids1</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">aid_list1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">grouped_aids1</span> <span class="o">=</span> <span class="p">[</span><span class="n">aids</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">grouped_aids1</span><span class="p">]</span>

    <span class="c"># Get the group of available aids that a reference aid could match</span>
    <span class="n">gropued_aids2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_groundtruth</span><span class="p">(</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">grouped_aids1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">daid_list</span><span class="o">=</span><span class="n">aid_list2</span><span class="p">,</span>
        <span class="n">noself</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># Flag if there is a correspondence</span>
    <span class="n">flag_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">gropued_aids2</span><span class="p">)]</span>

    <span class="c"># Corresonding lists of aids groups</span>
    <span class="n">gt_grouped_aids1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">grouped_aids1</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>
    <span class="n">gt_grouped_aids2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">gropued_aids2</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>

    <span class="c"># Non-corresponding lists of aids groups</span>
    <span class="n">gf_grouped_aids1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">grouped_aids1</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">flag_list</span><span class="p">))</span>
    <span class="c">#gf_aids1 = ut.flatten(gf_grouped_aids1)</span>
    <span class="n">gf_aids2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff_ordered</span><span class="p">(</span><span class="n">aid_list2</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">gt_grouped_aids2</span><span class="p">))</span>
    <span class="n">gf_grouped_aids2</span> <span class="o">=</span> <span class="p">[</span><span class="n">aids</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span>
                        <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">gf_aids2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="n">gt_grouped_aids1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">sorted</span><span class="p">,</span> <span class="n">gt_grouped_aids1</span><span class="p">))</span>
    <span class="n">gt_grouped_aids2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">sorted</span><span class="p">,</span> <span class="n">gt_grouped_aids2</span><span class="p">))</span>
    <span class="n">gf_grouped_aids1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">sorted</span><span class="p">,</span> <span class="n">gf_grouped_aids1</span><span class="p">))</span>
    <span class="n">gf_grouped_aids2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">sorted</span><span class="p">,</span> <span class="n">gf_grouped_aids2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">gt_grouped_aids1</span><span class="p">,</span> <span class="n">gt_grouped_aids2</span><span class="p">,</span> <span class="n">gf_grouped_aids1</span><span class="p">,</span> <span class="n">gf_grouped_aids2</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="dans_lists"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.dans_lists">[docs]</a><span class="k">def</span> <span class="nf">dans_lists</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">positives</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">negatives</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">shuffle</span>

    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">yaw_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">qua_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">sex_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_sex_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">age_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_age_months_est</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>

    <span class="n">positive_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">aid</span>
        <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">yaw</span><span class="p">,</span> <span class="n">qua</span><span class="p">,</span> <span class="n">sex</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span>
        <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">yaw_list</span><span class="p">,</span> <span class="n">qua_list</span><span class="p">,</span> <span class="n">sex_list</span><span class="p">,</span> <span class="n">age_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">yaw</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;LEFT&#39;</span> <span class="ow">and</span>
            <span class="n">qua</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;OK&#39;</span><span class="p">,</span> <span class="s">&#39;GOOD&#39;</span><span class="p">,</span> <span class="s">&#39;EXCELLENT&#39;</span><span class="p">]</span> <span class="ow">and</span>
            <span class="n">sex</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;MALE&#39;</span><span class="p">,</span> <span class="s">&#39;FEMALE&#39;</span><span class="p">]</span> <span class="ow">and</span>
            <span class="n">start</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="n">negative_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">aid</span>
        <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">yaw</span><span class="p">,</span> <span class="n">qua</span><span class="p">,</span> <span class="n">sex</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">yaw_list</span><span class="p">,</span>
                                                    <span class="n">qua_list</span><span class="p">,</span> <span class="n">sex_list</span><span class="p">,</span>
                                                    <span class="n">age_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">yaw</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;LEFT&#39;</span> <span class="ow">and</span>
            <span class="n">qua</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;OK&#39;</span><span class="p">,</span> <span class="s">&#39;GOOD&#39;</span><span class="p">,</span> <span class="s">&#39;EXCELLENT&#39;</span><span class="p">]</span> <span class="ow">and</span>
            <span class="n">sex</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;UNKNOWN SEX&#39;</span> <span class="ow">and</span>
            <span class="n">start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="n">shuffle</span><span class="p">(</span><span class="n">positive_list</span><span class="p">)</span>
    <span class="n">shuffle</span><span class="p">(</span><span class="n">negative_list</span><span class="p">)</span>

    <span class="n">positive_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">positive_list</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">negative_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">negative_list</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">pos_yaw_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">positive_list</span><span class="p">)</span>
        <span class="n">pos_qua_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">positive_list</span><span class="p">)</span>
        <span class="n">pos_sex_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_sex_texts</span><span class="p">(</span><span class="n">positive_list</span><span class="p">)</span>
        <span class="n">pos_age_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_age_months_est</span><span class="p">(</span><span class="n">positive_list</span><span class="p">)</span>
        <span class="n">pos_chip_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chip_fpath</span><span class="p">(</span><span class="n">positive_list</span><span class="p">)</span>

        <span class="n">neg_yaw_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">negative_list</span><span class="p">)</span>
        <span class="n">neg_qua_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">negative_list</span><span class="p">)</span>
        <span class="n">neg_sex_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_sex_texts</span><span class="p">(</span><span class="n">negative_list</span><span class="p">)</span>
        <span class="n">neg_age_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_age_months_est</span><span class="p">(</span><span class="n">negative_list</span><span class="p">)</span>
        <span class="n">neg_chip_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chip_fpath</span><span class="p">(</span><span class="n">negative_list</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;positive_aid_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">positive_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;positive_yaw_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos_yaw_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;positive_qua_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos_qua_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;positive_sex_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos_sex_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;positive_age_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos_age_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;positive_chip_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos_chip_list</span><span class="p">,</span> <span class="p">))</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">90</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;negative_aid_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">negative_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;negative_yaw_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">neg_yaw_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;negative_qua_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">neg_qua_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;negative_sex_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">neg_sex_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;negative_age_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">neg_age_list</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;negative_chip_list = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">neg_chip_list</span><span class="p">,</span> <span class="p">))</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;mkdir ~/Desktop/chips&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pos_chip</span> <span class="ow">in</span> <span class="n">pos_chip_list</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;cp &quot;</span><span class="si">%s</span><span class="s">&quot; ~/Desktop/chips/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos_chip</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">for</span> <span class="n">neg_chip</span> <span class="ow">in</span> <span class="n">neg_chip_list</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;cp &quot;</span><span class="si">%s</span><span class="s">&quot; ~/Desktop/chips/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">neg_chip</span><span class="p">,</span> <span class="p">))</span>

    <span class="k">return</span> <span class="n">positive_list</span><span class="p">,</span> <span class="n">negative_list</span>

</div>
<span class="k">def</span> <span class="nf">_stat_str</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
    <span class="n">dict_</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">dict_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;num_nan&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">dict_</span><span class="p">[</span><span class="s">&#39;num_nan&#39;</span><span class="p">]</span>
    <span class="n">exclude_keys</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c"># [&#39;std&#39;, &#39;nMin&#39;, &#39;nMax&#39;]</span>
    <span class="k">if</span> <span class="n">multi</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">str_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">strvals</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">str_</span> <span class="o">=</span>  <span class="n">ut</span><span class="o">.</span><span class="n">get_stats_str</span><span class="p">(</span><span class="n">stat_dict</span><span class="o">=</span><span class="n">dict_</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">,</span>
                                 <span class="n">exclude_keys</span><span class="o">=</span><span class="n">exclude_keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">str_</span> <span class="o">=</span> <span class="n">str_</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">str_</span> <span class="o">=</span> <span class="n">str_</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;num_nan: 0, &#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">str_</span>


<span class="c"># Quality and Viewpoint Stats</span>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_qual_stats"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_qual_stats">[docs]</a><span class="k">def</span> <span class="nf">get_annot_qual_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">annot_qualtext_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">qualtext2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">annot_qualtext_list</span><span class="p">)</span>
    <span class="n">qual_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">QUALITY_TEXT_TO_INT</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">qual_keys</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">qualtext2_aids</span><span class="p">),</span> <span class="p">(</span>
        <span class="s">&#39;bad keys: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">qualtext2_aids</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">qual_keys</span><span class="p">)))</span>
    <span class="n">qualtext2_nAnnots</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">qualtext2_aids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">qual_keys</span><span class="p">])</span>
    <span class="c"># Filter 0&#39;s</span>
    <span class="n">qualtext2_nAnnots</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">qualtext2_nAnnots</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">qualtext2_nAnnots</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_yaw_stats"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_yaw_stats">[docs]</a><span class="k">def</span> <span class="nf">get_annot_yaw_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">annot_yawtext_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">yawtext2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">annot_yawtext_list</span><span class="p">)</span>
    <span class="c"># Order keys</span>
    <span class="n">yaw_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">VIEWTEXT_TO_YAW_RADIANS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">yaw_keys</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">annot_yawtext_list</span><span class="p">),</span> <span class="p">(</span>
        <span class="s">&#39;bad keys: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">annot_yawtext_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">yaw_keys</span><span class="p">)))</span>
    <span class="n">yawtext2_nAnnots</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
        <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">yawtext2_aids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">yaw_keys</span><span class="p">])</span>
    <span class="c"># Filter 0&#39;s</span>
    <span class="n">yawtext2_nAnnots</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">const</span><span class="o">.</span><span class="n">YAWALIAS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="n">val</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">yawtext2_nAnnots</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="p">}</span>
    <span class="c">#yawtext2_nAnnots = {key: val for key, val in six.iteritems(yawtext2_nAnnots) if val != 0}</span>
    <span class="k">return</span> <span class="n">yawtext2_nAnnots</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_intermediate_viewpoint_stats"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_intermediate_viewpoint_stats">[docs]</a><span class="k">def</span> <span class="nf">get_annot_intermediate_viewpoint_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; aids = available_aids</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">getter_func</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span>
    <span class="n">prop_basis</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">VIEWTEXT_TO_YAW_RADIANS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">group_annots_by_view_and_name</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_prop_and_name</span><span class="p">,</span> <span class="n">getter_func</span><span class="o">=</span><span class="n">getter_func</span><span class="p">)</span>
    <span class="n">group_annots_by_view</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_prop</span><span class="p">,</span>
                                             <span class="n">getter_func</span><span class="o">=</span><span class="n">getter_func</span><span class="p">)</span>

    <span class="n">prop2_nid2_aids</span> <span class="o">=</span> <span class="n">group_annots_by_view_and_name</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>

    <span class="n">edge2_nid2_aids</span> <span class="o">=</span> <span class="n">group_prop_edges</span><span class="p">(</span><span class="n">prop2_nid2_aids</span><span class="p">,</span> <span class="n">prop_basis</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># Total number of names that have two viewpoints</span>
    <span class="c">#yawtext_edge_nid_hist = ut.map_dict_vals(len, edge2_nid2_aids)</span>
    <span class="n">edge2_grouped_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_dict_vals</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dict_</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">edge2_nid2_aids</span><span class="p">)</span>
    <span class="n">edge2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_dict_vals</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">,</span> <span class="n">edge2_grouped_aids</span><span class="p">)</span>
    <span class="c"># Num annots of each type of viewpoint</span>
    <span class="c">#yawtext_edge_aidyawtext_hist = ut.map_dict_vals(ut.dict_hist,</span>
    <span class="c">#ut.map_dict_vals(getter_func, yawtext_edge_aid))</span>

    <span class="c"># Regroup by view and name</span>
    <span class="n">edge2_vp2_pername_stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">edge2_vp2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_dict_vals</span><span class="p">(</span><span class="n">group_annots_by_view</span><span class="p">,</span> <span class="n">edge2_aids</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">vp2_aids</span> <span class="ow">in</span> <span class="n">edge2_vp2_aids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">vp2_pernam_stats</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_dict_vals</span><span class="p">(</span>
            <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annots_per_name_stats</span><span class="p">,</span> <span class="n">use_sum</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">vp2_aids</span><span class="p">)</span>
        <span class="n">edge2_vp2_pername_stats</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">vp2_pernam_stats</span>

    <span class="c">#yawtext_edge_numaids_hist = ut.map_dict_vals(len, yawtext_edge_aid)</span>
    <span class="c">#yawtext_edge_aid_viewpoint_stats_hist =</span>
    <span class="c">#ut.map_dict_vals(ibs.get_annot_yaw_stats, yawtext_edge_aid)</span>
    <span class="k">return</span> <span class="n">edge2_vp2_pername_stats</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="group_annots_by_name_dict"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.group_annots_by_name_dict">[docs]</a><span class="k">def</span> <span class="nf">group_annots_by_name_dict</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">):</span>
    <span class="n">grouped_aids</span><span class="p">,</span> <span class="n">nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">nids</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">grouped_aids</span><span class="p">)))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="group_annots_by_prop"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.group_annots_by_prop">[docs]</a><span class="k">def</span> <span class="nf">group_annots_by_prop</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">getter_func</span><span class="p">):</span>
    <span class="c"># Make a dictionary that maps props into a dictionary of names to aids</span>
    <span class="n">annot_prop_list</span> <span class="o">=</span> <span class="n">getter_func</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
    <span class="n">prop2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">annot_prop_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prop2_aids</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="group_annots_by_prop_and_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.group_annots_by_prop_and_name">[docs]</a><span class="k">def</span> <span class="nf">group_annots_by_prop_and_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">getter_func</span><span class="p">):</span>
    <span class="c"># Make a dictionary that maps props into a dictionary of names to aids</span>
    <span class="n">prop2_aids</span> <span class="o">=</span> <span class="n">group_annots_by_prop</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">getter_func</span><span class="p">)</span>
    <span class="n">prop2_nid2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_dict_vals</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name_dict</span><span class="p">,</span> <span class="n">prop2_aids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prop2_nid2_aids</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="group_annots_by_multi_prop"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.group_annots_by_multi_prop">[docs]</a><span class="k">def</span> <span class="nf">group_annots_by_multi_prop</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">getter_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    Performs heirachical grouping of annotations based on properties</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aids (list):  list of annotation rowids</span>
<span class="sd">        getter_list (list):</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: multiprop2_aids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-group_annots_by_multi_prop --db PZ_Master1 --props=yaw_texts,name_rowids --keys1 frontleft</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-group_annots_by_multi_prop</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aids = ibs.get_valid_aids(is_known=True)</span>
<span class="sd">        &gt;&gt;&gt; #getter_list = [ibs.get_annot_name_rowids, ibs.get_annot_yaw_texts]</span>
<span class="sd">        &gt;&gt;&gt; props = ut.get_argval(&#39;--props&#39;, type_=list, default=[&#39;yaw_texts&#39;, &#39;name_rowids&#39;])</span>
<span class="sd">        &gt;&gt;&gt; getter_list = [getattr(ibs, &#39;get_annot_&#39; + prop) for prop in props]</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;getter_list = %r&#39; % (getter_list,))</span>
<span class="sd">        &gt;&gt;&gt; #getter_list = [ibs.get_annot_yaw_texts, ibs.get_annot_name_rowids]</span>
<span class="sd">        &gt;&gt;&gt; multiprop2_aids = group_annots_by_multi_prop(ibs, aids, getter_list)</span>
<span class="sd">        &gt;&gt;&gt; get_dict_values = lambda x: list(x.values())</span>
<span class="sd">        &gt;&gt;&gt; # a bit convoluted</span>
<span class="sd">        &gt;&gt;&gt; keys1 = ut.get_argval(&#39;--keys1&#39;, type_=list, default=list(multiprop2_aids.keys()))</span>
<span class="sd">        &gt;&gt;&gt; multiprop2_num_aids = ut.hmap_vals(len, multiprop2_aids)</span>
<span class="sd">        &gt;&gt;&gt; prop2_num_aids = ut.hmap_vals(get_dict_values, multiprop2_num_aids, max_depth=len(props) - 2)</span>
<span class="sd">        &gt;&gt;&gt; #prop2_num_aids_stats = ut.hmap_vals(ut.get_stats, prop2_num_aids)</span>
<span class="sd">        &gt;&gt;&gt; prop2_num_aids_hist = ut.hmap_vals(ut.dict_hist, prop2_num_aids)</span>
<span class="sd">        &gt;&gt;&gt; prop2_num_aids_cumhist = ut.map_dict_vals(ut.dict_hist_cumsum, prop2_num_aids_hist)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;prop2_num_aids_hist[%s] = %s&#39; % (keys1,  ut.dict_str(ut.dict_subset(prop2_num_aids_hist, keys1))))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;prop2_num_aids_cumhist[%s] = %s&#39; % (keys1,  ut.dict_str(ut.dict_subset(prop2_num_aids_cumhist, keys1))))</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aid_prop_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">getter</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="k">for</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">getter_list</span><span class="p">]</span>
    <span class="c">#%timeit multiprop2_aids = ut.hierarchical_group_items(aids, aid_prop_list)</span>
    <span class="c">#%timeit ut.group_items(aids, list(zip(*aid_prop_list)))</span>
    <span class="n">multiprop2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hierarchical_group_items</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">aid_prop_list</span><span class="p">)</span>
    <span class="c">#multiprop2_aids = ut.group_items(aids, list(zip(*aid_prop_list)))</span>
    <span class="k">return</span> <span class="n">multiprop2_aids</span>

</div>
<div class="viewcode-block" id="group_prop_edges"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.group_prop_edges">[docs]</a><span class="k">def</span> <span class="nf">group_prop_edges</span><span class="p">(</span><span class="n">prop2_nid2_aids</span><span class="p">,</span> <span class="n">prop_basis</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">    getter_func = ibs.get_annot_yaw_texts</span>
<span class="sd">    prop_basis = list(const.VIEWTEXT_TO_YAW_RADIANS.keys())</span>
<span class="sd">    size = 2</span>
<span class="sd">    wrap = True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Get intermediate viewpoints</span>
    <span class="c"># prop = yawtext</span>

    <span class="c"># Build a list of property edges (TODO: mabye include option for all pairwise combinations)</span>
    <span class="n">prop_edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iter_window</span><span class="p">(</span><span class="n">prop_basis</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="n">wrap</span><span class="p">))</span>
    <span class="n">edge2_nid2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">prop_edges</span><span class="p">:</span>
        <span class="n">edge_nid2_aids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">prop2_nid2_aids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">edge</span><span class="p">]</span>
        <span class="n">isect_nid2_aids</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span>
            <span class="c">#functools.partial(ut.dict_intersection, combine=True),</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">dict_isect_combine</span><span class="p">,</span>
            <span class="n">edge_nid2_aids_list</span><span class="p">)</span>
        <span class="n">edge2_nid2_aids</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">isect_nid2_aids</span>
        <span class="c">#common_nids = list(isect_nid2_aids.keys())</span>
        <span class="c">#common_num_prop1 = np.array([len(prop2_nid2_aids[prop1][nid]) for nid in common_nids])</span>
        <span class="c">#common_num_prop2 = np.array([len(prop2_nid2_aids[prop2][nid]) for nid in common_nids])</span>
    <span class="k">return</span> <span class="n">edge2_nid2_aids</span>


<span class="c"># Indepdentent query / database stats</span></div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_stats_dict"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_stats_dict">[docs]</a><span class="k">def</span> <span class="nf">get_annot_stats_dict</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">forceall</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; stats for a set of annots</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (ibeis.IBEISController):  ibeis controller object</span>
<span class="sd">        aids (list):  list of annotation rowids</span>
<span class="sd">        prefix (str): (default = &#39;&#39;)</span>

<span class="sd">    Kwargs:</span>
<span class="sd">        hashid, per_name, per_qual, per_vp, per_name_vpedge, per_image, min_name_hourdist</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: aid_stats_dict</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_annot_stats_dict</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_annot_stats_dict --db PZ_Master1 --per_name_vpedge=True</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_annot_stats_dict --db PZ_Master1 --min_name_hourdist=True</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_annot_stats_dict --db GZ_ALL --min_name_hourdist=True --all</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_annot_stats_dict --db PZ_Master1 --min_name_hourdist=True --all</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_annot_stats_dict --db NNP_MasterGIRM_core --min_name_hourdist=True --all</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aids = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; prefix = &#39;&#39;</span>
<span class="sd">        &gt;&gt;&gt; kwkeys = ut.parse_func_kwarg_keys(get_annot_stats_dict)</span>
<span class="sd">        &gt;&gt;&gt; #default = True if ut.get_argflag(&#39;--all&#39;) else None</span>
<span class="sd">        &gt;&gt;&gt; default = None if ut.get_argflag(&#39;--notall&#39;) else True</span>
<span class="sd">        &gt;&gt;&gt; kwargs = ut.argparse_dict(dict(zip(kwkeys, [default] * len(kwkeys))))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;kwargs = %r&#39; % (kwargs,))</span>
<span class="sd">        &gt;&gt;&gt; aid_stats_dict = get_annot_stats_dict(ibs, aids, prefix, **kwargs)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;aid_stats_dict = %s&#39; % (ut.dict_str(aid_stats_dict, strvals=True, nl=True),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">statwrap</span> <span class="o">=</span> <span class="n">_stat_str</span> <span class="k">if</span> <span class="n">old</span> <span class="k">else</span> <span class="n">ut</span><span class="o">.</span><span class="n">identity</span>

    <span class="k">def</span> <span class="nf">get_per_prop_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">getter_func</span><span class="p">):</span>
        <span class="n">prop2_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_prop</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">getter_func</span><span class="o">=</span><span class="n">getter_func</span><span class="p">)</span>
        <span class="n">num_None</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">None</span> <span class="ow">in</span> <span class="n">prop2_aids</span><span class="p">:</span>
            <span class="c"># Dont count invalid properties</span>
            <span class="n">num_None</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prop2_aids</span><span class="p">[</span><span class="bp">None</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">prop2_aids</span><span class="p">[</span><span class="bp">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;____&#39;</span> <span class="ow">in</span> <span class="n">prop2_aids</span><span class="p">:</span>
            <span class="n">num_None</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prop2_aids</span><span class="p">[</span><span class="s">&#39;____&#39;</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">prop2_aids</span><span class="p">[</span><span class="s">&#39;____&#39;</span><span class="p">]</span>
        <span class="n">num_aids_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">prop2_aids</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">num_aids_stats</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">num_aids_list</span><span class="p">,</span> <span class="n">use_nan</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_median</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c"># represent that Nones were removed</span>
        <span class="c"># num_aids_list += ([np.nan] * num_None)</span>
        <span class="c"># if num_None:</span>
        <span class="n">num_aids_stats</span><span class="p">[</span><span class="s">&#39;num_None&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_None</span>
        <span class="k">return</span> <span class="n">num_aids_stats</span>

    <span class="n">keyval_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s">&#39;num_&#39;</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;aids&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)),</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;bigstr&#39;</span><span class="p">,</span> <span class="bp">False</span> <span class="ow">or</span> <span class="n">forceall</span><span class="p">):</span>
        <span class="n">bigstr</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">truncate_str</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">truncmsg</span><span class="o">=</span><span class="s">&#39; ~TRUNC~ &#39;</span><span class="p">)</span>
        <span class="n">keyval_list</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;bigstr&#39;</span><span class="p">,</span>
             <span class="n">bigstr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">aids</span><span class="p">)))]</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;hashid&#39;</span><span class="p">,</span> <span class="bp">True</span> <span class="ow">or</span> <span class="n">forceall</span><span class="p">):</span>
        <span class="n">keyval_list</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;hashid&#39;</span><span class="p">,</span>
             <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_hashid_semantic_uuid</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">()))]</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;per_name&#39;</span><span class="p">,</span> <span class="bp">True</span> <span class="ow">or</span> <span class="n">forceall</span><span class="p">):</span>
        <span class="n">keyval_list</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;per_name&#39;</span><span class="p">,</span>
             <span class="n">statwrap</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_num_annots_per_name</span><span class="p">(</span><span class="n">aids</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">use_nan</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_median</span><span class="o">=</span><span class="bp">True</span><span class="p">)))]</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;per_qual&#39;</span><span class="p">,</span> <span class="bp">False</span> <span class="ow">or</span> <span class="n">forceall</span><span class="p">):</span>
        <span class="n">keyval_list</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;per_qual&#39;</span><span class="p">,</span>
                         <span class="n">statwrap</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_qual_stats</span><span class="p">(</span><span class="n">aids</span><span class="p">)))]</span>

    <span class="c">#if kwargs.pop(&#39;per_vp&#39;, False):</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;per_vp&#39;</span><span class="p">,</span> <span class="bp">True</span> <span class="ow">or</span> <span class="n">forceall</span><span class="p">):</span>
        <span class="n">keyval_list</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;per_vp&#39;</span><span class="p">,</span>
                         <span class="n">statwrap</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_stats</span><span class="p">(</span><span class="n">aids</span><span class="p">)))]</span>

    <span class="c"># information about overlapping viewpoints</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;per_name_vpedge&#39;</span><span class="p">,</span> <span class="bp">False</span> <span class="ow">or</span> <span class="n">forceall</span><span class="p">):</span>
        <span class="n">keyval_list</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;per_name_vpedge&#39;</span><span class="p">,</span>
             <span class="n">statwrap</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_intermediate_viewpoint_stats</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="n">multi</span><span class="o">=</span><span class="bp">True</span><span class="p">))]</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;enc_per_name&#39;</span><span class="p">,</span> <span class="bp">True</span> <span class="ow">or</span> <span class="n">forceall</span><span class="p">):</span>
        <span class="c"># Does not handle None encounters. They show up as just another encounter</span>
        <span class="n">name2_enctexts</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_encounter_text</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_names</span><span class="p">(</span><span class="n">aids</span><span class="p">))</span>
        <span class="n">encsets</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">name2_enctexts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">nEncs_per_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">encsets</span><span class="p">))</span>
        <span class="n">keyval_list</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;enc_per_name&#39;</span><span class="p">,</span>
             <span class="n">statwrap</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">nEncs_per_name</span><span class="p">,</span> <span class="n">use_nan</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_median</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
             <span class="p">)]</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;per_enc&#39;</span><span class="p">,</span> <span class="bp">True</span> <span class="ow">or</span> <span class="n">forceall</span><span class="p">):</span>
        <span class="n">keyval_list</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;per_enc&#39;</span><span class="p">,</span>
             <span class="n">statwrap</span><span class="p">(</span><span class="n">get_per_prop_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_encounter_text</span><span class="p">)))]</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;per_image&#39;</span><span class="p">,</span> <span class="bp">False</span> <span class="ow">or</span> <span class="n">forceall</span><span class="p">):</span>
        <span class="n">keyval_list</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;aid_per_image&#39;</span><span class="p">,</span>
             <span class="n">statwrap</span><span class="p">(</span><span class="n">get_per_prop_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_rowids</span><span class="p">)))]</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;case_tag_hist&#39;</span><span class="p">,</span> <span class="bp">False</span> <span class="ow">or</span> <span class="n">forceall</span><span class="p">):</span>
        <span class="n">keyval_list</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;case_tags&#39;</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_case_tags</span><span class="p">(</span><span class="n">aids</span><span class="p">))))]</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;match_tag_hist&#39;</span><span class="p">,</span> <span class="bp">False</span> <span class="ow">or</span> <span class="n">forceall</span><span class="p">):</span>
        <span class="n">keyval_list</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;match_tags&#39;</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_annotmatch_tags</span><span class="p">(</span><span class="n">aids</span><span class="p">))))]</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;min_name_hourdist&#39;</span><span class="p">,</span> <span class="bp">False</span> <span class="ow">or</span> <span class="n">forceall</span><span class="p">):</span>
        <span class="n">grouped_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">aids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c">#ibs.unflat_map(ibs.get_annot_image_unixtimes_asfloat, grouped_aids)</span>
        <span class="n">timedeltas</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annots_timedelta_list</span><span class="p">(</span><span class="n">grouped_aids</span><span class="p">)</span>
        <span class="c">#timedeltas = [dists for dists in timedeltas if dists is not np.nan and</span>
        <span class="c">#dists is not None]</span>
        <span class="c">#timedeltas = [np.nan if dists is None else dists for dists in timedeltas]</span>
        <span class="c">#min_timedelta_list = [np.nan if dists is None else dists.min() / (60 *</span>
        <span class="c">#60 * 24) for dists in timedeltas]</span>
        <span class="c"># convert to hours</span>
        <span class="n">min_timedelta_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">dists</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">dists</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dists</span> <span class="ow">in</span> <span class="n">timedeltas</span><span class="p">]</span>
        <span class="c">#min_timedelta_list = [np.nan if dists is None else dists.min() for dists in timedeltas]</span>
        <span class="n">min_name_timedelta_stats</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">min_timedelta_list</span><span class="p">,</span> <span class="n">use_nan</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">keyval_list</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;min_name_hourdist&#39;</span><span class="p">,</span> <span class="n">_stat_str</span><span class="p">(</span><span class="n">min_name_timedelta_stats</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">))]</span>

    <span class="n">aid_stats_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span><span class="n">keyval_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_stats_dict</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_annot_stats"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_annot_stats">[docs]</a><span class="k">def</span> <span class="nf">print_annot_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">aid_stats_dict</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_stats_dict</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">label</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">aid_stats_dict</span><span class="p">,</span> <span class="n">strvals</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="compare_nested_props"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compare_nested_props">[docs]</a><span class="k">def</span> <span class="nf">compare_nested_props</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids1_list</span><span class="p">,</span>
                         <span class="n">aids2_list</span><span class="p">,</span> <span class="n">getter_func</span><span class="p">,</span>
                         <span class="n">cmp_func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares properties of query vs database annotations</span>

<span class="sd">    grouped_qaids = aids1_list</span>
<span class="sd">    grouped_groundtruth_list = aids2_list</span>

<span class="sd">    getter_func = ibs.get_annot_yaws</span>
<span class="sd">    cmp_func = vt.ori_distance</span>

<span class="sd">    getter_func = ibs.get_annot_image_unixtimes_asfloat</span>
<span class="sd">    cmp_func = ut.unixtime_hourdiff</span>

<span class="sd">    ExpandNestedComparisions:</span>
<span class="sd">        import itertools</span>
<span class="sd">        list(map(list, itertools.starmap(ut.iprod, zip(aids1_list, aids2_list))))</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aids1_list (list):</span>
<span class="sd">        aids2_list (list):</span>
<span class="sd">        getter_func (?):</span>
<span class="sd">        cmp_func (?):</span>

<span class="sd">    Returns:</span>
<span class="sd">        list of ndarrays:</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-compare_nested_props --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aids1_list = [ibs.get_valid_aids()[8:11]]</span>
<span class="sd">        &gt;&gt;&gt; aids2_list = [ibs.get_valid_aids()[8:11]]</span>
<span class="sd">        &gt;&gt;&gt; getter_func = ibs.get_annot_image_unixtimes_asfloat</span>
<span class="sd">        &gt;&gt;&gt; cmp_func = ut.unixtime_hourdiff</span>
<span class="sd">        &gt;&gt;&gt; result = compare_nested_props(ibs, aids1_list, aids2_list, getter_func, cmp_func)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">replace_none_with_nan</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">replace_nones</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>

    <span class="n">props1_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">getter_func</span><span class="p">,</span> <span class="n">aids1_list</span><span class="p">)</span>
    <span class="n">props1_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">replace_none_with_nan</span><span class="p">,</span> <span class="n">props1_list</span><span class="p">)</span>

    <span class="n">props2_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">getter_func</span><span class="p">,</span> <span class="n">aids2_list</span><span class="p">)</span>
    <span class="n">props2_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">replace_none_with_nan</span><span class="p">,</span> <span class="n">props2_list</span><span class="p">)</span>
    <span class="c"># Compare the query yaws to the yaws of its correct matches in the database</span>
    <span class="n">propdist_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">cmp_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qprops</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gt_props</span><span class="p">)[:,</span> <span class="bp">None</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">qprops</span><span class="p">,</span> <span class="n">gt_props</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">props1_list</span><span class="p">,</span> <span class="n">props2_list</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">propdist_list</span>

</div>
<div class="viewcode-block" id="viewpoint_diff"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.viewpoint_diff">[docs]</a><span class="k">def</span> <span class="nf">viewpoint_diff</span><span class="p">(</span><span class="n">ori1</span><span class="p">,</span> <span class="n">ori2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; convert distance in radians to distance in viewpoint category &quot;&quot;&quot;</span>
    <span class="n">TAU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">ori_diff</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ori_distance</span><span class="p">(</span><span class="n">ori1</span><span class="p">,</span> <span class="n">ori2</span><span class="p">)</span>
    <span class="n">viewpoint_diff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">VIEWTEXT_TO_YAW_RADIANS</span><span class="p">)</span> <span class="o">*</span> <span class="n">ori_diff</span> <span class="o">/</span> <span class="n">TAU</span>
    <span class="k">return</span> <span class="n">viewpoint_diff</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_per_name_stats"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_per_name_stats">[docs]</a><span class="k">def</span> <span class="nf">get_annot_per_name_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;  stats about this set of aids &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_num_annots_per_name</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">use_nan</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="print_annotconfig_stats"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_annotconfig_stats">[docs]</a><span class="k">def</span> <span class="nf">print_annotconfig_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SeeAlso:</span>
<span class="sd">        ibs.get_annotconfig_stats</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotconfig_stats</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annotconfig_stats"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annotconfig_stats">[docs]</a><span class="k">def</span> <span class="nf">get_annotconfig_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Gets statistics about a query / database set of annotations</span>

<span class="sd">    USEFUL DEVELOPER FUNCTION</span>

<span class="sd">    TODO: this function should return non-string values in dictionaries.</span>
<span class="sd">    The print function should do string conversions</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        qaids (list):  query annotation ids</span>
<span class="sd">        daids (list):  database annotation ids</span>

<span class="sd">    SeeAlso:</span>
<span class="sd">        ibeis.dbinfo.print_qd_info</span>
<span class="sd">        ibs.get_annot_stats_dict</span>
<span class="sd">        ibs.print_annotconfig_stats(qaid_list, daid_list)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_annotconfig_stats --db PZ_MTEST -a default</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_annotconfig_stats --db testdb1  -a default</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_annotconfig_stats --db PZ_MTEST -a controlled</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_annotconfig_stats --db PZ_FlankHack -a default:qaids=allgt</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_annotconfig_stats --db PZ_MTEST -a controlled:per_name=2,min_gt=4</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.init import main_helpers</span>
<span class="sd">        &gt;&gt;&gt; kwargs = {&#39;per_enc&#39;: True, &#39;enc_per_name&#39;: True}</span>
<span class="sd">        &gt;&gt;&gt; ibs, qaids, daids = main_helpers.testdata_expanded_aids(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; _ = get_annotconfig_stats(ibs, qaids, daids, **kwargs)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">warnings</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s">&#39;ignore&#39;</span><span class="p">,</span> <span class="s">r&#39;All-NaN (slice|axis) imageseted&#39;</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s">&#39;ignore&#39;</span><span class="p">,</span> <span class="s">r&#39;Mean of empty slice&#39;</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s">&#39;ignore&#39;</span><span class="p">,</span> <span class="s">r&#39;Degrees of freedom &lt;= 0 for slice.&#39;</span><span class="p">)</span>

        <span class="c"># The aids that should be matched by a query</span>
        <span class="n">grouped_qaids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">qaids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">grouped_groundtruth_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_groundtruth</span><span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">grouped_qaids</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">daid_list</span><span class="o">=</span><span class="n">daids</span><span class="p">)</span>
        <span class="n">groundtruth_daids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique_unordered</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">grouped_groundtruth_list</span><span class="p">))</span>
        <span class="n">hasgt_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_has_groundtruth</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">daid_list</span><span class="o">=</span><span class="n">daids</span><span class="p">)</span>
        <span class="c"># The aids that should not match any query</span>
        <span class="n">nonquery_daids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">daids</span><span class="p">,</span> <span class="n">qaids</span><span class="p">),</span> <span class="n">groundtruth_daids</span><span class="p">)</span>
        <span class="c"># The query aids that should not get any match</span>
        <span class="n">unmatchable_queries</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">hasgt_list</span><span class="p">))</span>
        <span class="c"># The query aids that should not have a match</span>
        <span class="n">matchable_queries</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">hasgt_list</span><span class="p">)</span>

        <span class="c"># Find the daids that are in the same occurrence as the qaids</span>
        <span class="c"># if False:</span>
        <span class="n">query_encs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_encounter_text</span><span class="p">(</span><span class="n">qaids</span><span class="p">))</span>
        <span class="n">data_encs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_encounter_text</span><span class="p">(</span><span class="n">daids</span><span class="p">))</span>
        <span class="n">enc_intersect</span> <span class="o">=</span> <span class="n">query_encs</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">data_encs</span><span class="p">)</span>
        <span class="n">enc_intersect</span><span class="o">.</span><span class="n">difference_update</span><span class="p">({</span><span class="bp">None</span><span class="p">})</span>
        <span class="c"># import operator as op</span>
        <span class="c"># compare_nested_props(</span>
        <span class="c">#     ibs, grouped_qaids, grouped_groundtruth_list, ibs.get_annot_encounter_text, op.eq)</span>

        <span class="c"># Intersection on a per name basis</span>
        <span class="n">imposter_daid_per_name_stats</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_per_name_stats</span><span class="p">(</span><span class="n">nonquery_daids</span><span class="p">)</span>
        <span class="n">genuine_daid_per_name_stats</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_per_name_stats</span><span class="p">(</span><span class="n">groundtruth_daids</span><span class="p">)</span>
        <span class="n">all_daid_per_name_stats</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_per_name_stats</span><span class="p">(</span><span class="n">daids</span><span class="p">)</span>
        <span class="c">#imposter_daid_per_name_stats =</span>
        <span class="c">#ut.get_stats(ibs.get_num_annots_per_name(nonquery_daids)[0],</span>
        <span class="c">#             use_nan=True)</span>
        <span class="c">#genuine_daid_per_name_stats  =</span>
        <span class="c">#ut.get_stats(ibs.get_num_annots_per_name(groundtruth_daids)[0],</span>
        <span class="c">#             use_nan=True)</span>
        <span class="c">#all_daid_per_name_stats = ut.get_stats(ibs.get_num_annots_per_name(daids)[0], use_nan=True)</span>

        <span class="c"># Compare the query yaws to the yaws of its correct matches in the database</span>
        <span class="c"># For each name there will be nQaids:nid x nDaids:nid comparisons</span>
        <span class="n">gt_viewdist_list</span> <span class="o">=</span> <span class="n">compare_nested_props</span><span class="p">(</span>
            <span class="n">ibs</span><span class="p">,</span> <span class="n">grouped_qaids</span><span class="p">,</span> <span class="n">grouped_groundtruth_list</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaws</span><span class="p">,</span> <span class="n">viewpoint_diff</span><span class="p">)</span>

        <span class="c"># Compare the query qualities to the qualities of its correct matches in the database</span>
        <span class="n">gt_qualdists_list</span> <span class="o">=</span> <span class="n">compare_nested_props</span><span class="p">(</span>
            <span class="n">ibs</span><span class="p">,</span> <span class="n">grouped_qaids</span><span class="p">,</span> <span class="n">grouped_groundtruth_list</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_qualities</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">absdiff</span><span class="p">)</span>

        <span class="c"># Compare timedelta differences</span>
        <span class="n">gt_hourdelta_list</span> <span class="o">=</span> <span class="n">compare_nested_props</span><span class="p">(</span>
            <span class="n">ibs</span><span class="p">,</span> <span class="n">grouped_qaids</span><span class="p">,</span> <span class="n">grouped_groundtruth_list</span><span class="p">,</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes_asfloat</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">unixtime_hourdiff</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">super_flatten</span><span class="p">(</span><span class="n">arr_list</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
            <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">arr</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arr_list</span><span class="p">])</span>

        <span class="n">gt_viewdist_stats</span>   <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">super_flatten</span><span class="p">(</span><span class="n">gt_viewdist_list</span><span class="p">),</span> <span class="n">use_nan</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">gt_qualdist_stats</span>  <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">super_flatten</span><span class="p">(</span><span class="n">gt_qualdists_list</span><span class="p">),</span> <span class="n">use_nan</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">gt_hourdelta_stats</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">super_flatten</span><span class="p">(</span><span class="n">gt_hourdelta_list</span><span class="p">),</span> <span class="n">use_nan</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">qaids2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qaids</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">daids2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">daids</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">qaids2</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">daids2</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">qaids2</span> <span class="o">==</span> <span class="n">qaids</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;WARNING: qaids are not sorted&#39;</span><span class="p">)</span>
            <span class="c">#raise AssertionError(&#39;WARNING: qaids are not sorted&#39;)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">daids2</span> <span class="o">==</span> <span class="n">daids</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;WARNING: daids are not sorted&#39;</span><span class="p">)</span>
            <span class="c">#raise AssertionError(&#39;WARNING: qaids are not sorted&#39;)</span>

        <span class="n">qaid_stats_dict</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_stats_dict</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="s">&#39;q&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">daid_stats_dict</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_stats_dict</span><span class="p">(</span><span class="n">daids</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># Intersections between qaids and daids</span>
        <span class="n">common_aids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">daids</span><span class="p">,</span> <span class="n">qaids</span><span class="p">)</span>

        <span class="n">qnids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique_unordered</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">qaids</span><span class="p">))</span>
        <span class="n">dnids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique_unordered</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">daids</span><span class="p">))</span>
        <span class="n">common_nids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">qnids</span><span class="p">,</span> <span class="n">dnids</span><span class="p">)</span>

        <span class="n">annotconfig_stats_strs_list1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">annotconfig_stats_strs_list2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">annotconfig_stats_strs_list1</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;dbname&#39;</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()),</span>
            <span class="p">(</span><span class="s">&#39;num_qaids&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qaids</span><span class="p">))),</span>
            <span class="p">(</span><span class="s">&#39;num_daids&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">daids</span><span class="p">))),</span>
            <span class="p">(</span><span class="s">&#39;num_annot_intersect&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">common_aids</span><span class="p">))),</span>
        <span class="p">]</span>

        <span class="n">annotconfig_stats_strs_list1</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;qaid_stats&#39;</span><span class="p">,</span> <span class="n">qaid_stats_dict</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;daid_stats&#39;</span><span class="p">,</span> <span class="n">daid_stats_dict</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">combined</span><span class="p">:</span>
            <span class="n">combined_aids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">))))</span>
            <span class="n">combined_aids</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">annotconfig_stats_strs_list1</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s">&#39;combined_aids&#39;</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_stats_dict</span><span class="p">(</span><span class="n">combined_aids</span><span class="p">,</span>
                                                           <span class="o">**</span><span class="n">kwargs</span><span class="p">)),</span>
            <span class="p">]</span>

        <span class="n">annotconfig_stats_strs_list1</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;num_unmatchable_queries&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unmatchable_queries</span><span class="p">)),</span>
            <span class="p">(</span><span class="s">&#39;num_matchable_queries&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">matchable_queries</span><span class="p">)),</span>
            <span class="c">#(&#39;num_qnids&#39;, (len(qnids))),</span>
            <span class="c">#(&#39;num_dnids&#39;, (len(dnids))),</span>
            <span class="p">(</span><span class="s">&#39;num_enc_intersect&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">enc_intersect</span><span class="p">))),</span>
            <span class="p">(</span><span class="s">&#39;num_name_intersect&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">common_nids</span><span class="p">))),</span>
        <span class="p">]</span>

        <span class="n">annotconfig_stats_strs_list2</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="c"># Number of aids per name for everything in the database</span>
            <span class="c">#(&#39;per_name_&#39;, _stat_str(all_daid_per_name_stats)),</span>
            <span class="c"># Number of aids in each name that should match to a query</span>
            <span class="c"># (not quite sure how to phrase what this is)</span>
            <span class="p">(</span><span class="s">&#39;per_name_genuine&#39;</span><span class="p">,</span> <span class="n">_stat_str</span><span class="p">(</span><span class="n">genuine_daid_per_name_stats</span><span class="p">)),</span>
            <span class="c"># Number of aids in each name that should not match to any query</span>
            <span class="c"># (not quite sure how to phrase what this is)</span>
            <span class="p">(</span><span class="s">&#39;per_name_imposter&#39;</span><span class="p">,</span> <span class="n">_stat_str</span><span class="p">(</span><span class="n">imposter_daid_per_name_stats</span><span class="p">)),</span>
            <span class="c"># Distances between a query and its groundtruth</span>
            <span class="p">(</span><span class="s">&#39;viewdist&#39;</span><span class="p">,</span> <span class="n">_stat_str</span><span class="p">(</span><span class="n">gt_viewdist_stats</span><span class="p">)),</span>
            <span class="c">#(&#39;qualdist&#39;, _stat_str(gt_qualdist_stats)),</span>
            <span class="p">(</span><span class="s">&#39;hourdist&#39;</span><span class="p">,</span> <span class="n">_stat_str</span><span class="p">(</span><span class="n">gt_hourdelta_stats</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">)),</span>
        <span class="p">]</span>

        <span class="n">annotconfig_stats_strs1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span><span class="n">annotconfig_stats_strs_list1</span><span class="p">)</span>
        <span class="n">annotconfig_stats_strs2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span><span class="n">annotconfig_stats_strs_list2</span><span class="p">)</span>

        <span class="n">annotconfig_stats_strs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span><span class="n">annotconfig_stats_strs1</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span>
                                          <span class="n">annotconfig_stats_strs2</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">stats_str</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">annotconfig_stats_strs1</span><span class="p">,</span> <span class="n">strvals</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                <span class="n">newlines</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nobraces</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">stats_str</span> <span class="o">+=</span>  <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">annotconfig_stats_strs2</span><span class="p">,</span> <span class="n">strvals</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                         <span class="n">newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                         <span class="n">nobraces</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c">#stats_str = ut.align(stats_str, &#39;:&#39;)</span>
        <span class="n">stats_str2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">annotconfig_stats_strs</span><span class="p">,</span> <span class="n">strvals</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                 <span class="n">newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">nobraces</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;annot_config_stats = &#39;</span> <span class="o">+</span> <span class="n">stats_str2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">annotconfig_stats_strs</span><span class="p">,</span> <span class="nb">locals</span><span class="p">()</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_dbname_alias"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_dbname_alias">[docs]</a><span class="k">def</span> <span class="nf">get_dbname_alias</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convinience for plots</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">const</span><span class="o">.</span><span class="n">DBNAME_ALIAS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">dbname</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="find_unlabeled_name_members"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.find_unlabeled_name_members">[docs]</a><span class="k">def</span> <span class="nf">find_unlabeled_name_members</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Find annots where some members of a name have information but others do not.</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-find_unlabeled_name_members --qual</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;PZ_Master1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; defaultdict = dict(ut.parse_func_kwarg_keys(find_unlabeled_name_members, with_vals=True))</span>
<span class="sd">        &gt;&gt;&gt; kwargs = ut.argparse_dict(defaultdict)</span>
<span class="sd">        &gt;&gt;&gt; result = find_unlabeled_name_members(ibs, **kwargs)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">aids_list</span><span class="p">,</span> <span class="n">nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aids_list</span><span class="p">,</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">find_missing</span><span class="p">(</span><span class="n">props_list</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">):</span>
        <span class="n">missing_idx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_where</span><span class="p">([</span><span class="nb">any</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="k">for</span> <span class="n">flags</span> <span class="ow">in</span> <span class="n">flags_list</span><span class="p">])</span>
        <span class="n">missing_flag_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">flags_list</span><span class="p">,</span> <span class="n">missing_idx_list</span><span class="p">)</span>
        <span class="n">missing_aids_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">aids_list</span><span class="p">,</span> <span class="n">missing_idx_list</span><span class="p">)</span>
        <span class="c">#missing_prop_list = ut.take(props_list, missing_idx_list)</span>
        <span class="n">missing_aid_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">zipcompress</span><span class="p">(</span><span class="n">missing_aids_list</span><span class="p">,</span> <span class="n">missing_flag_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">missing_percent_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="k">for</span> <span class="n">flags</span> <span class="ow">in</span> <span class="n">missing_flag_list</span><span class="p">]</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Missing per name stats&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">missing_percent_list</span><span class="p">,</span> <span class="n">use_median</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">missing_aid_list</span>

    <span class="n">selected_aids_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">props_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes_asfloat</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
        <span class="n">flags_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">props</span><span class="p">)</span> <span class="k">for</span> <span class="n">props</span> <span class="ow">in</span> <span class="n">props_list</span><span class="p">]</span>
        <span class="n">missing_time_aid_list</span> <span class="o">=</span> <span class="n">find_missing</span><span class="p">(</span><span class="n">props_list</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;missing_time_aid_list = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_time_aid_list</span><span class="p">),))</span>
        <span class="n">selected_aids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">missing_time_aid_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;yaw&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">props_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaws</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
        <span class="n">flags_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">flag_None_items</span><span class="p">(</span><span class="n">props</span><span class="p">)</span> <span class="k">for</span> <span class="n">props</span> <span class="ow">in</span> <span class="n">props_list</span><span class="p">]</span>
        <span class="n">missing_yaw_aid_list</span> <span class="o">=</span> <span class="n">find_missing</span><span class="p">(</span><span class="n">props_list</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;num_names_missing_yaw = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_yaw_aid_list</span><span class="p">),))</span>
        <span class="n">selected_aids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">missing_yaw_aid_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;qual&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">props_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_qualities</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
        <span class="n">flags_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">p</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">p</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">props</span><span class="p">]</span> <span class="k">for</span> <span class="n">props</span> <span class="ow">in</span> <span class="n">props_list</span><span class="p">]</span>
        <span class="n">missing_qual_aid_list</span> <span class="o">=</span> <span class="n">find_missing</span><span class="p">(</span><span class="n">props_list</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;num_names_missing_qual = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_qual_aid_list</span><span class="p">),))</span>
        <span class="n">selected_aids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">missing_qual_aid_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;suspect_yaws&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">yaws_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaws</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
        <span class="n">time_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes_asfloat</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
        <span class="n">max_timedelta_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">safe_pdist</span><span class="p">(</span><span class="n">unixtime_arr</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">],</span> <span class="n">metric</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">absdiff</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">unixtime_arr</span> <span class="ow">in</span> <span class="n">time_list</span><span class="p">])</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">max_timedelta_list</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1</span>

        <span class="n">aids1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aids_list</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="n">max_yawdiff_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">safe_pdist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yaws</span><span class="p">)[:,</span> <span class="bp">None</span><span class="p">],</span> <span class="n">metric</span><span class="o">=</span><span class="n">vt</span><span class="o">.</span><span class="n">ori_distance</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">yaws</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">yaws_list</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="c"># Find annots with large timedeltas but 0 viewpoint difference</span>
        <span class="n">flags2</span> <span class="o">=</span> <span class="n">max_yawdiff_list</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">selected_aids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aids1</span><span class="p">,</span> <span class="n">flags2</span><span class="p">))</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">selected_aids_list</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>
    <span class="n">selected_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique_ordered</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">selected_aids</span>

    <span class="c">#ibs.unflat_map(ibs.get_annot_quality_texts, aids_list)</span>
    <span class="c">#ibs.unflat_map(ibs.get_annot_yaw_texts, aids_list)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="start_web_annot_groupreview"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.start_web_annot_groupreview">[docs]</a><span class="k">def</span> <span class="nf">start_web_annot_groupreview</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (list):  list of annotation rowids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.tag_funcs --exec-start_web_annot_groupreview --db PZ_Master1</span>
<span class="sd">        python -m ibeis.tag_funcs --exec-start_web_annot_groupreview --db GZ_Master1</span>
<span class="sd">        python -m ibeis.tag_funcs --exec-start_web_annot_groupreview --db GIRM_Master1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.tag_funcs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; #ibs = ibeis.opendb(defaultdb=&#39;PZ_Master1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;GZ_Master1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; # -----</span>
<span class="sd">        &gt;&gt;&gt; any_tags = ut.get_argval(&#39;--tags&#39;, type_=list, default=[&#39;Viewpoint&#39;])</span>
<span class="sd">        &gt;&gt;&gt; min_num = ut.get_argval(&#39;--min_num&#39;, type_=int, default=1)</span>
<span class="sd">        &gt;&gt;&gt; prop = any_tags[0]</span>
<span class="sd">        &gt;&gt;&gt; filtered_annotmatch_rowids = filter_annotmatch_by_tags(ibs, None, any_tags=any_tags, min_num=min_num)</span>
<span class="sd">        &gt;&gt;&gt; aid1_list = (ibs.get_annotmatch_aid1(filtered_annotmatch_rowids))</span>
<span class="sd">        &gt;&gt;&gt; aid2_list = (ibs.get_annotmatch_aid2(filtered_annotmatch_rowids))</span>
<span class="sd">        &gt;&gt;&gt; aid_list = list(set(ut.flatten([aid2_list, aid1_list])))</span>
<span class="sd">        &gt;&gt;&gt; result = start_web_annot_groupreview(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">ibeis.web</span>
    <span class="n">aid_strs</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)))</span>
    <span class="n">url_suffix</span> <span class="o">=</span> <span class="s">&#39;/group_review/?aid_list=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid_strs</span><span class="p">)</span>
    <span class="n">ibeis</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">start_from_ibeis</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">url_suffix</span><span class="o">=</span><span class="n">url_suffix</span><span class="p">,</span> <span class="n">browser</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_pair_lazy_dict"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_pair_lazy_dict">[docs]</a><span class="k">def</span> <span class="nf">get_annot_pair_lazy_dict</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">daid</span><span class="p">,</span> <span class="n">qconfig2_</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dconfig2_</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        qaid (int):  query annotation id</span>
<span class="sd">        daid (?):</span>
<span class="sd">        qconfig2_ (dict): (default = None)</span>
<span class="sd">        dconfig2_ (dict): (default = None)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_annot_pair_lazy_dict</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; qaid, daid = ibs.get_valid_aids()[0:2]</span>
<span class="sd">        &gt;&gt;&gt; qconfig2_ = None</span>
<span class="sd">        &gt;&gt;&gt; dconfig2_ = None</span>
<span class="sd">        &gt;&gt;&gt; result = get_annot_pair_lazy_dict(ibs, qaid, daid, qconfig2_, dconfig2_)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">LazyDict</span><span class="p">({</span>
        <span class="s">&#39;annot1&#39;</span><span class="p">:</span> <span class="n">get_annot_lazy_dict</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">qconfig2_</span><span class="p">),</span>
        <span class="s">&#39;annot2&#39;</span><span class="p">:</span> <span class="n">get_annot_lazy_dict</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">daid</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">dconfig2_</span><span class="p">),</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">metadata</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_lazy_dict"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_lazy_dict">[docs]</a><span class="k">def</span> <span class="nf">get_annot_lazy_dict</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (ibeis.IBEISController):  image analysis api</span>
<span class="sd">        aid (int):  annotation id</span>
<span class="sd">        config2_ (dict): (default = None)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ut.LazyDict: metadata</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_annot_lazy_dict --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid = 1</span>
<span class="sd">        &gt;&gt;&gt; config2_ = None</span>
<span class="sd">        &gt;&gt;&gt; metadata = get_annot_lazy_dict(ibs, aid, config2_)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;metadata = %s&#39; % (ut.repr3(metadata),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.viz.interact</span> <span class="kn">import</span> <span class="n">interact_chip</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">LazyDict</span><span class="p">({</span>
        <span class="s">&#39;aid&#39;</span><span class="p">:</span> <span class="n">aid</span><span class="p">,</span>
        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_names</span><span class="p">([</span><span class="n">aid</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s">&#39;rchip_fpath&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chip_fpath</span><span class="p">([</span><span class="n">aid</span><span class="p">],</span> <span class="n">config2_</span><span class="o">=</span><span class="n">config2_</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s">&#39;rchip&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chips</span><span class="p">([</span><span class="n">aid</span><span class="p">],</span> <span class="n">config2_</span><span class="o">=</span><span class="n">config2_</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s">&#39;vecs&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span>  <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">([</span><span class="n">aid</span><span class="p">],</span> <span class="n">config2_</span><span class="o">=</span><span class="n">config2_</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s">&#39;kpts&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span>  <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_kpts</span><span class="p">([</span><span class="n">aid</span><span class="p">],</span> <span class="n">config2_</span><span class="o">=</span><span class="n">config2_</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s">&#39;dlen_sqrd&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chip_dlensqrd</span><span class="p">([</span><span class="n">aid</span><span class="p">],</span> <span class="n">config2_</span><span class="o">=</span><span class="n">config2_</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s">&#39;annot_context_options&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">interact_chip</span><span class="o">.</span><span class="n">build_annot_context_options</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid</span><span class="p">),</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">metadata</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_lazy_dict2"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_lazy_dict2">[docs]</a><span class="k">def</span> <span class="nf">get_annot_lazy_dict2</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (ibeis.IBEISController):  image analysis api</span>
<span class="sd">        aid (int):  annotation id</span>
<span class="sd">        config (dict): (default = None)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ut.LazyDict: metadata</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --exec-get_annot_lazy_dict2 --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid = 1</span>
<span class="sd">        &gt;&gt;&gt; config = {&#39;dim_size&#39;: 450}</span>
<span class="sd">        &gt;&gt;&gt; metadata = get_annot_lazy_dict2(ibs, aid, config)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;metadata = %s&#39; % (ut.repr3(metadata),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.viz.interact</span> <span class="kn">import</span> <span class="n">interact_chip</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">LazyDict</span><span class="p">({</span>
        <span class="s">&#39;aid&#39;</span><span class="p">:</span> <span class="n">aid</span><span class="p">,</span>
        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_names</span><span class="p">(</span><span class="n">aid</span><span class="p">),</span>
        <span class="s">&#39;rchip_fpath&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">ibs</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;chips&#39;</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="s">&#39;img&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">read_extern</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="s">&#39;rchip&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">ibs</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;chips&#39;</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="s">&#39;img&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">),</span>
        <span class="s">&#39;vecs&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span>  <span class="n">ibs</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;feat&#39;</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="s">&#39;vecs&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">),</span>
        <span class="s">&#39;kpts&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span>  <span class="n">ibs</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;feat&#39;</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="s">&#39;kpts&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">),</span>
        <span class="s">&#39;dlen_sqrd&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">ibs</span><span class="o">.</span><span class="n">depc</span><span class="p">[</span><span class="s">&#39;chips&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">subproperties</span><span class="p">[</span><span class="s">&#39;dlen_sqrd&#39;</span><span class="p">](</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">depc</span><span class="p">,</span> <span class="p">[</span><span class="n">aid</span><span class="p">],</span> <span class="n">config</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="c">#get_annot_chip_dlensqrd([aid], config=config)[0],</span>
        <span class="s">&#39;annot_context_options&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">interact_chip</span><span class="o">.</span><span class="n">build_annot_context_options</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid</span><span class="p">),</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">metadata</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="execute_pipeline_test"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.execute_pipeline_test">[docs]</a><span class="k">def</span> <span class="nf">execute_pipeline_test</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">pipecfg_name_list</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">]):</span>
    <span class="kn">from</span> <span class="nn">ibeis.expt</span> <span class="kn">import</span> <span class="n">harness</span><span class="p">,</span> <span class="n">experiment_helpers</span>
    <span class="n">experiment_helpers</span>
    <span class="n">testnameid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pipecfg_name_list</span><span class="p">)</span>
    <span class="n">lbl</span> <span class="o">=</span> <span class="s">&#39;[harn] TEST_CFG &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pipecfg_name_list</span><span class="p">)</span>

    <span class="c"># Generate list of query pipeline param configs</span>
    <span class="n">cfgdict_list</span><span class="p">,</span> <span class="n">pipecfg_list</span> <span class="o">=</span> <span class="n">experiment_helpers</span><span class="o">.</span><span class="n">get_pipecfg_list</span><span class="p">(</span>
        <span class="n">pipecfg_name_list</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="n">ibs</span><span class="p">)</span>

    <span class="n">cfgx2_lbl</span> <span class="o">=</span> <span class="n">experiment_helpers</span><span class="o">.</span><span class="n">get_varied_pipecfg_lbls</span><span class="p">(</span><span class="n">cfgdict_list</span><span class="p">)</span>
    <span class="n">testres</span> <span class="o">=</span> <span class="n">harness</span><span class="o">.</span><span class="n">run_test_configurations</span><span class="p">(</span>
        <span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">pipecfg_list</span><span class="p">,</span> <span class="n">cfgx2_lbl</span><span class="p">,</span> <span class="n">cfgdict_list</span><span class="p">,</span> <span class="n">lbl</span><span class="p">,</span>
        <span class="n">testnameid</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">testres</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_imageset_expanded_aids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_imageset_expanded_aids">[docs]</a><span class="k">def</span> <span class="nf">get_imageset_expanded_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;lynx&#39;)</span>
<span class="sd">        &gt;&gt;&gt; a = [&#39;default:hack_imageset=True&#39;, ]</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.expt import experiment_helpers</span>
<span class="sd">        &gt;&gt;&gt; acfg_list, expanded_aids_list = experiment_helpers.get_annotcfg_list(ibs, [a[0]], use_cache=False)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; filter_kw = dict(been_adjusted=True)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.filter_annots_general(aid_list, filter_kw)</span>
<span class="sd">        &gt;&gt;&gt; qaid_list, daid_list = ibs.get_imageset_expanded_aids()</span>
<span class="sd">        &gt;&gt;&gt; #ibs.query_chips(qaid_list, daid_list)</span>
<span class="sd">        &gt;&gt;&gt; testres = ibs.execute_pipeline_test(qaid_list, daid_list)</span>
<span class="sd">        &gt;&gt;&gt; testres.print_perent_identification_success()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">filter_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">been_adjusted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_general</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(),</span> <span class="n">filter_kw</span><span class="p">)</span>
    <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_primary_imageset</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">multiprop2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hierarchical_group_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">imgsetid_list</span><span class="p">])</span>
    <span class="n">daid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">qaid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">imgsetid</span><span class="p">,</span> <span class="n">nid2_aids</span> <span class="ow">in</span> <span class="n">multiprop2_aids</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">daid_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">nid2_aids</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aids_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nid2_aids</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_argmax</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)))</span>
            <span class="n">qaids</span> <span class="o">=</span> <span class="n">aids_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">aids_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">daids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
            <span class="n">daid_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">daids</span><span class="p">)</span>
            <span class="n">qaid_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">qaids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_primary_imageset"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_primary_imageset">[docs]</a><span class="k">def</span> <span class="nf">get_annot_primary_imageset</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c"># TODO: make it better</span>
    <span class="n">imgsetids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_imgsetids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">flags_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">is_special_imageset</span><span class="p">,</span> <span class="n">imgsetids_list</span><span class="p">)</span>
    <span class="c"># GET IMAGESET QUERY STRUCTURE DATA</span>
    <span class="n">flags_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">)</span>
    <span class="n">imgsetids_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_zipcompress</span><span class="p">(</span><span class="n">imgsetids_list</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">)</span>
    <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">imgsetids_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">imgsetid_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<span class="nd">@profile</span>
<div class="viewcode-block" id="lookup_annot_vecs_subset"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.lookup_annot_vecs_subset">[docs]</a><span class="k">def</span> <span class="nf">lookup_annot_vecs_subset</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">unflat_aids</span><span class="p">,</span> <span class="n">unflat_fxs</span><span class="p">,</span> <span class="n">annots</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    unflat_aids = naids_list</span>
<span class="sd">    unflat_fxs = nfxs_list</span>
<span class="sd">    annots = data_annots</span>
<span class="sd">    config2_ = data_config2_</span>

<span class="sd">    unflat_aids = cm.filtnorm_aids[0]</span>
<span class="sd">    unflat_fxs  = cm.filtnorm_fxs[0]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">unflat_aids</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">annots</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="p">{</span><span class="n">aid</span><span class="p">:</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_lazy_dict</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">config2_</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">aids</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">annots</span><span class="p">[</span><span class="n">aid</span><span class="p">]</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_lazy_dict</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">config2_</span><span class="p">)</span>

    <span class="c">#for annot in annots.values():</span>
    <span class="c">#    annot.eager_eval(&#39;vecs&#39;)</span>

    <span class="k">def</span> <span class="nf">extract_vecs</span><span class="p">(</span><span class="n">annots</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">fxs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; custom_func(lazydict, key, subkeys) for multigroup_lookup &quot;&quot;&quot;</span>
        <span class="n">vecs</span> <span class="o">=</span> <span class="n">annots</span><span class="p">[</span><span class="n">aid</span><span class="p">][</span><span class="s">&#39;vecs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fxs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vecs</span>
    <span class="c">#unflat_vecs1 = vt.multigroup_lookup(annots, unflat_aids, unflat_fxs, extract_vecs)</span>
    <span class="c"># HACK</span>
    <span class="c"># FIXME: naive and regular multigroup still arnt equivalent</span>
    <span class="c">#unflat_vecs = unflat_vecs1 = [[] if len(x) == 1 and x[0] is None else x  for x in unflat_vecs1]</span>
    <span class="n">unflat_vecs</span> <span class="o">=</span>  <span class="n">unflat_vecs2</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">multigroup_lookup_naive</span><span class="p">(</span><span class="n">annots</span><span class="p">,</span> <span class="n">unflat_aids</span><span class="p">,</span> <span class="n">unflat_fxs</span><span class="p">,</span> <span class="n">extract_vecs</span><span class="p">)</span>  <span class="c"># NOQA</span>
    <span class="c"># import utool</span>
    <span class="c"># with utool.embed_on_exception_context:</span>
    <span class="c"># vt.sver_c_wrapper.asserteq(unflat_vecs1, unflat_vecs2)</span>
    <span class="c"># unflat_vecs = unflat_vecs2</span>
    <span class="c"># unflat_vecs = unflat_vecs1</span>
    <span class="c"># import utool</span>
    <span class="c"># utool.embed()</span>

    <span class="k">return</span> <span class="n">unflat_vecs</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_vecs_subset"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_vecs_subset">[docs]</a><span class="k">def</span> <span class="nf">get_annot_vecs_subset</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">fxs_list</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">vecs_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">config2_</span><span class="p">)</span>
    <span class="n">vecs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">vecs_list</span><span class="p">,</span> <span class="n">fxs_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vecs_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_fgweights_subset"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_fgweights_subset">[docs]</a><span class="k">def</span> <span class="nf">get_annot_fgweights_subset</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">fxs_list</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">fgweight_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_fgweights</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">config2_</span><span class="p">)</span>
    <span class="n">vecs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">fgweight_list</span><span class="p">,</span> <span class="n">fxs_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vecs_list</span>

</div>
<span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">_clean_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[_clean_species] Cleaning...&#39;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">ibeis.species</span> <span class="kn">import</span> <span class="n">species_mapping</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--readonly-mode&#39;</span><span class="p">):</span>
        <span class="c"># SUPER HACK</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="s">&#39;--allow-keyboard-database-update&#39;</span>
        <span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">input</span> <span class="k">as</span> <span class="n">raw_input_</span>
        <span class="kn">from</span> <span class="nn">ibeis.control.manual_species_funcs</span> <span class="kn">import</span> <span class="n">_convert_species_nice_to_code</span>
        <span class="n">species_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_species_rowids</span><span class="p">()</span>
        <span class="n">species_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_texts</span><span class="p">(</span><span class="n">species_rowid_list</span><span class="p">)</span>
        <span class="n">species_nice_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_nice</span><span class="p">(</span><span class="n">species_rowid_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rowid</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">nice</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">species_rowid_list</span><span class="p">,</span> <span class="n">species_text_list</span><span class="p">,</span> <span class="n">species_nice_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">species_mapping</span><span class="p">:</span>
                <span class="n">species_code</span><span class="p">,</span> <span class="n">species_nice</span> <span class="o">=</span> <span class="n">species_mapping</span><span class="p">[</span><span class="n">text</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">text</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">,</span> <span class="s">&#39;none&#39;</span><span class="p">,</span> <span class="s">&#39;None&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">]:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[_clean_species] deleting species: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">))</span>
                <span class="n">ibs</span><span class="o">.</span><span class="n">delete_species</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">nice</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="n">flag</span><span class="p">):</span>
                    <span class="n">species_nice</span> <span class="o">=</span> <span class="n">text</span>
                    <span class="n">species_code</span> <span class="o">=</span> <span class="n">_convert_species_nice_to_code</span><span class="p">([</span><span class="n">species_nice</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Found an unknown species: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">))</span>
                    <span class="n">species_nice</span> <span class="o">=</span> <span class="n">raw_input_</span><span class="p">(</span><span class="s">&#39;Input a NICE name for </span><span class="si">%r</span><span class="s">: &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">))</span>
                    <span class="n">species_code</span> <span class="o">=</span> <span class="n">raw_input_</span><span class="p">(</span><span class="s">&#39;Input a CODE name for </span><span class="si">%r</span><span class="s">: &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">))</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_code</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_nice</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">_set_species_nice</span><span class="p">([</span><span class="n">rowid</span><span class="p">],</span> <span class="p">[</span><span class="n">species_nice</span><span class="p">])</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">_set_species_code</span><span class="p">([</span><span class="n">rowid</span><span class="p">],</span> <span class="p">[</span><span class="n">species_code</span><span class="p">])</span>


<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_encounter_text"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_encounter_text">[docs]</a><span class="k">def</span> <span class="nf">get_annot_encounter_text</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Encounter identifier for annotations &quot;&quot;&quot;</span>
    <span class="n">occur_texts</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_occurrence_text</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
    <span class="n">name_texts</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_names</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
    <span class="n">enc_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">ot</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">nt</span> <span class="k">if</span> <span class="n">ot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">nt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">ot</span><span class="p">,</span> <span class="n">nt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">occur_texts</span><span class="p">,</span> <span class="n">name_texts</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">enc_texts</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="get_annot_occurrence_text"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_occurrence_text">[docs]</a><span class="k">def</span> <span class="nf">get_annot_occurrence_text</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Occurrence identifier for annotations &quot;&quot;&quot;</span>
    <span class="n">imgset_ids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_imgsetids</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
    <span class="n">imgset_texts</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">,</span> <span class="n">imgset_ids</span><span class="p">)</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="p">[[</span><span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;occurrence&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>
             <span class="k">for</span> <span class="n">texts</span> <span class="ow">in</span> <span class="n">imgset_texts</span><span class="p">]</span>
    <span class="n">_occur_texts</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">zipcompress</span><span class="p">(</span><span class="n">imgset_texts</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
    <span class="n">_occur_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">_occur_texts</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">_occur_texts</span><span class="p">]),</span> <span class="s">&#39;annot must be in exactly one occurrence&#39;</span>
    <span class="n">occur_texts</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">_occur_texts</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">occur_texts</span>

</div>
<span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">_parse_smart_xml</span><span class="p">(</span><span class="n">back</span><span class="p">,</span> <span class="n">xml_path</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c"># Storage for the patrol imagesets</span>
    <span class="n">xml_dir</span><span class="p">,</span> <span class="n">xml_name</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">xml_path</span><span class="p">)</span>
    <span class="n">imageset_info_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">last_photo_number</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">last_imageset_info</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># Parse the XML file for the information</span>
    <span class="n">patrol_tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xml_path</span><span class="p">)</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="s">&#39;{http://www.smartconservationsoftware.org/xml/1.1/patrol}&#39;</span>
    <span class="c"># Load all waypoint elements</span>
    <span class="n">element</span> <span class="o">=</span> <span class="s">&#39;.//</span><span class="si">%s</span><span class="s">waypoints&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">waypoint_list</span> <span class="o">=</span> <span class="n">patrol_tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">waypoint_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c"># raise IOError(&#39;There are no observations (waypoints) in this</span>
        <span class="c"># Patrol XML file: %r&#39; % (xml_path, ))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;There are no observations (waypoints) in this Patrol XML file: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">xml_path</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">for</span> <span class="n">waypoint</span> <span class="ow">in</span> <span class="n">waypoint_list</span><span class="p">:</span>
        <span class="c"># Get the relevant information about the waypoint</span>
        <span class="n">waypoint_id</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">waypoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">))</span>
        <span class="n">waypoint_lat</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">waypoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">))</span>
        <span class="n">waypoint_lon</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">waypoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">))</span>
        <span class="n">waypoint_time</span> <span class="o">=</span> <span class="n">waypoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">)</span>
        <span class="n">waypoint_info</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">xml_name</span><span class="p">,</span>
            <span class="n">waypoint_id</span><span class="p">,</span>
            <span class="p">(</span><span class="n">waypoint_lat</span><span class="p">,</span> <span class="n">waypoint_lon</span><span class="p">),</span>
            <span class="n">waypoint_time</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">None</span> <span class="ow">in</span> <span class="n">waypoint_info</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                <span class="s">&#39;The observation (waypoint) is missing information: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">waypoint_info</span><span class="p">,</span> <span class="p">))</span>
        <span class="c"># Get all of the waypoint&#39;s observations (we expect only one</span>
        <span class="c"># normally)</span>
        <span class="n">element</span> <span class="o">=</span> <span class="s">&#39;.//</span><span class="si">%s</span><span class="s">observations&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="p">)</span>
        <span class="n">observation_list</span> <span class="o">=</span> <span class="n">waypoint</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="c"># if len(observation_list) == 0:</span>
        <span class="c">#     raise IOError(&#39;There are no observations in this waypoint,</span>
        <span class="c">#     waypoint_id: %r&#39; % (waypoint_id, ))</span>
        <span class="k">for</span> <span class="n">observation</span> <span class="ow">in</span> <span class="n">observation_list</span><span class="p">:</span>
            <span class="c"># Filter the observations based on type, we only care</span>
            <span class="c"># about certain types</span>
            <span class="n">categoryKey</span> <span class="o">=</span> <span class="n">observation</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;categoryKey&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">categoryKey</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;animals.liveanimals&#39;</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">categoryKey</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;animals.problemanimal&#39;</span><span class="p">)):</span>
                <span class="c"># Get the photonumber attribute for the waypoint&#39;s</span>
                <span class="c"># observation</span>
                <span class="n">element</span> <span class="o">=</span> <span class="s">&#39;.//</span><span class="si">%s</span><span class="s">attributes[@attributeKey=&quot;photonumber&quot;]&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">namespace</span><span class="p">,</span> <span class="p">)</span>
                <span class="n">photonumber</span> <span class="o">=</span> <span class="n">observation</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">photonumber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">element</span> <span class="o">=</span> <span class="s">&#39;.//</span><span class="si">%s</span><span class="s">sValue&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="p">)</span>
                    <span class="c"># Get the value for photonumber</span>
                    <span class="n">sValue</span>  <span class="o">=</span> <span class="n">photonumber</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sValue</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                            <span class="p">(</span><span class="s">&#39;The photonumber sValue is missing from &#39;</span>
                             <span class="s">&#39;photonumber, waypoint_id: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">waypoint_id</span><span class="p">,</span> <span class="p">))</span>
                    <span class="c"># Python cast the value</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">photo_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sValue</span><span class="o">.</span><span class="n">text</span><span class="p">))</span> <span class="o">-</span> <span class="n">offset</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c"># raise IOError(&#39;The photonumber sValue is invalid,</span>
                        <span class="c"># waypoint_id: %r&#39; % (waypoint_id, ))</span>
                        <span class="k">print</span><span class="p">((</span><span class="s">&#39;[ibs]     &#39;</span>
                               <span class="s">&#39;Skipped Invalid Observation with &#39;</span>
                               <span class="s">&#39;photonumber: </span><span class="si">%r</span><span class="s">, waypoint_id: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">)</span>
                              <span class="o">%</span> <span class="p">(</span><span class="n">sValue</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">waypoint_id</span><span class="p">,</span> <span class="p">))</span>
                        <span class="k">continue</span>
                    <span class="c"># Check that the photo_number is within the acceptable bounds</span>
                    <span class="k">if</span> <span class="n">photo_number</span> <span class="o">&gt;=</span> <span class="n">nTotal</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                            <span class="s">&#39;The Patrol XML file is looking for images &#39;</span>
                            <span class="s">&#39;that do not exist (too few images given)&#39;</span><span class="p">)</span>
                    <span class="c"># Keep track of the last waypoint that was processed</span>
                    <span class="c"># becuase we only have photono, which indicates start</span>
                    <span class="c"># indices and doesn&#39;t specify the end index.  The</span>
                    <span class="c"># ending index is extracted as the next waypoint&#39;s</span>
                    <span class="c"># photonum minus 1.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">last_photo_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                         <span class="n">last_imageset_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                        <span class="n">imageset_info</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">last_imageset_info</span> <span class="o">+</span> <span class="p">[(</span><span class="n">last_photo_number</span><span class="p">,</span>
                                                    <span class="n">photo_number</span><span class="p">)])</span>
                        <span class="n">imageset_info_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imageset_info</span><span class="p">)</span>
                    <span class="n">last_photo_number</span> <span class="o">=</span> <span class="n">photo_number</span>
                    <span class="n">last_imageset_info</span> <span class="o">=</span> <span class="n">waypoint_info</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># raise IOError(&#39;The photonumber value is missing from</span>
                    <span class="c"># waypoint, waypoint_id: %r&#39; % (waypoint_id, ))</span>
                    <span class="k">print</span><span class="p">((</span><span class="s">&#39;[ibs]     Skipped Empty Observation with&#39;</span>
                           <span class="s">&#39;&quot;categoryKey&quot;: </span><span class="si">%r</span><span class="s">, waypoint_id: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">categoryKey</span><span class="p">,</span> <span class="n">waypoint_id</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">((</span><span class="s">&#39;[ibs]     &#39;</span>
                       <span class="s">&#39;Skipped Incompatible Observation with &#39;</span>
                       <span class="s">&#39;&quot;categoryKey&quot;: </span><span class="si">%r</span><span class="s">, waypoint_id: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">categoryKey</span><span class="p">,</span> <span class="n">waypoint_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="c"># Append the last photo_number</span>
    <span class="k">if</span> <span class="n">last_photo_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">last_imageset_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">imageset_info</span> <span class="o">=</span> <span class="n">last_imageset_info</span> <span class="o">+</span> <span class="p">[(</span><span class="n">last_photo_number</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">)]</span>
        <span class="n">imageset_info_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imageset_info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">imageset_info_list</span>


<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="compute_occurrences_smart"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_occurrences_smart">[docs]</a><span class="k">def</span> <span class="nf">compute_occurrences_smart</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">smart_xml_fpath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to load and process a SMART patrol XML file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Get file and copy to ibeis database folder</span>
    <span class="n">xml_dir</span><span class="p">,</span> <span class="n">xml_name</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">smart_xml_fpath</span><span class="p">)</span>
    <span class="n">dst_xml_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_smart_patrol_dir</span><span class="p">(),</span> <span class="n">xml_name</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">smart_xml_fpath</span><span class="p">,</span> <span class="n">dst_xml_path</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># Process the XML File</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] Processing Patrol XML file: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dst_xml_path</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">imageset_info_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_parse_smart_xml</span><span class="p">(</span><span class="n">dst_xml_path</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_images</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="k">print</span><span class="p">((</span><span class="s">&#39;[ibs] ERROR: Parsing Patrol XML file failed, &#39;</span>
               <span class="s">&#39;rolling back by deleting </span><span class="si">%d</span><span class="s"> images...&#39;</span><span class="p">)</span> <span class="o">%</span>
              <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="p">)))</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c"># Sanity check</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">imageset_info_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&#39;Trying to added </span><span class="si">%d</span><span class="s"> images, but the Patrol  &#39;</span>
             <span class="s">&#39;XML file has no observations&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span> <span class="p">))</span>
    <span class="c"># Display the patrol imagesets</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">imageset_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imageset_info_list</span><span class="p">):</span>
        <span class="n">smart_xml_fname</span><span class="p">,</span> <span class="n">smart_waypoint_id</span><span class="p">,</span> <span class="n">gps</span><span class="p">,</span> <span class="n">local_time</span><span class="p">,</span> <span class="n">range_</span> <span class="o">=</span> <span class="n">imageset_info</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">range_</span>
        <span class="n">gid_list_</span> <span class="o">=</span> <span class="n">gid_list</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs]     Found Patrol ImageSet: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imageset_info</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs]         GIDs: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gid_list_</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs]         SKIPPING EMPTY IMAGESET&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c"># Add the GPS data to the iamges</span>
        <span class="n">gps_list</span>  <span class="o">=</span> <span class="p">[</span> <span class="n">gps</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_gps</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">,</span> <span class="n">gps_list</span><span class="p">)</span>
        <span class="c"># Create a new imageset</span>
        <span class="n">imagesettext</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> Waypoint </span><span class="si">%03d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xml_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.xml&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">)</span>
        <span class="n">imgsetid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_imagesets</span><span class="p">(</span><span class="n">imagesettext</span><span class="p">)</span>
        <span class="c"># Add images to the imagesets</span>
        <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">imgsetid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_imgsetids</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">,</span> <span class="n">imgsetid_list</span><span class="p">)</span>
        <span class="c"># Set the imageset&#39;s smart fields</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_imageset_smart_xml_fnames</span><span class="p">([</span><span class="n">imgsetid</span><span class="p">],</span> <span class="p">[</span><span class="n">smart_xml_fname</span><span class="p">])</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_imageset_smart_waypoint_ids</span><span class="p">([</span><span class="n">imgsetid</span><span class="p">],</span> <span class="p">[</span><span class="n">smart_waypoint_id</span><span class="p">])</span>
        <span class="c"># Set the imageset&#39;s time based on the images</span>
        <span class="n">unixtime_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">))</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">unixtime_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">unixtime_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_imageset_start_time_posix</span><span class="p">([</span><span class="n">imgsetid</span><span class="p">],</span> <span class="p">[</span><span class="n">start_time</span><span class="p">])</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_imageset_end_time_posix</span><span class="p">([</span><span class="n">imgsetid</span><span class="p">],</span> <span class="p">[</span><span class="n">end_time</span><span class="p">])</span>
    <span class="c"># Complete</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] ...Done processing Patrol XML file&#39;</span><span class="p">)</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="compute_occurrences"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_occurrences">[docs]</a><span class="k">def</span> <span class="nf">compute_occurrences</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clusters ungrouped images into imagesets representing occurrences</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.control.IBEISControl --test-compute_occurrences</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.control.IBEISControl import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs.compute_occurrences()</span>
<span class="sd">        &gt;&gt;&gt; ibs.update_special_imagesets()</span>
<span class="sd">        &gt;&gt;&gt; # Now we want to remove some images from a non-special imageset</span>
<span class="sd">        &gt;&gt;&gt; nonspecial_imgsetids = [i for i in ibs.get_valid_imgsetids() if i not in ibs.get_special_imgsetids()]</span>
<span class="sd">        &gt;&gt;&gt; images_to_remove = ibs.get_imageset_gids(nonspecial_imgsetids[0:1])[0][0:1]</span>
<span class="sd">        &gt;&gt;&gt; ibs.unrelate_images_and_imagesets(images_to_remove,nonspecial_imgsetids[0:1] * len(images_to_remove))</span>
<span class="sd">        &gt;&gt;&gt; ibs.update_special_imagesets()</span>
<span class="sd">        &gt;&gt;&gt; ungr_imgsetid = ibs.get_imageset_imgsetids_from_text(const.UNGROUPED_IMAGES_IMAGESETTEXT)</span>
<span class="sd">        &gt;&gt;&gt; ungr_gids = ibs.get_imageset_gids([ungr_imgsetid])[0]</span>
<span class="sd">        &gt;&gt;&gt; #Now let&#39;s make sure that when we recompute imagesets, our non-special imgsetid remains the same</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;PRE COMPUTE: ImageSets are %r&#39; % ibs.get_valid_imgsetids())</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;Containing: %r&#39; % ibs.get_imageset_gids(ibs.get_valid_imgsetids()))</span>
<span class="sd">        &gt;&gt;&gt; ibs.compute_occurrences()</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;COMPUTE: New imagesets are %r&#39; % ibs.get_valid_imgsetids())</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;Containing: %r&#39; % ibs.get_imageset_gids(ibs.get_valid_imgsetids()))</span>
<span class="sd">        &gt;&gt;&gt; ibs.update_special_imagesets()</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;UPDATE SPECIAL: New imagesets are %r&#39; % ibs.get_valid_imgsetids())</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;Containing: %r&#39; % ibs.get_imageset_gids(ibs.get_valid_imgsetids()))</span>
<span class="sd">        &gt;&gt;&gt; assert(images_to_remove[0] not in ibs.get_imageset_gids(nonspecial_imgsetids[0:1])[0])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.algo.preproc</span> <span class="kn">import</span> <span class="n">preproc_occurrence</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] Computing and adding imagesets.&#39;</span><span class="p">)</span>
    <span class="c">#gid_list = ibs.get_valid_gids(require_unixtime=False, reviewed=False)</span>
    <span class="c"># only cluster ungrouped images</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_ungrouped_gids</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s">&#39;computing imagesets&#39;</span><span class="p">):</span>
        <span class="n">flat_imgsetids</span><span class="p">,</span> <span class="n">flat_gids</span> <span class="o">=</span> <span class="n">preproc_occurrence</span><span class="o">.</span><span class="n">ibeis_compute_occurrences</span><span class="p">(</span>
            <span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)</span>
    <span class="n">valid_imgsetids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_imgsetids</span><span class="p">()</span>
    <span class="n">imgsetid_offset</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_imgsetids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="n">valid_imgsetids</span><span class="p">)</span>
    <span class="c"># This way we can make sure that manually separated imagesets</span>
    <span class="n">flat_imgsetids_offset</span> <span class="o">=</span> <span class="p">[</span><span class="n">imgsetid</span> <span class="o">+</span> <span class="n">imgsetid_offset</span> <span class="k">for</span> <span class="n">imgsetid</span> <span class="ow">in</span> <span class="n">flat_imgsetids</span><span class="p">]</span>
    <span class="c"># remain untouched, and ensure that new imagesets are created</span>
    <span class="n">imagesettext_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Occurrence &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span> <span class="k">for</span> <span class="n">imgsetid</span> <span class="ow">in</span> <span class="n">flat_imgsetids_offset</span><span class="p">]</span>
    <span class="c">#print(&#39;imagesettext_list: %r; flat_gids: %r&#39; % (imagesettext_list, flat_gids))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] Finished computing, about to add imageset.&#39;</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_imagesettext</span><span class="p">(</span><span class="n">flat_gids</span><span class="p">,</span> <span class="n">imagesettext_list</span><span class="p">)</span>
    <span class="c"># HACK TO UPDATE IMAGESET POSIX TIMES</span>
    <span class="c"># CAREFUL THIS BLOWS AWAY SMART DATA</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">update_imageset_info</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_imgsetids</span><span class="p">())</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] Finished computing and adding imagesets.&#39;</span><span class="p">)</span>

</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs</span>
<span class="sd">        python -m ibeis.ibsfuncs --allexamples</span>
<span class="sd">        python -m ibeis.ibsfuncs --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c"># for win32</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Jon Crall.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.5.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>