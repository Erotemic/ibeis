<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ibeis.ibsfuncs &mdash; ibeis 0.1.0.dev1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1.0.dev1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="ibeis 0.1.0.dev1 documentation" href="../../index.html" />
    <link rel="up" title="ibeis" href="../ibeis.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">ibeis 0.1.0.dev1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../ibeis.html" accesskey="U">ibeis</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for ibeis.ibsfuncs</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">developer convenience functions for ibs</span>

<span class="sd">TODO: need to split up into sub modules:</span>
<span class="sd">    consistency_checks</span>
<span class="sd">    feasibility_fixes</span>
<span class="sd">    move the export stuff to dbio</span>

<span class="sd">    then there are also convineience functions that need to be ordered at least</span>
<span class="sd">    within this file</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">zip</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">map</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">split</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">commonprefix</span>
<span class="kn">import</span> <span class="nn">vtool.image</span> <span class="kn">as</span> <span class="nn">gtool</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">utool._internal.meta_util_six</span> <span class="kn">import</span> <span class="n">get_funcname</span><span class="p">,</span> <span class="n">get_imfunc</span><span class="p">,</span> <span class="n">set_funcname</span>
<span class="kn">from</span> <span class="nn">vtool</span> <span class="kn">import</span> <span class="n">linalg</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">image</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">ibeis</span>
<span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">detecttools.pypascalmarkup</span> <span class="kn">import</span> <span class="n">PascalVOC_Markup_Annotation</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="s">&#39;COMMIT TO DETECTTOOLS&#39;</span><span class="p">)</span>
    <span class="k">pass</span>
<span class="kn">from</span> <span class="nn">ibeis.control.accessor_decors</span> <span class="kn">import</span> <span class="n">getter_1to1</span>

<span class="c"># Inject utool functions</span>
<span class="p">(</span><span class="k">print</span><span class="p">,</span> <span class="n">print_</span><span class="p">,</span> <span class="n">printDBG</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span>
    <span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;[ibsfuncs]&#39;</span><span class="p">,</span> <span class="n">DEBUG</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="c"># Try to work around circular import</span>
<span class="c">#from ibeis.control.IBEISControl import IBEISController  # Must import class before injection</span>
<span class="n">CLASS_INJECT_KEY</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;IBEISController&#39;</span><span class="p">,</span> <span class="s">&#39;ibsfuncs&#39;</span><span class="p">)</span>
<span class="n">__injectable</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_class_method_decorator</span><span class="p">(</span><span class="n">CLASS_INJECT_KEY</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span>


<span class="nd">@ut.make_class_postinject_decorator</span><span class="p">(</span><span class="n">CLASS_INJECT_KEY</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span>
<div class="viewcode-block" id="postinject_func"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.postinject_func">[docs]</a><span class="k">def</span> <span class="nf">postinject_func</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-postinject_func</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aids_list = ibs.get_name_aids(ibs.get_valid_nids())</span>
<span class="sd">        &gt;&gt;&gt; # indirectly test postinject_func</span>
<span class="sd">        &gt;&gt;&gt; thetas_list = ibs.get_unflat_annot_thetas(aids_list)</span>
<span class="sd">        &gt;&gt;&gt; result = str(thetas_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [[0.0, 0.0], [0.0, 0.0], [0.0], [0.0], [0.0], [0.0], [0.0]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># List of getters to _unflatten</span>
    <span class="n">to_unflatten</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">flat_getter</span> <span class="ow">in</span> <span class="n">to_unflatten</span><span class="p">:</span>
        <span class="n">unflat_getter</span> <span class="o">=</span> <span class="n">_make_unflat_getter_func</span><span class="p">(</span><span class="n">flat_getter</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">inject_func_as_method</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">unflat_getter</span><span class="p">,</span> <span class="n">allow_override</span><span class="o">=</span><span class="n">ibs</span><span class="o">.</span><span class="n">allow_override</span><span class="p">)</span>
    <span class="c"># very hacky, but useful</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span> <span class="o">=</span> <span class="n">unflat_map</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="refresh"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.refresh">[docs]</a><span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">ibsfuncs</span>
    <span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">all_imports</span>
    <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">rrr</span><span class="p">()</span>
    <span class="n">all_imports</span><span class="o">.</span><span class="n">reload_all</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">rrr</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="export_to_xml"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.export_to_xml">[docs]</a><span class="k">def</span> <span class="nf">export_to_xml</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">2829</span><span class="p">,</span> <span class="n">enforce_viewpoint</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">target_size</span> <span class="o">=</span> <span class="mi">900</span>
    <span class="n">information</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;database_name&#39;</span> <span class="p">:</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_ibsdb</span> <span class="o">+</span> <span class="s">&quot;/LearningData/&quot;</span>
    <span class="n">imagedir</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s">&#39;JPEGImages/&#39;</span>
    <span class="n">annotdir</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s">&#39;Annotations/&#39;</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">datadir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">imagedir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">annotdir</span><span class="p">)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">(</span><span class="n">reviewed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Exporting </span><span class="si">%d</span><span class="s"> images&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),))</span>
    <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">gid_list</span><span class="p">:</span>
        <span class="n">viewpointed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="n">image_uri</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uris</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fulldir</span> <span class="o">=</span> <span class="n">image_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">fulldir</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c"># NOQA</span>
            <span class="n">out_name</span> <span class="o">=</span> <span class="s">&quot;2014_</span><span class="si">%06d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">offset</span>
            <span class="n">out_img</span> <span class="o">=</span> <span class="n">out_name</span> <span class="o">+</span> <span class="s">&quot;.jpg&quot;</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="s">&quot;IBEIS&quot;</span>

            <span class="n">_image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">_image</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">height</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="n">width</span>
                <span class="n">decrease</span> <span class="o">=</span> <span class="n">target_size</span> <span class="o">/</span> <span class="n">width</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">target_size</span>
                <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_size</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">height</span>
                <span class="n">decrease</span> <span class="o">=</span> <span class="n">target_size</span> <span class="o">/</span> <span class="n">height</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">target_size</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_size</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>

            <span class="n">dst_img</span> <span class="o">=</span> <span class="n">imagedir</span> <span class="o">+</span> <span class="n">out_img</span>
            <span class="n">_image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">_image</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
            <span class="n">image</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">dst_img</span><span class="p">,</span> <span class="n">_image</span><span class="p">)</span>

            <span class="n">annotation</span> <span class="o">=</span> <span class="n">PascalVOC_Markup_Annotation</span><span class="p">(</span><span class="n">dst_img</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">out_img</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">image_uri</span><span class="p">,</span> <span class="o">**</span><span class="n">information</span><span class="p">)</span>
            <span class="n">bbox_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="n">theta_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">theta</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">):</span>
                <span class="c"># Transformation matrix</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">rotation_around_bbox_mat3x3</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">bbox</span><span class="p">)</span>
                <span class="c"># Get verticies of the annotation polygon</span>
                <span class="n">verts</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">verts_from_bbox</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="c"># Rotate and transform vertices</span>
                <span class="n">xyz_pts</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">homogonize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="n">trans_pts</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">unhomogonize</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xyz_pts</span><span class="p">))</span>
                <span class="n">new_verts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">trans_pts</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">x_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">new_verts</span><span class="p">]</span>
                <span class="n">y_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">new_verts</span><span class="p">]</span>
                <span class="n">xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">decrease</span><span class="p">)</span>
                <span class="n">xmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">decrease</span><span class="p">)</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">y_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">decrease</span><span class="p">)</span>
                <span class="n">ymax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">y_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">decrease</span><span class="p">)</span>
                <span class="c">#TODO: Change species_name to getter in IBEISControl once implemented</span>
                <span class="c">#species_name = &#39;grevys_zebra&#39;</span>
                <span class="n">species_name</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                <span class="n">viewpoint</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoints</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">viewpoint</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">viewpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">[</span><span class="s">&#39;pose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%0.6f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">viewpoint</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">viewpointed</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;UNVIEWPOINTED: </span><span class="si">%d</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">gid</span><span class="p">)</span>
                <span class="n">annotation</span><span class="o">.</span><span class="n">add_object</span><span class="p">(</span><span class="n">species_name</span><span class="p">,</span> <span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">),</span> <span class="o">**</span><span class="n">info</span><span class="p">)</span>
            <span class="n">dst_annot</span> <span class="o">=</span> <span class="n">annotdir</span> <span class="o">+</span> <span class="n">out_name</span>  <span class="o">+</span> <span class="s">&#39;.xml&#39;</span>
            <span class="c"># Write XML</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">enforce_viewpoint</span> <span class="ow">or</span> <span class="n">viewpointed</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Copying:</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">dst_img</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="p">))</span>
                <span class="n">xml_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dst_annot</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">xml_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">xml</span><span class="p">())</span>
                <span class="n">xml_data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Skipping:</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="export_to_hotspotter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.export_to_hotspotter">[docs]</a><span class="k">def</span> <span class="nf">export_to_hotspotter</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.dbio</span> <span class="kn">import</span> <span class="n">export_hsdb</span>
    <span class="n">export_hsdb</span><span class="o">.</span><span class="n">export_ibeis_to_hotspotter</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_image_annotation_bboxes"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_image_annotation_bboxes">[docs]</a><span class="k">def</span> <span class="nf">get_image_annotation_bboxes</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">bboxes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annotation_bboxes</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bboxes_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_image_annotation_thetas"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_image_annotation_thetas">[docs]</a><span class="k">def</span> <span class="nf">get_image_annotation_thetas</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">thetas_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annotation_thetas</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thetas_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="compute_all_chips"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_all_chips">[docs]</a><span class="k">def</span> <span class="nf">compute_all_chips</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes lazy evaluation of all chips</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] compute_all_chips&#39;</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_annot_chips</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="compute_all_features"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_all_features">[docs]</a><span class="k">def</span> <span class="nf">compute_all_features</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes lazy evaluation of all chips and features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">compute_all_chips</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] compute_all_features&#39;</span><span class="p">)</span>
    <span class="n">fid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_chip_feats</span><span class="p">(</span><span class="n">cid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="compute_all_featweights"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_all_featweights">[docs]</a><span class="k">def</span> <span class="nf">compute_all_featweights</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes lazy evaluation of all chips and features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">compute_all_features</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] compute_all_featweights&#39;</span><span class="p">)</span>
    <span class="n">featweight_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_feat_featweights</span><span class="p">(</span><span class="n">fid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">featweight_rowid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="precompute_all_annot_dependants"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.precompute_all_annot_dependants">[docs]</a><span class="k">def</span> <span class="nf">precompute_all_annot_dependants</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">compute_all_featweights</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="ensure_annotation_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.ensure_annotation_data">[docs]</a><span class="k">def</span> <span class="nf">ensure_annotation_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">chips</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">feats</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">featweights</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">chips</span> <span class="ow">or</span> <span class="n">feats</span> <span class="ow">or</span> <span class="n">featweights</span><span class="p">:</span>
        <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_annot_chips</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">feats</span> <span class="ow">or</span> <span class="n">featweights</span><span class="p">:</span>
        <span class="n">fid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_chip_feats</span><span class="p">(</span><span class="n">cid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">featweights</span><span class="p">:</span>
        <span class="n">featweight_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_feat_featweights</span><span class="p">(</span><span class="n">fid_list</span><span class="p">)</span>  <span class="c"># NOQA</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_empty_gids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_empty_gids">[docs]</a><span class="k">def</span> <span class="nf">get_empty_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns gid list without any chips &quot;&quot;&quot;</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">(</span><span class="n">eid</span><span class="o">=</span><span class="n">eid</span><span class="p">)</span>
    <span class="n">nRois_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_num_annotations</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">empty_gids</span> <span class="o">=</span> <span class="p">[</span><span class="n">gid</span> <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">nRois</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">nRois_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">nRois</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">empty_gids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="convert_empty_images_to_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.convert_empty_images_to_annotations">[docs]</a><span class="k">def</span> <span class="nf">convert_empty_images_to_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; images without chips are given an ANNOTATION over the entire image &quot;&quot;&quot;</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_empty_gids</span><span class="p">()</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">use_images_as_annotations</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="use_images_as_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.use_images_as_annotations">[docs]</a><span class="k">def</span> <span class="nf">use_images_as_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">name_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                              <span class="n">notes_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">adjust_percent</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adds an annotation the size of the entire image to each image.</span>
<span class="sd">    adjust_percent - shrinks the ANNOTATION by percentage on each side</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pct</span> <span class="o">=</span> <span class="n">adjust_percent</span>  <span class="c"># Alias</span>
    <span class="n">gsize_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_sizes</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="c"># Build bounding boxes as images size minus padding</span>
    <span class="n">bbox_list</span>  <span class="o">=</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span> <span class="mi">0</span> <span class="o">+</span> <span class="p">(</span><span class="n">gw</span> <span class="o">*</span> <span class="n">pct</span><span class="p">)),</span>
                   <span class="nb">int</span><span class="p">(</span> <span class="mi">0</span> <span class="o">+</span> <span class="p">(</span><span class="n">gh</span> <span class="o">*</span> <span class="n">pct</span><span class="p">)),</span>
                   <span class="nb">int</span><span class="p">(</span><span class="n">gw</span> <span class="o">-</span> <span class="p">(</span><span class="n">gw</span> <span class="o">*</span> <span class="n">pct</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span>
                   <span class="nb">int</span><span class="p">(</span><span class="n">gh</span> <span class="o">-</span> <span class="p">(</span><span class="n">gh</span> <span class="o">*</span> <span class="n">pct</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                  <span class="k">for</span> <span class="p">(</span><span class="n">gw</span><span class="p">,</span> <span class="n">gh</span><span class="p">)</span> <span class="ow">in</span> <span class="n">gsize_list</span><span class="p">]</span>
    <span class="n">theta_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gsize_list</span><span class="p">))]</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_annots</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">,</span>
                                   <span class="n">name_list</span><span class="o">=</span><span class="n">name_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="o">=</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">notes_list</span><span class="o">=</span><span class="n">notes_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="assert_valid_species"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_valid_species">[docs]</a><span class="k">def</span> <span class="nf">assert_valid_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">species_list</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">isvalid_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">species</span> <span class="ow">in</span> <span class="n">const</span><span class="o">.</span><span class="n">VALID_SPECIES</span>  <span class="c"># or species == const.UNKNOWN</span>
            <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_list</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">isvalid_list</span><span class="p">),</span> <span class="s">&#39;invalid species found in </span><span class="si">%r</span><span class="s">: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">get_caller_name</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">species_list</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">),)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="n">iswarning</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iswarning</span><span class="p">:</span>
            <span class="k">raise</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="assert_singleton_relationship"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_singleton_relationship">[docs]</a><span class="k">def</span> <span class="nf">assert_singleton_relationship</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">alrids_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">alrids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">alrids</span> <span class="ow">in</span> <span class="n">alrids_list</span><span class="p">]),</span>\
            <span class="s">&#39;must only have one relationship of a type&#39;</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">parent_locals</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_parent_locals</span><span class="p">()</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;parent_locals=&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">parent_locals</span><span class="p">),</span> <span class="n">key_list</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;alrids_list&#39;</span><span class="p">,</span> <span class="p">])</span>
        <span class="k">raise</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="assert_valid_aids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_valid_aids">[docs]</a><span class="k">def</span> <span class="nf">assert_valid_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">veryverbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">valid_aids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">())</span>
    <span class="c">#invalid_aids = [aid for aid in aid_list if aid not in valid_aids]</span>
    <span class="n">isinvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">aid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_aids</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">aid_list</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">isinvalid_list</span><span class="p">),</span> <span class="s">&#39;invalid aids: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">isinvalid_list</span><span class="p">),)</span>
        <span class="n">isinvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">VALID_INT_TYPES</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">aid_list</span><span class="p">]</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">isinvalid_list</span><span class="p">),</span> <span class="s">&#39;invalidly typed aids: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">isinvalid_list</span><span class="p">),)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;dbname = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()))</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">embed</span><span class="p">()</span>
        <span class="k">raise</span>
    <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;passed assert_valid_aids&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="assert_images_exist"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_images_exist">[docs]</a><span class="k">def</span> <span class="nf">assert_images_exist</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;checking images exist&#39;</span><span class="p">)</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">exists_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">exists</span><span class="p">,</span> <span class="n">gpath_list</span><span class="p">))</span>
    <span class="n">bad_gids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">exists_list</span><span class="p">)</span>
    <span class="n">num_bad_gids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_gids</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">bad_gpaths</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">,</span> <span class="n">exists_list</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Bad Gpaths:&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">truncate_str</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">bad_gpaths</span><span class="p">),</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">500</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">num_bad_gids</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s"> images dont exist&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_bad_gids</span><span class="p">,)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[check] checked </span><span class="si">%d</span><span class="s"> images exist&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="check_image_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_image_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_image_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c"># TODO: more consistency checks</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;check image consistency. len(gid_list)=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">assert_images_exist</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)</span>
    <span class="n">image_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">image_uuid_list</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="c">#check_image_uuid_consistency(ibs, gid_list)</span>

</div>
<div class="viewcode-block" id="check_image_uuid_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_image_uuid_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_image_uuid_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks to make sure image uuids are computed detemenistically</span>
<span class="sd">    by recomputing all guuids and checking that they are equal to</span>
<span class="sd">    what is already there.</span>

<span class="sd">    VERY SLOW</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;checking image uuid consistency&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">ibeis.model.preproc.preproc_image</span> <span class="kn">as</span> <span class="nn">preproc_image</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">guuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgressIter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">))):</span>
        <span class="n">gpath</span> <span class="o">=</span> <span class="n">gpath_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">guuid_stored</span> <span class="o">=</span> <span class="n">guuid_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">param_tup</span> <span class="o">=</span> <span class="n">preproc_image</span><span class="o">.</span><span class="n">parse_imageinfo</span><span class="p">(</span><span class="n">gpath</span><span class="p">)</span>
        <span class="n">guuid_computed</span> <span class="o">=</span> <span class="n">param_tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">guuid_stored</span> <span class="o">==</span> <span class="n">guuid_computed</span><span class="p">,</span> <span class="s">&#39;image ix=</span><span class="si">%d</span><span class="s"> had a bad uuid&#39;</span> <span class="o">%</span> <span class="n">ix</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="check_annot_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_annot_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_annot_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs      (IBEISController):</span>
<span class="sd">        aid_list (list):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-check_annot_consistency</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; result = check_annot_consistency(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># TODO: more consistency checks</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;check annot consistency. len(aid_list)=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
    <span class="n">annot_gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">assert_images_exist</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">annot_gid_list</span><span class="p">)</span>
    <span class="n">unique_gids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">annot_gid_list</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;num_unique_images=</span><span class="si">%r</span><span class="s"> / </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_gids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">annot_gid_list</span><span class="p">)))</span>
    <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chip_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">cfpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_chip_paths</span><span class="p">(</span><span class="n">cid_list</span><span class="p">)</span>
    <span class="n">valid_chip_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">cfpath</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">exists</span><span class="p">(</span><span class="n">cfpath</span><span class="p">)</span> <span class="k">for</span> <span class="n">cfpath</span> <span class="ow">in</span> <span class="n">cfpath_list</span><span class="p">]</span>
    <span class="n">invalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag</span> <span class="ow">is</span> <span class="bp">False</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">valid_chip_list</span><span class="p">]</span>
    <span class="n">invalid_cids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">cid_list</span><span class="p">,</span> <span class="n">invalid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_cids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;found </span><span class="si">%d</span><span class="s"> inconsistent chips attempting to fix&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_cids</span><span class="p">))</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_chips</span><span class="p">(</span><span class="n">invalid_cids</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">visual_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">exemplar_flag</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_exemplar_flags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">is_unknown</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_aid_unknown</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="c"># Exemplars should all be known</span>
    <span class="n">unknown_exemplar_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">exemplar_flag</span><span class="p">,</span> <span class="n">is_unknown</span><span class="p">)</span>
    <span class="n">is_error</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="n">flag</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">unknown_exemplar_flags</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">is_error</span><span class="p">),</span> <span class="s">&#39;Unknown annotations are set as exemplars&#39;</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">visual_uuid_list</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="fix_remove_visual_dupliate_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_remove_visual_dupliate_annotations">[docs]</a><span class="k">def</span> <span class="nf">fix_remove_visual_dupliate_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    depricate because duplicate visual_uuids</span>
<span class="sd">    are no longer allowed to be duplicates</span>

<span class="sd">    Add to clean database?</span>

<span class="sd">    removes visually duplicate annotations</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;GZ_ALL&#39;)</span>
<span class="sd">        &gt;&gt;&gt; fix_remove_visual_dupliate_annotations(ibs)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">visual_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs_dup_annots</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">visual_uuid_list</span><span class="p">)</span>
    <span class="n">dupaids_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibs_dup_annots</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">dupxs</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">ibs_dup_annots</span><span class="p">):</span>
            <span class="n">aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">dupxs</span><span class="p">)</span>
            <span class="n">dupaids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aids</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="n">toremove_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">dupaids_list</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;About to delete toremove_aids=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">toremove_aids</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">are_you_sure</span><span class="p">():</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">delete_annots</span><span class="p">(</span><span class="n">toremove_aids</span><span class="p">)</span>

            <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
            <span class="n">visual_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="n">ibs_dup_annots</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">visual_uuid_list</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibs_dup_annots</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="vacuum_and_clean_databases"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.vacuum_and_clean_databases">[docs]</a><span class="k">def</span> <span class="nf">vacuum_and_clean_databases</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># Add to duct tape?</span>
    <span class="c">#ibs.vdd()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">())</span>
    <span class="c"># Removes all lblannots and lblannot relations as we are not using them</span>
    <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">NAME_TABLE</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">LBLTYPE_TABLE</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">LBLANNOT_TABLE</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">AL_RELATION_TABLE</span><span class="p">))</span>
    <span class="c"># Get old table indexes</span>
    <span class="c">#lbltype_rowids = ibs.db.get_all_rowids(const.LBLTYPE_TABLE)</span>
    <span class="n">lblannot_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_all_rowids</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">LBLANNOT_TABLE</span><span class="p">)</span>
    <span class="n">alr_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_all_rowids</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">AL_RELATION_TABLE</span><span class="p">)</span>
    <span class="c"># delete those tables</span>
    <span class="c">#ibs.db.delete_rowids(const.LBLTYPE_TABLE, lbltype_rowids)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">delete_rowids</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">LBLANNOT_TABLE</span><span class="p">,</span> <span class="n">lblannot_rowids</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">delete_rowids</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">AL_RELATION_TABLE</span><span class="p">,</span> <span class="n">alr_rowids</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">vacuum</span><span class="p">()</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="fix_and_clean_database"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_and_clean_database">[docs]</a><span class="k">def</span> <span class="nf">fix_and_clean_database</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c">#TODO: Call more stuff, maybe rename to &#39;apply duct tape&#39;</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">fix_unknown_exemplars</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">fix_invalid_name_texts</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">fix_invalid_nids</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="check_name_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_name_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_name_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        nid_list (list):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-check_name_consistency</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nid_list = ibs._get_all_known_nids()</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = check_name_consistency(ibs, nid_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#aids_list = ibs.get_name_aids(nid_list)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;check name consistency. len(nid_list)=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;WARNING: check_name_consistency function is not longer used&#39;</span><span class="p">)</span>
    <span class="c">#aids_list = ibs.get_name_aids(nid_list)</span>
    <span class="c">#aid_list = ut.flatten(aids_list)</span>
    <span class="c">#</span>
    <span class="c">#lbltype_rowid_list = ibs.get_lblannot_lbltypes_rowids(nid_list)</span>
    <span class="c">#individual_lbltype_rowid = ibs.lbltype_ids[const.INDIVIDUAL_KEY]</span>
    <span class="c">#for lbltype_rowid in lbltype_rowid_list:</span>
    <span class="c">#    assert lbltype_rowid == individual_lbltype_rowid, &#39;non individual lbltype&#39;</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="check_annot_size"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_annot_size">[docs]</a><span class="k">def</span> <span class="nf">check_annot_size</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Checking annot sizes&#39;</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">desc_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">kpts_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_kpts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">vert_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_verts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(aid_list) = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(vert_list) = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">vert_list</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(uuid_list) = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">uuid_list</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(desc_list) = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">desc_list</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(kpts_list) = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">kpts_list</span><span class="p">)))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="check_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">embed</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] Checking consistency&#39;</span><span class="p">)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">()</span>
    <span class="n">check_annot_size</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>
    <span class="n">check_image_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)</span>
    <span class="n">check_annot_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
    <span class="n">check_name_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>
    <span class="c"># Very slow check</span>
    <span class="n">check_image_uuid_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">embed</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">embed</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] Finshed consistency check&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="fix_exif_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_exif_data">[docs]</a><span class="k">def</span> <span class="nf">fix_exif_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">vtool.exif</span> <span class="kn">as</span> <span class="nn">exif</span>
    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">mark_</span><span class="p">,</span> <span class="n">end_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">log_progress</span><span class="p">(</span><span class="s">&#39;checking exif: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">))</span>
    <span class="n">exif_dict_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">)):</span>
        <span class="n">mark_</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
        <span class="n">gpath</span> <span class="o">=</span> <span class="n">gpath_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">pil_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gpath</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">exif_dict</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">get_exif_dict</span><span class="p">(</span><span class="n">pil_img</span><span class="p">)</span>
        <span class="n">exif_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">)</span>
        <span class="c">#if len(exif_dict) &gt; 0:</span>
        <span class="c">#    break</span>
    <span class="n">end_</span><span class="p">()</span>

    <span class="n">latlon_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">exif</span><span class="o">.</span><span class="n">get_lat_lon</span><span class="p">(</span><span class="n">_dict</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">_dict</span> <span class="ow">in</span> <span class="n">exif_dict_list</span><span class="p">]</span>
    <span class="n">haslatlon_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">latlon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">latlon</span> <span class="ow">in</span> <span class="n">latlon_list</span><span class="p">]</span>

    <span class="n">latlon_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">latlon_list</span><span class="p">,</span> <span class="n">haslatlon_list</span><span class="p">)</span>
    <span class="n">gid_list_</span>    <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">haslatlon_list</span><span class="p">)</span>

    <span class="n">gps_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_gps</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span>
    <span class="n">needsupdate_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gps</span> <span class="o">==</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">gps</span> <span class="ow">in</span> <span class="n">gps_list</span><span class="p">]</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s"> / </span><span class="si">%d</span><span class="s"> need gps update&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">needsupdate_list</span><span class="p">),</span>
                                       <span class="nb">len</span><span class="p">(</span><span class="n">needsupdate_list</span><span class="p">)))</span>

    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">needsupdate_list</span><span class="p">)</span>  <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">sum</span><span class="p">(</span><span class="n">needsupdate_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">needsupdate_list</span><span class="p">),</span> <span class="s">&#39;safety. remove and evaluate if hit&#39;</span>
        <span class="c">#ibs.set_image_enctext(gid_list_, [&#39;HASGPS&#39;] * len(gid_list_))</span>
        <span class="n">latlon_list__</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">latlon_list_</span><span class="p">,</span> <span class="n">needsupdate_list</span><span class="p">)</span>
        <span class="n">gid_list__</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">,</span> <span class="n">needsupdate_list</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_gps</span><span class="p">(</span><span class="n">gid_list__</span><span class="p">,</span> <span class="n">latlon_list__</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="check_exif_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_exif_data">[docs]</a><span class="k">def</span> <span class="nf">check_exif_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">vtool.exif</span> <span class="kn">as</span> <span class="nn">exif</span>
    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">mark_</span><span class="p">,</span> <span class="n">end_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">log_progress</span><span class="p">(</span><span class="s">&#39;checking exif: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">))</span>
    <span class="n">exif_dict_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">)):</span>
        <span class="n">mark_</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
        <span class="n">gpath</span> <span class="o">=</span> <span class="n">gpath_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">pil_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gpath</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">exif_dict</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">get_exif_dict</span><span class="p">(</span><span class="n">pil_img</span><span class="p">)</span>
        <span class="n">exif_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">)</span>
        <span class="c">#if len(exif_dict) &gt; 0:</span>
        <span class="c">#    break</span>

    <span class="n">has_latlon</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">exif_dict</span> <span class="ow">in</span> <span class="n">exif_dict_list</span><span class="p">:</span>
        <span class="n">latlon</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">get_lat_lon</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">latlon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">has_latlon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_latlon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s"> / </span><span class="si">%d</span><span class="s"> have gps info&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">has_latlon</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">has_latlon</span><span class="p">),))</span>

    <span class="n">key2_freq</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">num_tags_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">exif_dict</span> <span class="ow">in</span> <span class="n">exif_dict_list</span><span class="p">:</span>
        <span class="n">exif_dict2</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">make_exif_dict_human_readable</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">)</span>
        <span class="n">num_tags_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">exif_dict2</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">key2_freq</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">print_stats</span><span class="p">(</span><span class="n">num_tags_list</span><span class="p">,</span> <span class="s">&#39;num tags per image&#39;</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;tag frequency&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">key2_freq</span><span class="p">))</span>

    <span class="n">end_</span><span class="p">()</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_thumbnails"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_thumbnails">[docs]</a><span class="k">def</span> <span class="nf">delete_thumbnails</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">remove_files_in_dir</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_thumbdir</span><span class="p">())</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_flann_cachedir"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_flann_cachedir">[docs]</a><span class="k">def</span> <span class="nf">delete_flann_cachedir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_flann_cachedir&#39;</span><span class="p">)</span>
    <span class="n">flann_cachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_flann_cachedir</span><span class="p">()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">remove_files_in_dir</span><span class="p">(</span><span class="n">flann_cachedir</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="print_flann_cachedir"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_flann_cachedir">[docs]</a><span class="k">def</span> <span class="nf">print_flann_cachedir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">flann_cachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_flann_cachedir</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">flann_cachedir</span><span class="p">)))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_all_recomputable_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_recomputable_data">[docs]</a><span class="k">def</span> <span class="nf">delete_all_recomputable_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete all cached data including chips and encounters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_recomputable_data&#39;</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_cachedir</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_all_chips</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_all_encounters</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_recomputable_data&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_cache"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_cache">[docs]</a><span class="k">def</span> <span class="nf">delete_cache</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">delete_chips</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">delete_encounters</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the cache directory in the database directory.</span>
<span class="sd">    Can specify to delete encoutners and chips as well.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">ensure_directories</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_cachedir</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">ensure_directories</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">delete_chips</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_all_chips</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">delete_encounters</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_all_encounters</span><span class="p">()</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_cachedir"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_cachedir">[docs]</a><span class="k">def</span> <span class="nf">delete_cachedir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the cache directory in the database directory.</span>

<span class="sd">    (does not remove chips)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_cachedir&#39;</span><span class="p">)</span>
    <span class="c"># Need to close dbcache before restarting</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">_close_sqldbcache</span><span class="p">()</span>
    <span class="n">cachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_cachedir</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] cachedir=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cachedir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete cachedir&#39;</span><span class="p">)</span>
    <span class="c"># Reinit cache</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">ensure_directories</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">_init_sqldbcache</span><span class="p">()</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_qres_cache"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_qres_cache">[docs]</a><span class="k">def</span> <span class="nf">delete_qres_cache</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete delete_qres_cache&#39;</span><span class="p">)</span>
    <span class="n">qreq_cachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_qres_cachedir</span><span class="p">()</span>
    <span class="n">qreq_bigcachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_big_cachedir</span><span class="p">()</span>
    <span class="c"># Preliminary-ensure</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">qreq_bigcachedir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">qreq_cachedir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">qreq_cachedir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">qreq_bigcachedir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="c"># Re-ensure</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">qreq_bigcachedir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">qreq_cachedir</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_qres_cache&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_all_features"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_features">[docs]</a><span class="k">def</span> <span class="nf">delete_all_features</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_features&#39;</span><span class="p">)</span>
    <span class="n">all_fids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_fids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_features</span><span class="p">(</span><span class="n">all_fids</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_features&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_all_chips"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_chips">[docs]</a><span class="k">def</span> <span class="nf">delete_all_chips</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_chips&#39;</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">chipdir</span><span class="p">)</span>
    <span class="n">all_cids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_cids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_chips</span><span class="p">(</span><span class="n">all_cids</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">chipdir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">chipdir</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_chips&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_all_encounters"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_encounters">[docs]</a><span class="k">def</span> <span class="nf">delete_all_encounters</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_encounters&#39;</span><span class="p">)</span>
    <span class="n">all_eids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_eids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_encounters</span><span class="p">(</span><span class="n">all_eids</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_encounters&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_all_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_annotations">[docs]</a><span class="k">def</span> <span class="nf">delete_all_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Carefull with this function. Annotations are not recomputable &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_annotations&#39;</span><span class="p">)</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">moves</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s">&#39;Are you sure you want to delete all annotations?&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ans</span> <span class="o">!=</span> <span class="s">&#39;yes&#39;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">all_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_aids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_annots</span><span class="p">(</span><span class="n">all_aids</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_annotations&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="vd"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.vd">[docs]</a><span class="k">def</span> <span class="nf">vd</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">view_dbdir</span><span class="p">()</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="view_dbdir"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.view_dbdir">[docs]</a><span class="k">def</span> <span class="nf">view_dbdir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">view_directory</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbdir</span><span class="p">())</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_vecs_cache"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_vecs_cache">[docs]</a><span class="k">def</span> <span class="nf">get_annot_vecs_cache</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; When you have a list with duplicates and you dont want to copy data</span>
<span class="sd">    creates a reference to each data object indexed by a dict &quot;&quot;&quot;</span>
    <span class="n">unique_aids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aids</span><span class="p">))</span>
    <span class="n">unique_desc</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">(</span><span class="n">unique_aids</span><span class="p">)</span>
    <span class="n">desc_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_aids</span><span class="p">,</span> <span class="n">unique_desc</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">desc_cache</span>


<span class="c"># TODO: move to const</span>
</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_is_hard"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_is_hard">[docs]</a><span class="k">def</span> <span class="nf">get_annot_is_hard</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CmdLine:</span>
<span class="sd">        ./dev.py --cmd --db PZ_Mothers</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>
<span class="sd">        aid_list (list):</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: is_hard_list</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()[0::2]</span>
<span class="sd">        &gt;&gt;&gt; is_hard_list = get_annot_is_hard(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; result = str(is_hard_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [False, False, False, False, False, False, False]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">is_hard_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">HARD_NOTE_TAG</span> <span class="ow">in</span> <span class="n">notes</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="p">(</span><span class="n">notes</span><span class="p">)</span>
                    <span class="ow">in</span> <span class="n">notes_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">is_hard_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_hard_annot_rowids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_hard_annot_rowids">[docs]</a><span class="k">def</span> <span class="nf">get_hard_annot_rowids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">valid_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">hard_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_is_hard</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">hard_aids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_easy_annot_rowids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_easy_annot_rowids">[docs]</a><span class="k">def</span> <span class="nf">get_easy_annot_rowids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">hard_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_hard_annot_rowids</span><span class="p">()</span>
    <span class="n">easy_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff_ordered</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(),</span> <span class="n">hard_aids</span><span class="p">)</span>
    <span class="n">easy_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">easy_aids</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_has_groundtruth</span><span class="p">(</span><span class="n">easy_aids</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">easy_aids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="set_annot_is_hard"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_annot_is_hard">[docs]</a><span class="k">def</span> <span class="nf">set_annot_is_hard</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hack to mark hard cases in the notes column</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; pz_mothers_hard_aids = [27, 43, 44, 49, 50, 51, 54, 66, 89, 97]</span>
<span class="sd">        &gt;&gt;&gt; aid_list = pz_mothers_hard_aids</span>
<span class="sd">        &gt;&gt;&gt; flag_list = [True] * len(aid_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">is_hard_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">HARD_NOTE_TAG</span> <span class="ow">in</span> <span class="n">notes</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="p">(</span><span class="n">notes</span><span class="p">)</span> <span class="ow">in</span> <span class="n">notes_list</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">fix_notes</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">is_hard</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="s">&quot; Adds or removes hard tag if needed &quot;</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="ow">and</span> <span class="n">is_hard</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">flag</span> <span class="ow">or</span> <span class="n">is_hard</span><span class="p">):</span>
            <span class="c"># do nothing</span>
            <span class="k">return</span> <span class="n">notes</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_hard</span> <span class="ow">and</span> <span class="n">flag</span><span class="p">:</span>
            <span class="c"># need to add flag</span>
            <span class="k">return</span> <span class="n">const</span><span class="o">.</span><span class="n">HARD_NOTE_TAG</span> <span class="o">+</span> <span class="s">&#39; &#39;</span>  <span class="o">+</span> <span class="n">notes</span>
        <span class="k">elif</span> <span class="n">is_hard</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">:</span>
            <span class="c"># need to remove flag</span>
            <span class="k">return</span> <span class="n">notes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">HARD_NOTE_TAG</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;impossible state&#39;</span><span class="p">)</span>

    <span class="n">new_notes_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fix_notes</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">is_hard</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span> <span class="k">for</span> <span class="n">notes</span><span class="p">,</span> <span class="n">is_hard</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">notes_list</span><span class="p">,</span> <span class="n">is_hard_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)]</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_notes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">new_notes_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">is_hard_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_bbox_area"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_bbox_area">[docs]</a><span class="k">def</span> <span class="nf">get_annot_bbox_area</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">bbox_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">area_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="n">bbox_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">area_list</span>


<span class="c">#@__injectable</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="rebase_images"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.rebase_images">[docs]</a><span class="k">def</span> <span class="nf">rebase_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">new_path</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Moves the images into the ibeis image cache.</span>
<span class="sd">    Images are renamed to img_uuid.ext</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gid_list</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
        <span class="c">#new_path = &#39;G:\PZ_Ol_Pejeta_All&#39;</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">len_prefix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">commonprefix</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">))</span>
    <span class="c">#if common_prefix.rfind(&#39;/&#39;)</span>
    <span class="c"># assum</span>
    <span class="n">gname_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gpath</span><span class="p">[</span><span class="n">len_prefix</span><span class="p">:]</span> <span class="k">for</span> <span class="n">gpath</span> <span class="ow">in</span> <span class="n">gpath_list</span><span class="p">]</span>
    <span class="n">new_gpath_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">join</span><span class="p">(</span><span class="n">new_path</span><span class="p">,</span> <span class="n">gname</span><span class="p">)</span> <span class="k">for</span> <span class="n">gname</span> <span class="ow">in</span> <span class="n">gname_list</span><span class="p">]</span>
    <span class="n">new_gpath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unixpath</span><span class="p">,</span> <span class="n">new_gpath_list</span><span class="p">))</span>
    <span class="c">#orig_exists = map(exists, gpath_list)</span>
    <span class="n">new_exists</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">exists</span><span class="p">,</span> <span class="n">new_gpath_list</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">new_exists</span><span class="p">),</span> <span class="s">&#39;some rebased images do not exist&#39;</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_uris</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">new_gpath_list</span><span class="p">)</span>
    <span class="k">assert</span>  <span class="s">&#39;not all images copied&#39;</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_invalid_nids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_invalid_nids">[docs]</a><span class="k">def</span> <span class="nf">delete_invalid_nids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Removes names that have no Rois from the database &quot;&quot;&quot;</span>
    <span class="n">invalid_nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_invalid_nids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_names</span><span class="p">(</span><span class="n">invalid_nids</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_invalid_eids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_invalid_eids">[docs]</a><span class="k">def</span> <span class="nf">delete_invalid_eids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Removes encounters without images &quot;&quot;&quot;</span>
    <span class="n">eid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_eids</span><span class="p">(</span><span class="n">min_num_gids</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">nGids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_num_gids</span><span class="p">(</span><span class="n">eid_list</span><span class="p">)</span>
    <span class="n">is_invalid</span> <span class="o">=</span> <span class="p">[</span><span class="n">nGids</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">nGids</span> <span class="ow">in</span> <span class="n">nGids_list</span><span class="p">]</span>
    <span class="n">invalid_eids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">eid_list</span><span class="p">,</span> <span class="n">is_invalid</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_encounters</span><span class="p">(</span><span class="n">invalid_eids</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@getter_1to1</span>
<div class="viewcode-block" id="is_nid_unknown"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.is_nid_unknown">[docs]</a><span class="k">def</span> <span class="nf">is_nid_unknown</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span> <span class="n">nid</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nid_list</span><span class="p">]</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_match_text"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_match_text">[docs]</a><span class="k">def</span> <span class="nf">get_match_text</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">):</span>
    <span class="n">truth</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_match_truth</span><span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;NEW Match &#39;</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">:</span> <span class="s">&#39;JOIN Match &#39;</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;SPLIT Match &#39;</span><span class="p">,</span>
    <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">truth</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_database_species"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_database_species">[docs]</a><span class="k">def</span> <span class="nf">get_database_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_database_species</span>

<span class="sd">    Example1:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = ibs.get_database_species()</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [&#39;____&#39;, u&#39;bear_polar&#39;, u&#39;zebra_grevys&#39;, u&#39;zebra_plains&#39;]</span>

<span class="sd">    Example2:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = ibs.get_database_species()</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [u&#39;zebra_plains&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">unique_species</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">species_list</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">unique_species</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_database_species_count"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_database_species_count">[docs]</a><span class="k">def</span> <span class="nf">get_database_species_count</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_database_species_count</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; #print(ut.dict_str(ibeis.opendb(&#39;PZ_Master0&#39;).get_database_species_count()))</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = ibs.get_database_species_count()</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        {u&#39;zebra_plains&#39;: 6, &#39;____&#39;: 3, u&#39;zebra_grevys&#39;: 2, u&#39;bear_polar&#39;: 2}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">species_count_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">item_hist</span><span class="p">(</span><span class="n">species_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">species_count_dict</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="set_annot_names_to_next_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_annot_names_to_next_name">[docs]</a><span class="k">def</span> <span class="nf">set_annot_names_to_next_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">next_name</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_name</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_names</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">next_name</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<span class="k">def</span> <span class="nf">_overwrite_annot_species_to_plains</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">Species</span><span class="o">.</span><span class="n">ZEB_PLAIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)</span>


<span class="nd">@__injectable</span>
<span class="k">def</span> <span class="nf">_overwrite_annot_species_to_grevys</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">Species</span><span class="o">.</span><span class="n">ZEB_GREVY</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)</span>


<span class="nd">@__injectable</span>
<span class="k">def</span> <span class="nf">_overwrite_annot_species_to_giraffe</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">Species</span><span class="o">.</span><span class="n">GIR</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)</span>


<span class="nd">@__injectable</span>
<span class="k">def</span> <span class="nf">_overwrite_all_annot_species_to</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">species</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; THIS OVERWRITES A LOT OF INFO &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">const</span><span class="o">.</span><span class="n">VALID_SPECIES</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">species</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;is not in &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">VALID_SPECIES</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)</span>


<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_match_truth"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_match_truth">[docs]</a><span class="k">def</span> <span class="nf">get_match_truth</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">):</span>
    <span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">((</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">))</span>
    <span class="n">isunknown_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">((</span><span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">isunknown_list</span><span class="p">):</span>
        <span class="n">truth</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c"># Unknown</span>
    <span class="k">elif</span> <span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span><span class="p">:</span>
        <span class="n">truth</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c"># True</span>
    <span class="k">elif</span> <span class="n">nid1</span> <span class="o">!=</span> <span class="n">nid2</span><span class="p">:</span>
        <span class="n">truth</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c"># False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;invalid_unknown_truth_state&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">truth</span>


<span class="c"># Use new invertable flatten functions</span></div>
<span class="n">_invertable_flatten</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">invertable_flatten2</span>
<span class="n">_unflatten</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unflatten2</span>


<div class="viewcode-block" id="unflat_map"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.unflat_map">[docs]</a><span class="k">def</span> <span class="nf">unflat_map</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">unflat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses an ibeis lookup function with a non-flat rowid list.</span>
<span class="sd">    In essence this is equivilent to map(method, unflat_rowids).</span>
<span class="sd">    The utility of this function is that it only calls method once.</span>
<span class="sd">    This is more efficient for calls that can take a list of inputs</span>

<span class="sd">    Args:</span>
<span class="sd">        method        (method):  ibeis controller method</span>
<span class="sd">        unflat_rowids (list): list of rowid lists</span>

<span class="sd">    Returns:</span>
<span class="sd">        list of values: unflat_vals</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-unflat_map</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; method = ibs.get_annot_name_rowids</span>
<span class="sd">        &gt;&gt;&gt; unflat_rowids = ibs.get_name_aids(ibs.get_valid_nids())</span>
<span class="sd">        &gt;&gt;&gt; unflat_vals = unflat_map(method, unflat_rowids)</span>
<span class="sd">        &gt;&gt;&gt; result = str(unflat_vals)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [[1, 1], [2, 2], [3], [4], [5], [6], [7]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#ut.assert_unflat_level(unflat_rowids, level=1, basetype=(int, uuid.UUID))</span>
    <span class="c"># First flatten the list, and remember the original dimensions</span>
    <span class="n">flat_rowids</span><span class="p">,</span> <span class="n">reverse_list</span> <span class="o">=</span> <span class="n">_invertable_flatten</span><span class="p">(</span><span class="n">unflat_rowids</span><span class="p">)</span>
    <span class="c"># Then preform the lookup / implicit mapping</span>
    <span class="n">flat_vals</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">flat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c"># Then _unflatten the results to the original input dimensions</span>
    <span class="n">unflat_vals</span> <span class="o">=</span> <span class="n">_unflatten</span><span class="p">(</span><span class="n">flat_vals</span><span class="p">,</span> <span class="n">reverse_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unflat_vals</span>

</div>
<div class="viewcode-block" id="unflat_multimap"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.unflat_multimap">[docs]</a><span class="k">def</span> <span class="nf">unflat_multimap</span><span class="p">(</span><span class="n">method_list</span><span class="p">,</span> <span class="n">unflat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; unflat_map, but allows multiple methods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># First flatten the list, and remember the original dimensions</span>
    <span class="n">flat_rowids</span><span class="p">,</span> <span class="n">reverse_list</span> <span class="o">=</span> <span class="n">_invertable_flatten</span><span class="p">(</span><span class="n">unflat_rowids</span><span class="p">)</span>
    <span class="c"># Then preform the lookup / implicit mapping</span>
    <span class="n">flat_vals_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">method</span><span class="p">(</span><span class="n">flat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">method_list</span><span class="p">]</span>
    <span class="c"># Then _unflatten the results to the original input dimensions</span>
    <span class="n">unflat_vals_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_unflatten</span><span class="p">(</span><span class="n">flat_vals</span><span class="p">,</span> <span class="n">reverse_list</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">flat_vals</span> <span class="ow">in</span> <span class="n">flat_vals_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">unflat_vals_list</span>

</div>
<span class="k">def</span> <span class="nf">_make_unflat_getter_func</span><span class="p">(</span><span class="n">flat_getter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    makes an unflat version of an ibeis getter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flat_getter</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">):</span>
        <span class="c"># Unwrap fmethods</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">get_imfunc</span><span class="p">(</span><span class="n">flat_getter</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">flat_getter</span>
    <span class="n">funcname</span> <span class="o">=</span> <span class="n">get_funcname</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">funcname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;get_&#39;</span><span class="p">),</span> <span class="s">&#39;only works on getters, not: &#39;</span> <span class="o">+</span> <span class="n">funcname</span>
    <span class="c"># Create new function</span>
    <span class="k">def</span> <span class="nf">unflat_getter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unflat_rowids</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># First flatten the list</span>
        <span class="n">flat_rowids</span><span class="p">,</span> <span class="n">reverse_list</span> <span class="o">=</span> <span class="n">_invertable_flatten</span><span class="p">(</span><span class="n">unflat_rowids</span><span class="p">)</span>
        <span class="c"># Then preform the lookup</span>
        <span class="n">flat_vals</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flat_rowids</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c"># Then _unflatten the list</span>
        <span class="n">unflat_vals</span> <span class="o">=</span> <span class="n">_unflatten</span><span class="p">(</span><span class="n">flat_vals</span><span class="p">,</span> <span class="n">reverse_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unflat_vals</span>
    <span class="n">set_funcname</span><span class="p">(</span><span class="n">unflat_getter</span><span class="p">,</span> <span class="n">funcname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;get_&#39;</span><span class="p">,</span> <span class="s">&#39;get_unflat_&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">unflat_getter</span>


<div class="viewcode-block" id="delete_ibeis_database"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_ibeis_database">[docs]</a><span class="k">def</span> <span class="nf">delete_ibeis_database</span><span class="p">(</span><span class="n">dbdir</span><span class="p">):</span>
    <span class="n">_ibsdb</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dbdir</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">PATH_NAMES</span><span class="o">.</span><span class="n">_ibsdb</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] DELETEING: _ibsdb=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">_ibsdb</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">_ibsdb</span><span class="p">):</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">_ibsdb</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="assert_valid_names"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_valid_names">[docs]</a><span class="k">def</span> <span class="nf">assert_valid_names</span><span class="p">(</span><span class="n">name_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Asserts that user specified names do not conflict with</span>
<span class="sd">    the standard unknown name &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">def</span> <span class="nf">isconflict</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="n">valid_namecheck</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="n">isconflict</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">valid_namecheck</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;A name conflicts with UKNONWN Name. -- &#39;</span>
                                  <span class="s">&#39;cannot start a name with four underscores&#39;</span><span class="p">)</span>

</div>
<span class="nd">@ut.on_exception_report_input</span>
<div class="viewcode-block" id="assert_lblannot_rowids_are_type"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_lblannot_rowids_are_type">[docs]</a><span class="k">def</span> <span class="nf">assert_lblannot_rowids_are_type</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">lblannot_rowid_list</span><span class="p">,</span> <span class="n">valid_lbltype_rowid</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">lbltype_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_lblannot_lbltypes_rowids</span><span class="p">(</span><span class="n">lblannot_rowid_list</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># HACK: the unknown_lblannot_rowid will have a None type</span>
        <span class="c"># the unknown lblannot_rowid should be handled more gracefully</span>
        <span class="c"># this should just check the first condition (get rid of the or)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">assert_same_len</span><span class="p">(</span><span class="n">lbltype_rowid_list</span><span class="p">,</span> <span class="n">lbltype_rowid_list</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">assert_scalar_list</span><span class="p">(</span><span class="n">lblannot_rowid_list</span><span class="p">)</span>
        <span class="n">validtype_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">lbltype_rowid</span> <span class="o">==</span> <span class="n">valid_lbltype_rowid</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">lbltype_rowid</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">lblannot_rowid</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN_LBLANNOT_ROWID</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">lbltype_rowid</span><span class="p">,</span> <span class="n">lblannot_rowid</span> <span class="ow">in</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">lbltype_rowid_list</span><span class="p">,</span> <span class="n">lblannot_rowid_list</span><span class="p">)]</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">validtype_list</span><span class="p">),</span> <span class="s">&#39;not all types match valid type&#39;</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">tup_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lbltype_rowid_list</span><span class="p">,</span> <span class="n">lblannot_rowid_list</span><span class="p">))))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[!!!] (lbltype_rowid, lblannot_rowid) = : &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">indentjoin</span><span class="p">(</span><span class="n">tup_list</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[!!!] valid_lbltype_rowid: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">valid_lbltype_rowid</span><span class="p">,))</span>

        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;not all types match valid type&#39;</span><span class="p">,</span>
                      <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;valid_lbltype_rowid&#39;</span><span class="p">,</span> <span class="s">&#39;lblannot_rowid_list&#39;</span><span class="p">])</span>
        <span class="k">raise</span>

</div>
<div class="viewcode-block" id="ensure_unix_gpaths"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.ensure_unix_gpaths">[docs]</a><span class="k">def</span> <span class="nf">ensure_unix_gpaths</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asserts that all paths are given with forward slashes.</span>
<span class="sd">    If not it fixes them</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#if ut.NO_ASSERTS:</span>
    <span class="c">#    return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;gpath_list must be in unix format (no backslashes).&#39;</span>
               <span class="s">&#39;Failed on </span><span class="si">%d</span><span class="s">-th gpath=</span><span class="si">%r</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">gpath</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">gpath</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">gpath</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">gpath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unixpath</span><span class="p">,</span> <span class="n">gpath_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gpath_list</span>

</div>
<div class="viewcode-block" id="aidstr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.aidstr">[docs]</a><span class="k">def</span> <span class="nf">aidstr</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Helper to make a string from an RID &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">notes</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;aid</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">name</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_names</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;aid</span><span class="si">%d</span><span class="s">-</span><span class="si">%r</span><span class="s">-</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">notes</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="vsstr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.vsstr">[docs]</a><span class="k">def</span> <span class="nf">vsstr</span><span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">lite</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">lite</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">-vs-</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">aid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;qaid</span><span class="si">%d</span><span class="s">-vs-aid</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">aid</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="list_images"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.list_images">[docs]</a><span class="k">def</span> <span class="nf">list_images</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">fullpath</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; lists images that are not in an internal cache &quot;&quot;&quot;</span>
    <span class="n">ignore_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;_hsdb&#39;</span><span class="p">,</span> <span class="s">&#39;.hs_internals&#39;</span><span class="p">,</span> <span class="s">&#39;_ibeis_cache&#39;</span><span class="p">,</span> <span class="s">&#39;_ibsdb&#39;</span><span class="p">]</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_images</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span>
                                   <span class="n">fullpath</span><span class="o">=</span><span class="n">fullpath</span><span class="p">,</span>
                                   <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
                                   <span class="n">ignore_list</span><span class="o">=</span><span class="n">ignore_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gpath_list</span>

</div>
<div class="viewcode-block" id="get_species_dbs"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_species_dbs">[docs]</a><span class="k">def</span> <span class="nf">get_species_dbs</span><span class="p">(</span><span class="n">species_prefix</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.dev</span> <span class="kn">import</span> <span class="n">sysres</span>
    <span class="n">ibs_dblist</span> <span class="o">=</span> <span class="n">sysres</span><span class="o">.</span><span class="n">get_ibsdb_list</span><span class="p">()</span>
    <span class="n">isvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">species_prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">ibs_dblist</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">ibs_dblist</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>


<span class="c">#def delete_non_exemplars(ibs):</span>
<span class="c">#    &quot;&quot;&quot; deletes images without exemplars &quot;&quot;&quot;</span>
<span class="c">#    gid_list = ibs.get_valid_gids</span>
<span class="c">#    aids_list = ibs.get_image_aids(gid_list)</span>
<span class="c">#    flags_list = unflat_map(ibs.get_annot_exemplar_flags, aids_list)</span>
<span class="c">#    delete_gid_flag_list = [not any(flags) for flags in flags_list]</span>
<span class="c">#    delete_gid_list = ut.filter_items(gid_list, delete_gid_flag_list)</span>
<span class="c">#    ibs.delete_images(delete_gid_list)</span>
<span class="c">#    delete_invalid_eids(ibs)</span>
<span class="c">#    delete_invalid_nids(ibs)</span>


<span class="c">#@__injectable</span>
<span class="c">#@ut.time_func</span>
<span class="c">#@profile</span>
<span class="c">#def update_reviewed_image_encounter(ibs):</span>
<span class="c">#    # FIXME SLOW</span>
<span class="c">#    #ibs.delete_encounters(eid)</span>
<span class="c">#    ibs.delete_egr_encounter_relations(eid)</span>
<span class="c">#    #gid_list = ibs.get_valid_gids(reviewed=True)</span>
<span class="c">#    gid_list = _get_reviewed_gids(ibs)  # hack</span>
<span class="c">#    #ibs.set_image_enctext(gid_list, [const.REVIEWED_IMAGE_ENCTEXT] * len(gid_list))</span>
<span class="c">#    ibs.set_image_eids(gid_list, [eid] * len(gid_list))</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@ut.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_exemplar_special_encounter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_exemplar_special_encounter">[docs]</a><span class="k">def</span> <span class="nf">update_exemplar_special_encounter</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">exemplar_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">EXEMPLAR_ENCTEXT</span><span class="p">)</span>
    <span class="c">#ibs.delete_encounters(exemplar_eid)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_egr_encounter_relations</span><span class="p">(</span><span class="n">exemplar_eid</span><span class="p">)</span>
    <span class="c">#aid_list = ibs.get_valid_aids(is_exemplar=True)</span>
    <span class="c">#gid_list = ut.unique_ordered(ibs.get_annot_gids(aid_list))</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_get_exemplar_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">)))</span>
    <span class="c">#ibs.set_image_enctext(gid_list, [const.EXEMPLAR_ENCTEXT] * len(gid_list))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">exemplar_eid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@ut.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_reviewed_unreviewed_image_special_encounter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_reviewed_unreviewed_image_special_encounter">[docs]</a><span class="k">def</span> <span class="nf">update_reviewed_unreviewed_image_special_encounter</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates encounter of images that have not been reviewed</span>
<span class="sd">    and that have been reviewed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">unreviewed_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">UNREVIEWED_IMAGE_ENCTEXT</span><span class="p">)</span>
    <span class="n">reviewed_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">REVIEWED_IMAGE_ENCTEXT</span><span class="p">)</span>
    <span class="c">#ibs.delete_encounters(eid)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_egr_encounter_relations</span><span class="p">(</span><span class="n">unreviewed_eid</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_egr_encounter_relations</span><span class="p">(</span><span class="n">reviewed_eid</span><span class="p">)</span>
    <span class="c">#gid_list = ibs.get_valid_gids(reviewed=False)</span>
    <span class="c">#ibs.set_image_enctext(gid_list, [const.UNREVIEWED_IMAGE_ENCTEXT] * len(gid_list))</span>
    <span class="n">unreviewed_gids</span> <span class="o">=</span> <span class="n">_get_unreviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>  <span class="c"># hack</span>
    <span class="n">reviewed_gids</span>   <span class="o">=</span> <span class="n">_get_reviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>  <span class="c"># hack</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">(</span><span class="n">unreviewed_gids</span><span class="p">,</span> <span class="p">[</span><span class="n">unreviewed_eid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">unreviewed_gids</span><span class="p">))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">(</span><span class="n">reviewed_gids</span><span class="p">,</span> <span class="p">[</span><span class="n">reviewed_eid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">reviewed_gids</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@ut.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_all_image_special_encounter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_all_image_special_encounter">[docs]</a><span class="k">def</span> <span class="nf">update_all_image_special_encounter</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">allimg_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ALL_IMAGE_ENCTEXT</span><span class="p">)</span>
    <span class="c">#ibs.delete_encounters(allimg_eid)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="c">#ibs.set_image_enctext(gid_list, [const.ALL_IMAGE_ENCTEXT] * len(gid_list))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">allimg_eid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_special_eids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_special_eids">[docs]</a><span class="k">def</span> <span class="nf">get_special_eids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">get_enctext_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span>
    <span class="n">special_enctext_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">const</span><span class="o">.</span><span class="n">UNGROUPED_IMAGES_ENCTEXT</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ALL_IMAGE_ENCTEXT</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">UNREVIEWED_IMAGE_ENCTEXT</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">REVIEWED_IMAGE_ENCTEXT</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">EXEMPLAR_ENCTEXT</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">special_eids_</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_enctext_eid</span><span class="p">(</span><span class="n">enctext</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">enctext</span> <span class="ow">in</span> <span class="n">special_enctext_list</span><span class="p">]</span>
    <span class="n">special_eids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">special_eids_</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">special_eids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_ungrouped_gids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_ungrouped_gids">[docs]</a><span class="k">def</span> <span class="nf">get_ungrouped_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_ungrouped_gids</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs.delete_all_encounters()</span>
<span class="sd">        &gt;&gt;&gt; ibs.compute_encounters()</span>
<span class="sd">        &gt;&gt;&gt; ibs.update_special_encounters()</span>
<span class="sd">        &gt;&gt;&gt; # Now we want to remove some images from a non-special encounter</span>
<span class="sd">        &gt;&gt;&gt; nonspecial_eids = [i for i in ibs.get_valid_eids() if i not in ibs.get_special_eids()]</span>
<span class="sd">        &gt;&gt;&gt; print(&quot;Nonspecial EIDs %r&quot; % nonspecial_eids)</span>
<span class="sd">        &gt;&gt;&gt; images_to_remove = ibs.get_encounter_gids(nonspecial_eids[0:1])[0][0:1]</span>
<span class="sd">        &gt;&gt;&gt; print(&quot;Removing %r&quot; % images_to_remove)</span>
<span class="sd">        &gt;&gt;&gt; ibs.unrelate_images_and_encounters(images_to_remove,nonspecial_eids[0:1] * len(images_to_remove))</span>
<span class="sd">        &gt;&gt;&gt; ibs.update_special_encounters()</span>
<span class="sd">        &gt;&gt;&gt; ungr_eid = ibs.get_encounter_eids_from_text(const.UNGROUPED_IMAGES_ENCTEXT)</span>
<span class="sd">        &gt;&gt;&gt; print(&quot;Ungrouped gids %r&quot; % ibs.get_ungrouped_gids())</span>
<span class="sd">        &gt;&gt;&gt; print(&quot;Ungrouped eid %d contains %r&quot; % (ungr_eid, ibs.get_encounter_gids([ungr_eid])))</span>
<span class="sd">        &gt;&gt;&gt; ungr_gids = ibs.get_encounter_gids([ungr_eid])[0]</span>
<span class="sd">        &gt;&gt;&gt; assert(sorted(images_to_remove) == sorted(ungr_gids))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">special_eids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_special_eids</span><span class="p">(</span><span class="n">ibs</span><span class="p">))</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">eids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_eids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">has_eids</span> <span class="o">=</span> <span class="p">[</span><span class="n">special_eids</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">eids</span><span class="p">))</span> <span class="k">for</span> <span class="n">eids</span> <span class="ow">in</span> <span class="n">eids_list</span><span class="p">]</span>
    <span class="n">ungrouped_gids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">has_eids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ungrouped_gids</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@ut.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_ungrouped_special_encounter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_ungrouped_special_encounter">[docs]</a><span class="k">def</span> <span class="nf">update_ungrouped_special_encounter</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-update_ungrouped_special_encounter</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb9&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = update_ungrouped_special_encounter(ibs)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">ungrouped_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">UNGROUPED_IMAGES_ENCTEXT</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_egr_encounter_relations</span><span class="p">(</span><span class="n">ungrouped_eid</span><span class="p">)</span>
    <span class="n">ungrouped_gids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_ungrouped_gids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">(</span><span class="n">ungrouped_gids</span><span class="p">,</span> <span class="p">[</span><span class="n">ungrouped_eid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ungrouped_gids</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@ut.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_special_encounters"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_special_encounters">[docs]</a><span class="k">def</span> <span class="nf">update_special_encounters</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">USE_MORE_SPECIAL_ENCOUNTERS</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">ensure_attr</span><span class="p">(</span><span class="s">&#39;use_more_special_encounters&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">USE_MORE_SPECIAL_ENCOUNTERS</span><span class="p">:</span>
        <span class="c">#ibs.update_reviewed_unreviewed_image_special_encounter()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">update_exemplar_special_encounter</span><span class="p">()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">update_all_image_special_encounter</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">update_ungrouped_special_encounter</span><span class="p">()</span>

</div>
<span class="k">def</span> <span class="nf">_get_unreviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># hack</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {IMAGE_TABLE}</span>
<span class="sd">        WHERE</span>
<span class="sd">        image_toggle_reviewed=0</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">const</span><span class="o">.</span><span class="n">__dict__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="k">def</span> <span class="nf">_get_reviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># hack</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {IMAGE_TABLE}</span>
<span class="sd">        WHERE</span>
<span class="sd">        image_toggle_reviewed=1</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">const</span><span class="o">.</span><span class="n">__dict__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="k">def</span> <span class="nf">_get_gids_in_eid</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid</span><span class="p">):</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {EG_RELATION_TABLE}</span>
<span class="sd">        WHERE</span>
<span class="sd">            encounter_rowid==?</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">const</span><span class="o">.</span><span class="n">__dict__</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">eid</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="k">def</span> <span class="nf">_get_dirty_reviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid</span><span class="p">):</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {EG_RELATION_TABLE}</span>
<span class="sd">        WHERE</span>
<span class="sd">            encounter_rowid==? AND</span>
<span class="sd">            image_rowid NOT IN (SELECT rowid FROM {IMAGE_TABLE} WHERE image_toggle_reviewed=1)</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">const</span><span class="o">.</span><span class="n">__dict__</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">eid</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="k">def</span> <span class="nf">_get_exemplar_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {ANNOTATION_TABLE}</span>
<span class="sd">        WHERE annot_exemplar_flag=1</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">const</span><span class="o">.</span><span class="n">__dict__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<div class="viewcode-block" id="get_title"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_title">[docs]</a><span class="k">def</span> <span class="nf">get_title</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;IBEIS - No Database Directory Open&#39;</span>
    <span class="k">elif</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbdir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;IBEIS - !! INVALID DATABASE !!&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dbdir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbdir</span><span class="p">()</span>
        <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;IBEIS - </span><span class="si">%r</span><span class="s"> - Database Directory = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">title</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_stats"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_stats">[docs]</a><span class="k">def</span> <span class="nf">print_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.dev</span> <span class="kn">import</span> <span class="n">dbinfo</span>
    <span class="n">dbinfo</span><span class="o">.</span><span class="n">dbstats</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_dbinfo"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_dbinfo">[docs]</a><span class="k">def</span> <span class="nf">print_dbinfo</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.dev</span> <span class="kn">import</span> <span class="n">dbinfo</span>
    <span class="n">dbinfo</span><span class="o">.</span><span class="n">get_dbinfo</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_dbinfo_str"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_dbinfo_str">[docs]</a><span class="k">def</span> <span class="nf">get_dbinfo_str</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.dev</span> <span class="kn">import</span> <span class="n">dbinfo</span>
    <span class="k">return</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">get_dbinfo</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="s">&#39;info_str&#39;</span><span class="p">]</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_infostr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_infostr">[docs]</a><span class="k">def</span> <span class="nf">get_infostr</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns printable database information &quot;&quot;&quot;</span>
    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span>
    <span class="n">workdir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unixpath</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_workdir</span><span class="p">())</span>
    <span class="n">num_images</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_num_images</span><span class="p">()</span>
    <span class="n">num_annotations</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_num_annotations</span><span class="p">()</span>
    <span class="n">num_names</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_num_names</span><span class="p">()</span>
    <span class="n">infostr</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">    workdir = </span><span class="si">%r</span><span class="s"></span>
<span class="s">    dbname = </span><span class="si">%r</span><span class="s"></span>
<span class="s">    num_images = </span><span class="si">%r</span><span class="s"></span>
<span class="s">    num_annotations = </span><span class="si">%r</span><span class="s"></span>
<span class="s">    num_names = </span><span class="si">%r</span><span class="s"></span>
<span class="s">    &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">num_images</span><span class="p">,</span> <span class="n">num_annotations</span><span class="p">,</span> <span class="n">num_names</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">infostr</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_annotation_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_annotation_table">[docs]</a><span class="k">def</span> <span class="nf">print_annotation_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dumps annotation table to stdout</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>
<span class="sd">        verbosity (int):</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; verbosity = 1</span>
<span class="sd">        &gt;&gt;&gt; print_annotation_table(ibs, verbosity)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exclude_columns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;annot_uuid&#39;</span><span class="p">,</span> <span class="s">&#39;annot_verts&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="s">&#39;annot_xtl&#39;</span><span class="p">,</span> <span class="s">&#39;annot_ytl&#39;</span><span class="p">,</span> <span class="s">&#39;annot_width&#39;</span><span class="p">,</span> <span class="s">&#39;annot_height&#39;</span><span class="p">,</span>
            <span class="s">&#39;annot_theta&#39;</span><span class="p">,</span> <span class="s">&#39;annot_viewpoint&#39;</span><span class="p">,</span> <span class="s">&#39;annot_detect_confidence&#39;</span><span class="p">,</span>
            <span class="s">&#39;annot_note&#39;</span><span class="p">,</span> <span class="s">&#39;annot_parent_rowid&#39;</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_chip_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_chip_table">[docs]</a><span class="k">def</span> <span class="nf">print_chip_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">CHIP_TABLE</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_feat_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_feat_table">[docs]</a><span class="k">def</span> <span class="nf">print_feat_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">FEATURE_TABLE</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span>
        <span class="s">&#39;feature_keypoints&#39;</span><span class="p">,</span> <span class="s">&#39;feature_vecs&#39;</span><span class="p">]))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_image_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_image_table">[docs]</a><span class="k">def</span> <span class="nf">print_image_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">))</span>
    <span class="c">#, exclude_columns=[&#39;image_rowid&#39;]))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_lblannot_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_lblannot_table">[docs]</a><span class="k">def</span> <span class="nf">print_lblannot_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">LBLANNOT_TABLE</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_name_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_name_table">[docs]</a><span class="k">def</span> <span class="nf">print_name_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">NAME_TABLE</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_species_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_species_table">[docs]</a><span class="k">def</span> <span class="nf">print_species_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">SPECIES_TABLE</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_alr_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_alr_table">[docs]</a><span class="k">def</span> <span class="nf">print_alr_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">AL_RELATION_TABLE</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_config_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_config_table">[docs]</a><span class="k">def</span> <span class="nf">print_config_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">CONFIG_TABLE</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_encounter_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_encounter_table">[docs]</a><span class="k">def</span> <span class="nf">print_encounter_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ENCOUNTER_TABLE</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_egpairs_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_egpairs_table">[docs]</a><span class="k">def</span> <span class="nf">print_egpairs_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">EG_RELATION_TABLE</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_tables"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_tables">[docs]</a><span class="k">def</span> <span class="nf">print_tables</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude_tables</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">exclude_columns</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">exclude_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;annot_uuid&#39;</span><span class="p">,</span> <span class="s">&#39;lblannot_uuid&#39;</span><span class="p">,</span> <span class="s">&#39;annot_verts&#39;</span><span class="p">,</span> <span class="s">&#39;feature_keypoints&#39;</span><span class="p">,</span>
                           <span class="s">&#39;feature_vecs&#39;</span><span class="p">,</span> <span class="s">&#39;image_uuid&#39;</span><span class="p">,</span> <span class="s">&#39;image_uri&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">exclude_tables</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">exclude_tables</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;masks&#39;</span><span class="p">,</span> <span class="s">&#39;recognitions&#39;</span><span class="p">,</span> <span class="s">&#39;chips&#39;</span><span class="p">,</span> <span class="s">&#39;features&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">exclude_tables</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">))</span>
    <span class="c">#ibs.print_image_table()</span>
    <span class="c">#ibs.print_annotation_table()</span>
    <span class="c">#ibs.print_lblannots_table()</span>
    <span class="c">#ibs.print_alr_table()</span>
    <span class="c">#ibs.print_config_table()</span>
    <span class="c">#ibs.print_chip_table()</span>
    <span class="c">#ibs.print_feat_table()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="is_aid_unknown"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.is_aid_unknown">[docs]</a><span class="k">def</span> <span class="nf">is_aid_unknown</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="make_enctext_list"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.make_enctext_list">[docs]</a><span class="k">def</span> <span class="nf">make_enctext_list</span><span class="p">(</span><span class="n">eid_list</span><span class="p">,</span> <span class="n">enc_cfgstr</span><span class="p">):</span>
    <span class="c"># DEPRICATE</span>
    <span class="n">enctext_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span> <span class="o">+</span> <span class="n">enc_cfgstr</span> <span class="k">for</span> <span class="n">eid</span> <span class="ow">in</span> <span class="n">eid_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">enctext_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="make_next_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.make_next_name">[docs]</a><span class="k">def</span> <span class="nf">make_next_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Creates a number of names which are not in the database, but does not</span>
<span class="sd">    add them &quot;&quot;&quot;</span>
    <span class="n">base_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_known_name_rowids</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c"># ibs.get_num_names()</span>
    <span class="n">userid</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_user_name</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">(</span><span class="s">&#39;tag&#39;</span><span class="p">)</span>
    <span class="c">#timestamp_suffix = &#39;_TMP_&#39;</span>
    <span class="n">timestamp_suffix</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span>
    <span class="n">timestamp_prefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">name_prefix</span> <span class="o">=</span> <span class="n">timestamp_prefix</span> <span class="o">+</span> <span class="n">timestamp</span> <span class="o">+</span> <span class="n">timestamp_suffix</span> <span class="o">+</span> <span class="n">userid</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span>
    <span class="k">if</span> <span class="n">num</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">next_name</span> <span class="o">=</span> <span class="n">name_prefix</span> <span class="o">+</span> <span class="s">&#39;</span><span class="si">%04d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">base_index</span>
        <span class="k">return</span> <span class="n">next_name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">next_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name_prefix</span> <span class="o">+</span> <span class="s">&#39;</span><span class="si">%04d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_index</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">next_names</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="prune_exemplars"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.prune_exemplars">[docs]</a><span class="k">def</span> <span class="nf">prune_exemplars</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Prunes exemplars from names with too many exemplars.</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">()</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_exemplar_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">max_exemplars</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">other_cfg</span><span class="o">.</span><span class="n">max_exemplars</span>
    <span class="n">problem_aids</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_exemplars</span><span class="p">]</span>
    <span class="n">problem_bboxes</span> <span class="o">=</span> <span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">,</span> <span class="n">problem_aids</span><span class="p">)</span>
    <span class="c">#problem_gids   = unflat_map(ibs.get_annot_gids, problem_aids)</span>
    <span class="c">#problem_sizes  = unflat_map(ibs.get_image_sizes, problem_gids)</span>
    <span class="k">def</span> <span class="nf">bbox_area</span><span class="p">(</span><span class="n">bbox</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">bbox</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">bbox</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">bboxes_area</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">bbox_area</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">))</span>

    <span class="c"># Get area of annotations, area of parent images, and the ratio</span>

    <span class="n">problem_annot_areas</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">bboxes_area</span><span class="p">,</span> <span class="n">problem_bboxes</span><span class="p">))))</span>

    <span class="c">#problem_img_areas = list(map(np.array, list(map(bboxes_area, problem_sizes))))</span>

    <span class="c">#problem_ratios = [(annot_areas / img_areas) for annot_areas, img_areas in</span>
    <span class="c">#                  zip(problem_annot_areas, problem_img_areas)]</span>

    <span class="n">problem_sortx</span> <span class="o">=</span> <span class="p">[</span><span class="n">areas</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span> <span class="k">for</span> <span class="n">areas</span> <span class="ow">in</span> <span class="n">problem_annot_areas</span><span class="p">]</span>
    <span class="c"># Get aids with the smallest bounding boxes to unexemplar</span>
    <span class="n">small_aids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">aids</span><span class="p">[</span><span class="n">sortx</span><span class="p">][:</span><span class="o">-</span><span class="n">max_exemplars</span><span class="p">]</span> <span class="k">for</span> <span class="n">aids</span><span class="p">,</span> <span class="n">sortx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">problem_aids</span><span class="p">,</span> <span class="n">problem_sortx</span><span class="p">)]</span>
    <span class="n">small_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">small_aids_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_exemplar_flags</span><span class="p">(</span><span class="n">small_aids</span><span class="p">,</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">small_aids</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="draw_thumb_helper"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.draw_thumb_helper">[docs]</a><span class="k">def</span> <span class="nf">draw_thumb_helper</span><span class="p">(</span><span class="n">tup</span><span class="p">):</span>
    <span class="n">thumb_path</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">,</span> <span class="n">gpath</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span> <span class="o">=</span> <span class="n">tup</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">gtool</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">gpath</span><span class="p">)</span>  <span class="c"># time consuming</span>
    <span class="p">(</span><span class="n">gh</span><span class="p">,</span> <span class="n">gw</span><span class="p">)</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">img_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">gw</span><span class="p">,</span> <span class="n">gh</span><span class="p">)</span>
    <span class="n">max_dsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">thumbsize</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">)</span>
    <span class="n">dsize</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">gtool</span><span class="o">.</span><span class="n">resized_clamped_thumb_dims</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">max_dsize</span><span class="p">)</span>
    <span class="n">new_verts_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gtool</span><span class="o">.</span><span class="n">scale_bbox_to_verts_gen</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">))</span>
    <span class="c">#thumb = gtool.resize_thumb(img, max_dsize)</span>
    <span class="c"># -----------------</span>
    <span class="c"># Actual computation</span>
    <span class="n">thumb</span> <span class="o">=</span> <span class="n">gtool</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dsize</span><span class="p">)</span>
    <span class="n">orange_bgr</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">new_verts</span> <span class="ow">in</span> <span class="n">new_verts_list</span><span class="p">:</span>
        <span class="n">thumb</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">draw_verts</span><span class="p">(</span><span class="n">thumb</span><span class="p">,</span> <span class="n">new_verts</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">orange_bgr</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">gtool</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">,</span> <span class="n">thumb</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#return (thumb_path, thumb)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="preprocess_image_thumbs"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.preprocess_image_thumbs">[docs]</a><span class="k">def</span> <span class="nf">preprocess_image_thumbs</span><span class="p">(</span>
        <span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes thumbs of images in parallel based on kwargs &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] preprocess_image_thumbs&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">thumbsize</span> <span class="o">=</span> <span class="mi">128</span>
    <span class="n">thumbpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_thumbpath</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">thumbsize</span><span class="o">=</span><span class="n">thumbsize</span><span class="p">)</span>
    <span class="c">#use_cache = False</span>
    <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
        <span class="n">exists_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">exists</span><span class="p">,</span> <span class="n">thumbpath_list</span><span class="p">))</span>
        <span class="n">gid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">exists_list</span><span class="p">)</span>
        <span class="n">thumbpath_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">thumbpath_list</span><span class="p">,</span> <span class="n">exists_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gid_list_</span> <span class="o">=</span> <span class="n">gid_list</span>
        <span class="n">thumbpath_list_</span> <span class="o">=</span> <span class="n">thumbpath_list</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span>

    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span>
    <span class="n">bboxes_list</span> <span class="o">=</span> <span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="n">thetas_list</span> <span class="o">=</span> <span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>

    <span class="n">args_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">thumb_path</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">,</span> <span class="n">gpath</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">thumb_path</span><span class="p">,</span> <span class="n">gpath</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span> <span class="ow">in</span>
                 <span class="nb">zip</span><span class="p">(</span><span class="n">thumbpath_list_</span><span class="p">,</span> <span class="n">gpath_list</span><span class="p">,</span> <span class="n">bboxes_list</span><span class="p">,</span> <span class="n">thetas_list</span><span class="p">)]</span>

    <span class="c"># Execute all tasks in parallel</span>
    <span class="n">genkw</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;ordered&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&#39;chunksize&#39;</span><span class="p">:</span> <span class="n">chunksize</span><span class="p">,</span>
        <span class="c">#&#39;force_serial&#39;: True,</span>
    <span class="p">}</span>
    <span class="c">#genkw[&#39;force_serial&#39;] = True</span>
    <span class="c">#genkw[&#39;chunksize&#39;] = max(len(gid_list_) // 16, 1)</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">draw_thumb_helper</span><span class="p">,</span> <span class="n">args_list</span><span class="p">,</span> <span class="n">nTasks</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">args_list</span><span class="p">),</span> <span class="o">**</span><span class="n">genkw</span><span class="p">)</span>
    <span class="c">#for output in gen:</span>
    <span class="c">#    #with ut.Timer(&#39;gentime&#39;):</span>
    <span class="c">#    gtool.imwrite(output[0], output[1])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">six</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">pass</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="compute_all_thumbs"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_all_thumbs">[docs]</a><span class="k">def</span> <span class="nf">compute_all_thumbs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">preprocess_image_thumbs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="group_annots_by_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.group_annots_by_name">[docs]</a><span class="k">def</span> <span class="nf">group_annots_by_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    This function is probably the fastest of its siblings</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (list):</span>
<span class="sd">        distinguish_unknowns (bool):</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: grouped_aids_, unique_nids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-group_annots_by_name</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; distinguish_unknowns = True</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = group_annots_by_name(ibs, aid_list, distinguish_unknowns)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="n">distinguish_unknowns</span><span class="p">))</span>
    <span class="n">unique_nids</span><span class="p">,</span> <span class="n">groupxs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">group_indicies</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">grouped_aids_</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="n">groupxs_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">grouped_aids_</span><span class="p">,</span> <span class="n">unique_nids</span>

</div>
<div class="viewcode-block" id="group_annots_by_known_names_nochecks"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.group_annots_by_known_names_nochecks">[docs]</a><span class="k">def</span> <span class="nf">group_annots_by_known_names_nochecks</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">nid2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">nid2_aids</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="group_annots_by_known_names"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.group_annots_by_known_names">[docs]</a><span class="k">def</span> <span class="nf">group_annots_by_known_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">checks</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    FIXME; rectify this</span>
<span class="sd">    #&gt;&gt;&gt; import ibeis  # NOQA</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-group_annots_by_known_names</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(db=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13]</span>
<span class="sd">        &gt;&gt;&gt; known_aids_list, unknown_aids = group_annots_by_known_names(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; result = str(known_aids_list) + &#39;\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; result += str(unknown_aids)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [[2, 3], [5, 6], [7], [8], [10], [12], [13]]</span>
<span class="sd">        [11, 9, 4, 1]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">nid2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>
    <span class="n">aid_gen</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">)</span>
    <span class="n">isunknown_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">))</span>
    <span class="n">known_aids_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ifilterfalse_items</span><span class="p">(</span><span class="n">aid_gen</span><span class="p">(),</span> <span class="n">isunknown_list</span><span class="p">))</span>
    <span class="n">unknown_aids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iflatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ifilter_items</span><span class="p">(</span><span class="n">aid_gen</span><span class="p">(),</span> <span class="n">isunknown_list</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
        <span class="c"># http://stackoverflow.com/questions/482014/how-would-you-do-the-equivalent-of-preprocessor-directives-in-python</span>
        <span class="n">nidgroup_list</span> <span class="o">=</span> <span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">,</span> <span class="n">known_aids_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nidgroup</span> <span class="ow">in</span> <span class="n">nidgroup_list</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_allsame</span><span class="p">(</span><span class="n">nidgroup</span><span class="p">),</span> <span class="s">&#39;bad name grouping&#39;</span>
    <span class="k">return</span> <span class="n">known_aids_list</span><span class="p">,</span> <span class="n">unknown_aids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_upsize_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_upsize_data">[docs]</a><span class="k">def</span> <span class="nf">get_upsize_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">num_samp</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">clamp_gt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">clamp_gf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns qaids and a corresponding list of lists for true matches and false</span>
<span class="sd">    matches to try.</span>

<span class="sd">    each item in the zip(*upsizetup) is qaid, true_aids, false_aids_samples</span>
<span class="sd">    which corresponds to a query aid and a list of true aids and false aids</span>
<span class="sd">    to try it as a query against.</span>

<span class="sd">    get_upsize_data</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>
<span class="sd">        qaid_list (int): query annotation id</span>
<span class="sd">        daid_list (list):</span>
<span class="sd">        num_samp (int):</span>
<span class="sd">        clamp_gt (int):</span>
<span class="sd">        clamp_gf (int):</span>
<span class="sd">        seed (int): if False seed is random else seeds numpy random num gen</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: upsizetup</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_upsize_data</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; qaid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; daid_list = None</span>
<span class="sd">        &gt;&gt;&gt; num_samp = 5</span>
<span class="sd">        &gt;&gt;&gt; clamp_gt = 1</span>
<span class="sd">        &gt;&gt;&gt; clamp_gf = 1</span>
<span class="sd">        &gt;&gt;&gt; seed = 143039</span>
<span class="sd">        &gt;&gt;&gt; upsizetup = get_upsize_data(ibs, qaid_list, daid_list, num_samp, clamp_gt, clamp_gf, seed)</span>
<span class="sd">        &gt;&gt;&gt; (qaid_list, qaid_trues_list, qaid_false_samples_list, nTotal) = upsizetup</span>
<span class="sd">        &gt;&gt;&gt; assert len(qaid_list) == 119</span>
<span class="sd">        &gt;&gt;&gt; assert len(qaid_trues_list) == 119</span>
<span class="sd">        &gt;&gt;&gt; assert len(qaid_false_samples_list) == 119</span>
<span class="sd">        &gt;&gt;&gt; assert nTotal == 525</span>
<span class="sd">        &gt;&gt;&gt; qaid, true_aids, false_aids_samples = six.next(zip(qaid_list, qaid_trues_list, qaid_false_samples_list))</span>
<span class="sd">        &gt;&gt;&gt; result = ut.hashstr(str(upsizetup))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        objl8qnhyics@0cr</span>

<span class="sd">    b9lvi3nz&amp;ld9u8rg</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
        <span class="c"># Determanism</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">daid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">daid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="c"># List of database sizes to test</span>
    <span class="n">samp_min</span><span class="p">,</span> <span class="n">samp_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_num_names</span><span class="p">())</span>
    <span class="n">dbsamplesize_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sample_domain</span><span class="p">(</span><span class="n">samp_min</span><span class="p">,</span> <span class="n">samp_max</span><span class="p">,</span> <span class="n">num_samp</span><span class="p">)</span>
    <span class="c">#</span>
    <span class="c"># Sample true and false matches for every query annotation</span>
    <span class="n">qaid_trues_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_groundtruth_sample</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">per_name</span><span class="o">=</span><span class="n">clamp_gt</span><span class="p">)</span>
    <span class="n">qaid_falses_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_groundfalse_sample</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">per_name</span><span class="o">=</span><span class="n">clamp_gf</span><span class="p">)</span>
    <span class="c">#</span>
    <span class="c"># Vary the size of the falses</span>
    <span class="k">def</span> <span class="nf">generate_varied_falses</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">false_aids</span> <span class="ow">in</span> <span class="n">qaid_falses_list</span><span class="p">:</span>
            <span class="n">false_sample_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">dbsize</span> <span class="ow">in</span> <span class="n">dbsamplesize_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dbsize</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">false_aids</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">false_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">false_aids</span><span class="p">,</span> <span class="n">dbsize</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">false_sample_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">false_sample</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">false_sample_list</span>
    <span class="n">qaid_false_samples_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">generate_varied_falses</span><span class="p">())</span>

    <span class="c">#</span>
    <span class="c"># Get a rough idea of how many queries will be run</span>
    <span class="n">nTotal</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">false_aids_samples</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_aids</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">true_aids</span><span class="p">,</span> <span class="n">false_aids_samples</span>
                  <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qaid_false_samples_list</span><span class="p">,</span> <span class="n">qaid_trues_list</span><span class="p">)])</span>
    <span class="n">upsizetup</span> <span class="o">=</span> <span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">qaid_trues_list</span><span class="p">,</span> <span class="n">qaid_false_samples_list</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">upsizetup</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_rowid_sample"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_rowid_sample">[docs]</a><span class="k">def</span> <span class="nf">get_annot_rowid_sample</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">per_name</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_ngt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                           <span class="n">stagger_names</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        per_name (int):</span>
<span class="sd">        min_ngt (int):</span>
<span class="sd">        seed (int):</span>
<span class="sd">        aid_list (list):</span>

<span class="sd">    Returns:</span>
<span class="sd">        ?: sample_aids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_annot_rowid_sample</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; per_name = 100</span>
<span class="sd">        &gt;&gt;&gt; min_ngt = 1</span>
<span class="sd">        &gt;&gt;&gt; seed = 0</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; sample_aids = ibs.get_annot_rowid_sample(per_name, min_ngt, seed)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = str(sample_aids)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#qaids = ibs.get_easy_annot_rowids()</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">())</span>
    <span class="n">grouped_aids_</span><span class="p">,</span> <span class="n">unique_nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">grouped_aids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_ngt</span><span class="p">,</span> <span class="n">grouped_aids_</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">stagger_names</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="n">zip_longest</span>
        <span class="n">sample_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_Nones</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iflatten</span><span class="p">(</span><span class="n">zip_longest</span><span class="p">(</span><span class="o">*</span><span class="n">ut</span><span class="o">.</span><span class="n">sample_lists</span><span class="p">(</span><span class="n">grouped_aids</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">per_name</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">))))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sample_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">sample_lists</span><span class="p">(</span><span class="n">grouped_aids</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">per_name</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">sample_aids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_groundfalse_sample"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_groundfalse_sample">[docs]</a><span class="k">def</span> <span class="nf">get_annot_groundfalse_sample</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">per_name</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get_annot_groundfalse_sample</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>
<span class="sd">        aid_list (list):</span>
<span class="sd">        per_name (int): number of groundfalse per name</span>
<span class="sd">        seed (bool or int): if False no seed, otherwise seeds numpy randgen</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: gf_aids_list</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()[::4]</span>
<span class="sd">        &gt;&gt;&gt; per_name = 1</span>
<span class="sd">        &gt;&gt;&gt; seed = 42</span>
<span class="sd">        &gt;&gt;&gt; sample_trues_list = get_annot_groundfalse_sample(ibs, aid_list, per_name, seed)</span>
<span class="sd">        &gt;&gt;&gt; result = str(sample_trues_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [[3, 5, 7, 8, 10, 12, 13], [3, 7, 8, 10, 12, 13], [3, 6, 7, 8, 10, 12, 13], [2, 6, 7, 8, 10, 12]]</span>

<span class="sd">        [[2, 6, 7, 8, 10, 12, 13], [2, 7, 8, 10, 12, 13], [2, 5, 7, 8, 10, 12, 13], [2, 6, 7, 8, 10, 12]]</span>
<span class="sd">        [[2, 5, 7, 8, 10, 12, 13], [3, 7, 8, 10, 12, 13], [2, 5, 7, 8, 10, 12, 13], [3, 5, 7, 8, 10, 12]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
        <span class="c"># Determanism</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="c"># Get valid names</span>
    <span class="n">valid_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">valid_nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">)</span>
    <span class="n">nid2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">,</span> <span class="n">valid_nids</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nid2_aids</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">nid</span><span class="p">):</span>
            <span class="c"># Remove unknown</span>
            <span class="k">del</span> <span class="n">nid2_aids</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="c"># Cast into numpy arrays</span>
        <span class="n">aids</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">[</span><span class="n">nid</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Remove empties</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] name with 0 aids. need to clean database&#39;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">nid2_aids</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="n">nid2_aids</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">aids</span>
        <span class="c"># Shuffle known annotations in each name</span>
        <span class="c">#np.random.shuffle(aids)</span>
    <span class="c"># Get not beloning to input names</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sample</span><span class="p">(</span><span class="n">nid_</span><span class="p">):</span>
        <span class="n">aids_iter</span> <span class="o">=</span> <span class="p">(</span><span class="n">aids</span> <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">)</span> <span class="k">if</span> <span class="n">nid</span> <span class="o">!=</span> <span class="n">nid_</span><span class="p">)</span>
        <span class="n">sample_gf_aids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">per_name</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_iter</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">sample_gf_aids</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">gf_aids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_sample</span><span class="p">(</span><span class="n">nid_</span><span class="p">)</span> <span class="k">for</span> <span class="n">nid_</span> <span class="ow">in</span> <span class="n">nid_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">gf_aids_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_groundtruth_sample"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_groundtruth_sample">[docs]</a><span class="k">def</span> <span class="nf">get_annot_groundtruth_sample</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">per_name</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isexemplar</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get_annot_groundtruth_sample</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>
<span class="sd">        aid_list (list):</span>
<span class="sd">        per_name (int):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-get_annot_groundtruth_sample --verbose-class</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()[::2]</span>
<span class="sd">        &gt;&gt;&gt; per_name = 1</span>
<span class="sd">        &gt;&gt;&gt; result = get_annot_groundtruth_sample(ibs, aid_list, per_name)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [[], [2], [6], [], [], [], []]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_trues_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_groundtruth</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">noself</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">is_exemplar</span><span class="o">=</span><span class="n">isexemplar</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">random_choice</span><span class="p">(</span><span class="n">aids</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="n">per_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">sample_trues_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">random_choice</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">all_trues_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sample_trues_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_aids_with_groundtruth"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_aids_with_groundtruth">[docs]</a><span class="k">def</span> <span class="nf">get_aids_with_groundtruth</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns aids with valid groundtruth &quot;&quot;&quot;</span>
    <span class="n">valid_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">has_gt_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_has_groundtruth</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">)</span>
    <span class="n">hasgt_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">,</span> <span class="n">has_gt_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hasgt_aids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="export_encounters"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.export_encounters">[docs]</a><span class="k">def</span> <span class="nf">export_encounters</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid_list</span><span class="p">,</span> <span class="n">new_dbdir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_gids</span><span class="p">(</span><span class="n">eid_list</span><span class="p">))))</span>
    <span class="k">if</span> <span class="n">new_dbdir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">ibeis.dev</span> <span class="kn">import</span> <span class="n">sysres</span>
        <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span>
        <span class="n">enc_texts</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_enctext</span><span class="p">(</span><span class="n">eid_list</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">nimg_text</span> <span class="o">=</span> <span class="s">&#39;nImg=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">new_dbname</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">enc_texts</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">nimg_text</span>
        <span class="n">workdir</span> <span class="o">=</span> <span class="n">sysres</span><span class="o">.</span><span class="n">get_workdir</span><span class="p">()</span>
        <span class="n">new_dbdir_</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">new_dbname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_dbdir_</span> <span class="o">=</span> <span class="n">new_dbdir</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">export_images</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">new_dbdir_</span><span class="o">=</span><span class="n">new_dbdir_</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="export_images"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.export_images">[docs]</a><span class="k">def</span> <span class="nf">export_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">new_dbdir_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; See ibeis/tests/test_ibs_export.py &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.dbio</span> <span class="kn">import</span> <span class="n">export_subset</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] exporting to new_dbdir_=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">new_dbdir_</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] opening database&#39;</span><span class="p">)</span>
    <span class="n">ibs_dst</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="n">dbdir</span><span class="o">=</span><span class="n">new_dbdir_</span><span class="p">,</span> <span class="n">allow_newdir</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] begining transfer&#39;</span><span class="p">)</span>
    <span class="n">ibs_src</span> <span class="o">=</span> <span class="n">ibs</span>
    <span class="n">gid_list1</span> <span class="o">=</span> <span class="n">gid_list</span>
    <span class="n">aid_list1</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">include_image_annots</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">export_subset</span><span class="o">.</span><span class="n">execute_transfer</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">ibs_dst</span><span class="p">,</span> <span class="n">gid_list1</span><span class="p">,</span>
                                            <span class="n">aid_list1</span><span class="p">,</span> <span class="n">include_image_annots</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="set_dbnotes"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_dbnotes">[docs]</a><span class="k">def</span> <span class="nf">set_dbnotes</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">notes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; sets notes for an entire database &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">IBEISControl</span><span class="o">.</span><span class="n">IBEISController</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbnotes_fpath</span><span class="p">(),</span> <span class="n">notes</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_dbnotes_fpath"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_dbnotes_fpath">[docs]</a><span class="k">def</span> <span class="nf">get_dbnotes_fpath</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">notes_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_ibsdir</span><span class="p">(),</span> <span class="s">&#39;dbnotes.txt&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ensure</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbnotes_fpath</span><span class="p">()):</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_dbnotes</span><span class="p">(</span><span class="s">&#39;None&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">notes_fpath</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_dbnotes"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_dbnotes">[docs]</a><span class="k">def</span> <span class="nf">get_dbnotes</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; sets notes for an entire database &quot;&quot;&quot;</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">read_from</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbnotes_fpath</span><span class="p">(),</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">notes</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_dbnotes</span><span class="p">(</span><span class="s">&#39;None&#39;</span><span class="p">)</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">read_from</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbnotes_fpath</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">notes</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="annotstr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.annotstr">[docs]</a><span class="k">def</span> <span class="nf">annotstr</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;aid=</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">aid</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="redownload_detection_models"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.redownload_detection_models">[docs]</a><span class="k">def</span> <span class="nf">redownload_detection_models</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -c &quot;from ibeis.model.detect import grabmodels; grabmodels.redownload_models()&quot;</span>
<span class="sd">        python -c &quot;import utool, ibeis.model; utool.view_directory(ibeis.model.detect.grabmodels._expand_modeldir())&quot;</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = redownload_detection_models(ibs)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] redownload_detection_models&#39;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">ibeis.model.detect</span> <span class="kn">import</span> <span class="n">grabmodels</span>
    <span class="n">modeldir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_detect_modeldir</span><span class="p">()</span>
    <span class="n">grabmodels</span><span class="o">.</span><span class="n">redownload_models</span><span class="p">(</span><span class="n">modeldir</span><span class="o">=</span><span class="n">modeldir</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="view_model_dir"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.view_model_dir">[docs]</a><span class="k">def</span> <span class="nf">view_model_dir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] redownload_detection_models&#39;</span><span class="p">)</span>
    <span class="n">modeldir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_detect_modeldir</span><span class="p">()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">view_directory</span><span class="p">(</span><span class="n">modeldir</span><span class="p">)</span>
    <span class="c">#grabmodels.redownload_models(modeldir=modeldir)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="fix_invalid_nids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_invalid_nids">[docs]</a><span class="k">def</span> <span class="nf">fix_invalid_nids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Make sure that all rowids are greater than 0</span>

<span class="sd">    We can only handle there being a name with rowid 0 if it is UNKNOWN. In this</span>
<span class="sd">    case we safely delete it, but anything more complicated needs to be handled</span>
<span class="sd">    anually</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-fix_invalid_nids</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = fix_invalid_nids(ibs)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Get actual rowids from sql database (no postprocessing)</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_known_name_rowids</span><span class="p">()</span>
    <span class="c"># Get actual names from sql database (no postprocessing)</span>
    <span class="n">name_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">apply_fix</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">is_invalid_nid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">nid</span> <span class="o">&lt;=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">UNKNOWN_NAME_ROWID</span> <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nid_list</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_invalid_nid_list</span><span class="p">):</span>
        <span class="n">invalid_nids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">is_invalid_nid_list</span><span class="p">)</span>
        <span class="n">invalid_texts</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">name_text_list</span><span class="p">,</span> <span class="n">is_invalid_nid_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_nids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span>
              <span class="n">invalid_nids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ibs</span><span class="o">.</span><span class="n">UNKNOWN_NAME_ROWID</span> <span class="ow">and</span>
              <span class="n">invalid_texts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">):</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">delete_names</span><span class="p">([</span><span class="n">ibs</span><span class="o">.</span><span class="n">UNKNOWN_NAME_ROWID</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errmsg</span> <span class="o">=</span> <span class="s">&#39;Unfixable error: Found invalid (nid, text) pairs: &#39;</span>
            <span class="n">errmsg</span> <span class="o">+=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">invalid_nids</span><span class="p">,</span> <span class="n">invalid_texts</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="fix_invalid_name_texts"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_invalid_name_texts">[docs]</a><span class="k">def</span> <span class="nf">fix_invalid_name_texts</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Ensure  that no name text is empty or &#39;____&#39;</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-fix_invalid_names</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = fix_invalid_name_texts(ibs)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>

<span class="sd">    ibs.set_name_texts(nid_list[3], &#39;____&#39;)</span>
<span class="sd">    ibs.set_name_texts(nid_list[2], &#39;&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;checking for invalid name texts&#39;</span><span class="p">)</span>
    <span class="c"># Get actual rowids from sql database (no postprocessing)</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_known_name_rowids</span><span class="p">()</span>
    <span class="c"># Get actual names from sql database (no postprocessing)</span>
    <span class="n">name_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">apply_fix</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">invalid_name_set</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">}</span>
    <span class="n">is_invalid_name_text_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">name_text</span> <span class="ow">in</span> <span class="n">invalid_name_set</span>
                                 <span class="k">for</span> <span class="n">name_text</span> <span class="ow">in</span> <span class="n">name_text_list</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_invalid_name_text_list</span><span class="p">):</span>
        <span class="n">invalid_nids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">is_invalid_name_text_list</span><span class="p">)</span>
        <span class="n">invalid_texts</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">name_text_list</span><span class="p">,</span> <span class="n">is_invalid_name_text_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="n">invalid_nid</span><span class="p">,</span> <span class="n">invalid_text</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">invalid_nids</span><span class="p">,</span> <span class="n">invalid_texts</span><span class="p">)):</span>
            <span class="n">conflict_set</span> <span class="o">=</span> <span class="n">invalid_name_set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">apply_fix</span><span class="o">=</span><span class="bp">False</span><span class="p">)))</span>
            <span class="n">base_str</span> <span class="o">=</span> <span class="s">&#39;fixedname</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">invalid_text</span>
            <span class="n">new_text</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_nonconflicting_string</span><span class="p">(</span><span class="n">base_str</span><span class="p">,</span> <span class="n">conflict_set</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Fixing name </span><span class="si">%r</span><span class="s"> -&gt; </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">invalid_text</span><span class="p">,</span> <span class="n">new_text</span><span class="p">))</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">set_name_texts</span><span class="p">((</span><span class="n">invalid_nid</span><span class="p">,),</span> <span class="p">(</span><span class="n">new_text</span><span class="p">,))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Fixed </span><span class="si">%d</span><span class="s"> name texts&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_nids</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;all names seem valid&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="fix_unknown_exemplars"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_unknown_exemplars">[docs]</a><span class="k">def</span> <span class="nf">fix_unknown_exemplars</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Goes through all of the annotations, and sets their exemplar flag to 0 if it</span>
<span class="sd">    is associated with an unknown annotation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="c">#nid_list = ibs.get_annot_nids(aid_list, distinguish_unknowns=False)</span>
    <span class="n">flag_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_exemplar_flags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">unknown_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_aid_unknown</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="c"># Exemplars should all be known</span>
    <span class="n">unknown_exemplar_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">flag_list</span><span class="p">,</span> <span class="n">unknown_list</span><span class="p">)</span>
    <span class="n">unknown_aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">unknown_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Fixing </span><span class="si">%d</span><span class="s"> unknown annotations set as exemplars&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">unknown_exemplar_flags</span><span class="p">),))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_exemplar_flags</span><span class="p">(</span><span class="n">unknown_aid_list</span><span class="p">,</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown_aid_list</span><span class="p">))</span>
    <span class="c">#is_error = [not flag for flag in unknown_exemplar_flags]</span>
    <span class="c">#new_annots = [flag if nid != const.UNKNOWN_NAME_ROWID else 0</span>
    <span class="c">#              for nid, flag in</span>
    <span class="c">#              zip(nid_list, flag_list)]</span>
    <span class="c">#ibs.set_annot_exemplar_flags(aid_list, new_annots)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="merge_names"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.merge_names">[docs]</a><span class="k">def</span> <span class="nf">merge_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">merge_name</span><span class="p">,</span> <span class="n">other_names</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        merge_name (str):</span>
<span class="sd">        other_names (list):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-merge_names</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; merge_name = &#39;zebra&#39;</span>
<span class="sd">        &gt;&gt;&gt; other_names = [&#39;occl&#39;, &#39;jeff&#39;]</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = merge_names(ibs, merge_name, other_names)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        &gt;&gt;&gt; ibs.print_names_table()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] merging other_names=</span><span class="si">%r</span><span class="s"> into merge_name=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">other_names</span><span class="p">,</span> <span class="n">merge_name</span><span class="p">))</span>
    <span class="n">other_nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_rowids_from_text</span><span class="p">(</span><span class="n">other_names</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_name_alias_texts</span><span class="p">(</span><span class="n">other_nid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">merge_name</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_nid_list</span><span class="p">))</span>
    <span class="n">other_aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">other_nid_list</span><span class="p">)</span>
    <span class="n">other_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">other_aids_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] ... </span><span class="si">%r</span><span class="s"> annotations are being merged into merge_name=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other_aids</span><span class="p">),</span> <span class="n">merge_name</span><span class="p">))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_names</span><span class="p">(</span><span class="n">other_aids</span><span class="p">,</span> <span class="p">[</span><span class="n">merge_name</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_aids</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="export_testset_for_chuck"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.export_testset_for_chuck">[docs]</a><span class="k">def</span> <span class="nf">export_testset_for_chuck</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">min_num_annots</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exports a set with some number of annotations that has good demo examples.</span>
<span class="sd">    multiple annotations per name and large time variation within names.</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-export_testset_for_chuck --dbdir /raid/work2/Turk/PZ_Master --min-num-annots 100</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-export_testset_for_chuck --dbdir /raid/work2/Turk/PZ_Master --min-num-annots 500</span>

<span class="sd">        python -m ibeis.ibsfuncs --test-export_testset_for_chuck --dbdir /raid/work2/Turk/GZ_Master --min-num-annots 100</span>
<span class="sd">        python -m ibeis.ibsfuncs --test-export_testset_for_chuck --dbdir /raid/work2/Turk/GZ_Master --min-num-annots 500</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; dbdir = ut.get_argval((&#39;--dbdir&#39;,), type_=str, default=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; min_num_annots = ut.get_argval((&#39;--min-num-annots&#39;,), type_=int, default=500)</span>
<span class="sd">        &gt;&gt;&gt; #ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #ibs = ibeis.opendb(dbdir=&#39;/raid/work2/Turk/PZ_Master&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(dbdir=dbdir)</span>
<span class="sd">        &gt;&gt;&gt; #ibs = ibeis.opendb(dbdir=&#39;/raid/work2/Turk/GZ_Master&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print(ibs.get_dbinfo_str())</span>
<span class="sd">        &gt;&gt;&gt; #ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = export_testset_for_chuck(ibs, min_num_annots)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>

<span class="sd">    min_num_annots = 500</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

    <span class="n">min_num_annots_per_name</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">max_annot_per_image</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="c">#3</span>

    <span class="c">#min_num_annots_per_name = 1</span>
    <span class="c">#max_annot_per_image = 3000</span>

    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">()</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">nAids_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">))</span>
    <span class="n">nOther_aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_num_contact_aids</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>

    <span class="n">invalid_by_num_annots</span> <span class="o">=</span> <span class="p">[</span><span class="n">num</span> <span class="o">&lt;</span> <span class="n">min_num_annots_per_name</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">nAids_list</span><span class="p">]</span>
    <span class="n">invalid_by_num_others</span> <span class="o">=</span> <span class="p">[</span><span class="nb">any</span><span class="p">([</span><span class="n">num</span> <span class="o">&gt;</span> <span class="n">max_annot_per_image</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">nums</span><span class="p">])</span>
                             <span class="k">for</span> <span class="n">nums</span> <span class="ow">in</span> <span class="n">nOther_aids_list</span><span class="p">]</span>
    <span class="n">invalid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">or_lists</span><span class="p">(</span><span class="n">invalid_by_num_annots</span><span class="p">,</span> <span class="n">invalid_by_num_others</span><span class="p">)</span>

    <span class="n">valid_nids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">invalid_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_name_time_variation</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
        <span class="n">aids_list</span>      <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
        <span class="n">unixtimes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
        <span class="n">unixtimes_arrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">unixtimes_list</span><span class="p">))</span>
        <span class="n">fixtimes_list</span>  <span class="o">=</span> <span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">arr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">unixtimes_arrs</span><span class="p">]</span>
        <span class="n">std_list</span>       <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">fixtimes_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">std_list</span>

    <span class="n">std_list</span> <span class="o">=</span> <span class="n">get_name_time_variation</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">valid_nids</span><span class="p">)</span>
    <span class="n">sorted_nids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">valid_nids</span><span class="p">,</span> <span class="n">std_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># Find which names to include</span>
    <span class="n">num_annot_cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_name_num_annotations</span><span class="p">(</span><span class="n">sorted_nids</span><span class="p">))</span>
    <span class="n">pos_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">num_annot_cumsum</span> <span class="o">&gt;=</span> <span class="n">min_num_annots</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="n">nid_list_chosen</span> <span class="o">=</span> <span class="n">sorted_nids</span><span class="p">[:</span><span class="n">pos_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;using names:&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">nid_list_chosen</span><span class="p">))</span>
    <span class="n">aids_list_chosen</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list_chosen</span><span class="p">)</span>
    <span class="n">aid_list_chosen</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">aids_list_chosen</span><span class="p">)</span>
    <span class="n">gid_list_chosen</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list_chosen</span><span class="p">)</span>
    <span class="c">#ut.debug_duplicate_items(gid_list_chosen)</span>

    <span class="c"># make sure not too many other annots are along for the ride</span>
    <span class="n">other_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_contact_aids</span><span class="p">(</span><span class="n">aid_list_chosen</span><span class="p">)</span>
    <span class="n">unexpected_aids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">other_aids</span><span class="p">))</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aid_list_chosen</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;got </span><span class="si">%d</span><span class="s"> unexpected_aids&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unexpected_aids</span><span class="p">),))</span>

    <span class="kn">from</span> <span class="nn">ibeis.dbio</span> <span class="kn">import</span> <span class="n">export_subset</span>

    <span class="k">def</span> <span class="nf">new_nonconflicting_dbpath</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
        <span class="n">dpath</span><span class="p">,</span> <span class="n">dbname</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbdir</span><span class="p">())</span>
        <span class="n">base_fmtstr</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="s">&#39;_demo&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">min_num_annots</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_export</span><span class="si">%d</span><span class="s">&#39;</span>
        <span class="n">new_dbpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_nonconflicting_path</span><span class="p">(</span><span class="n">base_fmtstr</span><span class="p">,</span> <span class="n">dpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_dbpath</span>

    <span class="c">#ut.embed()</span>

    <span class="n">dbpath</span> <span class="o">=</span> <span class="n">new_nonconflicting_dbpath</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>
    <span class="n">ibs_dst</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="n">dbdir</span><span class="o">=</span><span class="n">dbpath</span><span class="p">,</span> <span class="n">allow_newdir</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ibs_src</span> <span class="o">=</span> <span class="n">ibs</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">gid_list_chosen</span>
    <span class="n">export_subset</span><span class="o">.</span><span class="n">merge_databases</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">ibs_dst</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="n">gid_list</span><span class="p">)</span>

    <span class="n">DEBUG_NAME</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">DEBUG_NAME</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_num_annotations</span><span class="p">(</span><span class="n">sorted_nids</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
        <span class="n">ibeis</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">viz_name</span><span class="o">.</span><span class="n">show_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">sorted_nids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.ibsfuncs</span>
<span class="sd">        python -m ibeis.ibsfuncs --allexamples</span>
<span class="sd">        python -m ibeis.ibsfuncs --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c"># for win32</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">ibeis 0.1.0.dev1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../ibeis.html" >ibeis</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Jon Crall.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>