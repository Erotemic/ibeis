

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ibeis.dbio.export_subset &mdash; ibeis 1.4.4 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ibeis 1.4.4 documentation" href="../../../index.html"/>
        <link rel="up" title="ibeis" href="../../ibeis.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> ibeis
          

          
          </a>

          
            
            
              <div class="version">
                1.4.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ibeis.html">ibeis package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">ibeis</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
          <li><a href="../../ibeis.html">ibeis</a> &raquo;</li>
      
    <li>ibeis.dbio.export_subset</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ibeis.dbio.export_subset</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python2.7</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exports subset of an IBEIS database to a new IBEIS database</span>

<span class="sd">TODO:</span>
<span class="sd">    NEED TO UPDATE FILE TO USE THE NEW NAME AND SPECIES TABLE NOW THAT THEY</span>
<span class="sd">    ARE NO LONGER LBLANNOTS</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c"># TODO: ADD COPYRIGHT TAG</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">six</span>  <span class="c"># NOQA</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">utool</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="c"># import ibeis</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">ibsfuncs</span>  <span class="c"># NOQA</span>
<span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="c"># from ibeis.constants import (AL_RELATION_TABLE, ANNOTATION_TABLE, CONFIG_TABLE,</span>
<span class="c">#                              CONTRIBUTOR_TABLE, EG_RELATION_TABLE, ENCOUNTER_TABLE,</span>
<span class="c">#                              GL_RELATION_TABLE, IMAGE_TABLE, LBLANNOT_TABLE,</span>
<span class="c">#                              LBLIMAGE_TABLE, __STR__)</span>
<span class="c"># from vtool import geometry</span>

<span class="c"># Transfer data structures could become classes.</span>
<span class="c"># TODO: Infer transfer data properties from SQLController</span>
<span class="c"># TODO: REmove the nesting of transfer datas</span>
<span class="c"># it should be a flat list</span>
<span class="n">TransferData</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s">&#39;TransferData&#39;</span><span class="p">,</span> <span class="p">(</span>
        <span class="s">&#39;transfer_database_name&#39;</span><span class="p">,</span>
        <span class="s">&#39;transfer_database_source&#39;</span><span class="p">,</span>
        <span class="s">&#39;transfer_export_time&#39;</span><span class="p">,</span>
        <span class="s">&#39;transfer_export_location_city&#39;</span><span class="p">,</span>
        <span class="s">&#39;transfer_export_location_state&#39;</span><span class="p">,</span>
        <span class="s">&#39;transfer_export_location_zip&#39;</span><span class="p">,</span>
        <span class="s">&#39;transfer_export_location_country&#39;</span><span class="p">,</span>
        <span class="s">&#39;contributor_td_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;name_td&#39;</span><span class="p">,</span>
        <span class="s">&#39;species_td&#39;</span><span class="p">,</span>
    <span class="p">))</span>

<span class="n">CONTRIBUTOR_TransferData</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s">&#39;CONTRIBUTOR_TransferData&#39;</span><span class="p">,</span> <span class="p">(</span>
        <span class="s">&#39;contributor_uuid&#39;</span><span class="p">,</span>
        <span class="s">&#39;contributor_tag&#39;</span><span class="p">,</span>
        <span class="s">&#39;contributor_name_first&#39;</span><span class="p">,</span>
        <span class="s">&#39;contributor_name_last&#39;</span><span class="p">,</span>
        <span class="s">&#39;contributor_location_city&#39;</span><span class="p">,</span>
        <span class="s">&#39;contributor_location_state&#39;</span><span class="p">,</span>
        <span class="s">&#39;contributor_location_country&#39;</span><span class="p">,</span>
        <span class="s">&#39;contributor_location_zip&#39;</span><span class="p">,</span>
        <span class="s">&#39;contributor_note&#39;</span><span class="p">,</span>
        <span class="s">&#39;config_td&#39;</span><span class="p">,</span>
        <span class="s">&#39;encounter_td&#39;</span><span class="p">,</span>
        <span class="s">&#39;image_td&#39;</span><span class="p">,</span>
    <span class="p">))</span>

<span class="n">NAME_TransferData</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s">&#39;NAME_TransferData&#39;</span><span class="p">,</span> <span class="p">(</span>
        <span class="s">&#39;name_uuid_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;name_text_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;name_note_list&#39;</span><span class="p">,</span>
    <span class="p">))</span>

<span class="n">SPECIES_TransferData</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s">&#39;SPECIES_TransferData&#39;</span><span class="p">,</span> <span class="p">(</span>
        <span class="s">&#39;species_uuid_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;species_text_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;species_note_list&#39;</span><span class="p">,</span>
    <span class="p">))</span>

<span class="n">CONFIG_TransferData</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s">&#39;CONFIG_TransferData&#39;</span><span class="p">,</span> <span class="p">(</span>
        <span class="s">&#39;config_suffixes_list&#39;</span><span class="p">,</span>
    <span class="p">))</span>

<span class="n">ENCOUNTER_TransferData</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s">&#39;ENCOUNTER_TransferData&#39;</span><span class="p">,</span> <span class="p">(</span>
        <span class="s">&#39;config_INDEX_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;encounter_uuid_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;encounter_text_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;encoutner_note_list&#39;</span><span class="p">,</span>
    <span class="p">))</span>

<span class="n">IMAGE_TransferData</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s">&#39;IMAGE_TransferData&#39;</span><span class="p">,</span> <span class="p">(</span>
        <span class="s">&#39;encounter_INDEXs_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;image_path_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;image_uuid_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;image_ext_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;image_original_name_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;image_width_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;image_height_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;image_time_posix_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;image_gps_lat_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;image_gps_lon_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;image_toggle_enabled_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;image_toggle_reviewed_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;image_note_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;lblimage_td_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;annotation_td_list&#39;</span><span class="p">,</span>
    <span class="p">))</span>

<span class="n">ANNOTATION_TransferData</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s">&#39;ANNOTATION_TransferData&#39;</span><span class="p">,</span> <span class="p">(</span>
        <span class="s">&#39;annot_parent_INDEX_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;annot_uuid_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;annot_theta_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;annot_verts_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;annot_yaw_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;annot_detection_confidence_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;annot_exemplar_flag_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;annot_visual_uuid_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;annot_semantic_uuid_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;annot_note_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;annot_name_INDEX_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;annot_species_INDEX_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;lblannot_td_list&#39;</span><span class="p">,</span>
    <span class="p">))</span>

<span class="n">LBLIMAGE_TransferData</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s">&#39;LBLIMAGE_TransferData&#39;</span><span class="p">,</span> <span class="p">(</span>
        <span class="s">&#39;config_INDEX_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;glr_confidence_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;lblimage_uuid_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;lbltype_text_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;lblimage_value_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;lblimage_note_list&#39;</span><span class="p">,</span>
    <span class="p">))</span>

<span class="n">LBLANNOT_TransferData</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s">&#39;LBLANNOT_TransferData&#39;</span><span class="p">,</span> <span class="p">(</span>
        <span class="s">&#39;config_INDEX_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;alr_confidence_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;lblannot_uuid_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;lbltype_text_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;lblannot_value_list&#39;</span><span class="p">,</span>
        <span class="s">&#39;lblannot_note_list&#39;</span><span class="p">,</span>
    <span class="p">))</span>


<span class="c">#############################</span>
<span class="c">#############################</span>
<span class="c">#############################</span>


<div class="viewcode-block" id="tryindex"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.tryindex">[docs]</a><span class="k">def</span> <span class="nf">tryindex</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">list_</span><span class="p">,</span> <span class="n">warning</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">list_</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">list_</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curframe</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>
        <span class="n">calframe</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getouterframes</span><span class="p">(</span><span class="n">curframe</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">warning</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[export_subset] WARNING: value (</span><span class="si">%r</span><span class="s">) not in list: </span><span class="si">%r</span><span class="s"> (</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">list_</span><span class="p">,</span> <span class="n">calframe</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span>
        <span class="k">return</span> <span class="bp">None</span>


<span class="c">#############################</span>
<span class="c">#############################</span>
<span class="c">#############################</span>

</div>
<div class="viewcode-block" id="export_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.export_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">export_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    STEP 1)</span>

<span class="sd">    Packs all the data you are going to transfer from ibs_src</span>
<span class="sd">    info the transfer_data named tuple.</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.dbio.export_subset --test-export_transfer_data</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.dbio.export_subset import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.dbio import export_subset    # NOQA</span>
<span class="sd">        &gt;&gt;&gt; #ibs_src = ibeis.opendb(dbdir=&#39;/raid/work2/Turk/PZ_Master&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs_src = ibeis.opendb(db=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; bulk_conflict_resolution = &#39;ignore&#39;</span>
<span class="sd">        &gt;&gt;&gt; num = 5</span>
<span class="sd">        &gt;&gt;&gt; ibs_src.ensure_contributor_rowids(user_prompt=False)</span>
<span class="sd">        &gt;&gt;&gt; gid_list = ibs_src.get_valid_gids()[0:num]</span>
<span class="sd">        &gt;&gt;&gt; td = export_transfer_data(ibs_src, gid_list=gid_list)</span>
<span class="sd">        &gt;&gt;&gt; assert len(td.contributor_td_list) == 1, &#39;more than 1 contrib&#39;</span>
<span class="sd">        &gt;&gt;&gt; contributor_td = td.contributor_td_list[0]</span>
<span class="sd">        &gt;&gt;&gt; image_td = contributor_td.image_td</span>
<span class="sd">        &gt;&gt;&gt; assert len(image_td.annotation_td_list) == num</span>
<span class="sd">        &gt;&gt;&gt; annotation_td = image_td.annotation_td_list[num - 1]</span>
<span class="sd">        &gt;&gt;&gt; annot_td_dict = annotation_td._asdict()</span>
<span class="sd">        &gt;&gt;&gt; # remove non-determenistic uuid</span>
<span class="sd">        &gt;&gt;&gt; del annot_td_dict[&#39;annot_uuid_list&#39;]</span>
<span class="sd">        &gt;&gt;&gt; result = ut.dict_str(annot_td_dict)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        {</span>
<span class="sd">            &#39;annot_parent_INDEX_list&#39;: [None],</span>
<span class="sd">            &#39;annot_theta_list&#39;: [0.0],</span>
<span class="sd">            &#39;annot_verts_list&#39;: [((0, 0), (1072, 0), (1072, 804), (0, 804))],</span>
<span class="sd">            &#39;annot_yaw_list&#39;: [None],</span>
<span class="sd">            &#39;annot_detection_confidence_list&#39;: [0.0],</span>
<span class="sd">            &#39;annot_exemplar_flag_list&#39;: [1],</span>
<span class="sd">            &#39;annot_visual_uuid_list&#39;: [UUID(&#39;5a1a53ba-fd44-b113-7f8c-fcf248d7047f&#39;)],</span>
<span class="sd">            &#39;annot_semantic_uuid_list&#39;: [UUID(&#39;02a8b625-fd66-cf7f-8835-468043d0ed63&#39;)],</span>
<span class="sd">            &#39;annot_note_list&#39;: [u&#39;&#39;],</span>
<span class="sd">            &#39;annot_name_INDEX_list&#39;: [1],</span>
<span class="sd">            &#39;annot_species_INDEX_list&#39;: [0],</span>
<span class="sd">            &#39;lblannot_td_list&#39;: [None],</span>
<span class="sd">        }</span>

<span class="sd">    print(ut.truncate_str(ibs.db.get_table_csv(const.IMAGE_TABLE, exclude_columns=[&#39;image_uuid&#39;, &#39;image_uri&#39;]), 10000))</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">QUIET</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Exporting transfer from ibs_src.dbname = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">ibs_src</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">QUIET</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;... with </span><span class="si">%d</span><span class="s"> images&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)))</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_nids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))))</span>
    <span class="n">species_rowid_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">_get_all_species_rowids</span><span class="p">()</span>
    <span class="c"># Create Name TransferData</span>
    <span class="n">name_td</span> <span class="o">=</span> <span class="n">export_name_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>  <span class="c"># NOQA</span>
    <span class="c"># Create Species TranferData</span>
    <span class="n">species_td</span> <span class="o">=</span> <span class="n">export_species_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">species_rowid_list</span><span class="p">)</span>   <span class="c"># NOQA</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibs_src</span><span class="o">.</span><span class="n">get_all_uncontributed_images</span><span class="p">()</span>
               <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;images are still uncontributed&#39;</span>
    <span class="c"># with ut.EmbedOnException():</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">contrib_rowid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_contributor_rowid</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span>
        <span class="n">contrib_rowid_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;There must be at least one contributor to merge&#39;</span>
    <span class="n">contributor_td_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">export_contributor_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">contrib_rowid</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span>
                                         <span class="n">species_rowid_list</span><span class="p">,</span> <span class="n">valid_gid_list</span><span class="o">=</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">contrib_rowid</span> <span class="ow">in</span> <span class="n">contrib_rowid_list</span>
    <span class="p">]</span>
    <span class="c"># Geolocate and create database&#39;s TransferData object</span>
    <span class="n">success</span><span class="p">,</span> <span class="n">location_city</span><span class="p">,</span> <span class="n">location_state</span><span class="p">,</span> <span class="n">location_country</span><span class="p">,</span> <span class="n">location_zip</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">geo_locate</span><span class="p">()</span>
    <span class="n">transfer_database_source</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">get_computer_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_user_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
    <span class="n">transfer_export_time</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

    <span class="n">td</span> <span class="o">=</span> <span class="n">TransferData</span><span class="p">(</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">dbname</span><span class="p">,</span>
        <span class="n">transfer_database_source</span><span class="p">,</span>
        <span class="n">transfer_export_time</span><span class="p">,</span>
        <span class="n">location_city</span><span class="p">,</span>
        <span class="n">location_state</span><span class="p">,</span>
        <span class="n">location_zip</span><span class="p">,</span>
        <span class="n">location_country</span><span class="p">,</span>
        <span class="n">contributor_td_list</span><span class="p">,</span>
        <span class="n">name_td</span><span class="p">,</span>
        <span class="n">species_td</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">td</span>

</div>
<div class="viewcode-block" id="export_contributor_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.export_contributor_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">export_contributor_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">contributor_rowid</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span>
                                     <span class="n">species_rowid_list</span><span class="p">,</span> <span class="n">valid_gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.dbio.export_subset --test-export_contributor_transfer_data</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SLOW_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.dbio import export_subset    # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.dbio.export_subset import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs_src = ibeis.opendb(dbdir=&#39;/raid/work2/Turk/PZ_Master&#39;)</span>
<span class="sd">        &gt;&gt;&gt; bulk_conflict_resolution = &#39;ignore&#39;</span>
<span class="sd">        &gt;&gt;&gt; gid_list = ibs_src.get_valid_gids()[::10]</span>
<span class="sd">        &gt;&gt;&gt; user_prompt = False</span>
<span class="sd">        &gt;&gt;&gt; nid_list = list(set(ut.flatten(ibs_src.get_image_nids(gid_list))))</span>
<span class="sd">        &gt;&gt;&gt; species_rowid_list = ibs_src._get_all_species_rowids()</span>
<span class="sd">        &gt;&gt;&gt; contrib_rowid_list = list(set(ibs_src.get_image_contributor_rowid(gid_list)))</span>
<span class="sd">        &gt;&gt;&gt; valid_gid_list = gid_list</span>
<span class="sd">        &gt;&gt;&gt; contributor_rowid = contrib_rowid_list[0]</span>
<span class="sd">        &gt;&gt;&gt; contrib_td = export_contributor_transfer_data(ibs_src, contributor_rowid, nid_list, species_rowid_list, valid_gid_list=valid_gid_list)</span>

<span class="sd">    Dev::</span>
<span class="sd">        ibs = ibs_src</span>
<span class="sd">        configid_list = ibs.get_valid_configids()</span>
<span class="sd">        config_suffix_list = ibs.get_config_suffixes(configid_list)</span>
<span class="sd">        print(ut.list_str(list(zip(configid_list, config_suffix_list))))</span>

<span class="sd">        eid_list = ibs.get_valid_eids()</span>
<span class="sd">        enc_config_rowid_list = ibs.get_encounter_configid(eid_list)</span>
<span class="sd">        enc_suffix_list = ibs.get_config_suffixes(config_rowid_list)</span>
<span class="sd">        print(ut.list_str(list(zip(enc_config_rowid_list, enc_suffix_list))))</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Get configs</span>
    <span class="c">#config_rowid_list = ibs_src.get_contributor_config_rowids(contributor_rowid)</span>
    <span class="c"># Hack around config-less encounters</span>
    <span class="n">config_rowid_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_valid_configids</span><span class="p">()</span>
    <span class="n">config_td</span> <span class="o">=</span> <span class="n">export_config_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">)</span>
    <span class="c"># Get encounters</span>
    <span class="c">#eid_list = ibs_src.get_valid_eids()</span>
    <span class="n">eid_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs_src</span><span class="o">.</span><span class="n">get_contributor_eids</span><span class="p">(</span><span class="n">config_rowid_list</span><span class="p">))</span>
    <span class="n">encounter_td</span> <span class="o">=</span> <span class="n">export_encounter_transfer_data</span><span class="p">(</span>
        <span class="n">ibs_src</span><span class="p">,</span> <span class="n">eid_list</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">)</span>
    <span class="c"># Get images</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_contributor_gids</span><span class="p">(</span><span class="n">contributor_rowid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">valid_gid_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">isvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gid</span> <span class="ow">in</span> <span class="n">valid_gid_list</span> <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">gid_list</span><span class="p">]</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>
    <span class="n">image_td</span> <span class="o">=</span> <span class="n">export_image_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">,</span> <span class="n">eid_list</span><span class="p">,</span>
                                          <span class="n">nid_list</span><span class="p">,</span> <span class="n">species_rowid_list</span><span class="p">)</span>
    <span class="c"># Create Contributor TransferData</span>
    <span class="n">contributor_td</span> <span class="o">=</span> <span class="n">CONTRIBUTOR_TransferData</span><span class="p">(</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_contributor_uuid</span><span class="p">(</span><span class="n">contributor_rowid</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_contributor_tag</span><span class="p">(</span><span class="n">contributor_rowid</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_contributor_first_name</span><span class="p">(</span><span class="n">contributor_rowid</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_contributor_last_name</span><span class="p">(</span><span class="n">contributor_rowid</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_contributor_city</span><span class="p">(</span><span class="n">contributor_rowid</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_contributor_state</span><span class="p">(</span><span class="n">contributor_rowid</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_contributor_country</span><span class="p">(</span><span class="n">contributor_rowid</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_contributor_zip</span><span class="p">(</span><span class="n">contributor_rowid</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_contributor_note</span><span class="p">(</span><span class="n">contributor_rowid</span><span class="p">),</span>
        <span class="n">config_td</span><span class="p">,</span>
        <span class="n">encounter_td</span><span class="p">,</span>
        <span class="n">image_td</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">contributor_td</span>

</div>
<div class="viewcode-block" id="export_name_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.export_name_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">export_name_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="c"># TODO: autogenerate getter dictionaries</span>
    <span class="c"># TODO: incorporate autogenerated getter dictionaries</span>
    <span class="c"># name_getters = {</span>
    <span class="c">#    &#39;name_uuid&#39;        : ibs_src.get_name_uuids,</span>
    <span class="c">#    &#39;name_text&#39;        : ibs_src.get_name_texts,</span>
    <span class="c">#    &#39;name_notes&#39;       : ibs_src.get_name_notes,</span>
    <span class="c">#    &#39;name_temp_flag&#39;   : ibs_src.get_name_temp_flag,</span>
    <span class="c">#    &#39;name_alias_texts&#39; : ibs_src.get_name_alias_texts,</span>
    <span class="c">#}</span>
    <span class="c"># Create Name TransferData</span>
    <span class="n">name_td</span> <span class="o">=</span> <span class="n">NAME_TransferData</span><span class="p">(</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_name_uuids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">nid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_name_notes</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">name_td</span>

</div>
<div class="viewcode-block" id="export_species_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.export_species_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">export_species_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">species_rowid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ibs_src.db.print_schema()</span>
<span class="sd">    print(ibs.db.get_table_csv_header(ibeis.const.SPECIES_TABLE))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Create Species TransferData</span>
    <span class="n">species_td</span> <span class="o">=</span> <span class="n">SPECIES_TransferData</span><span class="p">(</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_species_uuids</span><span class="p">(</span><span class="n">species_rowid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_species_texts</span><span class="p">(</span><span class="n">species_rowid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_species_notes</span><span class="p">(</span><span class="n">species_rowid_list</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">species_td</span>

</div>
<div class="viewcode-block" id="export_config_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.export_config_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">export_config_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">config_rowid_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">config_rowid_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="c"># Create Config TransferData</span>
    <span class="n">config_td</span> <span class="o">=</span> <span class="n">CONFIG_TransferData</span><span class="p">(</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_config_suffixes</span><span class="p">(</span><span class="n">config_rowid_list</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">config_td</span>

</div>
<div class="viewcode-block" id="export_encounter_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.export_encounter_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">export_encounter_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">eid_list</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">eid_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">eid_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="c"># Get encounter data</span>
    <span class="n">config_INDEX_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tryindex</span><span class="p">(</span><span class="n">ibs_src</span><span class="o">.</span><span class="n">get_encounter_configid</span><span class="p">(</span><span class="n">eid</span><span class="p">),</span> <span class="n">config_rowid_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">eid</span> <span class="ow">in</span> <span class="n">eid_list</span><span class="p">]</span>
    <span class="c"># Create Encounter TransferData</span>
    <span class="n">encounter_td</span> <span class="o">=</span> <span class="n">ENCOUNTER_TransferData</span><span class="p">(</span>
        <span class="n">config_INDEX_list</span><span class="p">,</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_encounter_uuid</span><span class="p">(</span><span class="n">eid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_encounter_text</span><span class="p">(</span><span class="n">eid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_encounter_note</span><span class="p">(</span><span class="n">eid_list</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">encounter_td</span>

</div>
<div class="viewcode-block" id="export_image_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.export_image_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">export_image_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">,</span> <span class="n">eid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span>
                               <span class="n">species_rowid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    builds transfer data for seleted image ids in ibs_src.</span>
<span class="sd">    NOTE: gid_list, config_rowid_list and eid_list do not correspond</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="c"># Get image data</span>
    <span class="c">#image_size_list = ibs_src.get_image_sizes(gid_list)</span>
    <span class="c">#image_gps_list = ibs_src.get_image_gps(gid_list)</span>
    <span class="c"># Get encounter INDEXs</span>
    <span class="n">eids_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_eids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">encounter_INDEXs_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">tryindex</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">eid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">eid</span> <span class="ow">in</span> <span class="n">eid_list_</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">eid_list_</span> <span class="ow">in</span> <span class="n">eids_list</span>
    <span class="p">]</span>
    <span class="c"># Get image-label relationships</span>
    <span class="n">glrids_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_glrids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">lblimage_td_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">export_lblimage_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">glrid_list</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">glrid_list</span> <span class="ow">in</span> <span class="n">glrids_list</span>
    <span class="p">]</span>
    <span class="c"># Get annotations</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">annot_td_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">export_annot_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span>
                                   <span class="n">species_rowid_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="n">aids_list</span>
    <span class="p">]</span>
    <span class="c"># Create Image TransferData</span>
    <span class="n">image_td</span> <span class="o">=</span> <span class="n">IMAGE_TransferData</span><span class="p">(</span>
        <span class="n">encounter_INDEXs_list</span><span class="p">,</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_exts</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_gnames</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_widths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_heights</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="c">#[size[0] for size in image_size_list],</span>
        <span class="c">#[size[1] for size in image_size_list],</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_lat</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_lon</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="c">#[gps[0] for gps in image_gps_list],</span>
        <span class="c">#[gps[1] for gps in image_gps_list],</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_enabled</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_reviewed</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_notes</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="n">lblimage_td_list</span><span class="p">,</span>
        <span class="n">annot_td_list</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">image_td</span>

</div>
<div class="viewcode-block" id="export_annot_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.export_annot_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">export_annot_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span> <span class="n">species_rowid_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="c"># Get annotation parents</span>
    <span class="n">annot_parent_rowid_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_annot_parent_aid</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="c"># We can make this assumption because parts are not shared across an image.</span>
    <span class="n">annot_parent_INDEX_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="bp">None</span> <span class="k">if</span> <span class="n">annot_parent_rowid</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">tryindex</span><span class="p">(</span>
            <span class="n">annot_parent_rowid</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">annot_parent_rowid</span> <span class="ow">in</span> <span class="n">annot_parent_rowid_list</span>
    <span class="p">]</span>
    <span class="c"># Get annotation-label relationships</span>
    <span class="n">alrids_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_annot_alrids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">lblannot_td_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">export_lblannot_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">alrid_list</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">alrid_list</span> <span class="ow">in</span> <span class="n">alrids_list</span>
    <span class="p">]</span>
    <span class="c"># Get names and species of annotations</span>
    <span class="n">annot_name_rowid_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span>
        <span class="n">aid_list</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">annot_name_INDEX_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">tryindex</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">nid</span> <span class="o">!=</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN_NAME_ROWID</span> <span class="k">else</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">annot_name_rowid_list</span><span class="p">]</span>  <span class="c"># NOQA</span>
    <span class="n">annot_species_rowid_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_annot_species_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">annot_species_INDEX_list</span> <span class="o">=</span> <span class="p">[</span>  <span class="c"># NOQA</span>
        <span class="n">tryindex</span><span class="p">(</span><span class="n">species_rowid</span><span class="p">,</span> <span class="n">species_rowid_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">species_rowid</span> <span class="ow">in</span> <span class="n">annot_species_rowid_list</span>
    <span class="p">]</span>
    <span class="c"># Create Annotation TransferData</span>
    <span class="n">annot_td</span> <span class="o">=</span> <span class="n">ANNOTATION_TransferData</span><span class="p">(</span>
        <span class="n">annot_parent_INDEX_list</span><span class="p">,</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_annot_verts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_annot_yaws</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_annot_detect_confidence</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_annot_exemplar_flags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_annot_semantic_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">annot_name_INDEX_list</span><span class="p">,</span>
        <span class="n">annot_species_INDEX_list</span><span class="p">,</span>
        <span class="n">lblannot_td_list</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">annot_td</span>

</div>
<div class="viewcode-block" id="export_lblimage_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.export_lblimage_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">export_lblimage_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">glrid_list</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">glrid_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">glrid_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="c"># Get lblimage config</span>
    <span class="n">config_INDEX_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tryindex</span><span class="p">(</span><span class="n">ibs_src</span><span class="o">.</span><span class="n">get_glr_config_rowid</span><span class="p">(</span><span class="n">glrid</span><span class="p">),</span> <span class="n">config_rowid_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">glrid</span> <span class="ow">in</span> <span class="n">glrid_list</span>
    <span class="p">]</span>
    <span class="n">lblimage_rowid_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_glr_lblimage_rowids</span><span class="p">(</span><span class="n">glrid_list</span><span class="p">)</span>
    <span class="n">lbltypes_rowid_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_lblimage_lbltypes_rowids</span><span class="p">(</span>
        <span class="n">lblimage_rowid_list</span><span class="p">)</span>
    <span class="c"># Create Lblimage TransferData</span>
    <span class="n">lblimage_td</span> <span class="o">=</span> <span class="n">LBLIMAGE_TransferData</span><span class="p">(</span>
        <span class="n">config_INDEX_list</span><span class="p">,</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_glr_confidence</span><span class="p">(</span><span class="n">glrid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_lblimage_uuids</span><span class="p">(</span><span class="n">lblimage_rowid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_lbltype_text</span><span class="p">(</span><span class="n">lbltypes_rowid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_lblimage_values</span><span class="p">(</span><span class="n">lblimage_rowid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_lblimage_notes</span><span class="p">(</span><span class="n">lblimage_rowid_list</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">lblimage_td</span>

</div>
<div class="viewcode-block" id="export_lblannot_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.export_lblannot_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">export_lblannot_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">alrid_list</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">alrid_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">alrid_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="c"># Get lblannot config</span>
    <span class="n">config_INDEX_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tryindex</span><span class="p">(</span><span class="n">ibs_src</span><span class="o">.</span><span class="n">get_alr_config_rowid</span><span class="p">(</span><span class="n">alrid</span><span class="p">),</span> <span class="n">config_rowid_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">alrid</span> <span class="ow">in</span> <span class="n">alrid_list</span>
    <span class="p">]</span>
    <span class="n">lblannot_rowid_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_alr_lblannot_rowids</span><span class="p">(</span><span class="n">alrid_list</span><span class="p">)</span>
    <span class="n">lbltypes_rowid_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_lblannot_lbltypes_rowids</span><span class="p">(</span>
        <span class="n">lblannot_rowid_list</span><span class="p">)</span>
    <span class="c"># Create Lblannot TransferData</span>
    <span class="n">lblannot_td</span> <span class="o">=</span> <span class="n">LBLANNOT_TransferData</span><span class="p">(</span>
        <span class="n">config_INDEX_list</span><span class="p">,</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_alr_confidence</span><span class="p">(</span><span class="n">alrid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_lblannot_uuids</span><span class="p">(</span><span class="n">lblannot_rowid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_lbltype_text</span><span class="p">(</span><span class="n">lbltypes_rowid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_lblannot_values</span><span class="p">(</span><span class="n">lblannot_rowid_list</span><span class="p">),</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_lblannot_notes</span><span class="p">(</span><span class="n">lblannot_rowid_list</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">lblannot_td</span>


<span class="c">#############################</span>
<span class="c">#############################</span>
<span class="c">#############################</span>

</div>
<div class="viewcode-block" id="import_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.import_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">import_transfer_data</span><span class="p">(</span><span class="n">ibs_dst</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">bulk_conflict_resolution</span><span class="o">=</span><span class="s">&#39;merge&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Imports transfer data from any ibeis database and moves it into ibs_dst</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">import_name_transfer_data</span><span class="p">(</span><span class="n">ibs_dst</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">name_td</span><span class="p">)</span>
    <span class="n">species_rowid_list</span> <span class="o">=</span> <span class="n">import_species_transfer_data</span><span class="p">(</span><span class="n">ibs_dst</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">species_td</span><span class="p">)</span>
    <span class="c"># Import the contributors</span>
    <span class="n">added</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rejected</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">contributor_td</span> <span class="ow">in</span> <span class="n">td</span><span class="o">.</span><span class="n">contributor_td_list</span><span class="p">:</span>
        <span class="n">contrib_uuid</span> <span class="o">=</span> <span class="n">contributor_td</span><span class="o">.</span><span class="n">contributor_uuid</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">import_contributor_transfer_data</span><span class="p">(</span>
            <span class="n">ibs_dst</span><span class="p">,</span>
            <span class="n">contributor_td</span><span class="p">,</span>
            <span class="n">nid_list</span><span class="p">,</span>
            <span class="n">species_rowid_list</span><span class="p">,</span>
            <span class="n">bulk_conflict_resolution</span><span class="o">=</span><span class="n">bulk_conflict_resolution</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contrib_uuid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rejected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contrib_uuid</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data] ----------------------&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data] Database </span><span class="si">%r</span><span class="s"> imported&#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">transfer_database_name</span><span class="p">,))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]   Contributors Accepted: </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">added</span><span class="p">),))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]   Contributors Rejected: </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rejected</span><span class="p">),))</span>

</div>
<div class="viewcode-block" id="import_contributor_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.import_contributor_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">import_contributor_transfer_data</span><span class="p">(</span><span class="n">ibs_dst</span><span class="p">,</span> <span class="n">contributor_td</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span> <span class="n">species_rowid_list</span><span class="p">,</span>
                                     <span class="n">bulk_conflict_resolution</span><span class="o">=</span><span class="s">&#39;merge&#39;</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data] Import Contributor: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">contributor_uuid</span><span class="p">,))</span>
    <span class="c"># Find conflicts</span>
    <span class="n">contributor_rowid</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">get_contributor_rowid_from_uuid</span><span class="p">(</span>
        <span class="p">[</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">contributor_uuid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">contributor_rowid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># Resolve conflict</span>
        <span class="k">if</span> <span class="n">bulk_conflict_resolution</span> <span class="o">==</span> <span class="s">&#39;replace&#39;</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Conflict Resolution - Replacing contributor: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">contributor_uuid</span><span class="p">,</span> <span class="p">))</span>
            <span class="c"># Delete current contributor</span>
            <span class="n">ibs_dst</span><span class="o">.</span><span class="n">delete_contributors</span><span class="p">([</span><span class="n">contributor_rowid</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">bulk_conflict_resolution</span> <span class="o">==</span> <span class="s">&#39;ignore&#39;</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Conflict Resolution - Ignoring contributor: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">contributor_uuid</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Conflict Resolution - Merging contributor: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">contributor_uuid</span><span class="p">,</span> <span class="p">))</span>
            <span class="c"># TODO: do a more sophisticated contributor merge</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="n">contributor_rowid</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">add_contributors</span><span class="p">(</span>
        <span class="p">[</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">contributor_tag</span><span class="p">],</span>
        <span class="n">uuid_list</span><span class="o">=</span><span class="p">[</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">contributor_uuid</span><span class="p">],</span>
        <span class="n">name_first_list</span><span class="o">=</span><span class="p">[</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">contributor_name_first</span><span class="p">],</span>
        <span class="n">name_last_list</span><span class="o">=</span><span class="p">[</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">contributor_name_last</span><span class="p">],</span>
        <span class="n">loc_city_list</span><span class="o">=</span><span class="p">[</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">contributor_location_city</span><span class="p">],</span>
        <span class="n">loc_state_list</span><span class="o">=</span><span class="p">[</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">contributor_location_state</span><span class="p">],</span>
        <span class="n">loc_country_list</span><span class="o">=</span><span class="p">[</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">contributor_location_country</span><span class="p">],</span>
        <span class="n">loc_zip_list</span><span class="o">=</span><span class="p">[</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">contributor_location_zip</span><span class="p">],</span>
        <span class="n">notes_list</span><span class="o">=</span><span class="p">[</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">contributor_note</span><span class="p">]</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c"># Import configs</span>
    <span class="k">if</span> <span class="n">contributor_td</span><span class="o">.</span><span class="n">config_td</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]   Importing configs: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">config_td</span><span class="o">.</span><span class="n">config_suffixes_list</span><span class="p">,))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]   Importing configs&#39;</span><span class="p">)</span>
        <span class="n">config_rowid_list</span> <span class="o">=</span> <span class="n">import_config_transfer_data</span><span class="p">(</span>
            <span class="n">ibs_dst</span><span class="p">,</span>
            <span class="n">contributor_td</span><span class="o">.</span><span class="n">config_td</span><span class="p">,</span>
            <span class="n">contributor_rowid</span><span class="p">,</span>
            <span class="n">bulk_conflict_resolution</span><span class="o">=</span><span class="n">bulk_conflict_resolution</span>
        <span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]   ...imported </span><span class="si">%i</span><span class="s"> configs&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">config_rowid_list</span><span class="p">),))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config_rowid_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]   NO CONFIGS TO IMPORT (WARNING)&#39;</span><span class="p">)</span>
    <span class="c"># Import encounters</span>
    <span class="k">if</span> <span class="n">contributor_td</span><span class="o">.</span><span class="n">encounter_td</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]   Importing encounters: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">encounter_td</span><span class="o">.</span><span class="n">encounter_uuid_list</span><span class="p">,))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]   Importing encounters:&#39;</span><span class="p">)</span>
            <span class="n">eid_list</span> <span class="o">=</span> <span class="n">import_encounter_transfer_data</span><span class="p">(</span>
                <span class="n">ibs_dst</span><span class="p">,</span>
                <span class="n">contributor_td</span><span class="o">.</span><span class="n">encounter_td</span><span class="p">,</span>
                <span class="n">config_rowid_list</span><span class="p">,</span>
                <span class="n">bulk_conflict_resolution</span><span class="o">=</span><span class="n">bulk_conflict_resolution</span>
            <span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]   ...imported </span><span class="si">%i</span><span class="s"> encounters&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eid_list</span><span class="p">),))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eid_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]   NO ENCOUNTERS TO IMPORT&#39;</span><span class="p">)</span>
    <span class="c"># Import images</span>
    <span class="k">if</span> <span class="n">contributor_td</span><span class="o">.</span><span class="n">image_td</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]   Importing images: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">contributor_td</span><span class="o">.</span><span class="n">image_td</span><span class="o">.</span><span class="n">image_uuid_list</span><span class="p">,))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]   Importing images:&#39;</span><span class="p">)</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">import_image_transfer_data</span><span class="p">(</span>
            <span class="n">ibs_dst</span><span class="p">,</span>
            <span class="n">contributor_td</span><span class="o">.</span><span class="n">image_td</span><span class="p">,</span>
            <span class="n">contributor_rowid</span><span class="p">,</span>
            <span class="n">eid_list</span><span class="p">,</span>
            <span class="n">nid_list</span><span class="p">,</span>
            <span class="n">species_rowid_list</span><span class="p">,</span>
            <span class="n">config_rowid_list</span><span class="p">,</span>
            <span class="n">bulk_conflict_resolution</span><span class="o">=</span><span class="n">bulk_conflict_resolution</span>
        <span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]   ...imported </span><span class="si">%i</span><span class="s"> images&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]   NO IMAGES TO IMPORT&#39;</span><span class="p">)</span>
    <span class="c"># Finished importing contributor</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data] ...imported contributor: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">contributor_rowid</span><span class="p">,))</span>
    <span class="k">return</span> <span class="bp">True</span>

</div>
<div class="viewcode-block" id="import_name_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.import_name_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">import_name_transfer_data</span><span class="p">(</span><span class="n">ibs_dst</span><span class="p">,</span> <span class="n">name_td</span><span class="p">):</span>
    <span class="c"># Import Name TransferData</span>
    <span class="n">name_rowid_list</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">add_names</span><span class="p">(</span>
        <span class="n">name_td</span><span class="o">.</span><span class="n">name_text_list</span><span class="p">,</span>
        <span class="n">name_td</span><span class="o">.</span><span class="n">name_uuid_list</span><span class="p">,</span>
        <span class="n">name_td</span><span class="o">.</span><span class="n">name_note_list</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">name_rowid_list</span>

</div>
<div class="viewcode-block" id="import_species_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.import_species_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">import_species_transfer_data</span><span class="p">(</span><span class="n">ibs_dst</span><span class="p">,</span> <span class="n">species_td</span><span class="p">):</span>
    <span class="c"># Import Species TransferData</span>
    <span class="n">species_rowid_list</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">add_species</span><span class="p">(</span>
        <span class="n">species_td</span><span class="o">.</span><span class="n">species_text_list</span><span class="p">,</span>
        <span class="n">species_td</span><span class="o">.</span><span class="n">species_uuid_list</span><span class="p">,</span>
        <span class="n">species_td</span><span class="o">.</span><span class="n">species_note_list</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">species_rowid_list</span>

</div>
<div class="viewcode-block" id="import_config_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.import_config_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">import_config_transfer_data</span><span class="p">(</span><span class="n">ibs_dst</span><span class="p">,</span> <span class="n">config_td</span><span class="p">,</span> <span class="n">contributor_rowid</span><span class="p">,</span>
                                <span class="n">bulk_conflict_resolution</span><span class="o">=</span><span class="s">&#39;merge&#39;</span><span class="p">):</span>
    <span class="c"># Find conflicts</span>
    <span class="c"># Map input (because transfer objects are read-only)</span>
    <span class="n">config_suffixes_list</span> <span class="o">=</span> <span class="n">config_td</span><span class="o">.</span><span class="n">config_suffixes_list</span>
    <span class="c"># Find conflicts</span>
    <span class="n">known_config_rowid_list</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">get_config_rowid_from_suffix</span><span class="p">(</span>
        <span class="n">config_suffixes_list</span><span class="p">)</span>
    <span class="n">valid_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">known_config_rowid</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">known_config_rowid</span> <span class="ow">in</span> <span class="n">known_config_rowid_list</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">valid_list</span><span class="p">):</span>
        <span class="c"># Resolve conflicts</span>
        <span class="n">invalid_config_rowid_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span>
            <span class="n">known_config_rowid_list</span><span class="p">,</span> <span class="n">valid_list</span><span class="p">)</span>
        <span class="c"># invalid_indices =</span>
        <span class="c"># utool.filterfalse_items(range(len(known_config_rowid_list)),</span>
        <span class="c"># valid_list) # TODO</span>
        <span class="k">if</span> <span class="n">bulk_conflict_resolution</span> <span class="o">==</span> <span class="s">&#39;replace&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Conflict Resolution - Replacing configs: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">invalid_config_rowid_list</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Conflict Resolution - Replacing </span><span class="si">%i</span><span class="s"> configs...&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_config_rowid_list</span><span class="p">),</span> <span class="p">))</span>
            <span class="c"># Delete invalid configs</span>
            <span class="n">ibs_dst</span><span class="o">.</span><span class="n">delete_configs</span><span class="p">(</span><span class="n">invalid_config_rowid_list</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bulk_conflict_resolution</span> <span class="o">==</span> <span class="s">&#39;ignore&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Conflict Resolution - Ignoring configs: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">invalid_config_rowid_list</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Conflict Resolution - Ignoring </span><span class="si">%i</span><span class="s"> configs...&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_config_rowid_list</span><span class="p">),</span> <span class="p">))</span>
            <span class="n">config_suffixes_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">config_td</span><span class="o">.</span><span class="n">config_suffixes_list</span><span class="p">,</span> <span class="n">valid_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Conflict Resolution - Merging configs: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">invalid_config_rowid_list</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Conflict Resolution - Merging </span><span class="si">%i</span><span class="s"> configs...&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_config_rowid_list</span><span class="p">),</span> <span class="p">))</span>
            <span class="c"># TODO: do a more sophisticated config merge</span>
    <span class="c"># Add configs</span>
    <span class="n">config_rowid_list</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">add_config</span><span class="p">(</span>
        <span class="n">config_suffixes_list</span><span class="p">,</span>
        <span class="n">contrib_rowid_list</span><span class="o">=</span><span class="p">[</span><span class="n">contributor_rowid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">config_suffixes_list</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">config_rowid_list</span>

</div>
<div class="viewcode-block" id="import_encounter_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.import_encounter_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">import_encounter_transfer_data</span><span class="p">(</span><span class="n">ibs_dst</span><span class="p">,</span> <span class="n">encounter_td</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">,</span>
                                   <span class="n">bulk_conflict_resolution</span><span class="o">=</span><span class="s">&#39;merge&#39;</span><span class="p">):</span>
    <span class="c"># Map input (because transfer objects are read-only)</span>
    <span class="n">config_INDEX_list</span> <span class="o">=</span> <span class="n">encounter_td</span><span class="o">.</span><span class="n">config_INDEX_list</span>
    <span class="n">encounter_uuid_list</span> <span class="o">=</span> <span class="n">encounter_td</span><span class="o">.</span><span class="n">encounter_uuid_list</span>
    <span class="n">encounter_text_list</span> <span class="o">=</span> <span class="n">encounter_td</span><span class="o">.</span><span class="n">encounter_text_list</span>
    <span class="n">encoutner_note_list</span> <span class="o">=</span> <span class="n">encounter_td</span><span class="o">.</span><span class="n">encoutner_note_list</span>
    <span class="c"># Find conflicts</span>
    <span class="n">known_eid_list</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span><span class="p">(</span><span class="n">encounter_text_list</span><span class="p">)</span>
    <span class="n">valid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">known_eid</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">known_eid</span> <span class="ow">in</span> <span class="n">known_eid_list</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">valid_list</span><span class="p">):</span>
        <span class="c"># Resolve conflicts</span>
        <span class="n">invalid_eid_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">known_eid_list</span><span class="p">,</span> <span class="n">valid_list</span><span class="p">)</span>
        <span class="c"># invalid_indices = utool.filterfalse_items(range(len(known_eid_list)),</span>
        <span class="c"># valid_list)  # TODO</span>
        <span class="k">if</span> <span class="n">bulk_conflict_resolution</span> <span class="o">==</span> <span class="s">&#39;replace&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="s">&#39;[import_transfer_data]     Conflict Resolution - Replacing encounters: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">invalid_eid_list</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]   Conflict Resolution - Replacing </span><span class="si">%i</span><span class="s"> encounters...&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_eid_list</span><span class="p">),</span> <span class="p">))</span>
            <span class="c"># Delete invalid gids</span>
            <span class="n">ibs_dst</span><span class="o">.</span><span class="n">delete_encounters</span><span class="p">(</span><span class="n">invalid_eid_list</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bulk_conflict_resolution</span> <span class="o">==</span> <span class="s">&#39;ignore&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="s">&#39;[import_transfer_data]     Conflict Resolution - Ignoring encounters: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">invalid_eid_list</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Conflict Resolution - Ignoring </span><span class="si">%i</span><span class="s"> encounters...&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_eid_list</span><span class="p">),</span> <span class="p">))</span>
            <span class="n">config_INDEX_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">config_INDEX_list</span><span class="p">,</span>   <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">encounter_uuid_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">encounter_uuid_list</span><span class="p">,</span> <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">encounter_text_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">encounter_text_list</span><span class="p">,</span> <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">encoutner_note_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">encoutner_note_list</span><span class="p">,</span> <span class="n">valid_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="s">&#39;[import_transfer_data]     Conflict Resolution - Merging encounters: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">invalid_eid_list</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Conflict Resolution - Merging </span><span class="si">%i</span><span class="s"> encounters...&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_eid_list</span><span class="p">),</span> <span class="p">))</span>
            <span class="c"># TODO: do a more sophisticated encounter merge</span>
    <span class="c"># Add encounters</span>
    <span class="n">config_rowid_list_</span> <span class="o">=</span> <span class="p">[</span><span class="n">config_rowid_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">config_INDEX_list</span><span class="p">]</span>
    <span class="n">eid_list</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">add_encounters</span><span class="p">(</span>
        <span class="n">encounter_text_list</span><span class="p">,</span>
        <span class="n">encounter_uuid_list</span><span class="o">=</span><span class="n">encounter_uuid_list</span><span class="p">,</span>
        <span class="n">config_rowid_list</span><span class="o">=</span><span class="n">config_rowid_list_</span><span class="p">,</span>
        <span class="n">notes_list</span><span class="o">=</span><span class="n">encoutner_note_list</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">eid_list</span>

</div>
<div class="viewcode-block" id="import_image_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.import_image_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">import_image_transfer_data</span><span class="p">(</span><span class="n">ibs_dst</span><span class="p">,</span> <span class="n">image_td</span><span class="p">,</span> <span class="n">contributor_rowid</span><span class="p">,</span>
                               <span class="n">eid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span> <span class="n">species_rowid_list</span><span class="p">,</span>
                               <span class="n">config_rowid_list</span><span class="p">,</span> <span class="n">bulk_conflict_resolution</span><span class="o">=</span><span class="s">&#39;merge&#39;</span><span class="p">):</span>
    <span class="c"># Map input (because transfer objects are read-only)</span>
    <span class="n">encounter_INDEXs_list</span> <span class="o">=</span> <span class="n">image_td</span><span class="o">.</span><span class="n">encounter_INDEXs_list</span>
    <span class="n">image_path_list</span> <span class="o">=</span> <span class="n">image_td</span><span class="o">.</span><span class="n">image_path_list</span>
    <span class="n">image_uuid_list</span> <span class="o">=</span> <span class="n">image_td</span><span class="o">.</span><span class="n">image_uuid_list</span>
    <span class="n">image_ext_list</span> <span class="o">=</span> <span class="n">image_td</span><span class="o">.</span><span class="n">image_ext_list</span>
    <span class="n">image_original_name_list</span> <span class="o">=</span> <span class="n">image_td</span><span class="o">.</span><span class="n">image_original_name_list</span>
    <span class="n">image_width_list</span> <span class="o">=</span> <span class="n">image_td</span><span class="o">.</span><span class="n">image_width_list</span>
    <span class="n">image_height_list</span> <span class="o">=</span> <span class="n">image_td</span><span class="o">.</span><span class="n">image_height_list</span>
    <span class="n">image_time_posix_list</span> <span class="o">=</span> <span class="n">image_td</span><span class="o">.</span><span class="n">image_time_posix_list</span>
    <span class="n">image_gps_lat_list</span> <span class="o">=</span> <span class="n">image_td</span><span class="o">.</span><span class="n">image_gps_lat_list</span>
    <span class="n">image_gps_lon_list</span> <span class="o">=</span> <span class="n">image_td</span><span class="o">.</span><span class="n">image_gps_lon_list</span>
    <span class="n">image_toggle_enabled_list</span> <span class="o">=</span> <span class="n">image_td</span><span class="o">.</span><span class="n">image_toggle_enabled_list</span>
    <span class="n">image_toggle_reviewed_list</span> <span class="o">=</span> <span class="n">image_td</span><span class="o">.</span><span class="n">image_toggle_reviewed_list</span>
    <span class="n">image_note_list</span> <span class="o">=</span> <span class="n">image_td</span><span class="o">.</span><span class="n">image_note_list</span>
    <span class="n">lblimage_td_list</span> <span class="o">=</span> <span class="n">image_td</span><span class="o">.</span><span class="n">lblimage_td_list</span>
    <span class="n">annotation_td_list</span> <span class="o">=</span> <span class="n">image_td</span><span class="o">.</span><span class="n">annotation_td_list</span>
    <span class="c"># Find conflicts</span>
    <span class="n">known_gid_list</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">get_image_gids_from_uuid</span><span class="p">(</span><span class="n">image_uuid_list</span><span class="p">)</span>
    <span class="n">valid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">known_gid</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">known_gid</span> <span class="ow">in</span> <span class="n">known_gid_list</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">valid_list</span><span class="p">):</span>
        <span class="c"># Resolve conflicts</span>
        <span class="n">invalid_gid_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">known_gid_list</span><span class="p">,</span> <span class="n">valid_list</span><span class="p">)</span>
        <span class="c"># invalid_indices = utool.filterfalse_items(range(len(known_gid_list)),</span>
        <span class="c"># valid_list)  # TODO</span>
        <span class="k">if</span> <span class="n">bulk_conflict_resolution</span> <span class="o">==</span> <span class="s">&#39;replace&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="s">&#39;[import_transfer_data]     Conflict Resolution - Replacing images: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">invalid_gid_list</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Conflict Resolution - Replacing </span><span class="si">%i</span><span class="s"> images...&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_gid_list</span><span class="p">),</span> <span class="p">))</span>
            <span class="c"># Delete invalid gids</span>
            <span class="n">ibs_dst</span><span class="o">.</span><span class="n">delete_images</span><span class="p">(</span><span class="n">invalid_gid_list</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bulk_conflict_resolution</span> <span class="o">==</span> <span class="s">&#39;ignore&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="s">&#39;[import_transfer_data]     Conflict Resolution - Ignoring images: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">invalid_gid_list</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Conflict Resolution - Ignoring </span><span class="si">%i</span><span class="s"> images...&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_gid_list</span><span class="p">),</span> <span class="p">))</span>
            <span class="n">encounter_INDEXs_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">encounter_INDEXs_list</span><span class="p">,</span>      <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">image_path_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">image_path_list</span><span class="p">,</span>            <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">image_uuid_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">image_uuid_list</span><span class="p">,</span>            <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">image_ext_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">image_ext_list</span><span class="p">,</span>             <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">image_original_name_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">image_original_name_list</span><span class="p">,</span>   <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">image_width_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">image_width_list</span><span class="p">,</span>           <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">image_height_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">image_height_list</span><span class="p">,</span>          <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">image_time_posix_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">image_time_posix_list</span><span class="p">,</span>      <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">image_gps_lat_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">image_gps_lat_list</span><span class="p">,</span>         <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">image_gps_lon_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">image_gps_lon_list</span><span class="p">,</span>         <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">image_toggle_enabled_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">image_toggle_enabled_list</span><span class="p">,</span>  <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">image_toggle_reviewed_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">image_toggle_reviewed_list</span><span class="p">,</span> <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">image_note_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">image_note_list</span><span class="p">,</span>            <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">lblimage_td_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">lblimage_td_list</span><span class="p">,</span>           <span class="n">valid_list</span><span class="p">)</span>
            <span class="n">annotation_td_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
                <span class="n">annotation_td_list</span><span class="p">,</span>         <span class="n">valid_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="s">&#39;[import_transfer_data]     Conflict Resolution - Merging images: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">invalid_gid_list</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Conflict Resolution - Merging </span><span class="si">%i</span><span class="s"> images...&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_gid_list</span><span class="p">),</span> <span class="p">))</span>
            <span class="k">print</span><span class="p">(</span>
                <span class="s">&#39;IMAGE MERGING HAS NOT BEEN IMPLEMENTED, USE IGNORE OR REPLACE RESOLUTIONS FOR NOW&#39;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="c"># Sanity Check</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_uuid_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
        <span class="nb">set</span><span class="p">(</span><span class="n">image_uuid_list</span><span class="p">)),</span> <span class="s">&#39;Not unique images&#39;</span>
    <span class="c"># Add images</span>
    <span class="n">params_list</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image_uuid_list</span><span class="p">,</span> <span class="n">image_path_list</span><span class="p">,</span>
                      <span class="n">image_original_name_list</span><span class="p">,</span> <span class="n">image_ext_list</span><span class="p">,</span> <span class="n">image_width_list</span><span class="p">,</span>
                      <span class="n">image_height_list</span><span class="p">,</span> <span class="n">image_time_posix_list</span><span class="p">,</span> <span class="n">image_gps_lat_list</span><span class="p">,</span>
                      <span class="n">image_gps_lon_list</span><span class="p">,</span> <span class="n">image_note_list</span><span class="p">)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">add_images</span><span class="p">(</span>
        <span class="n">image_path_list</span><span class="p">,</span>
        <span class="n">params_list</span><span class="o">=</span><span class="n">params_list</span>
    <span class="p">)</span>
    <span class="c"># Add new contributor and set image reviewed and enabled bits</span>
    <span class="k">print</span><span class="p">(</span>
        <span class="s">&#39;[import_transfer_data]     &#39;</span>
        <span class="s">&#39;Associating images with contributors and setting reviewed and enabled bits...&#39;</span><span class="p">)</span>
    <span class="n">contrib_rowid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">contributor_rowid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">ibs_dst</span><span class="o">.</span><span class="n">set_image_contributor_rowid</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">contrib_rowid_list</span><span class="p">)</span>
    <span class="n">ibs_dst</span><span class="o">.</span><span class="n">set_image_reviewed</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">image_toggle_reviewed_list</span><span class="p">)</span>
    <span class="n">ibs_dst</span><span class="o">.</span><span class="n">set_image_enabled</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">image_toggle_enabled_list</span><span class="p">)</span>
    <span class="c"># Add images to appropriate encounters</span>
    <span class="k">print</span><span class="p">(</span>
        <span class="s">&#39;[import_transfer_data]     Associating images with new encounters...&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">encounter_INDEXs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">encounter_INDEXs_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">encounter_INDEX</span> <span class="ow">in</span> <span class="n">encounter_INDEXs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">encounter_INDEX</span> <span class="ow">and</span> <span class="n">encounter_INDEX</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">eid_list</span><span class="p">):</span>
                <span class="n">ibs_dst</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">([</span><span class="n">gid</span><span class="p">],</span> <span class="p">[</span><span class="n">eid_list</span><span class="p">[</span><span class="n">encounter_INDEX</span><span class="p">]])</span>
    <span class="c"># Add lblimages</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Importing lblimages...&#39;</span><span class="p">)</span>
    <span class="n">glrid_total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">lblimage_td</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">lblimage_td_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lblimage_td</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">glrid_list</span> <span class="o">=</span> <span class="n">import_lblimage_transfer_data</span><span class="p">(</span>
                <span class="n">ibs_dst</span><span class="p">,</span>
                <span class="n">lblimage_td</span><span class="p">,</span>
                <span class="n">gid</span><span class="p">,</span>
                <span class="n">config_rowid_list</span>
            <span class="p">)</span>
            <span class="n">glrid_total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glrid_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     ...imported </span><span class="si">%i</span><span class="s"> lblimages&#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">glrid_total</span><span class="p">,))</span>
    <span class="c"># Add annotations</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Importing annotations...&#39;</span><span class="p">)</span>
    <span class="n">aid_total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">annotation_td</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">annotation_td_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">annotation_td</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     Importing annotations for image </span><span class="si">%r</span><span class="s">: </span><span class="si">%r</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">gid</span><span class="p">,</span> <span class="n">annotation_td</span><span class="o">.</span><span class="n">annot_uuid_list</span><span class="p">,))</span>
            <span class="n">aid_list</span> <span class="o">=</span> <span class="n">import_annot_transfer_data</span><span class="p">(</span>
                <span class="n">ibs_dst</span><span class="p">,</span>
                <span class="n">annotation_td</span><span class="p">,</span>
                <span class="n">gid</span><span class="p">,</span>
                <span class="n">nid_list</span><span class="p">,</span>
                <span class="n">species_rowid_list</span><span class="p">,</span>
                <span class="n">config_rowid_list</span>
            <span class="p">)</span>
            <span class="n">aid_total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="s">&#39;[import_transfer_data]     ...imported </span><span class="si">%i</span><span class="s"> annotations&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),))</span>
        <span class="k">elif</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span>
                <span class="s">&#39;[import_transfer_data]     NO ANNOTATIONS TO IMPORT FOR IMAGE </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gid</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]     ...imported </span><span class="si">%i</span><span class="s"> annotations&#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">aid_total</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">gid_list</span>

</div>
<div class="viewcode-block" id="import_annot_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.import_annot_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">import_annot_transfer_data</span><span class="p">(</span><span class="n">ibs_dst</span><span class="p">,</span> <span class="n">annot_td</span><span class="p">,</span> <span class="n">parent_gid</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span>
                               <span class="n">species_rowid_list</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">):</span>
    <span class="n">parent_gid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent_gid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">annot_td</span><span class="o">.</span><span class="n">annot_uuid_list</span><span class="p">)</span>
    <span class="n">name_rowid_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN_NAME_ROWID</span>
        <span class="k">if</span> <span class="n">annot_name_INDEX</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span>
        <span class="n">nid_list</span><span class="p">[</span><span class="n">annot_name_INDEX</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">annot_name_INDEX</span> <span class="ow">in</span> <span class="n">annot_td</span><span class="o">.</span><span class="n">annot_name_INDEX_list</span>
    <span class="p">]</span>
    <span class="n">species_rowid_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN_SPECIES_ROWID</span>
        <span class="k">if</span> <span class="n">annot_species_INDEX</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span>
        <span class="n">species_rowid_list</span><span class="p">[</span><span class="n">annot_species_INDEX</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">annot_species_INDEX</span> <span class="ow">in</span> <span class="n">annot_td</span><span class="o">.</span><span class="n">annot_species_INDEX_list</span>
    <span class="p">]</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">add_annots</span><span class="p">(</span>
        <span class="n">parent_gid_list</span><span class="p">,</span>
        <span class="n">theta_list</span><span class="o">=</span><span class="n">annot_td</span><span class="o">.</span><span class="n">annot_theta_list</span><span class="p">,</span>
        <span class="n">detect_confidence_list</span><span class="o">=</span><span class="n">annot_td</span><span class="o">.</span><span class="n">annot_detection_confidence_list</span><span class="p">,</span>
        <span class="n">notes_list</span><span class="o">=</span><span class="n">annot_td</span><span class="o">.</span><span class="n">annot_note_list</span><span class="p">,</span>
        <span class="n">vert_list</span><span class="o">=</span><span class="n">annot_td</span><span class="o">.</span><span class="n">annot_verts_list</span><span class="p">,</span>
        <span class="n">annot_uuid_list</span><span class="o">=</span><span class="n">annot_td</span><span class="o">.</span><span class="n">annot_uuid_list</span><span class="p">,</span>
        <span class="n">yaw_list</span><span class="o">=</span><span class="n">annot_td</span><span class="o">.</span><span class="n">annot_yaw_list</span><span class="p">,</span>
        <span class="n">annot_visual_uuid_list</span><span class="o">=</span><span class="n">annot_td</span><span class="o">.</span><span class="n">annot_visual_uuid_list</span><span class="p">,</span>
        <span class="n">annot_semantic_uuid_list</span><span class="o">=</span><span class="n">annot_td</span><span class="o">.</span><span class="n">annot_semantic_uuid_list</span><span class="p">,</span>
        <span class="n">nid_list</span><span class="o">=</span><span class="n">name_rowid_list</span><span class="p">,</span>
        <span class="n">species_rowid_list</span><span class="o">=</span><span class="n">species_rowid_list</span><span class="p">,</span>
        <span class="c"># Turns off thumbnail deletion print statements</span>
        <span class="n">quiet_delete_thumbs</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span>
            <span class="s">&#39;[import_transfer_data]       Setting the annotation</span><span class="se">\&#39;</span><span class="s">s parent and exemplar bits...&#39;</span><span class="p">)</span>
    <span class="c"># Adding parent rowids that come from the aid_list (only can come from this list because</span>
    <span class="c"># aid parent rowids cannot span across images)</span>
    <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">annot_parent_INDEX</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">annot_td</span><span class="o">.</span><span class="n">annot_parent_INDEX_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">annot_parent_INDEX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
           <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">annot_parent_INDEX</span> <span class="ow">and</span>
           <span class="n">annot_parent_INDEX</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)):</span>
            <span class="n">parent_aid</span> <span class="o">=</span> <span class="n">aid_list</span><span class="p">[</span><span class="n">annot_parent_INDEX</span><span class="p">]</span>
            <span class="n">ibs_dst</span><span class="o">.</span><span class="n">set_annot_parent_rowid</span><span class="p">([</span><span class="n">aid</span><span class="p">],</span> <span class="p">[</span><span class="n">parent_aid</span><span class="p">])</span>
    <span class="n">ibs_dst</span><span class="o">.</span><span class="n">set_annot_exemplar_flags</span><span class="p">(</span>
        <span class="n">aid_list</span><span class="p">,</span> <span class="n">annot_td</span><span class="o">.</span><span class="n">annot_exemplar_flag_list</span><span class="p">)</span>
    <span class="c"># Add lblannots</span>
    <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]       Importing lblannots...&#39;</span><span class="p">)</span>
    <span class="n">alrid_total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">lblannot_td</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">annot_td</span><span class="o">.</span><span class="n">lblannot_td_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lblannot_td</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">alrid_list</span> <span class="o">=</span> <span class="n">import_lblannot_transfer_data</span><span class="p">(</span>
                <span class="n">ibs_dst</span><span class="p">,</span>
                <span class="n">lblannot_td</span><span class="p">,</span>
                <span class="n">aid</span><span class="p">,</span>
                <span class="n">config_rowid_list</span>
            <span class="p">)</span>
            <span class="n">alrid_total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alrid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[import_transfer_data]       ...imported </span><span class="si">%i</span><span class="s"> lblimages&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">alrid_total</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">aid_list</span>

</div>
<div class="viewcode-block" id="import_lblimage_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.import_lblimage_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">import_lblimage_transfer_data</span><span class="p">(</span><span class="n">ibs_dst</span><span class="p">,</span> <span class="n">lblimage_td</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">):</span>
    <span class="c"># Add lblimages</span>
    <span class="n">lblimage_rowid_list</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">add_lblimages</span><span class="p">(</span>
        <span class="n">ibs_dst</span><span class="o">.</span><span class="n">get_lbltype_rowid_from_text</span><span class="p">(</span><span class="n">lblimage_td</span><span class="o">.</span><span class="n">lbltype_text_list</span><span class="p">),</span>
        <span class="n">lblimage_td</span><span class="o">.</span><span class="n">lblimage_value_list</span><span class="p">,</span>
        <span class="n">note_list</span><span class="o">=</span><span class="n">lblimage_td</span><span class="o">.</span><span class="n">lblimage_note_list</span><span class="p">,</span>
        <span class="n">lblimage_uuid_list</span><span class="o">=</span><span class="n">lblimage_td</span><span class="o">.</span><span class="n">lblimage_uuid_list</span>
    <span class="p">)</span>
    <span class="c"># Add image-label relationships</span>
    <span class="n">valid_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">config_INDEX</span> <span class="ow">and</span> <span class="n">config_INDEX</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">config_rowid_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">config_INDEX</span> <span class="ow">in</span> <span class="n">lblimage_td</span><span class="o">.</span><span class="n">config_INDEX_list</span>
    <span class="p">]</span>
    <span class="n">lblimage_rowid_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">lblimage_rowid_list</span><span class="p">,</span> <span class="n">valid_list</span><span class="p">)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">lblimage_rowid_list</span><span class="p">)</span>
    <span class="n">config_rowid_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">config_rowid_list</span><span class="p">[</span><span class="n">config_INDEX</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">config_INDEX</span><span class="p">,</span> <span class="n">valid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lblimage_td</span><span class="o">.</span><span class="n">config_INDEX_list</span><span class="p">,</span> <span class="n">valid_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valid</span>
    <span class="p">]</span>
    <span class="n">glr_confidence_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
        <span class="n">lblimage_td</span><span class="o">.</span><span class="n">glr_confidence_list</span><span class="p">,</span> <span class="n">valid_list</span><span class="p">)</span>
    <span class="n">glrid_list</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">add_image_relationship</span><span class="p">(</span>
        <span class="n">gid_list</span><span class="p">,</span>
        <span class="n">lblimage_rowid_list</span><span class="p">,</span>
        <span class="n">config_rowid_list</span><span class="o">=</span><span class="n">config_rowid_list</span><span class="p">,</span>
        <span class="n">glr_confidence_list</span><span class="o">=</span><span class="n">glr_confidence_list</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">glrid_list</span>

</div>
<div class="viewcode-block" id="import_lblannot_transfer_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.import_lblannot_transfer_data">[docs]</a><span class="k">def</span> <span class="nf">import_lblannot_transfer_data</span><span class="p">(</span><span class="n">ibs_dst</span><span class="p">,</span> <span class="n">lblannot_td</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">):</span>
    <span class="c"># Add lblannots</span>
    <span class="n">lblannot_rowid_list</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">add_lblannots</span><span class="p">(</span>
        <span class="n">ibs_dst</span><span class="o">.</span><span class="n">get_lbltype_rowid_from_text</span><span class="p">(</span><span class="n">lblannot_td</span><span class="o">.</span><span class="n">lbltype_text_list</span><span class="p">),</span>
        <span class="n">lblannot_td</span><span class="o">.</span><span class="n">lblannot_value_list</span><span class="p">,</span>
        <span class="n">note_list</span><span class="o">=</span><span class="n">lblannot_td</span><span class="o">.</span><span class="n">lblannot_note_list</span><span class="p">,</span>
        <span class="n">lblannot_uuid_list</span><span class="o">=</span><span class="n">lblannot_td</span><span class="o">.</span><span class="n">lblannot_uuid_list</span>
    <span class="p">)</span>
    <span class="c"># Add annot-label relationships</span>
    <span class="n">valid_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">config_INDEX</span> <span class="ow">and</span> <span class="n">config_INDEX</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">config_rowid_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">config_INDEX</span> <span class="ow">in</span> <span class="n">lblannot_td</span><span class="o">.</span><span class="n">config_INDEX_list</span>
    <span class="p">]</span>
    <span class="n">lblannot_rowid_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">lblannot_rowid_list</span><span class="p">,</span> <span class="n">valid_list</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">aid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">lblannot_rowid_list</span><span class="p">)</span>
    <span class="n">config_rowid_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">config_rowid_list</span><span class="p">[</span><span class="n">config_INDEX</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">config_INDEX</span><span class="p">,</span> <span class="n">valid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lblannot_td</span><span class="o">.</span><span class="n">config_INDEX_list</span><span class="p">,</span> <span class="n">valid_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valid</span>
    <span class="p">]</span>
    <span class="n">alr_confidence_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span>
        <span class="n">lblannot_td</span><span class="o">.</span><span class="n">alr_confidence_list</span><span class="p">,</span> <span class="n">valid_list</span><span class="p">)</span>
    <span class="n">alrid_list</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">add_annot_relationship</span><span class="p">(</span>
        <span class="n">aid_list</span><span class="p">,</span>
        <span class="n">lblannot_rowid_list</span><span class="p">,</span>
        <span class="n">config_rowid_list</span><span class="o">=</span><span class="n">config_rowid_list</span><span class="p">,</span>
        <span class="n">alr_confidence_list</span><span class="o">=</span><span class="n">alr_confidence_list</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">alrid_list</span>


<span class="c">#############################</span>
<span class="c">#############################</span>
<span class="c">#############################</span>

</div>
<div class="viewcode-block" id="merge_databases"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.merge_databases">[docs]</a><span class="k">def</span> <span class="nf">merge_databases</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">ibs_dst</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">back</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">user_prompt</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bulk_conflict_resolution</span><span class="o">=</span><span class="s">&#39;ignore&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    STEP 0) MAIN DRIVER FUNCTION</span>

<span class="sd">    Conflict resolutions are only between contributors, configs, encounters and images.</span>
<span class="sd">    Annotations, lblannots, lblimages, their respective relationships, and image-encounter</span>
<span class="sd">    relationships all inherit the resolution from their associated image.</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs_src (IBEISController): source controller</span>

<span class="sd">        ibs_dst (IBEISController): destination controller (can be an empty database)</span>

<span class="sd">        back (GUIBackend): optional gui to update</span>

<span class="sd">        user_prompt (bool): prompt user for information</span>

<span class="sd">        bulk_conflict_resolution (str): valid conflict_resolutions are::</span>
<span class="sd">            +---</span>
<span class="sd">            * &#39;replace&#39; - delete original in ibs_dst and import new value</span>
<span class="sd">            * &#39;ignore&#39; - ignore imported value and keep original in ibs_dst</span>
<span class="sd">            * &#39;merge&#39; - (default) keep both values in both databases</span>
<span class="sd">            +---</span>
<span class="sd">            WARNING - this may cause near-duplicate information due to duplicate</span>
<span class="sd">            detections, duplicate manual annotations from different</span>
<span class="sd">            contributors.  Images and lblimages will not be duplicated.</span>
<span class="sd">            WARNING - this will only keep the meta data for an image, annotation</span>
<span class="sd">            from the source database (image_height, annotation_verts, etc.)</span>
<span class="sd">            WARNING - this may cause an exception to be raised</span>
<span class="sd">            +---</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.dbio.export_subset --test-merge_databases</span>
<span class="sd">        python -m ibeis.dbio.export_subset --test-merge_databases:1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SLOW_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.dbio.export_subset import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.dbio import export_subset</span>
<span class="sd">        &gt;&gt;&gt; ibs_src = ibeis.opendb(db=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; bulk_conflict_resolution = &#39;ignore&#39;</span>
<span class="sd">        &gt;&gt;&gt; #gid_list = None</span>
<span class="sd">        &gt;&gt;&gt; back = None</span>
<span class="sd">        &gt;&gt;&gt; user_prompt = False</span>
<span class="sd">        &gt;&gt;&gt; #ibs_src2 = ibeis.opendb(dbdir=&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print(ibs_src.get_infostr())</span>
<span class="sd">        &gt;&gt;&gt; #print(ibs_src2.get_infostr())</span>
<span class="sd">        &gt;&gt;&gt; # OPEN A CLEAN DATABASE</span>
<span class="sd">        &gt;&gt;&gt; ibs_dst = ibeis.opendb(dbdir=&#39;testdb_dst&#39;, allow_newdir=True, delete_ibsdir=True)</span>
<span class="sd">        &gt;&gt;&gt; assert ibs_dst.get_num_names() == 0, &#39;dst database is not empty&#39;</span>
<span class="sd">        &gt;&gt;&gt; assert ibs_dst.get_num_images() == 0, &#39;dst database is not empty&#39;</span>
<span class="sd">        &gt;&gt;&gt; assert ibs_dst.get_num_annotations() == 0, &#39;dst database is not empty&#39;</span>
<span class="sd">        &gt;&gt;&gt; #ibs_dst = ibs</span>
<span class="sd">        &gt;&gt;&gt; gid_list = ibs_src.get_valid_gids()</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;Execute test func&#39;)</span>
<span class="sd">        &gt;&gt;&gt; export_subset.merge_databases(ibs_src, ibs_dst, gid_list,</span>
<span class="sd">        ...                               bulk_conflict_resolution=bulk_conflict_resolution)</span>
<span class="sd">        &gt;&gt;&gt; #export_subset.merge_databases(ibs_src2, ibs_dst, bulk_conflict_resolution=&#39;ignore&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = ibs_dst.get_infostr()</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;Result:&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        dbname = &#39;testdb_dst&#39;</span>
<span class="sd">        num_images = 13</span>
<span class="sd">        num_annotations = 13</span>
<span class="sd">        num_names = 7</span>

<span class="sd">    Example2:</span>
<span class="sd">        &gt;&gt;&gt; # SLOW_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.dbio.export_subset import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.dbio import export_subset</span>
<span class="sd">        &gt;&gt;&gt; ibs_src = ibeis.opendb(db=&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; bulk_conflict_resolution = &#39;ignore&#39;</span>
<span class="sd">        &gt;&gt;&gt; #gid_list = None</span>
<span class="sd">        &gt;&gt;&gt; back = None</span>
<span class="sd">        &gt;&gt;&gt; user_prompt = False</span>
<span class="sd">        &gt;&gt;&gt; #ibs_src2 = ibeis.opendb(dbdir=&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print(ibs_src.get_infostr())</span>
<span class="sd">        &gt;&gt;&gt; #print(ibs_src2.get_infostr())</span>
<span class="sd">        &gt;&gt;&gt; # OPEN A CLEAN DATABASE</span>
<span class="sd">        &gt;&gt;&gt; ibs_dst = ibeis.opendb(dbdir=&#39;testdb_dst&#39;, allow_newdir=False, delete_ibsdir=False)</span>
<span class="sd">        &gt;&gt;&gt; assert ibs_dst.get_num_names() &gt; 0, &#39;dst database is empty&#39;</span>
<span class="sd">        &gt;&gt;&gt; assert ibs_dst.get_num_images() &gt; 0, &#39;dst database is empty&#39;</span>
<span class="sd">        &gt;&gt;&gt; assert ibs_dst.get_num_annotations() &gt; 0, &#39;dst database is empty&#39;</span>
<span class="sd">        &gt;&gt;&gt; #ibs_dst = ibs</span>
<span class="sd">        &gt;&gt;&gt; gid_list = ibs_src.get_valid_gids()</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;Execute test func&#39;)</span>
<span class="sd">        &gt;&gt;&gt; export_subset.merge_databases(ibs_src, ibs_dst, gid_list,</span>
<span class="sd">        ...                               bulk_conflict_resolution=bulk_conflict_resolution)</span>
<span class="sd">        &gt;&gt;&gt; #export_subset.merge_databases(ibs_src2, ibs_dst, bulk_conflict_resolution=&#39;ignore&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = ibs_dst.get_infostr()</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;Result:&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        dbname = &#39;testdb_dst&#39;</span>
<span class="sd">        num_images = 128</span>
<span class="sd">        num_annotations = 129</span>
<span class="sd">        num_names = 48</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># First ensure that the source and destionation have contributors</span>
    <span class="k">def</span> <span class="nf">DEBUG_UNCONTRIBUTED_IMAGES</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
        <span class="n">unassigned_gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_all_uncontributed_images</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;There are </span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s"> uncontributed images in </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unassigned_gid_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()),</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unassigned_gid_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dpath</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbdir</span><span class="p">()</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s">&#39;_debug_uncontributed_gids_&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;.txt&#39;</span>
            <span class="n">fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unixjoin</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span>
                <span class="n">fpath</span><span class="p">,</span> <span class="s">&#39;unassigned_gid_list = &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">unassigned_gid_list</span><span class="p">))</span>
    <span class="n">DEBUG_UNCONTRIBUTED_IMAGES</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">)</span>
    <span class="n">DEBUG_UNCONTRIBUTED_IMAGES</span><span class="p">(</span><span class="n">ibs_dst</span><span class="p">)</span>
    <span class="c"># Check that destination database has a valid contributor</span>
    <span class="n">ibs_src</span><span class="o">.</span><span class="n">ensure_contributor_rowids</span><span class="p">(</span><span class="n">user_prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">)</span>
    <span class="n">ibs_dst</span><span class="o">.</span><span class="n">ensure_contributor_rowids</span><span class="p">(</span><span class="n">user_prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">)</span>
    <span class="c"># Export source database</span>
    <span class="n">td</span> <span class="o">=</span> <span class="n">export_transfer_data</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">[merge_databases] -------------------</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[merge_databases] </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">td</span><span class="p">,))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">[merge_databases] -------------------</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="c"># Import tansfer data object into the destination database</span>
    <span class="c"># TODO: Implement db backup</span>
    <span class="n">import_transfer_data</span><span class="p">(</span>
        <span class="n">ibs_dst</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">bulk_conflict_resolution</span><span class="o">=</span><span class="n">bulk_conflict_resolution</span><span class="p">)</span>
    <span class="c"># TODO: Implement db restore or db deletion</span>
    <span class="n">ibs_dst</span><span class="o">.</span><span class="n">notify_observers</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="check_merge"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.check_merge">[docs]</a><span class="k">def</span> <span class="nf">check_merge</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">ibs_dst</span><span class="p">):</span>
    <span class="n">aid_list1</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">gid_list1</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list1</span><span class="p">)</span>
    <span class="n">gname_list1</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_uris</span><span class="p">(</span><span class="n">gid_list1</span><span class="p">)</span>
    <span class="n">image_uuid_list1</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">(</span><span class="n">gid_list1</span><span class="p">)</span>
    <span class="n">gid_list2</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">get_image_gids_from_uuid</span><span class="p">(</span><span class="n">image_uuid_list1</span><span class="p">)</span>
    <span class="n">gname_list2</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">get_image_uris</span><span class="p">(</span><span class="n">gid_list2</span><span class="p">)</span>
    <span class="c"># Asserts</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">assert_all_not_None</span><span class="p">(</span><span class="n">gid_list1</span><span class="p">,</span> <span class="s">&#39;gid_list1&#39;</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">assert_all_not_None</span><span class="p">(</span><span class="n">gid_list2</span><span class="p">,</span> <span class="s">&#39;gid_list2&#39;</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">assert_lists_eq</span><span class="p">(</span><span class="n">gname_list1</span><span class="p">,</span> <span class="n">gname_list2</span><span class="p">,</span> <span class="s">&#39;faild gname&#39;</span><span class="p">)</span>
    <span class="c"># Image UUIDS should be consistent between databases</span>
    <span class="n">image_uuid_list2</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">(</span><span class="n">gid_list2</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">assert_lists_eq</span><span class="p">(</span><span class="n">image_uuid_list1</span><span class="p">,</span> <span class="n">image_uuid_list2</span><span class="p">,</span> <span class="s">&#39;failed uuid&#39;</span><span class="p">)</span>

    <span class="n">aids_list1</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list1</span><span class="p">)</span>
    <span class="n">aids_list2</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list2</span><span class="p">)</span>

    <span class="n">avuuids_list1</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">,</span> <span class="n">aids_list1</span><span class="p">)</span>
    <span class="n">avuuids_list2</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span>
        <span class="n">ibs_dst</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">,</span> <span class="n">aids_list2</span><span class="p">)</span>

    <span class="n">issubset_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">avuuids1</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">avuuids2</span><span class="p">))</span>
                     <span class="k">for</span> <span class="n">avuuids1</span><span class="p">,</span> <span class="n">avuuids2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">avuuids_list1</span><span class="p">,</span> <span class="n">avuuids_list2</span><span class="p">)]</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">issubset_list</span><span class="p">),</span> <span class="s">&#39;ibs_src must be a subset of ibs_dst: issubset_list=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">issubset_list</span><span class="p">,)</span>
    <span class="c">#aids_depth1 = ut.depth_profile(aids_list1)</span>
    <span class="c">#aids_depth2 = ut.depth_profile(aids_list2)</span>
    <span class="c"># depth might not be true if ibs_dst is not empty</span>
    <span class="c">#ut.assert_lists_eq(aids_depth1, aids_depth2, &#39;failed depth&#39;)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Merge seems ok...&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="merge_databases2"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.merge_databases2">[docs]</a><span class="k">def</span> <span class="nf">merge_databases2</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">ibs_dst</span><span class="p">,</span> <span class="n">rowid_subsets</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; new way of merging using the non-hacky sql table merge that is only working due to major hacks</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.dbio.export_subset --test-merge_databases2:0</span>
<span class="sd">        python -m ibeis.dbio.export_subset --test-merge_databases2:0 --db1 PZ_Master0 --db2 PZ_Master1</span>
<span class="sd">        python -m ibeis.dbio.export_subset --test-merge_databases2:0 --db1 NNP_Master3 --db2 PZ_Master1</span>

<span class="sd">        python -m ibeis.dbio.export_subset --test-merge_databases2:0 --db1 GZ_ALL --db2 GZ_Master1</span>
<span class="sd">        python -m ibeis.dbio.export_subset --test-merge_databases2:0 --db1 lewa_grevys --db2 GZ_Master1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.dbio.export_subset import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; db1 = ut.get_argval(&#39;--db1&#39;, str, default=None)</span>
<span class="sd">        &gt;&gt;&gt; db2 = ut.get_argval(&#39;--db2&#39;, str, default=None)</span>
<span class="sd">        &gt;&gt;&gt; dbdir1 = ut.get_argval(&#39;--dbdir1&#39;, str, default=None)</span>
<span class="sd">        &gt;&gt;&gt; dbdir2 = ut.get_argval(&#39;--dbdir2&#39;, str, default=None)</span>
<span class="sd">        &gt;&gt;&gt; delete_ibsdir = False</span>
<span class="sd">        &gt;&gt;&gt; # Check for test mode instead of script mode</span>
<span class="sd">        &gt;&gt;&gt; if db1 is None and db2 is None and dbdir1 is None and dbdir2 is None:</span>
<span class="sd">        ...     db1 = &#39;testdb1&#39;</span>
<span class="sd">        ...     dbdir2 = &#39;testdb_dst&#39;</span>
<span class="sd">        ...     delete_ibsdir = True</span>
<span class="sd">        &gt;&gt;&gt; # Open the source and destination database</span>
<span class="sd">        &gt;&gt;&gt; assert db1 is not None or dbdir1 is not None</span>
<span class="sd">        &gt;&gt;&gt; assert db2 is not None or dbdir2 is not None</span>
<span class="sd">        &gt;&gt;&gt; ibs_src = ibeis.opendb(db=db1, dbdir=dbdir1)</span>
<span class="sd">        &gt;&gt;&gt; ibs_dst = ibeis.opendb(db=db2, dbdir=dbdir2, allow_newdir=True, delete_ibsdir=delete_ibsdir)</span>
<span class="sd">        &gt;&gt;&gt; merge_databases2(ibs_src, ibs_dst)</span>
<span class="sd">        &gt;&gt;&gt; check_merge(ibs_src, ibs_dst)</span>
<span class="sd">        &gt;&gt;&gt; ibs_dst.print_dbinfo()</span>

<span class="sd">    #Example2:</span>
<span class="sd">    #    &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">    #    &gt;&gt;&gt; from ibeis.dbio.export_subset import *  # NOQA</span>
<span class="sd">    #    &gt;&gt;&gt; import ibeis</span>
<span class="sd">    #    &gt;&gt;&gt; #ibs_dst = ibeis.opendb(dbdir=&#39;testdb_dst&#39;)</span>
<span class="sd">    #    &gt;&gt;&gt; ibs_src = ibeis.opendb(db=&#39;PZ_MTEST&#39;)</span>
<span class="sd">    #    &gt;&gt;&gt; # OPEN A CLEAN DATABASE</span>
<span class="sd">    #    &gt;&gt;&gt; delete_ibsdir = True</span>
<span class="sd">    #    &gt;&gt;&gt; ibs_dst = ibeis.opendb(db=&#39;testdb_dst2&#39;, allow_newdir=True, delete_ibsdir=delete_ibsdir)</span>
<span class="sd">    #    &gt;&gt;&gt; merge_databases2(ibs_src, ibs_dst)</span>
<span class="sd">    #    &gt;&gt;&gt; check_merge(ibs_src, ibs_dst)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># TODO: ensure images are localized</span>
    <span class="c"># otherwise this wont work</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;BEGIN MERGE OF </span><span class="si">%r</span><span class="s"> into </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">ibs_src</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">(),</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()))</span>
    <span class="c"># ibs_src.run_integrity_checks()</span>
    <span class="c"># ibs_dst.run_integrity_checks()</span>
    <span class="n">ibs_dst</span><span class="o">.</span><span class="n">update_annot_visual_uuids</span><span class="p">(</span><span class="n">ibs_dst</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">())</span>
    <span class="n">ibs_src</span><span class="o">.</span><span class="n">update_annot_visual_uuids</span><span class="p">(</span><span class="n">ibs_src</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">())</span>
    <span class="n">ibs_src</span><span class="o">.</span><span class="n">ensure_contributor_rowids</span><span class="p">()</span>
    <span class="n">ibs_dst</span><span class="o">.</span><span class="n">ensure_contributor_rowids</span><span class="p">()</span>
    <span class="n">ibs_src</span><span class="o">.</span><span class="n">fix_invalid_annotmatches</span><span class="p">()</span>
    <span class="n">ibs_dst</span><span class="o">.</span><span class="n">fix_invalid_annotmatches</span><span class="p">()</span>
    <span class="c"># Hack move of the external data</span>
    <span class="k">if</span> <span class="n">rowid_subsets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span> <span class="ow">in</span> <span class="n">rowid_subsets</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">rowid_subsets</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">imgpath_list</span> <span class="o">=</span> <span class="n">ibs_src</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">dst_imgdir</span> <span class="o">=</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">get_imgdir</span><span class="p">()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">copy_files_to</span><span class="p">(</span><span class="n">imgpath_list</span><span class="p">,</span> <span class="n">dst_imgdir</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ignore_tables</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;lblannot&#39;</span><span class="p">,</span> <span class="s">&#39;lblimage&#39;</span><span class="p">,</span> <span class="s">&#39;image_lblimage_relationship&#39;</span><span class="p">,</span>
                     <span class="s">&#39;annotation_lblannot_relationship&#39;</span><span class="p">,</span> <span class="s">&#39;keys&#39;</span><span class="p">]</span>
    <span class="n">ibs_dst</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">merge_databases_new</span><span class="p">(</span>
        <span class="n">ibs_src</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">ignore_tables</span><span class="o">=</span><span class="n">ignore_tables</span><span class="p">,</span> <span class="n">rowid_subsets</span><span class="o">=</span><span class="n">rowid_subsets</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;FINISHED MERGE </span><span class="si">%r</span><span class="s"> into </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">ibs_src</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">(),</span> <span class="n">ibs_dst</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()))</span>

</div>
<div class="viewcode-block" id="make_new_dbpath"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.make_new_dbpath">[docs]</a><span class="k">def</span> <span class="nf">make_new_dbpath</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">id_label</span><span class="p">,</span> <span class="n">id_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a new database path unique to the exported subset of ids.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">ibeis</span>
    <span class="n">tag_hash</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashstr_arr</span><span class="p">(</span><span class="n">id_list</span><span class="p">,</span> <span class="n">hashlen</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">alphabet</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">ALPHABET_27</span><span class="p">)</span>
    <span class="n">base_fmtstr</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">id_label</span> <span class="o">+</span> <span class="s">&#39;s=&#39;</span> <span class="o">+</span> \
        <span class="n">tag_hash</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_</span><span class="si">%d</span><span class="s">&#39;</span>
    <span class="n">dpath</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">get_workdir</span><span class="p">()</span>
    <span class="n">new_dbpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_nonconflicting_path_old</span><span class="p">(</span><span class="n">base_fmtstr</span><span class="p">,</span> <span class="n">dpath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_dbpath</span>

</div>
<div class="viewcode-block" id="export_names"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.export_names">[docs]</a><span class="k">def</span> <span class="nf">export_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span> <span class="n">new_dbpath</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    exports a subset of names and other required info</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        nid_list (list):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.dbio.export_subset --test-export_names</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.dbio.export_subset import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb2&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs.delete_empty_nids()</span>
<span class="sd">        &gt;&gt;&gt; nid_list = ibs._get_all_known_nids()[0:2]</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = export_names(ibs, nid_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Exporting name nid_list=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nid_list</span><span class="p">,))</span>
    <span class="k">if</span> <span class="n">new_dbpath</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">new_dbpath</span> <span class="o">=</span> <span class="n">make_new_dbpath</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="s">&#39;nid&#39;</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>

    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">))</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique_unordered</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">export_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span> <span class="n">new_dbpath</span><span class="o">=</span><span class="n">new_dbpath</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="export_images_temp"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.export_images_temp">[docs]</a><span class="k">def</span> <span class="nf">export_images_temp</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">reviewed_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_reviewed</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">gid_list_</span> <span class="o">=</span> <span class="p">[</span><span class="n">gid</span> <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">reviewed</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="n">gid_list</span><span class="p">,</span> <span class="n">reviewed_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">reviewed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">export_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list_</span><span class="p">,</span> <span class="s">&#39;/Datasets/PZ_Master1-Sub3&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="find_gid_list"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.find_gid_list">[docs]</a><span class="k">def</span> <span class="nf">find_gid_list</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">min_count</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">ensure_annots</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">reviewed_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_reviewed</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ensure_annots</span><span class="p">:</span>
        <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">reviewed_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">reviewed</span>
            <span class="k">for</span> <span class="n">aids</span><span class="p">,</span> <span class="n">reviewed</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aids_list</span><span class="p">,</span> <span class="n">reviewed_list</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="c"># Filter by reviewed</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">gid</span>
        <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">reviewed</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">reviewed_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reviewed</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_count</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_count</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">gid_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">gid_list</span>

</div>
<span class="k">def</span> <span class="nf">__export_reviewed_subset</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">min_count</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">ensure_annots</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">find_gid_list</span><span class="p">(</span>
        <span class="n">ibs</span><span class="p">,</span> <span class="n">min_count</span><span class="o">=</span><span class="n">min_count</span><span class="p">,</span> <span class="n">ensure_annots</span><span class="o">=</span><span class="n">ensure_annots</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">new_dbpath</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">join</span><span class="p">(</span><span class="s">&#39;Datasets&#39;</span><span class="p">,</span> <span class="s">&#39;BACKGROUND&#39;</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Exporting to </span><span class="si">%r</span><span class="s"> with </span><span class="si">%r</span><span class="s"> images&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_dbpath</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span> <span class="p">))</span>
    <span class="k">return</span> <span class="n">export_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">new_dbpath</span><span class="o">=</span><span class="n">new_dbpath</span><span class="p">)</span>


<div class="viewcode-block" id="export_images"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.export_images">[docs]</a><span class="k">def</span> <span class="nf">export_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">new_dbpath</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    exports a subset of images and other required info</span>

<span class="sd">    TODO:</span>
<span class="sd">        PZ_Master1 needs to backproject information back on to NNP_Master3 and PZ_Master0</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        gid_list (list):  list of annotation rowids</span>
<span class="sd">        new_dbpath (None): (default = None)</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: new_dbpath</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Exporting image gid_list=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gid_list</span><span class="p">,))</span>
    <span class="k">if</span> <span class="n">new_dbpath</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">new_dbpath</span> <span class="o">=</span> <span class="n">make_new_dbpath</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="s">&#39;gid&#39;</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)</span>

    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique_unordered</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)))</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique_unordered</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">export_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span> <span class="n">new_dbpath</span><span class="o">=</span><span class="n">new_dbpath</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="export_annots"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.export_annots">[docs]</a><span class="k">def</span> <span class="nf">export_annots</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">new_dbpath</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    exports a subset of annotations and other required info</span>

<span class="sd">    TODO:</span>
<span class="sd">        PZ_Master1 needs to backproject information back on to NNP_Master3 and PZ_Master0</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (list):  list of annotation rowids</span>
<span class="sd">        new_dbpath (None): (default = None)</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: new_dbpath</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.dbio.export_subset --exec-export_annots</span>
<span class="sd">        python -m ibeis.expt.experiment_helpers --exec-get_annotcfg_list:0 --db NNP_Master3 -a viewpoint_compare --nocache-aid --verbtd</span>
<span class="sd">        python -m ibeis.expt.experiment_helpers --exec-get_annotcfg_list:0 --db NNP_Master3 -a viewpoint_compare --nocache-aid --verbtd</span>

<span class="sd">        python -m ibeis.dbio.export_subset --exec-export_annots --db NNP_Master3 -a viewpoint_compare --nocache-aid --verbtd --new_dbpath=PZ_ViewPoints</span>

<span class="sd">        python -m ibeis.expt.experiment_helpers --exec-get_annotcfg_list:0 --db NNP_Master3 -a default:aids=all,is_known=True,view_pername=#primary&gt;0&amp;#primary1&gt;0,per_name=4,size=200</span>
<span class="sd">        python -m ibeis.expt.experiment_helpers --exec-get_annotcfg_list:0 --db NNP_Master3 -a default:aids=all,is_known=True,view_pername=&#39;#primary&gt;0&amp;#primary1&gt;0&#39;,per_name=4,size=200 --acfginfo</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.dbio.export_subset import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.expt import experiment_helpers</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;NNP_Master3&#39;)</span>
<span class="sd">        &gt;&gt;&gt; acfg_name_list = ut.get_argval((&#39;--aidcfg&#39;, &#39;--acfg&#39;, &#39;-a&#39;), type_=list, default=[&#39;&#39;])</span>
<span class="sd">        &gt;&gt;&gt; acfg_list, expanded_aids_list = experiment_helpers.get_annotcfg_list(ibs, acfg_name_list)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = expanded_aids_list[0][0]</span>
<span class="sd">        &gt;&gt;&gt; ibs.print_annot_stats(aid_list, yawtext_isect=True, per_image=True)</span>
<span class="sd">        &gt;&gt;&gt; # Expand to get all annots in each chosen image</span>
<span class="sd">        &gt;&gt;&gt; gid_list = ut.unique_keep_order(ibs.get_annot_gids(aid_list))</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ut.flatten(ibs.get_image_aids(gid_list))</span>
<span class="sd">        &gt;&gt;&gt; ibs.print_annot_stats(aid_list, yawtext_isect=True, per_image=True)</span>
<span class="sd">        &gt;&gt;&gt; new_dbpath = ut.get_argval(&#39;--new-dbpath&#39;, default=&#39;PZ_ViewPoints&#39;)</span>
<span class="sd">        &gt;&gt;&gt; new_dbpath = export_annots(ibs, aid_list, new_dbpath)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;new_dbpath = %s&#39; % (str(new_dbpath),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Exporting annotations aid_list=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid_list</span><span class="p">,))</span>
    <span class="k">if</span> <span class="n">new_dbpath</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">new_dbpath</span> <span class="o">=</span> <span class="n">make_new_dbpath</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="s">&#39;aid&#39;</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>

    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique_unordered</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique_unordered</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">export_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span> <span class="n">new_dbpath</span><span class="o">=</span><span class="n">new_dbpath</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="export_data"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.export_data">[docs]</a><span class="k">def</span> <span class="nf">export_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span> <span class="n">new_dbpath</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    exports a subset of data and other required info</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        gid_list (list):  list of image rowids</span>
<span class="sd">        aid_list (list):  list of annotation rowids</span>
<span class="sd">        nid_list (list):  list of name rowids</span>
<span class="sd">        eid_list (list):  list of encounter rowids</span>
<span class="sd">        egrid_list (list):  list of encounter-image pairs rowids</span>
<span class="sd">        new_dbpath (None): (default = None)</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: new_dbpath</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">ibeis</span>

    <span class="n">eid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique_unordered</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_image_eids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)))</span>
    <span class="n">egrid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique_unordered</span><span class="p">(</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_image_egrids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)))</span>

    <span class="n">annotmatch_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_annotmatch_rowids</span><span class="p">()</span>
    <span class="n">flags1_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">aid</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_aid1</span><span class="p">(</span><span class="n">annotmatch_rowid_list</span><span class="p">)]</span>
    <span class="n">flags2_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">aid</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_aid2</span><span class="p">(</span><span class="n">annotmatch_rowid_list</span><span class="p">)]</span>
    <span class="n">flag_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">and_lists</span><span class="p">(</span><span class="n">flags1_list</span><span class="p">,</span> <span class="n">flags2_list</span><span class="p">)</span>
    <span class="n">annotmatch_rowid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">annotmatch_rowid_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>
    <span class="c">#annotmatch_rowid_list = ibs.get_valid_aids(ibs.get_valid_aids())</span>

    <span class="n">rowid_subsets</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">:</span> <span class="n">aid_list</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">NAME_TABLE</span><span class="p">:</span> <span class="n">nid_list</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">:</span> <span class="n">gid_list</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">:</span> <span class="n">annotmatch_rowid_list</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">EG_RELATION_TABLE</span><span class="p">:</span> <span class="n">egrid_list</span><span class="p">,</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ENCOUNTER_TABLE</span><span class="p">:</span> <span class="n">eid_list</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">ibs_dst</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="n">dbdir</span><span class="o">=</span><span class="n">new_dbpath</span><span class="p">,</span> <span class="n">allow_newdir</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># Main merge driver</span>
    <span class="n">merge_databases2</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ibs_dst</span><span class="p">,</span> <span class="n">rowid_subsets</span><span class="o">=</span><span class="n">rowid_subsets</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Exported to </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_dbpath</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">new_dbpath</span>


<span class="c"># RELEVANT LEGACY CODE FOR IMAGE MERGING</span>
<span class="c"># def check_conflicts(ibs_src, ibs_dst, transfer_data):</span>
<span class="c">#     &quot;&quot;&quot;</span>
<span class="c">#     Check to make sure the destination database does not have any conflicts</span>
<span class="c">#     with the incoming transfer.</span>

<span class="c">#     Currently only checks that images do not have conflicting annotations.</span>

<span class="c">#     Does not check label consistency.</span>
<span class="c">#     &quot;&quot;&quot;</span>

<span class="c"># TODO: Check label consistency: ie check that labels with the</span>
<span class="c"># same (type, value) should also have the same UUID</span>
<span class="c">#     img_td      = transfer_data.img_td</span>
<span class="c"># annot_td    = transfer_data.annot_td</span>
<span class="c"># lblannot_td = transfer_data.lblannot_td</span>
<span class="c"># alr_td      = transfer_data.alr_td</span>

<span class="c">#     image_uuid_list1 = img_td.img_uuid_list</span>
<span class="c">#     sameimg_gid_list2_ = ibs_dst.get_image_gids_from_uuid(image_uuid_list1)</span>
<span class="c">#     issameimg = [gid is not None for gid in sameimg_gid_list2_]</span>
<span class="c"># Check if databases contain the same images</span>
<span class="c">#     if any(issameimg):</span>
<span class="c">#         sameimg_gid_list2 = utool.filter_items(sameimg_gid_list2_, issameimg)</span>
<span class="c">#         sameimg_image_uuids = utool.filter_items(image_uuid_list1, issameimg)</span>
<span class="c">#         print(&#39;! %d/%d images are duplicates&#39; % (len(sameimg_gid_list2), len(image_uuid_list1)))</span>
<span class="c"># Check if sameimg images in dst has any annotations.</span>
<span class="c">#         sameimg_aids_list2 = ibs_dst.get_image_aids(sameimg_gid_list2)</span>
<span class="c">#         hasannots = [len(aids) &gt; 0 for aids in sameimg_aids_list2]</span>
<span class="c">#         if any(hasannots):</span>
<span class="c"># TODO: Merge based on some merge stratagy parameter (like annotation timestamp)</span>
<span class="c">#             sameimg_gid_list1 = ibs_src.get_image_gids_from_uuid(sameimg_image_uuids)</span>
<span class="c">#             hasannot_gid_list2 = utool.filter_items(sameimg_gid_list2, hasannots)</span>
<span class="c">#             hasannot_gid_list1 = utool.filter_items(sameimg_gid_list1, hasannots)</span>
<span class="c">#             print(&#39;  !! %d/%d of those have annotations&#39; %</span>
<span class="c">#             (len(hasannot_gid_list2), len(sameimg_gid_list2)))</span>
<span class="c"># They had better be the same annotations!</span>
<span class="c">#             assert_images_have_same_annnots(ibs_src, ibs_dst,</span>
<span class="c">#             hasannot_gid_list1, hasannot_gid_list2)</span>
<span class="c">#             print(&#39;  ...phew, all of the annotations were the same.&#39;)</span>
<span class="c"># raise AssertionError(&#39;dst dataset contains some of this data&#39;)</span>


<span class="c"># def assert_images_have_same_annnots(ibs_src, ibs_dst, hasannot_gid_list1, hasannot_gid_list2):</span>
<span class="c">#     &quot;&quot;&quot; Given a list of gids from each ibs, this function asserts that every</span>
<span class="c">#         annontation in gid1 is the same as every annontation in gid2</span>
<span class="c">#     &quot;&quot;&quot;</span>
<span class="c">#     from ibeis.ibsfuncs import unflat_map</span>
<span class="c">#     hasannot_aids_list1 = ibs_src.get_image_aids(hasannot_gid_list1)</span>
<span class="c">#     hasannot_aids_list2 = ibs_dst.get_image_aids(hasannot_gid_list2)</span>
<span class="c">#     hasannot_auuids_list1 = unflat_map(ibs_src.get_annot_uuids, hasannot_aids_list1)</span>
<span class="c">#     hasannot_auuids_list2 = unflat_map(ibs_dst.get_annot_uuids, hasannot_aids_list2)</span>
<span class="c">#     hasannot_verts_list1 = unflat_map(ibs_src.get_annot_verts, hasannot_aids_list1)</span>
<span class="c">#     hasannot_verts_list2 = unflat_map(ibs_dst.get_annot_verts, hasannot_aids_list2)</span>
<span class="c">#     assert_same_annot_uuids(hasannot_auuids_list1, hasannot_auuids_list2)</span>
<span class="c"># assert_same_annot_verts(hasannot_verts_list1, hasannot_verts_list2)  #</span>
<span class="c"># hack, check verts as well</span>


<span class="c"># def assert_same_annot_uuids(hasannot_auuids_list1, hasannot_auuids_list2):</span>
<span class="c">#     uuids_pair_iter = zip(hasannot_auuids_list1, hasannot_auuids_list2)</span>
<span class="c">#     msg = (&#39;The {count}-th image has inconsistent annotation:. &#39;</span>
<span class="c">#            &#39;auuids1={auuids1} auuids2={auuids2}&#39;)</span>
<span class="c">#     for count, (auuids1, auuids2) in enumerate(uuids_pair_iter):</span>
<span class="c">#         assert auuids1 == auuids2, msg.format(</span>
<span class="c">#             count=count, auuids1=auuids1, auuids2=auuids2,)</span>


<span class="c"># def assert_same_annot_verts(hasannot_verts_list1, hasannot_verts_list2):</span>
<span class="c">#     verts_pair_iter = zip(hasannot_verts_list1, hasannot_verts_list2)</span>
<span class="c">#     msg = (&#39;The {count}-th image has inconsistent annotation:. &#39;</span>
<span class="c">#            &#39;averts1={averts1} averts2={averts2}&#39;)</span>
<span class="c">#     for count, (averts1, averts2) in enumerate(verts_pair_iter):</span>
<span class="c">#         assert averts1 == averts2, msg.format(</span>
<span class="c">#             count=count, averts1=averts1, averts2=averts2,)</span>

</div>
<div class="viewcode-block" id="test_merge"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.test_merge">[docs]</a><span class="k">def</span> <span class="nf">test_merge</span><span class="p">():</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.dbio.export_subset --test-test_merge</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SLOW_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.dbio.export_subset import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = test_merge()</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.dbio</span> <span class="kn">import</span> <span class="n">export_subset</span>
    <span class="kn">import</span> <span class="nn">ibeis</span>
    <span class="n">ibs1</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="s">&#39;testdb2&#39;</span><span class="p">)</span>
    <span class="n">ibs1</span><span class="o">.</span><span class="n">fix_invalid_annotmatches</span><span class="p">()</span>
    <span class="n">ibs_dst</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span>
        <span class="n">db</span><span class="o">=</span><span class="s">&#39;testdb_dst2&#39;</span><span class="p">,</span> <span class="n">allow_newdir</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">delete_ibsdir</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">export_subset</span><span class="o">.</span><span class="n">merge_databases2</span><span class="p">(</span><span class="n">ibs1</span><span class="p">,</span> <span class="n">ibs_dst</span><span class="p">)</span>
    <span class="c">#ibs_src = ibs1</span>
    <span class="n">check_merge</span><span class="p">(</span><span class="n">ibs1</span><span class="p">,</span> <span class="n">ibs_dst</span><span class="p">)</span>

    <span class="n">ibs2</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="s">&#39;testdb1&#39;</span><span class="p">)</span>
    <span class="n">ibs1</span><span class="o">.</span><span class="n">print_dbinfo</span><span class="p">()</span>
    <span class="n">ibs2</span><span class="o">.</span><span class="n">print_dbinfo</span><span class="p">()</span>
    <span class="n">ibs_dst</span><span class="o">.</span><span class="n">print_dbinfo</span><span class="p">()</span>

    <span class="n">ibs_dst</span><span class="o">.</span><span class="n">print_dbinfo</span><span class="p">()</span>

    <span class="n">export_subset</span><span class="o">.</span><span class="n">merge_databases2</span><span class="p">(</span><span class="n">ibs2</span><span class="p">,</span> <span class="n">ibs_dst</span><span class="p">)</span>
    <span class="c">#ibs_src = ibs2</span>
    <span class="n">check_merge</span><span class="p">(</span><span class="n">ibs2</span><span class="p">,</span> <span class="n">ibs_dst</span><span class="p">)</span>

    <span class="n">ibs3</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="s">&#39;PZ_MTEST&#39;</span><span class="p">)</span>
    <span class="n">export_subset</span><span class="o">.</span><span class="n">merge_databases2</span><span class="p">(</span><span class="n">ibs3</span><span class="p">,</span> <span class="n">ibs_dst</span><span class="p">)</span>
    <span class="c">#ibs_src = ibs2</span>
    <span class="n">check_merge</span><span class="p">(</span><span class="n">ibs3</span><span class="p">,</span> <span class="n">ibs_dst</span><span class="p">)</span>

    <span class="n">ibs_dst</span><span class="o">.</span><span class="n">print_dbinfo</span><span class="p">()</span>

    <span class="c">#ibs_src.print_annotation_table(exclude_columns=[&#39;annot_verts&#39;,</span>
    <span class="c">#&#39;annot_semantic_uuid&#39;, &#39;annot_note&#39;, &#39;annot_parent_rowid&#39;,</span>
    <span class="c">#&#39;annot_exemplar_flag,&#39;])</span>
    <span class="c"># ibs_dst.print_annotation_table()</span>

</div>
<div class="viewcode-block" id="check_database_overlap"><a class="viewcode-back" href="../../../ibeis.dbio.html#ibeis.dbio.export_subset.check_database_overlap">[docs]</a><span class="k">def</span> <span class="nf">check_database_overlap</span><span class="p">(</span><span class="n">ibs1</span><span class="p">,</span> <span class="n">ibs2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.other.dbinfo --test-get_dbinfo:1 --db PZ_MTEST</span>
<span class="sd">        dev.py -t listdbs</span>
<span class="sd">        python -m ibeis.dbio.export_subset --exec-check_database_overlap</span>
<span class="sd">        --db PZ_MTEST --db2 PZ_MOTHERS</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.dbio.export_subset --exec-check_database_overlap</span>

<span class="sd">        python -m ibeis.dbio.export_subset --exec-check_database_overlap --db1=PZ_MTEST --db2=PZ_Master0  # NOQA</span>
<span class="sd">        python -m ibeis.dbio.export_subset --exec-check_database_overlap --db1=NNP_Master3 --db2=PZ_Master0  # NOQA</span>

<span class="sd">        python -m ibeis.dbio.export_subset --exec-check_database_overlap --db1=GZ_Master0 --db2=GZ_ALL</span>
<span class="sd">        python -m ibeis.dbio.export_subset --exec-check_database_overlap --db1=GZ_ALL --db2=lewa_grevys</span>

<span class="sd">        python -m ibeis.dbio.export_subset --exec-check_database_overlap --db1=PZ_FlankHack --db2=PZ_Master1</span>


<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; #ibs1 = ibeis.opendb(db=&#39;PZ_Master0&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #ibs2 = ibeis.opendb(dbdir=&#39;/raid/work2/Turk/PZ_Master&#39;)</span>
<span class="sd">        &gt;&gt;&gt; db1 = ut.get_argval(&#39;--db1&#39;, str, default=&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; db2 = ut.get_argval(&#39;--db2&#39;, str, default=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; dbdir1 = ut.get_argval(&#39;--dbdir1&#39;, str, default=None)</span>
<span class="sd">        &gt;&gt;&gt; dbdir2 = ut.get_argval(&#39;--dbdir2&#39;, str, default=None)</span>
<span class="sd">        &gt;&gt;&gt; ibs1 = ibeis.opendb(db=db1, dbdir=dbdir1)</span>
<span class="sd">        &gt;&gt;&gt; ibs2 = ibeis.opendb(db=db2, dbdir=dbdir2)</span>
<span class="sd">        &gt;&gt;&gt; check_database_overlap(ibs1, ibs2)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>

    <span class="k">def</span> <span class="nf">print_intersection</span><span class="p">(</span><span class="n">uuids1</span><span class="p">,</span> <span class="n">uuids2</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="n">uuids1_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">uuids1</span><span class="p">)</span>
        <span class="n">uuids2_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">uuids2</span><span class="p">)</span>
        <span class="n">uuids_isect</span> <span class="o">=</span> <span class="n">uuids1_</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">uuids2_</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Checking {lbl} intersection&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lbl</span><span class="o">=</span><span class="n">lbl</span><span class="p">))</span>
        <span class="n">fmtkw1</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">lbl</span><span class="o">=</span><span class="n">lbl</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">uuids1_</span><span class="p">),</span> <span class="n">percent</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">uuids_isect</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">uuids1_</span><span class="p">))</span>
        <span class="n">fmtkw2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">lbl</span><span class="o">=</span><span class="n">lbl</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">uuids2_</span><span class="p">),</span> <span class="n">percent</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">uuids_isect</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">uuids2_</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span>
            <span class="s">&#39;  * Num {lbl} 1: {num}, Percentage {percent:.2f}%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw1</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span>
            <span class="s">&#39;  * Num {lbl} 2: {num}, Percentage {percent:.2f}%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw2</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span>
            <span class="s">&#39;  * Num {lbl} isect: {num}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lbl</span><span class="o">=</span><span class="n">lbl</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">uuids_isect</span><span class="p">)))</span>
        <span class="n">x_list1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">find_list_indexes</span><span class="p">(</span><span class="n">uuids1</span><span class="p">,</span> <span class="n">uuids_isect</span><span class="p">)</span>
        <span class="n">x_list2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">find_list_indexes</span><span class="p">(</span><span class="n">uuids2</span><span class="p">,</span> <span class="n">uuids_isect</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_list1</span><span class="p">,</span> <span class="n">x_list2</span>

    <span class="n">gids1</span> <span class="o">=</span> <span class="n">ibs1</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">gids2</span> <span class="o">=</span> <span class="n">ibs2</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">image_uuids1</span> <span class="o">=</span> <span class="n">ibs1</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">(</span><span class="n">gids1</span><span class="p">)</span>
    <span class="n">image_uuids2</span> <span class="o">=</span> <span class="n">ibs2</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">(</span><span class="n">gids2</span><span class="p">)</span>
    <span class="n">gx_list1</span><span class="p">,</span> <span class="n">gx_list2</span> <span class="o">=</span> <span class="n">print_intersection</span><span class="p">(</span>
        <span class="n">image_uuids1</span><span class="p">,</span> <span class="n">image_uuids2</span><span class="p">,</span> <span class="s">&#39;images&#39;</span><span class="p">)</span>
    <span class="n">gids_isect1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">gids1</span><span class="p">,</span> <span class="n">gx_list1</span><span class="p">)</span>
    <span class="n">gids_isect2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">gids2</span><span class="p">,</span> <span class="n">gx_list2</span><span class="p">)</span>
    <span class="n">SHOW_ISECT_GIDS</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">SHOW_ISECT_GIDS</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gx_list1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;gids_isect1 = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gids_isect1</span><span class="p">,))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;gids_isect2 = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gids_isect2</span><span class="p">,))</span>
            <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
                <span class="c"># Debug code</span>
                <span class="kn">import</span> <span class="nn">ibeis.viz</span>
                <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
                <span class="n">gid_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gids_isect1</span><span class="p">,</span> <span class="n">gids_isect2</span><span class="p">))</span>
                <span class="n">pairs_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ichunks</span><span class="p">(</span><span class="n">gid_pairs</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">pairs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pairs_iter</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">pnum_</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="n">nRows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">),</span> <span class="n">nCols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">gid1</span><span class="p">,</span> <span class="n">gid2</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                        <span class="n">ibeis</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">show_image</span><span class="p">(</span>
                            <span class="n">ibs1</span><span class="p">,</span> <span class="n">gid1</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">(),</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">)</span>
                        <span class="n">ibeis</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">show_image</span><span class="p">(</span>
                            <span class="n">ibs2</span><span class="p">,</span> <span class="n">gid2</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">(),</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">)</span>

    <span class="n">aids1</span> <span class="o">=</span> <span class="n">ibs1</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">aids2</span> <span class="o">=</span> <span class="n">ibs2</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">ibs1</span><span class="o">.</span><span class="n">update_annot_visual_uuids</span><span class="p">(</span><span class="n">aids1</span><span class="p">)</span>
        <span class="n">ibs2</span><span class="o">.</span><span class="n">update_annot_visual_uuids</span><span class="p">(</span><span class="n">aids2</span><span class="p">)</span>
        <span class="n">ibs1</span><span class="o">.</span><span class="n">update_annot_semantic_uuids</span><span class="p">(</span><span class="n">aids1</span><span class="p">)</span>
        <span class="n">ibs2</span><span class="o">.</span><span class="n">update_annot_semantic_uuids</span><span class="p">(</span><span class="n">aids2</span><span class="p">)</span>

    <span class="c"># Check to see which intersecting images have different annotations</span>
    <span class="n">image_aids_isect1</span> <span class="o">=</span> <span class="n">ibs1</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gids_isect1</span><span class="p">)</span>
    <span class="n">image_aids_isect2</span> <span class="o">=</span> <span class="n">ibs2</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gids_isect2</span><span class="p">)</span>
    <span class="n">image_avuuids_isect1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">ibs1</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs1</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">,</span> <span class="n">image_aids_isect1</span><span class="p">))</span>
    <span class="n">image_avuuids_isect2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">ibs2</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs2</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">,</span> <span class="n">image_aids_isect2</span><span class="p">))</span>
    <span class="n">changed_image_xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span>
        <span class="n">image_avuuids_isect1</span> <span class="o">!=</span> <span class="n">image_avuuids_isect2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">changed_image_xs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;There are </span><span class="si">%d</span><span class="s"> images with changes in annotation visual information&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">changed_image_xs</span><span class="p">),))</span>
        <span class="n">changed_gids1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">gids_isect1</span><span class="p">,</span> <span class="n">changed_image_xs</span><span class="p">)</span>
        <span class="n">changed_gids2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">gids_isect2</span><span class="p">,</span> <span class="n">changed_image_xs</span><span class="p">)</span>

        <span class="n">SHOW_CHANGED_GIDS</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">SHOW_CHANGED_GIDS</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;gids_isect1 = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">changed_gids2</span><span class="p">,))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;gids_isect2 = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">changed_gids1</span><span class="p">,))</span>
            <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
                <span class="c"># Debug code</span>
                <span class="kn">import</span> <span class="nn">ibeis.viz</span>
                <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
                <span class="n">gid_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">changed_gids1</span><span class="p">,</span> <span class="n">changed_gids2</span><span class="p">))</span>
                <span class="n">pairs_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ichunks</span><span class="p">(</span><span class="n">gid_pairs</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">pairs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pairs_iter</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">pnum_</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="n">nRows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">),</span> <span class="n">nCols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">gid1</span><span class="p">,</span> <span class="n">gid2</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                        <span class="n">ibeis</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">show_image</span><span class="p">(</span>
                            <span class="n">ibs1</span><span class="p">,</span> <span class="n">gid1</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">(),</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">)</span>
                        <span class="n">ibeis</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">show_image</span><span class="p">(</span>
                            <span class="n">ibs2</span><span class="p">,</span> <span class="n">gid2</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">(),</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">)</span>

    <span class="c"># Check for overlapping annotations (visual info only) in general</span>
    <span class="n">annot_vuuids1</span> <span class="o">=</span> <span class="n">ibs1</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">(</span><span class="n">aids1</span><span class="p">)</span>
    <span class="n">annot_vuuids2</span> <span class="o">=</span> <span class="n">ibs2</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">(</span><span class="n">aids2</span><span class="p">)</span>
    <span class="n">avx_list1</span><span class="p">,</span> <span class="n">avx_list2</span> <span class="o">=</span> <span class="n">print_intersection</span><span class="p">(</span>
        <span class="n">annot_vuuids1</span><span class="p">,</span> <span class="n">annot_vuuids2</span><span class="p">,</span> <span class="s">&#39;vuuids&#39;</span><span class="p">)</span>

    <span class="c"># Check for overlapping annotations (visual + semantic info) in general</span>
    <span class="n">annot_suuids1</span> <span class="o">=</span> <span class="n">ibs1</span><span class="o">.</span><span class="n">get_annot_semantic_uuids</span><span class="p">(</span><span class="n">aids1</span><span class="p">)</span>
    <span class="n">annot_suuids2</span> <span class="o">=</span> <span class="n">ibs2</span><span class="o">.</span><span class="n">get_annot_semantic_uuids</span><span class="p">(</span><span class="n">aids2</span><span class="p">)</span>
    <span class="n">asx_list1</span><span class="p">,</span> <span class="n">asx_list2</span> <span class="o">=</span> <span class="n">print_intersection</span><span class="p">(</span>
        <span class="n">annot_suuids1</span><span class="p">,</span> <span class="n">annot_suuids2</span><span class="p">,</span> <span class="s">&#39;suuids&#39;</span><span class="p">)</span>

    <span class="c"># Check which images with the same visual uuids have different semantic</span>
    <span class="c"># uuids</span>
    <span class="n">changed_ax_list1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff_ordered</span><span class="p">(</span><span class="n">avx_list1</span><span class="p">,</span> <span class="n">asx_list1</span><span class="p">)</span>
    <span class="n">changed_ax_list2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff_ordered</span><span class="p">(</span><span class="n">avx_list2</span><span class="p">,</span> <span class="n">asx_list2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">changed_ax_list1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">changed_ax_list2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">annot_vuuids1</span><span class="p">,</span> <span class="n">changed_ax_list1</span><span class="p">)</span> <span class="o">==</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span>
        <span class="n">annot_vuuids2</span><span class="p">,</span> <span class="n">changed_ax_list2</span><span class="p">)</span>

    <span class="n">changed_aids1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">aids1</span><span class="p">,</span> <span class="n">changed_ax_list1</span><span class="p">))</span>
    <span class="n">changed_aids2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">aids2</span><span class="p">,</span> <span class="n">changed_ax_list2</span><span class="p">))</span>

    <span class="n">changed_sinfo1</span> <span class="o">=</span> <span class="n">ibs1</span><span class="o">.</span><span class="n">get_annot_semantic_uuid_info</span><span class="p">(</span><span class="n">changed_aids1</span><span class="p">)</span>
    <span class="n">changed_sinfo2</span> <span class="o">=</span> <span class="n">ibs2</span><span class="o">.</span><span class="n">get_annot_semantic_uuid_info</span><span class="p">(</span><span class="n">changed_aids2</span><span class="p">)</span>
    <span class="n">sinfo1_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">changed_sinfo1</span><span class="p">)</span>
    <span class="n">sinfo2_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">changed_sinfo2</span><span class="p">)</span>
    <span class="n">is_semantic_diff</span> <span class="o">=</span> <span class="n">sinfo2_arr</span> <span class="o">!=</span> <span class="n">sinfo1_arr</span>
    <span class="c"># Inspect semantic differences</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">is_semantic_diff</span><span class="p">):</span>
        <span class="n">colxs</span><span class="p">,</span> <span class="n">rowxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">is_semantic_diff</span><span class="p">)</span>
        <span class="n">colx2_rowids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">rowxs</span><span class="p">,</span> <span class="n">colxs</span><span class="p">)</span>
        <span class="n">prop2_rowids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_dict_keys</span><span class="p">(</span>
            <span class="n">changed_sinfo1</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">,</span> <span class="n">colx2_rowids</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;changed_value_counts = &#39;</span> <span class="o">+</span>
              <span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">map_dict_vals</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">prop2_rowids</span><span class="p">)))</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">embed</span><span class="p">()</span>
        <span class="n">yawx</span> <span class="o">=</span> <span class="n">changed_sinfo1</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;yaw&#39;</span><span class="p">)</span>

        <span class="c"># Show change in viewpoints</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colx2_rowids</span><span class="p">[</span><span class="n">yawx</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">ibsfuncs</span>  <span class="c"># NOQA</span>
            <span class="n">vp_category_diff</span> <span class="o">=</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">viewpoint_diff</span><span class="p">(</span>
                <span class="n">sinfo1_arr</span><span class="p">[</span><span class="n">yawx</span><span class="p">],</span> <span class="n">sinfo2_arr</span><span class="p">[</span><span class="n">yawx</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="c"># Look for category changes</span>
            <span class="c">#any_diff = np.floor(vp_category_diff) &gt; 0</span>
            <span class="c">#_xs    = np.nonzero(any_diff)[0]</span>
            <span class="c">#_aids1 = changed_aids1.take(_xs)</span>
            <span class="c">#_aids2 = changed_aids2.take(_xs)</span>
            <span class="c"># Look for significant changes</span>
            <span class="n">is_significant_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">vp_category_diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="n">significant_xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">is_significant_diff</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">significant_aids1</span> <span class="o">=</span> <span class="n">changed_aids1</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">significant_xs</span><span class="p">)</span>
            <span class="n">significant_aids2</span> <span class="o">=</span> <span class="n">changed_aids2</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">significant_xs</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;There are </span><span class="si">%d</span><span class="s"> significant viewpoint changes&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">significant_aids2</span><span class="p">),))</span>
            <span class="c">#vt.ori_distance(sinfo1_arr[yawx], sinfo2_arr[yawx])</span>
            <span class="c">#zip(ibs1.get_annot_yaw_texts(significant_aids1),</span>
            <span class="c">#ibs2.get_annot_yaw_texts(significant_aids2))</span>
            <span class="c"># print(&#39;yawdiff = %r&#39; % )</span>
            <span class="c"># if False:</span>
            <span class="c"># Hack: Apply fixes</span>
            <span class="c"># good_yaws = ibs2.get_annot_yaws(significant_aids2)</span>
            <span class="c"># ibs1.set_annot_yaws(significant_aids1, good_yaws)</span>
            <span class="c">#    pass</span>
            <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
                <span class="c"># Debug code</span>
                <span class="kn">import</span> <span class="nn">ibeis.viz</span>
                <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
                <span class="c">#aid_pairs = list(zip(_aids1, _aids2))</span>
                <span class="n">aid_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">significant_aids1</span><span class="p">,</span> <span class="n">significant_aids2</span><span class="p">))</span>
                <span class="n">pairs_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ichunks</span><span class="p">(</span><span class="n">aid_pairs</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">pairs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pairs_iter</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">pnum_</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="n">nRows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">),</span> <span class="n">nCols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                        <span class="n">ibeis</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">show_chip</span><span class="p">(</span>
                            <span class="n">ibs1</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">(),</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">show_yawtext</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nokpts</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                        <span class="n">ibeis</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">show_chip</span><span class="p">(</span>
                            <span class="n">ibs2</span><span class="p">,</span> <span class="n">aid2</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">(),</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">show_yawtext</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nokpts</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c">#</span>
    <span class="n">nAnnots_per_image1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs1</span><span class="o">.</span><span class="n">get_image_num_annotations</span><span class="p">(</span><span class="n">gids1</span><span class="p">))</span>
    <span class="n">nAnnots_per_image2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs2</span><span class="o">.</span><span class="n">get_image_num_annotations</span><span class="p">(</span><span class="n">gids2</span><span class="p">))</span>
    <span class="c">#</span>
    <span class="n">images_without_annots1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nAnnots_per_image1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">images_without_annots2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nAnnots_per_image2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;images_without_annots1 = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">images_without_annots1</span><span class="p">,))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;images_without_annots2 = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">images_without_annots2</span><span class="p">,))</span>

    <span class="n">nAnnots_per_image1</span>

    <span class="k">class</span> <span class="nc">AlignedIndex</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iddict_</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">make_aligned_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_lists</span><span class="p">,</span> <span class="n">data_lists</span><span class="p">):</span>
            <span class="n">idx_lists</span> <span class="o">=</span> <span class="p">[</span><span class="n">vt</span><span class="o">.</span><span class="n">compute_unique_data_ids_</span><span class="p">(</span>
                <span class="n">id_list</span><span class="p">,</span> <span class="n">iddict_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iddict_</span><span class="p">)</span> <span class="k">for</span> <span class="n">id_list</span> <span class="ow">in</span> <span class="n">id_lists</span><span class="p">]</span>
            <span class="n">aligned_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx_list</span><span class="p">,</span> <span class="n">data_array</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">idx_lists</span><span class="p">,</span> <span class="n">data_lists</span><span class="p">):</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iddict_</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">array</span><span class="p">[</span><span class="n">idx_list</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_array</span>
                <span class="n">aligned_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">aligned_data</span>

    <span class="c"># Try to figure out the conflicts</span>
    <span class="c"># TODO: finishme</span>

    <span class="bp">self</span> <span class="o">=</span> <span class="n">AlignedIndex</span><span class="p">()</span>
    <span class="n">id_lists</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_uuids1</span><span class="p">,</span> <span class="n">image_uuids2</span><span class="p">)</span>
    <span class="n">data_lists</span> <span class="o">=</span> <span class="p">(</span><span class="n">nAnnots_per_image1</span><span class="p">,</span> <span class="n">nAnnots_per_image2</span><span class="p">)</span>
    <span class="n">aligned_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_aligned_arrays</span><span class="p">(</span><span class="n">id_lists</span><span class="p">,</span> <span class="n">data_lists</span><span class="p">)</span>
    <span class="n">nAnnots1_aligned</span><span class="p">,</span> <span class="n">nAnnots2_aligned</span> <span class="o">=</span> <span class="n">aligned_data</span>

    <span class="n">nAnnots_difference</span> <span class="o">=</span> <span class="n">nAnnots1_aligned</span> <span class="o">-</span> <span class="n">nAnnots2_aligned</span>
    <span class="n">nAnnots_difference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">nAnnots_difference</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;images_with_different_num_annnots = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">nAnnots_difference</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),))</span>

</div>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">def MERGE_NNP_MASTER_SCRIPT():</span>
<span class="sd">    print(ut.truncate_str(ibs_dst.db.get_table_csv(ibeis.const.ANNOTATION_TABLE,</span>
<span class="sd">        exclude_columns=[&#39;annot_verts&#39;, &#39;annot_semantic_uuid&#39;, &#39;annot_note&#39;, &#39;annot_parent_rowid&#39;]), 10000))</span>
<span class="sd">    print(ut.truncate_str(ibs_src1.db.get_table_csv(ibeis.const.ANNOTATION_TABLE,</span>
<span class="sd">        exclude_columns=[&#39;annot_verts&#39;, &#39;annot_semantic_uuid&#39;, &#39;annot_note&#39;, &#39;annot_parent_rowid&#39;]), 10000))</span>
<span class="sd">    print(ut.truncate_str(ibs_src1.db.get_table_csv(ibeis.const.ANNOTATION_TABLE), 10000))</span>

<span class="sd">    from ibeis.dbio.export_subset import *  # NOQA</span>
<span class="sd">    import ibeis</span>
<span class="sd">    # Step 1</span>
<span class="sd">    ibs_src1 = ibeis.opendb(&#39;GZC&#39;)</span>
<span class="sd">    ibs_dst = ibeis.opendb(&#39;NNP_Master3&#39;, allow_newdir=True)</span>
<span class="sd">    merge_databases2(ibs_src1, ibs_dst)</span>

<span class="sd">    ibs_src2 = ibeis.opendb(&#39;NNP_initial&#39;)</span>
<span class="sd">    merge_databases2(ibs_src2, ibs_dst)</span>

<span class="sd">    ## Step 2</span>
<span class="sd">    #ibs_src = ibeis.opendb(&#39;GZC&#39;)</span>

<span class="sd">    ## Check</span>
<span class="sd">    ibs1 = ibeis.opendb(&#39;NNP_initial&#39;)</span>
<span class="sd">    ibs2 = ibeis.opendb(&#39;GZC&#39;)</span>
<span class="sd">    ibs3 = ibs_dst</span>

<span class="sd">    #print(ibs1.get_image_time_statstr())</span>
<span class="sd">    #print(ibs2.get_image_time_statstr())</span>
<span class="sd">    #print(ibs3.get_image_time_statstr())</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    python -m ibeis.dbio.export_subset</span>
<span class="sd">    python -m ibeis.dbio.export_subset --allexamples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Jon Crall.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.4.4',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>