

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ibeis.model.hots.chip_match &mdash; ibeis 1.5.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ibeis 1.5.1 documentation" href="../../../../index.html"/>
        <link rel="up" title="ibeis.model.hots" href="../hots.html"/> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> ibeis
          

          
          </a>

          
            
            
              <div class="version">
                1.5.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../ibeis.html">ibeis package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../index.html">ibeis</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      
          <li><a href="../../../ibeis.html">ibeis</a> &raquo;</li>
      
          <li><a href="../../model.html">ibeis.model</a> &raquo;</li>
      
          <li><a href="../hots.html">ibeis.model.hots</a> &raquo;</li>
      
    <li>ibeis.model.hots.chip_match</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ibeis.model.hots.chip_match</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">xor</span>
<span class="kn">from</span> <span class="nn">vtool</span> <span class="kn">import</span> <span class="n">matching</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">ibeis.model.hots</span> <span class="kn">import</span> <span class="n">hstypes</span>
<span class="kn">from</span> <span class="nn">ibeis.model.hots</span> <span class="kn">import</span> <span class="n">old_chip_match</span>
<span class="kn">from</span> <span class="nn">ibeis.model.hots</span> <span class="kn">import</span> <span class="n">scoring</span>
<span class="kn">from</span> <span class="nn">ibeis.model.hots</span> <span class="kn">import</span> <span class="n">name_scoring</span>
<span class="kn">from</span> <span class="nn">ibeis.model.hots</span> <span class="kn">import</span> <span class="n">_pipeline_helpers</span> <span class="k">as</span> <span class="n">plh</span>  <span class="c"># NOQA</span>
<span class="k">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;[chip_match]&#39;</span><span class="p">,</span> <span class="n">DEBUG</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="n">DEBUG_CHIPMATCH</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c">#import six</span>

<span class="n">MAX_FNAME_LEN</span> <span class="o">=</span> <span class="mi">64</span> <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">WIN32</span> <span class="k">else</span> <span class="mi">200</span>
<span class="n">TRUNCATE_UUIDS</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s">&#39;--truncate-uuids&#39;</span><span class="p">,</span> <span class="s">&#39;--trunc-uuids&#39;</span><span class="p">))</span>
<span class="c">#or ( ut.is_developer() and not ut.get_argflag((&#39;--notrunc-uuids&#39;,)))</span>


<span class="nd">@profile</span>
<div class="viewcode-block" id="get_chipmatch_fname"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.get_chipmatch_fname">[docs]</a><span class="k">def</span> <span class="nf">get_chipmatch_fname</span><span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">qauuid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cfgstr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">TRUNCATE_UUIDS</span><span class="o">=</span><span class="n">TRUNCATE_UUIDS</span><span class="p">,</span> <span class="n">MAX_FNAME_LEN</span><span class="o">=</span><span class="n">MAX_FNAME_LEN</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.model.hots.chip_match --test-get_chipmatch_fname</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_pre_sver(&#39;PZ_MTEST&#39;, qaid_list=[18])</span>
<span class="sd">        &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">        &gt;&gt;&gt; fname = get_chipmatch_fname(cm.qaid, qreq_, qauuid=None, TRUNCATE_UUIDS=False, MAX_FNAME_LEN=200)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;fname = %s&#39; % (ut.repr2(fname),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        fname = &#39;qaid=18_cm_qjjzmjiwwwdhyzrw_quuid=a126d459-b730-573e-7a21-92894b016565.cPkl&#39;</span>

<span class="sd">        fname = &#39;qaid=18_cm_mnzkiegiilcsbwxy_quuid=a126d459-b730-573e-7a21-92894b016565.cPkl&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">qauuid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[chipmatch] Warning qasuuid should be passed into get_chipmatch_fname&#39;</span><span class="p">)</span>
        <span class="n">qauuid</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_semantic_uuids</span><span class="p">(</span><span class="n">qaid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfgstr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[chipmatch] Warning cfgstr should be passed into get_chipmatch_fname&#39;</span><span class="p">)</span>
        <span class="n">cfgstr</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">get_cfgstr</span><span class="p">(</span><span class="n">with_query</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">with_data</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">with_pipe</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#print(&#39;cfgstr = %r&#39; % (cfgstr,))</span>
    <span class="n">fname_fmt</span> <span class="o">=</span> <span class="s">&#39;qaid={qaid}_cm_{cfgstr}_quuid={qauuid}{ext}&#39;</span>
    <span class="n">text_type</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span>
    <span class="c">#text_type = str</span>
    <span class="n">qauuid_str</span> <span class="o">=</span> <span class="n">text_type</span><span class="p">(</span><span class="n">qauuid</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="k">if</span> <span class="n">TRUNCATE_UUIDS</span> <span class="k">else</span> <span class="n">text_type</span><span class="p">(</span><span class="n">qauuid</span><span class="p">)</span>
    <span class="n">fmt_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cfgstr</span><span class="o">=</span><span class="n">cfgstr</span><span class="p">,</span> <span class="n">qaid</span><span class="o">=</span><span class="n">qaid</span><span class="p">,</span> <span class="n">qauuid</span><span class="o">=</span><span class="n">qauuid_str</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s">&#39;.cPkl&#39;</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">long_fname_format</span><span class="p">(</span><span class="n">fname_fmt</span><span class="p">,</span> <span class="n">fmt_dict</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;cfgstr&#39;</span><span class="p">],</span>
                                 <span class="n">max_len</span><span class="o">=</span><span class="n">MAX_FNAME_LEN</span><span class="p">,</span> <span class="n">hack27</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fname</span>

</div>
<span class="nd">@six.add_metaclass</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ReloadingMetaclass</span><span class="p">)</span>
<div class="viewcode-block" id="ChipMatch2"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2">[docs]</a><span class="k">class</span> <span class="nc">ChipMatch2</span><span class="p">(</span><span class="n">old_chip_match</span><span class="o">.</span><span class="n">_OldStyleChipMatchSimulator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    behaves as as the ChipMatchOldTup named tuple until we</span>
<span class="sd">    completely replace the old structure</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Standard Contstructor</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        qaid and daid_list are not optional. fm_list and fsv_list are strongly</span>
<span class="sd">        encouraged and will probalby break things if they are not there.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span>         <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span>    <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span>      <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span>     <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span>      <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span>   <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span>       <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># This is aligned with daid list, need to avoid confusion with</span>
        <span class="c"># unique_nids</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># standard groupings</span>
        <span class="c"># TODO: rename unique_nids to indicate it is aligned with name_groupxs</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># belongs to name_groupxs</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># Name probabilities</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">prob_list</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># Annot scores</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># Name scores</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># TODO: have subclass or dict for special scores</span>
        <span class="c"># Special annot scores</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">special_annot_scores</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&#39;csum&#39;</span><span class="p">,</span>
            <span class="s">&#39;acov&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">score_method</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">special_annot_scores</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">score_method</span> <span class="o">+</span> <span class="s">&#39;_score_list&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="c">#cm.csum_score_list = None</span>
        <span class="c">#cm.acov_score_list = None</span>
        <span class="c"># Special name scores</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">special_name_scores</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&#39;nsum&#39;</span><span class="p">,</span>
            <span class="s">&#39;maxcsum&#39;</span><span class="p">,</span>
            <span class="s">&#39;ncov&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">score_method</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">special_name_scores</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">score_method</span> <span class="o">+</span> <span class="s">&#39;_score_list&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="c">#cm.nsum_score_list = None</span>
        <span class="c">#cm.maxcsum_score_list = None</span>
        <span class="c">#cm.ncov_score_list = None</span>
        <span class="c"># Re-evaluatables (for convinience only)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># maps onto cm.daid_list</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># maps onto cm.unique_nids</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ChipMatch2.initialize"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qaid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">daid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fm_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fsv_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">fk_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">score_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">H_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">fsv_col_lbls</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dnid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">qnid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">unique_nids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name_score_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">annot_score_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">autoinit</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        qaid and daid_list are not optional. fm_list and fsv_list are strongly</span>
<span class="sd">        encouraged and will probalby break things if they are not there.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">DEBUG_CHIPMATCH</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">daid_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;must give daids&#39;</span>
            <span class="k">assert</span> <span class="n">fm_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fm_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">daid_list</span><span class="p">),</span> <span class="s">&#39;incompatable data&#39;</span>
            <span class="k">assert</span> <span class="n">fsv_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fsv_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">daid_list</span><span class="p">),</span> <span class="s">&#39;incompatable data&#39;</span>
            <span class="k">assert</span> <span class="n">fk_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fk_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">daid_list</span><span class="p">),</span> <span class="s">&#39;incompatable data&#39;</span>
            <span class="k">assert</span> <span class="n">H_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">H_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">daid_list</span><span class="p">),</span> <span class="s">&#39;incompatable data&#39;</span>
            <span class="k">assert</span> <span class="n">score_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">score_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">daid_list</span><span class="p">),</span> <span class="s">&#39;incompatable data&#39;</span>
            <span class="k">assert</span> <span class="n">dnid_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">dnid_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">daid_list</span><span class="p">),</span> <span class="s">&#39;incompatable data&#39;</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span>         <span class="o">=</span> <span class="n">qaid</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">daid_list</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span>      <span class="o">=</span> <span class="n">fm_list</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span>     <span class="o">=</span> <span class="n">fsv_list</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span>      <span class="o">=</span> <span class="p">(</span><span class="n">fk_list</span> <span class="k">if</span> <span class="n">fk_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span>
                           <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">]</span>
                           <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span>   <span class="o">=</span> <span class="n">score_list</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span>       <span class="o">=</span> <span class="n">H_list</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span> <span class="o">=</span> <span class="n">fsv_col_lbls</span>
        <span class="c">#cm.daid2_idx    = None</span>
        <span class="c">#cm.fs_list = None</span>
        <span class="c"># TODO</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">dnid_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dnid_list</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span> <span class="o">=</span> <span class="n">qnid</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="o">=</span> <span class="n">unique_nids</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span> <span class="o">=</span> <span class="n">name_score_list</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span> <span class="o">=</span> <span class="n">annot_score_list</span>
        <span class="c"># standard groupings</span>
        <span class="c">#cm.unique_nids = None  # belongs to name_groupxs</span>
        <span class="c">#cm.nid2_nidx = None</span>
        <span class="c">#cm.name_groupxs = None</span>
        <span class="c">## Name probabilities</span>
        <span class="c">#cm.prob_list = None</span>
        <span class="c">## Annot scores</span>
        <span class="c">#cm.annot_score_list = None</span>
        <span class="c">## (Aggregated) Name scores</span>
        <span class="c">#cm.name_score_list = None</span>
        <span class="c">#cm.maxcsum_score_list = None</span>
        <span class="c">## TODO: have subclass or dict for special scores</span>
        <span class="k">if</span> <span class="n">autoinit</span><span class="p">:</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">_update_daid_index</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">cm</span><span class="o">.</span><span class="n">_update_unique_nid_index</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_empty_hack</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c">#------------------</span>
    <span class="c"># Modification / Evaluation Functions</span>
    <span class="c">#------------------</span>

    <span class="k">def</span> <span class="nf">_cast_scores</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">):</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fsv</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">fsv</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">]</span>

<div class="viewcode-block" id="ChipMatch2.extend_results"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.extend_results">[docs]</a>    <span class="k">def</span> <span class="nf">extend_results</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">other_aids</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns a new cmtup_old that contains empty data for an extended set of</span>
<span class="sd">        aids</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">other_aids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">other_aids</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">get_external_daids</span><span class="p">()</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">other_aids_</span> <span class="o">=</span> <span class="n">other_aids</span>
        <span class="n">other_aids_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">other_aids_</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>
        <span class="n">other_aids_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">other_aids_</span><span class="p">,</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">])</span>
        <span class="n">other_nids_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">other_aids_</span><span class="p">)</span>
        <span class="n">other_unique_nids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">other_nids_</span><span class="p">),</span>
                                         <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_aids_</span><span class="p">)</span>
        <span class="n">num2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_unique_nids</span><span class="p">)</span>
        <span class="c">#print(&#39;PRINT EXTENDING BY num = %r&#39; % (num,))</span>
        <span class="c">#print(&#39;num2 = %r&#39; % (num2,))</span>

        <span class="k">def</span> <span class="nf">extend_scores</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">vals</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">extend_nplists</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">x_list</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)]</span> <span class="o">*</span> <span class="n">num</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">extend_pylist</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">x_list</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x_list</span> <span class="o">+</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num</span><span class="p">)</span>

        <span class="n">daid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">other_aids_</span><span class="p">)</span>
        <span class="n">dnid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">other_nids_</span><span class="p">)</span>

        <span class="n">qaid</span>         <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span>
        <span class="n">qnid</span>         <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span>
        <span class="n">fsv_col_lbls</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span>

        <span class="n">num_vs</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">fsv_col_lbls</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">fsv_col_lbls</span><span class="p">)</span>

        <span class="n">fm_list</span>  <span class="o">=</span> <span class="n">extend_nplists</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">FM_DTYPE</span><span class="p">)</span>
        <span class="n">fk_list</span>  <span class="o">=</span> <span class="n">extend_nplists</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">FK_DTYPE</span><span class="p">)</span>
        <span class="n">fs_list</span>  <span class="o">=</span> <span class="n">extend_nplists</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">FS_DTYPE</span><span class="p">)</span>
        <span class="n">fsv_list</span> <span class="o">=</span> <span class="n">extend_nplists</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_vs</span><span class="p">),</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">FS_DTYPE</span><span class="p">)</span>
        <span class="n">H_list</span>   <span class="o">=</span> <span class="n">extend_pylist</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">score_list</span> <span class="o">=</span> <span class="n">extend_scores</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">)</span>
        <span class="n">annot_score_list</span> <span class="o">=</span> <span class="n">extend_scores</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="p">)</span>

        <span class="n">unique_nids</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">,</span> <span class="n">other_unique_nids</span><span class="p">)</span>
        <span class="n">name_score_list</span> <span class="o">=</span> <span class="n">extend_scores</span><span class="p">(</span><span class="n">num2</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="p">)</span>

        <span class="n">cm2</span> <span class="o">=</span> <span class="n">ChipMatch2</span><span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">,</span> <span class="n">fsv_list</span><span class="p">,</span> <span class="n">fk_list</span><span class="p">,</span>
                         <span class="n">score_list</span><span class="p">,</span> <span class="n">H_list</span><span class="p">,</span> <span class="n">fsv_col_lbls</span><span class="p">,</span> <span class="n">dnid_list</span><span class="p">,</span>
                         <span class="n">qnid</span><span class="p">,</span> <span class="n">unique_nids</span><span class="p">,</span> <span class="n">name_score_list</span><span class="p">,</span>
                         <span class="n">annot_score_list</span><span class="p">,</span> <span class="n">autoinit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">cm2</span><span class="o">.</span><span class="n">fs_list</span> <span class="o">=</span> <span class="n">fs_list</span>
        <span class="k">for</span> <span class="n">score_method</span> <span class="ow">in</span> <span class="n">cm2</span><span class="o">.</span><span class="n">special_annot_scores</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">score_method</span> <span class="o">+</span> <span class="s">&#39;_score_list&#39;</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cm2</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">extend_scores</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="bp">None</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">score_method</span> <span class="ow">in</span> <span class="n">cm2</span><span class="o">.</span><span class="n">special_name_scores</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">score_method</span> <span class="o">+</span> <span class="s">&#39;_score_list&#39;</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cm2</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">extend_scores</span><span class="p">(</span><span class="n">num2</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="bp">None</span><span class="p">)))</span>
        <span class="n">cm2</span><span class="o">.</span><span class="n">_update_daid_index</span><span class="p">()</span>
        <span class="n">cm2</span><span class="o">.</span><span class="n">_update_unique_nid_index</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cm2</span>
</div>
    <span class="k">def</span> <span class="nf">_update_daid_index</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span> <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span>
                        <span class="n">ut</span><span class="o">.</span><span class="n">make_index_lookup</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">))</span>
        <span class="c">#{daid: idx for idx, daid in enumerate(cm.daid_list)})</span>

    <span class="k">def</span> <span class="nf">_update_unique_nid_index</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="c">#assert cm.unique_nids is not None</span>
        <span class="n">unique_nids_</span><span class="p">,</span> <span class="n">name_groupxs_</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span> <span class="ow">is</span> <span class="bp">None</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="o">=</span> <span class="n">unique_nids_</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_index_lookup</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">)</span>
        <span class="n">nidx_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">,</span> <span class="n">unique_nids_</span><span class="p">))</span>
        <span class="n">inverse_idx_list</span> <span class="o">=</span> <span class="n">nidx_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">name_groupxs_</span><span class="p">,</span> <span class="n">inverse_idx_list</span><span class="p">)</span>
        <span class="c">#cm.unique_nids  = unique_nids</span>
        <span class="c">#cm.name_groupxs = name_groupxs</span>
        <span class="c">#cm.nid2_nidx    = ut.make_index_lookup(cm.unique_nids)</span>

<div class="viewcode-block" id="ChipMatch2.evaluate_dnids"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.evaluate_dnids">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_dnids</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ibs</span><span class="p">):</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">))</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">_update_unique_nid_index</span><span class="p">()</span>
        <span class="c"># evaluate name groupings as well</span>
        <span class="c">#unique_nids, name_groupxs = vt.group_indices(cm.dnid_list)</span>
        <span class="c">#cm.unique_nids  = unique_nids</span>
        <span class="c">#cm.name_groupxs = name_groupxs</span>
        <span class="c">#cm.nid2_nidx    = ut.make_index_lookup(cm.unique_nids)</span>
</div>
<div class="viewcode-block" id="ChipMatch2.sortself"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.sortself">[docs]</a>    <span class="k">def</span> <span class="nf">sortself</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; reorders the internal data using cm.score_list &quot;&quot;&quot;</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">csum_score_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">csum_score_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">H_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">_update_daid_index</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ChipMatch2.shortlist_subset"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.shortlist_subset">[docs]</a>    <span class="k">def</span> <span class="nf">shortlist_subset</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">top_aids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns a new cmtup_old with only the requested daids &quot;&quot;&quot;</span>
        <span class="n">qaid</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span>
        <span class="n">qnid</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span>
        <span class="n">idx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">,</span> <span class="n">top_aids</span><span class="p">)</span>
        <span class="n">daid_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">)</span>
        <span class="n">fm_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">)</span>
        <span class="n">fsv_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">)</span>
        <span class="n">fk_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">)</span>
        <span class="c">#score_list   = vt.trytake(cm.score_list, idx_list)</span>
        <span class="n">score_list</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># don&#39;t transfer scores</span>
        <span class="n">H_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">H_list</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">)</span>
        <span class="n">dnid_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">)</span>
        <span class="n">fsv_col_lbls</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span>
        <span class="n">cm_subset</span> <span class="o">=</span> <span class="n">ChipMatch2</span><span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">,</span> <span class="n">fsv_list</span><span class="p">,</span> <span class="n">fk_list</span><span class="p">,</span>
                               <span class="n">score_list</span><span class="p">,</span> <span class="n">H_list</span><span class="p">,</span> <span class="n">fsv_col_lbls</span><span class="p">,</span> <span class="n">dnid_list</span><span class="p">,</span>
                               <span class="n">qnid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cm_subset</span>

    <span class="c"># Alternative Cosntructors / Convertors</span>
</div>
    <span class="nd">@classmethod</span>
    <span class="nd">@profile</span>
<div class="viewcode-block" id="ChipMatch2.from_qres"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.from_qres">[docs]</a>    <span class="k">def</span> <span class="nf">from_qres</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">qres</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aid2_fm_</span>    <span class="o">=</span> <span class="n">qres</span><span class="o">.</span><span class="n">aid2_fm</span>
        <span class="n">aid2_fsv_</span>   <span class="o">=</span> <span class="n">qres</span><span class="o">.</span><span class="n">aid2_fsv</span>
        <span class="n">aid2_fk_</span>    <span class="o">=</span> <span class="n">qres</span><span class="o">.</span><span class="n">aid2_fk</span>
        <span class="n">aid2_score_</span> <span class="o">=</span> <span class="n">qres</span><span class="o">.</span><span class="n">aid2_score</span>
        <span class="n">aid2_H_</span>     <span class="o">=</span> <span class="n">qres</span><span class="o">.</span><span class="n">aid2_H</span>
        <span class="n">qaid</span>        <span class="o">=</span> <span class="n">qres</span><span class="o">.</span><span class="n">qaid</span>
        <span class="n">cmtup_old</span> <span class="o">=</span> <span class="p">(</span><span class="n">aid2_fm_</span><span class="p">,</span> <span class="n">aid2_fsv_</span><span class="p">,</span> <span class="n">aid2_fk_</span><span class="p">,</span> <span class="n">aid2_score_</span><span class="p">,</span> <span class="n">aid2_H_</span><span class="p">)</span>
        <span class="n">fsv_col_lbls</span> <span class="o">=</span> <span class="n">qres</span><span class="o">.</span><span class="n">filtkey_list</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">from_cmtup_old</span><span class="p">(</span><span class="n">cmtup_old</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">fsv_col_lbls</span><span class="p">,</span> <span class="n">daid_list</span><span class="o">=</span><span class="n">qres</span><span class="o">.</span><span class="n">daids</span><span class="p">)</span>
        <span class="c">#with ut.embed_on_exception_context:</span>
        <span class="c">#if &#39;lnbnn&#39; in fsv_col_lbls:</span>
        <span class="c">#    assert &#39;lnbnn&#39; in fsv_col_lbls, &#39;cm.fsv_col_lbls=%r&#39; % (cm.fsv_col_lbls,)</span>
        <span class="c">#    fs_list = [fsv.T[cm.fsv_col_lbls.index(&#39;lnbnn&#39;)] for fsv in cm.fsv_list]</span>
        <span class="c">#else:</span>
        <span class="k">if</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">fs_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">qres</span><span class="o">.</span><span class="n">aid2_fs</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">FS_DTYPE</span><span class="p">))</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span> <span class="o">=</span> <span class="n">fs_list</span>
        <span class="k">return</span> <span class="n">cm</span>
</div>
    <span class="nd">@classmethod</span>
    <span class="nd">@profile</span>
<div class="viewcode-block" id="ChipMatch2.from_unscored"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.from_unscored">[docs]</a>    <span class="k">def</span> <span class="nf">from_unscored</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">prior_cm</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">,</span> <span class="n">fs_list</span><span class="p">,</span> <span class="n">H_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fsv_col_lbls</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">qaid</span> <span class="o">=</span> <span class="n">prior_cm</span><span class="o">.</span><span class="n">qaid</span>
        <span class="n">daid_list</span> <span class="o">=</span> <span class="n">prior_cm</span><span class="o">.</span><span class="n">daid_list</span>
        <span class="n">fsv_list</span> <span class="o">=</span> <span class="n">matching</span><span class="o">.</span><span class="n">ensure_fsv_list</span><span class="p">(</span><span class="n">fs_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fsv_col_lbls</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fsv_col_lbls</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;unknown&#39;</span><span class="p">]</span>
            <span class="c">#fsv_col_lbls = [str(count) for count in range(num_cols)]</span>
            <span class="c">#fsv_col_lbls</span>
        <span class="c">#score_list = [fsv.prod(axis=1).sum() for fsv in fsv_list]</span>
        <span class="n">score_list</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">fsv</span> <span class="ow">in</span> <span class="n">fsv_list</span><span class="p">]</span>
        <span class="c">#fsv.prod(axis=1).sum() for fsv in fsv_list]</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">,</span> <span class="n">fsv_list</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">score_list</span><span class="p">,</span> <span class="n">H_list</span><span class="p">,</span> <span class="n">fsv_col_lbls</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span> <span class="o">=</span> <span class="n">fs_list</span>
        <span class="k">return</span> <span class="n">cm</span>
</div>
    <span class="nd">@classmethod</span>
    <span class="nd">@profile</span>
<div class="viewcode-block" id="ChipMatch2.from_vsmany_match_tup"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.from_vsmany_match_tup">[docs]</a>    <span class="k">def</span> <span class="nf">from_vsmany_match_tup</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">valid_match_tup</span><span class="p">,</span> <span class="n">qaid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fsv_col_lbls</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            valid_match_tup (tuple):</span>
<span class="sd">            qaid (int):  query annotation id</span>
<span class="sd">            fsv_col_lbls (None):</span>

<span class="sd">        Returns:</span>
<span class="sd">            ChipMatch2: cm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># CONTIGUOUS ARRAYS MAKE A HUGE DIFFERENCE</span>
        <span class="c"># Vsmany - create new cmtup_old</span>
        <span class="p">(</span><span class="n">valid_daid</span><span class="p">,</span> <span class="n">valid_qfx</span><span class="p">,</span> <span class="n">valid_dfx</span><span class="p">,</span> <span class="n">valid_scorevec</span><span class="p">,</span> <span class="n">valid_rank</span><span class="p">)</span> <span class="o">=</span> <span class="n">valid_match_tup</span>
        <span class="c">#valid_fm = np.vstack((valid_qfx, valid_dfx)).T</span>
        <span class="n">valid_fm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">valid_qfx</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">],</span> <span class="n">valid_dfx</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">])))</span>
        <span class="n">daid_list</span><span class="p">,</span> <span class="n">daid_groupxs</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">valid_daid</span><span class="p">)</span>
        <span class="n">fm_list</span>  <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">valid_fm</span><span class="p">,</span> <span class="n">daid_groupxs</span><span class="p">)</span>
        <span class="c">#fsv_list = vt.apply_grouping(valid_scorevec, daid_groupxs)</span>
        <span class="n">fsv_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">valid_scorevec</span><span class="p">),</span> <span class="n">daid_groupxs</span><span class="p">)</span>
        <span class="n">fk_list</span>  <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">valid_rank</span><span class="p">,</span> <span class="n">daid_groupxs</span><span class="p">)</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">,</span> <span class="n">fsv_list</span><span class="p">,</span> <span class="n">fk_list</span><span class="p">,</span> <span class="n">fsv_col_lbls</span><span class="o">=</span><span class="n">fsv_col_lbls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cm</span>
</div>
    <span class="nd">@classmethod</span>
    <span class="nd">@profile</span>
<div class="viewcode-block" id="ChipMatch2.from_vsone_match_tup"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.from_vsone_match_tup">[docs]</a>    <span class="k">def</span> <span class="nf">from_vsone_match_tup</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">valid_match_tup_list</span><span class="p">,</span> <span class="n">daid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                             <span class="n">qaid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fsv_col_lbls</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_allsame</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">valid_match_tup_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))),</span>\
            <span class="s">&#39;internal daids should not have different daids for vsone&#39;</span>
        <span class="n">qfx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">valid_match_tup_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dfx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">valid_match_tup_list</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">fm_list</span>  <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">dfx_qfx</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">dfx_qfx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dfx_list</span><span class="p">,</span> <span class="n">qfx_list</span><span class="p">)]</span>
        <span class="n">fsv_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">valid_match_tup_list</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">fk_list</span>  <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">valid_match_tup_list</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">,</span> <span class="n">fsv_list</span><span class="p">,</span> <span class="n">fk_list</span><span class="p">,</span> <span class="n">fsv_col_lbls</span><span class="o">=</span><span class="n">fsv_col_lbls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cm</span>

    <span class="c">#def as_qres2(cm, qreq_):</span>
    <span class="c">#    qres = qreq_.make_empty_query_result(cm.qaid)</span>
    <span class="c">#    #ut.assert_eq(qaid, cm.qaid)</span>
    <span class="c">#    qres.filtkey_list = cm.fsv_col_lbls</span>
    <span class="c">#    qres.aid2_fm    = dict(zip(cm.daid_list, cm.fm_list))</span>
    <span class="c">#    qres.aid2_fsv   = dict(zip(cm.daid_list, cm.fsv_list))</span>
    <span class="c">#    qres.aid2_fs    = dict(zip(cm.daid_list, [fsv.prod(axis=1) for fsv in cm.fsv_list]))</span>
    <span class="c">#    qres.aid2_fk    = dict(zip(cm.daid_list, cm.fk_list))</span>
    <span class="c">#    qres.aid2_score = dict(zip(cm.daid_list, cm.score_list))</span>
    <span class="c">#    qres.aid2_H     = None if cm.H_list is None else dict(zip(cm.daid_list, cm.H_list))</span>
    <span class="c">#    qres.aid2_prob  = None if cm.prob_list is None else dict(zip(cm.daid_list, cm.prob_list))</span>
    <span class="c">#    return qres</span>

    <span class="c">#def as_qres(cm, qreq_):</span>
    <span class="c">#    from ibeis.model.hots import scoring</span>
    <span class="c">#    assert qreq_ is not None</span>
    <span class="c">#    # Perform final scoring</span>
    <span class="c">#    # TODO: only score if already unscored</span>
    <span class="c">#    score_method = qreq_.qparams.score_method</span>
    <span class="c">#    # TODO: move scoring part to pipeline</span>
    <span class="c">#    scoring.score_chipmatch_list(qreq_, [cm], score_method)</span>
    <span class="c">#    # Normalize scores if requested</span>
    <span class="c">#    if qreq_.qparams.score_normalization:</span>
    <span class="c">#        normalizer = qreq_.normalizer</span>
    <span class="c">#        cm.prob_list = normalizer.normalize_score_list(cm.score_list)</span>
    <span class="c">#    qres = cm.as_qres2(qreq_)</span>
    <span class="c">#    return qres</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ChipMatch2.from_json"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.from_json">[docs]</a>    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">json_str</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Convert json string back to ChipMatch object</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            # FIXME; util_test is broken with classmethods</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --test-from_json --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; cls = ChipMatch2</span>
<span class="sd">            &gt;&gt;&gt; cm1, qreq_ = ibeis.testdata_cm()</span>
<span class="sd">            &gt;&gt;&gt; json_str = cm1.to_json()</span>
<span class="sd">            &gt;&gt;&gt; cm = ChipMatch2.from_json(json_str)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; cm.score_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; cm.show_single_namematch(qreq_, 1)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">convert_numpy_lists</span><span class="p">(</span><span class="n">arr_list</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arr_list</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">convert_numpy</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">replace_nones</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="n">class_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
        <span class="n">key_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">initialize</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c"># HACKY</span>
        <span class="n">key_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;autoinit&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="n">other_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">class_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">key_list</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Not unserializing extra attributes: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">other_keys</span><span class="p">)))</span>
        <span class="n">dict_subset</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_subset</span><span class="p">(</span><span class="n">class_dict</span><span class="p">,</span> <span class="n">key_list</span><span class="p">)</span>
        <span class="n">dict_subset</span><span class="p">[</span><span class="s">&#39;fm_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_numpy_lists</span><span class="p">(</span><span class="n">dict_subset</span><span class="p">[</span><span class="s">&#39;fm_list&#39;</span><span class="p">],</span>
                                                     <span class="n">hstypes</span><span class="o">.</span><span class="n">FM_DTYPE</span><span class="p">)</span>
        <span class="n">dict_subset</span><span class="p">[</span><span class="s">&#39;fsv_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_numpy_lists</span><span class="p">(</span><span class="n">dict_subset</span><span class="p">[</span><span class="s">&#39;fsv_list&#39;</span><span class="p">],</span>
                                                      <span class="n">hstypes</span><span class="o">.</span><span class="n">FS_DTYPE</span><span class="p">)</span>
        <span class="n">dict_subset</span><span class="p">[</span><span class="s">&#39;score_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_numpy</span><span class="p">(</span><span class="n">dict_subset</span><span class="p">[</span><span class="s">&#39;score_list&#39;</span><span class="p">],</span>
                                                  <span class="n">hstypes</span><span class="o">.</span><span class="n">FS_DTYPE</span><span class="p">)</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="o">**</span><span class="n">dict_subset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cm</span>
</div>
<div class="viewcode-block" id="ChipMatch2.to_json"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.to_json">[docs]</a>    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Serialize ChipMatch object as JSON string</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --test-ChipMatch2.to_json:0</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --test-ChipMatch2.to_json</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --test-ChipMatch2.to_json:1 --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; # Simple doctest demonstrating the json format</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; cm, qreq_ = ibs.query_chips(1, [2, 3, 4, 5], return_cm=True, return_request=True)</span>
<span class="sd">            &gt;&gt;&gt; cm.compress_feature_matches(num=4, rng=np.random.RandomState(0))</span>
<span class="sd">            &gt;&gt;&gt; # Serialize</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;\n\nRaw ChipMatch2 JSON:\n&#39;)</span>
<span class="sd">            &gt;&gt;&gt; json_str = cm.to_json()</span>
<span class="sd">            &gt;&gt;&gt; print(json_str)</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;\n\nPretty ChipMatch2 JSON:\n&#39;)</span>
<span class="sd">            &gt;&gt;&gt; # Pretty String Formatting</span>
<span class="sd">            &gt;&gt;&gt; dictrep = ut.from_json(json_str)</span>
<span class="sd">            &gt;&gt;&gt; dictrep = ut.delete_dict_keys(dictrep, [key for key, val in dictrep.items() if val is None])</span>
<span class="sd">            &gt;&gt;&gt; result  = ut.dict_str(dictrep, nl=2, precision=2, hack_liststr=True, key_order_metric=&#39;strlen&#39;)</span>
<span class="sd">            &gt;&gt;&gt; result = result.replace(&#39;u\&#39;&#39;, &#39;&quot;&#39;).replace(&#39;\&#39;&#39;, &#39;&quot;&#39;)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; # test to convert back and forth from json</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; cm, qreq_ = ibeis.testdata_cm()</span>
<span class="sd">            &gt;&gt;&gt; cm1 = cm</span>
<span class="sd">            &gt;&gt;&gt; # Serialize</span>
<span class="sd">            &gt;&gt;&gt; json_str = cm.to_json()</span>
<span class="sd">            &gt;&gt;&gt; print(repr(json_str))</span>
<span class="sd">            &gt;&gt;&gt; # Unserialize</span>
<span class="sd">            &gt;&gt;&gt; cm = ChipMatch2.from_json(json_str)</span>
<span class="sd">            &gt;&gt;&gt; # Show if it works</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; cm.score_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; cm.show_single_namematch(qreq_, 1)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">            &gt;&gt;&gt; # result = (&#39;json_str = \n%s&#39; % (str(json_str),))</span>
<span class="sd">            &gt;&gt;&gt; # print(result)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json_str</span>
</div>
<div class="viewcode-block" id="ChipMatch2.as_dict"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cm</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ChipMatch2.as_simple_dict"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.as_simple_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_simple_dict</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">()</span>
        <span class="n">simple_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_subset</span><span class="p">(</span><span class="n">state_dict</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;qaid&#39;</span><span class="p">,</span> <span class="s">&#39;daid_list&#39;</span><span class="p">,</span> <span class="s">&#39;score_list&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">simple_dict</span>
</div>
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">__dict__</span>
        <span class="k">return</span> <span class="n">state_dict</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">):</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>

    <span class="c"># --- IO</span>

<div class="viewcode-block" id="ChipMatch2.get_fpath"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_fpath">[docs]</a>    <span class="k">def</span> <span class="nf">get_fpath</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">get_qresdir</span><span class="p">()</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">get_chipmatch_fname</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">)</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fpath</span>
</div>
<div class="viewcode-block" id="ChipMatch2.save"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_fpath</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">save_to_fpath</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ChipMatch2.save_to_fpath"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.save_to_fpath">[docs]</a>    <span class="k">def</span> <span class="nf">save_to_fpath</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --exec-ChipMatch2.save_to_fpath --verbtest --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; qaid = 18</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_pre_sver(&#39;PZ_MTEST&#39;, qaid_list=[qaid])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; dpath = ut.get_app_resource_dir(&#39;ibeis&#39;)</span>
<span class="sd">            &gt;&gt;&gt; fpath = join(dpath, &#39;tmp_chipmatch.cPkl&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ut.delete(fpath)</span>
<span class="sd">            &gt;&gt;&gt; cm.save_to_fpath(fpath)</span>
<span class="sd">            &gt;&gt;&gt; cm2 = ChipMatch2.load_from_fpath(fpath)</span>
<span class="sd">            &gt;&gt;&gt; assert cm == cm2</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; cm.ishow_analysis(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#ut.save_data(fpath, cm.__getstate__(), verbose=verbose)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_cPkl</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">(),</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ChipMatch2.load"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">get_chipmatch_fname</span><span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dpath</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dpath</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">get_qresdir</span><span class="p">()</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">load_from_fpath</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cm</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ChipMatch2.load_from_fpath"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.load_from_fpath">[docs]</a>    <span class="k">def</span> <span class="nf">load_from_fpath</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c">#state_dict = ut.load_data(fpath, verbose=verbose)</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_cPkl</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">cls</span><span class="p">()</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cm</span>

    <span class="c"># ---</span>
</div>
<div class="viewcode-block" id="ChipMatch2.compress_feature_matches"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.compress_feature_matches">[docs]</a>    <span class="k">def</span> <span class="nf">compress_feature_matches</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="p">,</span> <span class="n">use_random</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes all but the best feature matches for testing purposes</span>
<span class="sd">        rng = np.random.RandomState(0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#num = 10</span>
        <span class="n">fs_list</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_fsv_prod_list</span><span class="p">()</span>
        <span class="n">score_sortx</span> <span class="o">=</span> <span class="p">[</span><span class="n">fs</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">fs</span> <span class="ow">in</span> <span class="n">fs_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">use_random</span><span class="p">:</span>
            <span class="c"># keep jagedness</span>
            <span class="n">score_sortx_filt</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">sortx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">num</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">num</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sortx</span><span class="p">))]</span>
                <span class="k">for</span> <span class="n">sortx</span> <span class="ow">in</span> <span class="n">score_sortx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score_sortx_filt</span> <span class="o">=</span> <span class="p">[</span><span class="n">sortx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sortx</span><span class="p">))]</span>
                                <span class="k">for</span> <span class="n">sortx</span> <span class="ow">in</span> <span class="n">score_sortx</span><span class="p">]</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">score_sortx_filt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">score_sortx_filt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span><span class="p">,</span> <span class="n">score_sortx_filt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span><span class="p">,</span> <span class="n">score_sortx_filt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># Override eequality</span>
</div>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">__class__</span><span class="p">):</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">flag</span> <span class="o">&amp;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">fm_list</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">check_arrs_eq</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">arr1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">arr2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">True</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr2</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
            <span class="n">flag</span> <span class="o">&amp;=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">qaid</span>
            <span class="n">flag</span> <span class="o">&amp;=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">qnid</span>
            <span class="n">flag</span> <span class="o">&amp;=</span> <span class="n">check_arrs_eq</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">fm_list</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">&amp;=</span> <span class="n">check_arrs_eq</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">fs_list</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">&amp;=</span> <span class="n">check_arrs_eq</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">fk_list</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">flag</span>
            <span class="c">#return cm.__dict__ == other.__dict__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="c">#------------------</span>
    <span class="c"># Getter Functions</span>
    <span class="c">#------------------</span>

<div class="viewcode-block" id="ChipMatch2.get_num_feat_score_cols"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_num_feat_score_cols">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_feat_score_cols</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_fs"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_fs">[docs]</a>    <span class="k">def</span> <span class="nf">get_fs</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">colx</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">daid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">xor</span><span class="p">(</span><span class="n">idx</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="n">daid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">xor</span><span class="p">(</span><span class="n">colx</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">col</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">daid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">[</span><span class="n">daid</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">colx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">colx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">fs</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_fsv_prod_list"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_fsv_prod_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_fsv_prod_list</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">fsv</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">fsv</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_annot_fm"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_annot_fm">[docs]</a>    <span class="k">def</span> <span class="nf">get_annot_fm</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">daid</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">,</span> <span class="n">daid</span><span class="p">)</span>
        <span class="n">fm</span>  <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fm</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_fs_list"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_fs_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_fs_list</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">colx</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">xor</span><span class="p">(</span><span class="n">colx</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="n">col</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">colx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">fs_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fsv</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">colx</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">fsv</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">fs_list</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_groundtruth_flags"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_groundtruth_flags">[docs]</a>    <span class="k">def</span> <span class="nf">get_groundtruth_flags</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;run cm.evaluate_dnids&#39;</span>
        <span class="n">gt_flags</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">==</span> <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span>
        <span class="k">return</span> <span class="n">gt_flags</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_groundtruth_daids"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_groundtruth_daids">[docs]</a>    <span class="k">def</span> <span class="nf">get_groundtruth_daids</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">gt_flags</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_groundtruth_flags</span><span class="p">()</span>
        <span class="n">gt_daids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_compress_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">gt_flags</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gt_daids</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_nid_scores"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_nid_scores">[docs]</a>    <span class="k">def</span> <span class="nf">get_nid_scores</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
        <span class="n">nidx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>
        <span class="n">name_scores</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="p">,</span> <span class="n">nidx_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name_scores</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_ranked_nids"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_ranked_nids">[docs]</a>    <span class="k">def</span> <span class="nf">get_ranked_nids</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sorted_name_scores</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sorted_nids</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sorted_nids</span><span class="p">,</span> <span class="n">sorted_name_scores</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_ranked_nids_and_aids"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_ranked_nids_and_aids">[docs]</a>    <span class="k">def</span> <span class="nf">get_ranked_nids_and_aids</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Hacky func &quot;&quot;&quot;</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sorted_name_scores</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sorted_nids</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sorted_groupxs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">sorted_daids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span>  <span class="n">sorted_groupxs</span><span class="p">)</span>
        <span class="n">sorted_annot_scores</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="p">,</span>  <span class="n">sorted_groupxs</span><span class="p">)</span>
        <span class="c"># do subsorting</span>
        <span class="n">subsortx_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">scores</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">sorted_annot_scores</span><span class="p">]</span>
        <span class="n">subsorted_daids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">sorted_daids</span><span class="p">,</span> <span class="n">subsortx_list</span><span class="p">)</span>
        <span class="n">subsorted_annot_scores</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">sorted_annot_scores</span><span class="p">,</span> <span class="n">subsortx_list</span><span class="p">)</span>
        <span class="n">nscoretup</span> <span class="o">=</span> <span class="n">name_scoring</span><span class="o">.</span><span class="n">NameScoreTup</span><span class="p">(</span><span class="n">sorted_nids</span><span class="p">,</span> <span class="n">sorted_name_scores</span><span class="p">,</span>
                                              <span class="n">subsorted_daids</span><span class="p">,</span>
                                              <span class="n">subsorted_annot_scores</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nscoretup</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_num_matches_list"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_num_matches_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_matches_list</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">num_matches_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">num_matches_list</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_name_shortlist_aids"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_name_shortlist_aids">[docs]</a>    <span class="k">def</span> <span class="nf">get_name_shortlist_aids</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">nNameShortList</span><span class="p">,</span> <span class="n">nAnnotPerName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_pre_sver(&#39;PZ_MTEST&#39;, qaid_list=[18])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; top_daids = cm.get_name_shortlist_aids(5, 2)</span>
<span class="sd">            &gt;&gt;&gt; assert cm.qnid in ibs.get_annot_name_rowids(top_daids)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">top_daids</span> <span class="o">=</span> <span class="n">scoring</span><span class="o">.</span><span class="n">get_name_shortlist_aids</span><span class="p">(</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="p">,</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">,</span> <span class="n">nNameShortList</span><span class="p">,</span> <span class="n">nAnnotPerName</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">top_daids</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_chip_shortlist_aids"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_chip_shortlist_aids">[docs]</a>    <span class="k">def</span> <span class="nf">get_chip_shortlist_aids</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">num_shortlist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_pre_sver(&#39;PZ_MTEST&#39;, qaid_list=[18])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; top_daids = cm.get_chip_shortlist_aids(5 * 2)</span>
<span class="sd">            &gt;&gt;&gt; assert cm.qnid in ibs.get_annot_name_rowids(top_daids)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">topx</span> <span class="o">=</span> <span class="n">sortx</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="n">num_shortlist</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sortx</span><span class="p">))]</span>
        <span class="n">top_daids</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">[</span><span class="n">topx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">top_daids</span>
</div>
<div class="viewcode-block" id="ChipMatch2.argsort"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.argsort">[docs]</a>    <span class="k">def</span> <span class="nf">argsort</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="c">#if cm.score_list is None:</span>
        <span class="c">#    num_matches_list = cm.get_num_matches_list()</span>
        <span class="c">#    sortx = ut.list_argsort(num_matches_list, reverse=True)</span>
        <span class="c">#else:</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_argsort</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sortx</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ChipMatch2.name_argsort"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.name_argsort">[docs]</a>    <span class="k">def</span> <span class="nf">name_argsort</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_argsort</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ranks</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sortx</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unique_name_ranks</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_argsort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sortx</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>

    <span class="c">#+=================</span>
    <span class="c"># Score Aggregation Functions</span>
    <span class="c">#------------------</span>

    <span class="c"># Cannonical Setters</span>

    <span class="nd">@profile</span>
<div class="viewcode-block" id="ChipMatch2.set_cannonical_annot_score"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.set_cannonical_annot_score">[docs]</a>    <span class="k">def</span> <span class="nf">set_cannonical_annot_score</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot_score_list</span><span class="p">):</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span> <span class="o">=</span> <span class="n">annot_score_list</span>
        <span class="c">#cm.name_score_list  = None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span>       <span class="o">=</span> <span class="n">annot_score_list</span>
</div>
    <span class="nd">@profile</span>
<div class="viewcode-block" id="ChipMatch2.set_cannonical_name_score"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.set_cannonical_name_score">[docs]</a>    <span class="k">def</span> <span class="nf">set_cannonical_name_score</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot_score_list</span><span class="p">,</span> <span class="n">name_score_list</span><span class="p">):</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span> <span class="o">=</span> <span class="n">annot_score_list</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span>  <span class="o">=</span> <span class="n">name_score_list</span>
        <span class="c"># align with score_list</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="o">=</span> <span class="n">name_scoring</span><span class="o">.</span><span class="n">align_name_scores_with_annots</span><span class="p">(</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span><span class="p">,</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="p">)</span>

    <span class="c"># --- ChipSum Score</span>
</div>
    <span class="nd">@profile</span>
<div class="viewcode-block" id="ChipMatch2.evaluate_csum_score"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.evaluate_csum_score">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_csum_score</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="n">csum_score_list</span> <span class="o">=</span> <span class="n">scoring</span><span class="o">.</span><span class="n">compute_csum_score</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">csum_score_list</span> <span class="o">=</span> <span class="n">csum_score_list</span>
</div>
    <span class="nd">@profile</span>
<div class="viewcode-block" id="ChipMatch2.score_csum"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.score_csum">[docs]</a>    <span class="k">def</span> <span class="nf">score_csum</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --test-score_csum --show</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --test-score_csum --show --qaid 18</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_post_sver()</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_csum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; cm.show_ranked_matches(qreq_, figtitle=&#39;score_csum&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_csum_score</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">set_cannonical_annot_score</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">csum_score_list</span><span class="p">)</span>

    <span class="c"># --- MaxChipSum Score</span>
</div>
    <span class="nd">@profile</span>
<div class="viewcode-block" id="ChipMatch2.score_maxcsum"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.score_maxcsum">[docs]</a>    <span class="k">def</span> <span class="nf">score_maxcsum</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_dnids</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">score_csum</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">maxcsum_score_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">csum_score_list</span><span class="p">,</span>
                                            <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">set_cannonical_name_score</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">csum_score_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">maxcsum_score_list</span><span class="p">)</span>

    <span class="c"># --- NameSum Score</span>
</div>
    <span class="nd">@profile</span>
<div class="viewcode-block" id="ChipMatch2.evaluate_nsum_score"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.evaluate_nsum_score">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_nsum_score</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_dnids</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">)</span>
        <span class="n">nsum_nid_list</span><span class="p">,</span> <span class="n">nsum_score_list</span> <span class="o">=</span> <span class="n">name_scoring</span><span class="o">.</span><span class="n">compute_nsum_score</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="o">==</span> <span class="n">nsum_nid_list</span><span class="p">),</span> <span class="s">&#39;name score not in alignment&#39;</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">nsum_score_list</span> <span class="o">=</span> <span class="n">nsum_score_list</span>
</div>
    <span class="nd">@profile</span>
<div class="viewcode-block" id="ChipMatch2.score_nsum"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.score_nsum">[docs]</a>    <span class="k">def</span> <span class="nf">score_nsum</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --test-score_nsum --show --qaid 1</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --test-score_nsum --show --qaid 18</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_post_sver(&#39;PZ_MTEST&#39;, qaid_list=[18])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; gt_score = cm.score_list.compress(cm.get_groundtruth_flags()).max()</span>
<span class="sd">            &gt;&gt;&gt; cm.print_csv()</span>
<span class="sd">            &gt;&gt;&gt; assert cm.get_top_nids()[0] == cm.unique_nids[cm.name_score_list.argmax()], &#39;bug in alignment&#39;</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; cm.show_ranked_matches(qreq_, figtitle=&#39;score_nsum&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">            &gt;&gt;&gt; assert cm.get_top_nids()[0] == cm.qnid, &#39;is this case truely hard?&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_csum_score</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_nsum_score</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">set_cannonical_name_score</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">csum_score_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">nsum_score_list</span><span class="p">)</span>

    <span class="c"># --- ChipCoverage Score</span>
</div>
    <span class="nd">@profile</span>
<div class="viewcode-block" id="ChipMatch2.evaluate_acov_score"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.evaluate_acov_score">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_acov_score</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="n">daid_list</span><span class="p">,</span> <span class="n">acov_score_list</span> <span class="o">=</span> <span class="n">scoring</span><span class="o">.</span><span class="n">compute_annot_coverage_score</span><span class="p">(</span>
            <span class="n">qreq_</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">qparams</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">daid_list</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)),</span> <span class="s">&#39;daids out of alignment&#39;</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">acov_score_list</span> <span class="o">=</span> <span class="n">acov_score_list</span>
</div>
    <span class="nd">@profile</span>
<div class="viewcode-block" id="ChipMatch2.score_annot_coverage"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.score_annot_coverage">[docs]</a>    <span class="k">def</span> <span class="nf">score_annot_coverage</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --test-score_annot_coverage --show</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --test-score_annot_coverage --show --qaid 18</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_post_sver()</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.fs_list = cm.get_fs_list(col=&#39;lnbnn&#39;)</span>
<span class="sd">            &gt;&gt;&gt; cm.score_annot_coverage(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; cm.show_ranked_matches(qreq_, figtitle=&#39;score_annot_coverage&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_acov_score</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">set_cannonical_annot_score</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">acov_score_list</span><span class="p">)</span>

    <span class="c"># --- NameCoverage Score</span>
</div>
    <span class="nd">@profile</span>
<div class="viewcode-block" id="ChipMatch2.evaluate_ncov_score"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.evaluate_ncov_score">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_ncov_score</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_dnids</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">)</span>
        <span class="n">ncov_nid_list</span><span class="p">,</span> <span class="n">ncov_score_list</span> <span class="o">=</span> <span class="n">scoring</span><span class="o">.</span><span class="n">compute_name_coverage_score</span><span class="p">(</span>
            <span class="n">qreq_</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">qparams</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="o">==</span> <span class="n">ncov_nid_list</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">ncov_score_list</span> <span class="o">=</span> <span class="n">ncov_score_list</span>
</div>
    <span class="nd">@profile</span>
<div class="viewcode-block" id="ChipMatch2.score_name_coverage"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.score_name_coverage">[docs]</a>    <span class="k">def</span> <span class="nf">score_name_coverage</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --test-score_name_coverage --show</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --test-score_name_coverage --show --qaid 18</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_post_sver()</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.fs_list = cm.get_fs_list(col=&#39;lnbnn&#39;)</span>
<span class="sd">            &gt;&gt;&gt; cm.score_name_coverage(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; cm.show_ranked_matches(qreq_, figtitle=&#39;score_name_coverage&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">csum_score_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_csum_score</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_ncov_score</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">set_cannonical_name_score</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">csum_score_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">ncov_score_list</span><span class="p">)</span>

    <span class="c">#------------------</span>
    <span class="c"># Result Functions</span>
    <span class="c">#------------------</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_top_scores"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_top_scores">[docs]</a>    <span class="k">def</span> <span class="nf">get_top_scores</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ntop</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_top_scores</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">top_scores</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">_top_scores</span><span class="p">,</span> <span class="n">ntop</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">top_scores</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_top_nids"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_top_nids">[docs]</a>    <span class="k">def</span> <span class="nf">get_top_nids</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ntop</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_top_nids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">top_nids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">_top_nids</span><span class="p">,</span> <span class="n">ntop</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">top_nids</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_top_aids"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_top_aids">[docs]</a>    <span class="k">def</span> <span class="nf">get_top_aids</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ntop</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_top_aids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">top_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">_top_aids</span><span class="p">,</span> <span class="n">ntop</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">top_aids</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_top_truth_aids"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_top_truth_aids">[docs]</a>    <span class="k">def</span> <span class="nf">get_top_truth_aids</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ibs</span><span class="p">,</span> <span class="n">truth</span><span class="p">,</span> <span class="n">ntop</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_top_aids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">truth_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_aidpair_truths</span><span class="p">([</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">_top_aids</span><span class="p">),</span> <span class="n">_top_aids</span><span class="p">)</span>
        <span class="n">flag_list</span> <span class="o">=</span> <span class="n">truth_list</span> <span class="o">==</span> <span class="n">truth</span>
        <span class="n">_top_aids</span> <span class="o">=</span> <span class="n">_top_aids</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flag_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">top_truth_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">_top_aids</span><span class="p">,</span> <span class="n">ntop</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">top_truth_aids</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_top_gf_aids"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_top_gf_aids">[docs]</a>    <span class="k">def</span> <span class="nf">get_top_gf_aids</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ibs</span><span class="p">,</span> <span class="n">ntop</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">ibeis</span>
        <span class="k">return</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_top_truth_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">TRUTH_NOT_MATCH</span><span class="p">,</span> <span class="n">ntop</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_top_gt_aids"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_top_gt_aids">[docs]</a>    <span class="k">def</span> <span class="nf">get_top_gt_aids</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ibs</span><span class="p">,</span> <span class="n">ntop</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">ibeis</span>
        <span class="k">return</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_top_truth_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">TRUTH_MATCH</span><span class="p">,</span> <span class="n">ntop</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_annot_scores"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_annot_scores">[docs]</a>    <span class="k">def</span> <span class="nf">get_annot_scores</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">score_method</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c">#idx_list = [cm.daid2_idx.get(daid, None) for daid in daids]</span>
        <span class="n">score_list</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span>
        <span class="n">idx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">score_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">score_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">score_list</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_annot_ranks"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_annot_ranks">[docs]</a>    <span class="k">def</span> <span class="nf">get_annot_ranks</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">daids</span><span class="p">):</span>  <span class="c"># score_method=None):</span>
        <span class="n">score_ranks</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">idx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">rank_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">score_ranks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">rank_list</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_name_ranks"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_name_ranks">[docs]</a>    <span class="k">def</span> <span class="nf">get_name_ranks</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">dnids</span><span class="p">):</span>  <span class="c"># score_method=None):</span>
        <span class="n">score_ranks</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">idx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">,</span> <span class="n">dnids</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">rank_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">score_ranks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">rank_list</span>

    <span class="c">#------------------</span>
    <span class="c"># String Functions</span>
    <span class="c">#------------------</span>
</div>
<div class="viewcode-block" id="ChipMatch2.print_inspect_str"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.print_inspect_str">[docs]</a>    <span class="k">def</span> <span class="nf">print_inspect_str</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">get_inspect_str</span><span class="p">(</span><span class="n">qreq_</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_inspect_str"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_inspect_str">[docs]</a>    <span class="k">def</span> <span class="nf">get_inspect_str</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            qreq_ (QueryRequest):  query request object with hyper-parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: varinfo</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --exec-get_inspect_str</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; cm, qreq_ = ibeis.testdata_cm()</span>
<span class="sd">            &gt;&gt;&gt; varinfo = cm.get_inspect_str(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;varinfo = %s&#39; % (str(varinfo),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">assert_self</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="c">#ut.embed()</span>

        <span class="n">top_lbls</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; top aids&#39;</span><span class="p">,</span> <span class="s">&#39; scores&#39;</span><span class="p">,</span> <span class="s">&#39; ranks&#39;</span><span class="p">]</span>

        <span class="n">ibs</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span>

        <span class="n">top_aids</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">get_top_aids</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">top_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">get_annot_scores</span><span class="p">(</span><span class="n">top_aids</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="c">#top_rawscores = np.array(cm.get_aid_scores(top_aids, rawscore=True), dtype=np.float64)</span>
        <span class="n">top_ranks</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_aids</span><span class="p">))</span>
        <span class="n">top_list</span>   <span class="o">=</span> <span class="p">[</span><span class="n">top_aids</span><span class="p">,</span> <span class="n">top_scores</span><span class="p">,</span> <span class="n">top_ranks</span><span class="p">]</span>

        <span class="n">top_lbls</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39; isgt&#39;</span><span class="p">]</span>
        <span class="n">istrue</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_aidpair_truths</span><span class="p">([</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_aids</span><span class="p">),</span> <span class="n">top_aids</span><span class="p">)</span>
        <span class="n">top_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">istrue</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>

        <span class="n">top_lbls</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;top nid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">top_lbls</span>
        <span class="n">top_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">top_aids</span><span class="p">)]</span> <span class="o">+</span> <span class="n">top_list</span>

        <span class="n">top_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">top_list</span><span class="p">)</span>
        <span class="c">#top_stack = np.array(top_stack, dtype=object)</span>
        <span class="n">top_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">top_stack</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="c">#np.int32)</span>
        <span class="n">top_str</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_str</span><span class="p">(</span><span class="n">top_stack</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">suppress_small</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_line_width</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="n">top_lbl</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">top_lbls</span><span class="p">)</span>
        <span class="n">inspect_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;QueryResult&#39;</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">get_cfgstr</span><span class="p">(),</span> <span class="p">]</span>
        <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">gt_aids</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_top_gt_aids</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">)</span>
            <span class="n">gt_ranks</span>  <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_annot_ranks</span><span class="p">(</span><span class="n">gt_aids</span><span class="p">)</span>
            <span class="n">gt_scores</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_annot_scores</span><span class="p">(</span><span class="n">gt_aids</span><span class="p">)</span>
            <span class="n">inspect_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;len(cm.daid_list) = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">))</span>
            <span class="n">inspect_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;len(cm.unique_nids) = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">))</span>
            <span class="n">inspect_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;gt_ranks = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">gt_ranks</span><span class="p">)</span>
            <span class="n">inspect_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;gt_aids = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">gt_aids</span><span class="p">)</span>
            <span class="n">inspect_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;gt_scores = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">gt_scores</span><span class="p">)</span>

        <span class="n">inspect_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="s">&#39;qaid=</span><span class="si">%r</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,</span>
            <span class="s">&#39;qnid=</span><span class="si">%r</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span><span class="p">,</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">hz_str</span><span class="p">(</span><span class="n">top_lbl</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">top_str</span><span class="p">),</span>
            <span class="c">#&#39;num feat matches per annotation stats:&#39;,</span>
            <span class="c">#ut.indent(ut.dict_str(nFeatMatch_stats)),</span>
            <span class="c">#ut.indent(nFeatMatch_stats_str),</span>
        <span class="p">])</span>

        <span class="n">inspect_str</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inspect_list</span><span class="p">)</span>

        <span class="c">#inspect_str = ut.indent(inspect_str, &#39;[INSPECT] &#39;)</span>
        <span class="k">return</span> <span class="n">inspect_str</span>
</div>
<div class="viewcode-block" id="ChipMatch2.print_rawinfostr"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.print_rawinfostr">[docs]</a>    <span class="k">def</span> <span class="nf">print_rawinfostr</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">get_rawinfostr</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="ChipMatch2.print_csv"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.print_csv">[docs]</a>    <span class="k">def</span> <span class="nf">print_csv</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cvs_str</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_rawinfostr"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_rawinfostr">[docs]</a>    <span class="k">def</span> <span class="nf">get_rawinfostr</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">varinfo</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">onlyrepr</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">canshowrepr</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
            <span class="n">varval</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">varname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;cm.&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
            <span class="n">show_if_smaller_than</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="k">if</span> <span class="n">canshowrepr</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">varval</span><span class="p">,</span> <span class="s">&#39;size&#39;</span><span class="p">):</span>
                    <span class="n">show_repr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">(</span><span class="n">varval</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">varval</span><span class="p">,</span> <span class="s">&#39;size&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">show_if_smaller_than</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">show_repr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">(</span><span class="n">varval</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">varval</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">show_if_smaller_than</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">show_repr</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">varinfo_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">print_summary</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">onlyrepr</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">(</span><span class="n">varval</span><span class="p">)</span>
            <span class="n">show_repr</span> <span class="o">=</span> <span class="n">show_repr</span> <span class="ow">or</span> <span class="p">(</span><span class="n">onlyrepr</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">print_summary</span><span class="p">)</span>
            <span class="n">symbol</span> <span class="o">=</span> <span class="s">&#39;*&#39;</span>
            <span class="k">if</span> <span class="n">show_repr</span><span class="p">:</span>
                <span class="n">varinfo_list</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;    * </span><span class="si">%s</span><span class="s"> = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">varval</span><span class="p">)]</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span>
            <span class="k">if</span> <span class="n">print_summary</span><span class="p">:</span>
                <span class="n">varinfo_list</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="s">&#39;    </span><span class="si">%s</span><span class="s"> varinfo(</span><span class="si">%s</span><span class="s">):&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">varname</span><span class="p">,),</span>
                    <span class="s">&#39;        depth = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">depth_profile</span><span class="p">(</span><span class="n">varval</span><span class="p">),),</span>
                    <span class="s">&#39;        types = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_type_profile</span><span class="p">(</span><span class="n">varval</span><span class="p">),),</span>
                <span class="p">]</span>
                <span class="c">#varinfo = &#39;\n&#39;.join(ut.align_lines(varinfo_list, &#39;=&#39;))</span>
            <span class="n">varinfo</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">align_lines</span><span class="p">(</span><span class="n">varinfo_list</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">varinfo</span>
        <span class="n">str_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">append</span> <span class="o">=</span> <span class="n">str_list</span><span class="o">.</span><span class="n">append</span>
        <span class="n">append</span><span class="p">(</span><span class="s">&#39;ChipMatch2:&#39;</span><span class="p">)</span>
        <span class="n">append</span><span class="p">(</span><span class="s">&#39;    * cm.qaid = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,))</span>
        <span class="n">append</span><span class="p">(</span><span class="s">&#39;    * cm.qnid = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">qnid</span><span class="p">,))</span>
        <span class="c">#append(&#39;    * len(cm.daid2_idx) = %r&#39; % (len(cm.daid2_idx),))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.daid2_idx&#39;</span><span class="p">))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.fsv_col_lbls&#39;</span><span class="p">,</span> <span class="n">onlyrepr</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.daid_list&#39;</span><span class="p">))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.dnid_list&#39;</span><span class="p">))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.fs_list&#39;</span><span class="p">))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.fm_list&#39;</span><span class="p">))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.fk_list&#39;</span><span class="p">))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.fsv_list&#39;</span><span class="p">))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.H_list&#39;</span><span class="p">,</span> <span class="n">canshowrepr</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.score_list&#39;</span><span class="p">))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.annot_score_list&#39;</span><span class="p">))</span>
        <span class="c">#</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.csum_score_list&#39;</span><span class="p">))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.acov_score_list&#39;</span><span class="p">))</span>
        <span class="c">#</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.unique_nids&#39;</span><span class="p">))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.nid2_nidx&#39;</span><span class="p">))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.name_score_list&#39;</span><span class="p">))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.nsum_score_list&#39;</span><span class="p">))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="s">&#39;cm.ncov_score_list&#39;</span><span class="p">))</span>
        <span class="c">#append(varinfo(&#39;cm.annot_score_dict[\&#39;csum\&#39;]&#39;))</span>
        <span class="c">#append(varinfo(&#39;cm.annot_score_dict[\&#39;acov\&#39;]&#39;))</span>
        <span class="c">#append(varinfo(&#39;cm.name_score_dict[\&#39;nsum\&#39;]&#39;))</span>
        <span class="c">#append(varinfo(&#39;cm.name_score_dict[\&#39;ncov\&#39;]&#39;))</span>
        <span class="c">#infostr = &#39;\n&#39;.join(ut.align_lines(str_list, &#39;=&#39;))</span>
        <span class="n">infostr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">infostr</span>
</div>
<div class="viewcode-block" id="ChipMatch2.get_cvs_str"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.get_cvs_str">[docs]</a>    <span class="k">def</span> <span class="nf">get_cvs_str</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span>  <span class="n">numtop</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            numtop (int): (default = 6)</span>
<span class="sd">            ibs (IBEISController):  ibeis controller object(default = None)</span>
<span class="sd">            sort (bool): (default = True)</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: csv_str</span>

<span class="sd">        Notes:</span>
<span class="sd">            Very weird that it got a score</span>
<span class="sd">            qaid 6 vs 41 has</span>
<span class="sd">                [72, 79, 0, 17, 6, 60, 15, 36, 63]</span>
<span class="sd">                [72, 79, 0, 17, 6, 60, 15, 36, 63]</span>
<span class="sd">                [72, 79, 0, 17, 6, 60, 15, 36, 63]</span>
<span class="sd">                [0.060, 0.053, 0.0497, 0.040, 0.016, 0, 0, 0, 0]</span>
<span class="sd">                [7, 40, 41, 86, 103, 88, 8, 101, 35]</span>
<span class="sd">            makes very little sense</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --test-get_cvs_str --force-serial</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_post_sver()</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; numtop = 6</span>
<span class="sd">            &gt;&gt;&gt; ibs = None</span>
<span class="sd">            &gt;&gt;&gt; sort = True</span>
<span class="sd">            &gt;&gt;&gt; csv_str = cm.get_cvs_str(numtop, ibs, sort)</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;csv_str = \n%s&#39; % (str(csv_str),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sort</span> <span class="ow">or</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: cm.score_list is None and sort is True&#39;</span><span class="p">)</span>
            <span class="n">sortx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sortx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_argsort</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">qnid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">)</span>
            <span class="n">dnid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qnid</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span>
            <span class="n">dnid_list</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span>
        <span class="c"># Build columns for the csv, filtering out unavailable information</span>
        <span class="n">column_lbls_</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;daid&#39;</span><span class="p">,</span> <span class="s">&#39;dnid&#39;</span><span class="p">,</span> <span class="s">&#39;score&#39;</span><span class="p">,</span> <span class="s">&#39;num_matches&#39;</span><span class="p">,</span> <span class="s">&#39;annot_scores&#39;</span><span class="p">,</span>
                        <span class="s">&#39;fm_depth&#39;</span><span class="p">,</span> <span class="s">&#39;fsv_depth&#39;</span><span class="p">]</span>
        <span class="n">column_list_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span>  <span class="n">sortx</span><span class="p">),</span>
            <span class="bp">None</span> <span class="k">if</span> <span class="n">dnid_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">),</span>
            <span class="bp">None</span> <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">),</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">get_num_matches_list</span><span class="p">(),</span> <span class="n">sortx</span><span class="p">),</span>
            <span class="bp">None</span> <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">),</span>
            <span class="c">#None if cm.name_score_list is None else vt.list_take_(cm.name_score_list, sortx),</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">depth_profile</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span>  <span class="n">sortx</span><span class="p">))),</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">depth_profile</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">))),</span>
        <span class="p">]</span>
        <span class="n">isnone_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_None_items</span><span class="p">(</span><span class="n">column_list_</span><span class="p">)</span>
        <span class="n">column_lbls</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">column_lbls_</span><span class="p">,</span> <span class="n">isnone_list</span><span class="p">)</span>
        <span class="n">column_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">column_list_</span><span class="p">,</span> <span class="n">isnone_list</span><span class="p">)</span>
        <span class="c"># Clip to the top results</span>
        <span class="k">if</span> <span class="n">numtop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">column_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">numtop</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">]</span>
        <span class="c"># hard case for python text parsing</span>
        <span class="c"># better know about quoted hash symbols</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">codeblock</span><span class="p">(</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            # qaid = {qaid}</span>
<span class="sd">            # qnid = {qnid}</span>
<span class="sd">            # fsv_col_lbls = {fsv_col_lbls}</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qaid</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,</span> <span class="n">qnid</span><span class="o">=</span><span class="n">qnid</span><span class="p">,</span> <span class="n">fsv_col_lbls</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span><span class="p">)</span>

        <span class="n">csv_str</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_csv_table</span><span class="p">(</span><span class="n">column_list</span><span class="p">,</span> <span class="n">column_lbls</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">comma_repl</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">csv_str</span>

    <span class="c">#------------------</span>
    <span class="c"># Testing Functions</span>
    <span class="c">#------------------</span>
</div>
<div class="viewcode-block" id="ChipMatch2.assert_self"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.assert_self">[docs]</a>    <span class="k">def</span> <span class="nf">assert_self</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">NOT_QUIET</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;must have qaid&#39;</span>
        <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;must give daids&#39;</span>
        <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">),</span> <span class="s">&#39;incompatable data&#39;</span>
        <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">),</span> <span class="s">&#39;incompatable data&#39;</span>
        <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">),</span> <span class="s">&#39;incompatable data&#39;</span>
        <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">H_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">),</span> <span class="s">&#39;incompatable data&#39;</span>
        <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">),</span> <span class="s">&#39;incompatable data&#39;</span>
        <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">),</span> <span class="s">&#39;incompatable data&#39;</span>

        <span class="k">class</span> <span class="nc">TestLogger</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">testlog</span><span class="p">):</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">test_out</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">failed_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">def</span> <span class="nf">start_test</span><span class="p">(</span><span class="n">testlog</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span> <span class="o">=</span> <span class="n">name</span>

            <span class="k">def</span> <span class="nf">log_skipped</span><span class="p">(</span><span class="n">testlog</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[cm] skip: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">log_passed</span><span class="p">(</span><span class="n">testlog</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[cm] pass: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">skip_test</span><span class="p">(</span><span class="n">testlog</span><span class="p">):</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">log_skipped</span><span class="p">(</span><span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span><span class="p">)</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">def</span> <span class="nf">log_failed</span><span class="p">(</span><span class="n">testlog</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">test_out</span><span class="p">[</span><span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">failed_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[cm] FAILED!: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">end_test</span><span class="p">(</span><span class="n">testlog</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">testlog</span><span class="o">.</span><span class="n">test_out</span><span class="p">[</span><span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">testlog</span><span class="o">.</span><span class="n">log_passed</span><span class="p">(</span><span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">testlog</span><span class="o">.</span><span class="n">log_failed</span><span class="p">(</span><span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span><span class="p">)</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">def</span> <span class="nf">context</span><span class="p">(</span><span class="n">testlog</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">start_test</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">testlog</span>

            <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="n">testlog</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">testlog</span>

            <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="n">testlog</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">testlog</span><span class="o">.</span><span class="n">end_test</span><span class="p">()</span>

        <span class="n">testlog</span> <span class="o">=</span> <span class="n">TestLogger</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s">&#39;lookup score by daid&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">skip_test</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">daids</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_top_aids</span><span class="p">()</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_top_scores</span><span class="p">()</span>
                <span class="n">scores_</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_annot_scores</span><span class="p">(</span><span class="n">daids</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">scores</span> <span class="o">==</span> <span class="n">scores_</span><span class="p">):</span>
                    <span class="n">testlog</span><span class="o">.</span><span class="n">log_failed</span><span class="p">(</span><span class="s">&#39;score mappings are NOT ok&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s">&#39;dnid_list = name(daid_list&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">strict</span> <span class="ow">or</span> <span class="n">qreq_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">==</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)):</span>
                    <span class="n">testlog</span><span class="o">.</span><span class="n">log_failed</span><span class="p">(</span><span class="s">&#39;annot aligned nids are NOT ok&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">skip_test</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">strict</span> <span class="ow">or</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s">&#39;unique nid mapping&#39;</span><span class="p">):</span>
                <span class="n">nidx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">nidx_list</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nidx_list</span><span class="p">)))</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">[</span><span class="n">nidx_list</span><span class="p">]</span> <span class="o">==</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s">&#39;allsame(grouped(dnid_list))&#39;</span><span class="p">):</span>
                <span class="n">grouped_nids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">nids</span> <span class="ow">in</span> <span class="n">grouped_nids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_allsame</span><span class="p">(</span><span class="n">nids</span><span class="p">):</span>
                        <span class="n">testlog</span><span class="o">.</span><span class="n">log_failed</span><span class="p">(</span><span class="s">&#39;internal dnid name grouping is NOT consistent&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s">&#39;allsame(name(grouped(daid_list)))&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">qreq_</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">testlog</span><span class="o">.</span><span class="n">skip_test</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># this might fail if this result is old and the names have changed</span>
                    <span class="n">grouped_aids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span><span class="p">)</span>
                    <span class="n">grouped_mapped_nids</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">,</span> <span class="n">grouped_aids</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">nids</span> <span class="ow">in</span> <span class="n">grouped_mapped_nids</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_allsame</span><span class="p">(</span><span class="n">nids</span><span class="p">):</span>
                            <span class="n">testlog</span><span class="o">.</span><span class="n">log_failed</span><span class="p">(</span><span class="s">&#39;internal daid name grouping is NOT consistent&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s">&#39;dnid_list - unique_nid alignment&#39;</span><span class="p">):</span>
                <span class="n">grouped_nids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">nids</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grouped_nids</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">nids</span> <span class="o">==</span> <span class="n">nid</span><span class="p">):</span>
                        <span class="n">testlog</span><span class="o">.</span><span class="n">log_failed</span><span class="p">(</span>
                            <span class="s">&#39;cm.unique_nids is NOT aligned with &#39;</span>
                            <span class="s">&#39;vt.apply_grouping(cm.dnid_list, cm.name_groupxs). &#39;</span>
                            <span class="s">&#39; nids=</span><span class="si">%r</span><span class="s">, nid=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nids</span><span class="p">,</span> <span class="n">nid</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">break</span>

            <span class="k">if</span> <span class="n">qreq_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">start_test</span><span class="p">(</span><span class="s">&#39;daid_list - unique_nid alignment&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">nids</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grouped_mapped_nids</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">nids</span> <span class="o">==</span> <span class="n">nid</span><span class="p">):</span>
                        <span class="n">testlog</span><span class="o">.</span><span class="n">log_failed</span><span class="p">(</span>
                            <span class="s">&#39;cm.unique_nids is NOT aligned with &#39;</span>
                            <span class="s">&#39;vt.apply_grouping(name(cm.daid_list), cm.name_groupxs). &#39;</span>
                            <span class="s">&#39; name(aids)=</span><span class="si">%r</span><span class="s">, nid=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nids</span><span class="p">,</span> <span class="n">nid</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">break</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">end_test</span><span class="p">()</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">testlog</span><span class="o">.</span><span class="n">failed_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testlog</span><span class="o">.</span><span class="n">failed_list</span><span class="p">)</span>
        <span class="n">testlog</span><span class="o">.</span><span class="n">log_passed</span><span class="p">(</span><span class="s">&#39;lengths are ok&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_all_eq_to</span><span class="p">([</span><span class="n">fsv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">fsv</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">print_rawinfostr</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_all_eq_to</span><span class="p">([</span><span class="n">fm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="s">&#39;bad fm&#39;</span>
        <span class="n">testlog</span><span class="o">.</span><span class="n">log_passed</span><span class="p">(</span><span class="s">&#39;shapes are ok&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">strict</span> <span class="ow">or</span> <span class="n">qreq_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">external_qaids</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">get_external_qaids</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">external_daids</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">get_external_daids</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">qparams</span><span class="o">.</span><span class="n">pipeline_root</span> <span class="o">==</span> <span class="s">&#39;vsone&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">external_qaids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;only one external qaid for vsone&#39;</span>
                <span class="k">if</span> <span class="n">strict</span> <span class="ow">or</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">indexer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">nExternalQVecs</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">(</span>
                        <span class="n">external_qaids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">config2_</span><span class="o">=</span><span class="n">qreq_</span><span class="o">.</span><span class="n">get_external_query_config2</span><span class="p">())</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">indexer</span><span class="o">.</span><span class="n">idx2_vec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nExternalQVecs</span><span class="p">,</span> <span class="p">(</span>
                        <span class="s">&#39;did not index query descriptors properly&#39;</span><span class="p">)</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">log_passed</span><span class="p">(</span><span class="s">&#39;vsone daids are ok are ok&#39;</span><span class="p">)</span>

            <span class="n">nFeats1</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_num_feats</span><span class="p">(</span>
                <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">qreq_</span><span class="o">.</span><span class="n">get_external_query_config2</span><span class="p">())</span>
            <span class="n">nFeats2_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_num_feats</span><span class="p">(</span>
                    <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">qreq_</span><span class="o">.</span><span class="n">get_external_data_config2</span><span class="p">()))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_issubset</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">external_daids</span><span class="p">),</span> <span class="p">(</span>
                    <span class="s">&#39;cmtup_old must be subset of daids&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;daid_list&#39;</span><span class="p">,</span> <span class="s">&#39;external_daids&#39;</span><span class="p">])</span>
                <span class="k">raise</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fm_list</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span>
                <span class="n">fx2s_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm_</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">fm_</span> <span class="ow">in</span> <span class="n">fm_list</span><span class="p">]</span>
                <span class="n">fx1s_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm_</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fm_</span> <span class="ow">in</span> <span class="n">fm_list</span><span class="p">]</span>
                <span class="n">max_fx1_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                    <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fx1s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">fx1s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">fx1s</span> <span class="ow">in</span> <span class="n">fx1s_list</span><span class="p">])</span>
                <span class="n">max_fx2_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                    <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fx2s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">fx2s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">fx2s</span> <span class="ow">in</span> <span class="n">fx2s_list</span><span class="p">])</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">assert_lessthan</span><span class="p">(</span><span class="n">max_fx2_list</span><span class="p">,</span> <span class="n">nFeats2_list</span><span class="p">,</span>
                                   <span class="s">&#39;max feat index must be less than num feats&#39;</span><span class="p">)</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">assert_lessthan</span><span class="p">(</span><span class="n">max_fx1_list</span><span class="p">,</span> <span class="n">nFeats1</span><span class="p">,</span>
                                   <span class="s">&#39;max feat index must be less than num feats&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;qaid&#39;</span><span class="p">,</span> <span class="s">&#39;daid_list&#39;</span><span class="p">,</span> <span class="s">&#39;nFeats1&#39;</span><span class="p">,</span>
                                     <span class="s">&#39;nFeats2_list&#39;</span><span class="p">,</span> <span class="s">&#39;max_fx1_list&#39;</span><span class="p">,</span>
                                     <span class="s">&#39;max_fx2_list&#39;</span><span class="p">,</span> <span class="p">])</span>
                <span class="k">raise</span>
            <span class="n">testlog</span><span class="o">.</span><span class="n">log_passed</span><span class="p">(</span><span class="s">&#39;nFeats are ok in fm&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">testlog</span><span class="o">.</span><span class="n">log_skipped</span><span class="p">(</span><span class="s">&#39;nFeat check&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qreq_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="ChipMatch2.show_single_namematch"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.show_single_namematch">[docs]</a>    <span class="k">def</span> <span class="nf">show_single_namematch</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">dnid</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                              <span class="n">homog</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--homog&#39;</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis --tf ChipMatch2.show_single_namematch --show</span>
<span class="sd">            python -m ibeis --tf ChipMatch2.show_single_namematch --show --qaid 1</span>
<span class="sd">            python -m ibeis --tf ChipMatch2.show_single_namematch --show --qaid 1 --dpath figures --save ~/latex/crall-candidacy-2015/figures/namematch.jpg</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; cm, qreq_ = ibeis.testdata_cm(&#39;PZ_MTEST&#39;, default_qaids=[18])</span>
<span class="sd">            &gt;&gt;&gt; homog = False</span>
<span class="sd">            &gt;&gt;&gt; dnid = cm.qnid</span>
<span class="sd">            &gt;&gt;&gt; cm.show_single_namematch(qreq_, dnid)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ibeis.viz</span> <span class="kn">import</span> <span class="n">viz_matches</span>
        <span class="n">qaid</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span>
        <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;cm.nid2_nidx has not been evaluated yet&#39;</span><span class="p">)</span>
            <span class="c">#cm.score_nsum(qreq_)</span>
        <span class="c"># &lt;GET NAME GROUPXS&gt;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nidx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">[</span><span class="n">dnid</span><span class="p">]</span>
            <span class="c">#if nidx == 144:</span>
            <span class="c">#    raise</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c">#def extend():</span>
                <span class="c">#pass</span>
            <span class="c">#cm.daid_list</span>
            <span class="c">#cm.print_inspect_str(qreq_)</span>
            <span class="c">#cm_orig = cm  # NOQA</span>
            <span class="c">#cm_orig.assert_self(qreq_)</span>
            <span class="c">#other_aids = qreq_.get_external_daids()</span>
            <span class="c"># Hack to get rid of key error</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">assert_self</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">cm2</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">extend_results</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
            <span class="n">cm2</span><span class="o">.</span><span class="n">assert_self</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="n">cm2</span>
            <span class="c">#cm2.assert_self(qreq_)</span>
            <span class="c">#ut.embed()</span>
            <span class="n">nidx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">[</span><span class="n">dnid</span><span class="p">]</span>
            <span class="c">#raise</span>
        <span class="n">groupxs</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span><span class="p">[</span><span class="n">nidx</span><span class="p">]</span>
        <span class="n">daids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">groupxs</span><span class="p">)</span>
        <span class="n">dnids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">groupxs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dnid</span> <span class="o">==</span> <span class="n">dnids</span><span class="p">),</span> <span class="p">(</span>
            <span class="s">&#39;inconsistent naming, dnid=</span><span class="si">%r</span><span class="s">, dnids=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dnid</span><span class="p">,</span> <span class="n">dnids</span><span class="p">,))</span>
        <span class="n">groupxs</span> <span class="o">=</span> <span class="n">groupxs</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">daids</span> <span class="o">!=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">)</span>
        <span class="c"># &lt;/GET NAME GROUPXS&gt;</span>
        <span class="c"># sort annots in this name by the chip score</span>
        <span class="c"># HACK USE cm.annot_score_list</span>
        <span class="n">group_sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">csum_score_list</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">groupxs</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sorted_groupxs</span> <span class="o">=</span> <span class="n">groupxs</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">group_sortx</span><span class="p">)</span>
        <span class="c"># get the info for this name</span>
        <span class="n">name_fm_list</span>  <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">sorted_groupxs</span><span class="p">)</span>
        <span class="n">REMOVE_EMPTY_MATCHES</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_groupxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span>
        <span class="n">REMOVE_EMPTY_MATCHES</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">REMOVE_EMPTY_MATCHES</span><span class="p">:</span>
            <span class="n">isvalid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">fm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">name_fm_list</span><span class="p">])</span>
            <span class="n">MAX_MATCHES</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">isvalid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_at_least_n_items_valid</span><span class="p">(</span><span class="n">isvalid_list</span><span class="p">,</span> <span class="n">MAX_MATCHES</span><span class="p">)</span>
            <span class="n">name_fm_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_compress</span><span class="p">(</span><span class="n">name_fm_list</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>
            <span class="n">sorted_groupxs</span> <span class="o">=</span> <span class="n">sorted_groupxs</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">isvalid_list</span><span class="p">)</span>

        <span class="n">name_H1_list</span>   <span class="o">=</span> <span class="p">(</span><span class="bp">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">homog</span> <span class="ow">or</span> <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span>
                          <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">H_list</span><span class="p">,</span> <span class="n">sorted_groupxs</span><span class="p">))</span>
        <span class="n">name_fsv_list</span>  <span class="o">=</span> <span class="p">(</span><span class="bp">None</span> <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span>
                          <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">sorted_groupxs</span><span class="p">))</span>
        <span class="n">name_fs_list</span>   <span class="o">=</span> <span class="p">(</span><span class="bp">None</span> <span class="k">if</span> <span class="n">name_fsv_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span>
                          <span class="p">[</span><span class="n">fsv</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">fsv</span> <span class="ow">in</span> <span class="n">name_fsv_list</span><span class="p">])</span>
        <span class="n">name_daid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">sorted_groupxs</span><span class="p">)</span>
        <span class="c"># find features marked as invalid by name scoring</span>
        <span class="n">featflag_list</span>  <span class="o">=</span> <span class="n">name_scoring</span><span class="o">.</span><span class="n">get_chipmatch_namescore_nonvoting_feature_flags</span><span class="p">(</span>
            <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">name_featflag_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_take</span><span class="p">(</span><span class="n">featflag_list</span><span class="p">,</span> <span class="n">sorted_groupxs</span><span class="p">)</span>
        <span class="c"># Get the scores for names and chips</span>
        <span class="n">name_score</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="p">[</span><span class="n">nidx</span><span class="p">]</span>
        <span class="n">name_rank</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listfind</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">nidx</span><span class="p">)</span>
        <span class="n">name_annot_scores</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">csum_score_list</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sorted_groupxs</span><span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">viz_matches</span><span class="o">.</span><span class="n">show_name_matches</span><span class="p">(</span>
            <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">name_daid_list</span><span class="p">,</span> <span class="n">name_fm_list</span><span class="p">,</span> <span class="n">name_fs_list</span><span class="p">,</span>
            <span class="n">name_H1_list</span><span class="p">,</span> <span class="n">name_featflag_list</span><span class="p">,</span> <span class="n">name_score</span><span class="o">=</span><span class="n">name_score</span><span class="p">,</span> <span class="n">name_rank</span><span class="o">=</span><span class="n">name_rank</span><span class="p">,</span>
            <span class="n">name_annot_scores</span><span class="o">=</span><span class="n">name_annot_scores</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span>
            <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_</span>
</div>
<div class="viewcode-block" id="ChipMatch2.show_single_annotmatch"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.show_single_annotmatch">[docs]</a>    <span class="k">def</span> <span class="nf">show_single_annotmatch</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">daid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                               <span class="n">homog</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--homog&#39;</span><span class="p">),</span> <span class="n">aid2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: rename daid to aid2</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_post_sver(&#39;PZ_MTEST&#39;, qaid_list=[18])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; daid = cm.get_groundtruth_daids()[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.show_single_annotmatch(qreq_, daid)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ibeis.viz</span> <span class="kn">import</span> <span class="n">viz_matches</span>
        <span class="k">if</span> <span class="n">aid2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">daid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;use aid2 instead of daid kwarg&#39;</span>
            <span class="n">daid</span> <span class="o">=</span> <span class="n">aid2</span>

        <span class="k">if</span> <span class="n">daid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">daid</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">[</span><span class="n">daid</span><span class="p">]</span>
        <span class="n">fm</span>   <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">H1</span>   <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">homog</span> <span class="ow">or</span> <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">fsv</span>  <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">fs</span>   <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">fsv</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">fsv</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">showkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fm</span><span class="o">=</span><span class="n">fm</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">H1</span><span class="o">=</span><span class="n">H1</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">viz_matches</span><span class="o">.</span><span class="n">show_matches2</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,</span> <span class="n">daid</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">,</span>
                                  <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span> <span class="o">**</span><span class="n">showkw</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ChipMatch2.show_ranked_matches"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.show_ranked_matches">[docs]</a>    <span class="k">def</span> <span class="nf">show_ranked_matches</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">clip_top</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Plots the ranked-list of name/annot matches using matplotlib</span>

<span class="sd">        Args:</span>
<span class="sd">            qreq_ (QueryRequest): query request object with hyper-parameters</span>
<span class="sd">            clip_top (int): (default = 6)</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            fnum, figtitle, plottype, ...more</span>

<span class="sd">        SeeAlso:</span>
<span class="sd">            ibeis.viz.viz_matches.show_matches2</span>
<span class="sd">            ibeis.viz.viz_matches.show_name_matches</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis --tf ChipMatch2.show_ranked_matches --show --qaid 1</span>
<span class="sd">            python -m ibeis --tf ChipMatch2.show_ranked_matches --qaid 86 --colorbar_=False --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.viz import viz_matches</span>
<span class="sd">            &gt;&gt;&gt; defaultkw = dict(ut.recursive_parse_kwargs(viz_matches.show_name_matches))</span>
<span class="sd">            &gt;&gt;&gt; kwargs = ut.argparse_dict(defaultkw, only_specified=True)</span>
<span class="sd">            &gt;&gt;&gt; del kwargs[&#39;qaid&#39;]</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;plottype&#39;] = kwargs.get(&#39;plottype&#39;, &#39;namematch&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_post_sver(&#39;PZ_MTEST&#39;, qaid_list=[1])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; clip_top = 3</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;kwargs = %s&#39; % (ut.repr2(kwargs, nl=True),))</span>
<span class="sd">            &gt;&gt;&gt; cm.show_ranked_matches(qreq_, clip_top, **kwargs)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idx_list</span>  <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">argsort</span><span class="p">(),</span> <span class="n">clip_top</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">show_index_matches</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ChipMatch2.show_daids_matches"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.show_daids_matches">[docs]</a>    <span class="k">def</span> <span class="nf">show_daids_matches</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">idx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">,</span> <span class="n">daids</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">show_index_matches</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ChipMatch2.show_index_matches"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.show_index_matches">[docs]</a>    <span class="k">def</span> <span class="nf">show_index_matches</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">figtitle</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                           <span class="n">plottype</span><span class="o">=</span><span class="s">&#39;annotmatch&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
        <span class="k">if</span> <span class="n">fnum</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">next_fnum</span><span class="p">()</span>
        <span class="n">nRows</span><span class="p">,</span> <span class="n">nCols</span>  <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">get_square_row_cols</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_list</span><span class="p">),</span> <span class="n">fix</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--vert&#39;</span><span class="p">):</span>
            <span class="c"># HACK</span>
            <span class="n">nRows</span><span class="p">,</span> <span class="n">nCols</span> <span class="o">=</span> <span class="n">nCols</span><span class="p">,</span> <span class="n">nRows</span>
        <span class="n">next_pnum</span>     <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="n">nRows</span><span class="p">,</span> <span class="n">nCols</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">:</span>
            <span class="n">daid</span>  <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">pnum</span> <span class="o">=</span> <span class="n">next_pnum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s">&#39;namematch&#39;</span><span class="p">:</span>
                <span class="n">dnid</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">daid</span><span class="p">)</span>
                <span class="n">cm</span><span class="o">.</span><span class="n">show_single_namematch</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">dnid</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s">&#39;annotmatch&#39;</span><span class="p">:</span>
                <span class="n">cm</span><span class="o">.</span><span class="n">show_single_annotmatch</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">daid</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c"># FIXME:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                <span class="n">annot_score</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                <span class="n">score_str</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;score = </span><span class="si">%.3f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">score</span><span class="p">,)</span>
                             <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span>
                             <span class="s">&#39;score = None&#39;</span><span class="p">)</span>
                <span class="n">annot_score_str</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;annot_score = </span><span class="si">%.3f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">annot_score</span><span class="p">,)</span>
                                   <span class="k">if</span> <span class="n">annot_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span>
                                   <span class="s">&#39;annot_score = None&#39;</span><span class="p">)</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">score_str</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">annot_score_str</span>
                <span class="n">pt</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Unknown plottype=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">plottype</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">figtitle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">set_figtitle</span><span class="p">(</span><span class="n">figtitle</span><span class="p">)</span>
</div>
    <span class="n">show_matches</span> <span class="o">=</span> <span class="n">show_single_annotmatch</span>  <span class="c"># HACK</span>

<div class="viewcode-block" id="ChipMatch2.ishow_single_annotmatch"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.ishow_single_annotmatch">[docs]</a>    <span class="k">def</span> <span class="nf">ishow_single_annotmatch</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">aid2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Iteract with a match to an individual annotation (or maybe name?)</span>

<span class="sd">        Args:</span>
<span class="sd">            qreq_ (QueryRequest):  query request object with hyper-parameters</span>
<span class="sd">            aid2 (int):  annotation id(default = None)</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --exec-ishow_single_annotmatch --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_post_sver(&#39;PZ_MTEST&#39;, qaid_list=[1])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; aid2 = None</span>
<span class="sd">            &gt;&gt;&gt; result = cm.ishow_single_annotmatch(qreq_, aid2)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ibeis.viz.interact</span> <span class="kn">import</span> <span class="n">interact_matches</span>  <span class="c"># NOQA</span>
        <span class="c">#if aid == &#39;top&#39;:</span>
        <span class="c">#    aid = qres.get_top_aids(ibs)</span>
        <span class="n">kwshow</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;mode&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">aid2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">aid2</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_top_aids</span><span class="p">(</span><span class="n">ntop</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">kwshow</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">match_interaction</span> <span class="o">=</span> <span class="n">interact_matches</span><span class="o">.</span><span class="n">MatchInteraction</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span>
                                                                  <span class="n">cm</span><span class="p">,</span> <span class="n">aid2</span><span class="p">,</span>
                                                                  <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">,</span>
                                                                  <span class="o">**</span><span class="n">kwshow</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">match_interaction</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;failed in qres.show_matches&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;aid&#39;</span><span class="p">,</span> <span class="s">&#39;qreq_&#39;</span><span class="p">])</span>
            <span class="k">raise</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;noupdate&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</div>
    <span class="n">ishow_match</span> <span class="o">=</span> <span class="n">ishow_single_annotmatch</span>
    <span class="n">ishow_matches</span> <span class="o">=</span> <span class="n">ishow_single_annotmatch</span>

<div class="viewcode-block" id="ChipMatch2.ishow_analysis"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.ishow_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">ishow_analysis</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --exec-ChipMatch2.ishow_analysis --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; qaid = 18</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_pre_sver(&#39;PZ_MTEST&#39;, qaid_list=[qaid])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; cm.ishow_analysis(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ibeis.viz.interact</span> <span class="kn">import</span> <span class="n">interact_qres</span>
        <span class="n">kwshow</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;show_query&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;show_timedelta&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">kwshow</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">interact_qres</span><span class="o">.</span><span class="n">ishow_analysis</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwshow</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ChipMatch2.show_analysis"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.show_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">show_analysis</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">ibeis.viz</span> <span class="kn">import</span> <span class="n">viz_qres</span>
        <span class="n">kwshow</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;show_query&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;show_timedelta&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">kwshow</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">viz_qres</span><span class="o">.</span><span class="n">show_qres_analysis</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwshow</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ChipMatch2.imwrite_single_annotmatch"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.imwrite_single_annotmatch">[docs]</a>    <span class="k">def</span> <span class="nf">imwrite_single_annotmatch</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --exec-ChipMatch2.imwrite_single_annotmatch --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; kwargs = {}</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;dpi&#39;] = ut.get_argval(&#39;--dpi&#39;, int, None)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;figsize&#39;] = ut.get_argval(&#39;--figsize&#39;, list, None)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;fpath&#39;] = ut.get_argval(&#39;--fpath&#39;, str, None)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;draw_fmatches&#39;] = not ut.get_argflag(&#39;--no-fmatches&#39;)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;vert&#39;] = ut.get_argflag(&#39;--vert&#39;)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;draw_border&#39;] = ut.get_argflag(&#39;--draw_border&#39;)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;saveax&#39;] = ut.get_argflag(&#39;--saveax&#39;)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;in_image&#39;] = ut.get_argflag(&#39;--in-image&#39;)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;draw_lbl&#39;] = ut.get_argflag(&#39;--no-draw-lbl&#39;)</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;kwargs = %s&#39; % (ut.dict_str(kwargs),))</span>
<span class="sd">            &gt;&gt;&gt; cm, qreq_ = ibeis.testdata_cm()</span>
<span class="sd">            &gt;&gt;&gt; aid = cm.get_top_aids()[0]</span>
<span class="sd">            &gt;&gt;&gt; img_fpath = cm.imwrite_single_annotmatch(qreq_, aid, **kwargs)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; # show the image dumped to disk</span>
<span class="sd">            &gt;&gt;&gt; ut.startfile(img_fpath, quote=True)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
        <span class="c"># Pop save kwargs from kwargs</span>
        <span class="n">save_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;dpi&#39;</span><span class="p">,</span> <span class="s">&#39;figsize&#39;</span><span class="p">,</span> <span class="s">&#39;saveax&#39;</span><span class="p">,</span> <span class="s">&#39;fpath&#39;</span><span class="p">,</span> <span class="s">&#39;fpath_strict&#39;</span><span class="p">,</span> <span class="s">&#39;verbose&#39;</span><span class="p">]</span>
        <span class="n">save_vals</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take_pop</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">save_keys</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">savekw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">save_keys</span><span class="p">,</span> <span class="n">save_vals</span><span class="p">))</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">savekw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;fpath&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fpath</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="s">&#39;fpath_strict&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">savekw</span><span class="p">:</span>
            <span class="n">savekw</span><span class="p">[</span><span class="s">&#39;usetitle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">was_interactive</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">is_interactive</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">was_interactive</span><span class="p">:</span>
            <span class="n">mpl</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="c"># Make new figure</span>
        <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">ensure_fnum</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;fnum&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="c">#fig = pt.figure(fnum=fnum, doclf=True, docla=True)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="c"># Draw Matches</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">show_single_annotmatch</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">colorbar_</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c">#if not kwargs.get(&#39;notitle&#39;, False):</span>
        <span class="c">#    pt.set_figtitle(cm.make_smaller_title())</span>
        <span class="c"># Save Figure</span>
        <span class="c"># Setting fig=fig might make the dpi and figsize code not work</span>
        <span class="n">img_fpath</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">save_figure</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">fpath</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="o">**</span><span class="n">savekw</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>  <span class="c"># Ensure that this figure will not pop up</span>
        <span class="k">if</span> <span class="n">was_interactive</span><span class="p">:</span>
            <span class="n">mpl</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="n">was_interactive</span><span class="p">)</span>
        <span class="c">#if False:</span>
        <span class="c">#    ut.startfile(img_fpath)</span>
        <span class="k">return</span> <span class="n">img_fpath</span>
</div>
<div class="viewcode-block" id="ChipMatch2.qt_inspect_gui"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.chip_match.ChipMatch2.qt_inspect_gui">[docs]</a>    <span class="k">def</span> <span class="nf">qt_inspect_gui</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ibs</span><span class="p">,</span> <span class="n">ranks_lt</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name_scoring</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            ibs (IBEISController):  ibeis controller object</span>
<span class="sd">            ranks_lt (int): (default = 6)</span>
<span class="sd">            qreq_ (QueryRequest):  query request object with hyper-parameters(default = None)</span>
<span class="sd">            name_scoring (bool): (default = False)</span>

<span class="sd">        Returns:</span>
<span class="sd">            QueryResult: qres_wgt -  object of feature correspondences and scores</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.model.hots.chip_match --exec-qt_inspect_gui --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_post_sver(&#39;PZ_MTEST&#39;, qaid_list=[1])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; ranks_lt = 6</span>
<span class="sd">            &gt;&gt;&gt; name_scoring = False</span>
<span class="sd">            &gt;&gt;&gt; qres_wgt = cm.qt_inspect_gui(ibs, ranks_lt, qreq_, name_scoring)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; import guitool</span>
<span class="sd">            &gt;&gt;&gt; guitool.qtapp_loop(qwin=qres_wgt)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[qres] qt_inspect_gui&#39;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">ibeis.gui</span> <span class="kn">import</span> <span class="n">inspect_gui</span>
        <span class="kn">import</span> <span class="nn">guitool</span>
        <span class="n">guitool</span><span class="o">.</span><span class="n">ensure_qapp</span><span class="p">()</span>
        <span class="n">cm_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[inspect_matches] make_qres_widget&#39;</span><span class="p">)</span>
        <span class="n">qres_wgt</span> <span class="o">=</span> <span class="n">inspect_gui</span><span class="o">.</span><span class="n">QueryResultsWidget</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">cm_list</span><span class="p">,</span>
                                                  <span class="n">ranks_lt</span><span class="o">=</span><span class="n">ranks_lt</span><span class="p">,</span>
                                                  <span class="n">name_scoring</span><span class="o">=</span><span class="n">name_scoring</span><span class="p">,</span>
                                                  <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[inspect_matches] show&#39;</span><span class="p">)</span>
        <span class="n">qres_wgt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[inspect_matches] raise&#39;</span><span class="p">)</span>
        <span class="n">qres_wgt</span><span class="o">.</span><span class="n">raise_</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">qres_wgt</span>
</div></div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.model.hots.chip_match</span>
<span class="sd">        python -m ibeis.model.hots.chip_match --allexamples</span>
<span class="sd">        python -m ibeis.model.hots.chip_match --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>  <span class="c"># NOQA</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Jon Crall.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'1.5.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>