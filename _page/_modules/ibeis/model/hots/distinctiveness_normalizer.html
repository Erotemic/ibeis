<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ibeis.model.hots.distinctiveness_normalizer &mdash; ibeis 0.1.0.dev1 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.1.0.dev1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="ibeis 0.1.0.dev1 documentation" href="../../../../index.html" />
    <link rel="up" title="ibeis.model.hots" href="../hots.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">ibeis 0.1.0.dev1 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../../ibeis.html" >ibeis</a> &raquo;</li>
          <li><a href="../../model.html" >ibeis.model</a> &raquo;</li>
          <li><a href="../hots.html" accesskey="U">ibeis.model.hots</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for ibeis.model.hots.distinctiveness_normalizer</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">External mechanism for computing feature distinctiveness</span>

<span class="sd">stores some set of vectors which lose their association with</span>
<span class="sd">their parent.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">utool</span>
<span class="c">#from os.path import join</span>
<span class="c">#import numpy as np</span>
<span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="c">#import vtool as vt</span>
<span class="kn">import</span> <span class="nn">six</span>  <span class="c"># NOQA</span>
<span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">import</span> <span class="nn">pyflann</span>
<span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">sysres</span>
<span class="kn">from</span> <span class="nn">ibeis.model.hots</span> <span class="kn">import</span> <span class="n">hstypes</span>
<span class="k">print</span><span class="p">,</span> <span class="n">print_</span><span class="p">,</span> <span class="n">printDBG</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;[distinctnorm]&#39;</span><span class="p">,</span> <span class="n">DEBUG</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="n">DISTINCTIVENESS_NORMALIZER_CACHE</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">BASELINE_DISTINCTIVNESS_URLS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c"># TODO: Populate</span>
    <span class="n">const</span><span class="o">.</span><span class="n">Species</span><span class="o">.</span><span class="n">ZEB_GREVY</span><span class="p">:</span> <span class="n">const</span><span class="o">.</span><span class="n">ZIPPED_URLS</span><span class="o">.</span><span class="n">GZ_DISTINCTIVE</span><span class="p">,</span>
    <span class="n">const</span><span class="o">.</span><span class="n">Species</span><span class="o">.</span><span class="n">ZEB_PLAIN</span><span class="p">:</span> <span class="n">const</span><span class="o">.</span><span class="n">ZIPPED_URLS</span><span class="o">.</span><span class="n">PZ_DISTINCTIVE</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">PUBLISH_DIR</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unixpath</span><span class="p">(</span><span class="s">&#39;~/Dropbox/IBEIS&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="testdata_distinctiveness"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.testdata_distinctiveness">[docs]</a><span class="k">def</span> <span class="nf">testdata_distinctiveness</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.model.hots.distinctiveness_normalizer import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; dstcnvs_normer, qreq_ = testdata_distinctiveness()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">ibeis</span>
    <span class="c"># build test data</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="s">&#39;testdb1&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">species</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">Species</span><span class="o">.</span><span class="n">ZEB_PLAIN</span>
    <span class="n">daids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">)</span>
    <span class="n">qaids</span> <span class="o">=</span> <span class="n">daids</span>
    <span class="n">qreq_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">new_query_request</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">)</span>
    <span class="n">dstcnvs_normer</span> <span class="o">=</span> <span class="n">request_ibeis_distinctiveness_normalizer</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dstcnvs_normer</span><span class="p">,</span> <span class="n">qreq_</span>

</div>
<span class="nd">@six.add_metaclass</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ReloadingMetaclass</span><span class="p">)</span>
<div class="viewcode-block" id="DistinctivnessNormalizer"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.DistinctivnessNormalizer">[docs]</a><span class="k">class</span> <span class="nc">DistinctivnessNormalizer</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">Cachable</span><span class="p">):</span>
    <span class="n">ext</span>    <span class="o">=</span> <span class="s">&#39;.cPkl&#39;</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;distinctivness&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; cfgstring should be the species trained on &quot;&quot;&quot;</span>
        <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">vecs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">=</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">VEC_PSEUDO_MAX_DISTANCE</span>
        <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">max_distance_sqrd</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">cachedir</span> <span class="o">=</span> <span class="n">cachedir</span>
        <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="n">species</span>
        <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">flann_params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s">&#39;kdtree&#39;</span><span class="p">,</span> <span class="s">&#39;trees&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&#39;checks&#39;</span><span class="p">:</span> <span class="mi">800</span><span class="p">}</span>
        <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">checks</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">flann_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;checks&#39;</span><span class="p">)</span>
        <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">cores</span>  <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">flann_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;cores&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="DistinctivnessNormalizer.get_prefix"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.DistinctivnessNormalizer.get_prefix">[docs]</a>    <span class="k">def</span> <span class="nf">get_prefix</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DistinctivnessNormalizer</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span>
</div>
<div class="viewcode-block" id="DistinctivnessNormalizer.get_cfgstr"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.DistinctivnessNormalizer.get_cfgstr">[docs]</a>    <span class="k">def</span> <span class="nf">get_cfgstr</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">species</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="n">cfgstr</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">species</span>
        <span class="k">return</span> <span class="n">cfgstr</span>
</div>
<div class="viewcode-block" id="DistinctivnessNormalizer.add_support"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.DistinctivnessNormalizer.add_support">[docs]</a>    <span class="k">def</span> <span class="nf">add_support</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">,</span> <span class="n">new_vecs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="DistinctivnessNormalizer.archive"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.DistinctivnessNormalizer.archive">[docs]</a>    <span class="k">def</span> <span class="nf">archive</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">cachedir</span>      <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">cachedir</span> <span class="k">if</span> <span class="n">cachedir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">cachedir</span>
        <span class="n">data_fpath</span>    <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">get_fpath</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
        <span class="c">#flann_fpath   = dstcnvs_normer.get_flann_fpath(cachedir)</span>
        <span class="n">archive_fpath</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">get_fpath</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s">&#39;.zip&#39;</span><span class="p">)</span>
        <span class="n">fpath_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">data_fpath</span><span class="p">,</span>
            <span class="c">#flann_fpath</span>
        <span class="p">]</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">archive_files</span><span class="p">(</span><span class="n">archive_fpath</span><span class="p">,</span> <span class="n">fpath_list</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">archive_fpath</span>
</div>
<div class="viewcode-block" id="DistinctivnessNormalizer.publish"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.DistinctivnessNormalizer.publish">[docs]</a>    <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets this as the default normalizer available for download</span>
<span class="sd">        ONLY DEVELOPERS CAN PERFORM THIS OPERATION</span>

<span class="sd">        Args:</span>
<span class="sd">            cachedir (str):</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.model.hots.distinctiveness_normalizer --test-publish</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.distinctiveness_normalizer import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; dstcnvs_normer = testdata_distinctiveness()[0]</span>
<span class="sd">            &gt;&gt;&gt; dstcnvs_normer.rebuild()</span>
<span class="sd">            &gt;&gt;&gt; dstcnvs_normer.save()</span>
<span class="sd">            &gt;&gt;&gt; result = dstcnvs_normer.publish(cachedir)</span>
<span class="sd">            &gt;&gt;&gt; # verify results</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span><span class="p">,</span> <span class="n">join</span>
        <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_developer</span><span class="p">(),</span> <span class="s">&#39;ONLY DEVELOPERS CAN PERFORM THIS OPERATION&#39;</span>
        <span class="n">cachedir</span>      <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">cachedir</span> <span class="k">if</span> <span class="n">cachedir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">cachedir</span>
        <span class="n">archive_fpath</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">archive</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">archive_fname</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">archive_fpath</span><span class="p">)</span>
        <span class="n">publish_dpath</span> <span class="o">=</span> <span class="n">PUBLISH_DIR</span>
        <span class="n">publish_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">publish_dpath</span><span class="p">,</span> <span class="n">archive_fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">checkpath</span><span class="p">(</span><span class="n">publish_fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Overwriting model&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;old nBytes(publish_fpath) = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_file_nBytes_str</span><span class="p">(</span><span class="n">publish_fpath</span><span class="p">),))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;new nBytes(archive_fpath) = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_file_nBytes_str</span><span class="p">(</span><span class="n">archive_fpath</span><span class="p">),))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Publishing model&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;publish_fpath = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">publish_fpath</span><span class="p">,))</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">archive_fpath</span><span class="p">,</span> <span class="n">publish_fpath</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DistinctivnessNormalizer.get_flann_fpath"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.DistinctivnessNormalizer.get_flann_fpath">[docs]</a>    <span class="k">def</span> <span class="nf">get_flann_fpath</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">,</span> <span class="n">cachedir</span><span class="p">):</span>
        <span class="n">flann_fpath</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">get_fpath</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s">&#39;.flann&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flann_fpath</span>
</div>
<div class="viewcode-block" id="DistinctivnessNormalizer.exists"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.DistinctivnessNormalizer.exists">[docs]</a>    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">need_flann</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            cachedir (str): cache directory</span>
<span class="sd">            verbose (bool):  verbosity flag</span>

<span class="sd">        Returns:</span>
<span class="sd">            flag: load_success</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.model.hots.distinctiveness_normalizer --test-exists</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.distinctiveness_normalizer import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; # build test data</span>
<span class="sd">            &gt;&gt;&gt; dstcnvs_normer = testdata_distinctiveness()[0]</span>
<span class="sd">            &gt;&gt;&gt; assert dstcnvs_normer.exists()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span>
        <span class="n">cachedir</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">cachedir</span> <span class="k">if</span> <span class="n">cachedir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">cachedir</span>
        <span class="n">cpkl_fpath</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">get_fpath</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
        <span class="n">flann_fpath</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">get_flann_fpath</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
        <span class="n">fpath_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cpkl_fpath</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">need_flann</span><span class="p">:</span>
            <span class="n">fpath_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flann_fpath</span><span class="p">)</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">exists</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span> <span class="k">for</span> <span class="n">fpath</span> <span class="ow">in</span> <span class="n">fpath_list</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">flag</span>
</div>
<div class="viewcode-block" id="DistinctivnessNormalizer.load"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.DistinctivnessNormalizer.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Inherited method</span>
        <span class="n">cachedir</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">cachedir</span> <span class="k">if</span> <span class="n">cachedir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">cachedir</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;ignore_keys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;flann&#39;</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DistinctivnessNormalizer</span><span class="p">,</span> <span class="n">dstcnvs_normer</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">load_or_build_flann</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c">## Load Flann</span>
        <span class="c">#if ut.VERBOSE:</span>
        <span class="c">#    print(&#39;[nnindex] load_success = %r&#39; % (load_success,))</span>
</div>
<div class="viewcode-block" id="DistinctivnessNormalizer.load_or_build_flann"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.DistinctivnessNormalizer.load_or_build_flann">[docs]</a>    <span class="k">def</span> <span class="nf">load_or_build_flann</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">flann_fpath</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">get_flann_fpath</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">checkpath</span><span class="p">(</span><span class="n">flann_fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">flann</span> <span class="o">=</span> <span class="n">pyflann</span><span class="o">.</span><span class="n">FLANN</span><span class="p">()</span>
                <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">flann</span><span class="o">.</span><span class="n">load_index</span><span class="p">(</span><span class="n">flann_fpath</span><span class="p">,</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">vecs</span><span class="p">)</span>
                <span class="c">#load_success = True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;... cannot load distinctiveness flann&#39;</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">ensure_flann</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
            <span class="c">#raise IOError(&#39;cannot load distinctiveness flann&#39;)</span>
        <span class="c">#return load_success</span>
</div>
<div class="viewcode-block" id="DistinctivnessNormalizer.save"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.DistinctivnessNormalizer.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        args = tuple()</span>
<span class="sd">        kwargs = {}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cachedir</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">cachedir</span> <span class="k">if</span> <span class="n">cachedir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">cachedir</span>
        <span class="c"># Inherited method</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;ignore_keys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;flann&#39;</span><span class="p">]</span>
        <span class="c"># Save everything but flann</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DistinctivnessNormalizer</span><span class="p">,</span> <span class="n">dstcnvs_normer</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c"># Save flann</span>
        <span class="k">if</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">flann</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">save_flann</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DistinctivnessNormalizer.save_flann"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.DistinctivnessNormalizer.save_flann">[docs]</a>    <span class="k">def</span> <span class="nf">save_flann</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">cachedir</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">cachedir</span> <span class="k">if</span> <span class="n">cachedir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">cachedir</span>
        <span class="n">flann_fpath</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">get_flann_fpath</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;flann.save_index(</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">path_ndir_split</span><span class="p">(</span><span class="n">flann_fpath</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">flann</span><span class="o">.</span><span class="n">save_index</span><span class="p">(</span><span class="n">flann_fpath</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DistinctivnessNormalizer.init_support"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.DistinctivnessNormalizer.init_support">[docs]</a>    <span class="k">def</span> <span class="nf">init_support</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">,</span> <span class="n">vecs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">vecs</span> <span class="o">=</span> <span class="n">vecs</span>
        <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">rebuild</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DistinctivnessNormalizer.rebuild"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.DistinctivnessNormalizer.rebuild">[docs]</a>    <span class="k">def</span> <span class="nf">rebuild</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">flann</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">build_flann_index</span><span class="p">(</span>
            <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">vecs</span><span class="p">,</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">flann_params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">vecs</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">VEC_TYPE</span><span class="p">:</span>
            <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">=</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">VEC_PSEUDO_MAX_DISTANCE</span>
            <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">max_distance_sqrd</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">**</span> <span class="mi">2</span>
</div>
<div class="viewcode-block" id="DistinctivnessNormalizer.ensure_flann"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.DistinctivnessNormalizer.ensure_flann">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_flann</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">checkpath</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">get_flann_fpath</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)):</span>
            <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">rebuild</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
            <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">save_flann</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DistinctivnessNormalizer.get_distinctiveness"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.DistinctivnessNormalizer.get_distinctiveness">[docs]</a>    <span class="k">def</span> <span class="nf">get_distinctiveness</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">,</span> <span class="n">qfx2_vec</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            qfx2_vec (ndarray):  mapping from query feature index to vec</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.model.hots.distinctiveness_normalizer --test-get_distinctiveness</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.model.hots.distinctiveness_normalizer import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; dstcnvs_normer, qreq_ = testdata_distinctiveness()</span>
<span class="sd">            &gt;&gt;&gt; qaid = qreq_.get_external_qaids()[0]</span>
<span class="sd">            &gt;&gt;&gt; qfx2_vec = qreq_.ibs.get_annot_vecs(qaid)</span>
<span class="sd">            &gt;&gt;&gt; qfx2_dstncvs = dstcnvs_normer.get_distinctiveness(qfx2_vec)</span>
<span class="sd">            &gt;&gt;&gt; ut.assert_eq(len(qfx2_dstncvs.shape), 1)</span>
<span class="sd">            &gt;&gt;&gt; assert np.all(qfx2_dstncvs) &lt;= 1</span>
<span class="sd">            &gt;&gt;&gt; assert np.all(qfx2_dstncvs) &gt;= 0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;K&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">K</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">K</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">vecs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qfx2_vec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">(</span><span class="n">qfx2_idx</span><span class="p">,</span> <span class="n">qfx2_dist</span><span class="p">)</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">empty_neighbors</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># perform nearest neighbors</span>
            <span class="p">(</span><span class="n">qfx2_idx</span><span class="p">,</span> <span class="n">qfx2_dist</span><span class="p">)</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">flann</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span>
                <span class="n">qfx2_vec</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">checks</span><span class="o">=</span><span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">checks</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">cores</span><span class="p">)</span>
            <span class="c"># Ensure that distance returned are between 0 and 1</span>
            <span class="c">#qfx2_dist = qfx2_dist / (dstcnvs_normer.max_distance ** 2)</span>
            <span class="n">qfx2_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">qfx2_dist</span><span class="p">,</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">max_distance_sqrd</span><span class="p">)</span>
            <span class="c">#qfx2_dist = np.sqrt(qfx2_dist) / dstcnvs_normer.max_distance</span>
        <span class="n">norm_sqared_dist</span> <span class="o">=</span> <span class="n">qfx2_dist</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">qfx2_dstncvs</span> <span class="o">=</span> <span class="n">compute_distinctiveness_from_dist</span><span class="p">(</span><span class="n">norm_sqared_dist</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qfx2_dstncvs</span>

</div></div>
<div class="viewcode-block" id="compute_distinctiveness_from_dist"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.compute_distinctiveness_from_dist">[docs]</a><span class="k">def</span> <span class="nf">compute_distinctiveness_from_dist</span><span class="p">(</span><span class="n">norm_sqared_dist</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute distinctiveness from distance to K+1 nearest neighbor</span>

<span class="sd">    Ignore:</span>
<span class="sd">        norm_sqared_dist = np.random.rand(1000)</span>

<span class="sd">        import numexpr</span>

<span class="sd">        %timeit np.divide(norm_sqared_dist, clip_fraction)</span>
<span class="sd">        %timeit numexpr.evaluate(&#39;norm_sqared_dist / clip_fraction&#39;, local_dict=dict(norm_sqared_dist=norm_sqared_dist, clip_fraction=clip_fraction))</span>
<span class="sd">        wd_cliped = np.divide(norm_sqared_dist, clip_fraction)</span>

<span class="sd">        %timeit numexpr.evaluate(&#39;wd_cliped &gt; 1.0&#39;, local_dict=locals())</span>
<span class="sd">        %timeit np.greater(wd_cliped, 1.0)</span>

<span class="sd">        %timeit np.power(wd_cliped, p)</span>
<span class="sd">        %timeit numexpr.evaluate(&#39;wd_cliped ** p&#39;, local_dict=locals())</span>

<span class="sd">        %timeit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># TODO: paramaterize</span>
    <span class="c"># expondent to augment distinctiveness scores.</span>
    <span class="c">#p = kwargs.get(&#39;p&#39;, .5)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;p&#39;</span><span class="p">,</span> <span class="o">.</span><span class="mi">25</span><span class="p">)</span>
    <span class="c">#1.0)</span>
    <span class="c"># clip the distinctiveness at this fraction</span>
    <span class="c">#clip_fraction = kwargs.get(&#39;clip_fraction&#39;, .2)</span>
    <span class="c">#clip_fraction = kwargs.get(&#39;clip_fraction&#39;, .4)</span>
    <span class="n">clip_fraction</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;clip_fraction&#39;</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">wd_cliped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">norm_sqared_dist</span><span class="p">,</span> <span class="n">clip_fraction</span><span class="p">)</span>
    <span class="n">wd_cliped</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">wd_cliped</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">dstncvs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">wd_cliped</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dstncvs</span>

</div>
<div class="viewcode-block" id="download_baseline_distinctiveness_normalizer"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.download_baseline_distinctiveness_normalizer">[docs]</a><span class="k">def</span> <span class="nf">download_baseline_distinctiveness_normalizer</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="n">species</span><span class="p">):</span>
    <span class="n">zipped_url</span> <span class="o">=</span> <span class="n">BASELINE_DISTINCTIVNESS_URLS</span><span class="p">[</span><span class="n">species</span><span class="p">]</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">grab_zipped_url</span><span class="p">(</span><span class="n">zipped_url</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">download_dir</span><span class="o">=</span><span class="n">cachedir</span><span class="p">)</span>
    <span class="c">#ut.assert_eq(ut.unixpath(cachedir), dir_)</span>

</div>
<div class="viewcode-block" id="request_ibeis_distinctiveness_normalizer"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.request_ibeis_distinctiveness_normalizer">[docs]</a><span class="k">def</span> <span class="nf">request_ibeis_distinctiveness_normalizer</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        qreq_ (QueryRequest):  query request object with hyper-parameters</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.model.hots.distinctiveness_normalizer --test-request_ibeis_distinctiveness_normalizer</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.model.hots.distinctiveness_normalizer import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; daids = ibs.get_valid_aids(species=ibeis.const.Species.ZEB_PLAIN)</span>
<span class="sd">        &gt;&gt;&gt; qaids = ibs.get_valid_aids(species=ibeis.const.Species.ZEB_PLAIN)</span>
<span class="sd">        &gt;&gt;&gt; qreq_ = ibs.new_query_request(qaids, daids)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; dstcnvs_normer = request_ibeis_distinctiveness_normalizer(qreq_)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; assert dstcnvs_normer is not None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">DISTINCTIVENESS_NORMALIZER_CACHE</span>
    <span class="n">unique_species</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">get_unique_species</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_species</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">species</span> <span class="o">=</span> <span class="n">unique_species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">global_distinctdir</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_global_distinctiveness_modeldir</span><span class="p">()</span>
    <span class="n">cachedir</span> <span class="o">=</span> <span class="n">global_distinctdir</span>
    <span class="n">dstcnvs_normer</span> <span class="o">=</span> <span class="n">request_species_distinctiveness_normalizer</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">cachedir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dstcnvs_normer</span>

</div>
<div class="viewcode-block" id="request_species_distinctiveness_normalizer"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.request_species_distinctiveness_normalizer">[docs]</a><span class="k">def</span> <span class="nf">request_species_distinctiveness_normalizer</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    helper function to get distinctivness model independent of IBEIS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">DISTINCTIVENESS_NORMALIZER_CACHE</span><span class="p">:</span>
        <span class="n">dstcnvs_normer</span> <span class="o">=</span> <span class="n">DISTINCTIVENESS_NORMALIZER_CACHE</span><span class="p">[</span><span class="n">species</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cachedir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cachedir</span> <span class="o">=</span> <span class="n">sysres</span><span class="o">.</span><span class="n">get_global_distinctiveness_modeldir</span><span class="p">(</span><span class="n">ensure</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dstcnvs_normer</span> <span class="o">=</span> <span class="n">DistinctivnessNormalizer</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="n">cachedir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cachedir</span><span class="p">):</span>
            <span class="c"># download normalizer if it doesn&#39;t exist</span>
            <span class="n">download_baseline_distinctiveness_normalizer</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span>
        <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size_str</span><span class="p">(</span><span class="n">dstcnvs_normer</span><span class="p">,</span> <span class="s">&#39;dstcnvs_normer = &#39;</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Loaded distinctivness normalizer&#39;</span><span class="p">)</span>
        <span class="c">#dstcnvs_normer.ensure_flann(cachedir)</span>
        <span class="k">assert</span> <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="n">need_flann</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="s">&#39;normalizer should have been downloaded, but it doesnt exist&#39;</span>
        <span class="n">DISTINCTIVENESS_NORMALIZER_CACHE</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="n">dstcnvs_normer</span>
    <span class="k">return</span> <span class="n">dstcnvs_normer</span>

</div>
<div class="viewcode-block" id="clear_distinctivness_cache"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.clear_distinctivness_cache">[docs]</a><span class="k">def</span> <span class="nf">clear_distinctivness_cache</span><span class="p">():</span>
    <span class="n">global_distinctdir</span> <span class="o">=</span> <span class="n">sysres</span><span class="o">.</span><span class="n">get_global_distinctiveness_modeldir</span><span class="p">()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">remove_files_in_dir</span><span class="p">(</span><span class="n">global_distinctdir</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="list_distinctivness_cache"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.list_distinctivness_cache">[docs]</a><span class="k">def</span> <span class="nf">list_distinctivness_cache</span><span class="p">():</span>
    <span class="n">global_distinctdir</span> <span class="o">=</span> <span class="n">sysres</span><span class="o">.</span><span class="n">get_global_distinctiveness_modeldir</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">global_distinctdir</span><span class="p">)))</span>

</div>
<div class="viewcode-block" id="list_published_distinctivness"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.list_published_distinctivness">[docs]</a><span class="k">def</span> <span class="nf">list_published_distinctivness</span><span class="p">():</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.model.hots.distinctiveness_normalizer --test-list_published_distinctivness</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.model.hots.distinctiveness_normalizer import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; published_fpaths = list_published_distinctivness()</span>
<span class="sd">        &gt;&gt;&gt; print(ut.list_str(published_fpaths))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">published_fpaths</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">PUBLISH_DIR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">published_fpaths</span>

</div>
<div class="viewcode-block" id="view_distinctiveness_model_dir"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.view_distinctiveness_model_dir">[docs]</a><span class="k">def</span> <span class="nf">view_distinctiveness_model_dir</span><span class="p">():</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.model.hots.distinctiveness_normalizer --test-view_distinctiveness_model_dir</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.model.hots.distinctiveness_normalizer import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; view_distinctiveness_model_dir()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">global_distinctdir</span> <span class="o">=</span> <span class="n">sysres</span><span class="o">.</span><span class="n">get_global_distinctiveness_modeldir</span><span class="p">()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">vd</span><span class="p">(</span><span class="n">global_distinctdir</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="view_publish_dir"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.view_publish_dir">[docs]</a><span class="k">def</span> <span class="nf">view_publish_dir</span><span class="p">():</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.model.hots.distinctiveness_normalizer --test-view_publish_dir</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.model.hots.distinctiveness_normalizer import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; view_publish_dir()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">vd</span><span class="p">(</span><span class="n">PUBLISH_DIR</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="test_single_annot_distinctiveness_params"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.test_single_annot_distinctiveness_params">[docs]</a><span class="k">def</span> <span class="nf">test_single_annot_distinctiveness_params</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.model.hots.distinctiveness_normalizer --test-test_single_annot_distinctiveness_params --show</span>
<span class="sd">        python -m ibeis.model.hots.distinctiveness_normalizer --test-test_single_annot_distinctiveness_params --show --db GZ_ALL</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.model.hots.distinctiveness_normalizer import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(ut.get_argval(&#39;--db&#39;, type_=str, default=&#39;PZ_MTEST&#39;))</span>
<span class="sd">        &gt;&gt;&gt; aid = ut.get_argval(&#39;--aid&#39;, type_=int, default=1)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; test_single_annot_distinctiveness_params(ibs, aid)</span>
<span class="sd">        &gt;&gt;&gt; pt.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">####</span>
    <span class="c"># TODO: Also paramatarize the downweighting based on the keypoint size</span>
    <span class="c">####</span>
    <span class="c"># HACK IN ABILITY TO SET CONFIG</span>
    <span class="kn">from</span> <span class="nn">ibeis.dev.main_commands</span> <span class="kn">import</span> <span class="n">postload_commands</span>
    <span class="n">postload_commands</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">vtool</span> <span class="kn">import</span> <span class="n">coverage_image</span>
    <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
    <span class="kn">from</span> <span class="nn">plottool</span> <span class="kn">import</span> <span class="n">interact_impaint</span>

    <span class="c">#cfglbl_list = cfgdict_list</span>
    <span class="c">#ut.all_dict_combinations_lbls(varied_dict)</span>

    <span class="c"># Get info to find distinctivness of</span>
    <span class="n">species_text</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="n">vecs</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="n">kpts</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_kpts</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">kpts</span><span class="p">)</span>
    <span class="n">chip</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chips</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="n">chipsize</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chipsizes</span><span class="p">(</span><span class="n">aid</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c"># Paramater space to search</span>
    <span class="c"># TODO: use slicing to control the params being varied</span>
    <span class="c"># Use GridSearch class to modify paramaters as you go.</span>

    <span class="n">gauss_patch_varydict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;gauss_shape&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span> <span class="p">(</span><span class="mi">41</span><span class="p">,</span> <span class="mi">41</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)],</span>
        <span class="s">&#39;gauss_sigma_frac&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">7</span><span class="p">,</span> <span class="o">.</span><span class="mi">95</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">cov_blur_varydict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;cov_blur_on&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">],</span>
        <span class="s">&#39;cov_blur_ksize&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,),</span>  <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">)],</span>
        <span class="s">&#39;cov_blur_sigma&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">dstncvs_varydict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;p&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="mo">01</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
        <span class="s">&#39;clip_fraction&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="mo">05</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">],</span>
        <span class="s">&#39;K&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">size_penalty_varydict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;remove_affine_information&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">],</span>
        <span class="s">&#39;constant_scaling&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">],</span>
        <span class="s">&#39;size_penalty_on&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">],</span>
        <span class="s">&#39;size_penalty_power&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
        <span class="s">&#39;size_penalty_scale&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">keyval_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">iflatten</span><span class="p">([</span>
        <span class="n">dstncvs_varydict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
        <span class="n">gauss_patch_varydict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
        <span class="n">cov_blur_varydict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
        <span class="n">size_penalty_varydict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
    <span class="p">])</span>

    <span class="c"># Dont vary most paramaters, specify how much of their list can be used</span>
    <span class="n">param_slice_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;p&#39;</span>                  <span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s">&#39;K&#39;</span>                  <span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s">&#39;clip_fraction&#39;</span>      <span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s">&#39;clip_fraction&#39;</span>      <span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="c">#&#39;gauss_shape&#39;        : slice(0, 3),</span>
        <span class="s">&#39;gauss_sigma_frac&#39;</span>   <span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s">&#39;remove_affine_information&#39;</span> <span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s">&#39;constant_scaling&#39;</span> <span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s">&#39;size_penalty_on&#39;</span> <span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="c">#&#39;cov_blur_on&#39;        : slice(0, 2),</span>
        <span class="c">#&#39;cov_blur_ksize&#39;     : slice(0, 2),</span>
        <span class="c">#&#39;cov_blur_sigma&#39;     : slice(0, 1),</span>
        <span class="c">#&#39;size_penalty_power&#39; : slice(0, 2),</span>
        <span class="c">#&#39;size_penalty_scale&#39; : slice(0, 2),</span>
    <span class="p">}</span>
    <span class="n">varied_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="n">param_slice_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">keyval_iter</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">constrain_config</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; encode what makes a configuration feasible &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;cov_blur_on&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;cov_blur_ksize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;cov_blur_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;constant_scaling&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;remove_affine_information&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;size_penalty_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;remove_affine_information&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;gauss_shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">41</span><span class="p">,</span> <span class="mi">41</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;size_penalty_on&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;size_penalty_power&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;size_penalty_scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Varied Dict: &#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">varied_dict</span><span class="p">))</span>

    <span class="n">cfgdict_list</span><span class="p">,</span> <span class="n">cfglbl_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_constrained_cfg_and_lbl_list</span><span class="p">(</span><span class="n">varied_dict</span><span class="p">,</span> <span class="n">constrain_config</span><span class="p">)</span>

    <span class="c"># Get groundtruthish distinctivness map</span>
    <span class="c"># for objective function</span>
    <span class="n">GT_IS_DSTNCVS</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="n">GT_NOT_DSTNCVS</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">GT_UNKNOWN</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">label_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">GT_IS_DSTNCVS</span><span class="p">,</span> <span class="n">GT_NOT_DSTNCVS</span><span class="p">,</span> <span class="n">GT_UNKNOWN</span><span class="p">]</span>
    <span class="n">gtmask</span> <span class="o">=</span> <span class="n">interact_impaint</span><span class="o">.</span><span class="n">cached_impaint</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="s">&#39;dstncvnss&#39;</span><span class="p">,</span>
                                             <span class="n">label_colors</span><span class="o">=</span><span class="n">label_colors</span><span class="p">,</span>
                                             <span class="n">aug</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">refine</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--refine&#39;</span><span class="p">))</span>
    <span class="n">true_dstncvs_mask</span> <span class="o">=</span> <span class="n">gtmask</span> <span class="o">==</span> <span class="n">GT_IS_DSTNCVS</span>
    <span class="n">false_dstncvs_mask</span> <span class="o">=</span> <span class="n">gtmask</span> <span class="o">==</span> <span class="n">GT_NOT_DSTNCVS</span>

    <span class="n">true_dstncvs_mask_sum</span> <span class="o">=</span> <span class="n">true_dstncvs_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">false_dstncvs_mask_sum</span> <span class="o">=</span> <span class="n">false_dstncvs_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">distinctiveness_objective_function</span><span class="p">(</span><span class="n">dstncvs_mask</span><span class="p">):</span>
        <span class="n">true_mask</span>  <span class="o">=</span> <span class="n">true_dstncvs_mask</span> <span class="o">*</span> <span class="n">dstncvs_mask</span>
        <span class="n">false_mask</span> <span class="o">=</span> <span class="n">false_dstncvs_mask</span> <span class="o">*</span> <span class="n">dstncvs_mask</span>
        <span class="n">true_score</span> <span class="o">=</span> <span class="n">true_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">true_dstncvs_mask_sum</span>
        <span class="n">false_score</span> <span class="o">=</span> <span class="n">false_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">false_dstncvs_mask_sum</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">true_score</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">false_score</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">score</span>

    <span class="c"># Load distinctivness normalizer</span>
    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s">&#39;Loading Distinctivness Normalizer for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">species_text</span><span class="p">)):</span>
        <span class="n">dstcvnss_normer</span> <span class="o">=</span> <span class="n">request_species_distinctiveness_normalizer</span><span class="p">(</span><span class="n">species_text</span><span class="p">)</span>

    <span class="c"># Get distinctivness over all params</span>
    <span class="n">dstncvs_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">dstcvnss_normer</span><span class="o">.</span><span class="n">get_distinctiveness</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span> <span class="o">**</span><span class="n">cfgdict</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">cfgdict</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgressIter</span><span class="p">(</span><span class="n">cfgdict_list</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="s">&#39;get dstcvns&#39;</span><span class="p">)]</span>

    <span class="c"># Then compute the distinctinvess coverage map</span>
    <span class="c">#gauss_shape = kwargs.get(&#39;gauss_shape&#39;, (19, 19))</span>
    <span class="c">#sigma_frac = kwargs.get(&#39;sigma_frac&#39;, .3)</span>
    <span class="n">dstncvs_mask_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">coverage_image</span><span class="o">.</span><span class="n">make_coverage_mask</span><span class="p">(</span>
            <span class="n">kpts</span><span class="p">,</span> <span class="n">chipsize</span><span class="p">,</span> <span class="n">fx2_score</span><span class="o">=</span><span class="n">dstncvs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;max&#39;</span><span class="p">,</span> <span class="n">return_patch</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">cfg</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">dstncvs</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgressIter</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cfgdict_list</span><span class="p">,</span> <span class="n">dstncvs_list</span><span class="p">),</span> <span class="n">lbl</span><span class="o">=</span><span class="s">&#39;Warping Image&#39;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">score_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">distinctiveness_objective_function</span><span class="p">(</span><span class="n">dstncvs_mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">dstncvs_mask</span> <span class="ow">in</span> <span class="n">dstncvs_mask_list</span><span class="p">]</span>

    <span class="n">fnum</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">show_covimg_result</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">img</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">)</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">interact_gridsearch_result_images</span><span class="p">(</span>
        <span class="n">show_covimg_result</span><span class="p">,</span> <span class="n">cfgdict_list</span><span class="p">,</span> <span class="n">cfglbl_list</span><span class="p">,</span> <span class="n">dstncvs_mask_list</span><span class="p">,</span>
        <span class="n">score_list</span><span class="o">=</span><span class="n">score_list</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">figtitle</span><span class="o">=</span><span class="s">&#39;dstncvs gridsearch&#39;</span><span class="p">)</span>

    <span class="c"># Show subcomponents of grid search</span>
    <span class="n">gauss_patch_cfgdict_list</span><span class="p">,</span> <span class="n">gauss_patch_cfglbl_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_cfgdict_lbl_list_subset</span><span class="p">(</span><span class="n">cfgdict_list</span><span class="p">,</span> <span class="n">gauss_patch_varydict</span><span class="p">)</span>
    <span class="n">patch_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">coverage_image</span><span class="o">.</span><span class="n">get_gaussian_weight_patch</span><span class="p">(</span><span class="o">**</span><span class="n">cfgdict</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">cfgdict</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgressIter</span><span class="p">(</span><span class="n">gauss_patch_cfgdict_list</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="s">&#39;patch cfg&#39;</span><span class="p">)]</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">interact_gridsearch_result_images</span><span class="p">(</span>
        <span class="n">show_covimg_result</span><span class="p">,</span> <span class="n">gauss_patch_cfgdict_list</span><span class="p">,</span> <span class="n">gauss_patch_cfglbl_list</span><span class="p">,</span>
        <span class="n">patch_list</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figtitle</span><span class="o">=</span><span class="s">&#39;gaussian patches&#39;</span><span class="p">)</span>

    <span class="n">patch</span> <span class="o">=</span> <span class="n">patch_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c">#ut.embed()</span>

    <span class="c"># Show the first mask in more depth</span>
    <span class="n">dstncvs</span> <span class="o">=</span> <span class="n">dstncvs_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dstncvs_mask</span> <span class="o">=</span> <span class="n">dstncvs_mask_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">coverage_image</span><span class="o">.</span><span class="n">show_coverage_map</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dstncvs_mask</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">kpts</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ell_alpha</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">show_mask_kpts</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gtmask</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;ground truth distinctiveness&#39;</span><span class="p">)</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">present</span><span class="p">()</span>
    <span class="c">#ut.embed()</span>
    <span class="c">#pt.iup()</span>

    <span class="c">#ut.print_resource_usage()</span>
    <span class="c">#pt.set_figtitle(mode)</span>
    <span class="c">#pass</span>


<span class="c">#def test_example():</span>
<span class="c">#    import scipy.linalg as spl</span>
<span class="c">#    M = np.array([</span>
<span class="c">#        [1.0, 0.6, 0. , 0. , 0. ],</span>
<span class="c">#        [0.6, 1.0, 0.5, 0.2, 0. ],</span>
<span class="c">#        [0. , 0.5, 1.0, 0. , 0. ],</span>
<span class="c">#        [0. , 0.2, 0. , 1.0, 0.8],</span>
<span class="c">#        [0. , 0. , 0. , 0.8, 1.0],</span>
<span class="c">#    ])</span>
<span class="c">#    M_ = M / M.sum(axis=0)[:, None]</span>
<span class="c">#    #eigvals, eigvecs = np.linalg.eigh(M_)</span>
<span class="c">#    #, left=True, right=False)</span>
<span class="c">#    eigvals, eigvecs = spl.eig(M_, left=True, right=False)</span>
<span class="c">#    index = np.where(np.isclose(eigvals, 1))[0]</span>
<span class="c">#    pi = stationary_vector = eigvecs.T[index]</span>
<span class="c">#    pi_test = pi.dot(M_)</span>
<span class="c">#    pi / pi.sum()</span>
<span class="c">#    print(pi / np.linalg.norm(pi))</span>
<span class="c">#    print(pi_test / np.linalg.norm(pi_test))</span>

<span class="c">#    M = np.array([</span>
<span class="c">#        [1.0, 0.6],</span>
<span class="c">#        [0.6, 1.0],</span>
<span class="c">#    ])</span>
<span class="c">#    M_ = M / M.sum(axis=0)[:, None]</span>
<span class="c">#    #eigvals, eigvecs = np.linalg.eigh(M_)</span>
<span class="c">#    #, left=True, right=False)</span>
<span class="c">#    eigvals, eigvecs = spl.eig(M_, left=True, right=False)</span>
<span class="c">#    index = np.where(np.isclose(eigvals, 1))[0]</span>
<span class="c">#    pi = stationary_vector = eigvecs.T[index]</span>
<span class="c">#    pi_test = pi.dot(M_)</span>
<span class="c">#    pi / pi.sum()</span>
<span class="c">#    print(pi / np.linalg.norm(pi))</span>
<span class="c">#    print(pi_test / np.linalg.norm(pi_test))</span>
<span class="c">#    #pi = pi / pi.sum()</span>

</div>
<div class="viewcode-block" id="dev_train_distinctiveness"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.distinctiveness_normalizer.dev_train_distinctiveness">[docs]</a><span class="k">def</span> <span class="nf">dev_train_distinctiveness</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        species (None):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.model.hots.distinctiveness_normalizer --test-dev_train_distinctiveness</span>
<span class="sd">        alias dev_train_distinctiveness=&#39;python -m ibeis.model.hots.distinctiveness_normalizer --test-dev_train_distinctiveness&#39;</span>
<span class="sd">        dev_train_distinctiveness --species GZ --publish</span>
<span class="sd">        dev_train_distinctiveness --species PZ --publish</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.model.hots.distinctiveness_normalizer import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; species_code = ut.get_argval(&#39;--species&#39;, str, &#39;GZ&#39;)</span>
<span class="sd">        &gt;&gt;&gt; species = sysres.resolve_species(species_code)</span>
<span class="sd">        &gt;&gt;&gt; dev_train_distinctiveness(species)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">ibeis</span>
    <span class="c">#if &#39;species&#39; not in vars() or species is None:</span>
    <span class="c">#    species = const.Species.ZEB_GREVY</span>
    <span class="k">if</span> <span class="n">species</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">Species</span><span class="o">.</span><span class="n">ZEB_GREVY</span><span class="p">:</span>
        <span class="n">dbname</span> <span class="o">=</span> <span class="s">&#39;GZ_ALL&#39;</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">Species</span><span class="o">.</span><span class="n">ZEB_PLAIN</span><span class="p">:</span>
        <span class="n">dbname</span> <span class="o">=</span> <span class="s">&#39;PZ_Master0&#39;</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
    <span class="n">global_distinctdir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_global_distinctiveness_modeldir</span><span class="p">()</span>
    <span class="n">cachedir</span> <span class="o">=</span> <span class="n">global_distinctdir</span>
    <span class="n">dstcnvs_normer</span> <span class="o">=</span> <span class="n">DistinctivnessNormalizer</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="n">cachedir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s">&#39;loading distinctiveness&#39;</span><span class="p">):</span>
            <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
        <span class="c"># Cache hit</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;distinctivness model cache hit&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;distinctivness model cache miss&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s">&#39;training distinctiveness&#39;</span><span class="p">):</span>
            <span class="c"># Need to train</span>
            <span class="c"># Add one example from each name</span>
            <span class="c"># TODO: add one exemplar per viewpoint for each name</span>
            <span class="c">#max_vecs = 1E6</span>
            <span class="n">max_annots</span> <span class="o">=</span> <span class="mi">975</span>
            <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">()</span>
            <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
            <span class="n">num_annots_list</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
            <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">aids_list</span><span class="p">,</span> <span class="n">num_annots_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">aids_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c"># Keep only a certain number of annots for distinctiveness mapping</span>
            <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">max_annots</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;total num named annots = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">num_annots_list</span><span class="p">)))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;training distinctiveness using </span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s"> singleton annots&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)))</span>
            <span class="c"># vec</span>
            <span class="n">vecs_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">)</span>
            <span class="n">num_vecs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">vecs_list</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;num_vecs = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_vecs</span><span class="p">,))</span>
            <span class="n">vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">vecs_list</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;vecs size = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_object_size_str</span><span class="p">(</span><span class="n">vecs</span><span class="p">),))</span>
            <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">init_support</span><span class="p">(</span><span class="n">vecs</span><span class="p">)</span>
            <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">global_distinctdir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--publish&#39;</span><span class="p">):</span>
        <span class="n">dstcnvs_normer</span><span class="o">.</span><span class="n">publish</span><span class="p">()</span>
    <span class="c">#vsone_</span>
    <span class="c">#inct</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.model.hots.distinctiveness_normalizer</span>
<span class="sd">        python -m ibeis.model.hots.distinctiveness_normalizer --allexamples</span>
<span class="sd">        python -m ibeis.model.hots.distinctiveness_normalizer --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>  <span class="c"># NOQA</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">ibeis 0.1.0.dev1 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../../ibeis.html" >ibeis</a> &raquo;</li>
          <li><a href="../../model.html" >ibeis.model</a> &raquo;</li>
          <li><a href="../hots.html" >ibeis.model.hots</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Jon Crall.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>