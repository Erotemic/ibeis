<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ibeis.model.hots.vsone_pipeline &mdash; ibeis 0.1.0.dev1 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.1.0.dev1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="ibeis 0.1.0.dev1 documentation" href="../../../../index.html" />
    <link rel="up" title="ibeis.model.hots" href="../hots.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">ibeis 0.1.0.dev1 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../../ibeis.html" >ibeis</a> &raquo;</li>
          <li><a href="../../model.html" >ibeis.model</a> &raquo;</li>
          <li><a href="../hots.html" accesskey="U">ibeis.model.hots</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for ibeis.model.hots.vsone_pipeline</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">special pipeline for vsone specific functions</span>


<span class="sd">Current Issues:</span>
<span class="sd">    * getting feature distinctiveness is too slow, we can either try a different</span>
<span class="sd">      model, or precompute feature distinctiveness.</span>

<span class="sd">      - we can reduce the size of the vsone shortlist</span>

<span class="sd">TODOLIST:</span>
<span class="sd">    * Precompute distinctivness</span>
<span class="sd">    * Paramatarize</span>
<span class="sd">     - grid / image coverage</span>
<span class="sd">     - image cov params</span>
<span class="sd">     - grid cov params</span>
<span class="sd">     - scr-vsone / rat-vsone</span>
<span class="sd">     - scr-params</span>
<span class="sd">     - rat-params</span>

<span class="sd">     - true-pos-score in qres</span>
<span class="sd">     - false-neg-score in qres</span>
<span class="sd">     - false-pos-score in qres</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
<span class="c">#from ibeis.model.hots import neighbor_index</span>
<span class="kn">from</span> <span class="nn">ibeis.model.hots</span> <span class="kn">import</span> <span class="n">name_scoring</span>
<span class="kn">from</span> <span class="nn">ibeis.model.hots</span> <span class="kn">import</span> <span class="n">hstypes</span>
<span class="c">#import pyflann</span>
<span class="c">#from ibeis.model.hots import coverage_image</span>
<span class="kn">from</span> <span class="nn">vtool</span> <span class="kn">import</span> <span class="n">coverage_image</span>
<span class="kn">from</span> <span class="nn">ibeis.model.hots</span> <span class="kn">import</span> <span class="n">_pipeline_helpers</span> <span class="k">as</span> <span class="n">plh</span>  <span class="c"># NOQA</span>
<span class="kn">from</span> <span class="nn">ibeis.model.hots</span> <span class="kn">import</span> <span class="n">distinctiveness_normalizer</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">zip</span><span class="p">,</span> <span class="nb">range</span>  <span class="c"># NOQA</span>
<span class="c">#profile = ut.profile</span>
<span class="k">print</span><span class="p">,</span> <span class="n">print_</span><span class="p">,</span>  <span class="n">printDBG</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;[vsonepipe]&#39;</span><span class="p">,</span> <span class="n">DEBUG</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<div class="viewcode-block" id="show_top_chipmatches"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.vsone_pipeline.show_top_chipmatches">[docs]</a><span class="k">def</span> <span class="nf">show_top_chipmatches</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid2_chipmatch</span><span class="p">,</span> <span class="n">fnum_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">figtitle</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; helper &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.viz</span> <span class="kn">import</span> <span class="n">viz_sver</span>
    <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
    <span class="n">CLIP_TOP</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="k">for</span> <span class="n">fnum_</span><span class="p">,</span> <span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">chipmatch</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">qaid2_chipmatch</span><span class="p">)):</span>
        <span class="n">fnum</span> <span class="o">=</span> <span class="n">fnum_</span> <span class="o">+</span> <span class="n">fnum_offset</span>
        <span class="c">#pt.figure(fnum=fnum, doclf=True, docla=True)</span>
        <span class="n">daid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">(</span><span class="n">chipmatch</span><span class="o">.</span><span class="n">aid2_fm</span><span class="p">))</span>
        <span class="n">score_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">chipmatch</span><span class="o">.</span><span class="n">aid2_score</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">)</span>
        <span class="n">top_daid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">score_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">CLIP_TOP</span><span class="p">)</span>
        <span class="n">nRows</span><span class="p">,</span> <span class="n">nCols</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">get_square_row_cols</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_daid_list</span><span class="p">),</span> <span class="n">fix</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">next_pnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="n">nRows</span><span class="p">,</span> <span class="n">nCols</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">daid</span> <span class="ow">in</span> <span class="n">top_daid_list</span><span class="p">:</span>
            <span class="n">fm</span> <span class="o">=</span> <span class="n">chipmatch</span><span class="o">.</span><span class="n">aid2_fm</span><span class="p">[</span><span class="n">daid</span><span class="p">]</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">chipmatch</span><span class="o">.</span><span class="n">aid2_H</span><span class="p">[</span><span class="n">daid</span><span class="p">]</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">chipmatch</span><span class="o">.</span><span class="n">aid2_score</span><span class="p">[</span><span class="n">daid</span><span class="p">]</span>
            <span class="n">viz_sver</span><span class="o">.</span><span class="n">show_constrained_match</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">daid</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">fm</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">next_pnum</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_match_truth</span><span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">daid</span><span class="p">):</span>
                <span class="n">pt</span><span class="o">.</span><span class="n">draw_border</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span> <span class="n">pt</span><span class="o">.</span><span class="n">TRUE_GREEN</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;score = </span><span class="si">%.3f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">score</span><span class="p">,))</span>
            <span class="c">#top_score_list = ut.dict_take(chipmatch.aid2_score, top_daid_list)</span>
            <span class="c">#top_fm_list    = ut.dict_take(chipmatch.aid2_fm, top_daid_list)</span>
            <span class="c">#top_fsv_list   = ut.dict_take(chipmatch.aid2_fsv, top_daid_list)</span>
            <span class="c">#top_H_list     = ut.dict_take(chipmatch.aid2_H, top_daid_list)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">set_figtitle</span><span class="p">(</span><span class="s">&#39;qaid=</span><span class="si">%r</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">figtitle</span><span class="p">))</span>

    <span class="c">#vsone_query_pairs = make_vsone_rerank_pairs(qreq_, qaid2_chipmatch)</span>
    <span class="c">#ibs = qreq_.ibs</span>
    <span class="c">#for fnum, vsone_pair_tup in enumerate(vsone_query_pairs):</span>
    <span class="c">#    (qaid, daid_list, H_list) = vsone_pair_tup</span>
    <span class="c">#    nRows, nCols = pt.get_square_row_cols(len(daid_list))</span>
    <span class="c">#    next_pnum = pt.make_pnum_nextgen(*daid_list)</span>
    <span class="c">#    for daid in daid_list:</span>
    <span class="c">#        fm = qaid2_chipmatch[qaid].aid2_fm[daid]</span>
    <span class="c">#        H = qaid2_chipmatch[qaid].aid2_H[daid]</span>
    <span class="c">#        viz_sver.show_constrained_match(ibs, qaid, daid, H, fm, pnum=next_pnum())</span>

</div>
<div class="viewcode-block" id="show_annot_weights"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.vsone_pipeline.show_annot_weights">[docs]</a><span class="k">def</span> <span class="nf">show_annot_weights</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;dstncvs&#39;</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    DEMO FUNC</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid (int):  annotation id</span>
<span class="sd">        mode (str):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        alias show_annot_weights=&#39;python -m ibeis.model.hots.vsone_pipeline --test-show_annot_weights --show&#39;</span>
<span class="sd">        show_annot_weights</span>
<span class="sd">        show_annot_weights --db PZ_MTEST --aid 1 --mode &#39;dstncvs&#39;</span>
<span class="sd">        show_annot_weights --db PZ_MTEST --aid 1 --mode &#39;fgweight&#39;&amp;</span>
<span class="sd">        show_annot_weights --db GZ_ALL --aid 1 --mode &#39;dstncvs&#39;</span>
<span class="sd">        show_annot_weights --db GZ_ALL --aid 1 --mode &#39;fgweight&#39;&amp;</span>


<span class="sd">        python -m ibeis.model.hots.vsone_pipeline --test-show_annot_weights --show --db GZ_ALL --aid 1 --mode &#39;dstncvs&#39;</span>
<span class="sd">        python -m ibeis.model.hots.vsone_pipeline --test-show_annot_weights --show --db PZ_MTEST --aid 1 --mode &#39;dstncvs&#39;</span>
<span class="sd">        python -m ibeis.model.hots.vsone_pipeline --test-show_annot_weights --show --db GZ_ALL --aid 1 --mode &#39;fgweight&#39;</span>
<span class="sd">        python -m ibeis.model.hots.vsone_pipeline --test-show_annot_weights --show --db PZ_MTEST --aid 1 --mode &#39;fgweight&#39;</span>

<span class="sd">        python -m ibeis.model.hots.vsone_pipeline --test-show_annot_weights --show --db GZ_ALL --aid 1 --mode &#39;dstncvs*fgweight&#39;</span>
<span class="sd">        python -m ibeis.model.hots.vsone_pipeline --test-show_annot_weights --show --db PZ_MTEST --aid 1 --mode &#39;dstncvs*fgweight&#39;</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.model.hots.vsone_pipeline import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(ut.get_argval(&#39;--db&#39;, type_=str, default=&#39;testdb1&#39;))</span>
<span class="sd">        &gt;&gt;&gt; aid = ut.get_argval(&#39;--aid&#39;, type_=int, default=1)</span>
<span class="sd">        &gt;&gt;&gt; mode = ut.get_argval(&#39;--mode&#39;, type_=str, default=&#39;dstncvs&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; show_annot_weights(ibs, aid, mode)</span>
<span class="sd">        &gt;&gt;&gt; pt.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">functools</span>
    <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
    <span class="n">fnum</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">chipsize</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chipsizes</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="c">#chipshape = chipsize[::-1]</span>
    <span class="n">chip</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chips</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="n">kpts</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_kpts</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">)</span>  <span class="c"># win32 hack</span>
    <span class="n">fx2_score</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">weight_fn_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;dstncvs&#39;</span><span class="p">:</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">get_kpts_distinctiveness</span><span class="p">,</span> <span class="n">ibs</span><span class="p">),</span>
        <span class="s">&#39;fgweight&#39;</span><span class="p">:</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_fgweights</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">key_list</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_list</span><span class="p">:</span>
        <span class="c">#print(key)</span>
        <span class="n">get_weight</span> <span class="o">=</span> <span class="n">weight_fn_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">fx2_weight</span> <span class="o">=</span> <span class="n">get_weight</span><span class="p">([</span><span class="n">aid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c">#print(fx2_weight)</span>
        <span class="n">fx2_score</span> <span class="o">=</span> <span class="n">fx2_score</span> <span class="o">*</span> <span class="n">fx2_weight</span>
    <span class="n">fx2_score</span> <span class="o">**=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_list</span><span class="p">)</span>  <span class="c"># geometric average</span>
    <span class="c">#mask, patch = coverage_image.make_coverage_mask(</span>
    <span class="c">#    kpts, chipshape, fx2_score=fx2_score, mode=&#39;max&#39;)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">coverage_image</span><span class="o">.</span><span class="n">get_grid_coverage_mask</span><span class="p">(</span>
        <span class="n">kpts</span><span class="p">,</span> <span class="n">chipsize</span><span class="p">,</span> <span class="n">fx2_score</span><span class="p">,</span> <span class="n">grid_scale_factor</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span> <span class="n">grid_steps</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">resize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#mask = (mask / mask.max()) ** 2</span>
    <span class="n">coverage_image</span><span class="o">.</span><span class="n">show_coverage_map</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">kpts</span><span class="p">,</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">ell_alpha</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">show_mask_kpts</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">set_figtitle</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>


<span class="c">#@profile</span></div>
<div class="viewcode-block" id="vsone_reranking"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.vsone_pipeline.vsone_reranking">[docs]</a><span class="k">def</span> <span class="nf">vsone_reranking</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">qaid2_chipmatch</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Driver function for vsone reranking</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.model.hots.vsone_pipeline --test-vsone_reranking</span>
<span class="sd">        utprof.py -m ibeis.model.hots.vsone_pipeline --test-vsone_reranking</span>
<span class="sd">        python -m ibeis.model.hots.vsone_pipeline --test-vsone_reranking --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.model.hots.vsone_pipeline import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; cfgdict = dict(dupvote_weight=1.0, prescore_method=&#39;nsum&#39;, score_method=&#39;nsum&#39;, sver_weighting=True)</span>
<span class="sd">        &gt;&gt;&gt; ibs, qreq_ = plh.get_pipeline_testdata(&#39;PZ_MTEST&#39;, cfgdict=cfgdict, qaid_list=[1, 4, 6])</span>
<span class="sd">        &gt;&gt;&gt; locals_ = plh.testrun_pipeline_upto(qreq_, &#39;chipmatch_to_resdict&#39;)</span>
<span class="sd">        &gt;&gt;&gt; qaid2_chipmatch = locals_[&#39;qaid2_chipmatch_SVER&#39;]</span>
<span class="sd">        &gt;&gt;&gt; qaid2_chipmatch_VSONE = vsone_reranking(qreq_, qaid2_chipmatch)</span>
<span class="sd">        &gt;&gt;&gt; if ut.show_was_requested():</span>
<span class="sd">        &gt;&gt;&gt;     import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt;     show_top_chipmatches(qreq_.ibs, qaid2_chipmatch_VSONE)</span>
<span class="sd">        &gt;&gt;&gt;     pt.show_if_requested()</span>

<span class="sd">    Ignore:</span>
<span class="sd">        max_depth = None</span>
<span class="sd">        max_depth2 = 1</span>
<span class="sd">        print(ut.depth_profile(Hs_list, 0))</span>
<span class="sd">        print(ut.depth_profile(scores_list, max_depth))</span>
<span class="sd">        print(ut.depth_profile(daid_list, max_depth))</span>
<span class="sd">        print(ut.depth_profile(fms_list, max_depth2))</span>
<span class="sd">        print(ut.depth_profile(fsvs_list, max_depth))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># First find a shortlist to execute vsone reranking on</span>
    <span class="n">qaid_list</span><span class="p">,</span> <span class="n">daids_list</span><span class="p">,</span> <span class="n">Hs_list</span> <span class="o">=</span> <span class="n">make_vsone_rerank_pairs</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">qaid2_chipmatch</span><span class="p">)</span>  <span class="c"># NOQA</span>
    <span class="c"># Then execute vsone reranking</span>
    <span class="n">vsone_res_tup</span> <span class="o">=</span> <span class="n">execute_vsone_reranking</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">qaid_list</span><span class="p">,</span> <span class="n">daids_list</span><span class="p">,</span> <span class="n">Hs_list</span><span class="p">)</span>
    <span class="c"># Format the output into chipmatches</span>
    <span class="p">(</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">scores_list</span><span class="p">,</span> <span class="n">fms_list</span><span class="p">,</span> <span class="n">fsvs_list</span><span class="p">)</span> <span class="o">=</span> <span class="n">vsone_res_tup</span>
    <span class="n">chipmatch_VSONE_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">daids</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">fms</span><span class="p">,</span> <span class="n">fsvs</span><span class="p">,</span> <span class="n">Hs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">scores_list</span><span class="p">,</span> <span class="n">fms_list</span><span class="p">,</span> <span class="n">fsvs_list</span><span class="p">,</span> <span class="n">Hs_list</span><span class="p">):</span>
        <span class="n">fks</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fm</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">FK_DTYPE</span><span class="p">)</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">fms</span><span class="p">]</span>
        <span class="n">aid2_fm</span>    <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">daids</span><span class="p">,</span> <span class="n">fms</span><span class="p">))</span>
        <span class="n">aid2_fsv</span>   <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">daids</span><span class="p">,</span> <span class="n">fsvs</span><span class="p">))</span>
        <span class="n">aid2_fk</span>    <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">daids</span><span class="p">,</span> <span class="n">fks</span><span class="p">))</span>
        <span class="n">aid2_score</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">daids</span><span class="p">,</span> <span class="n">scores</span><span class="p">))</span>
        <span class="n">aid2_H</span>     <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">daids</span><span class="p">,</span> <span class="n">Hs</span><span class="p">))</span>
        <span class="n">chipmatch_VSONE</span> <span class="o">=</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">ChipMatch</span><span class="p">(</span><span class="n">aid2_fm</span><span class="p">,</span> <span class="n">aid2_fsv</span><span class="p">,</span> <span class="n">aid2_fk</span><span class="p">,</span> <span class="n">aid2_score</span><span class="p">,</span> <span class="n">aid2_H</span><span class="p">)</span>
        <span class="n">chipmatch_VSONE_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chipmatch_VSONE</span><span class="p">)</span>
    <span class="n">qaid2_chipmatch_VSONE</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">chipmatch_VSONE_list</span><span class="p">))</span>
    <span class="c">#qaid2_scores = dict(zip(qaid_list, scores_list))</span>
    <span class="k">return</span> <span class="n">qaid2_chipmatch_VSONE</span>

</div>
<span class="nd">@profile</span>
<div class="viewcode-block" id="make_vsone_rerank_pairs"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.vsone_pipeline.make_vsone_rerank_pairs">[docs]</a><span class="k">def</span> <span class="nf">make_vsone_rerank_pairs</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">qaid2_chipmatch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Makes shortlists for vsone reranking</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.model.hots.vsone_pipeline import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; cfgdict = dict(dupvote_weight=1.0, prescore_method=&#39;nsum&#39;, score_method=&#39;nsum&#39;, sver_weighting=True)</span>
<span class="sd">        &gt;&gt;&gt; ibs, qreq_ = plh.get_pipeline_testdata(&#39;PZ_MTEST&#39;, cfgdict=cfgdict)</span>
<span class="sd">        &gt;&gt;&gt; locals_ = plh.testrun_pipeline_upto(qreq_, &#39;chipmatch_to_resdict&#39;)</span>
<span class="sd">        &gt;&gt;&gt; qaid2_chipmatch = locals_[&#39;qaid2_chipmatch_SVER&#39;]</span>
<span class="sd">        &gt;&gt;&gt; qaid = qreq_.get_external_qaids()[0]</span>
<span class="sd">        &gt;&gt;&gt; chipmatch = qaid2_chipmatch[qaid]</span>
<span class="sd">        &gt;&gt;&gt; qaid_list, top_aids_list, top_Hs_list = make_vsone_rerank_pairs(qreq_, qaid2_chipmatch)</span>
<span class="sd">        &gt;&gt;&gt; top_aid_list = top_aids_list[0]</span>
<span class="sd">        &gt;&gt;&gt; top_nid_list = ibs.get_annot_name_rowids(top_aid_list)</span>
<span class="sd">        &gt;&gt;&gt; assert top_nid_list.index(1) == 0, &#39;name 1 should be rank 1&#39;</span>
<span class="sd">        &gt;&gt;&gt; assert len(top_nid_list) == 5, &#39;should have 3 names and up to 2 image per name&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.model.hots</span> <span class="kn">import</span> <span class="n">pipeline</span>
    <span class="n">score_method</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">qparams</span><span class="o">.</span><span class="n">score_method</span>
    <span class="c"># TODO: paramaterize</span>
    <span class="n">nNameShortlistVsone</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">nAnnotPerName</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">assert</span> <span class="n">score_method</span> <span class="o">==</span> <span class="s">&#39;nsum&#39;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;vsone reranking. &#39;</span><span class="p">)</span>
    <span class="n">qaid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">(</span><span class="n">qaid2_chipmatch</span><span class="p">))</span>
    <span class="n">chipmatch_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">qaid2_chipmatch</span><span class="p">,</span> <span class="n">qaid_list</span><span class="p">)</span>
    <span class="n">daids_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Hs_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">chipmatch</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">chipmatch_list</span><span class="p">):</span>
        <span class="n">daid2_prescore</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">score_chipmatch</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">chipmatch</span><span class="p">,</span> <span class="n">score_method</span><span class="p">)</span>
        <span class="n">daid_list</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">daid2_prescore</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">prescore_arr</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">daid2_prescore</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="c"># HACK POPULATE AID2_SCORE FIELD IN CHIPMATCH TUPLE</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">dict_assign</span><span class="p">(</span><span class="n">chipmatch</span><span class="o">.</span><span class="n">aid2_score</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">prescore_arr</span><span class="p">)</span>
        <span class="c">#</span>
        <span class="n">nscore_tup</span> <span class="o">=</span> <span class="n">name_scoring</span><span class="o">.</span><span class="n">group_scores_by_name</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">prescore_arr</span><span class="p">)</span>
        <span class="p">(</span><span class="n">sorted_nids</span><span class="p">,</span> <span class="n">sorted_nscore</span><span class="p">,</span> <span class="n">sorted_aids</span><span class="p">,</span> <span class="n">sorted_scores</span><span class="p">)</span> <span class="o">=</span> <span class="n">nscore_tup</span>
        <span class="n">top_aids_list</span>  <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">sorted_aids</span><span class="p">,</span> <span class="n">nNameShortlistVsone</span><span class="p">)</span>
        <span class="n">top_aids_list_</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">nAnnotPerName</span><span class="p">)</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">top_aids_list</span><span class="p">]</span>
        <span class="n">top_aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">top_aids_list_</span><span class="p">)</span>
        <span class="n">top_H_list</span>   <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">chipmatch</span><span class="o">.</span><span class="n">aid2_H</span><span class="p">,</span> <span class="n">top_aid_list</span><span class="p">)</span>
        <span class="n">daids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_aid_list</span><span class="p">)</span>
        <span class="n">Hs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_H_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qaid_list</span><span class="p">,</span> <span class="n">daids_list</span><span class="p">,</span> <span class="n">Hs_list</span>


<span class="c">#@profile</span></div>
<div class="viewcode-block" id="execute_vsone_reranking"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.vsone_pipeline.execute_vsone_reranking">[docs]</a><span class="k">def</span> <span class="nf">execute_vsone_reranking</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">qaid_list</span><span class="p">,</span> <span class="n">daids_list_</span><span class="p">,</span> <span class="n">Hs_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot; runs several pairs of (qaid, daids) vsone matches &quot;&quot;&quot;</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span>
    <span class="c"># For each qaid, daids pair in the lists, execute a query</span>
    <span class="n">vsone_iter</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">daids_list_</span><span class="p">,</span> <span class="n">Hs_list</span><span class="p">)</span>
    <span class="n">progkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lbl</span><span class="o">=</span><span class="s">&#39;VSONE RERANKING&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">vsone_prog_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgressIter</span><span class="p">(</span><span class="n">vsone_iter</span><span class="p">,</span> <span class="n">nTotal</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">),</span> <span class="o">**</span><span class="n">progkw</span><span class="p">)</span>
    <span class="n">daid_score_fm_fsv_tup_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">single_vsone_query</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">H_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">H_list</span><span class="p">)</span> <span class="ow">in</span> <span class="n">vsone_prog_iter</span>
    <span class="p">]</span>
    <span class="c"># Unpack results into their respective types</span>
    <span class="n">daids_list</span>   <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">daid_score_fm_fsv_tup_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">scores_list</span>  <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">daid_score_fm_fsv_tup_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">fms_list</span>     <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">daid_score_fm_fsv_tup_list</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">fsvs_list</span>    <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">daid_score_fm_fsv_tup_list</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">vsone_res_tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">daids_list</span><span class="p">,</span> <span class="n">scores_list</span><span class="p">,</span> <span class="n">fms_list</span><span class="p">,</span> <span class="n">fsvs_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vsone_res_tup</span>

</div>
<span class="nd">@profile</span>
<div class="viewcode-block" id="single_vsone_query"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.vsone_pipeline.single_vsone_query">[docs]</a><span class="k">def</span> <span class="nf">single_vsone_query</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">H_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        qaid (int):  query annotation id</span>
<span class="sd">        daid_list (list):</span>
<span class="sd">        H_list (list):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.model.hots.vsone_pipeline --test-single_vsone_query</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.model.hots.vsone_pipeline import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; qaid = 1</span>
<span class="sd">        &gt;&gt;&gt; daid_list = [3, 2, 5, 4]</span>
<span class="sd">        &gt;&gt;&gt; H_list = [</span>
<span class="sd">        ...  np.array([[ -4.68815126e-01,   7.80306795e-02,  -2.23674587e+01],</span>
<span class="sd">        ...            [  4.54394231e-02,  -7.67438835e-01,   5.92158624e+01],</span>
<span class="sd">        ...            [  2.12918867e-04,  -8.64851418e-05,  -6.21472492e-01]]),</span>
<span class="sd">        ...  np.array([[  5.11319128e-01,  -2.69211436e-04,  -3.18079183e+01],</span>
<span class="sd">        ...            [ -5.97449121e-02,   4.67044573e-01,   5.27655556e+01],</span>
<span class="sd">        ...            [  1.06650025e-04,   8.70310639e-05,   5.28664052e-01]]),</span>
<span class="sd">        ...  np.array([[  4.47902439e-01,  -1.79874835e-01,  -1.88314836e-01],</span>
<span class="sd">        ...            [ -2.61825221e-02,   3.59390616e-01,   6.47754036e+01],</span>
<span class="sd">        ...            [ -1.02783595e-04,  -5.74416869e-04,   6.88664085e-01]]),</span>
<span class="sd">        ...  np.array([[  4.94544421e-01,   2.05268712e-01,  -5.35167763e+01],</span>
<span class="sd">        ...            [ -1.99183336e-01,   7.97940559e-01,  -2.45807386e+01],</span>
<span class="sd">        ...            [ -4.60593287e-04,   1.36874405e-03,   3.83659263e-01]])]</span>
<span class="sd">        &gt;&gt;&gt; #species = ibeis.const.Species.ZEB_PLAIN</span>
<span class="sd">        &gt;&gt;&gt; #dstncvs_normer = distinctiveness_normalizer.request_species_distinctiveness_normalizer(species)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; daid_fm_fs_score_tup = single_vsone_query(ibs, qaid, daid_list, H_list)</span>
<span class="sd">        &gt;&gt;&gt; daid_list, fm_list, fs_list, score_list = daid_fm_fs_score_tup</span>
<span class="sd">        &gt;&gt;&gt; print(score_list)</span>

<span class="sd">    Ignore:</span>
<span class="sd">        from ibeis.viz import viz_sver</span>
<span class="sd">        import plottool as pt</span>

<span class="sd">        next_pnum = pt.make_pnum_nextgen(*pt.get_square_row_cols(len(daid_list)))</span>
<span class="sd">        for fm, daid, H in zip(fm_SCR_list, daid_list, H_list):</span>
<span class="sd">            viz_sver.show_constrained_match(ibs, qaid, daid, H, fm, pnum=next_pnum())</span>
<span class="sd">        pt.update()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.model.hots</span> <span class="kn">import</span> <span class="n">name_scoring</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;==================&#39;</span><span class="p">)</span>
    <span class="n">fm_list</span><span class="p">,</span> <span class="n">fs_list</span> <span class="o">=</span> <span class="n">compute_query_matches</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">H_list</span><span class="p">)</span>  <span class="c"># 35.8</span>
    <span class="c"># BIG MEMORY JUMP HERE</span>
    <span class="c">#cov_score_list = compute_image_coverage_score(ibs, qaid, daid_list, fm_list, fs_list)  # 64.2</span>
    <span class="n">cov_score_list</span> <span class="o">=</span> <span class="n">compute_grid_coverage_score</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">,</span> <span class="n">fs_list</span><span class="p">)</span>  <span class="c"># 64.2</span>
    <span class="n">NAME_SCORING</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">NAME_SCORING</span><span class="p">:</span>
        <span class="c"># Keep only the best annotation per name</span>
        <span class="n">nscore_tup</span> <span class="o">=</span> <span class="n">name_scoring</span><span class="o">.</span><span class="n">group_scores_by_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">cov_score_list</span><span class="p">)</span>
        <span class="n">score_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                                 <span class="k">for</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">nscore_tup</span><span class="o">.</span><span class="n">sorted_scores</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score_list</span> <span class="o">=</span> <span class="n">cov_score_list</span>
    <span class="c"># Convert our one score to a score vector here</span>
    <span class="n">num_matches_iter</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">)</span>
    <span class="n">num_filts</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c"># currently only using one vector here.</span>
    <span class="n">fsv_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fs</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">num_matches</span><span class="p">,</span> <span class="n">num_filts</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">fs</span><span class="p">,</span> <span class="n">num_matches</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fs_list</span><span class="p">,</span> <span class="n">num_matches_iter</span><span class="p">)]</span>
    <span class="n">daid_score_fm_fsv_tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">score_list</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">,</span> <span class="n">fsv_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">daid_score_fm_fsv_tup</span>

</div>
<span class="nd">@profile</span>
<div class="viewcode-block" id="compute_query_matches"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.vsone_pipeline.compute_query_matches">[docs]</a><span class="k">def</span> <span class="nf">compute_query_matches</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">H_list</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot; calls specified vsone matching routine for single (qaid, daids) pair &quot;&quot;&quot;</span>
    <span class="c"># TODO: implement unconstrained regular vsone</span>
    <span class="n">fm_list</span><span class="p">,</span> <span class="n">fs_list</span> <span class="o">=</span> <span class="n">compute_query_constrained_matches</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">H_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fm_list</span><span class="p">,</span> <span class="n">fs_list</span>

</div>
<span class="nd">@profile</span>
<div class="viewcode-block" id="compute_query_constrained_matches"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.vsone_pipeline.compute_query_constrained_matches">[docs]</a><span class="k">def</span> <span class="nf">compute_query_constrained_matches</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">H_list</span><span class="p">):</span>
    <span class="n">flann_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s">&#39;kdtree&#39;</span><span class="p">,</span>
        <span class="s">&#39;trees&#39;</span><span class="p">:</span> <span class="mi">8</span>
    <span class="p">}</span>
    <span class="n">match_xy_thresh</span> <span class="o">=</span> <span class="o">.</span><span class="mo">05</span>
    <span class="n">ratio_thresh2</span> <span class="o">=</span> <span class="o">.</span><span class="mi">7</span>
    <span class="n">K</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">qvecs</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">(</span><span class="n">qaid</span><span class="p">)</span>
    <span class="n">qkpts</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_kpts</span><span class="p">(</span><span class="n">qaid</span><span class="p">)</span>
    <span class="n">flann_cachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_flann_cachedir</span><span class="p">()</span>
    <span class="n">flann</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">flann_cache</span><span class="p">(</span><span class="n">qvecs</span><span class="p">,</span> <span class="n">flann_cachedir</span><span class="p">,</span> <span class="n">flann_params</span><span class="o">=</span><span class="n">flann_params</span><span class="p">,</span>
                           <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">fm_SCR_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fs_SCR_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dvecs_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">(</span><span class="n">daid_list</span><span class="p">)</span>
    <span class="n">dkpts_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_kpts</span><span class="p">(</span><span class="n">daid_list</span><span class="p">)</span>
    <span class="n">dfgws_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_fgweights</span><span class="p">(</span><span class="n">daid_list</span><span class="p">)</span>
    <span class="n">dlen_sqrd_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chip_dlen_sqrd</span><span class="p">(</span><span class="n">daid_list</span><span class="p">)</span>
    <span class="n">dinfo_list</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dvecs_list</span><span class="p">,</span> <span class="n">dkpts_list</span><span class="p">,</span> <span class="n">dfgws_list</span><span class="p">,</span> <span class="n">dlen_sqrd_list</span><span class="p">,</span> <span class="n">H_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">daid</span><span class="p">,</span> <span class="n">dinfo</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">dinfo_list</span><span class="p">):</span>
        <span class="c"># THIS CAN BE SWAPED WITH PURE RATIO TEST</span>
        <span class="c"># ALSO, SVER CAN BE ADDED ON THE END</span>
        <span class="n">dvecs</span><span class="p">,</span> <span class="n">dkpts</span><span class="p">,</span> <span class="n">dfgws</span><span class="p">,</span> <span class="n">dlen_sqrd</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="n">dinfo</span>
        <span class="n">fm_SCR</span><span class="p">,</span> <span class="n">fs_SCR</span> <span class="o">=</span> <span class="n">spatially_constrained_match</span><span class="p">(</span>
            <span class="n">flann</span><span class="p">,</span> <span class="n">dvecs</span><span class="p">,</span> <span class="n">qkpts</span><span class="p">,</span> <span class="n">dkpts</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">dlen_sqrd</span><span class="p">,</span> <span class="n">match_xy_thresh</span><span class="p">,</span>
            <span class="n">ratio_thresh2</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
        <span class="n">fm_SCR_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fm_SCR</span><span class="p">)</span>
        <span class="n">fs_SCR_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fs_SCR</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">flann</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;---------------- ;)(&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fm_SCR_list</span><span class="p">,</span> <span class="n">fs_SCR_list</span>

</div>
<div class="viewcode-block" id="testdata_scoring"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.vsone_pipeline.testdata_scoring">[docs]</a><span class="k">def</span> <span class="nf">testdata_scoring</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">ibeis</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="s">&#39;testdb1&#39;</span><span class="p">)</span>
    <span class="n">cfgdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dupvote_weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">prescore_method</span><span class="o">=</span><span class="s">&#39;nsum&#39;</span><span class="p">,</span> <span class="n">score_method</span><span class="o">=</span><span class="s">&#39;nsum&#39;</span><span class="p">,</span> <span class="n">sver_weighting</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">qaid</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">qaid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">qaid</span><span class="p">]</span>
    <span class="c"># VSMANY TO GET HOMOG</span>
    <span class="n">ibs</span><span class="p">,</span> <span class="n">qreq_</span> <span class="o">=</span> <span class="n">plh</span><span class="o">.</span><span class="n">get_pipeline_testdata</span><span class="p">(</span><span class="s">&#39;PZ_MTEST&#39;</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="n">cfgdict</span><span class="p">,</span> <span class="n">qaid_list</span><span class="o">=</span><span class="n">qaid_list</span><span class="p">)</span>
    <span class="n">locals_</span> <span class="o">=</span> <span class="n">plh</span><span class="o">.</span><span class="n">testrun_pipeline_upto</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="s">&#39;chipmatch_to_resdict&#39;</span><span class="p">)</span>
    <span class="n">qaid2_chipmatch</span> <span class="o">=</span> <span class="n">locals_</span><span class="p">[</span><span class="s">&#39;qaid2_chipmatch_SVER&#39;</span><span class="p">]</span>
    <span class="n">qaid_list</span><span class="p">,</span> <span class="n">top_aids_list</span><span class="p">,</span> <span class="n">top_Hs_list</span> <span class="o">=</span> <span class="n">make_vsone_rerank_pairs</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">qaid2_chipmatch</span><span class="p">)</span>
    <span class="n">qaid</span> <span class="o">=</span> <span class="n">qaid_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">daid_list</span> <span class="o">=</span> <span class="n">top_aids_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">H_list</span> <span class="o">=</span> <span class="n">top_Hs_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c"># run vsone</span>
    <span class="n">fm_list</span><span class="p">,</span> <span class="n">fs_list</span> <span class="o">=</span> <span class="n">compute_query_matches</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">H_list</span><span class="p">)</span>  <span class="c"># 35.8</span>
    <span class="k">return</span> <span class="n">ibs</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">,</span> <span class="n">fs_list</span>
    <span class="c">#qaid = qaid_list[0]</span>
    <span class="c">#chipmatch = qaid2_chipmatch[qaid]</span>
    <span class="c">#fm = chipmatch.aid2_fm[daid]</span>
    <span class="c">#fsv = chipmatch.aid2_fsv[daid]</span>

</div>
<span class="nd">@profile</span>
<span class="c">#@ut.memprof</span>
<div class="viewcode-block" id="compute_image_coverage_score"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.vsone_pipeline.compute_image_coverage_score">[docs]</a><span class="k">def</span> <span class="nf">compute_image_coverage_score</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">,</span> <span class="n">fs_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a grayscale chip match which represents which pixels</span>
<span class="sd">    should be matches in order for a candidate to be considered a match.</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.model.hots.vsone_pipeline --test-compute_image_coverage_score</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.model.hots.vsone_pipeline import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs, qaid, daid_list, fm_list, fs_list = testdata_scoring()</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; score_list = compute_image_coverage_score(ibs, qaid, daid_list, fm_list, fs_list)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = str(score_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>

<span class="sd">    Ignore:</span>
<span class="sd">        import plottool as pt</span>
<span class="sd">        pt.imshow(weight_mask * 255, update=True, fnum=2)</span>
<span class="sd">        pt.imshow(weight_mask_m * 255, update=True, fnum=3)</span>
<span class="sd">        pt.imshow(weight_color * 255, update=True, fnum=3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Distinctivness Weight</span>
    <span class="c">#  Hits     Time     Per Hit    %Time</span>
    <span class="c">#     3      7213349 2404449.7     28.6</span>
    <span class="n">qdstncvs</span>  <span class="o">=</span> <span class="n">get_kpts_distinctiveness</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="p">[</span><span class="n">qaid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c">#  Hits     Time     Per Hit    %Time</span>
    <span class="c">#     3     14567165 4855721.7     57.8</span>
    <span class="n">ddstncvs_list</span>  <span class="o">=</span> <span class="n">get_kpts_distinctiveness</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">)</span>
    <span class="c"># Foreground weight</span>
    <span class="n">qfgweight</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_fgweights</span><span class="p">([</span><span class="n">qaid</span><span class="p">],</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dfgweight_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_fgweights</span><span class="p">(</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># Make weight mask</span>
    <span class="n">qchipsize</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chipsizes</span><span class="p">(</span><span class="n">qaid</span><span class="p">)</span>
    <span class="n">qchipshape</span> <span class="o">=</span> <span class="n">qchipsize</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">qkpts</span>     <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_kpts</span><span class="p">(</span><span class="n">qaid</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;max&#39;</span>
    <span class="c"># Foregroundness*Distinctiveness weight mask</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">qfgweight</span> <span class="o">*</span> <span class="n">qdstncvs</span><span class="p">)</span> <span class="o">**</span> <span class="o">.</span><span class="mi">5</span>
    <span class="c">#  Hits     Time     Per Hit    %Time</span>
    <span class="c">#    3      2298873 766291.0      9.1</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;==--==--==--==--==--==&#39;</span><span class="p">)</span>
    <span class="n">weight_mask</span><span class="p">,</span> <span class="n">patch</span> <span class="o">=</span> <span class="n">coverage_image</span><span class="o">.</span><span class="n">make_coverage_mask</span><span class="p">(</span>
        <span class="n">qkpts</span><span class="p">,</span> <span class="n">qchipsize</span><span class="p">,</span> <span class="n">fx2_score</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>  <span class="c"># 9% of the time</span>
    <span class="c">#print(&#39;==--==--==--==--==--==&#39;)</span>
    <span class="c">#10 loops, best of 3: 116 ms per loop</span>
    <span class="n">weight_mask</span><span class="p">,</span> <span class="n">patch</span> <span class="o">=</span> <span class="n">coverage_image</span><span class="o">.</span><span class="n">make_coverage_mask</span><span class="p">(</span><span class="n">qkpts</span><span class="p">,</span> <span class="n">qchipshape</span><span class="p">,</span> <span class="n">fx2_score</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>  <span class="c"># 9% of the time</span>
    <span class="c"># Apply weighted scoring to matches</span>
    <span class="n">score_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fm</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">ddstncvs</span><span class="p">,</span> <span class="n">dfgweight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">fs_list</span><span class="p">,</span> <span class="n">ddstncvs_list</span><span class="p">,</span> <span class="n">dfgweight_list</span><span class="p">):</span>
        <span class="c"># Get matching query keypoints</span>
        <span class="n">qkpts_m</span>     <span class="o">=</span> <span class="n">qkpts</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ddstncvs_m</span>  <span class="o">=</span> <span class="n">ddstncvs</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dfgweight_m</span> <span class="o">=</span> <span class="n">dfgweight</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">qdstncvs_m</span>  <span class="o">=</span> <span class="n">qdstncvs</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">qfgweight_m</span> <span class="o">=</span> <span class="n">qfgweight</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">weights_m</span> <span class="o">=</span> <span class="n">fs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">qdstncvs_m</span> <span class="o">*</span> <span class="n">ddstncvs_m</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">qfgweight_m</span> <span class="o">*</span> <span class="n">dfgweight_m</span><span class="p">)</span>
        <span class="c"># Hits     Time     Per Hit    %Time</span>
        <span class="c">#  46      1000214  21743.8      4.0</span>
        <span class="n">weight_mask_m</span><span class="p">,</span> <span class="n">patch</span> <span class="o">=</span> <span class="n">coverage_image</span><span class="o">.</span><span class="n">make_coverage_mask</span><span class="p">(</span>
            <span class="n">qkpts_m</span><span class="p">,</span> <span class="n">qchipshape</span><span class="p">,</span> <span class="n">fx2_score</span><span class="o">=</span><span class="n">weights_m</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>  <span class="c"># 4% of the time</span>
        <span class="c">#if True:</span>
        <span class="c">#    stacktup = (weight_mask, np.zeros(weight_mask.shape), weight_mask_m)</span>
        <span class="c">#    weight_color = np.dstack(stacktup)</span>
        <span class="n">coverage_score</span> <span class="o">=</span> <span class="n">weight_mask_m</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">weight_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">weights_m</span>
        <span class="k">del</span> <span class="n">weight_mask_m</span>
        <span class="n">score_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coverage_score</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">weight_mask</span>
    <span class="k">return</span> <span class="n">score_list</span>

</div>
<span class="nd">@profile</span>
<div class="viewcode-block" id="compute_grid_coverage_score"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.vsone_pipeline.compute_grid_coverage_score">[docs]</a><span class="k">def</span> <span class="nf">compute_grid_coverage_score</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaid</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">,</span> <span class="n">fs_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.model.hots.vsone_pipeline --test-compute_grid_coverage_score</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.model.hots.vsone_pipeline import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs, qaid, daid_list, fm_list, fs_list = testdata_scoring()</span>
<span class="sd">        &gt;&gt;&gt; score_list = compute_grid_coverage_score(ibs, qaid, daid_list, fm_list, fs_list)</span>
<span class="sd">        &gt;&gt;&gt; print(score_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qdstncvs</span>  <span class="o">=</span> <span class="n">get_kpts_distinctiveness</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="p">[</span><span class="n">qaid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ddstncvs_list</span>  <span class="o">=</span> <span class="n">get_kpts_distinctiveness</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">)</span>
    <span class="c"># Foreground weight</span>
    <span class="n">qfgweight</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_fgweights</span><span class="p">([</span><span class="n">qaid</span><span class="p">],</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dfgweight_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_fgweights</span><span class="p">(</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># Make weight mask</span>
    <span class="n">chipsize</span> <span class="o">=</span> <span class="n">qchipsize</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chipsizes</span><span class="p">(</span><span class="n">qaid</span><span class="p">)</span>  <span class="c"># NOQA</span>
    <span class="n">kpts</span> <span class="o">=</span> <span class="n">qkpts</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_kpts</span><span class="p">(</span><span class="n">qaid</span><span class="p">)</span>  <span class="c"># NOQA</span>
    <span class="c">#mode = &#39;max&#39;</span>
    <span class="c"># Foregroundness*Distinctiveness weight mask</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">qfgweight</span> <span class="o">*</span> <span class="n">qdstncvs</span><span class="p">)</span> <span class="o">**</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">gridcfg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">resize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">grid_scale_factor</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">grid_steps</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    <span class="c">#exec(ut.util_dbg.execstr_dict(gridcfg), globals(), locals())</span>
    <span class="c"># 100 loops, best of 3: 10.9 ms per loop</span>
    <span class="n">weight_mask</span> <span class="o">=</span> <span class="n">coverage_image</span><span class="o">.</span><span class="n">get_grid_coverage_mask</span><span class="p">(</span><span class="n">kpts</span><span class="p">,</span> <span class="n">chipsize</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="o">**</span><span class="n">gridcfg</span><span class="p">)</span>
    <span class="c"># Prealloc data for loop</span>
    <span class="n">weight_mask_m</span> <span class="o">=</span> <span class="n">weight_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c"># Apply weighted scoring to matches</span>
    <span class="n">score_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fm</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">ddstncvs</span><span class="p">,</span> <span class="n">dfgweight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">fs_list</span><span class="p">,</span> <span class="n">ddstncvs_list</span><span class="p">,</span> <span class="n">dfgweight_list</span><span class="p">):</span>
        <span class="c"># Get matching query keypoints</span>
        <span class="n">qkpts_m</span>     <span class="o">=</span> <span class="n">qkpts</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ddstncvs_m</span>  <span class="o">=</span> <span class="n">ddstncvs</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dfgweight_m</span> <span class="o">=</span> <span class="n">dfgweight</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">qdstncvs_m</span>  <span class="o">=</span> <span class="n">qdstncvs</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">qfgweight_m</span> <span class="o">=</span> <span class="n">qfgweight</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">weights_m</span> <span class="o">=</span> <span class="n">fs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">qdstncvs_m</span> <span class="o">*</span> <span class="n">ddstncvs_m</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">qfgweight_m</span> <span class="o">*</span> <span class="n">dfgweight_m</span><span class="p">)</span>
        <span class="n">weight_mask_m</span> <span class="o">=</span> <span class="n">coverage_image</span><span class="o">.</span><span class="n">get_grid_coverage_mask</span><span class="p">(</span>
            <span class="n">qkpts_m</span><span class="p">,</span> <span class="n">chipsize</span><span class="p">,</span> <span class="n">weights_m</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">weight_mask_m</span><span class="p">,</span> <span class="o">**</span><span class="n">gridcfg</span><span class="p">)</span>  <span class="c"># 4% of the time</span>
        <span class="n">coverage_score</span> <span class="o">=</span> <span class="n">weight_mask_m</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">weight_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">score_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coverage_score</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">score_list</span>

</div>
<span class="nd">@profile</span>
<div class="viewcode-block" id="spatially_constrained_match"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.vsone_pipeline.spatially_constrained_match">[docs]</a><span class="k">def</span> <span class="nf">spatially_constrained_match</span><span class="p">(</span><span class="n">flann</span><span class="p">,</span> <span class="n">dvecs</span><span class="p">,</span> <span class="n">qkpts</span><span class="p">,</span> <span class="n">dkpts</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">dlen_sqrd</span><span class="p">,</span>
                                <span class="n">match_xy_thresh</span><span class="p">,</span> <span class="n">ratio_thresh2</span><span class="p">,</span>  <span class="n">K</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">vtool</span> <span class="kn">import</span> <span class="n">constrained_matching</span>
    <span class="c"># Find candidate matches matches</span>
    <span class="c">#  Hits     Time     Per Hit    %Time</span>
    <span class="c">#    46     13082250 284396.7     94.6</span>
    <span class="n">dfx2_qfx</span><span class="p">,</span> <span class="n">_dfx2_dist</span> <span class="o">=</span> <span class="n">flann</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">dvecs</span><span class="p">,</span> <span class="n">num_neighbors</span><span class="o">=</span><span class="n">K</span><span class="p">,</span> <span class="n">checks</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
    <span class="n">dfx2_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">_dfx2_dist</span><span class="p">,</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">VEC_PSEUDO_MAX_DISTANCE_SQRD</span><span class="p">)</span>
    <span class="c"># Remove infeasible matches</span>
    <span class="n">constraintup</span> <span class="o">=</span> <span class="n">constrained_matching</span><span class="o">.</span><span class="n">spatially_constrain_matches</span><span class="p">(</span>
        <span class="n">dlen_sqrd</span><span class="p">,</span> <span class="n">qkpts</span><span class="p">,</span> <span class="n">dkpts</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">dfx2_qfx</span><span class="p">,</span> <span class="n">dfx2_dist</span><span class="p">,</span> <span class="n">match_xy_thresh</span><span class="p">,</span>
        <span class="n">normalizer_mode</span><span class="o">=</span><span class="s">&#39;far&#39;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">fm_SC</span><span class="p">,</span> <span class="n">fm_norm_SC</span><span class="p">,</span> <span class="n">match_dist_list</span><span class="p">,</span> <span class="n">norm_dist_list</span><span class="p">)</span> <span class="o">=</span> <span class="n">constraintup</span>
    <span class="n">fs_SC</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">match_dist_list</span><span class="p">,</span> <span class="n">norm_dist_list</span><span class="p">)</span>   <span class="c"># NOQA</span>
    <span class="c"># Given matching distance and normalizing distance, filter by ratio scores</span>
    <span class="n">fm_SCR</span><span class="p">,</span> <span class="n">fs_SCR</span><span class="p">,</span> <span class="n">fm_norm_SCR</span> <span class="o">=</span> <span class="n">constrained_matching</span><span class="o">.</span><span class="n">ratio_test2</span><span class="p">(</span>
        <span class="n">match_dist_list</span><span class="p">,</span> <span class="n">norm_dist_list</span><span class="p">,</span> <span class="n">fm_SC</span><span class="p">,</span> <span class="n">fm_norm_SC</span><span class="p">,</span> <span class="n">ratio_thresh2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fm_SCR</span><span class="p">,</span> <span class="n">fs_SCR</span>

</div>
<span class="nd">@profile</span>
<div class="viewcode-block" id="get_kpts_distinctiveness"><a class="viewcode-back" href="../../../../ibeis.model.hots.html#ibeis.model.hots.vsone_pipeline.get_kpts_distinctiveness">[docs]</a><span class="k">def</span> <span class="nf">get_kpts_distinctiveness</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    per-species disinctivness wrapper around ibeis cached function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">sid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
    <span class="c"># Compute distinctivness separately for each species</span>
    <span class="n">unique_sids</span><span class="p">,</span> <span class="n">groupxs</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">group_indicies</span><span class="p">(</span><span class="n">sid_list</span><span class="p">)</span>
    <span class="n">aids_groups</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">groupxs</span><span class="p">)</span>
    <span class="n">species_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_texts</span><span class="p">(</span><span class="n">unique_sids</span><span class="p">)</span>
    <span class="c"># Map distinctivness computation</span>
    <span class="n">normer_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">distinctiveness_normalizer</span><span class="o">.</span><span class="n">request_species_distinctiveness_normalizer</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_text_list</span><span class="p">]</span>
    <span class="c"># Reduce to get results</span>
    <span class="n">dstncvs_groups</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c"># uses ibeis non-persistant cache</span>
        <span class="c"># code lives in manual_ibeiscontrol_funcs</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_kpts_distinctiveness</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">dstncvs_normer</span><span class="o">=</span><span class="n">dstncvs_normer</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dstncvs_normer</span><span class="p">,</span> <span class="n">aids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">normer_list</span><span class="p">,</span> <span class="n">aids_groups</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">dstncvs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">invert_apply_grouping</span><span class="p">(</span><span class="n">dstncvs_groups</span><span class="p">,</span> <span class="n">groupxs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dstncvs_list</span>

</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.model.hots.vsone_pipeline</span>
<span class="sd">        python -m ibeis.model.hots.vsone_pipeline --allexamples</span>
<span class="sd">        python -m ibeis.model.hots.vsone_pipeline --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>  <span class="c"># NOQA</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">ibeis 0.1.0.dev1 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../../ibeis.html" >ibeis</a> &raquo;</li>
          <li><a href="../../model.html" >ibeis.model</a> &raquo;</li>
          <li><a href="../hots.html" >ibeis.model.hots</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Jon Crall.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>