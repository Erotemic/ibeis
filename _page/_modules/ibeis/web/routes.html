

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ibeis.web.routes &mdash; ibeis 1.8.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="ibeis 1.8.1 documentation" href="../../../index.html"/>
        <link rel="up" title="ibeis" href="../../ibeis.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> ibeis
          

          
          </a>

          
            
            
              <div class="version">
                1.8.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ibeis.html">ibeis package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ibeis</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../ibeis.html">ibeis</a> &raquo;</li>
        
      <li>ibeis.web.routes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ibeis.web.routes</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Dependencies: flask, tornado</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">simplejson</span> <span class="k">as</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">current_app</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">ibeis.control</span> <span class="k">import</span> <span class="n">controller_inject</span>
<span class="kn">from</span> <span class="nn">ibeis</span> <span class="k">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">ibeis.constants</span> <span class="k">import</span> <span class="n">KEY_DEFAULTS</span><span class="p">,</span> <span class="n">SPECIES_KEY</span>
<span class="kn">from</span> <span class="nn">ibeis.web</span> <span class="k">import</span> <span class="n">appfuncs</span> <span class="k">as</span> <span class="n">appf</span>
<span class="kn">from</span> <span class="nn">ibeis.web</span> <span class="k">import</span> <span class="n">routes_ajax</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="n">CLASS_INJECT_KEY</span><span class="p">,</span> <span class="n">register_ibs_method</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">controller_inject</span><span class="o">.</span><span class="n">make_ibs_register_decorator</span><span class="p">(</span><span class="vm">__name__</span><span class="p">))</span>
<span class="n">register_route</span> <span class="o">=</span> <span class="n">controller_inject</span><span class="o">.</span><span class="n">get_ibeis_flask_route</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="n">THROW_TEST_AOI_TURKING</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">THROW_TEST_AOI_TURKING_PERCENTAGE</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">THROW_TEST_AOI_TURKING_ERROR_MODES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;addition&#39;</span>   <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="s1">&#39;deletion&#39;</span>   <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="s1">&#39;alteration&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="s1">&#39;translation&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>


<span class="n">GLOBAL_FEEDBACK_LIMIT</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">GLOBAL_FEEDBACK_BUFFER</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">GLOBAL_FEEDBACK_CONFIG_DICT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ranks_top&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;ranks_bot&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>

    <span class="s1">&#39;score_thresh&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;max_num&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>

    <span class="s1">&#39;filter_reviewed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;filter_photobombs&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>

    <span class="s1">&#39;filter_true_matches&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;filter_false_matches&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>

    <span class="s1">&#39;filter_nonmatch_between_ccs&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;filter_dup_namepairs&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="root"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.root">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">],</span> <span class="n">__route_authenticate__</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">root</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>
    <span class="n">dbdir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbdir</span>

    <span class="n">embedded</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">globals</span><span class="p">(),</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">embedded</span><span class="p">)</span></div>


<div class="viewcode-block" id="login"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.login">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/login/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">],</span> <span class="n">__route_authenticate__</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">refer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># Default refer</span>
    <span class="k">if</span> <span class="n">refer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">refer</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">refer</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">decode_refer_url</span><span class="p">(</span><span class="n">refer</span><span class="p">)</span>

    <span class="c1"># Prevent loops</span>
    <span class="k">if</span> <span class="n">refer</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
        <span class="n">refer</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">controller_inject</span><span class="o">.</span><span class="n">authenticated</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">refer</span><span class="p">)</span>

    <span class="n">refer</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">encode_refer_url</span><span class="p">(</span><span class="n">refer</span><span class="p">)</span>

    <span class="n">organization_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;rpi&#39;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s1">&#39;RPI&#39;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="c1"># &#39;jason.parham&#39;,</span>
                <span class="s1">&#39;chuck.stewart&#39;</span><span class="p">,</span>
                <span class="s1">&#39;hendrik.weideman&#39;</span><span class="p">,</span>
                <span class="s1">&#39;angela.su&#39;</span><span class="p">,</span>
                <span class="s1">&#39;joshua.beard&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="s1">&#39;uic&#39;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s1">&#39;UIC&#39;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s1">&#39;tanya.berger-wolf&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mosheh.berger-wolf&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ivan.brugere&#39;</span><span class="p">,</span>
                <span class="s1">&#39;chainarong.amornbunchornvej&#39;</span><span class="p">,</span>
                <span class="s1">&#39;jia.li&#39;</span><span class="p">,</span>
                <span class="s1">&#39;aynaz.taheri&#39;</span><span class="p">,</span>
                <span class="s1">&#39;james.searing&#39;</span><span class="p">,</span>
                <span class="s1">&#39;lorenzo.semeria&#39;</span><span class="p">,</span>
                <span class="s1">&#39;matteo.foglio&#39;</span><span class="p">,</span>
                <span class="s1">&#39;eleonora.darnese &#39;</span><span class="p">,</span>
                <span class="s1">&#39;guido.muscioni&#39;</span><span class="p">,</span>
                <span class="s1">&#39;riccardo.pressiani&#39;</span><span class="p">,</span>
                <span class="s1">&#39;krishna.chandu&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mathew.yang&#39;</span><span class="p">,</span>
                <span class="s1">&#39;nathan.seitz&#39;</span><span class="p">,</span>
                <span class="s1">&#39;luis.love&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ashley.riley&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="s1">&#39;princeton&#39;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s1">&#39;Princeton&#39;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s1">&#39;dan.rubenstein&#39;</span><span class="p">,</span>
                <span class="s1">&#39;kaia.tombak&#39;</span><span class="p">,</span>
                <span class="s1">&#39;andrew.gersick&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ryan.herbert&#39;</span><span class="p">,</span>
                <span class="s1">&#39;joe.bakcoleman&#39;</span><span class="p">,</span>
                <span class="s1">&#39;lisa.pbryan&#39;</span><span class="p">,</span>
                <span class="s1">&#39;jackie.kariithi&#39;</span><span class="p">,</span>
                <span class="s1">&#39;megan.mcsherry&#39;</span><span class="p">,</span>
                <span class="s1">&#39;qing.cao&#39;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">),</span>
        <span class="s1">&#39;wildme&#39;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s1">&#39;Wild Me&#39;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s1">&#39;jason.holmberg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;jason.parham&#39;</span><span class="p">,</span>
                <span class="s1">&#39;jon.vanoast&#39;</span><span class="p">,</span>
                <span class="s1">&#39;colin.kingen&#39;</span><span class="p">,</span>
                <span class="s1">&#39;drew.blount&#39;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">),</span>
        <span class="s1">&#39;kitware&#39;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s1">&#39;Kitware&#39;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s1">&#39;jon.crall&#39;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">),</span>
        <span class="s1">&#39;ctrl-h&#39;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s1">&#39;CTRL-H&#39;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s1">&#39;jon.hannis&#39;</span><span class="p">,</span>
                <span class="s1">&#39;melinda.hannis&#39;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">),</span>
    <span class="p">}</span>
    <span class="n">organization_dict_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">organization_dict</span><span class="p">)</span>

    <span class="n">embedded</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">globals</span><span class="p">(),</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">embedded</span><span class="p">)</span></div>


<div class="viewcode-block" id="logout"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.logout">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/logout/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">],</span> <span class="n">__route_authenticate__</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">controller_inject</span><span class="o">.</span><span class="n">deauthenticate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="view"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.view">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/view/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="n">ibs</span><span class="o">.</span><span class="n">update_all_image_special_imageset</span><span class="p">()</span>
    <span class="n">imgsetids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_imgsetids</span><span class="p">()</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span>
                         <span class="n">num_imgsetids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">imgsetids_list</span><span class="p">),</span>
                         <span class="n">num_gids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
                         <span class="n">num_aids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
                         <span class="n">num_nids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">))</span></div>


<div class="viewcode-block" id="view_viewpoints"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.view_viewpoints">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/view/viewpoints/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">view_viewpoints</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">viewpoint_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoints</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>

    <span class="n">species_tag_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">species_list</span><span class="p">)))</span>
    <span class="n">species_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_rowids_from_text</span><span class="p">(</span><span class="n">species_tag_list</span><span class="p">)</span>
    <span class="n">species_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">species_tag_list</span><span class="p">)</span>
    <span class="n">species_nice_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">species_tag</span> <span class="p">:</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_nice</span><span class="p">(</span><span class="n">species_rowid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">species_tag</span><span class="p">,</span> <span class="n">species_rowid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_tag_list</span><span class="p">,</span> <span class="n">species_rowid_list</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="n">viewpoint_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">species</span><span class="p">,</span> <span class="n">viewpoint</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_list</span><span class="p">,</span> <span class="n">viewpoint_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">species</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">viewpoint_dict</span><span class="p">:</span>
                <span class="n">viewpoint_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">viewpoint</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">viewpoint_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]:</span>
                <span class="n">viewpoint_dict</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="n">viewpoint</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">viewpoint_dict</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="n">viewpoint</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">viewpoint_tag_list</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">VIEWTEXT_TO_VIEWPOINT_RADIANS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">pie_label_list</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">VIEWPOINTALIAS_NICE</span><span class="p">[</span><span class="n">_</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">viewpoint_tag_list</span> <span class="p">]</span>
    <span class="n">pie_values_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span>
            <span class="n">species_nice_dict</span><span class="p">[</span><span class="n">species</span><span class="p">],</span>
            <span class="p">[</span><span class="n">viewpoint_dict</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="n">_</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">viewpoint_tag_list</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_tag_list</span>
    <span class="p">]</span>

    <span class="n">viewpoint_order_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;frontleft&#39;</span><span class="p">,</span> <span class="s1">&#39;front&#39;</span><span class="p">,</span> <span class="s1">&#39;frontright&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;backright&#39;</span><span class="p">,</span> <span class="s1">&#39;back&#39;</span><span class="p">,</span> <span class="s1">&#39;backleft&#39;</span><span class="p">]</span>
    <span class="n">pie_left_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;frontleft&#39;</span><span class="p">,</span> <span class="s1">&#39;front&#39;</span><span class="p">,</span> <span class="s1">&#39;frontright&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;backright&#39;</span><span class="p">,</span> <span class="s1">&#39;back&#39;</span><span class="p">,</span> <span class="s1">&#39;backleft&#39;</span><span class="p">]</span>
    <span class="n">pie_right_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;backright&#39;</span><span class="p">,</span> <span class="s1">&#39;back&#39;</span><span class="p">,</span> <span class="s1">&#39;backleft&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;frontleft&#39;</span><span class="p">,</span> <span class="s1">&#39;front&#39;</span><span class="p">,</span> <span class="s1">&#39;frontright&#39;</span><span class="p">]</span>
    <span class="n">viewpoint_tag_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;zebra_grevys&#39;</span> <span class="p">:</span> <span class="n">pie_right_list</span><span class="p">,</span>
        <span class="s1">&#39;zebra_plains&#39;</span> <span class="p">:</span> <span class="n">pie_left_list</span><span class="p">,</span>
        <span class="s1">&#39;giraffe_masai&#39;</span> <span class="p">:</span> <span class="n">pie_left_list</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">pie_label_corrected_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span>
        <span class="nb">str</span><span class="p">,</span>
        <span class="p">[</span><span class="s1">&#39;Correct&#39;</span><span class="p">,</span> <span class="s1">&#39;+45&#39;</span><span class="p">,</span> <span class="s1">&#39;+90&#39;</span><span class="p">,</span> <span class="s1">&#39;+135&#39;</span><span class="p">,</span> <span class="s1">&#39;+180&#39;</span><span class="p">,</span> <span class="s1">&#39;+225&#39;</span><span class="p">,</span> <span class="s1">&#39;+270&#39;</span><span class="p">,</span> <span class="s1">&#39;+315&#39;</span><span class="p">]</span>
    <span class="p">))</span>
    <span class="n">pie_values_corrected_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span>
            <span class="n">species_nice_dict</span><span class="p">[</span><span class="n">species</span><span class="p">],</span>
            <span class="p">[</span><span class="n">viewpoint_dict</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="n">_</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">viewpoint_tag_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_tag_list</span>
    <span class="p">]</span>

    <span class="c1"># Get number of annotations per name as a histogram for each species</span>
    <span class="n">embedded</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">globals</span><span class="p">(),</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;viewpoints&#39;</span><span class="p">,</span>
                         <span class="n">__wrapper_header__</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">embedded</span><span class="p">)</span></div>


<div class="viewcode-block" id="view_advanced0"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.view_advanced0">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/view/advanced/0/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">view_advanced0</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_date_list</span><span class="p">(</span><span class="n">gid_list</span><span class="p">):</span>
        <span class="n">unixtime_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">datetime_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">unixtime_to_datetimestr</span><span class="p">(</span><span class="n">unixtime</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unixtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span>
            <span class="s1">&#39;UNKNOWN&#39;</span>
            <span class="k">for</span> <span class="n">unixtime</span> <span class="ow">in</span> <span class="n">unixtime_list</span>
        <span class="p">]</span>
        <span class="n">datetime_split_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">datetime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">datetime</span> <span class="ow">in</span> <span class="n">datetime_list</span> <span class="p">]</span>
        <span class="n">date_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">datetime_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datetime_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s1">&#39;UNKNOWN&#39;</span> <span class="k">for</span> <span class="n">datetime_split</span> <span class="ow">in</span> <span class="n">datetime_split_list</span> <span class="p">]</span>
        <span class="k">return</span> <span class="n">date_list</span>

    <span class="k">def</span> <span class="nf">filter_annots_imageset</span><span class="p">(</span><span class="n">aid_list</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imgsetid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imgsetid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">imgsetid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>
            <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_imgsetids</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">imgsetid</span> <span class="ow">in</span> <span class="n">imgsetid_list</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR PARSING IMAGESET ID FOR ANNOTATION FILTERING&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">aid_list</span>
        <span class="n">imgsetids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_imgsetids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">aid</span>
            <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">imgsetid_list_</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">imgsetids_list</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">imgsetid</span> <span class="ow">in</span> <span class="n">imgsetid_list_</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">aid_list</span>

    <span class="k">def</span> <span class="nf">filter_images_imageset</span><span class="p">(</span><span class="n">gid_list</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imgsetid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imgsetid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">imgsetid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>
            <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_imgsetids</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">imgsetid</span> <span class="ow">in</span> <span class="n">imgsetid_list</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR PARSING IMAGESET ID FOR IMAGE FILTERING&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">gid_list</span>
        <span class="n">imgsetids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_imgsetids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">gid</span>
            <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">imgsetid_list_</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">imgsetids_list</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">imgsetid</span> <span class="ow">in</span> <span class="n">imgsetid_list_</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">gid_list</span>

    <span class="k">def</span> <span class="nf">filter_names_imageset</span><span class="p">(</span><span class="n">nid_list</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imgsetid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imgsetid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">imgsetid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>
            <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_imgsetids</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">imgsetid</span> <span class="ow">in</span> <span class="n">imgsetid_list</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR PARSING IMAGESET ID FOR ANNOTATION FILTERING&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nid_list</span>
        <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
        <span class="n">imgsetids_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_imgsetids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="n">aids_list</span>
        <span class="p">]</span>
        <span class="n">nid_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">nid</span>
            <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">imgsetid_list_</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">imgsetids_list</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">imgsetid</span> <span class="ow">in</span> <span class="n">imgsetid_list_</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">nid_list</span>

    <span class="k">def</span> <span class="nf">filter_annots_general</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span> <span class="o">==</span> <span class="s1">&#39;GGR-IBEIS&#39;</span><span class="p">:</span>
            <span class="c1"># Grevy&#39;s</span>
            <span class="n">filter_kw</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;multiple&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;minqual&#39;</span><span class="p">:</span> <span class="s1">&#39;good&#39;</span><span class="p">,</span>
                <span class="s1">&#39;is_known&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;min_pername&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="s1">&#39;zebra_grevys&#39;</span><span class="p">,</span>
                <span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">aid_list1</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_general</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">filter_kw</span><span class="o">=</span><span class="n">filter_kw</span><span class="p">)</span>
            <span class="c1"># aid_list1 = []</span>

            <span class="c1"># Plains</span>
            <span class="n">filter_kw</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;multiple&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;minqual&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span>
                <span class="s1">&#39;is_known&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;min_pername&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="s1">&#39;zebra_plains&#39;</span><span class="p">,</span>
                <span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">aid_list2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_general</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">filter_kw</span><span class="o">=</span><span class="n">filter_kw</span><span class="p">)</span>
            <span class="n">aid_list2</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Masai</span>
            <span class="n">filter_kw</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;multiple&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;minqual&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span>
                <span class="s1">&#39;is_known&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;min_pername&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="s1">&#39;giraffe_masai&#39;</span><span class="p">,</span>
                <span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">aid_list3</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_general</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">filter_kw</span><span class="o">=</span><span class="n">filter_kw</span><span class="p">)</span>
            <span class="n">aid_list3</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">aid_list</span> <span class="o">=</span> <span class="n">aid_list1</span> <span class="o">+</span> <span class="n">aid_list2</span> <span class="o">+</span> <span class="n">aid_list3</span>

            <span class="c1"># aid_list = ibs.filter_annots_general(aid_list, filter_kw=filter_kw)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span> <span class="o">==</span> <span class="s1">&#39;GGR2-IBEIS&#39;</span>
            <span class="c1"># aid_list = ibs.check_ggr_valid_aids(aid_list, species=&#39;zebra_grevys&#39;, threshold=0.75)</span>
            <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">check_ggr_valid_aids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="s1">&#39;giraffe_reticulated&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">aid_list</span>

    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">filter_annots_general</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
    <span class="c1"># aid_list = filter_annots_imageset(aid_list)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">unixtime_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">date_list</span> <span class="o">=</span> <span class="n">_date_list</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>

    <span class="c1"># flagged_date_list = None</span>
    <span class="n">flagged_date_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2015/03/01&#39;</span><span class="p">,</span> <span class="s1">&#39;2015/03/02&#39;</span><span class="p">,</span> <span class="s1">&#39;2016/01/30&#39;</span><span class="p">,</span> <span class="s1">&#39;2016/01/31&#39;</span><span class="p">,</span> <span class="s1">&#39;2018/01/27&#39;</span><span class="p">,</span> <span class="s1">&#39;2018/01/28&#39;</span><span class="p">]</span>

    <span class="n">gid_list_unique</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>
    <span class="n">date_list_unique</span> <span class="o">=</span> <span class="n">_date_list</span><span class="p">(</span><span class="n">gid_list_unique</span><span class="p">)</span>
    <span class="n">date_taken_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gid_list_unique</span><span class="p">,</span> <span class="n">date_list_unique</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">flagged_date_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">date</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flagged_date_list</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">date_taken_dict</span><span class="p">:</span>
            <span class="n">date_taken_dict</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">date_taken_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">gid_list_all</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">gid_list_all</span> <span class="o">=</span> <span class="n">filter_images_imageset</span><span class="p">(</span><span class="n">gid_list_all</span><span class="p">)</span>
    <span class="n">date_list_all</span> <span class="o">=</span> <span class="n">_date_list</span><span class="p">(</span><span class="n">gid_list_all</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gid_list_all</span><span class="p">,</span> <span class="n">date_list_all</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">flagged_date_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">date</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flagged_date_list</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">date_taken_dict</span><span class="p">:</span>
            <span class="n">date_taken_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">value_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">current_seen_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">previous_seen_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">last_date</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">date_seen_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">unixtime</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unixtime_list</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span> <span class="n">date_list</span><span class="p">))):</span>
        <span class="k">if</span> <span class="n">flagged_date_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">date</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flagged_date_list</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Add to counters</span>

        <span class="k">if</span> <span class="n">date</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">date_seen_dict</span><span class="p">:</span>
            <span class="n">date_seen_dict</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">date_seen_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">nid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_seen_set</span><span class="p">:</span>
            <span class="n">current_seen_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
            <span class="n">date_seen_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">previous_seen_set</span><span class="p">:</span>
                <span class="n">date_seen_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">nid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_set</span><span class="p">:</span>
            <span class="n">seen_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">date_seen_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Add to register</span>
        <span class="n">value_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="c1"># Reset step (per day)</span>
        <span class="k">if</span> <span class="n">date</span> <span class="o">!=</span> <span class="n">last_date</span> <span class="ow">and</span> <span class="n">date</span> <span class="o">!=</span> <span class="s1">&#39;UNKNOWN&#39;</span><span class="p">:</span>
            <span class="n">last_date</span> <span class="o">=</span> <span class="n">date</span>
            <span class="n">previous_seen_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_seen_set</span><span class="p">)</span>
            <span class="n">current_seen_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># def optimization1(x, a, b, c):</span>
    <span class="c1">#     return a * np.log(b * x) + c</span>

    <span class="c1"># def optimization2(x, a, b, c):</span>
    <span class="c1">#     return a * np.sqrt(x) ** b + c</span>

    <span class="c1"># def optimization3(x, a, b, c):</span>
    <span class="c1">#     return 1.0 / (a * np.exp(-b * x) + c)</span>

    <span class="c1"># def process(func, opts, domain, zero_index, zero_value):</span>
    <span class="c1">#     values = func(domain, *opts)</span>
    <span class="c1">#     diff = values[zero_index] - zero_value</span>
    <span class="c1">#     values -= diff</span>
    <span class="c1">#     values[ values &lt; 0.0 ] = 0.0</span>
    <span class="c1">#     values[:zero_index] = 0.0</span>
    <span class="c1">#     values = values.astype(int)</span>
    <span class="c1">#     return list(values)</span>

    <span class="c1"># optimization_funcs = [</span>
    <span class="c1">#     optimization1,</span>
    <span class="c1">#     optimization2,</span>
    <span class="c1">#     optimization3,</span>
    <span class="c1"># ]</span>
    <span class="c1"># # Get data</span>
    <span class="c1"># x = np.array(index_list)</span>
    <span class="c1"># y = np.array(value_list)</span>
    <span class="c1"># # Fit curves</span>
    <span class="c1"># end    = int(len(index_list) * 1.25)</span>
    <span class="c1"># domain = np.array(range(1, end))</span>
    <span class="c1"># zero_index = len(value_list) - 1</span>
    <span class="c1"># zero_value = value_list[zero_index]</span>
    <span class="c1"># regressed_opts = [ curve_fit(func, x, y)[0] for func in optimization_funcs ]</span>
    <span class="c1"># prediction_list = [</span>
    <span class="c1">#     process(func, opts, domain, zero_index, zero_value)</span>
    <span class="c1">#     for func, opts in list(zip(optimization_funcs, regressed_opts))</span>
    <span class="c1"># ]</span>
    <span class="c1"># index_list = list(domain)</span>
    <span class="n">prediction_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">date_seen_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;UNKNOWN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">bar_label_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">date_seen_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">bar_value_list1</span> <span class="o">=</span> <span class="p">[</span> <span class="n">date_taken_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">bar_label_list</span> <span class="p">]</span>
    <span class="n">bar_value_list2</span> <span class="o">=</span> <span class="p">[</span> <span class="n">date_taken_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">bar_label_list</span> <span class="p">]</span>
    <span class="n">bar_value_list3</span> <span class="o">=</span> <span class="p">[</span> <span class="n">date_seen_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">bar_label_list</span> <span class="p">]</span>
    <span class="n">bar_value_list4</span> <span class="o">=</span> <span class="p">[</span> <span class="n">date_seen_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">bar_label_list</span> <span class="p">]</span>
    <span class="n">bar_value_list5</span> <span class="o">=</span> <span class="p">[</span> <span class="n">date_seen_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">bar_label_list</span> <span class="p">]</span>
    <span class="n">bar_value_list6</span> <span class="o">=</span> <span class="p">[</span> <span class="n">date_seen_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">bar_label_list</span> <span class="p">]</span>

    <span class="c1"># label_list += [&#39;Models&#39;] + [&#39;&#39;] * (len(index_list) - len(label_list) - 1)</span>
    <span class="c1"># value_list += [0] * (len(index_list) - len(value_list))</span>

    <span class="c1"># Counts</span>
    <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_imgsetids</span><span class="p">()</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">filter_images_imageset</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="c1"># aid_list = filter_annots_imageset(aid_list)</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">()</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">filter_names_imageset</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="c1"># contributor_list = ibs.get_valid_contributor_rowids()</span>
    <span class="n">note_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_notes</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">note_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">note</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">note_list</span>
    <span class="p">]</span>
    <span class="n">contributor_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">note_list</span><span class="p">)</span>
    <span class="c1"># nid_list = ibs.get_valid_nids()</span>
    <span class="n">aid_list_count</span> <span class="o">=</span> <span class="n">filter_annots_general</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
    <span class="c1"># aid_list_count = filter_annots_imageset(aid_list_count)</span>
    <span class="n">gid_list_count</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list_count</span><span class="p">)))</span>
    <span class="n">nid_list_count_dup</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list_count</span><span class="p">)</span>
    <span class="n">nid_list_count</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">nid_list_count_dup</span><span class="p">))</span>

    <span class="c1"># Calculate the Petersen-Lincoln index form the last two days</span>
    <span class="kn">from</span> <span class="nn">ibeis.other</span> <span class="k">import</span> <span class="n">dbinfo</span> <span class="k">as</span> <span class="n">dbinfo_</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">dbinfo_</span><span class="o">.</span><span class="n">estimate_ggr_count</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>
            <span class="n">nsight1</span><span class="p">,</span> <span class="n">nsight2</span><span class="p">,</span> <span class="n">resight</span><span class="p">,</span> <span class="n">pl_index</span><span class="p">,</span> <span class="n">pl_error</span> <span class="o">=</span> <span class="n">vals</span>
            <span class="c1"># pl_index = &#39;Undefined - Zero recaptured (k = 0)&#39;</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">flagged_date_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
            <span class="n">index1</span> <span class="o">=</span> <span class="n">bar_label_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flagged_date_list</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">index2</span> <span class="o">=</span> <span class="n">bar_label_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flagged_date_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">bar_value_list4</span><span class="p">[</span><span class="n">index1</span><span class="p">]</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">bar_value_list4</span><span class="p">[</span><span class="n">index2</span><span class="p">]</span>
            <span class="n">c3</span> <span class="o">=</span> <span class="n">bar_value_list6</span><span class="p">[</span><span class="n">index2</span><span class="p">]</span>
            <span class="n">pl_index</span><span class="p">,</span> <span class="n">pl_error</span> <span class="o">=</span> <span class="n">dbinfo_</span><span class="o">.</span><span class="n">sight_resight_count</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">pl_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pl_error</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Get the markers</span>
    <span class="n">gid_list_markers</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list_count</span><span class="p">)</span>
    <span class="n">gps_list_markers</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_gps</span><span class="p">(</span><span class="n">gid_list_markers</span><span class="p">))</span>
    <span class="n">gps_list_markers_all</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_gps</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>

    <span class="n">REMOVE_DUP_CODE</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">REMOVE_DUP_CODE</span><span class="p">:</span>
        <span class="c1"># Get the tracks</span>
        <span class="n">nid_track_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">gps</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">nid_list_count_dup</span><span class="p">,</span> <span class="n">gps_list_markers</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">gps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span> <span class="ow">and</span> <span class="n">gps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">nid_track_dict</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gps</span><span class="p">)</span>
        <span class="n">gps_list_tracks</span> <span class="o">=</span> <span class="p">[</span> <span class="n">nid_track_dict</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nid_track_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">__nid_list</span><span class="p">,</span> <span class="n">gps_track_list</span><span class="p">,</span> <span class="n">aid_track_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_gps_tracks</span><span class="p">(</span><span class="n">aid_list</span><span class="o">=</span><span class="n">aid_list_count</span><span class="p">)</span>
        <span class="n">gps_list_tracks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">x</span><span class="p">)),</span> <span class="n">gps_track_list</span><span class="p">))</span>

    <span class="n">gps_list_markers</span> <span class="o">=</span> <span class="p">[</span> <span class="n">gps</span> <span class="k">for</span> <span class="n">gps</span> <span class="ow">in</span> <span class="n">gps_list_markers</span> <span class="p">]</span>
    <span class="n">gps_list_markers_tuple_all</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">gps</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span> <span class="k">for</span> <span class="n">gps</span><span class="p">,</span> <span class="n">gid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gps_list_markers_all</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">))</span>  <span class="p">]</span>
    <span class="n">gps_list_markers_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">gps_list_markers_tuple_all</span><span class="p">]</span>
    <span class="n">gid_list_markers_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">gps_list_markers_tuple_all</span><span class="p">]</span>
    <span class="n">gps_list_tracks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="n">gps</span> <span class="k">for</span> <span class="n">gps</span> <span class="ow">in</span> <span class="n">gps_list_track</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">gps_list_track</span> <span class="ow">in</span> <span class="n">gps_list_tracks</span>
    <span class="p">]</span>

    <span class="c1"># ut.embed()</span>

    <span class="n">ALLOW_IMAGE_DATE_COLOR</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">VERSION</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># Colors for GPS</span>
    <span class="n">color_none</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;#777777&quot;</span><span class="p">]</span>
    <span class="n">color_day1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;#CA4141&quot;</span><span class="p">]</span>
    <span class="n">color_day2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;#428BCA&quot;</span><span class="p">]</span>
    <span class="n">color_resight</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;#9A41CA&quot;</span><span class="p">]</span>
    <span class="n">combined_list_markers_all</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dataset_color_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">VERSION</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dataset_color_label_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Day 1 Only&#39;</span><span class="p">,</span> <span class="s1">&#39;Resightings&#39;</span><span class="p">,</span> <span class="s1">&#39;Day 2 Only&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataset_color_label_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Day 1 Only&#39;</span><span class="p">,</span> <span class="s1">&#39;Resightings&#39;</span><span class="p">,</span> <span class="s1">&#39;Day 2 Only&#39;</span><span class="p">,</span> <span class="s1">&#39;Unused&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gps</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gid_list_markers_all</span><span class="p">,</span> <span class="n">gps_list_markers_all</span><span class="p">)):</span>
        <span class="n">image_note</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_notes</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="n">current_date</span> <span class="o">=</span> <span class="n">_date_list</span><span class="p">([</span><span class="n">gid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">color_none</span>
        <span class="k">if</span> <span class="n">current_date</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flagged_date_list</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">color_none</span>
        <span class="k">elif</span> <span class="n">gps</span> <span class="o">==</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">color_none</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
            <span class="n">nid_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">)</span>
            <span class="n">nid_list_</span> <span class="o">=</span> <span class="p">[</span><span class="n">nid</span> <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nid_list_</span> <span class="k">if</span> <span class="n">nid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid_list_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">color_none</span>

                <span class="k">if</span> <span class="n">ALLOW_IMAGE_DATE_COLOR</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">current_date</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2016/01/30&#39;</span><span class="p">,</span> <span class="s1">&#39;2018/01/27&#39;</span><span class="p">]:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">color_day1</span>
                    <span class="k">elif</span> <span class="n">current_date</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2016/01/31&#39;</span><span class="p">,</span> <span class="s1">&#39;2018/01/28&#39;</span><span class="p">]:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">color_day2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list_</span><span class="p">))</span>
                <span class="n">gid_list_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">)))</span>
                <span class="n">date_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_date_list</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">current_date</span> <span class="o">==</span> <span class="s1">&#39;2015/03/01&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;2015/03/02&#39;</span> <span class="ow">in</span> <span class="n">date_list</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">color_resight</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">color_day1</span>
                <span class="k">elif</span> <span class="n">current_date</span> <span class="o">==</span> <span class="s1">&#39;2015/03/02&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;2015/03/01&#39;</span> <span class="ow">in</span> <span class="n">date_list</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">color_resight</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">color_day2</span>
                <span class="k">elif</span> <span class="n">current_date</span> <span class="o">==</span> <span class="s1">&#39;2016/01/30&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;2016/01/31&#39;</span> <span class="ow">in</span> <span class="n">date_list</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">color_resight</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">color_day1</span>
                <span class="k">elif</span> <span class="n">current_date</span> <span class="o">==</span> <span class="s1">&#39;2016/01/31&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;2016/01/30&#39;</span> <span class="ow">in</span> <span class="n">date_list</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">color_resight</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">color_day2</span>
                <span class="k">elif</span> <span class="n">current_date</span> <span class="o">==</span> <span class="s1">&#39;2018/01/27&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;2018/01/28&#39;</span> <span class="ow">in</span> <span class="n">date_list</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">color_resight</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">color_day1</span>
                <span class="k">elif</span> <span class="n">current_date</span> <span class="o">==</span> <span class="s1">&#39;2018/01/28&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;2018/01/27&#39;</span> <span class="ow">in</span> <span class="n">date_list</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">color_resight</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">color_day2</span>

        <span class="n">color_id</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">VERSION</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">color_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">VERSION</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">color_id</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">combined_list_markers_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">color</span> <span class="o">+</span> <span class="p">[</span><span class="n">gps</span><span class="p">]))</span>
        <span class="n">dataset_tag</span> <span class="o">=</span> <span class="s1">&#39;GGR&#39;</span> <span class="k">if</span> <span class="s1">&#39;GGR&#39;</span> <span class="ow">in</span> <span class="n">image_note</span> <span class="k">else</span> <span class="s1">&#39;GZGC&#39;</span>

        <span class="k">if</span> <span class="n">dataset_tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_color_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERSION</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dataset_color_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dataset_color_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">dataset_color_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">][</span><span class="n">color_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">dataset_tag</span> <span class="ow">in</span> <span class="n">dataset_color_dict</span><span class="p">:</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">dataset_color_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">]</span>
        <span class="n">temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">temp</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dataset_color_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>

    <span class="n">combined_list_markers_all</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">combined_list_markers_all</span><span class="p">)</span>
    <span class="n">marker</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">combined</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combined_list_markers_all</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">combined</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="n">index</span>
        <span class="k">break</span>

    <span class="c1"># Shuffle day 1, day 2, resights randomly</span>
    <span class="n">sublist</span> <span class="o">=</span> <span class="n">combined_list_markers_all</span><span class="p">[</span><span class="n">marker</span><span class="p">:]</span>
    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span>
    <span class="n">combined_list_markers_all</span><span class="p">[</span><span class="n">marker</span><span class="p">:]</span> <span class="o">=</span> <span class="n">sublist</span>

    <span class="n">color_list_markers_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">combined_list_markers_all</span><span class="p">]</span>
    <span class="n">gps_list_markers_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">combined_list_markers_all</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_list_markers_all</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">gps_list_markers_all</span><span class="p">)</span>

    <span class="n">JITTER_GPS</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">JITTER_AMOUNT</span> <span class="o">=</span> <span class="mf">0.0001</span>
    <span class="k">if</span> <span class="n">JITTER_GPS</span><span class="p">:</span>
        <span class="n">gps_list_markers_all</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">gps</span> <span class="k">if</span> <span class="n">color_</span> <span class="o">==</span> <span class="n">color_none</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span>
            <span class="p">[</span>
                <span class="n">gps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">JITTER_AMOUNT</span><span class="p">,</span> <span class="n">JITTER_AMOUNT</span><span class="p">),</span>
                <span class="n">gps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">JITTER_AMOUNT</span><span class="p">,</span> <span class="n">JITTER_AMOUNT</span><span class="p">),</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">gps</span><span class="p">,</span> <span class="n">color_</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gps_list_markers_all</span><span class="p">,</span> <span class="n">color_list_markers_all</span><span class="p">))</span>
        <span class="p">]</span>

    <span class="n">valid_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="c1"># valid_aids = filter_annots_imageset(valid_aids)</span>
    <span class="n">used_gids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">)</span> <span class="p">))</span>
    <span class="c1"># used_contributor_tags = list(set( ibs.get_image_contributor_tag(used_gids) ))</span>
    <span class="n">note_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_notes</span><span class="p">(</span><span class="n">used_gids</span><span class="p">)</span>
    <span class="n">note_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">note</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">note_list</span>
    <span class="p">]</span>
    <span class="n">used_contributor_tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">note_list</span><span class="p">)</span>

    <span class="c1"># Get Age and sex (By Annot)</span>
    <span class="c1"># annot_sex_list = ibs.get_annot_sex(valid_aids_)</span>
    <span class="c1"># annot_age_months_est_min = ibs.get_annot_age_months_est_min(valid_aids_)</span>
    <span class="c1"># annot_age_months_est_max = ibs.get_annot_age_months_est_max(valid_aids_)</span>
    <span class="c1"># age_list = [[0, 0, 0], [0, 0, 0], [0, 0, 0]]</span>
    <span class="c1"># for sex, min_age, max_age in list(zip(annot_sex_list, annot_age_months_est_min, annot_age_months_est_max)):</span>
    <span class="c1">#     if sex not in [0, 1]:</span>
    <span class="c1">#         sex = 2</span>
    <span class="c1">#         # continue</span>
    <span class="c1">#     if (min_age is None or min_age &lt; 12) and max_age &lt; 12:</span>
    <span class="c1">#         age_list[sex][0] += 1</span>
    <span class="c1">#     elif 12 &lt;= min_age and min_age &lt; 36 and 12 &lt;= max_age and max_age &lt; 36:</span>
    <span class="c1">#         age_list[sex][1] += 1</span>
    <span class="c1">#     elif 36 &lt;= min_age and (36 &lt;= max_age or max_age is None):</span>
    <span class="c1">#         age_list[sex][2] += 1</span>

    <span class="c1"># Get Age and sex (By Name)</span>
    <span class="n">name_sex_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_sex</span><span class="p">(</span><span class="n">nid_list_count</span><span class="p">)</span>
    <span class="n">name_age_months_est_mins_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_age_months_est_min</span><span class="p">(</span><span class="n">nid_list_count</span><span class="p">)</span>
    <span class="n">name_age_months_est_maxs_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_age_months_est_max</span><span class="p">(</span><span class="n">nid_list_count</span><span class="p">)</span>
    <span class="n">age_list</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">age_unreviewed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">age_ambiguous</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">sex</span><span class="p">,</span> <span class="n">min_ages</span><span class="p">,</span> <span class="n">max_ages</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">nid_list_count</span><span class="p">,</span> <span class="n">name_sex_list</span><span class="p">,</span> <span class="n">name_age_months_est_mins_list</span><span class="p">,</span> <span class="n">name_age_months_est_maxs_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">min_ages</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">max_ages</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># print(&#39;[web] Invalid name %r: Cannot have more than one age&#39; % (nid, ))</span>
            <span class="n">age_ambiguous</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="n">min_age</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">max_age</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_ages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">min_age</span> <span class="o">=</span> <span class="n">min_ages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">max_ages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">max_age</span> <span class="o">=</span> <span class="n">max_ages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Histogram</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">min_age</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_age</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">min_age</span> <span class="ow">is</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">max_age</span> <span class="ow">is</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># print(&#39;[web] Unreviewded name %r: Specify the age for the name&#39; % (nid, ))</span>
            <span class="n">age_unreviewed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">sex</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">sex</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="c1"># continue</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">min_age</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">min_age</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="ow">and</span> <span class="n">max_age</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">age_list</span><span class="p">[</span><span class="n">sex</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="mi">12</span> <span class="o">&lt;=</span> <span class="n">min_age</span> <span class="ow">and</span> <span class="n">min_age</span> <span class="o">&lt;</span> <span class="mi">24</span> <span class="ow">and</span> <span class="mi">12</span> <span class="o">&lt;=</span> <span class="n">max_age</span> <span class="ow">and</span> <span class="n">max_age</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">:</span>
            <span class="n">age_list</span><span class="p">[</span><span class="n">sex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="mi">24</span> <span class="o">&lt;=</span> <span class="n">min_age</span> <span class="ow">and</span> <span class="n">min_age</span> <span class="o">&lt;</span> <span class="mi">36</span> <span class="ow">and</span> <span class="mi">24</span> <span class="o">&lt;=</span> <span class="n">max_age</span> <span class="ow">and</span> <span class="n">max_age</span> <span class="o">&lt;</span> <span class="mi">36</span><span class="p">:</span>
            <span class="n">age_list</span><span class="p">[</span><span class="n">sex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="mi">36</span> <span class="o">&lt;=</span> <span class="n">min_age</span> <span class="ow">and</span> <span class="p">(</span><span class="n">max_age</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="mi">36</span> <span class="o">&lt;=</span> <span class="n">max_age</span><span class="p">):</span>
            <span class="n">age_list</span><span class="p">[</span><span class="n">sex</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">DEMOGRAPHICS_INCLUDE_UNREVIEWED_AMBIGOUS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">age_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span> <span class="n">age_list</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">DEMOGRAPHICS_INCLUDE_UNREVIEWED_AMBIGOUS</span><span class="p">:</span>
        <span class="n">age_total</span> <span class="o">+=</span> <span class="n">age_unreviewed</span> <span class="o">+</span> <span class="n">age_ambiguous</span>
    <span class="n">age_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">age_total</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">age_total</span>
    <span class="n">age_fmt_str</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">% 4d</span><span class="s1"> (</span><span class="si">% 2.02f%%</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="n">age_total</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">age_str_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span>
            <span class="n">age_fmt_str</span><span class="p">(</span><span class="n">age</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">age</span> <span class="ow">in</span> <span class="n">age_list_</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">age_list_</span> <span class="ow">in</span> <span class="n">age_list</span>
    <span class="p">]</span>
    <span class="n">age_str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">age_fmt_str</span><span class="p">(</span><span class="n">age_unreviewed</span><span class="p">))</span>
    <span class="n">age_str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">age_fmt_str</span><span class="p">(</span><span class="n">age_ambiguous</span><span class="p">))</span>

    <span class="c1"># dbinfo_str = dbinfo()</span>
    <span class="n">dbinfo_str</span> <span class="o">=</span> <span class="s1">&#39;SKIPPED DBINFO&#39;</span>

    <span class="n">path_dict</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">compute_ggr_path_dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;North&#39;</span> <span class="ow">in</span> <span class="n">path_dict</span><span class="p">:</span>
        <span class="n">path_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;North&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;Core&#39;</span> <span class="ow">in</span> <span class="n">path_dict</span><span class="p">:</span>
        <span class="n">path_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Core&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;advanced0&#39;</span><span class="p">,</span>
                         <span class="n">line_index_list</span><span class="o">=</span><span class="n">index_list</span><span class="p">,</span>
                         <span class="n">line_label_list</span><span class="o">=</span><span class="n">label_list</span><span class="p">,</span>
                         <span class="n">line_value_list</span><span class="o">=</span><span class="n">value_list</span><span class="p">,</span>
                         <span class="n">prediction_list</span><span class="o">=</span><span class="n">prediction_list</span><span class="p">,</span>
                         <span class="n">pl_index</span><span class="o">=</span><span class="n">pl_index</span><span class="p">,</span>
                         <span class="n">pl_error</span><span class="o">=</span><span class="n">pl_error</span><span class="p">,</span>
                         <span class="n">gps_list_markers</span><span class="o">=</span><span class="n">gps_list_markers</span><span class="p">,</span>
                         <span class="n">gps_list_markers_all</span><span class="o">=</span><span class="n">gps_list_markers_all</span><span class="p">,</span>
                         <span class="n">color_list_markers_all</span><span class="o">=</span><span class="n">color_list_markers_all</span><span class="p">,</span>
                         <span class="n">gps_list_tracks</span><span class="o">=</span><span class="n">gps_list_tracks</span><span class="p">,</span>
                         <span class="n">dataset_color_dict</span><span class="o">=</span><span class="n">dataset_color_dict</span><span class="p">,</span>
                         <span class="n">dataset_color_label_list</span><span class="o">=</span><span class="n">dataset_color_label_list</span><span class="p">,</span>
                         <span class="n">path_dict</span><span class="o">=</span><span class="n">path_dict</span><span class="p">,</span>
                         <span class="n">bar_label_list</span><span class="o">=</span><span class="n">bar_label_list</span><span class="p">,</span>
                         <span class="n">bar_value_list1</span><span class="o">=</span><span class="n">bar_value_list1</span><span class="p">,</span>
                         <span class="n">bar_value_list2</span><span class="o">=</span><span class="n">bar_value_list2</span><span class="p">,</span>
                         <span class="n">bar_value_list3</span><span class="o">=</span><span class="n">bar_value_list3</span><span class="p">,</span>
                         <span class="n">bar_value_list4</span><span class="o">=</span><span class="n">bar_value_list4</span><span class="p">,</span>
                         <span class="n">bar_value_list5</span><span class="o">=</span><span class="n">bar_value_list5</span><span class="p">,</span>
                         <span class="n">bar_value_list6</span><span class="o">=</span><span class="n">bar_value_list6</span><span class="p">,</span>
                         <span class="n">age_list</span><span class="o">=</span><span class="n">age_list</span><span class="p">,</span>
                         <span class="n">age_str_list</span><span class="o">=</span><span class="n">age_str_list</span><span class="p">,</span>
                         <span class="n">age_ambiguous</span><span class="o">=</span><span class="n">age_ambiguous</span><span class="p">,</span>
                         <span class="n">age_unreviewed</span><span class="o">=</span><span class="n">age_unreviewed</span><span class="p">,</span>
                         <span class="n">age_total</span><span class="o">=</span><span class="n">age_total</span><span class="p">,</span>
                         <span class="n">dbinfo_str</span><span class="o">=</span><span class="n">dbinfo_str</span><span class="p">,</span>
                         <span class="n">imgsetid_list</span><span class="o">=</span><span class="n">imgsetid_list</span><span class="p">,</span>
                         <span class="n">imgsetid_list_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">imgsetid_list</span><span class="p">)),</span>
                         <span class="n">num_imgsetids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">imgsetid_list</span><span class="p">),</span>
                         <span class="n">gid_list</span><span class="o">=</span><span class="n">gid_list</span><span class="p">,</span>
                         <span class="n">gid_list_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)),</span>
                         <span class="n">num_gids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
                         <span class="n">contributor_list</span><span class="o">=</span><span class="n">contributor_list</span><span class="p">,</span>
                         <span class="n">contributor_list_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">contributor_list</span><span class="p">)),</span>
                         <span class="n">num_contribs</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">contributor_list</span><span class="p">),</span>
                         <span class="n">gid_list_count</span><span class="o">=</span><span class="n">gid_list_count</span><span class="p">,</span>
                         <span class="n">gid_list_count_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">gid_list_count</span><span class="p">)),</span>
                         <span class="n">num_gids_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list_count</span><span class="p">),</span>
                         <span class="n">aid_list</span><span class="o">=</span><span class="n">aid_list</span><span class="p">,</span>
                         <span class="n">aid_list_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)),</span>
                         <span class="n">num_aids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
                         <span class="n">aid_list_count</span><span class="o">=</span><span class="n">aid_list_count</span><span class="p">,</span>
                         <span class="n">aid_list_count_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">aid_list_count</span><span class="p">)),</span>
                         <span class="n">num_aids_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list_count</span><span class="p">),</span>
                         <span class="n">nid_list</span><span class="o">=</span><span class="n">nid_list</span><span class="p">,</span>
                         <span class="n">nid_list_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)),</span>
                         <span class="n">num_nids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">),</span>
                         <span class="n">nid_list_count</span><span class="o">=</span><span class="n">nid_list_count</span><span class="p">,</span>
                         <span class="n">nid_list_count_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">nid_list_count</span><span class="p">)),</span>
                         <span class="n">num_nids_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">nid_list_count</span><span class="p">),</span>
                         <span class="n">used_gids</span><span class="o">=</span><span class="n">used_gids</span><span class="p">,</span>
                         <span class="n">num_used_gids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">used_gids</span><span class="p">),</span>
                         <span class="n">used_contribs</span><span class="o">=</span><span class="n">used_contributor_tags</span><span class="p">,</span>
                         <span class="n">num_used_contribs</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">used_contributor_tags</span><span class="p">),</span>
                         <span class="n">__wrapper_header__</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="view_advanced1"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.view_advanced1">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/view/advanced/1/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">view_advanced1</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="n">species_tag_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;zebra_grevys&#39;</span><span class="p">,</span> <span class="s1">&#39;zebra_plains&#39;</span><span class="p">,</span> <span class="s1">&#39;giraffe_masai&#39;</span><span class="p">]</span>
    <span class="n">species_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_rowids_from_text</span><span class="p">(</span><span class="n">species_tag_list</span><span class="p">)</span>
    <span class="n">species_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">species_tag_list</span><span class="p">)</span>
    <span class="n">species_nice_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">species_tag</span> <span class="p">:</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_nice</span><span class="p">(</span><span class="n">species_rowid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">species_tag</span><span class="p">,</span> <span class="n">species_rowid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_tag_list</span><span class="p">,</span> <span class="n">species_rowid_list</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">viewpoint_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoints</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">viewpoint_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">species</span><span class="p">,</span> <span class="n">viewpoint</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_list</span><span class="p">,</span> <span class="n">viewpoint_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">species</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">viewpoint_dict</span><span class="p">:</span>
                <span class="n">viewpoint_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">viewpoint</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">viewpoint_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]:</span>
                <span class="n">viewpoint_dict</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="n">viewpoint</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">viewpoint_dict</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="n">viewpoint</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">viewpoint_tag_list</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">VIEWTEXT_TO_VIEWPOINT_RADIANS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">pie_label_list</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">VIEWPOINTALIAS_NICE</span><span class="p">[</span><span class="n">_</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">viewpoint_tag_list</span> <span class="p">]</span>
    <span class="n">pie_values_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span>
            <span class="n">species_nice_dict</span><span class="p">[</span><span class="n">species</span><span class="p">],</span>
            <span class="p">[</span><span class="n">viewpoint_dict</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="n">_</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">viewpoint_tag_list</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_tag_list</span>
    <span class="p">]</span>

    <span class="n">pie_left_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;frontleft&#39;</span><span class="p">,</span> <span class="s1">&#39;front&#39;</span><span class="p">,</span> <span class="s1">&#39;frontright&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;backright&#39;</span><span class="p">,</span> <span class="s1">&#39;back&#39;</span><span class="p">,</span> <span class="s1">&#39;backleft&#39;</span><span class="p">]</span>
    <span class="n">pie_right_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;backright&#39;</span><span class="p">,</span> <span class="s1">&#39;back&#39;</span><span class="p">,</span> <span class="s1">&#39;backleft&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;frontleft&#39;</span><span class="p">,</span> <span class="s1">&#39;front&#39;</span><span class="p">,</span> <span class="s1">&#39;frontright&#39;</span><span class="p">]</span>
    <span class="n">viewpoint_tag_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;zebra_grevys&#39;</span> <span class="p">:</span> <span class="n">pie_right_list</span><span class="p">,</span>
        <span class="s1">&#39;zebra_plains&#39;</span> <span class="p">:</span> <span class="n">pie_left_list</span><span class="p">,</span>
        <span class="s1">&#39;giraffe_masai&#39;</span> <span class="p">:</span> <span class="n">pie_left_list</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">pie_label_corrected_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span>
        <span class="nb">str</span><span class="p">,</span>
        <span class="p">[</span><span class="s1">&#39;Correct&#39;</span><span class="p">,</span> <span class="s1">&#39;+45&#39;</span><span class="p">,</span> <span class="s1">&#39;+90&#39;</span><span class="p">,</span> <span class="s1">&#39;+135&#39;</span><span class="p">,</span> <span class="s1">&#39;+180&#39;</span><span class="p">,</span> <span class="s1">&#39;+225&#39;</span><span class="p">,</span> <span class="s1">&#39;+270&#39;</span><span class="p">,</span> <span class="s1">&#39;+315&#39;</span><span class="p">]</span>
    <span class="p">))</span>
    <span class="n">pie_values_corrected_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span>
            <span class="n">species_nice_dict</span><span class="p">[</span><span class="n">species</span><span class="p">],</span>
            <span class="p">[</span><span class="n">viewpoint_dict</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="n">_</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">viewpoint_tag_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_tag_list</span>
    <span class="p">]</span>

    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">note_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_notes</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">viewpoints_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoints</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="n">dataset_tag_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GGR&#39;</span><span class="p">,</span> <span class="s1">&#39;GZGC&#39;</span><span class="p">]</span>
    <span class="n">pie_label_images_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Correct Viewpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;+/- 45 Viewpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;Unused&#39;</span><span class="p">]</span>
    <span class="n">pie_values_images_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">dataset_tag</span> <span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dataset_tag</span> <span class="ow">in</span> <span class="n">dataset_tag_list</span>
    <span class="p">}</span>
    <span class="n">allowed_viewpoint_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;GGR&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;frontright&#39;</span><span class="p">,</span> <span class="s1">&#39;backright&#39;</span><span class="p">],</span>
        <span class="s1">&#39;GZGC&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;frontleft&#39;</span><span class="p">,</span> <span class="s1">&#39;backleft&#39;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">note</span><span class="p">,</span> <span class="n">viewpoint_list</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">note_list</span><span class="p">,</span> <span class="n">viewpoints_list</span><span class="p">)):</span>
        <span class="n">dataset_tag</span> <span class="o">=</span> <span class="s1">&#39;GGR&#39;</span> <span class="k">if</span> <span class="s1">&#39;GGR&#39;</span> <span class="ow">in</span> <span class="n">note</span> <span class="k">else</span> <span class="s1">&#39;GZGC&#39;</span>
        <span class="n">allowed_viewpoint_list</span> <span class="o">=</span> <span class="n">allowed_viewpoint_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">]</span>

        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">allowed_viewpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allowed_viewpoint_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">allowed_viewpoint</span> <span class="ow">in</span> <span class="n">viewpoint_list</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pie_values_images_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pie_values_images_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">pie_values_images_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">pie_values_images_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">pie_values_images_dict</span><span class="p">[</span><span class="n">_</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dataset_tag_list</span>
    <span class="p">]</span>

    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">()</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)))</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">None</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">species_list</span> <span class="p">]</span>

    <span class="n">num_bins</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">histogram_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">species</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">species</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">histogram_dict</span><span class="p">:</span>
            <span class="n">histogram_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">count</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">histogram_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]:</span>
            <span class="n">histogram_dict</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">histogram_dict</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="n">count</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">histogram_bins</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">bar_label_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">+&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bin_</span><span class="p">,</span> <span class="p">)</span> <span class="k">if</span> <span class="n">bin_</span> <span class="o">==</span> <span class="n">histogram_bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bin_</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">bin_</span> <span class="ow">in</span> <span class="n">histogram_bins</span>
    <span class="p">]</span>
    <span class="n">bar_values_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">histogram_dict</span><span class="p">:</span>
        <span class="n">bar_values_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">bin_</span> <span class="ow">in</span> <span class="n">histogram_bins</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">histogram_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bin_</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">species</span> <span class="o">==</span> <span class="s1">&#39;zebra_plains&#39;</span><span class="p">:</span>
                <span class="n">value2</span> <span class="o">=</span> <span class="n">histogram_dict</span><span class="p">[</span><span class="s1">&#39;giraffe_masai&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bin_</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">+=</span> <span class="n">value2</span>
            <span class="n">bar_values_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># Get number of annotations per name as a histogram for each species</span>
    <span class="n">embedded</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">globals</span><span class="p">(),</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;advanced1&#39;</span><span class="p">,</span>
                         <span class="n">__wrapper_header__</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">embedded</span><span class="p">)</span></div>


<div class="viewcode-block" id="view_advanced2"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.view_advanced2">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/view/advanced/2/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">view_advanced2</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_date_list</span><span class="p">(</span><span class="n">gid_list</span><span class="p">):</span>
        <span class="n">unixtime_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">datetime_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">unixtime_to_datetimestr</span><span class="p">(</span><span class="n">unixtime</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unixtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span>
            <span class="s1">&#39;UNKNOWN&#39;</span>
            <span class="k">for</span> <span class="n">unixtime</span> <span class="ow">in</span> <span class="n">unixtime_list</span>
        <span class="p">]</span>
        <span class="n">datetime_split_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">datetime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">datetime</span> <span class="ow">in</span> <span class="n">datetime_list</span> <span class="p">]</span>
        <span class="n">date_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">datetime_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datetime_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s1">&#39;UNKNOWN&#39;</span> <span class="k">for</span> <span class="n">datetime_split</span> <span class="ow">in</span> <span class="n">datetime_split_list</span> <span class="p">]</span>
        <span class="k">return</span> <span class="n">date_list</span>

    <span class="k">def</span> <span class="nf">filter_annots_imageset</span><span class="p">(</span><span class="n">aid_list</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imgsetid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imgsetid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">imgsetid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>
            <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_imgsetids</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">imgsetid</span> <span class="ow">in</span> <span class="n">imgsetid_list</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR PARSING IMAGESET ID FOR ANNOTATION FILTERING&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">aid_list</span>
        <span class="n">imgsetids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_imgsetids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">aid</span>
            <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">imgsetid_list_</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">imgsetids_list</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">imgsetid</span> <span class="ow">in</span> <span class="n">imgsetid_list_</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">aid_list</span>

    <span class="k">def</span> <span class="nf">filter_annots_general</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span> <span class="o">==</span> <span class="s1">&#39;GGR-IBEIS&#39;</span><span class="p">:</span>
            <span class="c1"># Grevy&#39;s</span>
            <span class="n">filter_kw</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;multiple&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;minqual&#39;</span><span class="p">:</span> <span class="s1">&#39;good&#39;</span><span class="p">,</span>
                <span class="s1">&#39;is_known&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;min_pername&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="s1">&#39;zebra_grevys&#39;</span><span class="p">,</span>
                <span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">aid_list1</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_general</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">filter_kw</span><span class="o">=</span><span class="n">filter_kw</span><span class="p">)</span>
            <span class="c1"># aid_list1 = []</span>

            <span class="c1"># Plains</span>
            <span class="n">filter_kw</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;multiple&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;minqual&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span>
                <span class="s1">&#39;is_known&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;min_pername&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="s1">&#39;zebra_plains&#39;</span><span class="p">,</span>
                <span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">aid_list2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_general</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">filter_kw</span><span class="o">=</span><span class="n">filter_kw</span><span class="p">)</span>
            <span class="n">aid_list2</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Masai</span>
            <span class="n">filter_kw</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;multiple&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;minqual&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span>
                <span class="s1">&#39;is_known&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;min_pername&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="s1">&#39;giraffe_masai&#39;</span><span class="p">,</span>
                <span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">aid_list3</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_general</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">filter_kw</span><span class="o">=</span><span class="n">filter_kw</span><span class="p">)</span>
            <span class="n">aid_list3</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">aid_list</span> <span class="o">=</span> <span class="n">aid_list1</span> <span class="o">+</span> <span class="n">aid_list2</span> <span class="o">+</span> <span class="n">aid_list3</span>

            <span class="c1"># aid_list = ibs.filter_annots_general(aid_list, filter_kw=filter_kw)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span> <span class="o">==</span> <span class="s1">&#39;GGR2-IBEIS&#39;</span>
            <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">check_ggr_valid_aids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="s1">&#39;zebra_grevys&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">aid_list</span>

    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">filter_annots_general</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
    <span class="c1"># aid_list = filter_annots_imageset(aid_list)</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">unixtime_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">date_list</span> <span class="o">=</span> <span class="n">_date_list</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>

    <span class="n">flagged_date_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2015/03/01&#39;</span><span class="p">,</span> <span class="s1">&#39;2015/03/02&#39;</span><span class="p">,</span> <span class="s1">&#39;2016/01/30&#39;</span><span class="p">,</span> <span class="s1">&#39;2016/01/31&#39;</span><span class="p">]</span>

    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">line_index_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">line_label_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">line_value_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">last_date</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">unixtime</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">species</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unixtime_list</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span> <span class="n">date_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">))):</span>
        <span class="c1"># if flagged_date_list is not None and date not in flagged_date_list:</span>
        <span class="c1">#     continue</span>

        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">line_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># Add to counters</span>
        <span class="k">if</span> <span class="n">nid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_set</span><span class="p">:</span>
            <span class="n">seen_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Add to register</span>
        <span class="n">line_value_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># Reset step (per day)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line_label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line_label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># if date != last_date and date != &#39;UNKNOWN&#39;:</span>
        <span class="c1">#     last_date = date</span>
        <span class="c1">#     # line_label_list.append(date)</span>
        <span class="c1">#     line_label_list.append(&#39;&#39;)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     line_label_list.append(&#39;&#39;)</span>

    <span class="c1"># Get number of annotations per name as a histogram for each species</span>
    <span class="n">embedded</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">globals</span><span class="p">(),</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;advanced2&#39;</span><span class="p">,</span>
                         <span class="n">__wrapper_header__</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">embedded</span><span class="p">)</span></div>


<div class="viewcode-block" id="view_advanced3"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.view_advanced3">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/view/advanced/3/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">view_advanced3</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="c1"># gid_list = gid_list[:100] + gid_list[-100:]</span>
    <span class="n">note_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_notes</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>

    <span class="n">contrib_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">note</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">note_list</span><span class="p">)):</span>
        <span class="n">note</span> <span class="o">=</span> <span class="n">note</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">note</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="n">dataset_tag</span> <span class="o">=</span> <span class="s1">&#39;GGR&#39;</span> <span class="k">if</span> <span class="s1">&#39;GGR&#39;</span> <span class="ow">in</span> <span class="n">note</span> <span class="k">else</span> <span class="s1">&#39;GZGC&#39;</span>
        <span class="k">if</span> <span class="n">dataset_tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">contrib_dict</span><span class="p">:</span>
            <span class="n">contrib_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">dataset_tag</span> <span class="o">==</span> <span class="s1">&#39;GGR&#39;</span><span class="p">:</span>
            <span class="n">note_</span> <span class="o">=</span> <span class="n">note</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">car</span><span class="p">,</span> <span class="n">letter</span> <span class="o">=</span> <span class="n">note_</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">note_</span> <span class="o">=</span> <span class="n">note</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">car</span><span class="p">,</span> <span class="n">letter</span> <span class="o">=</span> <span class="n">note_</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">car</span> <span class="o">=</span> <span class="n">car</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">letter</span> <span class="o">=</span> <span class="n">letter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">car</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">contrib_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">]:</span>
            <span class="n">contrib_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">][</span><span class="n">car</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">letter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">contrib_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">][</span><span class="n">car</span><span class="p">]:</span>
            <span class="n">contrib_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">][</span><span class="n">car</span><span class="p">][</span><span class="n">letter</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">contrib_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">][</span><span class="n">car</span><span class="p">][</span><span class="n">letter</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">max_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">dataset_tag</span> <span class="ow">in</span> <span class="n">contrib_dict</span><span class="p">:</span>
        <span class="n">temp_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">car</span> <span class="ow">in</span> <span class="n">contrib_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">]:</span>
            <span class="n">letter_dict</span> <span class="o">=</span> <span class="n">contrib_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">][</span><span class="n">car</span><span class="p">]</span>
            <span class="n">combined_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([(</span><span class="n">_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">letter_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
            <span class="n">combined_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">combined_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">letter_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">combined_list</span><span class="p">]</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">letter_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">total</span><span class="p">,</span> <span class="n">car</span><span class="p">,</span> <span class="n">letter_list</span><span class="p">))</span>
        <span class="n">temp_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">temp_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">max_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_list</span><span class="p">))</span>
        <span class="n">contrib_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">][</span><span class="s1">&#39;__MANIFEST__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_list</span>

    <span class="n">max_show</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="c1"># bar_label_list = [&#39;&#39;] * max_show</span>
    <span class="n">bar_label_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_show</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">bar_values_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">dataset_tag</span> <span class="ow">in</span> <span class="n">contrib_dict</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">contrib_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">][</span><span class="s1">&#39;__MANIFEST__&#39;</span><span class="p">]]</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="n">max_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">padding</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[:</span><span class="n">max_show</span><span class="p">]</span>
        <span class="n">bar_values_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

    <span class="k">for</span> <span class="n">dataset_tag</span> <span class="ow">in</span> <span class="n">contrib_dict</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">dataset_tag</span><span class="p">)</span>
        <span class="n">total_cars</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_letters</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_images</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">car</span> <span class="ow">in</span> <span class="n">contrib_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">car</span> <span class="o">==</span> <span class="s1">&#39;__MANIFEST__&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">total_cars</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">contrib_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">][</span><span class="n">car</span><span class="p">]:</span>
                <span class="n">total_letters</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">total_images</span> <span class="o">+=</span> <span class="n">contrib_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">][</span><span class="n">car</span><span class="p">][</span><span class="n">letter</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">total_cars</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">total_letters</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">total_images</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">skipped</span><span class="p">)</span>

    <span class="c1"># Get number of annotations per name as a histogram for each species</span>
    <span class="n">embedded</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">globals</span><span class="p">(),</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;advanced3&#39;</span><span class="p">,</span>
                         <span class="n">__wrapper_header__</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">embedded</span><span class="p">)</span></div>


<div class="viewcode-block" id="view_advanced4"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.view_advanced4">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/view/advanced/4/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">view_advanced4</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_date_list</span><span class="p">(</span><span class="n">gid_list</span><span class="p">):</span>
        <span class="n">unixtime_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">datetime_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">unixtime_to_datetimestr</span><span class="p">(</span><span class="n">unixtime</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unixtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span>
            <span class="s1">&#39;UNKNOWN&#39;</span>
            <span class="k">for</span> <span class="n">unixtime</span> <span class="ow">in</span> <span class="n">unixtime_list</span>
        <span class="p">]</span>
        <span class="n">datetime_split_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">datetime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">datetime</span> <span class="ow">in</span> <span class="n">datetime_list</span> <span class="p">]</span>
        <span class="n">date_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">datetime_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datetime_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s1">&#39;UNKNOWN&#39;</span> <span class="k">for</span> <span class="n">datetime_split</span> <span class="ow">in</span> <span class="n">datetime_split_list</span> <span class="p">]</span>
        <span class="k">return</span> <span class="n">date_list</span>

    <span class="k">def</span> <span class="nf">filter_species_of_interest</span><span class="p">(</span><span class="n">gid_list</span><span class="p">):</span>
        <span class="n">wanted_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;zebra_plains&#39;</span><span class="p">,</span> <span class="s1">&#39;zebra_grevys&#39;</span><span class="p">,</span> <span class="s1">&#39;giraffe_masai&#39;</span><span class="p">])</span>
        <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">speciess_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
        <span class="n">speciess_set</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">speciess_list</span><span class="p">)</span>
        <span class="n">gid_list_filtered</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">species_set</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">speciess_set</span><span class="p">)):</span>
            <span class="n">intersect_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">wanted_set</span> <span class="o">&amp;</span> <span class="n">species_set</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">gid_list_filtered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gid_list_filtered</span>

    <span class="k">def</span> <span class="nf">filter_viewpoints_of_interest</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">allowed_viewpoint_list</span><span class="p">):</span>
        <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">wanted_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">allowed_viewpoint_list</span><span class="p">)</span>
        <span class="n">viewpoints_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoints</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
        <span class="n">viewpoints_list</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">viewpoints_list</span><span class="p">)</span>
        <span class="n">gid_list_filtered</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">viewpoint_set</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">viewpoints_list</span><span class="p">)):</span>
            <span class="n">intersect_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">wanted_set</span> <span class="o">&amp;</span> <span class="n">viewpoint_set</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">gid_list_filtered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gid_list_filtered</span>

    <span class="k">def</span> <span class="nf">filter_bad_metadata</span><span class="p">(</span><span class="n">gid_list</span><span class="p">):</span>
        <span class="n">wanted_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;2015/03/01&#39;</span><span class="p">,</span> <span class="s1">&#39;2015/03/02&#39;</span><span class="p">,</span> <span class="s1">&#39;2016/01/30&#39;</span><span class="p">,</span> <span class="s1">&#39;2016/01/31&#39;</span><span class="p">])</span>
        <span class="n">date_list</span> <span class="o">=</span> <span class="n">_date_list</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">gps_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_gps</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">gid_list_filtered</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">gps</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">date_list</span><span class="p">,</span> <span class="n">gps_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">wanted_set</span> <span class="ow">and</span> <span class="n">gps</span> <span class="o">!=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">):</span>
                <span class="n">gid_list_filtered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gid_list_filtered</span>

    <span class="k">def</span> <span class="nf">filter_bad_quality</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">allowed_quality_list</span><span class="p">):</span>
        <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">wanted_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">allowed_quality_list</span><span class="p">)</span>
        <span class="n">qualities_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
        <span class="n">qualities_list</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">qualities_list</span><span class="p">)</span>
        <span class="n">gid_list_filtered</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">quality_list</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">qualities_list</span><span class="p">)):</span>
            <span class="n">intersect_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">wanted_set</span> <span class="o">&amp;</span> <span class="n">quality_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">gid_list_filtered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gid_list_filtered</span>

    <span class="c1"># def filter_singletons(gid_list):</span>
    <span class="c1">#     aids_list = ibs.get_image_aids(gid_list)</span>
    <span class="c1">#     nids_list = ut.unflat_map(ibs.get_annot_nids, aids_list)</span>
    <span class="c1">#     gid_list_filtered = []</span>
    <span class="c1">#     for gid, nid_list in list(zip(gid_list, nids_list)):</span>
    <span class="c1">#         print(gid)</span>
    <span class="c1">#         print(nid_list)</span>
    <span class="c1">#         aids_list_ = ibs.get_name_aids(nid_list)</span>
    <span class="c1">#         print(aids_list_)</span>
    <span class="c1">#         single = True</span>
    <span class="c1">#         for nid, aid_list in list(zip(nid_list, aids_list_)):</span>
    <span class="c1">#             if nid == const.UNKNOWN_NAME_ROWID or nid &lt; 0:</span>
    <span class="c1">#                 continue</span>
    <span class="c1">#             if len(aid_list) &gt; 1:</span>
    <span class="c1">#                 single = False</span>
    <span class="c1">#                 break</span>
    <span class="c1">#         print(single)</span>
    <span class="c1">#         if single:</span>
    <span class="c1">#             gid_list_filtered.append(gid)</span>
    <span class="c1">#     return gid_list_filtered</span>

    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">note_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_notes</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>

    <span class="n">dataset_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">note</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">note_list</span><span class="p">)):</span>
        <span class="n">note</span> <span class="o">=</span> <span class="n">note</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">dataset_tag</span> <span class="o">=</span> <span class="s1">&#39;GGR&#39;</span> <span class="k">if</span> <span class="s1">&#39;GGR&#39;</span> <span class="ow">in</span> <span class="n">note</span> <span class="k">else</span> <span class="s1">&#39;GZGC&#39;</span>
        <span class="k">if</span> <span class="n">dataset_tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_dict</span><span class="p">:</span>
            <span class="n">dataset_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">dataset_dict</span><span class="p">[</span><span class="n">dataset_tag</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>

    <span class="n">num_all_gzgc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GZGC&#39;</span><span class="p">])</span>
    <span class="n">num_all_ggr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GGR&#39;</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">num_all_gzgc</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">num_all_ggr</span><span class="p">)</span>

    <span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GZGC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_species_of_interest</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GZGC&#39;</span><span class="p">])</span>
    <span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GGR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_species_of_interest</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GGR&#39;</span><span class="p">])</span>

    <span class="n">num_species_gzgc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GZGC&#39;</span><span class="p">])</span>
    <span class="n">num_species_ggr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GGR&#39;</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="n">num_species_gzgc</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="n">num_species_ggr</span><span class="p">)</span>

    <span class="n">allowed_viewpoint_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;GGR&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;frontright&#39;</span><span class="p">,</span> <span class="s1">&#39;backright&#39;</span><span class="p">],</span>
        <span class="s1">&#39;GZGC&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;frontleft&#39;</span><span class="p">,</span> <span class="s1">&#39;backleft&#39;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GZGC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_viewpoints_of_interest</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GZGC&#39;</span><span class="p">],</span> <span class="n">allowed_viewpoint_dict</span><span class="p">[</span><span class="s1">&#39;GZGC&#39;</span><span class="p">])</span>
    <span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GGR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_viewpoints_of_interest</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GGR&#39;</span><span class="p">],</span> <span class="n">allowed_viewpoint_dict</span><span class="p">[</span><span class="s1">&#39;GGR&#39;</span><span class="p">])</span>

    <span class="n">num_viewpoint_gzgc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GZGC&#39;</span><span class="p">])</span>
    <span class="n">num_viewpoint_ggr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GGR&#39;</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;viewpoint&#39;</span><span class="p">,</span> <span class="n">num_viewpoint_gzgc</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;viewpoint&#39;</span><span class="p">,</span> <span class="n">num_viewpoint_ggr</span><span class="p">)</span>

    <span class="n">allowed_quality_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;GGR&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;good&#39;</span><span class="p">,</span> <span class="s1">&#39;perfect&#39;</span><span class="p">],</span>
        <span class="s1">&#39;GZGC&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="s1">&#39;good&#39;</span><span class="p">,</span> <span class="s1">&#39;perfect&#39;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GZGC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_bad_quality</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GZGC&#39;</span><span class="p">],</span> <span class="n">allowed_quality_dict</span><span class="p">[</span><span class="s1">&#39;GZGC&#39;</span><span class="p">])</span>
    <span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GGR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_bad_quality</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GGR&#39;</span><span class="p">],</span> <span class="n">allowed_quality_dict</span><span class="p">[</span><span class="s1">&#39;GZGC&#39;</span><span class="p">])</span>

    <span class="n">num_quality_gzgc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GZGC&#39;</span><span class="p">])</span>
    <span class="n">num_quality_ggr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GGR&#39;</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;quality&#39;</span><span class="p">,</span> <span class="n">num_quality_gzgc</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;quality&#39;</span><span class="p">,</span> <span class="n">num_quality_ggr</span><span class="p">)</span>

    <span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GZGC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_bad_metadata</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GZGC&#39;</span><span class="p">])</span>
    <span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GGR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_bad_metadata</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GGR&#39;</span><span class="p">])</span>

    <span class="n">num_metadata_gzgc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GZGC&#39;</span><span class="p">])</span>
    <span class="n">num_metadata_ggr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">[</span><span class="s1">&#39;GGR&#39;</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="n">num_metadata_gzgc</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="n">num_metadata_ggr</span><span class="p">)</span>

    <span class="c1"># dataset_dict[&#39;GZGC&#39;] = filter_singletons(dataset_dict[&#39;GZGC&#39;])</span>
    <span class="c1"># dataset_dict[&#39;GGR&#39;] = filter_singletons(dataset_dict[&#39;GGR&#39;])</span>

    <span class="c1"># num_named_gzgc = len(dataset_dict[&#39;GZGC&#39;])</span>
    <span class="c1"># num_named_ggr = len(dataset_dict[&#39;GGR&#39;])</span>

    <span class="c1"># print(&#39;named&#39;, num_named_gzgc)</span>
    <span class="c1"># print(&#39;named&#39;, num_named_ggr)</span>

    <span class="n">stage_list_gzgc</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">num_all_gzgc</span><span class="p">,</span>
        <span class="n">num_species_gzgc</span><span class="p">,</span>
        <span class="n">num_viewpoint_gzgc</span><span class="p">,</span>
        <span class="n">num_quality_gzgc</span><span class="p">,</span>
        <span class="n">num_metadata_gzgc</span><span class="p">,</span>
        <span class="c1"># num_named_gzgc,</span>
        <span class="mi">0</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">stage_list_ggr</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">num_all_ggr</span><span class="p">,</span>
        <span class="n">num_species_ggr</span><span class="p">,</span>
        <span class="n">num_viewpoint_ggr</span><span class="p">,</span>
        <span class="n">num_quality_ggr</span><span class="p">,</span>
        <span class="n">num_metadata_ggr</span><span class="p">,</span>
        <span class="c1"># num_named_ggr,</span>
        <span class="mi">0</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">diff_list_gzgc</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">stage_list_gzgc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">stage_list_gzgc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stage_list_gzgc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">diff_list_ggr</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">stage_list_ggr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">stage_list_ggr</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stage_list_ggr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">bar_value_list</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">diff_list_gzgc</span><span class="p">,</span> <span class="n">diff_list_ggr</span><span class="p">)))</span>

    <span class="c1"># Get number of annotations per name as a histogram for each species</span>
    <span class="n">embedded</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">globals</span><span class="p">(),</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;advanced4&#39;</span><span class="p">,</span>
                         <span class="n">__wrapper_header__</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">embedded</span><span class="p">)</span></div>


<div class="viewcode-block" id="view_imagesets"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.view_imagesets">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/view/imagesets/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">view_imagesets</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">update_all_image_special_imageset</span><span class="p">()</span>
    <span class="n">imgsetid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imgsetid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="n">imgsetid</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">imgsetid_</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">imgsetid_</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">imgsetid_</span><span class="p">)</span> <span class="k">for</span> <span class="n">imgsetid_</span> <span class="ow">in</span> <span class="n">imgsetid_list</span> <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_imgsetids</span><span class="p">()</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">imageset_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid_list</span><span class="p">)</span>
    <span class="n">start_time_posix_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_start_time_posix</span><span class="p">(</span><span class="n">imgsetid_list</span><span class="p">)</span>
    <span class="n">datetime_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">unixtime_to_datetimestr</span><span class="p">(</span><span class="n">start_time_posix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_time_posix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span>
        <span class="s1">&#39;Unknown&#39;</span>
        <span class="k">for</span> <span class="n">start_time_posix</span> <span class="ow">in</span> <span class="n">start_time_posix_list</span>
    <span class="p">]</span>

    <span class="c1">######################################################################################</span>
    <span class="n">all_gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">all_aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>

    <span class="n">gids_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">(</span><span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid_</span><span class="p">)</span> <span class="k">for</span> <span class="n">imgsetid_</span> <span class="ow">in</span> <span class="n">imgsetid_list</span> <span class="p">]</span>
    <span class="n">num_gids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">gids_list</span><span class="p">))</span>

    <span class="c1">######################################################################################</span>
    <span class="n">all_gid_aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">all_gid_list</span><span class="p">)</span>
    <span class="n">gid_aid_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">gid</span><span class="p">:</span> <span class="n">aid_list</span>
        <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_gid_list</span><span class="p">,</span> <span class="n">all_gid_aids_list</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">aids_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">gid_aid_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">gid_list</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">gid_list</span> <span class="ow">in</span> <span class="n">gids_list</span>
    <span class="p">]</span>
    <span class="n">num_aids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">))</span>

    <span class="c1">######################################################################################</span>
    <span class="n">all_gid_reviewed_list</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">imageset_image_processed</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">all_gid_list</span><span class="p">)</span>
    <span class="n">gid_reviewed_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">gid</span><span class="p">:</span> <span class="n">reviewed</span>
        <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">reviewed</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_gid_list</span><span class="p">,</span> <span class="n">all_gid_reviewed_list</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">images_reviewed_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">gid_reviewed_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">gid_list</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">gid_list</span> <span class="ow">in</span> <span class="n">gids_list</span>
    <span class="p">]</span>

    <span class="c1">######################################################################################</span>
    <span class="n">all_aid_reviewed_list</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">imageset_annot_viewpoint_processed</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">all_aid_list</span><span class="p">)</span>
    <span class="n">aid_reviewed_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">aid</span><span class="p">:</span> <span class="n">reviewed</span>
        <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">reviewed</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_aid_list</span><span class="p">,</span> <span class="n">all_aid_reviewed_list</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">annots_reviewed_viewpoint_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">aid_reviewed_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">aid_list</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="n">aids_list</span>
    <span class="p">]</span>

    <span class="c1">######################################################################################</span>
    <span class="n">all_aid_reviewed_list</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">imageset_annot_quality_processed</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">all_aid_list</span><span class="p">)</span>
    <span class="n">aid_reviewed_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">aid</span><span class="p">:</span> <span class="n">reviewed</span>
        <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">reviewed</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_aid_list</span><span class="p">,</span> <span class="n">all_aid_reviewed_list</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">annots_reviewed_quality_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">aid_reviewed_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">aid_list</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="n">aids_list</span>
    <span class="p">]</span>

    <span class="c1">######################################################################################</span>
    <span class="n">image_processed_list</span>           <span class="o">=</span> <span class="p">[</span> <span class="n">images_reviewed</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">images_reviewed</span> <span class="ow">in</span> <span class="n">images_reviewed_list</span> <span class="p">]</span>
    <span class="n">annot_processed_viewpoint_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">annots_reviewed</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">annots_reviewed</span> <span class="ow">in</span> <span class="n">annots_reviewed_viewpoint_list</span> <span class="p">]</span>
    <span class="n">annot_processed_quality_list</span>   <span class="o">=</span> <span class="p">[</span> <span class="n">annots_reviewed</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">annots_reviewed</span> <span class="ow">in</span> <span class="n">annots_reviewed_quality_list</span> <span class="p">]</span>
    <span class="n">reviewed_list</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">all</span><span class="p">(</span><span class="n">images_reviewed</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">annots_reviewed_viewpoint</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">annot_processed_quality</span><span class="p">)</span> <span class="k">for</span> <span class="n">images_reviewed</span><span class="p">,</span> <span class="n">annots_reviewed_viewpoint</span><span class="p">,</span> <span class="n">annot_processed_quality</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">images_reviewed_list</span><span class="p">,</span> <span class="n">annots_reviewed_viewpoint_list</span><span class="p">,</span> <span class="n">annots_reviewed_quality_list</span><span class="p">))</span> <span class="p">]</span>
    <span class="n">is_normal_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">is_special_imageset</span><span class="p">(</span><span class="n">imgsetid_list</span><span class="p">))</span>

    <span class="n">imageset_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
        <span class="n">is_normal_list</span><span class="p">,</span>
        <span class="n">imgsetid_list</span><span class="p">,</span>
        <span class="n">imageset_text_list</span><span class="p">,</span>
        <span class="n">num_gids</span><span class="p">,</span>
        <span class="n">image_processed_list</span><span class="p">,</span>
        <span class="n">num_aids</span><span class="p">,</span>
        <span class="n">annot_processed_viewpoint_list</span><span class="p">,</span>
        <span class="n">annot_processed_quality_list</span><span class="p">,</span>
        <span class="n">start_time_posix_list</span><span class="p">,</span>
        <span class="n">datetime_list</span><span class="p">,</span>
        <span class="n">reviewed_list</span><span class="p">,</span>
    <span class="p">))</span>
    <span class="n">imageset_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;imagesets&#39;</span><span class="p">,</span>
                         <span class="n">filtered</span><span class="o">=</span><span class="n">filtered</span><span class="p">,</span>
                         <span class="n">imgsetid_list</span><span class="o">=</span><span class="n">imgsetid_list</span><span class="p">,</span>
                         <span class="n">imgsetid_list_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">imgsetid_list</span><span class="p">)),</span>
                         <span class="n">num_imgsetids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">imgsetid_list</span><span class="p">),</span>
                         <span class="n">imageset_list</span><span class="o">=</span><span class="n">imageset_list</span><span class="p">,</span>
                         <span class="n">num_imagesets</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">imageset_list</span><span class="p">))</span></div>


<div class="viewcode-block" id="view_graphs"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.view_graphs">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/view/graphs/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">view_graphs</span><span class="p">(</span><span class="n">sync</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="k">if</span> <span class="n">sync</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">ibeis</span>
        <span class="kn">import</span> <span class="nn">ibeis.constants</span> <span class="k">as</span> <span class="nn">const</span>

        <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>

        <span class="c1"># Save sex from current name</span>
        <span class="n">sex_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_sex</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">)</span>

        <span class="n">nid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN_NAME_ROWID</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">,</span> <span class="n">notify_wildbook</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_empty_nids</span><span class="p">()</span>

        <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Delete nids: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">),</span> <span class="p">))</span>

        <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;zebra_grevys&#39;</span><span class="p">,</span> <span class="s1">&#39;giraffe_reticulated&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_list</span><span class="p">:</span>
            <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">check_ggr_valid_aids</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_names_to_different_new_names</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">notify_wildbook</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">infr</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">AnnotInference</span><span class="p">(</span><span class="n">ibs</span><span class="o">=</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="o">=</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">autoinit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">reset_feedback</span><span class="p">(</span><span class="s1">&#39;staging&#39;</span><span class="p">,</span> <span class="n">apply</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">num_pccs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">positive_components</span><span class="p">()))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">proposing PCCs for </span><span class="si">%r</span><span class="s1">: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">num_pccs</span><span class="p">,</span> <span class="p">))</span>

            <span class="n">infr</span><span class="o">.</span><span class="n">relabel_using_reviews</span><span class="p">(</span><span class="n">rectify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">write_ibeis_staging_feedback</span><span class="p">()</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">write_ibeis_annotmatch_feedback</span><span class="p">()</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">write_ibeis_name_assignment</span><span class="p">(</span><span class="n">notify_wildbook</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_empty_nids</span><span class="p">()</span>
        <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Final nids: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">),</span> <span class="p">))</span>

        <span class="c1"># Reset sex for new names from old names</span>
        <span class="n">nid_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">)</span>

        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">new_nid_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_sex_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">nid_</span><span class="p">,</span> <span class="n">sex_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nid_list_</span><span class="p">,</span> <span class="n">sex_list_</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nid_</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nid_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nid_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">new_nid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nid_</span><span class="p">)</span>
                <span class="n">new_sex_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sex_</span><span class="p">)</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nid_</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_name_sex</span><span class="p">(</span><span class="n">new_nid_list</span><span class="p">,</span> <span class="n">new_sex_list</span><span class="p">)</span>

    <span class="n">graph_uuid_list</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">GRAPH_CLIENT_DICT</span>
    <span class="n">num_graphs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph_uuid_list</span><span class="p">)</span>

    <span class="n">graph_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">graph_uuid</span> <span class="ow">in</span> <span class="n">graph_uuid_list</span><span class="p">:</span>
        <span class="n">graph_client</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">GRAPH_CLIENT_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">graph_uuid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">graph_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">graph_uuid_str</span> <span class="o">=</span> <span class="s1">&#39;graph_uuid=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">graph_uuid</span><span class="p">),</span> <span class="p">)</span>
        <span class="n">graph_uuid_str</span> <span class="o">=</span> <span class="n">graph_uuid_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">graph_status</span><span class="p">,</span> <span class="n">graph_exception</span> <span class="o">=</span> <span class="n">graph_client</span><span class="o">.</span><span class="n">refresh_status</span><span class="p">()</span>
        <span class="n">infr_status</span> <span class="o">=</span> <span class="n">graph_client</span><span class="o">.</span><span class="n">infr_status</span>
        <span class="k">if</span> <span class="n">infr_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">infr_status</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">graph_exception</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">graph_exception</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">graph_exception</span> <span class="o">=</span> <span class="s1">&#39;Exception: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">graph_exception</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">graph_client</span><span class="o">.</span><span class="n">review_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_edges</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edge_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">graph_client</span><span class="o">.</span><span class="n">review_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">num_edges</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_list</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;Phase </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">infr_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;phase&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">infr_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loop_phase&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">infr_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_inconsistent&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">infr_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_converged&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">reviews</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_edges</span><span class="p">,</span> <span class="n">infr_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_meaningful&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">infr_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_pccs&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">graph_uuid</span><span class="p">,</span>
            <span class="n">graph_client</span><span class="o">.</span><span class="n">imagesets</span><span class="p">,</span>
            <span class="n">graph_status</span><span class="p">,</span>
            <span class="n">graph_exception</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">graph_client</span><span class="o">.</span><span class="n">aids</span><span class="p">),</span>
            <span class="n">reviews</span><span class="p">,</span>
            <span class="n">graph_uuid_str</span><span class="p">,</span>
            <span class="n">phase</span><span class="p">,</span>
            <span class="n">state</span>
        <span class="p">)</span>
        <span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

    <span class="n">embedded</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">globals</span><span class="p">(),</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;graphs&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">embedded</span><span class="p">)</span></div>


<div class="viewcode-block" id="image_view_api"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.image_view_api">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/view/image/&lt;gid&gt;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">image_view_api</span><span class="p">(</span><span class="n">gid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thumbnail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the base64 encoded image of image &lt;gid&gt;</span>

<span class="sd">    RESTful:</span>
<span class="sd">        Method: GET</span>
<span class="sd">        URL:    /image/view/&lt;gid&gt;/</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">encoded</span> <span class="o">=</span> <span class="n">routes_ajax</span><span class="o">.</span><span class="n">image_src</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">thumbnail</span><span class="o">=</span><span class="n">thumbnail</span><span class="p">,</span> <span class="n">fresh</span><span class="o">=</span><span class="n">fresh</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="n">encoded</span><span class="o">=</span><span class="n">encoded</span><span class="p">)</span></div>


<div class="viewcode-block" id="view_images"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.view_images">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/view/images/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">view_images</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">imgsetid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imgsetid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">gid</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">gid_</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">gid_</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">gid_</span><span class="p">)</span> <span class="k">for</span> <span class="n">gid_</span> <span class="ow">in</span> <span class="n">gid_list</span> <span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="n">imgsetid</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">imgsetid_</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">imgsetid_</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">imgsetid_</span><span class="p">)</span> <span class="k">for</span> <span class="n">imgsetid_</span> <span class="ow">in</span> <span class="n">imgsetid_list</span> <span class="p">]</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">(</span><span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">)</span> <span class="k">for</span> <span class="n">imgsetid_</span> <span class="ow">in</span> <span class="n">imgsetid_list</span> <span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Page</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">page_start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">appf</span><span class="o">.</span><span class="n">PAGE_SIZE</span><span class="p">)</span>
    <span class="n">page_end</span>   <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span> <span class="n">page</span> <span class="o">*</span> <span class="n">appf</span><span class="o">.</span><span class="n">PAGE_SIZE</span><span class="p">)</span>
    <span class="n">page_total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span> <span class="o">/</span> <span class="n">appf</span><span class="o">.</span><span class="n">PAGE_SIZE</span><span class="p">))</span>
    <span class="n">page_previous</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">page_start</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">page</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">page_next</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">page_end</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span> <span class="k">else</span> <span class="n">page</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">gid_list</span><span class="p">[</span><span class="n">page_start</span><span class="p">:</span><span class="n">page_end</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[web] Loading Page [ </span><span class="si">%d</span><span class="s1"> -&gt; </span><span class="si">%d</span><span class="s1"> ] (</span><span class="si">%d</span><span class="s1">), Prev: </span><span class="si">%s</span><span class="s1">, Next: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">page_start</span><span class="p">,</span> <span class="n">page_end</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span> <span class="n">page_previous</span><span class="p">,</span> <span class="n">page_next</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">image_unixtime_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">datetime_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">unixtime_to_datetimestr</span><span class="p">(</span><span class="n">image_unixtime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">image_unixtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span>
        <span class="s1">&#39;Unknown&#39;</span>
        <span class="k">for</span> <span class="n">image_unixtime</span> <span class="ow">in</span> <span class="n">image_unixtime_list</span>
    <span class="p">]</span>
    <span class="n">image_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
        <span class="n">gid_list</span><span class="p">,</span>
        <span class="p">[</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">imgsetid_list_</span><span class="p">))</span> <span class="k">for</span> <span class="n">imgsetid_list_</span> <span class="ow">in</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_imgsetids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span> <span class="p">],</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_gnames</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="n">image_unixtime_list</span><span class="p">,</span>
        <span class="n">datetime_list</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_gps</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_party_tag</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_contributor_tag</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_notes</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
        <span class="n">appf</span><span class="o">.</span><span class="n">imageset_image_processed</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">),</span>
    <span class="p">))</span>
    <span class="c1"># image_list.sort(key=lambda t: t[3])</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">,</span>
                         <span class="n">filtered</span><span class="o">=</span><span class="n">filtered</span><span class="p">,</span>
                         <span class="n">imgsetid_list</span><span class="o">=</span><span class="n">imgsetid_list</span><span class="p">,</span>
                         <span class="n">imgsetid_list_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">imgsetid_list</span><span class="p">)),</span>
                         <span class="n">num_imgsetids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">imgsetid_list</span><span class="p">),</span>
                         <span class="n">gid_list</span><span class="o">=</span><span class="n">gid_list</span><span class="p">,</span>
                         <span class="n">gid_list_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)),</span>
                         <span class="n">num_gids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
                         <span class="n">image_list</span><span class="o">=</span><span class="n">image_list</span><span class="p">,</span>
                         <span class="n">num_images</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">image_list</span><span class="p">),</span>
                         <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
                         <span class="n">page_start</span><span class="o">=</span><span class="n">page_start</span><span class="p">,</span>
                         <span class="n">page_end</span><span class="o">=</span><span class="n">page_end</span><span class="p">,</span>
                         <span class="n">page_total</span><span class="o">=</span><span class="n">page_total</span><span class="p">,</span>
                         <span class="n">page_previous</span><span class="o">=</span><span class="n">page_previous</span><span class="p">,</span>
                         <span class="n">page_next</span><span class="o">=</span><span class="n">page_next</span><span class="p">)</span></div>


<div class="viewcode-block" id="view_annotations"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.view_annotations">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/view/annotations/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">view_annotations</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">aid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">gid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">imgsetid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imgsetid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">aid</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">aid_</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">aid_</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">aid_</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid_</span> <span class="ow">in</span> <span class="n">aid_list</span> <span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">gid</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">gid_</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">gid_</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">gid_</span><span class="p">)</span> <span class="k">for</span> <span class="n">gid_</span> <span class="ow">in</span> <span class="n">gid_list</span> <span class="p">]</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="n">imgsetid</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">imgsetid_</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">imgsetid_</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">imgsetid_</span><span class="p">)</span> <span class="k">for</span> <span class="n">imgsetid_</span> <span class="ow">in</span> <span class="n">imgsetid_list</span> <span class="p">]</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">(</span><span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid_</span><span class="p">)</span> <span class="k">for</span> <span class="n">imgsetid_</span> <span class="ow">in</span> <span class="n">imgsetid_list</span> <span class="p">])</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Page</span>
    <span class="n">page_start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">appf</span><span class="o">.</span><span class="n">PAGE_SIZE</span><span class="p">)</span>
    <span class="n">page_end</span>   <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="n">page</span> <span class="o">*</span> <span class="n">appf</span><span class="o">.</span><span class="n">PAGE_SIZE</span><span class="p">)</span>
    <span class="n">page_total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="o">/</span> <span class="n">appf</span><span class="o">.</span><span class="n">PAGE_SIZE</span><span class="p">))</span>
    <span class="n">page_previous</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">page_start</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">page</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">page_next</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">page_end</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="k">else</span> <span class="n">page</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">aid_list</span><span class="p">[</span><span class="n">page_start</span><span class="p">:</span><span class="n">page_end</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[web] Loading Page [ </span><span class="si">%d</span><span class="s1"> -&gt; </span><span class="si">%d</span><span class="s1"> ] (</span><span class="si">%d</span><span class="s1">), Prev: </span><span class="si">%s</span><span class="s1">, Next: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">page_start</span><span class="p">,</span> <span class="n">page_end</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="n">page_previous</span><span class="p">,</span> <span class="n">page_next</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">annotation_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
        <span class="n">aid_list</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="p">[</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">imgsetid_list_</span><span class="p">))</span> <span class="k">for</span> <span class="n">imgsetid_list_</span> <span class="ow">in</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_imgsetids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="p">],</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_names</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_names</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_exemplar_flags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoints</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_sex_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_age_months_est</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_reviewed</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
        <span class="c1"># [ reviewed_viewpoint and reviewed_quality for reviewed_viewpoint, reviewed_quality in list(zip(appf.imageset_annot_viewpoint_processed(ibs, aid_list), appf.imageset_annot_quality_processed(ibs, aid_list))) ],</span>
    <span class="p">))</span>
    <span class="n">annotation_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;annotations&#39;</span><span class="p">,</span>
                         <span class="n">filtered</span><span class="o">=</span><span class="n">filtered</span><span class="p">,</span>
                         <span class="n">imgsetid_list</span><span class="o">=</span><span class="n">imgsetid_list</span><span class="p">,</span>
                         <span class="n">imgsetid_list_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">imgsetid_list</span><span class="p">)),</span>
                         <span class="n">num_imgsetids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">imgsetid_list</span><span class="p">),</span>
                         <span class="n">gid_list</span><span class="o">=</span><span class="n">gid_list</span><span class="p">,</span>
                         <span class="n">gid_list_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)),</span>
                         <span class="n">num_gids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
                         <span class="n">aid_list</span><span class="o">=</span><span class="n">aid_list</span><span class="p">,</span>
                         <span class="n">aid_list_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)),</span>
                         <span class="n">num_aids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
                         <span class="n">annotation_list</span><span class="o">=</span><span class="n">annotation_list</span><span class="p">,</span>
                         <span class="n">num_annotations</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">annotation_list</span><span class="p">),</span>
                         <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
                         <span class="n">page_start</span><span class="o">=</span><span class="n">page_start</span><span class="p">,</span>
                         <span class="n">page_end</span><span class="o">=</span><span class="n">page_end</span><span class="p">,</span>
                         <span class="n">page_total</span><span class="o">=</span><span class="n">page_total</span><span class="p">,</span>
                         <span class="n">page_previous</span><span class="o">=</span><span class="n">page_previous</span><span class="p">,</span>
                         <span class="n">page_next</span><span class="o">=</span><span class="n">page_next</span><span class="p">)</span></div>


<div class="viewcode-block" id="view_names"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.view_names">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/view/names/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">view_names</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">aid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">gid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">imgsetid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imgsetid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">nid_list</span> <span class="o">=</span> <span class="n">nid</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">nid_list</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">nid_</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">nid_</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">nid_</span><span class="p">)</span> <span class="k">for</span> <span class="n">nid_</span> <span class="ow">in</span> <span class="n">nid_list</span> <span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">aid</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">aid_</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">aid_</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">aid_</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid_</span> <span class="ow">in</span> <span class="n">aid_list</span> <span class="p">]</span>
        <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">gid</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">gid_</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">gid_</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">gid_</span><span class="p">)</span> <span class="k">for</span> <span class="n">gid_</span> <span class="ow">in</span> <span class="n">gid_list</span> <span class="p">]</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>
        <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="n">imgsetid</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">imgsetid_</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">imgsetid_</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">imgsetid_</span><span class="p">)</span> <span class="k">for</span> <span class="n">imgsetid_</span> <span class="ow">in</span> <span class="n">imgsetid_list</span> <span class="p">]</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">(</span><span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid_</span><span class="p">)</span> <span class="k">for</span> <span class="n">imgsetid_</span> <span class="ow">in</span> <span class="n">imgsetid_list</span> <span class="p">])</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>
        <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">()</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Page</span>
    <span class="n">appf</span><span class="o">.</span><span class="n">PAGE_SIZE_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">appf</span><span class="o">.</span><span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">page_start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">),</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">appf</span><span class="o">.</span><span class="n">PAGE_SIZE_</span><span class="p">)</span>
    <span class="n">page_end</span>   <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">),</span> <span class="n">page</span> <span class="o">*</span> <span class="n">appf</span><span class="o">.</span><span class="n">PAGE_SIZE_</span><span class="p">)</span>
    <span class="n">page_total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span> <span class="o">/</span> <span class="n">appf</span><span class="o">.</span><span class="n">PAGE_SIZE_</span><span class="p">))</span>
    <span class="n">page_previous</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">page_start</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">page</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">page_next</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">page_end</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span> <span class="k">else</span> <span class="n">page</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">nid_list</span><span class="p">[</span><span class="n">page_start</span><span class="p">:</span><span class="n">page_end</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[web] Loading Page [ </span><span class="si">%d</span><span class="s1"> -&gt; </span><span class="si">%d</span><span class="s1"> ] (</span><span class="si">%d</span><span class="s1">), Prev: </span><span class="si">%s</span><span class="s1">, Next: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">page_start</span><span class="p">,</span> <span class="n">page_end</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">),</span> <span class="n">page_previous</span><span class="p">,</span> <span class="n">page_next</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">annotations_list</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
        <span class="n">aid_list_</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">),</span>
        <span class="p">[</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">imgsetid_list_</span><span class="p">))</span> <span class="k">for</span> <span class="n">imgsetid_list_</span> <span class="ow">in</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_imgsetids</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">)</span> <span class="p">],</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_names</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_names</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_exemplar_flags</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoints</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_sex_texts</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">),</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_age_months_est</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">),</span>
        <span class="p">[</span> <span class="n">reviewed_viewpoint</span> <span class="ow">and</span> <span class="n">reviewed_quality</span> <span class="k">for</span> <span class="n">reviewed_viewpoint</span><span class="p">,</span> <span class="n">reviewed_quality</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">appf</span><span class="o">.</span><span class="n">imageset_annot_viewpoint_processed</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list_</span><span class="p">),</span> <span class="n">appf</span><span class="o">.</span><span class="n">imageset_annot_quality_processed</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list_</span><span class="p">)))</span> <span class="p">],</span>
    <span class="p">))</span> <span class="k">for</span> <span class="n">aid_list_</span> <span class="ow">in</span> <span class="n">aids_list</span> <span class="p">]</span>
    <span class="n">name_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
        <span class="n">nid_list</span><span class="p">,</span>
        <span class="n">annotations_list</span>
    <span class="p">))</span>
    <span class="n">name_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;names&#39;</span><span class="p">,</span>
                         <span class="n">filtered</span><span class="o">=</span><span class="n">filtered</span><span class="p">,</span>
                         <span class="n">imgsetid_list</span><span class="o">=</span><span class="n">imgsetid_list</span><span class="p">,</span>
                         <span class="n">imgsetid_list_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">imgsetid_list</span><span class="p">)),</span>
                         <span class="n">num_imgsetids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">imgsetid_list</span><span class="p">),</span>
                         <span class="n">gid_list</span><span class="o">=</span><span class="n">gid_list</span><span class="p">,</span>
                         <span class="n">gid_list_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)),</span>
                         <span class="n">num_gids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span>
                         <span class="n">aid_list</span><span class="o">=</span><span class="n">aid_list</span><span class="p">,</span>
                         <span class="n">aid_list_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)),</span>
                         <span class="n">num_aids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span>
                         <span class="n">nid_list</span><span class="o">=</span><span class="n">nid_list</span><span class="p">,</span>
                         <span class="n">nid_list_str</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)),</span>
                         <span class="n">num_nids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">),</span>
                         <span class="n">name_list</span><span class="o">=</span><span class="n">name_list</span><span class="p">,</span>
                         <span class="n">num_names</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">name_list</span><span class="p">),</span>
                         <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
                         <span class="n">page_start</span><span class="o">=</span><span class="n">page_start</span><span class="p">,</span>
                         <span class="n">page_end</span><span class="o">=</span><span class="n">page_end</span><span class="p">,</span>
                         <span class="n">page_total</span><span class="o">=</span><span class="n">page_total</span><span class="p">,</span>
                         <span class="n">page_previous</span><span class="o">=</span><span class="n">page_previous</span><span class="p">,</span>
                         <span class="n">page_next</span><span class="o">=</span><span class="n">page_next</span><span class="p">)</span></div>


<div class="viewcode-block" id="action"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.action">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/action/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">action</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="n">imgsetid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imgsetid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">imgsetid</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">imgsetid</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">imgsetid</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>

    <span class="n">job_id_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_job_id_list</span><span class="p">()</span>
    <span class="n">job_action_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_id_list</span><span class="p">)</span>
    <span class="n">job_status_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_job_status</span><span class="p">(</span><span class="n">job_id</span><span class="p">)[</span><span class="s1">&#39;jobstatus&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">job_id_list</span>
    <span class="p">]</span>
    <span class="n">action_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">job_id_list</span><span class="p">,</span> <span class="n">job_action_list</span><span class="p">,</span> <span class="n">job_status_list</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">,</span>
                         <span class="n">action_list</span><span class="o">=</span><span class="n">action_list</span><span class="p">,</span>
                         <span class="n">num_actions</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">action_list</span><span class="p">))</span></div>


<div class="viewcode-block" id="action_detect"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.action_detect">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/action/detect/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">action_detect</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">image_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">start_detect_image</span><span class="p">(</span><span class="n">image_uuid_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="action_identification"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.action_identification">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/action/identify/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">action_identification</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="n">ibs</span><span class="o">.</span><span class="n">start_web_query_all</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="turk"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk</span><span class="p">(</span><span class="n">imgsetid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_make_review_image_info</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.web.apis_detect import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; gid = ibs.get_valid_gids()[0]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Shows how to use new object-like interface to populate data</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">images</span><span class="p">([</span><span class="n">gid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">annots</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">annots</span>
    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">sizes</span>
    <span class="n">bbox_denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">])</span>
    <span class="n">annotation_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">annots</span><span class="o">.</span><span class="n">aids</span><span class="p">:</span>
        <span class="n">annot_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">aid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">annot_</span><span class="o">.</span><span class="n">bboxes</span><span class="p">)</span>
        <span class="n">bbox_percent</span> <span class="o">=</span> <span class="n">bbox</span> <span class="o">/</span> <span class="n">bbox_denom</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;left&#39;</span>   <span class="p">:</span>  <span class="n">bbox_percent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;top&#39;</span>    <span class="p">:</span>  <span class="n">bbox_percent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;width&#39;</span>  <span class="p">:</span>  <span class="n">bbox_percent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s1">&#39;height&#39;</span> <span class="p">:</span>  <span class="n">bbox_percent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="s1">&#39;label&#39;</span>  <span class="p">:</span>  <span class="n">annot_</span><span class="o">.</span><span class="n">species</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span>     <span class="p">:</span>  <span class="n">annot_</span><span class="o">.</span><span class="n">aids</span><span class="p">,</span>
            <span class="s1">&#39;theta&#39;</span>  <span class="p">:</span>  <span class="n">annot_</span><span class="o">.</span><span class="n">thetas</span><span class="p">,</span>
            <span class="s1">&#39;tags&#39;</span>   <span class="p">:</span>  <span class="n">annot_</span><span class="o">.</span><span class="n">case_tags</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="n">annotation_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>


<div class="viewcode-block" id="turk_cameratrap"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_cameratrap">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/cameratrap/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_cameratrap</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
    <span class="n">tup</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">get_turk_image_args</span><span class="p">(</span><span class="n">appf</span><span class="o">.</span><span class="n">imageset_image_cameratrap_processed</span><span class="p">)</span>
    <span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">reviewed_list</span><span class="p">,</span> <span class="n">imgsetid</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span> <span class="o">=</span> <span class="n">tup</span>

    <span class="n">finished</span> <span class="o">=</span> <span class="n">gid</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
        <span class="n">image_src</span> <span class="o">=</span> <span class="n">routes_ajax</span><span class="o">.</span><span class="n">image_src</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">positive</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_cameratrap</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image_src</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">positive</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">imagesettext</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>

    <span class="n">embedded</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">globals</span><span class="p">(),</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="s1">&#39;cameratrap&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">embedded</span><span class="p">)</span></div>


<div class="viewcode-block" id="precompute_web_detection_thumbnails"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.precompute_web_detection_thumbnails">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">precompute_web_detection_thumbnails</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;thumbsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">appf</span><span class="o">.</span><span class="n">TARGET_WIDTH</span><span class="p">),</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">appf</span><span class="o">.</span><span class="n">TARGET_HEIGHT</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;draw_annots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_thumbpath</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">ensure_paths</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="precompute_web_viewpoint_thumbnails"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.precompute_web_viewpoint_thumbnails">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">precompute_web_viewpoint_thumbnails</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dim_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">appf</span><span class="o">.</span><span class="n">TARGET_WIDTH</span><span class="p">),</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">appf</span><span class="o">.</span><span class="n">TARGET_HEIGHT</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">_parallel_chips</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chip_fpath</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="turk_detection"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_detection">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/detection/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_detection</span><span class="p">(</span><span class="n">gid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refer_aid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imgsetid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">previous</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">staged_super</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="n">default_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;autointerest&#39;</span><span class="p">,</span>            <span class="kc">False</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;interest_bypass&#39;</span><span class="p">,</span>         <span class="kc">False</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span>                <span class="kc">True</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;metadata_viewpoint&#39;</span><span class="p">,</span>      <span class="kc">True</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;metadata_quality&#39;</span><span class="p">,</span>        <span class="kc">True</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;metadata_flags&#39;</span><span class="p">,</span>          <span class="kc">True</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;metadata_flags_aoi&#39;</span><span class="p">,</span>      <span class="kc">True</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;metadata_flags_multiple&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;metadata_species&#39;</span><span class="p">,</span>        <span class="kc">True</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;metadata_label&#39;</span><span class="p">,</span>          <span class="kc">True</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;metadata_quickhelp&#39;</span><span class="p">,</span>      <span class="kc">True</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;parts&#39;</span><span class="p">,</span>                   <span class="kc">True</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;modes_rectangle&#39;</span><span class="p">,</span>         <span class="kc">True</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;modes_diagonal&#39;</span><span class="p">,</span>          <span class="kc">True</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;modes_diagonal2&#39;</span><span class="p">,</span>         <span class="kc">True</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;staged&#39;</span><span class="p">,</span>                  <span class="kc">False</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">config_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">config_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">default_list</span>
    <span class="p">}</span>
    <span class="n">config_str_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="n">config_str</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_str_list</span><span class="p">)</span>

    <span class="n">is_staged</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;staged&#39;</span><span class="p">]</span>
    <span class="n">staged_reviews_required</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="n">imgsetid</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">imgsetid</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">imgsetid</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="k">else</span> <span class="n">imgsetid</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">(</span><span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">)</span>
    <span class="n">reviewed_list</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">imageset_image_processed</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">is_staged</span><span class="o">=</span><span class="n">is_staged</span><span class="p">,</span>
                                                  <span class="n">reviews_required</span><span class="o">=</span><span class="n">staged_reviews_required</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="n">reviewed_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">),</span> <span class="p">)</span>
    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="s1">&#39;100.0&#39;</span>

    <span class="k">if</span> <span class="n">is_staged</span><span class="p">:</span>
        <span class="n">staged_progress</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">imageset_image_staged_progress</span><span class="p">(</span>
            <span class="n">ibs</span><span class="p">,</span>
            <span class="n">gid_list</span><span class="p">,</span>
            <span class="n">reviews_required</span><span class="o">=</span><span class="n">staged_reviews_required</span>
        <span class="p">)</span>
        <span class="n">staged_progress</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="n">staged_progress</span><span class="p">,</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">staged_progress</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">imagesettext</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">imgsetid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">reviewed_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># gid = gid_list_[0]</span>
            <span class="n">gid</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="n">gid</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">review</span> <span class="o">=</span> <span class="s1">&#39;review&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">display_instructions</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># request.cookies.get(&#39;ia-detection_instructions_seen&#39;, 1) == 1</span>
    <span class="n">display_new_features</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ia-detection_new_features_seen&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">display_species_examples</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># request.cookies.get(&#39;ia-detection_example_species_seen&#39;, 0) == 0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
        <span class="n">image_src</span> <span class="o">=</span> <span class="n">routes_ajax</span><span class="o">.</span><span class="n">image_src</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_sizes</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>

        <span class="n">staged_user</span> <span class="o">=</span> <span class="n">controller_inject</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
        <span class="n">staged_user_id</span> <span class="o">=</span> <span class="n">staged_user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Get annotations</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">is_staged</span><span class="o">=</span><span class="n">is_staged</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_staged</span><span class="p">:</span>
            <span class="c1"># Filter aids for current user</span>
            <span class="n">annot_user_id_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_staged_user_ids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="n">aid_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">aid</span>
                <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">annot_user_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">annot_user_id_list</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">staged_super</span> <span class="ow">or</span> <span class="n">annot_user_id</span> <span class="o">==</span> <span class="n">staged_user_id</span>
            <span class="p">]</span>

        <span class="n">annot_bbox_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
        <span class="n">annot_theta_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
        <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
        <span class="n">viewpoint_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoints</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
        <span class="n">quality_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_qualities</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
        <span class="n">multiple_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_multiple</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
        <span class="n">interest_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_interest</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
        <span class="c1"># Get annotation bounding boxes</span>
        <span class="n">mapping_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">annotation_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">annot_bbox_list</span><span class="p">,</span> <span class="n">annot_theta_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">,</span> <span class="n">viewpoint_list</span><span class="p">,</span> <span class="n">quality_list</span><span class="p">,</span> <span class="n">multiple_list</span><span class="p">,</span> <span class="n">interest_list</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">annot_bbox</span><span class="p">,</span> <span class="n">annot_theta</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">viewpoint</span><span class="p">,</span> <span class="n">quality</span><span class="p">,</span> <span class="n">multiple</span><span class="p">,</span> <span class="n">interest</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">quality</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
                <span class="n">quality</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">quality</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">quality</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">quality</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">quality</span> <span class="o">=</span> <span class="mi">2</span>

            <span class="n">viewpoint1</span><span class="p">,</span> <span class="n">viewpoint2</span><span class="p">,</span> <span class="n">viewpoint3</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">convert_viewpoint_to_tuple</span><span class="p">(</span><span class="n">viewpoint</span><span class="p">)</span>

            <span class="n">temp</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">aid</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">annot_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">annot_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">annot_bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">annot_bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">annot_theta</span><span class="p">)</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;viewpoint1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">viewpoint1</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;viewpoint2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">viewpoint2</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;viewpoint3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">viewpoint3</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;quality&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">quality</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;multiple&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="s1">&#39;true&#39;</span> <span class="k">if</span> <span class="n">multiple</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;false&#39;</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;interest&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="s1">&#39;true&#39;</span> <span class="k">if</span> <span class="n">interest</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;false&#39;</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">species</span>

            <span class="n">mapping_dict</span><span class="p">[</span><span class="n">aid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotation_list</span><span class="p">)</span>
            <span class="n">annotation_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

        <span class="c1"># Get parts</span>
        <span class="n">part_rowid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_part_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">is_staged</span><span class="o">=</span><span class="n">is_staged</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">is_staged</span><span class="p">:</span>
            <span class="c1"># Filter part_rowids for current user</span>
            <span class="n">part_user_id_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_part_staged_user_ids</span><span class="p">(</span><span class="n">part_rowid_list</span><span class="p">)</span>
            <span class="n">part_rowid_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">part_rowid</span>
                <span class="k">for</span> <span class="n">part_rowid</span><span class="p">,</span> <span class="n">part_user_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">part_rowid_list</span><span class="p">,</span> <span class="n">part_user_id_list</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">staged_super</span> <span class="ow">or</span> <span class="n">part_user_id</span> <span class="o">==</span> <span class="n">staged_user_id</span>
            <span class="p">]</span>

        <span class="n">part_aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_part_aids</span><span class="p">(</span><span class="n">part_rowid_list</span><span class="p">)</span>
        <span class="n">part_bbox_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_part_bboxes</span><span class="p">(</span><span class="n">part_rowid_list</span><span class="p">)</span>
        <span class="n">part_theta_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_part_thetas</span><span class="p">(</span><span class="n">part_rowid_list</span><span class="p">)</span>
        <span class="n">part_viewpoint_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_part_viewpoints</span><span class="p">(</span><span class="n">part_rowid_list</span><span class="p">)</span>
        <span class="n">part_quality_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_part_qualities</span><span class="p">(</span><span class="n">part_rowid_list</span><span class="p">)</span>
        <span class="n">part_type_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_part_types</span><span class="p">(</span><span class="n">part_rowid_list</span><span class="p">)</span>
        <span class="c1"># Get annotation bounding boxes</span>

        <span class="n">part_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">part_rowid_list</span><span class="p">,</span> <span class="n">part_aid_list</span><span class="p">,</span> <span class="n">part_bbox_list</span><span class="p">,</span> <span class="n">part_theta_list</span><span class="p">,</span> <span class="n">part_viewpoint_list</span><span class="p">,</span> <span class="n">part_quality_list</span><span class="p">,</span> <span class="n">part_type_list</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">part_rowid</span><span class="p">,</span> <span class="n">part_aid</span><span class="p">,</span> <span class="n">part_bbox</span><span class="p">,</span> <span class="n">part_theta</span><span class="p">,</span> <span class="n">part_viewpoint</span><span class="p">,</span> <span class="n">part_quality</span><span class="p">,</span> <span class="n">part_type</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">part_quality</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
                <span class="n">part_quality</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">part_quality</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">part_quality</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">part_quality</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">part_quality</span> <span class="o">=</span> <span class="mi">2</span>

            <span class="n">viewpoint1</span><span class="p">,</span> <span class="n">viewpoint2</span><span class="p">,</span> <span class="n">viewpoint3</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">convert_viewpoint_to_tuple</span><span class="p">(</span><span class="n">part_viewpoint</span><span class="p">)</span>

            <span class="n">temp</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">part_rowid</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">mapping_dict</span><span class="p">[</span><span class="n">part_aid</span><span class="p">]</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">part_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">part_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">part_bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">part_bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">part_theta</span><span class="p">)</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;viewpoint1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">viewpoint1</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;quality&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">part_quality</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">part_type</span>
            <span class="n">part_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">species_list</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">species_list</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>  <span class="c1"># Get most common species</span>
        <span class="k">elif</span> <span class="n">appf</span><span class="o">.</span><span class="n">default_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">default_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="n">KEY_DEFAULTS</span><span class="p">[</span><span class="n">SPECIES_KEY</span><span class="p">]</span>

        <span class="n">staged_aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">is_staged</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">staged_part_rowid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_part_rowids</span><span class="p">(</span><span class="n">staged_aid_list</span><span class="p">,</span> <span class="n">is_staged</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">species</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">image_src</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">annotation_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">part_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">staged_aid_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">staged_part_rowid_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">staged_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_staged_uuids</span><span class="p">(</span><span class="n">staged_aid_list</span><span class="p">)</span>
    <span class="n">staged_user_id_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_staged_user_ids</span><span class="p">(</span><span class="n">staged_aid_list</span><span class="p">)</span>

    <span class="n">num_staged_aids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">staged_aid_list</span><span class="p">)</span>
    <span class="n">num_staged_part_rowids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">staged_part_rowid_list</span><span class="p">)</span>
    <span class="n">num_staged_sessions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">staged_uuid_list</span><span class="p">))</span>
    <span class="n">num_staged_users</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">staged_user_id_list</span><span class="p">))</span>

    <span class="n">THROW_TEST_AOI_TURKING_MANIFEST</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">THROW_TEST_AOI_TURKING_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">THROW_TEST_AOI_TURKING</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">THROW_TEST_AOI_TURKING_PERCENTAGE</span><span class="p">:</span>
            <span class="n">THROW_TEST_AOI_TURKING_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">annotation_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">annotation_list</span><span class="p">)</span>
            <span class="n">part_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">part_list</span><span class="p">)</span>

            <span class="n">key_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">THROW_TEST_AOI_TURKING_ERROR_MODES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">throw_test_aoi_turking_mode</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">key_list</span><span class="p">)</span>
            <span class="n">throw_test_aoi_turking_severity</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                <span class="n">THROW_TEST_AOI_TURKING_ERROR_MODES</span><span class="p">[</span><span class="n">throw_test_aoi_turking_mode</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">throw_test_aoi_turking_severity</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="n">throw_test_aoi_turking_severity</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">annotation_list</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">throw_test_aoi_turking_mode</span><span class="p">,</span> <span class="n">throw_test_aoi_turking_severity</span><span class="p">,</span> <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;throw_test_aoi_turking: </span><span class="si">%r</span><span class="s1"> mode with </span><span class="si">%r</span><span class="s1"> severity&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>

            <span class="n">index_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">annotation_list</span><span class="p">)))</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">index_list</span><span class="p">)</span>
            <span class="n">index_list</span> <span class="o">=</span> <span class="n">index_list</span><span class="p">[:</span><span class="n">throw_test_aoi_turking_severity</span><span class="p">]</span>
            <span class="n">index_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">index_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">throw_test_aoi_turking_mode</span><span class="p">,</span> <span class="n">throw_test_aoi_turking_severity</span><span class="p">,</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">throw_test_aoi_turking_mode</span> <span class="o">==</span> <span class="s1">&#39;addition&#39;</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">index_list</span><span class="p">:</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">)</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">)</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">100.0</span> <span class="o">-</span> <span class="n">width</span><span class="p">)</span>
                    <span class="n">top</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">100.0</span> <span class="o">-</span> <span class="n">height</span><span class="p">)</span>
                    <span class="n">species</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_all_species_texts</span><span class="p">())</span>
                    <span class="n">annotation</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;top&#39;</span><span class="p">:</span> <span class="n">top</span><span class="p">,</span>
                        <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="n">left</span><span class="p">,</span>
                        <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
                        <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">,</span>
                        <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="n">species</span><span class="p">,</span>
                        <span class="s1">&#39;quality&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;interest&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;multiple&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;viewpoint1&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="s1">&#39;viewpoint2&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="s1">&#39;viewpoint3&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">annotation_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
                    <span class="n">THROW_TEST_AOI_TURKING_MANIFEST</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;addition&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">annotation</span><span class="p">,</span>
                    <span class="p">})</span>
            <span class="k">elif</span> <span class="n">throw_test_aoi_turking_mode</span> <span class="o">==</span> <span class="s1">&#39;deletion&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">part_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">index_list</span><span class="p">:</span>
                        <span class="n">annotation</span> <span class="o">=</span> <span class="n">annotation_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                        <span class="n">THROW_TEST_AOI_TURKING_MANIFEST</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;deletion&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">annotation</span><span class="p">,</span>
                        <span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">THROW_TEST_AOI_TURKING_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">throw_test_aoi_turking_mode</span> <span class="o">==</span> <span class="s1">&#39;alteration&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">index_list</span><span class="p">:</span>
                    <span class="n">direction_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">]</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">direction_list</span><span class="p">)</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;left&#39;</span><span class="p">]</span>
                    <span class="n">top</span> <span class="o">=</span> <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;top&#39;</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
                        <span class="n">delta</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="mf">0.25</span>
                        <span class="n">left</span> <span class="o">-=</span> <span class="n">delta</span>
                        <span class="n">width</span> <span class="o">+=</span> <span class="n">delta</span>
                    <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
                        <span class="n">delta</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="mf">0.25</span>
                        <span class="n">width</span> <span class="o">+=</span> <span class="n">delta</span>
                    <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
                        <span class="n">delta</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="mf">0.25</span>
                        <span class="n">top</span> <span class="o">-=</span> <span class="n">delta</span>
                        <span class="n">height</span> <span class="o">+=</span> <span class="n">delta</span>
                    <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span>
                        <span class="n">delta</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="mf">0.25</span>
                        <span class="n">height</span> <span class="o">+=</span> <span class="n">delta</span>

                    <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">100.0</span><span class="p">)</span>
                    <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">100.0</span><span class="p">)</span>
                    <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;left&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">100.0</span><span class="p">)</span>
                    <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;top&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">100.0</span><span class="p">)</span>

                    <span class="n">THROW_TEST_AOI_TURKING_MANIFEST</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;alteration-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="p">),</span>
                        <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
                    <span class="p">})</span>
            <span class="k">elif</span> <span class="n">throw_test_aoi_turking_mode</span> <span class="o">==</span> <span class="s1">&#39;translation&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">index_list</span><span class="p">:</span>
                    <span class="n">direction_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">]</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">direction_list</span><span class="p">)</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;left&#39;</span><span class="p">]</span>
                    <span class="n">top</span> <span class="o">=</span> <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;top&#39;</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
                        <span class="n">delta</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="mf">0.25</span>
                        <span class="n">left</span> <span class="o">-=</span> <span class="n">delta</span>
                    <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
                        <span class="n">delta</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="mf">0.25</span>
                        <span class="n">left</span> <span class="o">+=</span> <span class="n">delta</span>
                    <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
                        <span class="n">delta</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="mf">0.25</span>
                        <span class="n">top</span> <span class="o">-=</span> <span class="n">delta</span>
                    <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span>
                        <span class="n">delta</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="mf">0.25</span>
                        <span class="n">top</span> <span class="o">+=</span> <span class="n">delta</span>

                    <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">100.0</span><span class="p">)</span>
                    <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">100.0</span><span class="p">)</span>
                    <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;left&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">100.0</span><span class="p">)</span>
                    <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;top&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">100.0</span><span class="p">)</span>

                    <span class="n">THROW_TEST_AOI_TURKING_MANIFEST</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;translation-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="p">),</span>
                        <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">annotation_list</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
                    <span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid throw_test_aoi_turking_mode&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">THROW_TEST_AOI_TURKING_MANIFEST</span><span class="p">))</span>

    <span class="n">THROW_TEST_AOI_TURKING_MANIFEST</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">THROW_TEST_AOI_TURKING_MANIFEST</span><span class="p">)</span>

    <span class="n">species_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_species_rowids</span><span class="p">()</span>
    <span class="n">species_nice_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_nice</span><span class="p">(</span><span class="n">species_rowids</span><span class="p">)</span>

    <span class="n">combined_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_nice_list</span><span class="p">,</span> <span class="n">species_rowids</span><span class="p">))</span>
    <span class="n">species_nice_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">combined</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">combined</span> <span class="ow">in</span> <span class="n">combined_list</span> <span class="p">]</span>
    <span class="n">species_rowids</span> <span class="o">=</span> <span class="p">[</span> <span class="n">combined</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">combined</span> <span class="ow">in</span> <span class="n">combined_list</span> <span class="p">]</span>

    <span class="n">species_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_texts</span><span class="p">(</span><span class="n">species_rowids</span><span class="p">)</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_nice_list</span><span class="p">,</span> <span class="n">species_text_list</span><span class="p">))</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="s1">&#39;Unspecified&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">)</span> <span class="p">]</span> <span class="o">+</span> <span class="n">species_list</span>

    <span class="c1"># Collect mapping of species to parts</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">part_species_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">part_species_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_texts</span><span class="p">(</span><span class="n">part_species_rowid_list</span><span class="p">)</span>
    <span class="n">part_rowids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_part_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">part_types_list</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_part_types</span><span class="p">,</span> <span class="n">part_rowids_list</span><span class="p">)</span>

    <span class="n">zipped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">part_species_text_list</span><span class="p">,</span> <span class="n">part_types_list</span><span class="p">))</span>
    <span class="n">species_part_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">:</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">part_species_text</span><span class="p">,</span> <span class="n">part_type_list</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">part_species_text</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">species_part_dict</span><span class="p">:</span>
            <span class="n">species_part_dict</span><span class="p">[</span><span class="n">part_species_text</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">part_type</span> <span class="ow">in</span> <span class="n">part_type_list</span><span class="p">:</span>
            <span class="n">species_part_dict</span><span class="p">[</span><span class="n">part_species_text</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">part_type</span><span class="p">)</span>
            <span class="n">species_part_dict</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">part_type</span><span class="p">)</span>
    <span class="c1"># Add any images that did not get added because they aren&#39;t assigned any annotations</span>
    <span class="k">for</span> <span class="n">species_text</span> <span class="ow">in</span> <span class="n">species_text_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">species_text</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">species_part_dict</span><span class="p">:</span>
            <span class="n">species_part_dict</span><span class="p">[</span><span class="n">species_text</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">species_part_dict</span><span class="p">:</span>
        <span class="n">species_part_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">species_part_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
    <span class="n">species_part_dict_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">species_part_dict</span><span class="p">)</span>

    <span class="n">orientation_flag</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
    <span class="k">if</span> <span class="n">species</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;zebra&#39;</span> <span class="ow">in</span> <span class="n">species</span><span class="p">:</span>
        <span class="n">orientation_flag</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>

    <span class="n">settings_key_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;ia-detection-setting-orientation&#39;</span><span class="p">,</span> <span class="n">orientation_flag</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;ia-detection-setting-parts-assignments&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;ia-detection-setting-toggle-annotations&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;ia-detection-setting-toggle-parts&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;ia-detection-setting-parts-show&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;ia-detection-setting-parts-hide&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">settings_key</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">settings_key</span><span class="p">,</span> <span class="n">settings_default</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">settings_key</span><span class="p">,</span> <span class="n">settings_default</span><span class="p">)</span> <span class="ow">in</span> <span class="n">settings_key_list</span>
    <span class="p">}</span>

    <span class="n">callback_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">?imgsetid=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;submit_detection&#39;</span><span class="p">),</span> <span class="n">imgsetid</span><span class="p">,</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="s1">&#39;detection&#39;</span><span class="p">,</span>
                         <span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">,</span>
                         <span class="n">gid</span><span class="o">=</span><span class="n">gid</span><span class="p">,</span>
                         <span class="n">config_str</span><span class="o">=</span><span class="n">config_str</span><span class="p">,</span>
                         <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                         <span class="n">refer_aid</span><span class="o">=</span><span class="n">refer_aid</span><span class="p">,</span>
                         <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                         <span class="n">image_src</span><span class="o">=</span><span class="n">image_src</span><span class="p">,</span>
                         <span class="n">previous</span><span class="o">=</span><span class="n">previous</span><span class="p">,</span>
                         <span class="n">imagesettext</span><span class="o">=</span><span class="n">imagesettext</span><span class="p">,</span>
                         <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                         <span class="n">staged_progress</span><span class="o">=</span><span class="n">staged_progress</span><span class="p">,</span>
                         <span class="n">finished</span><span class="o">=</span><span class="n">finished</span><span class="p">,</span>
                         <span class="n">species_list</span><span class="o">=</span><span class="n">species_list</span><span class="p">,</span>
                         <span class="n">species_part_dict_json</span><span class="o">=</span><span class="n">species_part_dict_json</span><span class="p">,</span>
                         <span class="n">annotation_list</span><span class="o">=</span><span class="n">annotation_list</span><span class="p">,</span>
                         <span class="n">part_list</span><span class="o">=</span><span class="n">part_list</span><span class="p">,</span>
                         <span class="n">display_instructions</span><span class="o">=</span><span class="n">display_instructions</span><span class="p">,</span>
                         <span class="n">display_new_features</span><span class="o">=</span><span class="n">display_new_features</span><span class="p">,</span>
                         <span class="n">display_species_examples</span><span class="o">=</span><span class="n">display_species_examples</span><span class="p">,</span>
                         <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
                         <span class="n">THROW_TEST_AOI_TURKING_AVAILABLE</span><span class="o">=</span><span class="n">THROW_TEST_AOI_TURKING_AVAILABLE</span><span class="p">,</span>
                         <span class="n">THROW_TEST_AOI_TURKING_MANIFEST</span><span class="o">=</span><span class="n">THROW_TEST_AOI_TURKING_MANIFEST</span><span class="p">,</span>
                         <span class="n">is_staged</span><span class="o">=</span><span class="n">is_staged</span><span class="p">,</span>
                         <span class="n">num_staged_aids</span><span class="o">=</span><span class="n">num_staged_aids</span><span class="p">,</span>
                         <span class="n">num_staged_part_rowids</span><span class="o">=</span><span class="n">num_staged_part_rowids</span><span class="p">,</span>
                         <span class="n">num_staged_sessions</span><span class="o">=</span><span class="n">num_staged_sessions</span><span class="p">,</span>
                         <span class="n">num_staged_users</span><span class="o">=</span><span class="n">num_staged_users</span><span class="p">,</span>
                         <span class="n">callback_url</span><span class="o">=</span><span class="n">callback_url</span><span class="p">,</span>
                         <span class="n">callback_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
                         <span class="n">EMBEDDED</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">EMBEDDED_CSS</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">EMBEDDED_JAVASCRIPT</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">review</span><span class="o">=</span><span class="n">review</span><span class="p">)</span></div>


<div class="viewcode-block" id="turk_detection_dynamic"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_detection_dynamic">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/detection/dynamic/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_detection_dynamic</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
    <span class="n">gid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">image_src</span> <span class="o">=</span> <span class="n">routes_ajax</span><span class="o">.</span><span class="n">image_src</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
    <span class="c1"># Get annotations</span>
    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_sizes</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
    <span class="n">annot_bbox_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">annot_thetas_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="c1"># Get annotation bounding boxes</span>
    <span class="n">annotation_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">annot_bbox</span><span class="p">,</span> <span class="n">annot_theta</span><span class="p">,</span> <span class="n">species</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">annot_bbox_list</span><span class="p">,</span> <span class="n">annot_thetas_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">annot_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">annot_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">annot_bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">annot_bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">species</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">aid</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">annot_theta</span><span class="p">)</span>
        <span class="n">annotation_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">species</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">species_list</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">species_list</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>  <span class="c1"># Get most common species</span>
    <span class="k">elif</span> <span class="n">appf</span><span class="o">.</span><span class="n">default_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">default_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">KEY_DEFAULTS</span><span class="p">[</span><span class="n">SPECIES_KEY</span><span class="p">]</span>

    <span class="n">callback_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">?imgsetid=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;submit_detection&#39;</span><span class="p">),</span> <span class="n">gid</span><span class="p">,</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="s1">&#39;detection_dynamic&#39;</span><span class="p">,</span>
                         <span class="n">gid</span><span class="o">=</span><span class="n">gid</span><span class="p">,</span>
                         <span class="n">refer_aid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                         <span class="n">image_src</span><span class="o">=</span><span class="n">image_src</span><span class="p">,</span>
                         <span class="n">annotation_list</span><span class="o">=</span><span class="n">annotation_list</span><span class="p">,</span>
                         <span class="n">callback_url</span><span class="o">=</span><span class="n">callback_url</span><span class="p">,</span>
                         <span class="n">callback_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
                         <span class="n">EMBEDDED_CSS</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">EMBEDDED_JAVASCRIPT</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">__wrapper__</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="turk_annotation"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_annotation">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/annotation/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_annotation</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.web.app --exec-turk_annotation --db PZ_Master1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.other.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;PZ_Master1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list_ = ibs.find_unlabeled_name_members(suspect_yaws=True)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.filter_aids_to_quality(aid_list_, &#39;good&#39;, unknown_ok=False)</span>
<span class="sd">        &gt;&gt;&gt; ibs.start_web_annot_groupreview(aid_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
    <span class="n">tup</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">get_turk_annot_args</span><span class="p">(</span><span class="n">appf</span><span class="o">.</span><span class="n">imageset_annot_processed</span><span class="p">)</span>
    <span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">reviewed_list</span><span class="p">,</span> <span class="n">imgsetid</span><span class="p">,</span> <span class="n">src_ag</span><span class="p">,</span> <span class="n">dst_ag</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span> <span class="o">=</span> <span class="n">tup</span>

    <span class="n">review</span> <span class="o">=</span> <span class="s1">&#39;review&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="n">aid</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">display_instructions</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ia-annotation_instructions_seen&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
        <span class="n">gid</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">image_src</span> <span class="o">=</span> <span class="n">routes_ajax</span><span class="o">.</span><span class="n">annotation_src</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">species</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">viewpoint_text</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoints</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">viewpoint_value</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">VIEWPOINT_MAPPING_INVERT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">viewpoint_text</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">quality_value</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_qualities</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">quality_value</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="n">quality_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">quality_value</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">quality_value</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">quality_value</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">quality_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">multiple_value</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_multiple</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">update_special_imagesets</span><span class="p">()</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">notify_observers</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">gid</span>       <span class="o">=</span> <span class="kc">None</span>
        <span class="n">image_src</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">species</span>   <span class="o">=</span> <span class="kc">None</span>
        <span class="n">viewpoint_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">quality_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">multiple_value</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">imagesettext</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>

    <span class="n">species_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_species_rowids</span><span class="p">()</span>
    <span class="n">species_nice_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_nice</span><span class="p">(</span><span class="n">species_rowids</span><span class="p">)</span>

    <span class="n">combined_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_nice_list</span><span class="p">,</span> <span class="n">species_rowids</span><span class="p">))</span>
    <span class="n">species_nice_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">combined</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">combined</span> <span class="ow">in</span> <span class="n">combined_list</span> <span class="p">]</span>
    <span class="n">species_rowids</span> <span class="o">=</span> <span class="p">[</span> <span class="n">combined</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">combined</span> <span class="ow">in</span> <span class="n">combined_list</span> <span class="p">]</span>

    <span class="n">species_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_texts</span><span class="p">(</span><span class="n">species_rowids</span><span class="p">)</span>
    <span class="n">species_selected_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">species</span> <span class="o">==</span> <span class="n">species_</span> <span class="k">for</span> <span class="n">species_</span> <span class="ow">in</span> <span class="n">species_text_list</span> <span class="p">]</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_nice_list</span><span class="p">,</span> <span class="n">species_text_list</span><span class="p">,</span> <span class="n">species_selected_list</span><span class="p">))</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="s1">&#39;Unspecified&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="p">]</span> <span class="o">+</span> <span class="n">species_list</span>

    <span class="n">callback_url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;submit_annotation&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="s1">&#39;annotation&#39;</span><span class="p">,</span>
                         <span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">,</span>
                         <span class="n">src_ag</span><span class="o">=</span><span class="n">src_ag</span><span class="p">,</span>
                         <span class="n">dst_ag</span><span class="o">=</span><span class="n">dst_ag</span><span class="p">,</span>
                         <span class="n">gid</span><span class="o">=</span><span class="n">gid</span><span class="p">,</span>
                         <span class="n">aid</span><span class="o">=</span><span class="n">aid</span><span class="p">,</span>
                         <span class="n">viewpoint_value</span><span class="o">=</span><span class="n">viewpoint_value</span><span class="p">,</span>
                         <span class="n">quality_value</span><span class="o">=</span><span class="n">quality_value</span><span class="p">,</span>
                         <span class="n">multiple_value</span><span class="o">=</span><span class="n">multiple_value</span><span class="p">,</span>
                         <span class="n">image_src</span><span class="o">=</span><span class="n">image_src</span><span class="p">,</span>
                         <span class="n">previous</span><span class="o">=</span><span class="n">previous</span><span class="p">,</span>
                         <span class="n">species_list</span><span class="o">=</span><span class="n">species_list</span><span class="p">,</span>
                         <span class="n">imagesettext</span><span class="o">=</span><span class="n">imagesettext</span><span class="p">,</span>
                         <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                         <span class="n">finished</span><span class="o">=</span><span class="n">finished</span><span class="p">,</span>
                         <span class="n">display_instructions</span><span class="o">=</span><span class="n">display_instructions</span><span class="p">,</span>
                         <span class="n">callback_url</span><span class="o">=</span><span class="n">callback_url</span><span class="p">,</span>
                         <span class="n">callback_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
                         <span class="n">EMBEDDED_CSS</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">EMBEDDED_JAVASCRIPT</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">review</span><span class="o">=</span><span class="n">review</span><span class="p">)</span></div>


<div class="viewcode-block" id="turk_annotation_dynamic"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_annotation_dynamic">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/annotation/dynamic/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_annotation_dynamic</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
    <span class="n">aid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">imgsetid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imgsetid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">review</span> <span class="o">=</span> <span class="s1">&#39;review&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">gid</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="n">image_src</span> <span class="o">=</span> <span class="n">routes_ajax</span><span class="o">.</span><span class="n">annotation_src</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="n">species</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="n">viewpoint_text</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoints</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="n">viewpoint_value</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">VIEWPOINT_MAPPING_INVERT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">viewpoint_text</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">quality_value</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_qualities</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">quality_value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">quality_value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">quality_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">quality_value</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">species_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_species_rowids</span><span class="p">()</span>
    <span class="n">species_nice_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_nice</span><span class="p">(</span><span class="n">species_rowids</span><span class="p">)</span>

    <span class="n">combined_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_nice_list</span><span class="p">,</span> <span class="n">species_rowids</span><span class="p">))</span>
    <span class="n">species_nice_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">combined</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">combined</span> <span class="ow">in</span> <span class="n">combined_list</span> <span class="p">]</span>
    <span class="n">species_rowids</span> <span class="o">=</span> <span class="p">[</span> <span class="n">combined</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">combined</span> <span class="ow">in</span> <span class="n">combined_list</span> <span class="p">]</span>

    <span class="n">species_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_texts</span><span class="p">(</span><span class="n">species_rowids</span><span class="p">)</span>
    <span class="n">species_selected_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">species</span> <span class="o">==</span> <span class="n">species_</span> <span class="k">for</span> <span class="n">species_</span> <span class="ow">in</span> <span class="n">species_text_list</span> <span class="p">]</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_nice_list</span><span class="p">,</span> <span class="n">species_text_list</span><span class="p">,</span> <span class="n">species_selected_list</span><span class="p">))</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="s1">&#39;Unspecified&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="p">]</span> <span class="o">+</span> <span class="n">species_list</span>

    <span class="n">callback_url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;submit_annotation&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="s1">&#39;annotation_dynamic&#39;</span><span class="p">,</span>
                         <span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">,</span>
                         <span class="n">gid</span><span class="o">=</span><span class="n">gid</span><span class="p">,</span>
                         <span class="n">aid</span><span class="o">=</span><span class="n">aid</span><span class="p">,</span>
                         <span class="n">viewpoint_value</span><span class="o">=</span><span class="n">viewpoint_value</span><span class="p">,</span>
                         <span class="n">quality_value</span><span class="o">=</span><span class="n">quality_value</span><span class="p">,</span>
                         <span class="n">image_src</span><span class="o">=</span><span class="n">image_src</span><span class="p">,</span>
                         <span class="n">species_list</span><span class="o">=</span><span class="n">species_list</span><span class="p">,</span>
                         <span class="n">callback_url</span><span class="o">=</span><span class="n">callback_url</span><span class="p">,</span>
                         <span class="n">callback_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
                         <span class="n">EMBEDDED_CSS</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">EMBEDDED_JAVASCRIPT</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">review</span><span class="o">=</span><span class="n">review</span><span class="p">,</span>
                         <span class="n">__wrapper__</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="turk_annotation_grid"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_annotation_grid">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/annotation/grid/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_annotation_grid</span><span class="p">(</span><span class="n">imgsetid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="s1">&#39;zebra_grevys&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">random</span>

    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="k">if</span> <span class="n">imgsetid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_aids</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>

    <span class="n">enable_grid</span> <span class="o">=</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">check_ggr_valid_aids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">enable_grid</span><span class="o">=</span><span class="n">enable_grid</span><span class="p">)</span>
    <span class="n">metadata_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_metadata</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">highlighted_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="n">metadata_list</span>
    <span class="p">]</span>
    <span class="n">reviewed_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">highlighted</span> <span class="ow">in</span> <span class="n">highlighted_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">reviewed</span> <span class="o">=</span> <span class="n">highlighted</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">reviewed</span> <span class="o">=</span> <span class="n">highlighted</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">reviewed</span> <span class="o">=</span> <span class="n">highlighted</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
        <span class="n">reviewed_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reviewed</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;aoi_two_weight_filepath&#39;</span><span class="p">:</span> <span class="s1">&#39;ggr2&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">prediction_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">depc_annot</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;aoi_two&#39;</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">confidence_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">depc_annot</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;aoi_two&#39;</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">confidence_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">confidence</span> <span class="k">if</span> <span class="n">prediction</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span> <span class="k">else</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">confidence</span>
        <span class="k">for</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">confidence</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">prediction_list</span><span class="p">,</span> <span class="n">confidence_list</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total len(reviewed_list) = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reviewed_list</span><span class="p">),</span> <span class="p">))</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="n">reviewed_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">reviewed_list</span><span class="p">),</span> <span class="p">)</span>
    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="s1">&#39;100.0&#39;</span>

    <span class="n">zipped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">highlighted_list</span><span class="p">,</span> <span class="n">confidence_list</span><span class="p">))</span>
    <span class="n">values_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">zipped</span><span class="p">,</span> <span class="n">reviewed_list</span><span class="p">)</span>

    <span class="n">aid_list_</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">highlighted_list_</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">confidence_list_</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">values_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">samples</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">values_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">aid</span><span class="p">,</span> <span class="n">highlighted</span><span class="p">,</span> <span class="n">confidence</span> <span class="o">=</span> <span class="n">values_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">highlighted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">aid_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">highlighted_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">highlighted</span><span class="p">)</span>
        <span class="n">confidence_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">confidence</span><span class="p">)</span>

    <span class="n">finished</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="n">highlighted_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">)</span>
    <span class="n">annotation_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
        <span class="n">aid_list_</span><span class="p">,</span>
        <span class="n">highlighted_list_</span><span class="p">,</span>
        <span class="n">confidence_list_</span><span class="p">,</span>
    <span class="p">))</span>
    <span class="n">aid_list_str</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">aid_list_</span><span class="p">))</span>

    <span class="n">annotation_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;submit_annotation_grid&#39;</span><span class="p">),</span> <span class="n">imgsetid</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">callback_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">?imgsetid=</span><span class="si">%s</span><span class="s1">&amp;version=</span><span class="si">%d</span><span class="s1">&amp;samples=</span><span class="si">%d</span><span class="s1">&amp;species=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="s1">&#39;grid_annotation&#39;</span><span class="p">,</span>
                         <span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">,</span>
                         <span class="n">aid_list</span><span class="o">=</span><span class="n">aid_list_</span><span class="p">,</span>
                         <span class="n">aid_list_str</span><span class="o">=</span><span class="n">aid_list_str</span><span class="p">,</span>
                         <span class="n">num_aids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">),</span>
                         <span class="n">annotation_list</span><span class="o">=</span><span class="n">annotation_list</span><span class="p">,</span>
                         <span class="n">num_annotations</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">annotation_list</span><span class="p">),</span>
                         <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                         <span class="n">finished</span><span class="o">=</span><span class="n">finished</span><span class="p">,</span>
                         <span class="n">callback_url</span><span class="o">=</span><span class="n">callback_url</span><span class="p">,</span>
                         <span class="n">callback_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="turk_splits"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_splits">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/splits/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_splits</span><span class="p">(</span><span class="n">aid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="n">annotation_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">aid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>

        <span class="n">annotation_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
            <span class="n">aid_list</span><span class="p">,</span>
        <span class="p">))</span>

    <span class="n">annotation_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">callback_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;submit_splits&#39;</span><span class="p">),</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="s1">&#39;splits&#39;</span><span class="p">,</span>
                         <span class="n">aid</span><span class="o">=</span><span class="n">aid</span><span class="p">,</span>
                         <span class="n">annotation_list</span><span class="o">=</span><span class="n">annotation_list</span><span class="p">,</span>
                         <span class="n">num_annotations</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">annotation_list</span><span class="p">),</span>
                         <span class="n">callback_url</span><span class="o">=</span><span class="n">callback_url</span><span class="p">,</span>
                         <span class="n">callback_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="turk_contour"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_contour">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/contour/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_contour</span><span class="p">(</span><span class="n">part_rowid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imgsetid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">previous</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="n">default_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span>            <span class="kc">True</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">config_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">config_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">default_list</span>
    <span class="p">}</span>
    <span class="n">config_str_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="n">config_str</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_str_list</span><span class="p">)</span>

    <span class="n">imgsetid</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">imgsetid</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">imgsetid</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="k">else</span> <span class="n">imgsetid</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">(</span><span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>
    <span class="n">part_rowid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_part_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
    <span class="n">part_rowid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">part_rowid_list</span><span class="p">))</span>

    <span class="n">reviewed_list</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">imageset_part_contour_processed</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">part_rowid_list</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="n">reviewed_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">reviewed_list</span><span class="p">),</span> <span class="p">)</span>
    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="s1">&#39;100.0&#39;</span>

    <span class="n">imagesettext</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">imgsetid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">part_rowid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">part_rowid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">part_rowid_list</span><span class="p">,</span> <span class="n">reviewed_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">part_rowid_list_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">part_rowid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">part_rowid</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">part_rowid_list_</span><span class="p">)</span>

    <span class="n">finished</span> <span class="o">=</span> <span class="n">part_rowid</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">display_instructions</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ia-contour_instructions_seen&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">padding</span> <span class="o">=</span> <span class="mf">0.15</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
        <span class="n">image_src</span> <span class="o">=</span> <span class="n">routes_ajax</span><span class="o">.</span><span class="n">part_src</span><span class="p">(</span><span class="n">part_rowid</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>

        <span class="c1"># Get contours from part</span>
        <span class="n">existing_contour_dict</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_part_contour</span><span class="p">(</span><span class="n">part_rowid</span><span class="p">)</span>
        <span class="n">existing_contour</span> <span class="o">=</span> <span class="n">existing_contour_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;contour&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing_contour</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">existing_contour</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image_src</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">existing_contour</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">existing_contour_json</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">existing_contour</span><span class="p">)</span>

    <span class="n">settings_key_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;ia-contour-setting-guiderail&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">settings_key</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">settings_key</span><span class="p">,</span> <span class="n">settings_default</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">settings_key</span><span class="p">,</span> <span class="n">settings_default</span><span class="p">)</span> <span class="ow">in</span> <span class="n">settings_key_list</span>
    <span class="p">}</span>

    <span class="n">callback_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">?imgsetid=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;submit_contour&#39;</span><span class="p">),</span> <span class="n">imgsetid</span><span class="p">,</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="s1">&#39;contour&#39;</span><span class="p">,</span>
                         <span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">,</span>
                         <span class="n">part_rowid</span><span class="o">=</span><span class="n">part_rowid</span><span class="p">,</span>
                         <span class="n">config_str</span><span class="o">=</span><span class="n">config_str</span><span class="p">,</span>
                         <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                         <span class="n">image_src</span><span class="o">=</span><span class="n">image_src</span><span class="p">,</span>
                         <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span>
                         <span class="n">previous</span><span class="o">=</span><span class="n">previous</span><span class="p">,</span>
                         <span class="n">imagesettext</span><span class="o">=</span><span class="n">imagesettext</span><span class="p">,</span>
                         <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                         <span class="n">finished</span><span class="o">=</span><span class="n">finished</span><span class="p">,</span>
                         <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
                         <span class="n">display_instructions</span><span class="o">=</span><span class="n">display_instructions</span><span class="p">,</span>
                         <span class="n">existing_contour_json</span><span class="o">=</span><span class="n">existing_contour_json</span><span class="p">,</span>
                         <span class="n">callback_url</span><span class="o">=</span><span class="n">callback_url</span><span class="p">,</span>
                         <span class="n">callback_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="turk_species"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_species">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/species/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_species</span><span class="p">(</span><span class="n">hotkeys</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">previous_species_rowids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
    <span class="n">tup</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">get_turk_annot_args</span><span class="p">(</span><span class="n">appf</span><span class="o">.</span><span class="n">imageset_annot_processed</span><span class="p">)</span>
    <span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">reviewed_list</span><span class="p">,</span> <span class="n">imgsetid</span><span class="p">,</span> <span class="n">src_ag</span><span class="p">,</span> <span class="n">dst_ag</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span> <span class="o">=</span> <span class="n">tup</span>

    <span class="n">review</span> <span class="o">=</span> <span class="s1">&#39;review&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="n">aid</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">display_instructions</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ia-species_instructions_seen&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
        <span class="n">gid</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">image_src</span> <span class="o">=</span> <span class="n">routes_ajax</span><span class="o">.</span><span class="n">annotation_src</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">species</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">update_special_imagesets</span><span class="p">()</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">notify_observers</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">gid</span>       <span class="o">=</span> <span class="kc">None</span>
        <span class="n">image_src</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">species</span>   <span class="o">=</span> <span class="kc">None</span>

    <span class="n">imagesettext</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>
    <span class="n">species_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_species_rowids</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">previous_species_rowids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">previous_species_rowid</span> <span class="ow">in</span> <span class="n">previous_species_rowids</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">previous_species_rowid</span> <span class="ow">in</span> <span class="n">species_rowids</span>

            <span class="n">species_rowids</span> <span class="o">=</span> <span class="n">previous_species_rowids</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error finding previous species rowid in existing list&#39;</span><span class="p">)</span>
            <span class="n">previous_species_rowids</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">previous_species_rowids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">refresh</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">current_species_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>

    <span class="n">species_count</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">current_species_rowids</span><span class="p">)</span> <span class="o">-</span> <span class="n">current_species_rowids</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">species_rowid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">species_rowid</span> <span class="ow">in</span> <span class="n">species_rowids</span>
    <span class="p">]</span>
    <span class="n">species_nice_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_nice</span><span class="p">(</span><span class="n">species_rowids</span><span class="p">)</span>
    <span class="n">combined_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_count</span><span class="p">,</span> <span class="n">species_nice_list</span><span class="p">,</span> <span class="n">species_rowids</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">refresh</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;REFRESHING!&#39;</span><span class="p">)</span>
        <span class="n">combined_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">combined_list</span><span class="p">)</span>

    <span class="n">species_count_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">combined</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">combined</span> <span class="ow">in</span> <span class="n">combined_list</span> <span class="p">]</span>
    <span class="n">species_nice_list</span>  <span class="o">=</span> <span class="p">[</span> <span class="n">combined</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">combined</span> <span class="ow">in</span> <span class="n">combined_list</span> <span class="p">]</span>
    <span class="n">species_rowids</span>     <span class="o">=</span> <span class="p">[</span> <span class="n">combined</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">combined</span> <span class="ow">in</span> <span class="n">combined_list</span> <span class="p">]</span>
    <span class="n">species_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_texts</span><span class="p">(</span><span class="n">species_rowids</span><span class="p">)</span>

    <span class="n">species_rowids_json</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">species_rowids</span><span class="p">)</span>

    <span class="n">hotkey_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species_nice_list</span><span class="p">))</span> <span class="p">]</span>
    <span class="n">species_selected_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">species</span> <span class="o">==</span> <span class="n">species_</span> <span class="k">for</span> <span class="n">species_</span> <span class="ow">in</span> <span class="n">species_text_list</span> <span class="p">]</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">hotkey_list</span><span class="p">,</span> <span class="n">species_nice_list</span><span class="p">,</span> <span class="n">species_text_list</span><span class="p">,</span> <span class="n">species_selected_list</span><span class="p">))</span>
    <span class="n">species_extended_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">other_selected</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">zipped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_count_list</span><span class="p">,</span> <span class="n">species_nice_list</span><span class="p">,</span> <span class="n">species_selected_list</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">species_count</span><span class="p">,</span> <span class="n">species_nice</span><span class="p">,</span> <span class="n">species_selected</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">zipped</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">species_selected</span><span class="p">:</span>
            <span class="n">species_nice</span> <span class="o">+=</span> <span class="s1">&#39; (default)&#39;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">current_species_rowids</span><span class="p">)</span> <span class="o">-</span> <span class="n">species_count</span><span class="p">,</span> <span class="n">species_nice</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">hotkeys</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">% 5d</span><span class="s1">   : </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">% 5d</span><span class="s1"> * : </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_list</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">hotkeys</span><span class="p">:</span>
        <span class="n">species_extended_list</span> <span class="o">=</span> <span class="n">species_list</span><span class="p">[</span><span class="n">hotkeys</span><span class="p">:]</span>
        <span class="n">species_list</span> <span class="o">=</span> <span class="n">species_list</span><span class="p">[:</span><span class="n">hotkeys</span><span class="p">]</span>
        <span class="n">extended_flag_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">species_extended_list</span><span class="p">]</span>

        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">extended_flag_list</span><span class="p">:</span>
            <span class="n">other_selected</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">species_list</span> <span class="o">=</span> <span class="n">species_list</span> <span class="o">+</span> <span class="p">[</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Other&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">,</span> <span class="n">other_selected</span><span class="p">)</span> <span class="p">]</span>

    <span class="n">example_species_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">SPECIES_MAPPING</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">SPECIES_MAPPING</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">const</span><span class="o">.</span><span class="n">SPECIES_MAPPING</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span>
    <span class="p">]</span>

    <span class="n">callback_url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;submit_species&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="s1">&#39;species&#39;</span><span class="p">,</span>
                         <span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">,</span>
                         <span class="n">src_ag</span><span class="o">=</span><span class="n">src_ag</span><span class="p">,</span>
                         <span class="n">dst_ag</span><span class="o">=</span><span class="n">dst_ag</span><span class="p">,</span>
                         <span class="n">gid</span><span class="o">=</span><span class="n">gid</span><span class="p">,</span>
                         <span class="n">aid</span><span class="o">=</span><span class="n">aid</span><span class="p">,</span>
                         <span class="n">image_src</span><span class="o">=</span><span class="n">image_src</span><span class="p">,</span>
                         <span class="n">previous</span><span class="o">=</span><span class="n">previous</span><span class="p">,</span>
                         <span class="n">species_list</span><span class="o">=</span><span class="n">species_list</span><span class="p">,</span>
                         <span class="n">species_extended_list</span><span class="o">=</span><span class="n">species_extended_list</span><span class="p">,</span>
                         <span class="n">species_rowids_json</span><span class="o">=</span><span class="n">species_rowids_json</span><span class="p">,</span>
                         <span class="n">example_species_list</span><span class="o">=</span><span class="n">example_species_list</span><span class="p">,</span>
                         <span class="n">imagesettext</span><span class="o">=</span><span class="n">imagesettext</span><span class="p">,</span>
                         <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                         <span class="n">finished</span><span class="o">=</span><span class="n">finished</span><span class="p">,</span>
                         <span class="n">display_instructions</span><span class="o">=</span><span class="n">display_instructions</span><span class="p">,</span>
                         <span class="n">callback_url</span><span class="o">=</span><span class="n">callback_url</span><span class="p">,</span>
                         <span class="n">callback_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
                         <span class="n">EMBEDDED_CSS</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">EMBEDDED_JAVASCRIPT</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">review</span><span class="o">=</span><span class="n">review</span><span class="p">)</span></div>


<div class="viewcode-block" id="turk_viewpoint"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_viewpoint">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/viewpoint/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_viewpoint</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.web.app --exec-turk_viewpoint --db PZ_Master1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.other.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;PZ_Master1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list_ = ibs.find_unlabeled_name_members(suspect_yaws=True)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.filter_aids_to_quality(aid_list_, &#39;good&#39;, unknown_ok=False)</span>
<span class="sd">        &gt;&gt;&gt; ibs.start_web_annot_groupreview(aid_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
    <span class="n">tup</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">get_turk_annot_args</span><span class="p">(</span><span class="n">appf</span><span class="o">.</span><span class="n">imageset_annot_viewpoint_processed</span><span class="p">)</span>
    <span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">reviewed_list</span><span class="p">,</span> <span class="n">imgsetid</span><span class="p">,</span> <span class="n">src_ag</span><span class="p">,</span> <span class="n">dst_ag</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span> <span class="o">=</span> <span class="n">tup</span>

    <span class="n">viewpoint_text</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoints</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">VIEWPOINT_MAPPING_INVERT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">viewpoint_text</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">review</span> <span class="o">=</span> <span class="s1">&#39;review&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="n">aid</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">display_instructions</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ia-viewpoint_instructions_seen&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
        <span class="n">gid</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">image_src</span> <span class="o">=</span> <span class="n">routes_ajax</span><span class="o">.</span><span class="n">annotation_src</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">species</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gid</span>       <span class="o">=</span> <span class="kc">None</span>
        <span class="n">image_src</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">species</span>   <span class="o">=</span> <span class="kc">None</span>

    <span class="n">imagesettext</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>

    <span class="n">species_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_species_rowids</span><span class="p">()</span>
    <span class="n">species_nice_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_nice</span><span class="p">(</span><span class="n">species_rowids</span><span class="p">)</span>

    <span class="n">combined_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_nice_list</span><span class="p">,</span> <span class="n">species_rowids</span><span class="p">))</span>
    <span class="n">species_nice_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">combined</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">combined</span> <span class="ow">in</span> <span class="n">combined_list</span> <span class="p">]</span>
    <span class="n">species_rowids</span> <span class="o">=</span> <span class="p">[</span> <span class="n">combined</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">combined</span> <span class="ow">in</span> <span class="n">combined_list</span> <span class="p">]</span>

    <span class="n">species_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_texts</span><span class="p">(</span><span class="n">species_rowids</span><span class="p">)</span>
    <span class="n">species_selected_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">species</span> <span class="o">==</span> <span class="n">species_</span> <span class="k">for</span> <span class="n">species_</span> <span class="ow">in</span> <span class="n">species_text_list</span> <span class="p">]</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_nice_list</span><span class="p">,</span> <span class="n">species_text_list</span><span class="p">,</span> <span class="n">species_selected_list</span><span class="p">))</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="s1">&#39;Unspecified&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="p">]</span> <span class="o">+</span> <span class="n">species_list</span>

    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="s1">&#39;viewpoint&#39;</span><span class="p">,</span>
                         <span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">,</span>
                         <span class="n">src_ag</span><span class="o">=</span><span class="n">src_ag</span><span class="p">,</span>
                         <span class="n">dst_ag</span><span class="o">=</span><span class="n">dst_ag</span><span class="p">,</span>
                         <span class="n">gid</span><span class="o">=</span><span class="n">gid</span><span class="p">,</span>
                         <span class="n">aid</span><span class="o">=</span><span class="n">aid</span><span class="p">,</span>
                         <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                         <span class="n">image_src</span><span class="o">=</span><span class="n">image_src</span><span class="p">,</span>
                         <span class="n">previous</span><span class="o">=</span><span class="n">previous</span><span class="p">,</span>
                         <span class="n">species_list</span><span class="o">=</span><span class="n">species_list</span><span class="p">,</span>
                         <span class="n">imagesettext</span><span class="o">=</span><span class="n">imagesettext</span><span class="p">,</span>
                         <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                         <span class="n">finished</span><span class="o">=</span><span class="n">finished</span><span class="p">,</span>
                         <span class="n">display_instructions</span><span class="o">=</span><span class="n">display_instructions</span><span class="p">,</span>
                         <span class="n">review</span><span class="o">=</span><span class="n">review</span><span class="p">)</span></div>


<div class="viewcode-block" id="turk_viewpoint2"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_viewpoint2">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/viewpoint2/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_viewpoint2</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.web.app --exec-turk_viewpoint --db PZ_Master1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.other.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;PZ_Master1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list_ = ibs.find_unlabeled_name_members(suspect_yaws=True)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.filter_aids_to_quality(aid_list_, &#39;good&#39;, unknown_ok=False)</span>
<span class="sd">        &gt;&gt;&gt; ibs.start_web_annot_groupreview(aid_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
    <span class="n">tup</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">get_turk_annot_args</span><span class="p">(</span><span class="n">appf</span><span class="o">.</span><span class="n">imageset_annot_viewpoint_processed</span><span class="p">)</span>
    <span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">reviewed_list</span><span class="p">,</span> <span class="n">imgsetid</span><span class="p">,</span> <span class="n">src_ag</span><span class="p">,</span> <span class="n">dst_ag</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span> <span class="o">=</span> <span class="n">tup</span>

    <span class="n">viewpoint</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoints</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="n">viewpoint1</span><span class="p">,</span> <span class="n">viewpoint2</span><span class="p">,</span> <span class="n">viewpoint3</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">convert_viewpoint_to_tuple</span><span class="p">(</span><span class="n">viewpoint</span><span class="p">)</span>

    <span class="n">review</span> <span class="o">=</span> <span class="s1">&#39;review&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="n">aid</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">display_instructions</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ia-viewpoint_instructions_seen&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
        <span class="n">gid</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">image_src</span> <span class="o">=</span> <span class="n">routes_ajax</span><span class="o">.</span><span class="n">annotation_src</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">species</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gid</span>       <span class="o">=</span> <span class="kc">None</span>
        <span class="n">image_src</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">species</span>   <span class="o">=</span> <span class="kc">None</span>

    <span class="n">imagesettext</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>

    <span class="n">species_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_species_rowids</span><span class="p">()</span>
    <span class="n">species_nice_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_nice</span><span class="p">(</span><span class="n">species_rowids</span><span class="p">)</span>

    <span class="n">combined_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_nice_list</span><span class="p">,</span> <span class="n">species_rowids</span><span class="p">))</span>
    <span class="n">species_nice_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">combined</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">combined</span> <span class="ow">in</span> <span class="n">combined_list</span> <span class="p">]</span>
    <span class="n">species_rowids</span> <span class="o">=</span> <span class="p">[</span> <span class="n">combined</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">combined</span> <span class="ow">in</span> <span class="n">combined_list</span> <span class="p">]</span>

    <span class="n">species_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_texts</span><span class="p">(</span><span class="n">species_rowids</span><span class="p">)</span>
    <span class="n">species_selected_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">species</span> <span class="o">==</span> <span class="n">species_</span> <span class="k">for</span> <span class="n">species_</span> <span class="ow">in</span> <span class="n">species_text_list</span> <span class="p">]</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_nice_list</span><span class="p">,</span> <span class="n">species_text_list</span><span class="p">,</span> <span class="n">species_selected_list</span><span class="p">))</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="s1">&#39;Unspecified&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="p">]</span> <span class="o">+</span> <span class="n">species_list</span>

    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="s1">&#39;viewpoint2&#39;</span><span class="p">,</span>
                         <span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">,</span>
                         <span class="n">src_ag</span><span class="o">=</span><span class="n">src_ag</span><span class="p">,</span>
                         <span class="n">dst_ag</span><span class="o">=</span><span class="n">dst_ag</span><span class="p">,</span>
                         <span class="n">gid</span><span class="o">=</span><span class="n">gid</span><span class="p">,</span>
                         <span class="n">aid</span><span class="o">=</span><span class="n">aid</span><span class="p">,</span>
                         <span class="n">viewpoint1</span><span class="o">=</span><span class="n">viewpoint1</span><span class="p">,</span>
                         <span class="n">viewpoint2</span><span class="o">=</span><span class="n">viewpoint2</span><span class="p">,</span>
                         <span class="n">viewpoint3</span><span class="o">=</span><span class="n">viewpoint3</span><span class="p">,</span>
                         <span class="n">image_src</span><span class="o">=</span><span class="n">image_src</span><span class="p">,</span>
                         <span class="n">previous</span><span class="o">=</span><span class="n">previous</span><span class="p">,</span>
                         <span class="n">species_list</span><span class="o">=</span><span class="n">species_list</span><span class="p">,</span>
                         <span class="n">imagesettext</span><span class="o">=</span><span class="n">imagesettext</span><span class="p">,</span>
                         <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                         <span class="n">finished</span><span class="o">=</span><span class="n">finished</span><span class="p">,</span>
                         <span class="n">display_instructions</span><span class="o">=</span><span class="n">display_instructions</span><span class="p">,</span>
                         <span class="n">review</span><span class="o">=</span><span class="n">review</span><span class="p">)</span></div>


<div class="viewcode-block" id="turk_viewpoint3"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_viewpoint3">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/viewpoint3/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_viewpoint3</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;[turk_viewpoint3]&#39;</span><span class="p">):</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">tup</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">get_turk_annot_args</span><span class="p">(</span><span class="n">appf</span><span class="o">.</span><span class="n">imageset_annot_viewpoint_processed</span><span class="p">)</span>
        <span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">reviewed_list</span><span class="p">,</span> <span class="n">imgsetid</span><span class="p">,</span> <span class="n">src_ag</span><span class="p">,</span> <span class="n">dst_ag</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span> <span class="o">=</span> <span class="n">tup</span>

        <span class="n">viewpoint</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">aid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoints</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">viewpoint_code</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">YAWALIAS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">viewpoint</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">review</span> <span class="o">=</span> <span class="s1">&#39;review&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="n">aid</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">display_instructions</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ia-viewpoint3_instructions_seen&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
            <span class="n">gid</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
            <span class="n">image_src</span> <span class="o">=</span> <span class="n">routes_ajax</span><span class="o">.</span><span class="n">annotation_src</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
            <span class="n">species</span>   <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gid</span>       <span class="o">=</span> <span class="kc">None</span>
            <span class="n">image_src</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">species</span>   <span class="o">=</span> <span class="kc">None</span>

        <span class="n">imagesettext</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>

        <span class="n">species_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_species_rowids</span><span class="p">()</span>
        <span class="n">species_nice_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_nice</span><span class="p">(</span><span class="n">species_rowids</span><span class="p">)</span>

        <span class="n">combined_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_nice_list</span><span class="p">,</span> <span class="n">species_rowids</span><span class="p">))</span>
        <span class="n">species_nice_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">combined</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">combined</span> <span class="ow">in</span> <span class="n">combined_list</span> <span class="p">]</span>
        <span class="n">species_rowids</span> <span class="o">=</span> <span class="p">[</span> <span class="n">combined</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">combined</span> <span class="ow">in</span> <span class="n">combined_list</span> <span class="p">]</span>

        <span class="n">species_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_texts</span><span class="p">(</span><span class="n">species_rowids</span><span class="p">)</span>
        <span class="n">species_selected_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">species</span> <span class="o">==</span> <span class="n">species_</span> <span class="k">for</span> <span class="n">species_</span> <span class="ow">in</span> <span class="n">species_text_list</span> <span class="p">]</span>
        <span class="n">species_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">species_nice_list</span><span class="p">,</span> <span class="n">species_text_list</span><span class="p">,</span> <span class="n">species_selected_list</span><span class="p">))</span>
        <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="s1">&#39;Unspecified&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="p">]</span> <span class="o">+</span> <span class="n">species_list</span>

        <span class="n">axis_preference</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ia-viewpoint3_axis_preference&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="s1">&#39;viewpoint3&#39;</span><span class="p">,</span>
                                 <span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">,</span>
                                 <span class="n">src_ag</span><span class="o">=</span><span class="n">src_ag</span><span class="p">,</span>
                                 <span class="n">dst_ag</span><span class="o">=</span><span class="n">dst_ag</span><span class="p">,</span>
                                 <span class="n">gid</span><span class="o">=</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">aid</span><span class="o">=</span><span class="n">aid</span><span class="p">,</span>
                                 <span class="n">viewpoint_code</span><span class="o">=</span><span class="n">viewpoint_code</span><span class="p">,</span>
                                 <span class="n">axis_preference</span><span class="o">=</span><span class="n">axis_preference</span><span class="p">,</span>
                                 <span class="n">image_src</span><span class="o">=</span><span class="n">image_src</span><span class="p">,</span>
                                 <span class="n">previous</span><span class="o">=</span><span class="n">previous</span><span class="p">,</span>
                                 <span class="n">species_list</span><span class="o">=</span><span class="n">species_list</span><span class="p">,</span>
                                 <span class="n">imagesettext</span><span class="o">=</span><span class="n">imagesettext</span><span class="p">,</span>
                                 <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                                 <span class="n">finished</span><span class="o">=</span><span class="n">finished</span><span class="p">,</span>
                                 <span class="n">display_instructions</span><span class="o">=</span><span class="n">display_instructions</span><span class="p">,</span>
                                 <span class="n">review</span><span class="o">=</span><span class="n">review</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">template</span></div>


<div class="viewcode-block" id="commit_current_query_object_names"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.commit_current_query_object_names">[docs]</a><span class="k">def</span> <span class="nf">commit_current_query_object_names</span><span class="p">(</span><span class="n">query_object</span><span class="p">,</span> <span class="n">ibs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        query_object (ibeis.AnnotInference):</span>
<span class="sd">        ibs (ibeis.IBEISController):  image analysis api</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ensure connected components are used to relabel names</span>
    <span class="n">query_object</span><span class="o">.</span><span class="n">relabel_using_reviews</span><span class="p">()</span>
    <span class="c1"># Transfers any remaining internal feedback into staging</span>
    <span class="c1"># TODO:  uncomment once buffer is dead</span>
    <span class="c1"># query_object.write_ibeis_staging_feedback()</span>
    <span class="c1"># Commit a delta of the current annotmatch</span>
    <span class="n">query_object</span><span class="o">.</span><span class="n">write_ibeis_annotmatch_feedback</span><span class="p">()</span>
    <span class="n">query_object</span><span class="o">.</span><span class="n">write_ibeis_name_assignment</span><span class="p">()</span></div>


<div class="viewcode-block" id="precompute_current_review_match_images"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.precompute_current_review_match_images">[docs]</a><span class="k">def</span> <span class="nf">precompute_current_review_match_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">query_object</span><span class="p">,</span>
                                           <span class="n">global_feedback_limit</span><span class="o">=</span><span class="n">GLOBAL_FEEDBACK_LIMIT</span><span class="p">,</span>
                                           <span class="n">view_orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.web</span> <span class="k">import</span> <span class="n">apis_query</span>

    <span class="n">review_aid1_list</span><span class="p">,</span> <span class="n">review_aid2_list</span> <span class="o">=</span> <span class="n">query_object</span><span class="o">.</span><span class="n">get_filtered_edges</span><span class="p">(</span><span class="n">GLOBAL_FEEDBACK_CONFIG_DICT</span><span class="p">)</span>
    <span class="n">qreq_</span> <span class="o">=</span> <span class="n">query_object</span><span class="o">.</span><span class="n">qreq_</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">review_aid1_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">review_aid2_list</span><span class="p">),</span> <span class="s1">&#39;not aligned&#39;</span>

    <span class="c1"># Precompute</span>
    <span class="n">zipped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">review_aid1_list</span><span class="p">,</span> <span class="n">review_aid2_list</span><span class="p">))</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">zipped</span><span class="p">),</span> <span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">review_aid2_list</span><span class="p">),</span>
                       <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Rending images&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">prog</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">global_feedback_limit</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">cm</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span> <span class="o">=</span> <span class="n">query_object</span><span class="o">.</span><span class="n">lookup_cm</span><span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">apis_query</span><span class="o">.</span><span class="n">ensure_review_image</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid2</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span>
                                           <span class="n">view_orientation</span><span class="o">=</span><span class="n">view_orientation</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;Failed to make review image. falling back&#39;</span><span class="p">,</span>
                       <span class="n">tb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cm.qaid&#39;</span><span class="p">,</span> <span class="s1">&#39;aid2&#39;</span><span class="p">],</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">apis_query</span><span class="o">.</span><span class="n">ensure_review_image</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid2</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span>
                                           <span class="n">view_orientation</span><span class="o">=</span><span class="n">view_orientation</span><span class="p">,</span>
                                           <span class="n">draw_matches</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_identification_query_object_worker"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.load_identification_query_object_worker">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">load_identification_query_object_worker</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">_init_identification_query_object</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;precomputed&#39;</span></div>


<span class="k">def</span> <span class="nf">_init_identification_query_object</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">debug_ignore_name_gt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">global_feedback_limit</span><span class="o">=</span><span class="n">GLOBAL_FEEDBACK_LIMIT</span><span class="p">,</span>
                                      <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.web.routes _init_identification_query_object</span>

<span class="sd">    Ignore:</span>
<span class="sd">        # mount lev to the home drive</span>
<span class="sd">        sshfs -o idmap=user lev:/ ~/lev</span>

<span class="sd">        # unmount</span>
<span class="sd">        fusermount -u ~/lev</span>

<span class="sd">        import ibeis</span>
<span class="sd">        ibs = ibeis.opendb(ut.truepath(&#39;~/lev/media/hdd/work/EWT_Cheetahs&#39;))</span>
<span class="sd">        aid_list = ibs.filter_annots_general(view=[&#39;right&#39;, &#39;frontright&#39;, &#39;backright&#39;])</span>
<span class="sd">        infr = ibeis.AnnotInference(ibs, aid_list, autoinit=True)</span>
<span class="sd">        infr.reset_feedback(&#39;staging&#39;)</span>
<span class="sd">        infr.apply_feedback_edges()</span>
<span class="sd">        infr.exec_matching()</span>
<span class="sd">        infr.apply_match_edges()</span>
<span class="sd">        infr.apply_match_scores()</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SLOW_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.web.routes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.web.routes import _init_identification_query_object</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ut.exec_funckw(_init_identification_query_object, locals())</span>
<span class="sd">        &gt;&gt;&gt; kwargs = {}</span>
<span class="sd">        &gt;&gt;&gt; _init_identification_query_object(ibs)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">ibeis</span>

    <span class="k">if</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span> <span class="o">==</span> <span class="s1">&#39;EWT_Cheetahs&#39;</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_general</span><span class="p">(</span><span class="n">view</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;frontright&#39;</span><span class="p">,</span> <span class="s1">&#39;backright&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">is_exemplar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">nids</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">aid</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">aid_list</span><span class="p">]</span> <span class="k">if</span> <span class="n">debug_ignore_name_gt</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Initailize a graph with no edges.</span>
    <span class="n">query_object</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">AnnotInference</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">,</span> <span class="n">autoinit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Load feedback from the staging database (does not change graph state)</span>
    <span class="n">query_object</span><span class="o">.</span><span class="n">reset_feedback</span><span class="p">(</span><span class="s1">&#39;staging&#39;</span><span class="p">,</span> <span class="n">apply</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">query_object</span><span class="o">.</span><span class="n">refresh_candidate_edges</span><span class="p">()</span>

    <span class="c1"># Exec matching (adds candidate edges using hotspotter and score them)</span>
    <span class="n">query_object</span><span class="o">.</span><span class="n">exec_matching</span><span class="p">()</span>
    <span class="n">query_object</span><span class="o">.</span><span class="n">apply_match_edges</span><span class="p">()</span>
    <span class="n">query_object</span><span class="o">.</span><span class="n">apply_match_scores</span><span class="p">()</span>

    <span class="c1"># Use connected components to relabel names on nodes</span>
    <span class="n">query_object</span><span class="o">.</span><span class="n">relabel_using_reviews</span><span class="p">()</span>

    <span class="c1"># Create a priority on edge review ands determines inconsistencies</span>
    <span class="n">query_object</span><span class="o">.</span><span class="n">ensure_mst</span><span class="p">()</span>
    <span class="n">query_object</span><span class="o">.</span><span class="n">apply_nondynamic_update</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Precomputing match images&#39;</span><span class="p">)</span>
    <span class="c1"># view_orientation = request.args.get(&#39;view_orientation&#39;, &#39;vertical&#39;)</span>
    <span class="c1"># precompute_current_review_match_images(ibs, query_object,</span>
    <span class="c1">#                                        global_feedback_limit=global_feedback_limit,</span>
    <span class="c1">#                                        view_orientation=&#39;vertical&#39;)</span>
    <span class="c1"># precompute_current_review_match_images(ibs, query_object,</span>
    <span class="c1">#                                        global_feedback_limit=global_feedback_limit,</span>
    <span class="c1">#                                        view_orientation=&#39;horizontal&#39;)</span>
    <span class="k">return</span> <span class="n">query_object</span>


<div class="viewcode-block" id="load_identification_query_object"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.load_identification_query_object">[docs]</a><span class="k">def</span> <span class="nf">load_identification_query_object</span><span class="p">(</span><span class="n">autoinit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">global_feedback_limit</span><span class="o">=</span><span class="n">GLOBAL_FEEDBACK_LIMIT</span><span class="p">,</span>
                                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="k">if</span> <span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">autoinit</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT</span><span class="o">.</span><span class="n">GLOBAL_FEEDBACK_COUNTER</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">global_feedback_limit</span><span class="p">:</span>
            <span class="c1"># Apply current names that have been made to database</span>
            <span class="n">commit_current_query_object_names</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT</span><span class="p">,</span> <span class="n">ibs</span><span class="p">)</span>

            <span class="c1"># Rebuild the AnnotInference object via the engine</span>
            <span class="n">autoinit</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">autoinit</span><span class="p">:</span>
        <span class="n">query_object</span> <span class="o">=</span> <span class="n">_init_identification_query_object</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Assign to current_app&#39;s QUERY_OBJECT attribute</span>
        <span class="n">query_object</span><span class="o">.</span><span class="n">GLOBAL_FEEDBACK_COUNTER</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT</span> <span class="o">=</span> <span class="n">query_object</span>

    <span class="c1"># Load query object and apply and buffered feedback before returning object</span>
    <span class="n">query_object</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT_FEEDBACK_BUFFER</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">feedback</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT_FEEDBACK_BUFFER</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Popping </span><span class="si">%r</span><span class="s1"> out of QUERY_OBJECT_FEEDBACK_BUFFER&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">feedback</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">feedback</span>
        <span class="n">query_object</span><span class="o">.</span><span class="n">add_feedback</span><span class="p">((</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">),</span> <span class="n">state</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
        <span class="n">query_object</span><span class="o">.</span><span class="n">GLOBAL_FEEDBACK_COUNTER</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">query_object</span></div>


<div class="viewcode-block" id="check_engine_identification_query_object"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.check_engine_identification_query_object">[docs]</a><span class="k">def</span> <span class="nf">check_engine_identification_query_object</span><span class="p">(</span><span class="n">global_feedback_limit</span><span class="o">=</span><span class="n">GLOBAL_FEEDBACK_LIMIT</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="c1"># We need to precompute the chips in this process for OpenCV, as warp-affine</span>
    <span class="c1"># segfaults in the web engine process</span>
    <span class="c1"># ibs.depc.get_rowids(&#39;chips&#39;, ibs.get_valid_aids())</span>
    <span class="c1"># ibs.depc.get_rowids(&#39;probchip&#39;, ibs.get_valid_aids())</span>

    <span class="k">if</span> <span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT</span><span class="o">.</span><span class="n">GLOBAL_FEEDBACK_COUNTER</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">global_feedback_limit</span><span class="p">:</span>
            <span class="c1"># Apply current names that have been made to database</span>
            <span class="n">commit_current_query_object_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT</span><span class="p">)</span>

            <span class="c1"># Rebuild the AnnotInference object via the engine</span>
            <span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT_JOBID</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT_JOBID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT_JOBID</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">start_web_query_all</span><span class="p">()</span>
        <span class="c1"># import ibeis</span>
        <span class="c1"># web_ibs = ibeis.opendb_bg_web(dbdir=ibs.dbdir, port=6000)</span>
        <span class="c1"># query_object_jobid = web_ibs.send_ibeis_request(&#39;/api/engine/query/graph/&#39;)</span>
        <span class="c1"># print(&#39;query_object_jobid = %r&#39; % (query_object_jobid, ))</span>
        <span class="c1"># current_app.QUERY_OBJECT_JOBID = query_object_jobid</span>

    <span class="n">query_object_status_dict</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_job_status</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT_JOBID</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT_JOBID</span><span class="p">,</span> <span class="n">query_object_status_dict</span><span class="p">,</span> <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;job id </span><span class="si">%r</span><span class="s1">: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">query_object_status_dict</span><span class="p">[</span><span class="s1">&#39;jobstatus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span><span class="p">:</span>
        <span class="n">query_object_result</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_job_result</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT_JOBID</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT_JOBID</span><span class="p">,</span> <span class="n">query_object_result</span><span class="p">,</span> <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;job id </span><span class="si">%r</span><span class="s1">: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">query_object_result</span><span class="p">[</span><span class="s1">&#39;json_result&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;precomputed&#39;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="turk_identification"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_identification">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/identification/lnbnn/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_identification</span><span class="p">(</span><span class="n">aid1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aid2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_engine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">global_feedback_limit</span><span class="o">=</span><span class="n">GLOBAL_FEEDBACK_LIMIT</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.web.routes turk_identification --db PZ_Master1</span>
<span class="sd">        python -m ibeis.web.routes turk_identification --db PZ_MTEST</span>
<span class="sd">        python -m ibeis.web.routes turk_identification --db testdb1 --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.other.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; web_ibs = ibeis.opendb_bg_web(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; resp = web_ibs.get(&#39;/turk/identification/lnbnn/&#39;)</span>
<span class="sd">        &gt;&gt;&gt; web_ibs.terminate2()</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; ut.render_html(resp.content)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.web</span> <span class="k">import</span> <span class="n">apis_query</span>

    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;[web.routes.turk_identification] Load query_object&#39;</span><span class="p">):</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

        <span class="k">if</span> <span class="n">use_engine</span><span class="p">:</span>
            <span class="n">engine_computed</span> <span class="o">=</span> <span class="n">check_engine_identification_query_object</span><span class="p">(</span>
                <span class="n">global_feedback_limit</span><span class="o">=</span><span class="n">global_feedback_limit</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">engine_computed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">engine_computed</span><span class="p">:</span>
            <span class="c1"># ibs.depc_annot.get_rowids(&#39;chips&#39;, ibs.get_valid_aids())</span>
            <span class="c1"># ibs.depc_annot.get_rowids(&#39;probchip&#39;, ibs.get_valid_aids())</span>

            <span class="n">query_object</span> <span class="o">=</span> <span class="n">load_identification_query_object</span><span class="p">(</span>
                <span class="n">global_feedback_limit</span><span class="o">=</span><span class="n">global_feedback_limit</span>
            <span class="p">)</span>

            <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;[web.routes.turk_identification] Get matches&#39;</span><span class="p">):</span>
                <span class="c1"># Get raw list of reviews</span>
                <span class="n">review_cfg</span> <span class="o">=</span> <span class="n">GLOBAL_FEEDBACK_CONFIG_DICT</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">raw_review_list</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># Get actual</span>
                <span class="n">review_cfg</span><span class="p">[</span><span class="s1">&#39;max_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_feedback_limit</span>  <span class="c1"># Controls the top X to be randomly sampled and displayed to all concurrent users</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">query_object</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="p">(</span><span class="n">review_aid1_list</span><span class="p">,</span> <span class="n">review_aid2_list</span><span class="p">),</span> <span class="n">review_confidence</span> <span class="o">=</span> <span class="n">values</span>
                <span class="n">review_aid1_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">review_aid1_list</span><span class="p">]</span>
                <span class="n">review_aid2_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">review_aid2_list</span><span class="p">]</span>

            <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;[web.routes.turk_identification] Get status&#39;</span><span class="p">):</span>
                <span class="c1"># Get status</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">status_dict</span> <span class="o">=</span> <span class="n">query_object</span><span class="o">.</span><span class="n">connected_component_status</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="n">status_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">status_dict</span><span class="p">[</span><span class="s1">&#39;num_names_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">status_dict</span><span class="p">[</span><span class="s1">&#39;num_names_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="c1"># status_remaining = status_dict[&#39;num_names_max&#39;] - status_dict[&#39;num_names_min&#39;]</span>
                <span class="n">status_remaining</span> <span class="o">=</span> <span class="n">status_dict</span><span class="p">[</span><span class="s1">&#39;num_names_max&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Feedback counter    = </span><span class="si">%r</span><span class="s1"> / </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_object</span><span class="o">.</span><span class="n">GLOBAL_FEEDBACK_COUNTER</span><span class="p">,</span> <span class="n">GLOBAL_FEEDBACK_LIMIT</span><span class="p">,</span> <span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Status dict         = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">status_dict</span><span class="p">,</span> <span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Raw list len        = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_review_list</span><span class="p">),</span> <span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;len(query_aid_list) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">query_object</span><span class="o">.</span><span class="n">aids</span><span class="p">),</span> <span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimated remaining = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">status_remaining</span><span class="p">,</span> <span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reviews list len    = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">review_aid1_list</span><span class="p">),</span> <span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">progress</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.02f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">status_remaining</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_object</span><span class="o">.</span><span class="n">aids</span><span class="p">))),</span> <span class="p">)</span>
                <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                    <span class="n">progress</span> <span class="o">=</span> <span class="s1">&#39;100.0&#39;</span>

                <span class="c1"># aid1 = request.args.get(&#39;aid1&#39;, None)</span>
                <span class="c1"># aid2 = request.args.get(&#39;aid2&#39;, None)</span>
                <span class="n">replace_review_rowid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;replace_review_rowid&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="n">aid1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">aid2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;[web.routes.turk_identification] Process choice&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">choice</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">review_aid1_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">review_aid2_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>

                    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;[web.routes.turk_identification] ... Pick choice&#39;</span><span class="p">):</span>
                        <span class="n">finished</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">choice</span><span class="p">:</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">review_aid1_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Picked random index = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">))</span>
                            <span class="n">aid1</span> <span class="o">=</span> <span class="n">review_aid1_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                            <span class="n">aid2</span> <span class="o">=</span> <span class="n">review_aid2_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

                        <span class="n">aid1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">aid1</span><span class="p">)</span>
                        <span class="n">aid2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">aid2</span><span class="p">)</span>
                        <span class="n">annot_uuid_1</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">(</span><span class="n">aid1</span><span class="p">)</span>
                        <span class="n">annot_uuid_2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">(</span><span class="n">aid2</span><span class="p">)</span>

                    <span class="c1"># lookup ChipMatch object</span>
                    <span class="n">qreq_</span> <span class="o">=</span> <span class="n">query_object</span><span class="o">.</span><span class="n">qreq_</span>

                    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;[web.routes.turk_identification] ... Get scores&#39;</span><span class="p">):</span>
                        <span class="c1"># Get score</span>
                        <span class="c1"># idx = cm.daid2_idx[aid2]</span>
                        <span class="c1"># match_score = cm.name_score_list[idx]</span>
                        <span class="c1"># match_score = cm.aid2_score[aid2]</span>
                        <span class="n">graph_dict</span> <span class="o">=</span> <span class="n">query_object</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span>
                        <span class="n">match_score</span> <span class="o">=</span> <span class="n">graph_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>

                    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;[web.routes.turk_identification] ... Make images&#39;</span><span class="p">):</span>
                        <span class="n">cm</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span> <span class="o">=</span> <span class="n">query_object</span><span class="o">.</span><span class="n">lookup_cm</span><span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span>
                        <span class="n">view_orientation</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;view_orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
                        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;[web.routes.turk_identification] ... ... Render images2&#39;</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">image_matches</span> <span class="o">=</span> <span class="n">apis_query</span><span class="o">.</span><span class="n">ensure_review_image</span><span class="p">(</span>
                                    <span class="n">ibs</span><span class="p">,</span> <span class="n">aid2</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span>
                                    <span class="n">view_orientation</span><span class="o">=</span><span class="n">view_orientation</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;Failed to make review image&#39;</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cm.qaid&#39;</span><span class="p">,</span> <span class="s1">&#39;aid1&#39;</span><span class="p">,</span> <span class="s1">&#39;aid2&#39;</span><span class="p">],</span>
                                           <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">image_clean</span> <span class="o">=</span> <span class="n">apis_query</span><span class="o">.</span><span class="n">ensure_review_image</span><span class="p">(</span>
                                    <span class="n">ibs</span><span class="p">,</span> <span class="n">aid2</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span>
                                    <span class="n">view_orientation</span><span class="o">=</span><span class="n">view_orientation</span><span class="p">,</span>
                                    <span class="n">draw_matches</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                                <span class="n">image_clean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;Failed to make fallback review image&#39;</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cm.qaid&#39;</span><span class="p">,</span> <span class="s1">&#39;aid1&#39;</span><span class="p">,</span> <span class="s1">&#39;aid2&#39;</span><span class="p">])</span>

                        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;[web.routes.turk_identification] ... ... Embed images&#39;</span><span class="p">):</span>
                            <span class="n">image_matches_src</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">embed_image_html</span><span class="p">(</span><span class="n">image_matches</span><span class="p">)</span>
                            <span class="n">image_clean_src</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">embed_image_html</span><span class="p">(</span><span class="n">image_clean</span><span class="p">)</span>

                    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;[web.routes.turk_identification] ... Process previous&#39;</span><span class="p">):</span>
                        <span class="c1"># Get previous</span>
                        <span class="n">previous</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">previous</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;;&#39;</span> <span class="ow">in</span> <span class="n">previous</span><span class="p">:</span>
                            <span class="n">previous</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">previous</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)))</span>
                            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
                        <span class="c1"># print(&#39;Previous = %r&#39; % (previous, ))</span>
                        <span class="c1"># print(&#39;replace_review_rowid  = %r&#39; % (replace_review_rowid, ))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">finished</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">progress</span> <span class="o">=</span> <span class="mf">100.0</span>
                    <span class="n">aid1</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">aid2</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">annot_uuid_1</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">annot_uuid_2</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">image_clean_src</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">image_matches_src</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">previous</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">replace_review_rowid</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">view_orientation</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">match_score</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finished</span> <span class="o">=</span> <span class="s1">&#39;engine&#39;</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="mf">100.0</span>
            <span class="n">aid1</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">aid2</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">annot_uuid_1</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">annot_uuid_2</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">image_clean_src</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">image_matches_src</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">replace_review_rowid</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">view_orientation</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">match_score</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">session_counter</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">QUERY_OBJECT</span><span class="o">.</span><span class="n">GLOBAL_FEEDBACK_COUNTER</span>
    <span class="n">session_limit</span> <span class="o">=</span> <span class="n">global_feedback_limit</span>

    <span class="n">confidence_dict</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">CONFIDENCE</span><span class="o">.</span><span class="n">NICE_TO_CODE</span>
    <span class="n">confidence_nice_list</span> <span class="o">=</span> <span class="n">confidence_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">confidence_text_list</span> <span class="o">=</span> <span class="n">confidence_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="n">confidence_selected_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">confidence_text</span> <span class="o">==</span> <span class="s1">&#39;unspecified&#39;</span>
        <span class="k">for</span> <span class="n">confidence_text</span> <span class="ow">in</span> <span class="n">confidence_text_list</span>
    <span class="p">]</span>
    <span class="n">confidence_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">confidence_nice_list</span><span class="p">,</span> <span class="n">confidence_text_list</span><span class="p">,</span> <span class="n">confidence_selected_list</span><span class="p">))</span>

    <span class="n">timedelta_str</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>
    <span class="k">if</span> <span class="n">aid1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">aid2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">unixtime_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">([</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">]))</span>
        <span class="k">if</span> <span class="o">-</span><span class="mf">1.0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unixtime_list</span> <span class="ow">and</span> <span class="mf">0.0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unixtime_list</span><span class="p">:</span>
            <span class="n">timedelta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">unixtime_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">unixtime_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">secs</span> <span class="o">=</span> <span class="mf">60.0</span>
            <span class="n">mins</span> <span class="o">=</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span>
            <span class="n">hrs</span>  <span class="o">=</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">24.0</span>
            <span class="n">days</span> <span class="o">=</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">24.0</span> <span class="o">*</span> <span class="mf">365.0</span>

            <span class="k">if</span> <span class="n">timedelta</span> <span class="o">&lt;</span> <span class="n">secs</span><span class="p">:</span>
                <span class="n">timedelta_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timedelta</span><span class="p">,</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">timedelta</span> <span class="o">&lt;</span> <span class="n">mins</span><span class="p">:</span>
                <span class="n">timedelta</span> <span class="o">/=</span> <span class="n">secs</span>
                <span class="n">timedelta_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1"> minutes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timedelta</span><span class="p">,</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">timedelta</span> <span class="o">&lt;</span> <span class="n">hrs</span><span class="p">:</span>
                <span class="n">timedelta</span> <span class="o">/=</span> <span class="n">mins</span>
                <span class="n">timedelta_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1"> hours&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timedelta</span><span class="p">,</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">timedelta</span> <span class="o">&lt;</span> <span class="n">days</span><span class="p">:</span>
                <span class="n">timedelta</span> <span class="o">/=</span> <span class="n">hrs</span>
                <span class="n">timedelta_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1"> days&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timedelta</span><span class="p">,</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">timedelta</span> <span class="o">/=</span> <span class="n">days</span>
                <span class="n">timedelta_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1"> years&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timedelta</span><span class="p">,</span> <span class="p">)</span>

    <span class="n">callback_url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;submit_identification&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="s1">&#39;identification&#39;</span><span class="p">,</span>
                         <span class="n">match_data</span><span class="o">=</span><span class="s1">&#39;Score: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">match_score</span><span class="p">),</span>
                         <span class="n">image_clean_src</span><span class="o">=</span><span class="n">image_clean_src</span><span class="p">,</span>
                         <span class="n">image_matches_src</span><span class="o">=</span><span class="n">image_matches_src</span><span class="p">,</span>
                         <span class="n">aid1</span><span class="o">=</span><span class="n">aid1</span><span class="p">,</span>
                         <span class="n">aid2</span><span class="o">=</span><span class="n">aid2</span><span class="p">,</span>
                         <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                         <span class="n">session</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">session_counter</span><span class="o">=</span><span class="n">session_counter</span><span class="p">,</span>
                         <span class="n">session_limit</span><span class="o">=</span><span class="n">session_limit</span><span class="p">,</span>
                         <span class="n">confidence_list</span><span class="o">=</span><span class="n">confidence_list</span><span class="p">,</span>
                         <span class="n">timedelta_str</span><span class="o">=</span><span class="n">timedelta_str</span><span class="p">,</span>
                         <span class="n">finished</span><span class="o">=</span><span class="n">finished</span><span class="p">,</span>
                         <span class="n">annot_uuid_1</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">annot_uuid_1</span><span class="p">),</span>
                         <span class="n">annot_uuid_2</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">annot_uuid_2</span><span class="p">),</span>
                         <span class="n">previous</span><span class="o">=</span><span class="n">previous</span><span class="p">,</span>
                         <span class="n">previous_version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">replace_review_rowid</span><span class="o">=</span><span class="n">replace_review_rowid</span><span class="p">,</span>
                         <span class="n">view_orientation</span><span class="o">=</span><span class="n">view_orientation</span><span class="p">,</span>
                         <span class="n">callback_url</span><span class="o">=</span><span class="n">callback_url</span><span class="p">,</span>
                         <span class="n">callback_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
                         <span class="n">EMBEDDED_CSS</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">EMBEDDED_JAVASCRIPT</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="turk_identification_graph_refer"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_identification_graph_refer">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/identification/graph/refer/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_identification_graph_refer</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_aids</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>
    <span class="n">annot_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>

    <span class="n">imageset_text</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;zebra_grevys&#39;</span> <span class="k">if</span> <span class="s1">&#39;zebra&#39;</span> <span class="ow">in</span> <span class="n">imageset_text</span> <span class="k">else</span> <span class="s1">&#39;giraffe_reticulated&#39;</span>

    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;species&#39;</span><span class="p">:</span>     <span class="n">species</span><span class="p">,</span>
        <span class="s1">&#39;threshold&#39;</span><span class="p">:</span>   <span class="mf">0.75</span><span class="p">,</span>
        <span class="s1">&#39;enable_grid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">turk_identification_graph</span><span class="p">(</span><span class="n">annot_uuid_list</span><span class="o">=</span><span class="n">annot_uuid_list</span><span class="p">,</span> <span class="n">hogwild_species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                                     <span class="n">creation_imageset_rowid_list</span><span class="o">=</span><span class="p">[</span><span class="n">imgsetid</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="delete_query_chips_graph_v2_refer"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.delete_query_chips_graph_v2_refer">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/query/graph/v2/refer/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_query_chips_graph_v2_refer</span><span class="p">(</span><span class="n">graph_uuid</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_query_chips_graph_v2</span><span class="p">(</span><span class="n">graph_uuid</span><span class="o">=</span><span class="n">graph_uuid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;view_graphs&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="turk_identification_hardcase"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_identification_hardcase">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/identification/hardcase/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_identification_hardcase</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis --db PZ_MTEST --web --browser --url=/turk/identification/hardcase/</span>
<span class="sd">        python -m ibeis --db PZ_MTEST --web --browser --url=/turk/identification/graph/</span>

<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.other.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; web_ibs = ibeis.opendb_bg_web(&#39;PZ_Master1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; resp = web_ibs.get(&#39;/turk/identification/hardcase/&#39;)</span>
<span class="sd">        &gt;&gt;&gt; web_ibs.terminate2()</span>

<span class="sd">    Ignore:</span>
<span class="sd">        import ibeis</span>
<span class="sd">        ibs, aids = ibeis.testdata_aids(&#39;PZ_Master1&#39;, a=&#39;:species=zebra_plains&#39;)</span>
<span class="sd">        print(len(aids))</span>
<span class="sd">        infr = ibeis.AnnotInference(ibs, aids=aids, autoinit=&#39;staging&#39;)</span>
<span class="sd">        infr.load_published()</span>
<span class="sd">        print(ut.repr4(infr.status()))</span>
<span class="sd">        infr.qt_review_loop()</span>

<span class="sd">        verifiers = infr.learn_evaluation_verifiers()</span>

<span class="sd">        verif = verifiers[&#39;match_state&#39;]</span>
<span class="sd">        edges = list(infr.edges())</span>
<span class="sd">        real = list(infr.edge_decision_from(edges))</span>
<span class="sd">        hardness = 1 - verif.easiness(edges, real)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">ibeis</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="c1"># HACKS</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;hardcase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="s1">&#39;annot_uuid_list&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">aids</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">testdata_aids</span><span class="p">(</span><span class="n">ibs</span><span class="o">=</span><span class="n">ibs</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="s1">&#39;:species=primary&#39;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;annot_uuid_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span><span class="o">.</span><span class="n">uuids</span>

    <span class="k">return</span> <span class="n">turk_identification_graph</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="turk_identification_graph"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_identification_graph">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/identification/graph/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_identification_graph</span><span class="p">(</span><span class="n">graph_uuid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aid1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aid2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">annot_uuid_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hardcase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">view_orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">view_version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">hogwild</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hogwild_species</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">creation_imageset_rowid_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.web.routes turk_identification_graph --db PZ_Master1</span>
<span class="sd">        python -m ibeis.web.routes turk_identification_graph --db PZ_MTEST</span>
<span class="sd">        python -m ibeis.web.routes turk_identification_graph --db testdb1 --show</span>

<span class="sd">        python -m ibeis --db PZ_MTEST --web --browser --url=/turk/identification/graph/ --noengine</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.other.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; web_ibs = ibeis.opendb_bg_web(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; resp = web_ibs.get(&#39;/turk/identification/graph/&#39;)</span>
<span class="sd">        &gt;&gt;&gt; web_ibs.terminate2()</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; ut.render_html(resp.content)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

    <span class="k">if</span> <span class="n">hogwild_species</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
        <span class="n">hogwild_species</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">progress</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">hogwild_graph_uuid</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">refer_query_uuid</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">refer_graph_uuid_str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hogwild</span> <span class="ow">and</span> <span class="n">aid1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">aid2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hogwild_graph_uuid</span> <span class="o">=</span> <span class="n">graph_uuid</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">GRAPH_CLIENT_DICT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot go hogwild when there are no graphs already started&#39;</span><span class="p">)</span>

                <span class="n">fallback_graph_uuid_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">candidate_graph_uuid_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">progress_graph_uuid_list</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">graph_uuid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">GRAPH_CLIENT_DICT</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">graph_uuid_</span> <span class="ow">in</span> <span class="n">graph_uuid_list</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">graph_uuid_</span><span class="p">,</span> <span class="p">))</span>

                    <span class="n">graph_client</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">GRAPH_CLIENT_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">graph_uuid_</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">graph_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> ERROR: UNKNOWN graph_client&#39;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">hogwild_species</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">imagesets</span> <span class="o">=</span> <span class="n">graph_client</span><span class="o">.</span><span class="n">imagesets</span>
                        <span class="k">if</span> <span class="n">imagesets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">imageset_id</span> <span class="o">=</span> <span class="n">imagesets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">imageset_text</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imageset_id</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                            <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;zebra_grevys&#39;</span> <span class="k">if</span> <span class="s1">&#39;zebra&#39;</span> <span class="ow">in</span> <span class="n">imageset_text</span> <span class="k">else</span> <span class="s1">&#39;giraffe_reticulated&#39;</span>
                            <span class="k">if</span> <span class="n">species</span> <span class="o">!=</span> <span class="n">hogwild_species</span><span class="p">:</span>
                                <span class="k">continue</span>

                    <span class="n">progress_graph_uuid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">graph_uuid_</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">graph_client</span><span class="o">.</span><span class="n">review_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> ERROR: FINISHED&#39;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="n">fallback_graph_uuid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">graph_uuid_</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> len(graph_client.futures)     = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">graph_client</span><span class="o">.</span><span class="n">futures</span><span class="p">),</span> <span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> len(graph_client.review_dict) = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">graph_client</span><span class="o">.</span><span class="n">review_dict</span><span class="p">),</span> <span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph_client</span><span class="o">.</span><span class="n">futures</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">15</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph_client</span><span class="o">.</span><span class="n">review_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">candidate_graph_uuid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">graph_uuid_</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fallback_graph_uuid_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot go hogwild when all graphs are finished&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_graph_uuid_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: candidate_graph_uuid_list was empty, picking random from fallback_graph_uuid_list&#39;</span><span class="p">)</span>
                    <span class="n">candidate_graph_uuid_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">fallback_graph_uuid_list</span><span class="p">)</span> <span class="p">]</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using Hogwild fallback_graph_uuid_list  = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fallback_graph_uuid_list</span><span class="p">,</span> <span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using Hogwild candidate_graph_uuid_list = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">candidate_graph_uuid_list</span><span class="p">,</span> <span class="p">))</span>

                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_graph_uuid_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="n">graph_uuid</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">candidate_graph_uuid_list</span><span class="p">)</span>

                <span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">graph_uuid_</span> <span class="ow">in</span> <span class="n">progress_graph_uuid_list</span><span class="p">:</span>
                    <span class="n">graph_client</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_graph_client_query_chips_graph_v2</span><span class="p">(</span><span class="n">graph_uuid_</span><span class="p">)</span>
                    <span class="n">infr_status</span> <span class="o">=</span> <span class="n">graph_client</span><span class="o">.</span><span class="n">infr_status</span>
                    <span class="k">if</span> <span class="n">infr_status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cc_status</span> <span class="o">=</span> <span class="n">infr_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cc_status&#39;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="n">progress</span> <span class="o">+=</span> <span class="n">cc_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_names_max&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using Hogwild graph_uuid = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">graph_uuid</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                <span class="n">hogwild</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">graph_uuid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">annot_uuid_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">ibeis</span>
                <span class="n">aids</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">testdata_aids</span><span class="p">(</span><span class="n">ibs</span><span class="o">=</span><span class="n">ibs</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="s1">&#39;:species=primary&#39;</span><span class="p">)</span>
                <span class="n">annot_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span><span class="o">.</span><span class="n">uuids</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[routes] Starting graph turk of </span><span class="si">{}</span><span class="s1"> annotations&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">annot_uuid_list</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">hardcase</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[routes] Graph is in hardcase-mode&#39;</span><span class="p">)</span>
                <span class="n">query_config_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;ranking.enabled&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;autoreview.enabled&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;redun.enabled&#39;</span>   <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;queue.conf.thresh&#39;</span> <span class="p">:</span> <span class="s1">&#39;absolutely_sure&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;algo.hardcase&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[routes] Graph is in hardcase-mode&#39;</span><span class="p">)</span>
                <span class="n">query_config_dict</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">query_config_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query_config_dict&#39;</span><span class="p">,</span> <span class="p">{}))</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[routes] query_config_dict = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">query_config_dict</span><span class="p">)))</span>

            <span class="n">graph_uuid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">query_chips_graph_v2</span><span class="p">(</span>
                <span class="n">annot_uuid_list</span><span class="o">=</span><span class="n">annot_uuid_list</span><span class="p">,</span>
                <span class="n">query_config_dict</span><span class="o">=</span><span class="n">query_config_dict</span><span class="p">,</span>
                <span class="n">creation_imageset_rowid_list</span><span class="o">=</span><span class="n">creation_imageset_rowid_list</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculated graph_uuid </span><span class="si">{}</span><span class="s1"> from all </span><span class="si">{}</span><span class="s1"> annotations&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">graph_uuid</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">annot_uuid_list</span><span class="p">)))</span>
            <span class="c1"># HACK probably should be a config flag instead</span>
            <span class="k">if</span> <span class="n">query_config_dict</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;turk_identification_hardcase&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;turk_identification_graph&#39;</span><span class="p">)</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span> <span class="k">if</span> <span class="s1">&#39;?&#39;</span> <span class="ow">in</span> <span class="n">base</span> <span class="k">else</span> <span class="s1">&#39;?&#39;</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">graph_uuid=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">graph_uuid</span><span class="p">),</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">hardcase</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">+=</span> <span class="s1">&#39;&amp;hardcase=True&#39;</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">review_graph_match_config_v2</span><span class="p">(</span><span class="n">graph_uuid</span><span class="p">,</span> <span class="n">aid1</span><span class="o">=</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="o">=</span><span class="n">aid2</span><span class="p">,</span>
                                                  <span class="n">view_orientation</span><span class="o">=</span><span class="n">view_orientation</span><span class="p">,</span>
                                                  <span class="n">view_version</span><span class="o">=</span><span class="n">view_version</span><span class="p">)</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="n">controller_inject</span><span class="o">.</span><span class="n">WebReviewNotReadyException</span><span class="p">:</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="s1">&#39;engine&#39;</span>
    <span class="k">except</span> <span class="n">controller_inject</span><span class="o">.</span><span class="n">WebUnavailableUUIDException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="s1">&#39;unavailable&#39;</span>
        <span class="n">refer_query_uuid</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">query_uuid</span>
        <span class="n">refer_graph_uuid_str</span> <span class="o">=</span> <span class="s1">&#39;graph_uuid=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">refer_query_uuid</span><span class="p">),</span> <span class="p">)</span>
        <span class="n">refer_graph_uuid_str</span> <span class="o">=</span> <span class="n">refer_graph_uuid_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">controller_inject</span><span class="o">.</span><span class="n">WebReviewFinishedException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="n">controller_inject</span><span class="o">.</span><span class="n">WebUnknownUUIDException</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
        <span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">,</span> <span class="n">annot_uuid_1</span><span class="p">,</span> <span class="n">annot_uuid_2</span><span class="p">,</span>
            <span class="n">image_clean_src</span><span class="p">,</span> <span class="n">image_matches_src</span><span class="p">,</span> <span class="n">image_heatmask_src</span><span class="p">,</span>
            <span class="n">server_time_start</span><span class="p">)</span> <span class="o">=</span> <span class="n">values</span>

        <span class="n">timedelta_str</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>
        <span class="k">if</span> <span class="n">aid1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">aid2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unixtime_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">([</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">]))</span>
            <span class="k">if</span> <span class="o">-</span><span class="mf">1.0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unixtime_list</span> <span class="ow">and</span> <span class="mf">0.0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unixtime_list</span><span class="p">:</span>
                <span class="n">timedelta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">unixtime_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">unixtime_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">secs</span> <span class="o">=</span> <span class="mf">60.0</span>
                <span class="n">mins</span> <span class="o">=</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span>
                <span class="n">hrs</span>  <span class="o">=</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">24.0</span>
                <span class="n">days</span> <span class="o">=</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">24.0</span> <span class="o">*</span> <span class="mf">365.0</span>

                <span class="k">if</span> <span class="n">timedelta</span> <span class="o">&lt;</span> <span class="n">secs</span><span class="p">:</span>
                    <span class="n">timedelta_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timedelta</span><span class="p">,</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="n">timedelta</span> <span class="o">&lt;</span> <span class="n">mins</span><span class="p">:</span>
                    <span class="n">timedelta</span> <span class="o">/=</span> <span class="n">secs</span>
                    <span class="n">timedelta_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1"> minutes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timedelta</span><span class="p">,</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="n">timedelta</span> <span class="o">&lt;</span> <span class="n">hrs</span><span class="p">:</span>
                    <span class="n">timedelta</span> <span class="o">/=</span> <span class="n">mins</span>
                    <span class="n">timedelta_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1"> hours&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timedelta</span><span class="p">,</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="n">timedelta</span> <span class="o">&lt;</span> <span class="n">days</span><span class="p">:</span>
                    <span class="n">timedelta</span> <span class="o">/=</span> <span class="n">hrs</span>
                    <span class="n">timedelta_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1"> days&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timedelta</span><span class="p">,</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">timedelta</span> <span class="o">/=</span> <span class="n">days</span>
                    <span class="n">timedelta_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1"> years&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timedelta</span><span class="p">,</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">progress</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">graph_client</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_graph_client_query_chips_graph_v2</span><span class="p">(</span><span class="n">graph_uuid</span><span class="p">)</span>
            <span class="n">infr_status</span> <span class="o">=</span> <span class="n">graph_client</span><span class="o">.</span><span class="n">infr_status</span>
            <span class="k">if</span> <span class="n">infr_status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cc_status</span> <span class="o">=</span> <span class="n">infr_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cc_status&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="n">cc_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_names_max&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">alert</span> <span class="o">=</span> <span class="n">priority</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">priority</span> <span class="o">&gt;</span> <span class="mf">10.0</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prob_match&#39;</span><span class="p">)</span>
        <span class="n">queue_len</span> <span class="o">=</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;queue_len&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">match_data</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([])</span>
        <span class="k">if</span> <span class="s1">&#39;evidence_decision&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">match_data</span><span class="p">[</span><span class="s1">&#39;State&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">EVIDENCE_DECISION</span><span class="o">.</span><span class="n">CODE_TO_NICE</span><span class="p">[</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;evidence_decision&#39;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="s1">&#39;match_state&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;match_state&#39;</span><span class="p">]</span>
            <span class="n">probs_nice</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_keys</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">EVIDENCE_DECISION</span><span class="o">.</span><span class="n">CODE_TO_NICE</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">order_dict_by</span><span class="p">(</span><span class="n">probs_nice</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">EVIDENCE_DECISION</span><span class="o">.</span><span class="n">CODE_TO_NICE</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">match_data</span><span class="p">[</span><span class="s1">&#39;Probs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probs_nice</span>
        <span class="k">elif</span> <span class="s1">&#39;prob_match&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">match_data</span><span class="p">[</span><span class="s1">&#39;Probs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;prob_match&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;normscore&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">match_data</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;normscore&#39;</span><span class="p">]</span>

        <span class="n">match_data</span><span class="p">[</span><span class="s1">&#39;Priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">priority</span>

        <span class="k">if</span> <span class="s1">&#39;nid_edge&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">match_data</span><span class="p">[</span><span class="s1">&#39;Names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;nid_edge&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;n_ccs&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">match_data</span><span class="p">[</span><span class="s1">&#39;Connected Components&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;n_ccs&#39;</span><span class="p">]</span>

        <span class="n">interest_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;aoi_two_weight_filepath&#39;</span><span class="p">:</span> <span class="s1">&#39;candidacy&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">interest_prediction_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">depc_annot</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;aoi_two&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">interest_config</span><span class="p">)</span>
        <span class="n">match_data</span><span class="p">[</span><span class="s1">&#39;AoI Top&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interest_prediction_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">match_data</span><span class="p">[</span><span class="s1">&#39;AoI Bottom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interest_prediction_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">match_data</span><span class="p">[</span><span class="s1">&#39;Queue Size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">queue_len</span>

        <span class="k">if</span> <span class="s1">&#39;Probs&#39;</span> <span class="ow">in</span> <span class="n">match_data</span><span class="p">:</span>
            <span class="n">probs_dict</span> <span class="o">=</span> <span class="n">match_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Probs&#39;</span><span class="p">)</span>
            <span class="n">match_data</span><span class="p">[</span><span class="s1">&#39;VAMP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="s1">&#39;Positive&#39;</span> <span class="ow">in</span> <span class="n">probs_dict</span><span class="p">:</span>
                <span class="n">match_data</span><span class="p">[</span><span class="s1">&#39;VAMP&#39;</span><span class="p">][</span><span class="s1">&#39;Positive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probs_dict</span><span class="p">[</span><span class="s1">&#39;Positive&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;Negative&#39;</span> <span class="ow">in</span> <span class="n">probs_dict</span><span class="p">:</span>
                <span class="n">match_data</span><span class="p">[</span><span class="s1">&#39;VAMP&#39;</span><span class="p">][</span><span class="s1">&#39;Negative&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probs_dict</span><span class="p">[</span><span class="s1">&#39;Negative&#39;</span><span class="p">]</span>

        <span class="n">review_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_review_rowids</span><span class="p">()</span>
        <span class="n">identity_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_review_identity</span><span class="p">(</span><span class="n">review_rowid_list</span><span class="p">)</span>
        <span class="n">num_auto</span> <span class="o">=</span> <span class="n">identity_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;algo:auto_clf&#39;</span><span class="p">)</span>
        <span class="n">num_manual</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">review_rowid_list</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_auto</span>
        <span class="n">match_data</span><span class="p">[</span><span class="s1">&#39;Reviews&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Auto&#39;</span><span class="p">:</span> <span class="n">num_auto</span><span class="p">,</span>
            <span class="s1">&#39;Manual&#39;</span><span class="p">:</span> <span class="n">num_manual</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">match_data</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">match_data</span><span class="p">,</span> <span class="n">si</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">kvsep</span><span class="o">=</span><span class="s1">&#39;=&#39;</span><span class="p">,</span>
                               <span class="n">nobr</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">previous</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;;&#39;</span> <span class="ow">in</span> <span class="n">previous</span><span class="p">:</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">previous</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)))</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">aid1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">aid2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">annot_uuid_1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">annot_uuid_2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">image_clean_src</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">image_matches_src</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">view_orientation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">match_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">alert</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">timedelta_str</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">graph_uuid_str</span> <span class="o">=</span> <span class="s1">&#39;graph_uuid=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">graph_uuid</span><span class="p">),</span> <span class="p">)</span>
    <span class="n">graph_uuid_str</span> <span class="o">=</span> <span class="n">graph_uuid_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;submit_identification_v2&#39;</span><span class="p">)</span>
    <span class="n">callback_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">?</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">graph_uuid_str</span><span class="p">,</span> <span class="p">)</span>

    <span class="n">hogwild_graph_uuid_str</span> <span class="o">=</span> <span class="s1">&#39;graph_uuid=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">hogwild_graph_uuid</span><span class="p">),</span> <span class="p">)</span>
    <span class="n">hogwild_graph_uuid_str</span> <span class="o">=</span> <span class="n">hogwild_graph_uuid_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>

    <span class="n">confidence_dict</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">CONFIDENCE</span><span class="o">.</span><span class="n">NICE_TO_CODE</span>
    <span class="n">confidence_nice_list</span> <span class="o">=</span> <span class="n">confidence_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">confidence_text_list</span> <span class="o">=</span> <span class="n">confidence_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="n">confidence_selected_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">confidence_text</span> <span class="o">==</span> <span class="s1">&#39;unspecified&#39;</span>
        <span class="k">for</span> <span class="n">confidence_text</span> <span class="ow">in</span> <span class="n">confidence_text_list</span>
    <span class="p">]</span>
    <span class="n">confidence_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">confidence_nice_list</span><span class="p">,</span> <span class="n">confidence_text_list</span><span class="p">,</span> <span class="n">confidence_selected_list</span><span class="p">))</span>

    <span class="n">graph_uuid_</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">graph_uuid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">graph_uuid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="s1">&#39;identification&#39;</span><span class="p">,</span>
                         <span class="n">match_data</span><span class="o">=</span><span class="n">match_data</span><span class="p">,</span>
                         <span class="n">image_clean_src</span><span class="o">=</span><span class="n">image_clean_src</span><span class="p">,</span>
                         <span class="n">image_matches_src</span><span class="o">=</span><span class="n">image_matches_src</span><span class="p">,</span>
                         <span class="n">aid1</span><span class="o">=</span><span class="n">aid1</span><span class="p">,</span>
                         <span class="n">aid2</span><span class="o">=</span><span class="n">aid2</span><span class="p">,</span>
                         <span class="n">alert</span><span class="o">=</span><span class="n">alert</span><span class="p">,</span>
                         <span class="n">session</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                         <span class="n">timedelta_str</span><span class="o">=</span><span class="n">timedelta_str</span><span class="p">,</span>
                         <span class="n">refer_query_uuid</span><span class="o">=</span><span class="n">refer_query_uuid</span><span class="p">,</span>
                         <span class="n">refer_graph_uuid_str</span><span class="o">=</span><span class="n">refer_graph_uuid_str</span><span class="p">,</span>
                         <span class="n">finished</span><span class="o">=</span><span class="n">finished</span><span class="p">,</span>
                         <span class="n">graph_uuid</span><span class="o">=</span><span class="n">graph_uuid_</span><span class="p">,</span>
                         <span class="n">hogwild</span><span class="o">=</span><span class="n">hogwild</span><span class="p">,</span>
                         <span class="n">hogwild_species</span><span class="o">=</span><span class="n">hogwild_species</span><span class="p">,</span>
                         <span class="n">annot_uuid_1</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">annot_uuid_1</span><span class="p">),</span>
                         <span class="n">annot_uuid_2</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">annot_uuid_2</span><span class="p">),</span>
                         <span class="n">confidence_list</span><span class="o">=</span><span class="n">confidence_list</span><span class="p">,</span>
                         <span class="n">previous</span><span class="o">=</span><span class="n">previous</span><span class="p">,</span>
                         <span class="n">graph_uuid_str</span><span class="o">=</span><span class="n">graph_uuid_str</span><span class="p">,</span>
                         <span class="n">hogwild_graph_uuid_str</span><span class="o">=</span><span class="n">hogwild_graph_uuid_str</span><span class="p">,</span>
                         <span class="n">previous_version</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                         <span class="n">replace_review_rowid</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">view_orientation</span><span class="o">=</span><span class="n">view_orientation</span><span class="p">,</span>
                         <span class="n">callback_url</span><span class="o">=</span><span class="n">callback_url</span><span class="p">,</span>
                         <span class="n">callback_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
                         <span class="n">EMBEDDED_CSS</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">EMBEDDED_JAVASCRIPT</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="turk_quality"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_quality">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/quality/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_quality</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PZ Needs Tags:</span>
<span class="sd">        17242</span>
<span class="sd">        14468</span>
<span class="sd">        14427</span>
<span class="sd">        15946</span>
<span class="sd">        14771</span>
<span class="sd">        14084</span>
<span class="sd">        4102</span>
<span class="sd">        6074</span>
<span class="sd">        3409</span>

<span class="sd">    GZ Needs Tags;</span>
<span class="sd">    1302</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.web.app --exec-turk_quality --db PZ_Master1</span>
<span class="sd">        python -m ibeis.web.app --exec-turk_quality --db GZ_Master1</span>
<span class="sd">        python -m ibeis.web.app --exec-turk_quality --db GIRM_Master1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.other.ibsfuncs import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list_ = ibs.find_unlabeled_name_members(qual=True)</span>
<span class="sd">        &gt;&gt;&gt; valid_views = [&#39;primary&#39;, &#39;primary1&#39;, &#39;primary-1&#39;]</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.filter_aids_to_viewpoint(aid_list_, valid_views, unknown_ok=False)</span>
<span class="sd">        &gt;&gt;&gt; ibs.start_web_annot_groupreview(aid_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
    <span class="n">tup</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">get_turk_annot_args</span><span class="p">(</span><span class="n">appf</span><span class="o">.</span><span class="n">imageset_annot_quality_processed</span><span class="p">)</span>
    <span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">reviewed_list</span><span class="p">,</span> <span class="n">imgsetid</span><span class="p">,</span> <span class="n">src_ag</span><span class="p">,</span> <span class="n">dst_ag</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span> <span class="o">=</span> <span class="n">tup</span>

    <span class="n">value</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_qualities</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">review</span> <span class="o">=</span> <span class="s1">&#39;review&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="n">aid</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">display_instructions</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ia-quality_instructions_seen&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
        <span class="n">gid</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">image_src</span> <span class="o">=</span> <span class="n">routes_ajax</span><span class="o">.</span><span class="n">annotation_src</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gid</span>       <span class="o">=</span> <span class="kc">None</span>
        <span class="n">image_src</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">imagesettext</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="s1">&#39;quality&#39;</span><span class="p">,</span>
                         <span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">,</span>
                         <span class="n">src_ag</span><span class="o">=</span><span class="n">src_ag</span><span class="p">,</span>
                         <span class="n">dst_ag</span><span class="o">=</span><span class="n">dst_ag</span><span class="p">,</span>
                         <span class="n">gid</span><span class="o">=</span><span class="n">gid</span><span class="p">,</span>
                         <span class="n">aid</span><span class="o">=</span><span class="n">aid</span><span class="p">,</span>
                         <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                         <span class="n">image_src</span><span class="o">=</span><span class="n">image_src</span><span class="p">,</span>
                         <span class="n">previous</span><span class="o">=</span><span class="n">previous</span><span class="p">,</span>
                         <span class="n">imagesettext</span><span class="o">=</span><span class="n">imagesettext</span><span class="p">,</span>
                         <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                         <span class="n">finished</span><span class="o">=</span><span class="n">finished</span><span class="p">,</span>
                         <span class="n">display_instructions</span><span class="o">=</span><span class="n">display_instructions</span><span class="p">,</span>
                         <span class="n">review</span><span class="o">=</span><span class="n">review</span><span class="p">)</span></div>


<div class="viewcode-block" id="turk_demographics"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.turk_demographics">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/turk/demographics/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">turk_demographics</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="s1">&#39;zebra_grevys&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;turk_demographics&#39;</span><span class="p">):</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">imgsetid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imgsetid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">imgsetid</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">imgsetid</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">imgsetid</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;turk_demographics 0&#39;</span><span class="p">):</span>
            <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">(</span><span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">)</span>
            <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>
            <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">check_ggr_valid_aids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
            <span class="n">reviewed_list</span> <span class="o">=</span> <span class="n">appf</span><span class="o">.</span><span class="n">imageset_annot_demographics_processed</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;!&#39;</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Demographics Progress&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> reviewed_list.count(True) = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reviewed_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> len(reviewed_list)        = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;!&#39;</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="n">reviewed_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="s1">&#39;0.00&#39;</span>

        <span class="n">imagesettext</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">imgsetid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid</span><span class="p">)</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">aid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">reviewed_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">aid</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># aid = aid_list_[0]</span>
                <span class="n">aid</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">)</span>

        <span class="n">previous</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">value_sex</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_sex</span><span class="p">([</span><span class="n">aid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">value_sex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value_sex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">value_sex</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value_sex</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">value_age_min</span><span class="p">,</span> <span class="n">value_age_max</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_age_months_est</span><span class="p">([</span><span class="n">aid</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">value_age</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value_age_min</span> <span class="ow">is</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">value_age_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">value_age_max</span> <span class="ow">is</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">value_age_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">value_age</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value_age_min</span> <span class="ow">is</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">value_age_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value_age_max</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">value_age</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">value_age_min</span> <span class="ow">is</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">value_age_max</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">value_age</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">value_age_min</span> <span class="ow">is</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">value_age_max</span> <span class="o">==</span> <span class="mi">11</span><span class="p">:</span>
            <span class="n">value_age</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">elif</span> <span class="n">value_age_min</span> <span class="ow">is</span> <span class="mi">12</span> <span class="ow">and</span> <span class="n">value_age_max</span> <span class="o">==</span> <span class="mi">23</span><span class="p">:</span>
            <span class="n">value_age</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">elif</span> <span class="n">value_age_min</span> <span class="ow">is</span> <span class="mi">24</span> <span class="ow">and</span> <span class="n">value_age_max</span> <span class="o">==</span> <span class="mi">35</span><span class="p">:</span>
            <span class="n">value_age</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="k">elif</span> <span class="n">value_age_min</span> <span class="ow">is</span> <span class="mi">36</span> <span class="ow">and</span> <span class="p">(</span><span class="n">value_age_max</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value_age_max</span> <span class="o">&gt;</span> <span class="mi">36</span><span class="p">):</span>
            <span class="n">value_age</span> <span class="o">=</span> <span class="mi">7</span>

        <span class="n">review</span> <span class="o">=</span> <span class="s1">&#39;review&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="n">aid</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">display_instructions</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ia-demographics_instructions_seen&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
            <span class="n">gid</span>       <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
            <span class="n">image_src</span> <span class="o">=</span> <span class="n">routes_ajax</span><span class="o">.</span><span class="n">annotation_src</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gid</span>       <span class="o">=</span> <span class="kc">None</span>
            <span class="n">image_src</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">name_aid_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">nid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name_aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_aids</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
            <span class="n">quality_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_qualities</span><span class="p">(</span><span class="n">name_aid_list</span><span class="p">)</span>
            <span class="n">quality_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">name_aid_list</span><span class="p">)</span>
            <span class="n">viewpoint_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoints</span><span class="p">(</span><span class="n">name_aid_list</span><span class="p">)</span>
            <span class="n">name_aid_combined_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                <span class="n">name_aid_list</span><span class="p">,</span>
                <span class="n">quality_list</span><span class="p">,</span>
                <span class="n">quality_text_list</span><span class="p">,</span>
                <span class="n">viewpoint_list</span><span class="p">,</span>
            <span class="p">))</span>
            <span class="c1"># name_aid_combined_list.sort(key=lambda t: t[1], reverse=True)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name_aid_combined_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">region_str</span> <span class="o">=</span> <span class="s1">&#39;UNKNOWN&#39;</span>
        <span class="k">if</span> <span class="n">aid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">gid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_image_imgsetids</span><span class="p">(</span><span class="n">gid</span><span class="p">))</span>
            <span class="n">imgset_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_text</span><span class="p">(</span><span class="n">imgsetid_list</span><span class="p">)</span>
            <span class="n">imgset_text_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">imgset_text</span>
                <span class="k">for</span> <span class="n">imgset_text</span> <span class="ow">in</span> <span class="n">imgset_text_list</span>
                <span class="k">if</span> <span class="s1">&#39;GGR Special Zone&#39;</span> <span class="ow">in</span> <span class="n">imgset_text</span>
            <span class="p">]</span>
            <span class="c1"># assert len(imgset_text_list) &lt; 2</span>
            <span class="c1"># if len(imgset_text_list) == 1:</span>
            <span class="c1">#     region_str = imgset_text_list[0]</span>
            <span class="n">region_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imgset_text_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="s1">&#39;turk&#39;</span><span class="p">,</span> <span class="s1">&#39;demographics&#39;</span><span class="p">,</span>
                         <span class="n">imgsetid</span><span class="o">=</span><span class="n">imgsetid</span><span class="p">,</span>
                         <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                         <span class="n">gid</span><span class="o">=</span><span class="n">gid</span><span class="p">,</span>
                         <span class="n">aid</span><span class="o">=</span><span class="n">aid</span><span class="p">,</span>
                         <span class="n">region_str</span><span class="o">=</span><span class="n">region_str</span><span class="p">,</span>
                         <span class="n">value_sex</span><span class="o">=</span><span class="n">value_sex</span><span class="p">,</span>
                         <span class="n">value_age</span><span class="o">=</span><span class="n">value_age</span><span class="p">,</span>
                         <span class="n">name_aid_combined_list</span><span class="o">=</span><span class="n">name_aid_combined_list</span><span class="p">,</span>
                         <span class="n">image_src</span><span class="o">=</span><span class="n">image_src</span><span class="p">,</span>
                         <span class="n">previous</span><span class="o">=</span><span class="n">previous</span><span class="p">,</span>
                         <span class="n">imagesettext</span><span class="o">=</span><span class="n">imagesettext</span><span class="p">,</span>
                         <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                         <span class="n">finished</span><span class="o">=</span><span class="n">finished</span><span class="p">,</span>
                         <span class="n">display_instructions</span><span class="o">=</span><span class="n">display_instructions</span><span class="p">,</span>
                         <span class="n">review</span><span class="o">=</span><span class="n">review</span><span class="p">)</span></div>


<div class="viewcode-block" id="group_review"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.group_review">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/group_review/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">group_review</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">prefill</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prefill&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefill</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
        <span class="n">bad_species_list</span><span class="p">,</span> <span class="n">bad_viewpoint_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">validate_annot_species_viewpoint_cnn</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>

        <span class="n">GROUP_BY_PREDICTION</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">GROUP_BY_PREDICTION</span><span class="p">:</span>
            <span class="n">grouped_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">bad_viewpoint_list</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">bad_viewpoint_list</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">grouped_list</span> <span class="o">=</span> <span class="n">grouped_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="n">regrouped_items</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">grouped_list</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">grouped_list</span><span class="p">)))</span>
            <span class="n">candidate_aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">regrouped_items</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">candidate_aid_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">bad_viewpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">bad_viewpoint</span> <span class="ow">in</span> <span class="n">bad_viewpoint_list</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aid_list&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aid_list&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">aid_list</span> <span class="o">=</span> <span class="n">aid_list</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">aid_list</span> <span class="o">=</span> <span class="n">aid_list</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">aid_list</span> <span class="o">=</span> <span class="n">aid_list</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">candidate_aid_list</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">aid_</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">aid_</span> <span class="ow">in</span> <span class="n">aid_list</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">candidate_aid_list</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">candidate_aid_list</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;group_review&#39;</span><span class="p">,</span> <span class="n">candidate_aid_list</span><span class="o">=</span><span class="n">candidate_aid_list</span><span class="p">,</span> <span class="n">mode_list</span><span class="o">=</span><span class="n">appf</span><span class="o">.</span><span class="n">VALID_TURK_MODES</span><span class="p">)</span></div>


<div class="viewcode-block" id="sightings"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.sightings">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/sightings/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">sightings</span><span class="p">(</span><span class="n">html_encode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
    <span class="n">complete</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;complete&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">sightings</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">report_sightings_str</span><span class="p">(</span><span class="n">complete</span><span class="o">=</span><span class="n">complete</span><span class="p">,</span> <span class="n">include_images</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">html_encode</span><span class="p">:</span>
        <span class="n">sightings</span> <span class="o">=</span> <span class="n">sightings</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;br/&gt;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sightings</span></div>


<div class="viewcode-block" id="api_root"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.api_root">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">],</span> <span class="n">__route_prefix_check__</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">api_root</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">url_map</span><span class="o">.</span><span class="n">iter_rules</span><span class="p">()</span>
    <span class="n">rule_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">methods</span>
        <span class="n">url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;/api/&#39;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">methods</span> <span class="o">-=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;HEAD&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">methods</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">methods</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;methods = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">methods</span><span class="p">,))</span>
            <span class="n">method</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">methods</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">rule_dict</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rule_dict</span><span class="p">[</span><span class="n">method</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">rule_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rule_dict</span><span class="p">[</span><span class="n">method</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/api/core/dbname/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">server_url</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">app_auth</span> <span class="o">=</span> <span class="n">controller_inject</span><span class="o">.</span><span class="n">get_url_authorization</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;api&#39;</span><span class="p">,</span>
                         <span class="n">app_url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                         <span class="n">app_name</span><span class="o">=</span><span class="n">controller_inject</span><span class="o">.</span><span class="n">GLOBAL_APP_NAME</span><span class="p">,</span>
                         <span class="n">app_secret</span><span class="o">=</span><span class="n">controller_inject</span><span class="o">.</span><span class="n">GLOBAL_APP_SECRET</span><span class="p">,</span>
                         <span class="n">app_auth</span><span class="o">=</span><span class="n">app_auth</span><span class="p">,</span>
                         <span class="n">rule_list</span><span class="o">=</span><span class="n">rule_dict</span><span class="p">)</span></div>


<div class="viewcode-block" id="upload"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.upload">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/upload/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;upload&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="dbinfo"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.dbinfo">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/dbinfo/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">dbinfo</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">dbinfo_str</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbinfo_str</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">dbinfo_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">dbinfo_str_formatted</span> <span class="o">=</span> <span class="s1">&#39;&lt;pre&gt;</span><span class="si">%s</span><span class="s1">&lt;/pre&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dbinfo_str</span><span class="p">,</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">dbinfo_str_formatted</span></div>


<div class="viewcode-block" id="wb_counts"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.wb_counts">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/counts/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">wb_counts</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">fmt_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;p&gt;# Annotations: &lt;b&gt;</span><span class="si">%d</span><span class="s1">&lt;/b&gt;&lt;/p&gt;</span>
<span class="s1">&lt;p&gt;# MediaAssets (images): &lt;b&gt;</span><span class="si">%d</span><span class="s1">&lt;/b&gt;&lt;/p&gt;</span>
<span class="s1">&lt;p&gt;# MarkedIndividuals: &lt;b&gt;</span><span class="si">%d</span><span class="s1">&lt;/b&gt;&lt;/p&gt;</span>
<span class="s1">&lt;p&gt;# Encounters: &lt;b&gt;</span><span class="si">%d</span><span class="s1">&lt;/b&gt;&lt;/p&gt;</span>
<span class="s1">&lt;p&gt;# Occurrences: &lt;b&gt;</span><span class="si">%d</span><span class="s1">&lt;/b&gt;&lt;/p&gt;&#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">ibs</span>

        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
        <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
        <span class="n">nid_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">nid</span> <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nid_list</span> <span class="k">if</span> <span class="n">nid</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">]</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
        <span class="n">imgset_id_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_imgsetids</span><span class="p">()</span>
        <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_aids</span><span class="p">(</span><span class="n">imgset_id_list</span><span class="p">)</span>
        <span class="n">imgset_id_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">imgset_id</span>
            <span class="k">for</span> <span class="n">imgset_id</span><span class="p">,</span> <span class="n">aid_list_</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">imgset_id_list</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">]</span>

        <span class="n">valid_nid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">nid_list</span><span class="p">))</span>
        <span class="n">valid_aid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
        <span class="n">valid_gid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>
        <span class="n">valid_imgset_id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">imgset_id_list</span><span class="p">))</span>
        <span class="n">valid_imgset_id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">imgset_id_list</span><span class="p">))</span>

        <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_aids</span><span class="p">(</span><span class="n">valid_imgset_id_list</span><span class="p">)</span>
        <span class="n">nids_list</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
        <span class="n">nids_list</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">nids_list</span><span class="p">)</span>
        <span class="n">nids_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">nids_list</span><span class="p">)</span>

        <span class="n">num_nid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_nid_list</span><span class="p">)</span>
        <span class="n">num_aid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_aid_list</span><span class="p">)</span>
        <span class="n">num_gid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_gid_list</span><span class="p">)</span>
        <span class="n">num_imgset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_imgset_id_list</span><span class="p">)</span>
        <span class="n">num_encounters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nids_list</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_aid</span><span class="p">,</span> <span class="n">num_gid</span><span class="p">,</span> <span class="n">num_nid</span><span class="p">,</span> <span class="n">num_encounters</span><span class="p">,</span> <span class="n">num_imgset</span><span class="p">,</span> <span class="p">)</span>
        <span class="n">counts_str</span> <span class="o">=</span> <span class="n">fmt_str</span> <span class="o">%</span> <span class="n">args</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">counts_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">return</span> <span class="n">counts_str</span></div>


<div class="viewcode-block" id="wb_counts_alias1"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.wb_counts_alias1">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/test/counts.jsp&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">],</span> <span class="n">__route_postfix_check__</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">wb_counts_alias1</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">wb_counts</span><span class="p">()</span></div>


<div class="viewcode-block" id="wb_counts_alias2"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.wb_counts_alias2">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/gzgc/counts.jsp&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">],</span> <span class="n">__route_postfix_check__</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">wb_counts_alias2</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">wb_counts</span><span class="p">()</span></div>


<div class="viewcode-block" id="error404"><a class="viewcode-back" href="../../../ibeis.web.html#ibeis.web.routes.error404">[docs]</a><span class="nd">@register_route</span><span class="p">(</span><span class="s1">&#39;/404/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">error404</span><span class="p">(</span><span class="n">exception</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">traceback</span>
    <span class="n">exception_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
    <span class="n">traceback_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[web] </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">exception_str</span><span class="p">,</span> <span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[web] </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">traceback_str</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">return</span> <span class="n">appf</span><span class="o">.</span><span class="n">template</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;404&#39;</span><span class="p">,</span> <span class="n">exception_str</span><span class="o">=</span><span class="n">exception_str</span><span class="p">,</span>
                         <span class="n">traceback_str</span><span class="o">=</span><span class="n">traceback_str</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.web.app</span>
<span class="sd">        python -m ibeis.web.app --allexamples</span>
<span class="sd">        python -m ibeis.web.app --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c1"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Wild Me.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.8.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>