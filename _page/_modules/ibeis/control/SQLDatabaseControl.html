

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ibeis.control.SQLDatabaseControl &mdash; ibeis 1.5.2 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ibeis 1.5.2 documentation" href="../../../index.html"/>
        <link rel="up" title="ibeis.control" href="../control.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> ibeis
          

          
          </a>

          
            
            
              <div class="version">
                1.5.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ibeis.html">ibeis package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">ibeis</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
          <li><a href="../../ibeis.html">ibeis</a> &raquo;</li>
      
          <li><a href="../control.html">ibeis.control</a> &raquo;</li>
      
    <li>ibeis.control.SQLDatabaseControl</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ibeis.control.SQLDatabaseControl</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Interface into SQL for the IBEIS Controller</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#from __future__ import absolute_import, division, print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">parse</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">map</span><span class="p">,</span> <span class="nb">zip</span><span class="p">,</span> <span class="n">cStringIO</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">exists</span>
<span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">ibeis.control._sql_helpers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_unpacker</span><span class="p">,</span> <span class="n">sanitize_sql</span><span class="p">,</span> <span class="n">SQLExecutionContext</span><span class="p">,</span> <span class="n">VERBOSE_SQL</span><span class="p">,</span> <span class="n">NOT_QUIET</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">ibeis.control</span> <span class="kn">import</span> <span class="n">__SQLITE3__</span> <span class="k">as</span> <span class="n">lite</span>
<span class="k">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s1">&#39;[sql]&#39;</span><span class="p">)</span>

<span class="n">VERBOSE</span>        <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span>
<span class="n">VERYVERBOSE</span>    <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERYVERBOSE</span>
<span class="n">COPY_TO_MEMORY</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--copy-db-to-memory&#39;</span><span class="p">))</span>
<span class="c1">#AUTODUMP       = ut.get_argflag(&#39;--auto-dump&#39;)</span>

<span class="n">SQLColumnRichInfo</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;SQLColumnRichInfo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;column_id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;type_&#39;</span><span class="p">,</span> <span class="s1">&#39;notnull&#39;</span><span class="p">,</span> <span class="s1">&#39;dflt_value&#39;</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">))</span>


<span class="n">__STR__</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">__STR__</span>


<div class="viewcode-block" id="default_decor"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.default_decor">[docs]</a><span class="k">def</span> <span class="nf">default_decor</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="c1">#return profile(func)</span>
    <span class="k">return</span> <span class="n">func</span>

</div>
<div class="viewcode-block" id="SQLAtomicContext"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLAtomicContext">[docs]</a><span class="k">class</span> <span class="nc">SQLAtomicContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE_SQL</span><span class="p">):</span>
        <span class="n">context</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>  <span class="c1"># Reference to sqldb</span>
        <span class="n">context</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>  <span class="c1"># Get new cursor</span>
        <span class="n">context</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

<div class="viewcode-block" id="SQLAtomicContext.__enter__"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLAtomicContext.__enter__">[docs]</a>    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets the database into a state of an atomic transaction &quot;&quot;&quot;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;BEGIN EXCLUSIVE TRANSACTION&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span>
</div>
<div class="viewcode-block" id="SQLAtomicContext.__exit__"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLAtomicContext.__exit__">[docs]</a>    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Finalization of an SQLAtomicContext &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># An SQLError is a serious offence.</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] FATAL ERROR IN ATOMIC CONTEXT&#39;</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>  <span class="c1"># Dump on error</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] Error in atomic context manager!: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>  <span class="c1"># return a falsey value on error</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">context</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="dev_test_new_schema_version"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.dev_test_new_schema_version">[docs]</a><span class="k">def</span> <span class="nf">dev_test_new_schema_version</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">sqldb_dpath</span><span class="p">,</span> <span class="n">sqldb_fname</span><span class="p">,</span>
                                <span class="n">version_current</span><span class="p">,</span> <span class="n">version_next</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    hacky function to ensure that only developer sees the development schema</span>
<span class="sd">    and only on test databases</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">TESTING_NEW_SQL_VERSION</span> <span class="o">=</span> <span class="n">version_current</span> <span class="o">!=</span> <span class="n">version_next</span>
    <span class="k">if</span> <span class="n">TESTING_NEW_SQL_VERSION</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] ATTEMPTING TO TEST NEW SQLDB VERSION&#39;</span><span class="p">)</span>
        <span class="n">devdb_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PZ_MTEST&#39;</span><span class="p">,</span> <span class="s1">&#39;testdb1&#39;</span><span class="p">,</span> <span class="s1">&#39;testdb0&#39;</span><span class="p">,</span> <span class="s1">&#39;testdb2&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;testdb_dst2&#39;</span><span class="p">,</span> <span class="s1">&#39;emptydatabase&#39;</span><span class="p">]</span>
        <span class="n">testing_newschmea</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_developer</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dbname</span> <span class="ow">in</span> <span class="n">devdb_list</span>
        <span class="c1">#testing_newschmea = False</span>
        <span class="c1">#ut.is_developer() and ibs.get_dbname() in [&#39;PZ_MTEST&#39;, &#39;testdb1&#39;]</span>
        <span class="k">if</span> <span class="n">testing_newschmea</span><span class="p">:</span>
            <span class="c1"># Set to true until the schema module is good then continue tests</span>
            <span class="c1"># with this set to false</span>
            <span class="n">testing_force_fresh</span> <span class="o">=</span> <span class="bp">True</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--force-fresh&#39;</span><span class="p">)</span>
            <span class="c1"># Work on a fresh schema copy when developing</span>
            <span class="n">dev_sqldb_fname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">augpath</span><span class="p">(</span><span class="n">sqldb_fname</span><span class="p">,</span> <span class="s1">&#39;_develop_schema&#39;</span><span class="p">)</span>
            <span class="n">sqldb_fpath</span>     <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">sqldb_dpath</span><span class="p">,</span> <span class="n">sqldb_fname</span><span class="p">)</span>
            <span class="n">dev_sqldb_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">sqldb_dpath</span><span class="p">,</span> <span class="n">dev_sqldb_fname</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sqldb_fpath</span><span class="p">,</span> <span class="n">dev_sqldb_fpath</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">testing_force_fresh</span><span class="p">)</span>
            <span class="c1"># Set testing schema version</span>
            <span class="c1">#ibs.db_version_expected = &#39;1.3.6&#39;</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] TESTING NEW SQLDB VERSION: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">version_next</span><span class="p">,))</span>
            <span class="c1">#print(&#39;[sql] ... pass --force-fresh to reload any changes&#39;)</span>
            <span class="k">return</span> <span class="n">version_next</span><span class="p">,</span> <span class="n">dev_sqldb_fname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[ibs] NOT TESTING&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">version_current</span><span class="p">,</span> <span class="n">sqldb_fname</span>

</div>
<div class="viewcode-block" id="SQLDatabaseController"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController">[docs]</a><span class="k">class</span> <span class="nc">SQLDatabaseController</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SQLDatabaseController an efficientish interface into SQL</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">sqldb_dpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">sqldb_fname</span><span class="o">=</span><span class="s1">&#39;database.sqlite3&#39;</span><span class="p">,</span>
                 <span class="n">text_factory</span><span class="o">=</span><span class="n">__STR__</span><span class="p">,</span> <span class="n">inmemory</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates db and opens connection &quot;&quot;&quot;</span>
        <span class="c1"># standard metadata table keys for each docstr</span>
        <span class="c1"># TODO: generalize the places that use this so to add a new cannonical</span>
        <span class="c1"># metadata field it is only necessary to append to this list.</span>
        <span class="n">db</span><span class="o">.</span><span class="n">table_metadata_keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c1">#&#39;constraint&#39;,</span>
            <span class="s1">&#39;dependson&#39;</span><span class="p">,</span>
            <span class="s1">&#39;docstr&#39;</span><span class="p">,</span>
            <span class="s1">&#39;relates&#39;</span><span class="p">,</span>
            <span class="s1">&#39;shortname&#39;</span><span class="p">,</span>
            <span class="s1">&#39;superkeys&#39;</span><span class="p">,</span>
            <span class="s1">&#39;extern_tables&#39;</span><span class="p">,</span>
            <span class="s1">&#39;dependsmap&#39;</span><span class="p">,</span>
            <span class="s1">&#39;primary_superkey&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="c1"># Get SQL file path</span>
        <span class="n">db</span><span class="o">.</span><span class="n">dir_</span>  <span class="o">=</span> <span class="n">sqldb_dpath</span>
        <span class="n">db</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">sqldb_fname</span>
        <span class="k">assert</span> <span class="n">exists</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">dir_</span><span class="p">),</span> <span class="s1">&#39;[sql] db.dir_=</span><span class="si">%r</span><span class="s1"> does not exist!&#39;</span> <span class="o">%</span> <span class="n">db</span><span class="o">.</span><span class="n">dir_</span>
        <span class="n">db</span><span class="o">.</span><span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">dir_</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">text_factory</span> <span class="o">=</span> <span class="n">text_factory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">fpath</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] Initializing new database&#39;</span><span class="p">)</span>
        <span class="c1"># Open the SQL database connection with support for custom types</span>
        <span class="c1">#lite.enable_callback_tracebacks(True)</span>
        <span class="c1">#db.fpath = &#39;:memory:&#39;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">lite</span><span class="o">.</span><span class="n">connect2</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">fpath</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">text_factory</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">text_factory</span>
        <span class="c1">#db.connection.isolation_level = None  # turns sqlite3 autocommit off</span>
        <span class="c1">#db.connection.isolation_level = lite.IMMEDIATE  # turns sqlite3 autocommit off</span>
        <span class="k">if</span> <span class="n">inmemory</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">or</span> <span class="p">(</span><span class="n">inmemory</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">COPY_TO_MEMORY</span><span class="p">):</span>
            <span class="n">db</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_copy_to_memory</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">text_factory</span> <span class="o">=</span> <span class="n">text_factory</span>
        <span class="c1"># Get a cursor which will preform sql commands / queries / executions</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c1"># Optimize the database (if anything is set)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">_ensure_metadata_table</span><span class="p">()</span>

<div class="viewcode-block" id="SQLDatabaseController.get_fpath"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_fpath">[docs]</a>    <span class="k">def</span> <span class="nf">get_fpath</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">fpath</span>
</div>
<div class="viewcode-block" id="SQLDatabaseController.close"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_ensure_metadata_table</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the metadata table if it does not exist</span>

<span class="sd">        We need this to be done every time so that the update code works</span>
<span class="sd">        correctly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span> <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;metadata_rowid&#39;</span><span class="p">,</span>               <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;metadata_key&#39;</span><span class="p">,</span>                 <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;metadata_value&#39;</span><span class="p">,</span>               <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
        <span class="p">),</span>
            <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;metadata_key&#39;</span><span class="p">,)],</span>
            <span class="c1"># IMPORTANT: Yes, we want this line to be tabbed over for the</span>
            <span class="c1"># schema auto-generation</span>
            <span class="n">docstr</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        The table that stores permanently all of the metadata about the</span>
<span class="s1">        database (tables, etc)&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># Ensure that a version number exists</span>
        <span class="n">db</span><span class="o">.</span><span class="n">get_db_version</span><span class="p">(</span><span class="n">ensure</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<div class="viewcode-block" id="SQLDatabaseController.get_db_version"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_db_version">[docs]</a>    <span class="k">def</span> <span class="nf">get_db_version</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_metadata_val</span><span class="p">(</span><span class="s1">&#39;database_version&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ensure</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">BASE_DATABASE_VERSION</span>
            <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metadata_key&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata_value&#39;</span><span class="p">]</span>
            <span class="n">params_iter</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;database_version&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">version</span><span class="p">])</span>
            <span class="c1"># We don&#39;t care to find any, because we know there is no version</span>
            <span class="k">def</span> <span class="nf">get_rowid_from_superkey</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add_cleanly</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">get_rowid_from_superkey</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">version</span>
</div>
    <span class="k">def</span> <span class="nf">_copy_to_memory</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        References:</span>
<span class="sd">            http://stackoverflow.com/questions/3850022/python-sqlite3-load-existing-db-file-to-memory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">NOT_QUIET</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] Copying database into RAM&#39;</span><span class="p">)</span>
        <span class="n">tempfile</span> <span class="o">=</span> <span class="n">cStringIO</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">iterdump</span><span class="p">():</span>
            <span class="n">tempfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">tempfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Create a database in memory and import from tempfile</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">lite</span><span class="o">.</span><span class="n">connect2</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">lite</span><span class="o">.</span><span class="n">Row</span>

    <span class="c1">#@ut.memprof</span>
<div class="viewcode-block" id="SQLDatabaseController.reboot"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.reboot">[docs]</a>    <span class="k">def</span> <span class="nf">reboot</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] reboot&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">db</span><span class="o">.</span><span class="n">cur</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">db</span><span class="o">.</span><span class="n">connection</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">lite</span><span class="o">.</span><span class="n">connect2</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">fpath</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">text_factory</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">text_factory</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SQLDatabaseController.optimize"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.optimize">[docs]</a>    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="c1"># http://web.utk.edu/~jplyon/sqlite/SQLite_optimization_FAQ.html#pragma-cache_size</span>
        <span class="c1"># http://web.utk.edu/~jplyon/sqlite/SQLite_optimization_FAQ.html</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] running sql pragma optimizions&#39;</span><span class="p">)</span>
        <span class="c1">#db.cur.execute(&#39;PRAGMA cache_size = 0;&#39;)</span>
        <span class="c1">#db.cur.execute(&#39;PRAGMA cache_size = 1024;&#39;)</span>
        <span class="c1">#db.cur.execute(&#39;PRAGMA page_size = 1024;&#39;)</span>
        <span class="c1">#print(&#39;[sql] running sql pragma optimizions&#39;)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA cache_size = 10000;&#39;</span><span class="p">)</span>  <span class="c1"># Default: 2000</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA temp_store = MEMORY;&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA synchronous = OFF;&#39;</span><span class="p">)</span>
        <span class="c1">#db.cur.execute(&#39;PRAGMA synchronous = NORMAL;&#39;)</span>
        <span class="c1">#db.cur.execute(&#39;PRAGMA synchronous = FULL;&#39;)  # Default</span>
        <span class="c1">#db.cur.execute(&#39;PRAGMA parser_trace = OFF;&#39;)</span>
        <span class="c1">#db.cur.execute(&#39;PRAGMA busy_timeout = 1;&#39;)</span>
        <span class="c1">#db.cur.execute(&#39;PRAGMA default_cache_size = 0;&#39;)</span>
</div>
<div class="viewcode-block" id="SQLDatabaseController.shrink_memory"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.shrink_memory">[docs]</a>    <span class="k">def</span> <span class="nf">shrink_memory</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] shrink_memory&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA shrink_memory;&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SQLDatabaseController.vacuum"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.vacuum">[docs]</a>    <span class="k">def</span> <span class="nf">vacuum</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] vaccum&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;VACUUM;&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SQLDatabaseController.squeeze"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.squeeze">[docs]</a>    <span class="k">def</span> <span class="nf">squeeze</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] squeeze&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">shrink_memory</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">vacuum</span><span class="p">()</span>

    <span class="c1">#==============</span>
    <span class="c1"># API INTERFACE</span>
    <span class="c1">#==============</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_all_rowids"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_all_rowids">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_rowids</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns a list of all rowids from a table in ascending order &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span> <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        SELECT rowid</span>
<span class="s1">        FROM {tblname}</span>
<span class="s1">        ORDER BY rowid ASC</span>
<span class="s1">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">_executeone_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_all_col_rows"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_all_col_rows">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_col_rows</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns a list of all rowids from a table in ascending order &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;colname&#39;</span><span class="p">:</span> <span class="n">colname</span><span class="p">,</span> <span class="s1">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span> <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        SELECT {colname}</span>
<span class="s1">        FROM {tblname}</span>
<span class="s1">        ORDER BY rowid ASC</span>
<span class="s1">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">_executeone_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_all_rowids_where"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_all_rowids_where">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_rowids_where</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns a list of rowids from a table in ascending order satisfying a</span>
<span class="sd">        condition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span> <span class="s1">&#39;where_clause&#39;</span><span class="p">:</span> <span class="n">where_clause</span><span class="p">,</span> <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        SELECT rowid</span>
<span class="s1">        FROM {tblname}</span>
<span class="s1">        WHERE {where_clause}</span>
<span class="s1">        ORDER BY rowid ASC</span>
<span class="s1">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">_executeone_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.check_rowid_exists"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.check_rowid_exists">[docs]</a>    <span class="k">def</span> <span class="nf">check_rowid_exists</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">rowid_iter</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rowid_list1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;rowid&#39;</span><span class="p">,),</span> <span class="n">rowid_iter</span><span class="p">)</span>
        <span class="n">exists_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">rowid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">rowid</span> <span class="ow">in</span> <span class="n">rowid_list1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">exists_list</span>
</div>
    <span class="nd">@default_decor</span>
    <span class="k">def</span> <span class="nf">_add</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; ADDER NOTE: use add_cleanly &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tblname&#39;</span>  <span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
                   <span class="s1">&#39;erotemes&#39;</span> <span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;?&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">)),</span>
                   <span class="s1">&#39;params&#39;</span>   <span class="p">:</span> <span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colnames</span><span class="p">),</span> <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        INSERT INTO {tblname}(</span>
<span class="s1">        rowid,</span>
<span class="s1">        {params}</span>
<span class="s1">        ) VALUES (NULL, {erotemes})</span>
<span class="s1">        &#39;&#39;&#39;</span>
        <span class="n">rowid_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_executemany_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span>
                                                   <span class="n">params_iter</span><span class="o">=</span><span class="n">params_iter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rowid_list</span>

    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.add_cleanly"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.add_cleanly">[docs]</a>    <span class="k">def</span> <span class="nf">add_cleanly</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span>
                    <span class="n">get_rowid_from_superkey</span><span class="p">,</span> <span class="n">superkey_paramx</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ADDER Extra input:</span>
<span class="sd">        the first item of params_iter must be a superkey (like a uuid),</span>

<span class="sd">        Does not add None values. Does not add duplicate values.</span>
<span class="sd">        For each None input returns None ouptut.</span>
<span class="sd">        For each duplicate input returns existing rowid</span>

<span class="sd">        Args:</span>
<span class="sd">            tblname (str): table name to add into</span>

<span class="sd">            colnames (tuple of strs): columns whos values are specified in params_iter</span>

<span class="sd">            params_iter (iterable): an iterable of tuples where each tuple corresonds to a row</span>

<span class="sd">            get_rowid_from_superkey (func): function that tests if a row needs</span>
<span class="sd">                to be added. It should return None for any new rows to be inserted.</span>
<span class="sd">                It should return the existing rowid if one exists</span>

<span class="sd">            superkey_paramx (tuple of ints): indices of tuples in params_iter which</span>
<span class="sd">                correspond to superkeys. defaults to (0,)</span>

<span class="sd">        Returns:</span>
<span class="sd">            iterable: rowid_list_ -- list of newly added or previously added rowids</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.control.SQLDatabaseControl import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; db = &#39;?&#39;</span>
<span class="sd">            &gt;&gt;&gt; tblname = tblname_temp</span>
<span class="sd">            &gt;&gt;&gt; colnames = dst_list</span>
<span class="sd">            &gt;&gt;&gt; params_iter = data_list</span>
<span class="sd">            &gt;&gt;&gt; #get_rowid_from_superkey = &#39;?&#39;</span>
<span class="sd">            &gt;&gt;&gt; superkey_paramx = (0,)</span>
<span class="sd">            &gt;&gt;&gt; rowid_list_ = add_cleanly(db, tblname, colnames, params_iter, get_rowid_from_superkey, superkey_paramx)</span>
<span class="sd">            &gt;&gt;&gt; print(rowid_list_)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ADD_CLEANLY_1: PREPROCESS INPUT</span>
        <span class="n">params_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params_iter</span><span class="p">)</span>  <span class="c1"># eagerly evaluate for superkeys</span>
        <span class="c1"># Extract superkeys from the params list (requires eager eval)</span>
        <span class="n">superkey_lists</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">params</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                           <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">superkey_paramx</span><span class="p">]</span>
        <span class="c1"># ADD_CLEANLY_2: PREFORM INPUT CHECKS</span>
        <span class="c1"># check which parameters are valid</span>
        <span class="c1">#and not any(ut.flag_None_items(params))</span>
        <span class="n">isvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">]</span>
        <span class="c1"># Check for duplicate inputs</span>
        <span class="n">isunique_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_unique_items</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">superkey_lists</span><span class="p">)))</span>
        <span class="c1"># Check to see if this already exists in the database</span>
        <span class="c1">#superkey_params_iter = list(zip(*superkey_lists))</span>
        <span class="c1"># get_rowid_from_superkey functions take each list separately here</span>
        <span class="n">rowid_list_</span> <span class="o">=</span> <span class="n">get_rowid_from_superkey</span><span class="p">(</span><span class="o">*</span><span class="n">superkey_lists</span><span class="p">)</span>
        <span class="n">isnew_list</span>  <span class="o">=</span> <span class="p">[</span><span class="n">rowid</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">rowid</span> <span class="ow">in</span> <span class="n">rowid_list_</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">isunique_list</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[WARNING]: duplicate inputs to db.add_cleanly&#39;</span><span class="p">)</span>
        <span class="c1"># Flag each item that needs to added to the database</span>
        <span class="n">needsadd_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">all</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">isvalid_list</span><span class="p">,</span> <span class="n">isunique_list</span><span class="p">,</span> <span class="n">isnew_list</span><span class="p">)))</span>
        <span class="c1"># ADD_CLEANLY_3.1: EXIT IF CLEAN</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">needsadd_list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rowid_list_</span>  <span class="c1"># There is nothing to add. Return the rowids</span>
        <span class="c1"># ADD_CLEANLY_3.2: PERFORM DIRTY ADDITIONS</span>
        <span class="n">dirty_params</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">params_list</span><span class="p">,</span> <span class="n">needsadd_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] adding </span><span class="si">%r</span><span class="s1">/</span><span class="si">%r</span><span class="s1"> new </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dirty_params</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_list</span><span class="p">),</span> <span class="n">tblname</span><span class="p">))</span>
        <span class="c1"># Add any unadded parameters to the database</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">dirty_params</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_list</span><span class="p">)</span>  <span class="c1"># NOQA</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">key_list</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;dirty_params&#39;</span><span class="p">,</span>
                <span class="s1">&#39;needsadd_list&#39;</span><span class="p">,</span>
                <span class="s1">&#39;superkey_lists&#39;</span><span class="p">,</span>
                <span class="s1">&#39;nInput&#39;</span><span class="p">,</span>
                <span class="s1">&#39;rowid_list_&#39;</span><span class="p">])</span>
            <span class="k">raise</span>
        <span class="c1"># TODO: We should only have to preform a subset of adds here</span>
        <span class="c1"># (at the positions where rowid_list was None in the getter check)</span>
        <span class="n">rowid_list</span> <span class="o">=</span> <span class="n">get_rowid_from_superkey</span><span class="p">(</span><span class="o">*</span><span class="n">superkey_lists</span><span class="p">)</span>

        <span class="c1"># ADD_CLEANLY_4: SANITY CHECK AND RETURN</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_list</span><span class="p">),</span> <span class="s1">&#39;failed sanity check&#39;</span>
        <span class="k">return</span> <span class="n">rowid_list</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_where2"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_where2">[docs]</a>    <span class="k">def</span> <span class="nf">get_where2</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">andwhere_colnames</span><span class="p">,</span>
                   <span class="n">orwhere_colnames</span><span class="o">=</span><span class="p">[],</span>
                   <span class="n">unpack_scalars</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; hacked in function for nicer templates &quot;&quot;&quot;</span>
        <span class="n">andwhere_clauses</span> <span class="o">=</span> <span class="p">[</span><span class="n">colname</span> <span class="o">+</span> <span class="s1">&#39;=?&#39;</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">andwhere_colnames</span><span class="p">]</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">andwhere_clauses</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span><span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span>
                            <span class="n">unpack_scalars</span><span class="o">=</span><span class="n">unpack_scalars</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_where3"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_where3">[docs]</a>    <span class="k">def</span> <span class="nf">get_where3</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">where_colnames</span><span class="p">,</span>
                   <span class="n">unpack_scalars</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">logicop</span><span class="o">=</span><span class="s1">&#39;AND&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; hacked in function for nicer templates</span>

<span class="sd">        unpack_scalars = True</span>
<span class="sd">        kwargs = {}</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            verbose:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">andwhere_clauses</span> <span class="o">=</span> <span class="p">[</span><span class="n">colname</span> <span class="o">+</span> <span class="s1">&#39;=?&#39;</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">where_colnames</span><span class="p">]</span>
        <span class="n">logicop_</span> <span class="o">=</span> <span class="s1">&#39; </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">logicop</span><span class="p">,)</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="n">logicop_</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">andwhere_clauses</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span><span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span>
                            <span class="n">unpack_scalars</span><span class="o">=</span><span class="n">unpack_scalars</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_where"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_where">[docs]</a>    <span class="k">def</span> <span class="nf">get_where</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span>
                  <span class="n">unpack_scalars</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s1">&#39;colnames must be a tuple&#39;</span>
        <span class="c1">#if isinstance(colnames, six.string_types):</span>
        <span class="c1">#    colnames = (colnames,)</span>
        <span class="k">if</span> <span class="n">where_clause</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tblname&#39;</span>  <span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
                       <span class="s1">&#39;colnames&#39;</span> <span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colnames</span><span class="p">),</span> <span class="p">}</span>
            <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            SELECT {colnames}</span>
<span class="s1">            FROM {tblname}</span>
<span class="s1">            &#39;&#39;&#39;</span>
            <span class="n">val_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_executeone_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;tblname&#39;</span>     <span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
                        <span class="s1">&#39;colnames&#39;</span>    <span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colnames</span><span class="p">),</span>
                        <span class="s1">&#39;where_clauses&#39;</span> <span class="p">:</span>  <span class="n">where_clause</span><span class="p">,</span> <span class="p">}</span>
            <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            SELECT {colnames}</span>
<span class="s1">            FROM {tblname}</span>
<span class="s1">            WHERE {where_clauses}</span>
<span class="s1">            &#39;&#39;&#39;</span>
            <span class="n">val_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_executemany_operation_fmt</span><span class="p">(</span>
                <span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="n">params_iter</span><span class="o">=</span><span class="n">params_iter</span><span class="p">,</span>
                <span class="n">unpack_scalars</span><span class="o">=</span><span class="n">unpack_scalars</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val_list</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_rowid_from_superkey"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_rowid_from_superkey">[docs]</a>    <span class="k">def</span> <span class="nf">get_rowid_from_superkey</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">params_iter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                <span class="n">superkey_colnames</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; getter which uses the constrained superkeys instead of rowids &quot;&quot;&quot;</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">colname</span> <span class="o">+</span> <span class="s1">&#39;=?&#39;</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">superkey_colnames</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span><span class="n">tblname</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;rowid&#39;</span><span class="p">,),</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">id_iter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; getter</span>

<span class="sd">        Args:</span>
<span class="sd">            tblname (str): table name to get from</span>
<span class="sd">            colnames (tuple of str): column names to grab from</span>
<span class="sd">            id_iter (iterable): iterable of search keys</span>
<span class="sd">            id_colname (str): column to be used as the search key (default: rowid)</span>
<span class="sd">            eager (bool): use eager evaluation</span>
<span class="sd">            unpack_scalars (bool): default True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql]&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_caller_name</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39; db.get(</span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">, ...)&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,))</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s1">&#39;must specify column names to get from&#39;</span>
        <span class="c1">#if isinstance(colnames, six.string_types):</span>
        <span class="c1">#    colnames = (colnames,)</span>
        <span class="k">if</span> <span class="n">id_iter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">where_clause</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">params_iter</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">where_clause</span> <span class="o">=</span> <span class="p">(</span><span class="n">id_colname</span> <span class="o">+</span> <span class="s1">&#39;=?&#39;</span><span class="p">)</span>
            <span class="n">params_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">_rowid</span><span class="p">,)</span> <span class="k">for</span> <span class="n">_rowid</span> <span class="ow">in</span> <span class="n">id_iter</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span><span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.set"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">val_iter</span><span class="p">,</span> <span class="n">id_iter</span><span class="p">,</span> <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span><span class="p">,</span>
            <span class="n">duplicate_behavior</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setter</span>

<span class="sd">        TODO: Test</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
        <span class="c1">#if isinstance(colnames, six.string_types):</span>
        <span class="c1">#    colnames = (colnames,)</span>
        <span class="n">val_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">val_iter</span><span class="p">)</span>  <span class="c1"># eager evaluation</span>
        <span class="n">id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">id_iter</span><span class="p">)</span>  <span class="c1"># eager evaluation</span>

        <span class="k">if</span> <span class="n">VERBOSE_SQL</span> <span class="ow">or</span> <span class="p">(</span><span class="n">NOT_QUIET</span> <span class="ow">and</span> <span class="n">VERYVERBOSE</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] SETTER: &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_caller_name</span><span class="p">())</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] * tblname=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tblname</span><span class="p">,))</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] * val_list=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">val_list</span><span class="p">,))</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] * id_list=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">id_list</span><span class="p">,))</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] * id_colname=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">id_colname</span><span class="p">,))</span>

        <span class="k">if</span> <span class="n">duplicate_behavior</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">duplicates_exist</span><span class="p">(</span><span class="n">id_list</span><span class="p">),</span> <span class="s2">&quot;Passing a not-unique list of ids&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">id_list</span><span class="p">)</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;len(id_list) = </span><span class="si">%r</span><span class="s1">, len(set(id_list)) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">id_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">id_list</span><span class="p">))))</span>
                <span class="k">raise</span>
        <span class="k">elif</span> <span class="n">duplicate_behavior</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span><span class="p">:</span>
            <span class="c1"># Keep only the first setting of every row</span>
            <span class="n">isunique_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_unique_items</span><span class="p">(</span><span class="n">id_list</span><span class="p">)</span>
            <span class="n">id_list</span>  <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">id_list</span><span class="p">,</span> <span class="n">isunique_list</span><span class="p">)</span>
            <span class="n">val_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">val_list</span><span class="p">,</span> <span class="n">isunique_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;unknown duplicate_behavior=</span><span class="si">%r</span><span class="s1">. &#39;</span>
                 <span class="s1">&#39;known behaviors are: error and filter&#39;</span><span class="p">)</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">duplicate_behavior</span><span class="p">,))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_list</span><span class="p">)</span>
            <span class="n">num_id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">id_list</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">num_val</span> <span class="o">==</span> <span class="n">num_id</span><span class="p">,</span> <span class="s1">&#39;list inputs have different lengths&#39;</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">key_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;num_val&#39;</span><span class="p">,</span> <span class="s1">&#39;num_id&#39;</span><span class="p">])</span>
            <span class="k">raise</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tblname_str&#39;</span>  <span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
            <span class="s1">&#39;assign_str&#39;</span>   <span class="p">:</span> <span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=?&#39;</span> <span class="o">%</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">]),</span>
            <span class="s1">&#39;where_clause&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">id_colname</span> <span class="o">+</span> <span class="s1">&#39;=?&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            UPDATE {tblname_str}</span>
<span class="s1">            SET {assign_str}</span>
<span class="s1">            WHERE {where_clause}</span>
<span class="s1">            &#39;&#39;&#39;</span>

        <span class="c1"># TODO: The flattenize can be removed if we pass in val_lists instead</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flattenize</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">val_list</span><span class="p">,</span> <span class="n">id_list</span><span class="p">)))</span>
        <span class="c1">#params_iter = list(zip(val_list, id_list))</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">_executemany_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span>
                                             <span class="n">params_iter</span><span class="o">=</span><span class="n">params_iter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.delete"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">id_list</span><span class="p">,</span> <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; deleter. USE delete_rowids instead &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tblname&#39;</span>   <span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
            <span class="s1">&#39;rowid_str&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">id_colname</span> <span class="o">+</span> <span class="s1">&#39;=?&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            DELETE</span>
<span class="s1">            FROM {tblname}</span>
<span class="s1">            WHERE {rowid_str}</span>
<span class="s1">            &#39;&#39;&#39;</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">_rowid</span><span class="p">,)</span> <span class="k">for</span> <span class="n">_rowid</span> <span class="ow">in</span> <span class="n">id_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">_executemany_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span>
                                             <span class="n">params_iter</span><span class="o">=</span><span class="n">params_iter</span><span class="p">,</span>
                                             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.delete_rowids"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.delete_rowids">[docs]</a>    <span class="k">def</span> <span class="nf">delete_rowids</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">rowid_list</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; deletes the the rows in rowid_list &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tblname&#39;</span>   <span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
            <span class="s1">&#39;rowid_str&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;rowid=?&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            DELETE</span>
<span class="s1">            FROM {tblname}</span>
<span class="s1">            WHERE {rowid_str}</span>
<span class="s1">            &#39;&#39;&#39;</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">_rowid</span><span class="p">,)</span> <span class="k">for</span> <span class="n">_rowid</span> <span class="ow">in</span> <span class="n">rowid_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">_executemany_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span>
                                             <span class="n">params_iter</span><span class="o">=</span><span class="n">params_iter</span><span class="p">,</span>
                                             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1">#==============</span>
    <span class="c1"># CORE WRAPPERS</span>
    <span class="c1">#==============</span>
</div>
    <span class="nd">@default_decor</span>
    <span class="k">def</span> <span class="nf">_executeone_operation_fmt</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">operation_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtdict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">auto_commit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@default_decor</span>
    <span class="k">def</span> <span class="nf">_executemany_operation_fmt</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span>
                                   <span class="n">unpack_scalars</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">operation_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtdict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">unpack_scalars</span><span class="o">=</span><span class="n">unpack_scalars</span><span class="p">,</span>
                              <span class="n">auto_commit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1">#=========</span>
    <span class="c1"># SQLDB CORE</span>
    <span class="c1">#=========</span>

    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.executeone"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.executeone">[docs]</a>    <span class="k">def</span> <span class="nf">executeone</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">(),</span> <span class="n">auto_commit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                   <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE_SQL</span><span class="p">):</span>
        <span class="n">contextkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">nInput</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">SQLExecutionContext</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="o">**</span><span class="n">contextkw</span><span class="p">)</span> <span class="k">as</span> <span class="n">context</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result_iter</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">execute_and_generate_results</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="n">result_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result_iter</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">key_list</span><span class="o">=</span><span class="p">[(</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;operation&#39;</span><span class="p">),</span> <span class="s1">&#39;params&#39;</span><span class="p">])</span>
                <span class="c1"># ut.sys.exit(1)</span>
                <span class="k">raise</span>
        <span class="k">return</span> <span class="n">result_list</span>

    <span class="c1">#@ut.memprof</span></div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.executemany"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.executemany">[docs]</a>    <span class="k">def</span> <span class="nf">executemany</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">auto_commit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE_SQL</span><span class="p">,</span> <span class="n">unpack_scalars</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c1"># --- ARGS PREPROC ---</span>
        <span class="c1"># Aggresively compute iterator if the nInput is not given</span>
        <span class="k">if</span> <span class="n">nInput</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params_iter</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_iter</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql!] WARNING: aggressive eval of params_iter because nInput=None&#39;</span><span class="p">)</span>
                <span class="n">params_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params_iter</span><span class="p">)</span>
                <span class="n">nInput</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_iter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] Taking params_iter as iterator&#39;</span><span class="p">)</span>

        <span class="c1"># Do not compute executemany without params</span>
        <span class="k">if</span> <span class="n">nInput</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql!] WARNING: dont use executemany&#39;</span>
                      <span class="s1">&#39;with no params use executeone instead.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="c1"># --- SQL EXECUTION ---</span>
        <span class="n">contextkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;nInput&#39;</span><span class="p">:</span> <span class="n">nInput</span><span class="p">,</span>
            <span class="s1">&#39;start_transaction&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="n">verbose</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">with</span> <span class="n">SQLExecutionContext</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="o">**</span><span class="n">contextkw</span><span class="p">)</span> <span class="k">as</span> <span class="n">context</span><span class="p">:</span>
            <span class="c1">#try:</span>
            <span class="k">if</span> <span class="n">eager</span><span class="p">:</span>
                <span class="c1">#if ut.DEBUG2:</span>
                <span class="c1">#    print(&#39;--------------&#39;)</span>
                <span class="c1">#    print(&#39;+++ eager eval&#39;)</span>
                <span class="c1">#    print(operation)</span>
                <span class="c1">#    print(&#39;+++ eager eval&#39;)</span>
                <span class="c1">#results_iter = list(</span>
                    <span class="c1">#map(</span>
                    <span class="c1">#    list,</span>
                    <span class="c1">#    (context.execute_and_generate_results(params) for params in params_iter)</span>
                    <span class="c1">#)</span>
                <span class="c1">#)  # list of iterators</span>
                <span class="n">results_iter</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">execute_and_generate_results</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_iter</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">unpack_scalars</span><span class="p">:</span>
                    <span class="n">results_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_unpacker</span><span class="p">,</span> <span class="n">results_iter</span><span class="p">))</span>  <span class="c1"># list of iterators</span>
                    <span class="c1">#try:</span>
                    <span class="c1">#    results_iter = [_unpacker(results_) for resultx,</span>
                    <span class="c1">#    results_ in enumerate(results_iter)]</span>
                    <span class="c1">#except AssertionError:</span>
                    <span class="c1">#    print(&#39;resultx = %r&#39; % (resultx,))</span>
                    <span class="c1">#    if isinstance(params_iter, list):</span>
                    <span class="c1">#        print(&#39;params = %r&#39; % (params_iter[resultx]))</span>
                    <span class="c1">#    raise</span>
                <span class="n">results_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results_iter</span><span class="p">)</span>  <span class="c1"># Eager evaluation</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#if ut.DEBUG2:</span>
                <span class="c1">#    print(&#39;--------------&#39;)</span>
                <span class="c1">#    print(&#39; +++ lazy eval&#39;)</span>
                <span class="c1">#    print(operation)</span>
                <span class="c1">#    print(&#39; +++ lazy eval&#39;)</span>
                <span class="k">def</span> <span class="nf">tmpgen</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
                    <span class="c1"># Temporary hack to turn off eager_evaluation</span>
                    <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_iter</span><span class="p">:</span>
                        <span class="c1"># Eval results per query yeild per iter</span>
                        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">execute_and_generate_results</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">unpack_scalars</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">_unpacker</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">results</span>
                <span class="n">results_list</span> <span class="o">=</span> <span class="n">tmpgen</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="c1">#except Exception as ex:</span>
            <span class="c1">#    ut.printex(ex)</span>
            <span class="c1">#    raise</span>
        <span class="k">return</span> <span class="n">results_list</span>

    <span class="c1">#def commit(db):</span>
    <span class="c1">#    db.connection.commit()</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.dump"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">file_</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file_</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">dump_fpath</span> <span class="o">=</span> <span class="n">file_</span>
            <span class="k">if</span> <span class="n">dump_fpath</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># Default filepath</span>
                <span class="n">version_str</span> <span class="o">=</span> <span class="s1">&#39;v&#39;</span> <span class="o">+</span> <span class="n">db</span><span class="o">.</span><span class="n">get_db_version</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema_only&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                    <span class="n">version_str</span> <span class="o">+=</span> <span class="s1">&#39;.schema_only&#39;</span>
                <span class="n">dump_fname</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">version_str</span> <span class="o">+</span>  <span class="s1">&#39;.dump.txt&#39;</span>
                <span class="n">dump_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">dir_</span><span class="p">,</span> <span class="n">dump_fname</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dump_fpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">dump_to_file</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">dump_to_file</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.dump_to_string"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.dump_to_string">[docs]</a>    <span class="k">def</span> <span class="nf">dump_to_string</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">string_file</span> <span class="o">=</span> <span class="n">cStringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">dump_to_file</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="n">string_file</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">retstr</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.dump_to_file"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.dump_to_file">[docs]</a>    <span class="k">def</span> <span class="nf">dump_to_file</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">file_</span><span class="p">,</span> <span class="n">auto_commit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">schema_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_metadata</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">VERBOSE_SQL</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql.dump_to_file] file_=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">file_</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">auto_commit</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="c1">#db.commit(verbose=False)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">iterdump</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">schema_only</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;INSERT&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">include_metadata</span> <span class="ow">or</span> <span class="s1">&#39;metadata&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SQLDatabaseController.dump_to_stdout"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.dump_to_stdout">[docs]</a>    <span class="k">def</span> <span class="nf">dump_to_stdout</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="n">file_</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;schema_only&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema_only&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SQLDatabaseController.print_dbg_schema"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.print_dbg_schema">[docs]</a>    <span class="k">def</span> <span class="nf">print_dbg_schema</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">CREATE&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">dump_to_string</span><span class="p">(</span><span class="n">schema_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;CREATE&#39;</span><span class="p">)))</span>

    <span class="c1">#=========</span>
    <span class="c1"># SQLDB METADATA</span>
    <span class="c1">#=========</span></div>
<div class="viewcode-block" id="SQLDatabaseController.get_metadata_items"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_metadata_items">[docs]</a>    <span class="k">def</span> <span class="nf">get_metadata_items</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            list: metadata_items</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --exec-get_metadata_items --db=PZ_Master0</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --exec-get_metadata_items --db=testdb1</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --exec-get_metadata_items</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.control.SQLDatabaseControl import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; db = ibeis.opendb(defaultdb=&#39;testdb1&#39;).db</span>
<span class="sd">            &gt;&gt;&gt; metadata_items = db.get_metadata_items()</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;metadata_items = %s&#39; % (ut.list_str(sorted(metadata_items)),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metadata_rowids</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_all_rowids</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">)</span>
        <span class="n">metadata_items</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span>
                                <span class="p">(</span><span class="s1">&#39;metadata_key&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata_value&#39;</span><span class="p">),</span>
                                <span class="n">metadata_rowids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">metadata_items</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.set_metadata_val"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.set_metadata_val">[docs]</a>    <span class="k">def</span> <span class="nf">set_metadata_val</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        key must be given as a repr-ed string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tablename&#39;</span><span class="p">:</span> <span class="n">const</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span>
            <span class="s1">&#39;columns&#39;</span><span class="p">:</span> <span class="s1">&#39;metadata_key, metadata_value&#39;</span>
        <span class="p">}</span>
        <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s1">&#39;INSERT OR REPLACE INTO {tablename} ({columns}) VALUES (?, ?)&#39;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">]</span>
        <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
    <span class="c1">#def get_metadata_val(db, key, eval_=False, default=ut.NoParam):</span>
<div class="viewcode-block" id="SQLDatabaseController.get_metadata_val"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_metadata_val">[docs]</a>    <span class="k">def</span> <span class="nf">get_metadata_val</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">eval_</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        val is the repr string unless eval_ is true</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="s1">&#39;metadata_key=?&#39;</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;metadata_value&#39;</span><span class="p">,)</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,)]</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;duplicate keys in metadata table&#39;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default</span> <span class="o">==</span> <span class="n">ut</span><span class="o">.</span><span class="n">NoParam</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;metadata_table key=</span><span class="si">%r</span><span class="s1"> does not exist&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">default</span>
        <span class="c1">#if key.endswith(&#39;_constraint&#39;) or</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_docstr&#39;</span><span class="p">):</span>
            <span class="c1"># Hack eval off for constriant and docstr</span>
            <span class="k">return</span> <span class="n">val</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">eval_</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># eventually we will not have to worry about</span>
                <span class="c1"># mid level representations by default, for now flag it</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">])</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="c1">#==============</span>
    <span class="c1"># SCHEMA MODIFICATION</span>
    <span class="c1">#==============</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.add_column"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.add_column">[docs]</a>    <span class="k">def</span> <span class="nf">add_column</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">coltype</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] add column=</span><span class="si">%r</span><span class="s1"> of type=</span><span class="si">%r</span><span class="s1"> to tablename=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">coltype</span><span class="p">,</span> <span class="n">tablename</span><span class="p">))</span>
        <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tablename&#39;</span><span class="p">:</span> <span class="n">tablename</span><span class="p">,</span>
            <span class="s1">&#39;colname&#39;</span><span class="p">:</span> <span class="n">colname</span><span class="p">,</span>
            <span class="s1">&#39;coltype&#39;</span><span class="p">:</span> <span class="n">coltype</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s1">&#39;ALTER TABLE {tablename} ADD COLUMN {colname} {coltype}&#39;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.add_table"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.add_table">[docs]</a>    <span class="k">def</span> <span class="nf">add_table</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">coldef_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata_keyval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add_table</span>

<span class="sd">        Args:</span>
<span class="sd">            tablename (str):</span>
<span class="sd">            coldef_list (list):</span>
<span class="sd">            constraint (list or None):</span>
<span class="sd">            docstr (str):</span>
<span class="sd">            superkeys (list or None): list of tuples of column names which</span>
<span class="sd">                uniquely identifies a rowid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bad_kwargs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">metadata_keyval</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">table_metadata_keys</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;keyword args specified that are not metadata keys=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">bad_kwargs</span><span class="p">,)</span>
        <span class="k">assert</span> <span class="n">tablename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;tablename must be given&#39;</span>
        <span class="k">assert</span> <span class="n">coldef_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;tablename must be given&#39;</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">DEBUG2</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] schema ensuring tablename=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tablename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">tablename</span><span class="p">,</span> <span class="n">coldef_list</span><span class="p">]</span>
            <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">func_str</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">,</span> <span class="n">_args</span><span class="p">,</span> <span class="n">metadata_keyval</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># Technically insecure call, but all entries are statically inputted by</span>
        <span class="c1"># the database&#39;s owner, who could delete or alter the entire database</span>
        <span class="c1"># anyway.</span>
        <span class="n">constraint_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">superkeys</span> <span class="o">=</span> <span class="n">metadata_keyval</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;superkeys&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">has_superkeys</span> <span class="o">=</span> <span class="p">(</span><span class="n">superkeys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                             <span class="nb">len</span><span class="p">(</span><span class="n">superkeys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_superkeys</span><span class="p">:</span>
                <span class="c1"># Add in superkeys to constraints</span>
                <span class="c1">#SELECT image_rowid</span>
                <span class="c1">#FROM encounter_image_relationship</span>
                <span class="c1">#WHERE image_rowid=? AND encounter_rowid=?</span>
                <span class="n">constraint_fmtstr</span> <span class="o">=</span> <span class="s1">&#39;CONSTRAINT superkey UNIQUE ({colnames_str})&#39;</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">superkeys</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="p">(</span>
                    <span class="s1">&#39;must be list got </span><span class="si">%r</span><span class="s1">, superkeys=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">superkeys</span><span class="p">),</span> <span class="n">superkeys</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">superkey_colnames</span> <span class="ow">in</span> <span class="n">superkeys</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">superkey_colnames</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="p">(</span>
                        <span class="s1">&#39;must be list of tuples got list of </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">superkey_colnames</span><span class="p">,)))</span>
                    <span class="n">colnames_str</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">superkey_colnames</span><span class="p">)</span>
                    <span class="n">unique_constraint</span> <span class="o">=</span> <span class="n">constraint_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">colnames_str</span><span class="o">=</span><span class="n">colnames_str</span><span class="p">)</span>
                    <span class="n">constraint_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unique_constraint</span><span class="p">)</span>
                <span class="n">constraint_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique_keep_order</span><span class="p">(</span><span class="n">constraint_list</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span>

        <span class="c1"># ASSERT VALID TYPES</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">type_</span> <span class="ow">in</span> <span class="n">coldef_list</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span>  <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>  <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
                <span class="s1">&#39;cannot have empty name. name=</span><span class="si">%r</span><span class="s1">, type_=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">type_</span><span class="p">))</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
                <span class="s1">&#39;cannot have empty type. name=</span><span class="si">%r</span><span class="s1">, type_=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">type_</span><span class="p">))</span>

        <span class="n">body_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">coldef_list</span><span class="p">]</span>

        <span class="n">table_body</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">body_list</span> <span class="o">+</span> <span class="n">constraint_list</span><span class="p">)</span>
        <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;table_body&#39;</span><span class="p">:</span> <span class="n">table_body</span><span class="p">,</span>
            <span class="s1">&#39;tablename&#39;</span><span class="p">:</span> <span class="n">tablename</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s1">&#39;CREATE TABLE IF NOT EXISTS {tablename} ({table_body})&#39;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c1"># Handle table metdata</span>
        <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">table_metadata_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">metadata_keyval</span> <span class="ow">and</span> <span class="n">metadata_keyval</span><span class="p">[</span><span class="n">suffix</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">metadata_keyval</span><span class="p">[</span><span class="n">suffix</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;docstr&#39;</span><span class="p">]:</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">set_metadata_val</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">set_metadata_val</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.modify_table"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.modify_table">[docs]</a>    <span class="k">def</span> <span class="nf">modify_table</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">colmap_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tablename_new</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="c1">#constraint=None, docstr=None, superkeys=None,</span>
                     <span class="o">**</span><span class="n">metadata_keyval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        function to modify the schema - only columns that are being added,</span>
<span class="sd">        removed or changed need to be enumerated</span>

<span class="sd">        Args:</span>
<span class="sd">           tablename (str): tablename</span>
<span class="sd">           colmap_list (list): of tuples (orig_colname, new_colname, new_coltype, convert_func)</span>
<span class="sd">               orig_colname - the original name of the column, None to append, int for index</span>
<span class="sd">               new_colname - the new column name (&#39;&#39; for same, None to delete)</span>
<span class="sd">               new_coltype - New Column Type. None to use data unmodified</span>
<span class="sd">               convert_func - Function to convert data from old to new</span>
<span class="sd">           constraint (str):</span>
<span class="sd">           superkeys (list)</span>
<span class="sd">           docstr (str)</span>
<span class="sd">           tablename_new (?)</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; def loc_zip_map(x):</span>
<span class="sd">            ...     return x</span>
<span class="sd">            &gt;&gt;&gt; db.modify_table(const.CONTRIBUTOR_TABLE, (</span>
<span class="sd">            &gt;&gt;&gt;         # orig_colname,             new_colname,      new_coltype, convert_func</span>
<span class="sd">            &gt;&gt;&gt;         # a non-needed, but correct mapping (identity function)</span>
<span class="sd">            &gt;&gt;&gt;         (&#39;contrib_rowid&#39;,      &#39;&#39;,                    &#39;&#39;,               None),</span>
<span class="sd">            &gt;&gt;&gt;         # for new columns, function is ignored (TYPE CANNOT BE EMPTY IF ADDING)</span>
<span class="sd">            &gt;&gt;&gt;         (None,                 &#39;contrib_loc_address&#39;, &#39;TEXT&#39;,           None),</span>
<span class="sd">            &gt;&gt;&gt;         # adding a new column at index 4 (if index is invalid, None is used)</span>
<span class="sd">            &gt;&gt;&gt;         (4,                    &#39;contrib_loc_address&#39;, &#39;TEXT&#39;,           None),</span>
<span class="sd">            &gt;&gt;&gt;         # for deleted columns, type and function are ignored</span>
<span class="sd">            &gt;&gt;&gt;         (&#39;contrib_loc_city&#39;,    None,                 &#39;&#39;,               None),</span>
<span class="sd">            &gt;&gt;&gt;         # for renamed columns, type and function are ignored</span>
<span class="sd">            &gt;&gt;&gt;         (&#39;contrib_loc_city&#39;,   &#39;contrib_loc_town&#39;,    &#39;&#39;,       None),</span>
<span class="sd">            &gt;&gt;&gt;         (&#39;contrib_loc_zip&#39;,    &#39;contrib_loc_zip&#39;,     &#39;TEXT&#39;,   loc_zip_map),</span>
<span class="sd">            &gt;&gt;&gt;         # type not changing, only NOT NULL provision</span>
<span class="sd">            &gt;&gt;&gt;         (&#39;contrib_loc_country&#39;, &#39;&#39;,                   &#39;TEXT NOT NULL&#39;,  None),</span>
<span class="sd">            &gt;&gt;&gt;     ),</span>
<span class="sd">            &gt;&gt;&gt;     superkeys=[(&#39;contributor_rowid&#39;,)],</span>
<span class="sd">            &gt;&gt;&gt;     constraint=[],</span>
<span class="sd">            &gt;&gt;&gt;     docstr=&#39;Used to store the contributors to the project&#39;</span>
<span class="sd">            &gt;&gt;&gt; )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#assert colmap_list is not None, &#39;must specify colmaplist&#39;</span>
        <span class="k">assert</span> <span class="n">tablename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;tablename must be given&#39;</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] schema modifying tablename=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tablename</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] * colmap_list = &#39;</span> <span class="o">+</span> <span class="s1">&#39;None&#39;</span> <span class="k">if</span> <span class="n">colmap_list</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span>
                  <span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">colmap_list</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">colmap_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">colmap_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">colname_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">colname_original_list</span> <span class="o">=</span> <span class="n">colname_list</span><span class="p">[:]</span>
        <span class="n">coltype_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_types</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">colname_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">colname</span><span class="p">:</span> <span class="n">colname</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">colname_list</span><span class="p">}</span>
        <span class="n">colmap_dict</span>  <span class="o">=</span> <span class="p">{}</span>

        <span class="n">insert</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">map_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">colmap_list</span><span class="p">:</span>
            <span class="c1">#is_newcol = dst not in colname_list</span>
            <span class="c1">#if dst == &#39;contributor_rowid&#39;:</span>
            <span class="c1">#    ut.embed()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
                <span class="c1"># Add column</span>
                <span class="k">assert</span> <span class="n">dst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
                    <span class="s2">&quot;New column&#39;s name must be valid&quot;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">type_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
                    <span class="s2">&quot;New column&#39;s type must be specified&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">src</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">colname_list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">src</span><span class="p">):</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">src</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">colname_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
                    <span class="n">coltype_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">insert</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] WARNING: multiple index inserted add columns&#39;</span>
                              <span class="s1">&#39;, may cause allignment issues&#39;</span><span class="p">)</span>
                    <span class="n">colname_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
                    <span class="n">coltype_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>
                    <span class="n">insert</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">colname_list</span><span class="p">,</span> <span class="p">(</span>
                        <span class="s1">&#39;Unkown source colname=</span><span class="si">%s</span><span class="s1"> in tablename=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">src</span><span class="p">,</span> <span class="n">tablename</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;colname_list&#39;</span><span class="p">])</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">colname_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dst</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1"># Drop column</span>
                    <span class="k">assert</span> <span class="n">src</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
                        <span class="s2">&quot;Deleted column&#39;s name  must be valid&quot;</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">colname_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">colname_dict</span><span class="p">[</span><span class="n">src</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">src</span> <span class="o">!=</span> <span class="n">dst</span><span class="p">):</span>
                    <span class="c1"># Rename column</span>
                    <span class="n">colname_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">dst</span>
                    <span class="n">colname_dict</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">=</span> <span class="n">dst</span>
                    <span class="c1"># Check if type should change as well</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">type_</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">type_</span> <span class="o">!=</span> <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]):</span>
                        <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">type_</span> <span class="o">!=</span> <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                    <span class="c1"># Change column type</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dst</span> <span class="o">=</span> <span class="n">src</span>
                    <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_</span>
                <span class="k">elif</span> <span class="n">map_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1"># Simply map function across table&#39;s data</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dst</span> <span class="o">=</span> <span class="n">src</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">type_</span> <span class="o">=</span> <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Identity, this can be ommited as it is automatically done</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dst</span> <span class="o">=</span> <span class="n">src</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">type_</span> <span class="o">=</span> <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">map_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">colmap_dict</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_</span>

        <span class="n">coldef_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">colname_list</span><span class="p">,</span> <span class="n">coltype_list</span><span class="p">))</span>
        <span class="n">tablename_orig</span> <span class="o">=</span> <span class="n">tablename</span>
        <span class="n">tablename_temp</span> <span class="o">=</span> <span class="n">tablename_orig</span> <span class="o">+</span> <span class="s1">&#39;_temp&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">random_nonce</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">metadata_keyval2</span> <span class="o">=</span> <span class="n">metadata_keyval</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">table_metadata_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata_keyval2</span> <span class="ow">or</span> <span class="n">metadata_keyval2</span><span class="p">[</span><span class="n">suffix</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_metadata_val</span><span class="p">(</span><span class="n">tablename_orig</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">eval_</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">metadata_keyval2</span><span class="p">[</span><span class="n">suffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">coldef_list</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata_keyval2</span><span class="p">)</span>

        <span class="c1"># Copy data</span>
        <span class="n">src_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dst_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">colname_original_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">colname_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">src_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">dst_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colname_dict</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data_list_</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">src_list</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_list_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Run functions across all data for specified callums</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">tuple</span><span class="p">([</span>
                <span class="n">colmap_dict</span><span class="p">[</span><span class="n">src_</span><span class="p">](</span><span class="n">d</span><span class="p">)</span> <span class="k">if</span> <span class="n">src_</span> <span class="ow">in</span> <span class="n">colmap_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">d</span>
                <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">src_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">src_list</span><span class="p">)</span>
            <span class="p">])</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list_</span>
        <span class="p">]</span>
        <span class="c1"># Add the data to the database</span>
        <span class="k">def</span> <span class="nf">get_rowid_from_superkey</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add_cleanly</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">dst_list</span><span class="p">,</span> <span class="n">data_list</span><span class="p">,</span> <span class="n">get_rowid_from_superkey</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tablename_new</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># Drop original table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="c1"># Rename temp table to original table name</span>
            <span class="n">db</span><span class="o">.</span><span class="n">rename_table</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Rename new table to new name</span>
            <span class="n">db</span><span class="o">.</span><span class="n">rename_table</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">tablename_new</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.reorder_columns"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.reorder_columns">[docs]</a>    <span class="k">def</span> <span class="nf">reorder_columns</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">order_list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;needs update&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] schema column reordering for tablename=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tablename</span><span class="p">)</span>
        <span class="c1"># Get current tables</span>
        <span class="n">colname_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">coltype_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_types</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">colname_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">coltype_list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">colname_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">order_list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order_list</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colname_list</span><span class="p">))</span> <span class="p">]),</span> <span class="p">(</span>
            <span class="s1">&#39;Order index list invalid&#39;</span><span class="p">)</span>
        <span class="c1"># Reorder column definitions</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">order_list</span><span class="p">,</span> <span class="n">colname_list</span><span class="p">,</span> <span class="n">coltype_list</span><span class="p">)))</span>
        <span class="n">coldef_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type_</span> <span class="ow">in</span> <span class="n">combined</span> <span class="p">]</span>
        <span class="n">tablename_temp</span> <span class="o">=</span> <span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_temp&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">random_nonce</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">docstr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_docstr</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="c1">#constraint = db.get_table_constraints(tablename)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">coldef_list</span><span class="p">,</span>
                     <span class="c1">#constraint=constraint,</span>
                     <span class="n">docstr</span><span class="o">=</span><span class="n">docstr</span><span class="p">,)</span>
        <span class="c1"># Copy data</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">colname_list</span><span class="p">))</span>
        <span class="c1"># Add the data to the database</span>
        <span class="n">get_rowid_from_superkey</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add_cleanly</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">colname_list</span><span class="p">,</span> <span class="n">data_list</span><span class="p">,</span> <span class="n">get_rowid_from_superkey</span><span class="p">)</span>
        <span class="c1"># Drop original table</span>
        <span class="n">db</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="c1"># Rename temp table to original table name</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rename_table</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.duplicate_table"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.duplicate_table">[docs]</a>    <span class="k">def</span> <span class="nf">duplicate_table</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">tablename_duplicate</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] schema duplicating tablename=</span><span class="si">%r</span><span class="s1"> into tablename=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">tablename_duplicate</span><span class="p">))</span>
        <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="p">[],</span> <span class="n">tablename_new</span><span class="o">=</span><span class="n">tablename_duplicate</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.duplicate_column"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.duplicate_column">[docs]</a>    <span class="k">def</span> <span class="nf">duplicate_column</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">colname_duplicate</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] schema duplicating tablename.colname=</span><span class="si">%r</span><span class="s1">.</span><span class="si">%r</span><span class="s1"> into tablename.colname=</span><span class="si">%r</span><span class="s1">.</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">colname_duplicate</span><span class="p">))</span>
        <span class="c1"># Modify table to add a blank column with the appropriate tablename and NO data</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">column_types</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_types</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_types</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[!sql] could not find colname=</span><span class="si">%r</span><span class="s1"> to duplicate&#39;</span> <span class="o">%</span> <span class="n">colname</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Add column to the table</span>
        <span class="c1"># DATABASE TABLE CACHES ARE UPDATED WITH add_column</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">colname_duplicate</span><span class="p">,</span> <span class="n">column_types</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="c1"># Copy the data from the original column to the new duplcate column</span>
        <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tablename&#39;</span><span class="p">:</span>           <span class="n">tablename</span><span class="p">,</span>
            <span class="s1">&#39;colname_duplicate&#39;</span><span class="p">:</span>   <span class="n">colname_duplicate</span><span class="p">,</span>
            <span class="s1">&#39;colname&#39;</span><span class="p">:</span>             <span class="n">colname</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s1">&#39;UPDATE {tablename} SET {colname_duplicate} = {colname}&#39;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.rename_table"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.rename_table">[docs]</a>    <span class="k">def</span> <span class="nf">rename_table</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename_old</span><span class="p">,</span> <span class="n">tablename_new</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] schema renaming tablename=</span><span class="si">%r</span><span class="s1"> -&gt; </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename_old</span><span class="p">,</span> <span class="n">tablename_new</span><span class="p">))</span>
        <span class="c1"># Technically insecure call, but all entries are statically inputted by</span>
        <span class="c1"># the database&#39;s owner, who could delete or alter the entire database</span>
        <span class="c1"># anyway.</span>
        <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tablename_old&#39;</span><span class="p">:</span> <span class="n">tablename_old</span><span class="p">,</span>
            <span class="s1">&#39;tablename_new&#39;</span><span class="p">:</span> <span class="n">tablename_new</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s1">&#39;ALTER TABLE {tablename_old} RENAME TO {tablename_new}&#39;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c1"># Rename table&#39;s metadata</span>
        <span class="n">key_old_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">tablename_old</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">table_metadata_keys</span><span class="p">]</span>
        <span class="n">key_new_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">tablename_new</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">table_metadata_keys</span><span class="p">]</span>
        <span class="n">id_iter</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_old_list</span><span class="p">]</span>
        <span class="n">val_iter</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_new_list</span><span class="p">]</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;metadata_key&#39;</span><span class="p">,)</span>
        <span class="c1">#print(&#39;Setting metadata_key from %s to %s&#39; % (ut.list_str(id_iter), ut.list_str(val_iter)))</span>
        <span class="c1">#ut.embed()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">val_iter</span><span class="p">,</span> <span class="n">id_iter</span><span class="p">,</span> <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;metadata_key&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.rename_column"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.rename_column">[docs]</a>    <span class="k">def</span> <span class="nf">rename_column</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">colname_old</span><span class="p">,</span> <span class="n">colname_new</span><span class="p">):</span>
        <span class="c1"># DATABASE TABLE CACHES ARE UPDATED WITH modify_table</span>
        <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">colname_old</span><span class="p">,</span> <span class="n">colname_new</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
        <span class="p">))</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.drop_table"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.drop_table">[docs]</a>    <span class="k">def</span> <span class="nf">drop_table</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] schema dropping tablename=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tablename</span><span class="p">)</span>
        <span class="c1"># Technically insecure call, but all entries are statically inputted by</span>
        <span class="c1"># the database&#39;s owner, who could delete or alter the entire database</span>
        <span class="c1"># anyway.</span>
        <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tablename&#39;</span><span class="p">:</span> <span class="n">tablename</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s1">&#39;DROP TABLE IF EXISTS {tablename}&#39;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c1"># Delete table&#39;s metadata</span>
        <span class="n">key_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">table_metadata_keys</span><span class="p">]</span>
        <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span> <span class="n">key_list</span><span class="p">,</span> <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;metadata_key&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.drop_column"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.drop_column">[docs]</a>    <span class="k">def</span> <span class="nf">drop_column</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">colname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; # DATABASE TABLE CACHES ARE UPDATED WITH modify_table &quot;&quot;&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
        <span class="p">))</span>

    <span class="c1">#==============</span>
    <span class="c1"># CONVINENCE</span>
    <span class="c1">#==============</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.dump_tables_to_csv"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.dump_tables_to_csv">[docs]</a>    <span class="k">def</span> <span class="nf">dump_tables_to_csv</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convenience: Dumps all csv database files to disk &quot;&quot;&quot;</span>
        <span class="n">dump_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">dir_</span><span class="p">,</span> <span class="s1">&#39;CSV_DUMP&#39;</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">dump_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">():</span>
            <span class="n">table_fname</span> <span class="o">=</span> <span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span>
            <span class="n">table_csv</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dump_dir</span><span class="p">,</span> <span class="n">table_fname</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_</span><span class="p">:</span>
                <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">table_csv</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_schema_current_autogeneration_str"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_schema_current_autogeneration_str">[docs]</a>    <span class="k">def</span> <span class="nf">get_schema_current_autogeneration_str</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">autogen_cmd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convenience: Autogenerates the most up-to-date database schema</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --exec-get_schema_current_autogeneration_str</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; result = ibs.db.get_schema_current_autogeneration_str(&#39;&#39;)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db_version_current</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_db_version</span><span class="p">()</span>
        <span class="c1"># Define what tab space we want to save</span>
        <span class="n">tab1</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="n">tab2</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="n">line_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#autogen_cmd = &#39;python -m ibeis.control.DB_SCHEMA --test-test_dbschema</span>
        <span class="c1">#--force-incremental-db-update --dump-autogen-schema&#39;</span>
        <span class="c1"># File Header</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">TRIPLE_DOUBLE_QUOTE</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;AUTOGENERATED ON &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(</span><span class="s1">&#39;printable&#39;</span><span class="p">))</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;AutogenCommandLine:&#39;</span><span class="p">)</span>
        <span class="c1"># TODO: Fix autogen command</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">autogen_cmd</span><span class="p">,</span> <span class="n">tab1</span><span class="p">))</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">TRIPLE_DOUBLE_QUOTE</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# -*- coding: utf-8 -*-&#39;</span><span class="p">)</span>
        <span class="c1">#line_list.append(&#39;from __future__ import absolute_import, division, print_function&#39;)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;from __future__ import absolute_import, division, print_function, unicode_literals&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;from ibeis import constants as const&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# =======================&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# Schema Version Current&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# =======================&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;VERSION_CURRENT = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">db_version_current</span><span class="p">))</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;def update_current(db, ibs=None):&#39;</span><span class="p">)</span>
        <span class="c1"># Function content</span>
        <span class="n">first</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="c1"># Hack to find the name of the constant variable</span>
            <span class="n">constant_name</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">const</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">tablename</span><span class="p">:</span>
                    <span class="n">constant_name</span> <span class="o">=</span> <span class="n">variable</span>
                    <span class="k">break</span>
            <span class="c1"># assert constant_name is not None, &quot;Table name does not exists in constants&quot;</span>
            <span class="k">if</span> <span class="n">constant_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab1</span> <span class="o">+</span> <span class="s1">&#39;db.add_table(const.</span><span class="si">%s</span><span class="s1">, [&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">constant_name</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab1</span> <span class="o">+</span> <span class="s1">&#39;db.add_table(</span><span class="si">%s</span><span class="s1">, [&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">tablename</span><span class="p">),))</span>
            <span class="n">column_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">:</span>
                <span class="n">col_name</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">__STR__</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
                <span class="n">col_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Check if PRIMARY KEY</span>
                    <span class="n">col_type</span> <span class="o">+=</span> <span class="s1">&#39; PRIMARY KEY&#39;</span>
                <span class="k">elif</span> <span class="n">column</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Check if NOT NULL</span>
                    <span class="n">col_type</span> <span class="o">+=</span> <span class="s1">&#39; NOT NULL&#39;</span>
                <span class="k">elif</span> <span class="n">column</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">col_type</span> <span class="o">+=</span> <span class="s1">&#39; DEFAULT &#39;</span> <span class="o">+</span> <span class="n">__STR__</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>  <span class="c1"># Specify default value</span>
                <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab2</span> <span class="o">+</span> <span class="s1">&#39;(</span><span class="si">%s%s</span><span class="s1">),&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">col_type</span><span class="p">),</span> <span class="p">))</span>
            <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab1</span> <span class="o">+</span> <span class="s1">&#39;],&#39;</span><span class="p">)</span>
            <span class="n">superkeys</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_superkey_colnames</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="n">docstr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_docstr</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="c1"># Append metadata values</span>
            <span class="n">specially_handled_table_metakeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;docstr&#39;</span><span class="p">,</span> <span class="s1">&#39;superkeys&#39;</span><span class="p">,</span>
                                                <span class="c1">#&#39;constraint&#39;,</span>
                                                <span class="s1">&#39;dependsmap&#39;</span><span class="p">]</span>
            <span class="k">def</span> <span class="nf">quote_docstr</span><span class="p">(</span><span class="n">docstr</span><span class="p">):</span>
                <span class="kn">import</span> <span class="nn">textwrap</span>
                <span class="n">wraped_docstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">textblock</span><span class="p">(</span><span class="n">docstr</span><span class="p">)))</span>
                <span class="n">indented_docstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">wraped_docstr</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">tab2</span><span class="p">)</span>
                <span class="n">_TSQ</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">TRIPLE_SINGLE_QUOTE</span>
                <span class="n">quoted_docstr</span> <span class="o">=</span> <span class="n">_TSQ</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">indented_docstr</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">tab2</span> <span class="o">+</span> <span class="n">_TSQ</span>
                <span class="k">return</span> <span class="n">quoted_docstr</span>
            <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab2</span> <span class="o">+</span> <span class="s1">&#39;docstr=&#39;</span> <span class="o">+</span> <span class="n">quote_docstr</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab2</span> <span class="o">+</span> <span class="s1">&#39;superkeys=</span><span class="si">%s</span><span class="s1">,&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">superkeys</span><span class="p">),</span> <span class="p">))</span>
            <span class="c1">#line_list.append(tab2 + &#39;constraint=%r,&#39; %</span>
            <span class="c1">#(db.get_metadata_val(tablename + &#39;_constraint&#39;),))</span>
            <span class="c1"># Hack out docstr and superkeys for now</span>
            <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">table_metadata_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">specially_handled_table_metakeys</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_metadata_val</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">eval_</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1">#ut.embed()</span>
                    <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab2</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">,&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
            <span class="n">dependsmap</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_metadata_val</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_dependsmap&#39;</span><span class="p">,</span> <span class="n">eval_</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dependsmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_dictstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">dependsmap</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">tab2</span><span class="p">)</span>
                <span class="n">depends_map_dictstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">_dictstr</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="c1"># hack for formatting</span>
                <span class="n">depends_map_dictstr</span> <span class="o">=</span> <span class="n">depends_map_dictstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tab1</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">)</span>
                <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab2</span> <span class="o">+</span> <span class="s1">&#39;dependsmap=</span><span class="si">%s</span><span class="s1">,&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">depends_map_dictstr</span><span class="p">,))</span>
            <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab1</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>

        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line_list</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.dump_schema"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.dump_schema">[docs]</a>    <span class="k">def</span> <span class="nf">dump_schema</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Convenience: Dumps all csv database files to disk</span>
<span class="sd">            NOTE: This function is semi-obsolete because of the auto-generated</span>
<span class="sd">            current schema file.  Use dump_schema_current_autogeneration instead for</span>
<span class="sd">            all purposes except for parsing out the database schema or for consice visual</span>
<span class="sd">            representation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">app_resource_dir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_app_resource_dir</span><span class="p">(</span><span class="s1">&#39;ibeis&#39;</span><span class="p">)</span>
        <span class="n">dump_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">app_resource_dir</span><span class="p">,</span> <span class="s1">&#39;schema.txt&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dump_fpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()):</span>
                <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">column_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">:</span>
                    <span class="n">col_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                    <span class="n">col_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">col_null</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="s1">&#39;ALLOW NULL&#39;</span> <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;NOT NULL&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">col_default</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">col_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="s1">&#39;KEY&#39;</span> <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">col_type</span><span class="p">,</span> <span class="n">col_null</span><span class="p">,</span> <span class="n">col_default</span><span class="p">,</span> <span class="n">col_key</span><span class="p">)</span>
                    <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s%s%s%s%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">col</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">view_directory</span><span class="p">(</span><span class="n">app_resource_dir</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_names"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_names</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conveinience: &quot;&quot;&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;&quot;</span><span class="p">)</span>
        <span class="n">tablename_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">tablename_list</span><span class="p">]</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_constraints"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_constraints</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="n">constraint</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_metadata_val</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_constraint&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="c1">#where_clause = &#39;metadata_key=?&#39;</span>
        <span class="c1">#colnames = (&#39;metadata_value&#39;,)</span>
        <span class="c1">#data = [(tablename + &#39;_constraint&#39;,)]</span>
        <span class="c1">#constraint = db.get_where(const.METADATA_TABLE, colnames, data, where_clause)</span>
        <span class="c1">#constraint = constraint[0]</span>
        <span class="k">if</span> <span class="n">constraint</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">constraint</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_superkey_colnames"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_superkey_colnames">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_superkey_colnames</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get_table_superkey_colnames</span>
<span class="sd">        Actually resturns a list of tuples. need to change the name to</span>
<span class="sd">        get_table_superkey_colnames_list</span>

<span class="sd">        Args:</span>
<span class="sd">            tablename (str):</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: superkeys</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --test-get_table_superkey_colnames</span>
<span class="sd">            python -m ibeis --tf get_table_superkey_colnames --tablename=contributors</span>
<span class="sd">            python -m ibeis --tf get_table_superkey_colnames --db PZ_Master0 --tablename=annotations</span>
<span class="sd">            python -m ibeis --tf get_table_superkey_colnames --db PZ_Master0 --tablename=contributors  # NOQA</span>

<span class="sd">        Example0:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; tablename = ut.get_argval(&#39;--tablename&#39;, type_=str, default=&#39;lblimage&#39;)</span>
<span class="sd">            &gt;&gt;&gt; result = ut.list_str(ibs.db.get_table_superkey_colnames(tablename), nl=False)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            [(&#39;lbltype_rowid&#39;, &#39;lblimage_value&#39;)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">(),</span> <span class="p">(</span>
            <span class="s1">&#39;tablename=</span><span class="si">%r</span><span class="s1"> is not a part of this database&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,))</span>
        <span class="n">superkey_colnames_list_repr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_metadata_val</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_superkeys&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="c1"># These asserts might not be valid, but in that case this function needs</span>
        <span class="c1"># to be rewritten under a different name</span>
        <span class="c1">#assert len(superkeys) == 1, &#39;INVALID DEVELOPER ASSUMPTION IN</span>
        <span class="c1">#SQLCONTROLLER. MORE THAN 1 SUPERKEY&#39;</span>
        <span class="k">if</span> <span class="n">superkey_colnames_list_repr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">superkeys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#superkey_colnames = superkey_colnames_str.split(&#39;;&#39;)</span>
            <span class="c1">#with ut.EmbedOnException():</span>
            <span class="k">if</span> <span class="n">superkey_colnames_list_repr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># SHOW NOT HAPPEN</span>
                <span class="c1"># hack for old metadata superkey_val format</span>
                <span class="n">superkeys</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">superkey_colnames_list_repr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)))]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># new evalable format</span>
                <span class="n">superkeys</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">superkey_colnames_list_repr</span><span class="p">)</span>
        <span class="c1">#superkeys = [</span>
        <span class="c1">#    None if superkey_colname is None else str(superkey_colname)</span>
        <span class="c1">#    for superkey_colname in superkey_colnames</span>
        <span class="c1">#]</span>
        <span class="n">superkeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">superkeys</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">superkeys</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_primarykey_colnames"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_primarykey_colnames">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_primarykey_colnames</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">primarykey_colnames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span>
            <span class="n">name</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">column_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">notnull</span><span class="p">,</span> <span class="n">dflt_value</span><span class="p">,</span> <span class="n">pk</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">columns</span>
            <span class="k">if</span> <span class="n">pk</span>
        <span class="p">])</span>
        <span class="k">return</span> <span class="n">primarykey_colnames</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_otherkey_colnames"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_otherkey_colnames">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_otherkey_colnames</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="n">flat_superkey_colnames_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_superkey_colnames</span><span class="p">(</span><span class="n">tablename</span><span class="p">))</span>
        <span class="c1">#superkeys = set((lambda x: x if x is not None else</span>
        <span class="c1">#[])(db.get_table_superkey_colnames(tablename)))</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">otherkey_colnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span>
                             <span class="k">for</span> <span class="p">(</span><span class="n">column_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">notnull</span><span class="p">,</span> <span class="n">dflt_value</span><span class="p">,</span> <span class="n">pk</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">columns</span>
                             <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">pk</span> <span class="ow">and</span>   <span class="c1"># not primary key</span>
                                 <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flat_superkey_colnames_list</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">otherkey_colnames</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_docstr"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_docstr">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_docstr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --exec-get_table_docstr</span>

<span class="sd">        Example0:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; tablename = ut.get_argval(&#39;--tablename&#39;, type_=str, default=&#39;contributors&#39;)</span>
<span class="sd">            &gt;&gt;&gt; docstr = ibs.db.get_table_docstr(tablename)</span>
<span class="sd">            &gt;&gt;&gt; print(docstr)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">docstr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_metadata_val</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_docstr&#39;</span><span class="p">)</span>
        <span class="c1">#where_clause = &#39;metadata_key=?&#39;</span>
        <span class="c1">#colnames = (&#39;metadata_value&#39;,)</span>
        <span class="c1">#data = [(tablename + &#39;_docstr&#39;,)]</span>
        <span class="c1">#docstr = db.get_where(const.METADATA_TABLE, colnames, data, where_clause)[0]</span>
        <span class="k">return</span> <span class="n">docstr</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_columns"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_columns">[docs]</a>    <span class="k">def</span> <span class="nf">get_columns</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get_columns</span>

<span class="sd">        Args:</span>
<span class="sd">            tablename (str): table name</span>

<span class="sd">        Returns:</span>
<span class="sd">            column_list : list of tuples with format:</span>
<span class="sd">                (</span>
<span class="sd">                    column_id  : id of the column</span>
<span class="sd">                    name       : the name of the column</span>
<span class="sd">                    type_      : the type of the column</span>
<span class="sd">                    notnull    : 0 or 1 if the column can contains null values</span>
<span class="sd">                    dflt_value : the default value</span>
<span class="sd">                    pk         : 0 or 1 if the column partecipate to the primary key</span>
<span class="sd">                )</span>

<span class="sd">        References:</span>
<span class="sd">            http://stackoverflow.com/questions/17717829/how-to-get-column-names-from-a-table-in-sqlite-via-pragma-net-c</span>
<span class="sd">            http://stackoverflow.com/questions/1601151/how-do-i-check-in-sqlite-whether-a-table-exists</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --exec-get_columns</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --exec-get_columns --tablename=contributors</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --exec-get_columns --tablename=nonexist</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.control.SQLDatabaseControl import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; db = ibeis.opendb(defaultdb=&#39;testdb1&#39;).db</span>
<span class="sd">            &gt;&gt;&gt; tablename = ut.get_argval(&#39;--tablename&#39;, type_=str, default=ibeis.const.NAME_TABLE)</span>
<span class="sd">            &gt;&gt;&gt; colrichinfo_list = db.get_columns(tablename)</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;colrichinfo_list = %s&#39; % (ut.list_str(colrichinfo_list),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            colrichinfo_list = [</span>
<span class="sd">                (0, &#39;name_rowid&#39;, &#39;INTEGER&#39;, 0, None, 1),</span>
<span class="sd">                (1, &#39;name_uuid&#39;, &#39;UUID&#39;, 1, None, 0),</span>
<span class="sd">                (2, &#39;name_text&#39;, &#39;TEXT&#39;, 1, None, 0),</span>
<span class="sd">                (3, &#39;name_note&#39;, &#39;TEXT&#39;, 0, None, 0),</span>
<span class="sd">                (4, &#39;name_temp_flag&#39;, &#39;INTEGER&#39;, 0, &#39;0&#39;, 0),</span>
<span class="sd">                (5, &#39;name_alias_text&#39;, &#39;TEXT&#39;, 0, None, 0),</span>
<span class="sd">                (6, &#39;name_sex&#39;, &#39;INTEGER&#39;, 0, &#39;-1&#39;, 0),</span>
<span class="sd">            ]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if the table exists first. Throws an error if it does not exist.</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT 1 FROM &#39;</span> <span class="o">+</span> <span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39; LIMIT 1&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA TABLE_INFO(&#39;&quot;</span> <span class="o">+</span> <span class="n">tablename</span> <span class="o">+</span> <span class="s2">&quot;&#39;)&quot;</span><span class="p">)</span>
        <span class="n">colinfo_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">colrichinfo_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQLColumnRichInfo</span><span class="p">(</span><span class="o">*</span><span class="n">colinfo</span><span class="p">)</span> <span class="k">for</span> <span class="n">colinfo</span> <span class="ow">in</span> <span class="n">colinfo_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">colrichinfo_list</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_column_names"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_column_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_column_names</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conveinience: Returns the sql tablename columns &quot;&quot;&quot;</span>
        <span class="n">column_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">column_names</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_column_types"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_column_types">[docs]</a>    <span class="k">def</span> <span class="nf">get_column_types</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conveinience: Returns the sql tablename columns &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">_format</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">type_</span> <span class="o">+</span> <span class="s2">&quot; PRIMARY KEY&quot;</span>
            <span class="k">elif</span> <span class="n">null</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">type_</span> <span class="o">+</span> <span class="s2">&quot; NOT NULL&quot;</span>
            <span class="k">elif</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">type_</span> <span class="o">+</span> <span class="s2">&quot; DEFAULT &quot;</span> <span class="o">+</span> <span class="n">default</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">type_</span>

        <span class="n">column_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">column_types</span>   <span class="o">=</span> <span class="p">[</span> <span class="n">column</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">]</span>
        <span class="n">column_null</span>    <span class="o">=</span> <span class="p">[</span> <span class="n">column</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">]</span>
        <span class="n">column_default</span> <span class="o">=</span> <span class="p">[</span> <span class="n">column</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">]</span>
        <span class="n">column_key</span>     <span class="o">=</span> <span class="p">[</span> <span class="n">column</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">]</span>
        <span class="n">column_types_</span>  <span class="o">=</span> <span class="p">[</span>
            <span class="n">_format</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">type_</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">key</span>
            <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">column_types</span><span class="p">,</span> <span class="n">column_null</span><span class="p">,</span> <span class="n">column_default</span><span class="p">,</span> <span class="n">column_key</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">column_types_</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_column"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_column">[docs]</a>    <span class="k">def</span> <span class="nf">get_column</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conveinience: &quot;&quot;&quot;</span>
        <span class="n">_table</span><span class="p">,</span> <span class="p">(</span><span class="n">_column</span><span class="p">,)</span> <span class="o">=</span> <span class="n">sanitize_sql</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>
        <span class="n">column_vals</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            SELECT </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">            FROM </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">            ORDER BY rowid ASC</span>
<span class="s1">            &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_column</span><span class="p">,</span> <span class="n">_table</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">column_vals</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_column_data"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_column_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_column_data</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --test-get_table_column_data</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.control.SQLDatabaseControl import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; # build test data</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; db = ibs.db</span>
<span class="sd">            &gt;&gt;&gt; tablename = ibeis.const.ANNOTATION_TABLE</span>
<span class="sd">            &gt;&gt;&gt; exclude_columns = []</span>
<span class="sd">            &gt;&gt;&gt; # execute function</span>
<span class="sd">            &gt;&gt;&gt; column_list, column_names = db.get_table_column_data(tablename)</span>
<span class="sd">            &gt;&gt;&gt; # verify results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_column_names</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">isvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_columns</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">all_column_names</span><span class="p">]</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">all_column_names</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>
        <span class="n">column_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">column_names</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_columns</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">column_list</span><span class="p">,</span> <span class="n">column_names</span>
</div>
<div class="viewcode-block" id="SQLDatabaseController.make_json_table_definition"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.make_json_table_definition">[docs]</a>    <span class="k">def</span> <span class="nf">make_json_table_definition</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        VERY HACKY FUNC RIGHT NOW. NEED TO FIX LATER</span>

<span class="sd">        Args:</span>
<span class="sd">            tablename (?):</span>

<span class="sd">        Returns:</span>
<span class="sd">            ?: new_transferdata</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis --tf SQLDatabaseControl.make_json_table_definition</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m utool --tf iter_module_doctestable --modname=ibeis.control.SQLDatabaseControl</span>
<span class="sd">            --include_inherited=True</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --exec-make_json_table_definition</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.control.SQLDatabaseControl import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; db = ibs.db</span>
<span class="sd">            &gt;&gt;&gt; # TODO: define heirarchy</span>
<span class="sd">            &gt;&gt;&gt; tablename = ibs.const.ANNOTATION_TABLE</span>
<span class="sd">            &gt;&gt;&gt; annot_table_def = db.make_json_table_definition(tablename)</span>
<span class="sd">            &gt;&gt;&gt; tablename = ibs.const.IMAGE_TABLE</span>
<span class="sd">            &gt;&gt;&gt; image_table_def = db.make_json_table_definition(tablename)</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;annot_attrs = %s&#39; % (ut.repr2(annot_table_def, nl=True),))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;image_attrs = %s&#39; % (ut.repr2(image_table_def, nl=True),))</span>

<span class="sd">        Ignore:</span>
<span class="sd">            annot_table_def = {</span>
<span class="sd">                &#39;annot_rowid&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;annot_uuid&#39;: &#39;UUID&#39;,</span>
<span class="sd">                &#39;annot_xtl&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;annot_ytl&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;annot_width&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;annot_height&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;annot_theta&#39;: &#39;REAL&#39;,</span>
<span class="sd">                &#39;annot_num_verts&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;annot_verts&#39;: &#39;TEXT&#39;,</span>
<span class="sd">                &#39;annot_yaw&#39;: &#39;REAL&#39;,</span>
<span class="sd">                &#39;annot_detect_confidence&#39;: &#39;REAL&#39;,</span>
<span class="sd">                &#39;annot_exemplar_flag&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;annot_note&#39;: &#39;TEXT&#39;,</span>
<span class="sd">                &#39;annot_visual_uuid&#39;: &#39;UUID&#39;,</span>
<span class="sd">                &#39;annot_semantic_uuid&#39;: &#39;UUID&#39;,</span>
<span class="sd">                &#39;annot_quality&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;annot_age_months_est_min&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;annot_age_months_est_max&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;annot_tags&#39;: &#39;TEXT&#39;,</span>
<span class="sd">                &#39;species_text&#39;: &#39;DATA&#39;,</span>
<span class="sd">                &#39;name_text&#39;: &#39;DATA&#39;,</span>
<span class="sd">                &#39;image_uuid&#39;: &#39;DATA&#39;,</span>
<span class="sd">            }</span>
<span class="sd">            image_table_def = {</span>
<span class="sd">                &#39;image_rowid&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;image_uuid&#39;: &#39;UUID&#39;,</span>
<span class="sd">                &#39;image_uri&#39;: &#39;TEXT&#39;,</span>
<span class="sd">                &#39;image_ext&#39;: &#39;TEXT&#39;,</span>
<span class="sd">                &#39;image_original_name&#39;: &#39;TEXT&#39;,</span>
<span class="sd">                &#39;image_width&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;image_height&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;image_time_posix&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;image_gps_lat&#39;: &#39;REAL&#39;,</span>
<span class="sd">                &#39;image_gps_lon&#39;: &#39;REAL&#39;,</span>
<span class="sd">                &#39;image_toggle_enabled&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;image_toggle_reviewed&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;image_note&#39;: &#39;TEXT&#39;,</span>
<span class="sd">                &#39;image_timedelta_posix&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;image_original_path&#39;: &#39;TEXT&#39;,</span>
<span class="sd">                &#39;image_location_code&#39;: &#39;TEXT&#39;,</span>
<span class="sd">                &#39;contributor_tag&#39;: &#39;DATA&#39;,</span>
<span class="sd">                &#39;party_tag&#39;: &#39;DATA&#39;,</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_transferdata</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_new_transferdata</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="p">(</span><span class="n">column_list</span><span class="p">,</span> <span class="n">column_names</span><span class="p">,</span> <span class="n">extern_colx_list</span><span class="p">,</span>
         <span class="n">extern_superkey_colname_list</span><span class="p">,</span> <span class="n">extern_superkey_colval_list</span><span class="p">,</span>
         <span class="n">extern_tablename_list</span><span class="p">,</span> <span class="n">extern_primarycolnames_list</span><span class="p">)</span> <span class="o">=</span> <span class="n">new_transferdata</span>
        <span class="n">dependsmap</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_metadata_val</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_dependsmap&#39;</span><span class="p">,</span> <span class="n">eval_</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="c1">#dependson = db.get_metadata_val(tablename + &#39;_dependson&#39;, eval_=True, default=None)</span>

        <span class="n">richcolinfo_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">table_dict_def</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([(</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">type_</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">richcolinfo_list</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">dependsmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dependsmap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tablename</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">table_dict_def</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">table_dict_def</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># replace with superkey</span>
                    <span class="k">del</span> <span class="n">table_dict_def</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">_deptablecols</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">superkey</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">superkey</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;unhandled&#39;</span>
                    <span class="n">colinfo</span> <span class="o">=</span> <span class="p">{</span><span class="n">_</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">_deptablecols</span><span class="p">}[</span><span class="n">superkey</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">table_dict_def</span><span class="p">[</span><span class="n">superkey</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">colinfo</span><span class="o">.</span><span class="n">type_</span>
        <span class="c1">#json_def_str = ut.dict_str(table_dict_def, aligned=True)</span>
        <span class="k">return</span> <span class="n">table_dict_def</span>
        <span class="c1">#table_obj_def =</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_new_transferdata"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_new_transferdata">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_new_transferdata</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --test-get_table_column_data</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --test-get_table_new_transferdata</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --test-get_table_new_transferdata:1</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.control.SQLDatabaseControl import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; db = ibs.db</span>
<span class="sd">            &gt;&gt;&gt; exclude_columns = []</span>
<span class="sd">            &gt;&gt;&gt; tablename_list = ibs.db.get_table_names()</span>
<span class="sd">            &gt;&gt;&gt; for tablename in tablename_list:</span>
<span class="sd">            ...     new_transferdata = db.get_table_new_transferdata(tablename)</span>
<span class="sd">            ...     column_list, column_names, extern_colx_list, extern_superkey_colname_list, extern_superkey_colval_list, extern_tablename_list, extern_primarycolnames_list = new_transferdata</span>
<span class="sd">            ...     print(&#39;tablename = %r&#39; % (tablename,))</span>
<span class="sd">            ...     print(&#39;colnames = &#39; + ut.list_str(column_names))</span>
<span class="sd">            ...     print(&#39;extern_colx_list = &#39; + ut.list_str(extern_colx_list))</span>
<span class="sd">            ...     print(&#39;extern_superkey_colname_list = &#39; + ut.list_str(extern_superkey_colname_list))</span>
<span class="sd">            ...     print(&#39;L___&#39;)</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.control.SQLDatabaseControl import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; db = ibs.db</span>
<span class="sd">            &gt;&gt;&gt; exclude_columns = []</span>
<span class="sd">            &gt;&gt;&gt; tablename = ibs.const.IMAGE_TABLE</span>
<span class="sd">            &gt;&gt;&gt; new_transferdata = db.get_table_new_transferdata(tablename)</span>
<span class="sd">            &gt;&gt;&gt; column_list, column_names, extern_colx_list, extern_superkey_colname_list, extern_superkey_colval_list, extern_tablename_list, extern_primarycolnames_list = new_transferdata</span>
<span class="sd">            &gt;&gt;&gt; dependsmap = db.get_metadata_val(tablename + &#39;_dependsmap&#39;, eval_=True, default=None)</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;tablename = %r&#39; % (tablename,))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;colnames = &#39; + ut.list_str(column_names))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;extern_colx_list = &#39; + ut.list_str(extern_colx_list))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;extern_superkey_colname_list = &#39; + ut.list_str(extern_superkey_colname_list))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;dependsmap = %s&#39; % (ut.repr2(dependsmap, nl=True),))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;L___&#39;)</span>
<span class="sd">            &gt;&gt;&gt; tablename = ibs.const.ANNOTATION_TABLE</span>
<span class="sd">            &gt;&gt;&gt; new_transferdata = db.get_table_new_transferdata(tablename)</span>
<span class="sd">            &gt;&gt;&gt; column_list, column_names, extern_colx_list, extern_superkey_colname_list, extern_superkey_colval_list, extern_tablename_list, extern_primarycolnames_list = new_transferdata</span>
<span class="sd">            &gt;&gt;&gt; dependsmap = db.get_metadata_val(tablename + &#39;_dependsmap&#39;, eval_=True, default=None)</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;tablename = %r&#39; % (tablename,))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;colnames = &#39; + ut.list_str(column_names))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;extern_colx_list = &#39; + ut.list_str(extern_colx_list))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;extern_superkey_colname_list = &#39; + ut.list_str(extern_superkey_colname_list))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;dependsmap = %s&#39; % (ut.repr2(dependsmap, nl=True),))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;L___&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_column_names</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">isvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_columns</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">all_column_names</span><span class="p">]</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">all_column_names</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>
        <span class="n">column_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">column_names</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_columns</span><span class="p">]</span>

        <span class="n">extern_colx_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">extern_tablename_list</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="n">extern_superkey_colname_list</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="n">extern_superkey_colval_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">extern_primarycolnames_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dependsmap</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_metadata_val</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_dependsmap&#39;</span><span class="p">,</span> <span class="n">eval_</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dependsmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">colname</span><span class="p">,</span> <span class="n">dependtup</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">dependsmap</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">dependtup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;must be 3 for now&#39;</span>
                <span class="p">(</span><span class="n">extern_tablename</span><span class="p">,</span> <span class="n">extern_primary_colnames</span><span class="p">,</span> <span class="n">extern_superkey_colnames</span><span class="p">)</span> <span class="o">=</span> <span class="n">dependtup</span>
                <span class="k">if</span> <span class="n">extern_primary_colnames</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1">#ut.embed()</span>
                    <span class="c1"># INFER PRIMARY COLNAMES</span>
                    <span class="n">extern_primary_colnames</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_primarykey_colnames</span><span class="p">(</span><span class="n">extern_tablename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">extern_superkey_colnames</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">get_standard_superkey_colnames</span><span class="p">(</span><span class="n">tablename_</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># FIXME: Rectify duplicate code</span>
                            <span class="n">superkeys</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_superkey_colnames</span><span class="p">(</span><span class="n">tablename_</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">superkeys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="c1">#primary_superkey =</span>
                                <span class="c1">#db.get_metadata_val(tablename_ +</span>
                                <span class="c1">#                    &#39;_primary_superkey&#39;,</span>
                                <span class="c1">#                    eval_=True)</span>
                                <span class="n">primary_superkey</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_metadata_val</span><span class="p">(</span>
                                    <span class="n">tablename_</span> <span class="o">+</span> <span class="s1">&#39;_primary_superkey&#39;</span><span class="p">,</span> <span class="n">eval_</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                                <span class="n">db</span><span class="o">.</span><span class="n">get_table_superkey_colnames</span><span class="p">(</span><span class="s1">&#39;contributors&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">primary_superkey</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                                        <span class="p">(</span><span class="s1">&#39;tablename_=</span><span class="si">%r</span><span class="s1"> has multiple superkeys=</span><span class="si">%r</span><span class="s1">, &#39;</span>
                                         <span class="s1">&#39;but no primary superkey.&#39;</span>
                                         <span class="s1">&#39; A primary superkey is required&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                                             <span class="n">tablename_</span><span class="p">,</span> <span class="n">superkeys</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">index</span> <span class="o">=</span> <span class="n">superkeys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">primary_superkey</span><span class="p">)</span>
                                    <span class="n">superkey_colnames</span> <span class="o">=</span> <span class="n">superkeys</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">superkeys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">superkey_colnames</span> <span class="o">=</span> <span class="n">superkeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv_header</span><span class="p">(</span><span class="n">tablename_</span><span class="p">))</span>
                                <span class="n">db</span><span class="o">.</span><span class="n">print_table_csv</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;metadata_value&#39;</span><span class="p">])</span>
                                <span class="c1"># Execute hack to fix contributor tables</span>
                                <span class="k">if</span> <span class="n">tablename_</span> <span class="o">==</span> <span class="s1">&#39;contributors&#39;</span><span class="p">:</span>
                                    <span class="c1"># hack to fix contributors table</span>
                                    <span class="n">constraint_str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_metadata_val</span><span class="p">(</span><span class="n">tablename_</span> <span class="o">+</span> <span class="s1">&#39;_constraint&#39;</span><span class="p">)</span>
                                    <span class="n">parse_result</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                                        <span class="s1">&#39;CONSTRAINT superkey UNIQUE ({superkey})&#39;</span><span class="p">,</span>
                                        <span class="n">constraint_str</span><span class="p">)</span>
                                    <span class="n">superkey</span> <span class="o">=</span> <span class="n">parse_result</span><span class="p">[</span><span class="s1">&#39;superkey&#39;</span><span class="p">]</span>
                                    <span class="k">assert</span> <span class="n">superkey</span> <span class="o">==</span> <span class="s1">&#39;contributor_tag&#39;</span><span class="p">,</span> <span class="s1">&#39;hack failed1&#39;</span>
                                    <span class="k">assert</span> <span class="bp">None</span> <span class="ow">is</span> <span class="n">db</span><span class="o">.</span><span class="n">get_metadata_val</span><span class="p">(</span><span class="s1">&#39;contributors_superkey&#39;</span><span class="p">),</span> <span class="p">(</span>
                                        <span class="s1">&#39;hack failed2&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="bp">True</span><span class="p">:</span>
                                        <span class="n">db</span><span class="o">.</span><span class="n">set_metadata_val</span><span class="p">(</span><span class="s1">&#39;contributors_superkeys&#39;</span><span class="p">,</span>
                                                            <span class="s2">&quot;[(&#39;&quot;</span> <span class="o">+</span> <span class="n">superkey</span> <span class="o">+</span> <span class="s2">&quot;&#39;,)]&quot;</span><span class="p">)</span>
                                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                                    <span class="s1">&#39;Cannot Handle: len(superkeys) == 0. &#39;</span>
                                    <span class="s1">&#39;Probably a degenerate case&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;Error Getting superkey colnames&#39;</span><span class="p">,</span>
                                       <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tablename_&#39;</span><span class="p">,</span> <span class="s1">&#39;superkeys&#39;</span><span class="p">])</span>
                            <span class="k">raise</span>
                        <span class="k">return</span> <span class="n">superkey_colnames</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">extern_superkey_colnames</span> <span class="o">=</span> <span class="n">get_standard_superkey_colnames</span><span class="p">(</span><span class="n">extern_tablename</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;Error Building Transferdata&#39;</span><span class="p">,</span>
                                   <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tablename_&#39;</span><span class="p">,</span> <span class="s1">&#39;dependtup&#39;</span><span class="p">])</span>
                        <span class="k">raise</span>
                    <span class="c1"># INFER SUPERKEY COLNAMES</span>
                <span class="n">colx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listfind</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span>
                <span class="n">extern_rowids</span> <span class="o">=</span> <span class="n">column_list</span><span class="p">[</span><span class="n">colx</span><span class="p">]</span>
                <span class="n">superkey_column</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">extern_tablename</span><span class="p">,</span> <span class="n">extern_superkey_colnames</span><span class="p">,</span> <span class="n">extern_rowids</span><span class="p">)</span>
                <span class="n">extern_colx_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colx</span><span class="p">)</span>
                <span class="n">extern_superkey_colname_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extern_superkey_colnames</span><span class="p">)</span>
                <span class="n">extern_superkey_colval_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">superkey_column</span><span class="p">)</span>
                <span class="n">extern_tablename_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extern_tablename</span><span class="p">)</span>
                <span class="n">extern_primarycolnames_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extern_primary_colnames</span><span class="p">)</span>

        <span class="n">new_transferdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">column_list</span><span class="p">,</span> <span class="n">column_names</span><span class="p">,</span> <span class="n">extern_colx_list</span><span class="p">,</span>
                            <span class="n">extern_superkey_colname_list</span><span class="p">,</span>
                            <span class="n">extern_superkey_colval_list</span><span class="p">,</span> <span class="n">extern_tablename_list</span><span class="p">,</span>
                            <span class="n">extern_primarycolnames_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_transferdata</span>

    <span class="c1">#def import_table_new_transferdata(tablename, new_transferdata):</span>
    <span class="c1">#    pass</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.merge_databases_new"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.merge_databases_new">[docs]</a>    <span class="k">def</span> <span class="nf">merge_databases_new</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">db_src</span><span class="p">,</span> <span class="n">ignore_tables</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rowid_subsets</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        Copies over all non-rowid properties into another sql table. handles annotated dependenceis.</span>
<span class="sd">        Does not handle external files</span>
<span class="sd">        Could handle dependency tree order, but not yet implemented.</span>

<span class="sd">        Args:</span>
<span class="sd">            db_src (SQLController): merge data from db_src into db</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --test-merge_databases_new:0</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --test-merge_databases_new:2</span>

<span class="sd">        Example0:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.control.SQLDatabaseControl import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; #ibs_dst = ibeis.opendb(dbdir=&#39;testdb_dst&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ibs_src = ibeis.opendb(db=&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; # OPEN A CLEAN DATABASE</span>
<span class="sd">            &gt;&gt;&gt; ibs_dst = ibeis.opendb(dbdir=&#39;test_sql_merge_dst1&#39;, allow_newdir=True, delete_ibsdir=True)</span>
<span class="sd">            &gt;&gt;&gt; ibs_src.ensure_contributor_rowids()</span>
<span class="sd">            &gt;&gt;&gt; # build test data</span>
<span class="sd">            &gt;&gt;&gt; db = ibs_dst.db</span>
<span class="sd">            &gt;&gt;&gt; db_src = ibs_src.db</span>
<span class="sd">            &gt;&gt;&gt; rowid_subsets = None</span>
<span class="sd">            &gt;&gt;&gt; # execute function</span>
<span class="sd">            &gt;&gt;&gt; db.merge_databases_new(db_src)</span>

<span class="sd">        Example1:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.control.SQLDatabaseControl import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; ibs_src = ibeis.opendb(db=&#39;testdb2&#39;)</span>
<span class="sd">            &gt;&gt;&gt; # OPEN A CLEAN DATABASE</span>
<span class="sd">            &gt;&gt;&gt; ibs_dst = ibeis.opendb(dbdir=&#39;test_sql_merge_dst2&#39;, allow_newdir=True, delete_ibsdir=True)</span>
<span class="sd">            &gt;&gt;&gt; ibs_src.ensure_contributor_rowids()</span>
<span class="sd">            &gt;&gt;&gt; # build test data</span>
<span class="sd">            &gt;&gt;&gt; db = ibs_dst.db</span>
<span class="sd">            &gt;&gt;&gt; db_src = ibs_src.db</span>
<span class="sd">            &gt;&gt;&gt; ignore_tables = [&#39;lblannot&#39;, &#39;lblimage&#39;, &#39;image_lblimage_relationship&#39;, &#39;annotation_lblannot_relationship&#39;, &#39;keys&#39;]</span>
<span class="sd">            &gt;&gt;&gt; rowid_subsets = None</span>
<span class="sd">            &gt;&gt;&gt; # execute function</span>
<span class="sd">            &gt;&gt;&gt; db.merge_databases_new(db_src, ignore_tables=ignore_tables)</span>

<span class="sd">        Example2:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.control.SQLDatabaseControl import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; ibs_src = ibeis.opendb(db=&#39;testdb2&#39;)</span>
<span class="sd">            &gt;&gt;&gt; # OPEN A CLEAN DATABASE</span>
<span class="sd">            &gt;&gt;&gt; ibs_src.fix_invalid_annotmatches()</span>
<span class="sd">            &gt;&gt;&gt; ibs_dst = ibeis.opendb(dbdir=&#39;test_sql_subexport_dst2&#39;, allow_newdir=True, delete_ibsdir=True)</span>
<span class="sd">            &gt;&gt;&gt; ibs_src.ensure_contributor_rowids()</span>
<span class="sd">            &gt;&gt;&gt; #ibs_src.delete_all_encounters()</span>
<span class="sd">            &gt;&gt;&gt; # build test data</span>
<span class="sd">            &gt;&gt;&gt; db = ibs_dst.db</span>
<span class="sd">            &gt;&gt;&gt; db_src = ibs_src.db</span>
<span class="sd">            &gt;&gt;&gt; ignore_tables = [&#39;lblannot&#39;, &#39;lblimage&#39;, &#39;image_lblimage_relationship&#39;, &#39;annotation_lblannot_relationship&#39;, &#39;keys&#39;]</span>
<span class="sd">            &gt;&gt;&gt; # execute function</span>
<span class="sd">            &gt;&gt;&gt; aid_subset = [1, 2, 3]</span>
<span class="sd">            &gt;&gt;&gt; rowid_subsets = {const.ANNOTATION_TABLE: aid_subset,</span>
<span class="sd">            ...                  const.NAME_TABLE: ibs_src.get_annot_nids(aid_subset),</span>
<span class="sd">            ...                  const.IMAGE_TABLE: ibs_src.get_annot_gids(aid_subset),</span>
<span class="sd">            ...                  const.ANNOTMATCH_TABLE: [],</span>
<span class="sd">            ...                  const.EG_RELATION_TABLE: [],</span>
<span class="sd">            ...                  }</span>
<span class="sd">            &gt;&gt;&gt; db.merge_databases_new(db_src, ignore_tables=ignore_tables, rowid_subsets=rowid_subsets)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">veryverbose</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># Check version consistency</span>
        <span class="n">version_dst</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_metadata_val</span><span class="p">(</span><span class="s1">&#39;database_version&#39;</span><span class="p">)</span>
        <span class="n">version_src</span> <span class="o">=</span> <span class="n">db_src</span><span class="o">.</span><span class="n">get_metadata_val</span><span class="p">(</span><span class="s1">&#39;database_version&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">version_src</span> <span class="o">==</span> <span class="n">version_dst</span><span class="p">,</span> <span class="s1">&#39;cannot merge databases that have different versions&#39;</span>
        <span class="c1"># Get merge tablenames</span>
        <span class="n">all_tablename_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()</span>
        <span class="c1"># always ignore the metadata table.</span>
        <span class="n">ignore_tables_</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ignore_tables</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ignore_tables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ignore_tables_</span> <span class="o">+=</span> <span class="n">ignore_tables</span>
        <span class="n">tablename_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">tablename</span> <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">all_tablename_list</span>
                          <span class="k">if</span> <span class="n">tablename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore_tables_</span><span class="p">]</span>
        <span class="c1"># Reorder tablenames based on dependencies.</span>
        <span class="c1"># the tables with dependencies are merged after the tables they depend on</span>
        <span class="n">dependsmap_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">db</span><span class="o">.</span><span class="n">get_metadata_val</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_dependsmap&#39;</span><span class="p">,</span> <span class="n">eval_</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">tablename_list</span><span class="p">]</span>
        <span class="n">dependency_digraph</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">tablename</span><span class="p">:</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">dependsmap</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">dependsmap</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dependsmap</span><span class="p">,</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dependsmap_list</span><span class="p">,</span> <span class="n">tablename_list</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1">#EXTEND_SUBSETS = False</span>
        <span class="c1">#if EXTEND_SUBSETS:</span>

        <span class="c1">#    inverted_digraph = ut.ddict(list)</span>
        <span class="c1">#    for key, item_list in six.iteritems(dependency_digraph):</span>
        <span class="c1">#        for item in item_list:</span>
        <span class="c1">#            inverted_digraph[item].append(key)</span>
        <span class="c1">#        #dependency_digraph</span>
        <span class="c1">#    inverted_digraph = dict(inverted_digraph)</span>

        <span class="c1">#    rowid_subsets</span>
        <span class="c1">#    seen_ = set([])</span>
        <span class="c1">#    #def expand_subsets(rowid_subsets, seen_=seen_):</span>
        <span class="c1">#    #    key_list = list(set(rowid_subsets.keys()) - seen_)</span>
        <span class="c1">#    #    for key in key_list:</span>
        <span class="c1">#    #        item_list = dependency_digraph[key]</span>
        <span class="c1">#    #        for item in item_list:</span>
        <span class="c1">#    #            dependsmap = dependsmap_list[tablename_list.index(key)]</span>
        <span class="c1">#    #            new_transferdata = db_src.get_table_new_transferdata(tablename)</span>
        <span class="c1">#    #            # FIXME: SUPER DUPLICATE CODE</span>
        <span class="c1">#    #            (column_list, column_names,</span>
        <span class="c1">#    #             extern_colx_list, extern_superkey_colname_list,</span>
        <span class="c1">#    #             extern_superkey_colval_list, extern_tablename_list,</span>
        <span class="c1">#    #             extern_primarycolnames_list</span>
        <span class="c1">#    #             ) = new_transferdata</span>
        <span class="c1">#    #            for index, (key2, val2) in enumerate(six.iteritems(dependsmap)):</span>
        <span class="c1">#    #                if key2 == &#39;image_rowid&#39;:</span>
        <span class="c1">#    #                    break</span>
        <span class="c1">#    #                column_list[key2]</span>
        <span class="c1">#    #                column_list[index]</span>
        <span class="c1">#    #                pass</span>

        <span class="c1">#    #        pass</span>

        <span class="c1">#    #    pass</span>

        <span class="k">def</span> <span class="nf">find_depth</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">dependency_digraph</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            depth first search to find root self cycles are counted as 0 depth</span>
<span class="sd">            will break if a true cycle exists</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">depth_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">find_depth</span><span class="p">(</span><span class="n">depends_tablename</span><span class="p">,</span> <span class="n">dependency_digraph</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">depends_tablename</span> <span class="o">!=</span> <span class="n">tablename</span> <span class="k">else</span>
                <span class="mi">0</span>
                <span class="k">for</span> <span class="n">depends_tablename</span> <span class="ow">in</span> <span class="n">dependency_digraph</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="n">depth_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">depth</span>
        <span class="n">order_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">find_depth</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">dependency_digraph</span><span class="p">)</span> <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">tablename_list</span><span class="p">]</span>
        <span class="n">sorted_tablename_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">tablename_list</span><span class="p">,</span> <span class="n">order_list</span><span class="p">)</span>
        <span class="c1"># ================================</span>
        <span class="c1"># Merge each table into new database</span>
        <span class="c1"># ================================</span>
        <span class="c1">#tablename_to_rowidmap = {}  # TODO</span>
        <span class="c1">#old_rowids_to_new_roids</span>
        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">sorted_tablename_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[sqlmerge] Merging tablename=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,))</span>
            <span class="c1"># Collect the data from the source table that will be merged in</span>
            <span class="n">new_transferdata</span> <span class="o">=</span> <span class="n">db_src</span><span class="o">.</span><span class="n">get_table_new_transferdata</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="c1"># FIXME: This needs to pass back sparser output</span>
            <span class="p">(</span><span class="n">column_list</span><span class="p">,</span> <span class="n">column_names</span><span class="p">,</span>
             <span class="c1"># These fields are for external data dependencies. We need to find what the</span>
             <span class="c1"># new rowids will be in the destintation database</span>
             <span class="n">extern_colx_list</span><span class="p">,</span> <span class="n">extern_superkey_colname_list</span><span class="p">,</span>
             <span class="n">extern_superkey_colval_list</span><span class="p">,</span> <span class="n">extern_tablename_list</span><span class="p">,</span>
             <span class="n">extern_primarycolnames_list</span>
             <span class="p">)</span> <span class="o">=</span> <span class="n">new_transferdata</span>
            <span class="c1"># FIXME: extract the primary rowid column a little bit nicer</span>
            <span class="k">assert</span> <span class="n">column_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_rowid&#39;</span><span class="p">)</span>
            <span class="n">old_rowid_list</span> <span class="o">=</span> <span class="n">column_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">column_names_</span> <span class="o">=</span> <span class="n">column_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">column_list_</span> <span class="o">=</span> <span class="n">column_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="c1"># +=================================================</span>
            <span class="c1"># WIP: IF SUBSET REQUSTED FILTER OUT INVALID ROWIDS</span>
            <span class="k">if</span> <span class="n">rowid_subsets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">rowid_subsets</span><span class="p">:</span>
                <span class="n">valid_rowids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">rowid_subsets</span><span class="p">[</span><span class="n">tablename</span><span class="p">])</span>
                <span class="n">isvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">rowid</span> <span class="ow">in</span> <span class="n">valid_rowids</span> <span class="k">for</span> <span class="n">rowid</span> <span class="ow">in</span> <span class="n">old_rowid_list</span><span class="p">]</span>
                <span class="n">valid_old_rowid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">old_rowid_list</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>
                <span class="n">valid_column_list_</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_list_</span><span class="p">]</span>
                <span class="n">valid_extern_superkey_colval_list</span> <span class="o">=</span>  <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>
                                                      <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">extern_superkey_colval_list</span><span class="p">]</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39; * filtered number of rows from </span><span class="si">%d</span><span class="s1"> to </span><span class="si">%d</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">valid_rowids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_old_rowid_list</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39; * no filtering requested&#39;</span><span class="p">)</span>
                <span class="n">valid_extern_superkey_colval_list</span> <span class="o">=</span> <span class="n">extern_superkey_colval_list</span>
                <span class="n">valid_old_rowid_list</span> <span class="o">=</span> <span class="n">old_rowid_list</span>
                <span class="n">valid_column_list_</span> <span class="o">=</span> <span class="n">column_list_</span>
            <span class="c1">#if len(valid_old_rowid_list) == 0:</span>
            <span class="c1">#    continue</span>
            <span class="c1"># L=================================================</span>

            <span class="c1"># ================================</span>
            <span class="c1"># Resolve external superkey lookups</span>
            <span class="c1"># ================================</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extern_colx_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sqlmerge] </span><span class="si">%s</span><span class="s1"> has </span><span class="si">%d</span><span class="s1"> externaly dependant columns to resolve&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">tablename</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">extern_colx_list</span><span class="p">)))</span>
                <span class="n">modified_column_list_</span> <span class="o">=</span> <span class="n">valid_column_list_</span><span class="p">[:]</span>
                <span class="n">new_extern_rowid_list</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># Find the mappings from the old tables rowids to the new tables rowids</span>
                <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">extern_colx_list</span><span class="p">,</span> <span class="n">extern_superkey_colname_list</span><span class="p">,</span>
                               <span class="n">valid_extern_superkey_colval_list</span><span class="p">,</span>
                               <span class="n">extern_tablename_list</span><span class="p">,</span>
                               <span class="n">extern_primarycolnames_list</span><span class="p">):</span>
                    <span class="p">(</span><span class="n">colx</span><span class="p">,</span> <span class="n">extern_superkey_colname</span><span class="p">,</span> <span class="n">extern_superkey_colval</span><span class="p">,</span>
                     <span class="n">extern_tablename</span><span class="p">,</span> <span class="n">extern_primarycolname</span><span class="p">)</span> <span class="o">=</span> <span class="n">tup</span>
                    <span class="n">source_colname</span> <span class="o">=</span> <span class="n">column_names_</span><span class="p">[</span><span class="n">colx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">veryverbose</span> <span class="ow">or</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sqlmerge] +--&#39;</span><span class="p">)</span>
                            <span class="k">print</span><span class="p">((</span><span class="s1">&#39;[sqlmerge] * resolving source_colname=</span><span class="si">%r</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span>
                                   <span class="s1">&#39;                 via extern_superkey_colname=</span><span class="si">%r</span><span class="s1"> ...</span><span class="se">\n</span><span class="s1">&#39;</span>
                                   <span class="s1">&#39;                 -&gt; extern_primarycolname=</span><span class="si">%r</span><span class="s1">. colx=</span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">)</span>
                                  <span class="o">%</span> <span class="p">(</span><span class="n">source_colname</span><span class="p">,</span> <span class="n">extern_superkey_colname</span><span class="p">,</span>
                                     <span class="n">extern_primarycolname</span><span class="p">,</span> <span class="n">colx</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sqlmerge] * resolving </span><span class="si">%r</span><span class="s1"> via </span><span class="si">%r</span><span class="s1"> -&gt; </span><span class="si">%r</span><span class="s1">&#39;</span>
                                  <span class="o">%</span> <span class="p">(</span><span class="n">source_colname</span><span class="p">,</span> <span class="n">extern_superkey_colname</span><span class="p">,</span>
                                     <span class="n">extern_primarycolname</span><span class="p">))</span>
                    <span class="n">_params_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">extern_superkey_colval</span><span class="p">))</span>
                    <span class="n">new_extern_rowids</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_rowid_from_superkey</span><span class="p">(</span>
                        <span class="n">extern_tablename</span><span class="p">,</span> <span class="n">_params_iter</span><span class="p">,</span> <span class="n">superkey_colnames</span><span class="o">=</span><span class="n">extern_superkey_colname</span><span class="p">)</span>
                    <span class="n">num_Nones</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flag_None_items</span><span class="p">(</span><span class="n">new_extern_rowids</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sqlmerge] * there were </span><span class="si">%d</span><span class="s1"> none items&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_Nones</span><span class="p">,))</span>
                    <span class="c1">#ut.assert_all_not_None(new_extern_rowids)</span>
                    <span class="n">new_extern_rowid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_extern_rowids</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">colx</span><span class="p">,</span> <span class="n">new_extern_rowids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">extern_colx_list</span><span class="p">,</span> <span class="n">new_extern_rowid_list</span><span class="p">):</span>
                    <span class="n">modified_column_list_</span><span class="p">[</span><span class="n">colx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_extern_rowids</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">modified_column_list_</span> <span class="o">=</span> <span class="n">valid_column_list_</span>

            <span class="c1"># ================================</span>
            <span class="c1"># Merge into db with add_cleanly</span>
            <span class="c1"># ================================</span>
            <span class="n">superkey_colnames_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_superkey_colnames</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">superkey_paramxs_list</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">column_names_</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">superkey</span><span class="p">))</span> <span class="k">for</span> <span class="n">superkey</span> <span class="ow">in</span>  <span class="n">superkey_colnames</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">superkey_colnames</span> <span class="ow">in</span> <span class="n">superkey_colnames_list</span>
                <span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;column_names_&#39;</span><span class="p">,</span> <span class="s1">&#39;superkey_colnames_list&#39;</span><span class="p">])</span>
                <span class="k">raise</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">superkey_colnames_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># FIXME: Rectify duplicate code</span>
                <span class="n">primary_superkey</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_metadata_val</span><span class="p">(</span>
                    <span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_primary_superkey&#39;</span><span class="p">,</span> <span class="n">eval_</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">primary_superkey</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                        <span class="p">(</span><span class="s1">&#39;tablename=</span><span class="si">%r</span><span class="s1"> has multiple superkey_colnames_list=</span><span class="si">%r</span><span class="s1">, &#39;</span>
                         <span class="s1">&#39;but no primary superkey. &#39;</span>
                         <span class="s1">&#39;A primary superkey is required&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">superkey_colnames_list</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">superkey_index</span> <span class="o">=</span> <span class="n">superkey_colnames_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">primary_superkey</span><span class="p">)</span>
                    <span class="n">superkey_paramx</span> <span class="o">=</span> <span class="n">superkey_paramxs_list</span><span class="p">[</span><span class="n">superkey_index</span><span class="p">]</span>
                    <span class="n">superkey_colnames</span> <span class="o">=</span> <span class="n">superkey_colnames_list</span><span class="p">[</span><span class="n">superkey_index</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">superkey_colnames_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="n">superkey_paramx</span> <span class="o">=</span> <span class="n">superkey_paramxs_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">superkey_colnames</span> <span class="o">=</span> <span class="n">superkey_colnames_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">params_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">modified_column_list_</span><span class="p">))</span>
            <span class="k">def</span> <span class="nf">get_rowid_from_superkey</span><span class="p">(</span><span class="o">*</span><span class="n">superkey_column_list</span><span class="p">):</span>
                <span class="n">superkey_params_iter</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">superkey_column_list</span><span class="p">)</span>
                <span class="n">rowid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_rowid_from_superkey</span><span class="p">(</span>
                    <span class="n">tablename</span><span class="p">,</span> <span class="n">superkey_params_iter</span><span class="p">,</span> <span class="n">superkey_colnames</span><span class="o">=</span><span class="n">superkey_colnames</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">rowid</span>

            <span class="c1"># TODO: allow for cetrain databases to take precidence over another</span>
            <span class="c1"># basically allow insert or replace</span>
            <span class="n">new_rowid_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">add_cleanly</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">column_names_</span><span class="p">,</span>
                                            <span class="n">params_iter</span><span class="p">,</span>
                                            <span class="n">get_rowid_from_superkey</span><span class="o">=</span><span class="n">get_rowid_from_superkey</span><span class="p">,</span>
                                            <span class="n">superkey_paramx</span><span class="o">=</span><span class="n">superkey_paramx</span><span class="p">)</span>
            <span class="c1"># TODO: Use mapping generated here for new rowids</span>
            <span class="n">old_rowids_to_new_roids</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">valid_old_rowid_list</span><span class="p">,</span> <span class="n">new_rowid_list</span><span class="p">))</span>  <span class="c1"># NOQA</span>
            <span class="c1">#tablename_to_rowidmap[tablename] = old_rowids_to_new_roids</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_csv"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_csv">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_csv</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot; Conveinience: Converts a tablename to csv format</span>

<span class="sd">        Args:</span>
<span class="sd">            tablename (str):</span>
<span class="sd">            exclude_columns (list):</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: csv_table</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --test-get_table_csv</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --exec-get_table_csv --tablename=contributors</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.control.SQLDatabaseControl import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; tablename = ut.get_argval(&#39;--tablename&#39;, type_=str, default=ibeis.const.NAME_TABLE)</span>
<span class="sd">            &gt;&gt;&gt; db = ibs.db</span>
<span class="sd">            &gt;&gt;&gt; exclude_columns = []</span>
<span class="sd">            &gt;&gt;&gt; csv_table = db.get_table_csv(tablename, exclude_columns)</span>
<span class="sd">            &gt;&gt;&gt; # verify results</span>
<span class="sd">            &gt;&gt;&gt; result = str(csv_table)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#=None, column_list=[], header=&#39;&#39;, column_type=None</span>
        <span class="n">column_list</span><span class="p">,</span> <span class="n">column_names</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_column_data</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="p">)</span>
        <span class="c1"># remove column prefix for more compact csvs</span>
        <span class="n">column_lbls</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tablename</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_csv_header</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">csv_table</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_csv_table</span><span class="p">(</span><span class="n">column_list</span><span class="p">,</span> <span class="n">column_lbls</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">csv_table</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.print_table_csv"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.print_table_csv">[docs]</a>    <span class="k">def</span> <span class="nf">print_table_csv</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">))</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_csv_header"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_csv_header">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_csv_header</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="n">column_nametypes</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">tablename</span><span class="p">),</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_types</span><span class="p">(</span><span class="n">tablename</span><span class="p">))</span>
        <span class="n">header_constraints</span> <span class="o">=</span> <span class="s1">&#39;# CONSTRAINTS: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_constraints</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">header_name</span>  <span class="o">=</span> <span class="s1">&#39;# TABLENAME: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tablename</span>
        <span class="n">header_types</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">indentjoin</span><span class="p">(</span><span class="n">column_nametypes</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># &#39;</span><span class="p">)</span>
        <span class="n">header_doc</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">indentjoin</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unindent</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_docstr</span><span class="p">(</span><span class="n">tablename</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># &#39;</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">header_doc</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">header_name</span> <span class="o">+</span> <span class="n">header_types</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">header_constraints</span>
        <span class="k">return</span> <span class="n">header</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.print_schema"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.print_schema">[docs]</a>    <span class="k">def</span> <span class="nf">print_schema</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv_header</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.view_db_in_external_reader"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.view_db_in_external_reader">[docs]</a>    <span class="k">def</span> <span class="nf">view_db_in_external_reader</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="n">known_readers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sqlitebrowser&#39;</span><span class="p">,</span> <span class="s1">&#39;sqliteman&#39;</span><span class="p">]</span>
        <span class="n">sqlite3_reader</span> <span class="o">=</span> <span class="n">known_readers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sqlite3_db_fpath</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_fpath</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">sqlite3_reader</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">sqlite3_db_fpath</span><span class="p">)</span>
        <span class="c1">#ut.cmd(sqlite3_reader, sqlite3_db_fpath)</span>
        <span class="k">pass</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.set_db_version"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.set_db_version">[docs]</a>    <span class="k">def</span> <span class="nf">set_db_version</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="c1"># Do things properly, get the metadata_rowid (best because we want to assert anyway)</span>
        <span class="n">metadata_key_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;database_version&#39;</span><span class="p">]</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">metadata_key</span><span class="p">,)</span> <span class="k">for</span> <span class="n">metadata_key</span> <span class="ow">in</span> <span class="n">metadata_key_list</span><span class="p">)</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="s1">&#39;metadata_key=?&#39;</span>
        <span class="c1"># list of relationships for each image</span>
        <span class="n">metadata_rowid_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span>
                                           <span class="p">(</span><span class="s1">&#39;metadata_rowid&#39;</span><span class="p">,),</span> <span class="n">params_iter</span><span class="p">,</span>
                                           <span class="n">where_clause</span><span class="p">,</span> <span class="n">unpack_scalars</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_rowid_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;duplicate database_version keys in database&#39;</span>
        <span class="n">id_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">metadata_rowid</span><span class="p">,)</span> <span class="k">for</span> <span class="n">metadata_rowid</span> <span class="ow">in</span> <span class="n">metadata_rowid_list</span><span class="p">)</span>
        <span class="n">val_list</span> <span class="o">=</span> <span class="p">((</span><span class="n">_</span><span class="p">,)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">[</span><span class="n">version</span><span class="p">])</span>
        <span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;metadata_value&#39;</span><span class="p">,),</span> <span class="n">val_list</span><span class="p">,</span> <span class="n">id_iter</span><span class="p">)</span>
</div>
    <span class="nd">@default_decor</span>
<div class="viewcode-block" id="SQLDatabaseController.get_sql_version"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_sql_version">[docs]</a>    <span class="k">def</span> <span class="nf">get_sql_version</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conveinience &quot;&quot;&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT sqlite_version()&#39;</span><span class="p">)</span>
        <span class="n">sql_version</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] SELECT sqlite_version = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sql_version</span><span class="p">,))</span>
        <span class="c1"># The version number sqlite3 module. NOT the version of SQLite library.</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] sqlite3.version = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lite</span><span class="o">.</span><span class="n">version</span><span class="p">,))</span>
        <span class="c1"># The version of the SQLite library</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[sql] sqlite3.sqlite_version = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lite</span><span class="o">.</span><span class="n">sqlite_version</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">sql_version</span>
</div></div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.control.SQLDatabaseControl</span>
<span class="sd">        python -m ibeis.control.SQLDatabaseControl --allexamples</span>
<span class="sd">        python -m ibeis.control.SQLDatabaseControl --allexamples --verbtest</span>
<span class="sd">        python -m ibeis.control.SQLDatabaseControl --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c1"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Jon Crall.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.5.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>