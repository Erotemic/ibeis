{% extends "layout.html" %}
{% block content %}
  {% if finished %}
  <div class="alert alert-info text-center" role="alert">
    Congratulations, turking is completed.  Thank you!
  </div>
  {% else %}
  <div class="row">
    <div class="col-lg-1"></div>
    
    <div class="col-lg-10">
      Gid: {{ gid }}
      <br/>
      Species: {{ species }}
      <span class="glyphicon glyphicon-info-sign pull-right" data-toggle="modal" data-target="#turk-instructions"></span>
      <br/>
      Path: {{ image_path }}
      <div id="bbox_annotator"></div>
      <br/>
      <form method="post" action="/submit/detection.html" id="detection-form">
        <input type="text" name="detection-gid" value="{{ gid }}" style="display: none;" readonly>
        <input type="submit" name="detection-submit" id="turk-submit-skip"   class="btn btn-default pull-left"  value="Skip">
        <input type="submit" name="detection-submit" id="turk-submit-accept" class="btn btn-primary pull-right" value="Accept">
        <textarea id="detection_data" name="detection-annotations" style="font-family:monospace; margin-top:30px;width: 100%; height: 100px; display: none;" readonly="" form="detection-form"></textarea>
      </form>
    </div>

    <div class="col-lg-1"></div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="turk-instructions" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
          <h4 class="modal-title" id="myModalLabel">Detection Review Turking Instructions</h4>
        </div>
        <div class="modal-body">
          To review the detections for an image, simply draw new rectangle bounding boxes (annotations) around animals that are missing annotations and delete annotations that should not exist based on the following guidelines:
          <br/>
          <br/>
          <ul style="padding-right:30px;">
            <li>
              A new annotation can be added by dragging the mouse cursor around the animal like a selection.  To perform a selection, click the left mouse button down on the top left corner where the annotation should <i>start</i>, <i>drag</i> the mouse to the bottom right corner where the annotation should <i>end</i>, and release the left mouse button to add the annotation.  
            </li>
            <li>
              You can <b>always</b> add a new annotation by <b>double clicking</b>.  This is particularly helpful when adding an annotation on top (inside) of a current annotation.
              <br/>
              <i>For example:</i>
            </li>
<!--
            <div class="row">
              <div class="col-lg-2"></div>
              <div class="col-lg-8" style="margin-top: 20px;">
                <img src="{{ url_for('static', filename='images/example-detection1.jpg') }}" style="width: 100%; margin-bottom: 5px;">
                <p>This image has no annotations and one should be added around the animal.  Once the annotation has been added, simply save the new annotation by clicking Accept.</p>
              </div>
              <div class="col-lg-2"></div>
            </div>
            <div class="row">
              <div class="col-lg-2"></div>
              <div class="col-lg-8" style="margin-top: 20px;">
                <img src="{{ url_for('static', filename='images/example-detection2.jpg') }}" style="width: 100%; margin-bottom: 5px;">
                <p>This image has one (correct) annotation and nothing should be done.  The correct action is to click Accept to mark the image has having been processed correctly. </p>
              </div>
              <div class="col-lg-2"></div>
            </div>
-->
            <li>When an annotation is highlighted (by hovering the mouse cursor over the annotation), the bounding box will turn orange and the following actions will become available:
              <ul>
                <li><u>Translation</u> - by dragging the mouse an annotation can be moved.  An annotation can also be moved (when highlighted) by using the arrow keys on the keyboard.  When using the arrow keys, an annotation will be moved 1 pixel at a time.  When the <b>Shift</b> key is held, the annotation is moved 10 pixels at a time.</li>
                <li><u>Scaling</u> - by dragging one of the 8 anchors an annotation can be resized.  If the <b>Shift</b> key is held, the annotation's aspect ratio is preserved.</li>
                <li><u>Rotation</u> - by dragging on the <div class="ui-widget-content annotated_bounding_box ui-resizable ui-draggable ui-draggable-handle annotated_bounding_box_active" style="width: 16px; display: inline-block; border:none;"><div class="ui-rotatable-handle ui-draggable" style="display: block; margin-left: -6px; top: -10px;"></div></div> rotation anchor an annotation can be rotated.  If the <b>Shift</b> key is held, the annotation's angle is constrained to increments of 45 degrees.</li>
                <li><u>Deletion</u> - by clicking on the <span style="position: relative; display: inline-block; margin-bottom: -5px; margin-right: -2px; width: 20px; height: 0px; padding: 16px 0px 0px; overflow: visible; color: rgb(255, 255, 255); border: 2px solid rgb(255, 255, 255); border-top-left-radius: 18px; border-top-right-radius: 18px; border-bottom-right-radius: 18px; border-bottom-left-radius: 18px; cursor: pointer; -webkit-user-select: none; text-align: center; background-color: rgb(0, 51, 0);"><div style="display: block; text-align: center; width: 16px; position: absolute; top: -2px; left: 0px; font-size: 16px; line-height: 16px; font-family: 'Helvetica Neue', Consolas, Verdana, Tahoma, Calibri, Helvetica, Menlo, 'Droid Sans', sans-serif;">Ã—</div></span> button an annotation can be deleted.  An annotation can also be deleted (when highlighted) by hitting the <b>Esc</b> key.</li>
                <li><u>Send to Back</u> - when an annotation is highlighted, pressing the <b>b</b> key will send the annotation to the "back".  This is useful (or required) when a large annotation is covering a smaller annotation and makes highlighting the smaller annotation difficult (or impossible).</li>
              </ul>
              <br/>
            </li>
            <li><b>It is vitally important that only animals that belong to the species are annotated - at the top of every image, the species will be specified.</b></li>
            <li>Always annotate the animals regardless of viewpoint.</li>
            <li>A new, in-progress annotation selection can be cancelled by pressing the <b>Esc</b> key.</li>
            <li>The <b>Space</b> key skips the image and does not save any viewpoint information for that image.  The <b>Enter</b> key submits all current annotations.</li>
            <li>Review annotations as fast as you can while maintaining perfect accuracy.</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal">Got it!</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endblock %}
{% block content_custom_javascript %}  
<script src="{{ url_for('static', filename='javascript/turk.js') }}"></script>
<script src="{{ url_for('static', filename='include/bbox_annotator.js') }}"></script>
<script type="text/javascript">  
  $(document).ready(function() {
    // Initialize the bounding-box annotator.
    var annotator = new BBoxAnnotator({
      url: "{{ image_src }}",
      input_method: 'fixed',
      show_label: true,
      labels: ['{{ species }}'],
      onchange: function(entries) {
        $('#detection_data').text(JSON.stringify(entries, null, "  "));
      }
    });

    {% for annot in annotation_list %}
      annotator.add_entry({
        left:   {{ annot['left'] }}, 
        top:    {{ annot['top'] }},
        width:  {{ annot['width'] }},
        height: {{ annot['height'] }},
        label:  '{{ annot['label'] }}',
        angle:  {{ annot['angle'] }},
      });
    {% endfor %}
    
    annotator.refresh();
  });
</script>  
{% endblock %}
