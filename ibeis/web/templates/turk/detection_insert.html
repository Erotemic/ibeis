<div class="ia-container">

  {% if EMBEDDED_CSS %}
    {{ EMBEDDED_CSS|safe }}
  {% endif %}

  <div class="row">

    <div class="col-lg-4 col-md-4 col-sm-4">
        <div style="text-align: left; margin-top: 28px;">
          <input type="checkbox" id="ia-detection-annotation-mode-parts-assignments" checked>
          <i> Show Part Assignments</i>
        </div>
    </div>
    <div class="col-lg-4 col-md-4 col-sm-4">
        <div style="text-align: center; margin-top: 10px; margin-bottom: 2px;">
          <!-- <input type="checkbox" id="ia-detection-annotation-mode-toggle" checked> -->
          <input type="checkbox" id="ia-detection-annotation-mode-toggle" data-width="150">
          <br/>
          <div id="ia-detection-annotation-mode-toggle-label" style="font-size: 10px; margin: 0px; line-height: 10px;">Annotation</div>
        </div>
    </div>
    <div class="col-lg-4 col-md-4 col-sm-4">
        <div style="text-align: right; margin-top: 8px;">
          <i>Always Show Parts</i>
          <input type="checkbox" id="ia-detection-annotation-mode-parts-show"><br/>
          <i>Always Hide Parts</i>
          <input type="checkbox" id="ia-detection-annotation-mode-parts-hide">
        </div>
    </div>
  </div>

  <form class="ia-form" method="{{ callback_method }}" action="{{ callback_url }}{% if REFER_DST_STR %}&refer={{ REFER_DST_ENCODED }}{% endif %}" onsubmit="return check_form();" id="ia-detection-form">
    <div id="ia-bbox-annotator-container"></div>
    <div style="text-align: center; color: #aaa;">
      <span>hover to highlight (orange) an annotation, press <b>b</b> to send an annotation to the back, click the dark <b>X</b> button, <b>Esc</b>, <b>k</b>, or the <b>Delete</b> key to delete</a></span>
      <br/>
      <span>right-click to focus (red) an annotation and edit its metadata below, click the green check button or press the delete keys to unfocus</span>
    </div>
    <br/>
    <input type="text" name="detection-gid" value="{{ gid }}" style="display: none;" readonly>
    <input type="text" name="detection-image-uuid" value="{{ image_uuid }}" style="display: none;" readonly>
    <div class="row">
      <div class="col-lg-2"></div>
      <div class="col-lg-8" style="text-align:center;">
        {% if REFER_DST_STR and refer_aid %}
          <a href="/{{ REFER_DST_STR }}&aid={{ refer_aid }}" class="btn btn-default" style="margin-left:auto; margin-right: auto;">Nevermind, take me back...</a>
        {% endif %}
      </div>
      <div class="col-lg-2"></div>
    </div>

    <div class="row" style="margin-bottom: 20px">
      <div class="col-lg-4 col-md-4 col-sm-4"></div>

      <div class="col-lg-4 col-md-4 col-sm-4" style="text-align: center">
        <span id="ia-metadata-badge-annotation" class="badge" style="margin-right: -5px; border-top-right-radius: 0; border-bottom-right-radius: 0;">Annotation</span>
        <span id="ia-metadata-badge-part" class="badge" style="border-top-left-radius: 0;border-bottom-left-radius: 0;">Part</span>
      </div>

      <div class="col-lg-4 col-md-4 col-sm-4">
        {% if previous %}
          <a class="btn btn-default pull-left" id="ia-turk-previous" href="{{ url_for('turk_detection') }}?imgsetid={{ imgsetid }}&gid={{ previous }}">Previous {{ previous }}</a>
        {% endif %}
        <input type="submit" name="detection-submit" id="ia-turk-submit-accept" class="btn btn-primary pull-right" value="Accept">
        {% if not EMBEDDED_JAVASCRIPT %}
          <input type="submit" name="detection-submit" id="ia-turk-submit-clear"  class="btn btn-warning pull-right" value="Clear" style="margin-right: 15px;">
          <!-- <input type="submit" name="detection-submit" id="ia-turk-submit-delete" class="btn btn-danger pull-right" value="Delete" style="margin-right: 15px;" onclick="return confirm('Are you sure you want to delete this image?')"> -->
        {% endif %}
      </div>
    </div>

    <div id="ia-metadata-panel-container" style="position: relative; width: 100%;">
      <div id="ia-metadata-panel-annotation" style="position: absolute; width: 100%;">
        Viewpoint: <span id="ia-viewpoint-label-degrees"></span> Degrees | Radians: <span id="ia-viewpoint-label-radians1"></span> (&pi; * <span id="ia-viewpoint-label-radians2"></span>) | Label: <span id="ia-viewpoint-label-text"></span>
        <span id="ia-detection-form-annotation-warning" class="pull-right" style="color: #ac2925;"><i>focus an annotation to edit these values</i></span>
        <br/>
        <input id="ia-detection-annotation-viewpoint" class="ia-detection-form-annotation-value" type="range" name="ia-viewpoint-value" value="{% if viewpoint_value %}{{ viewpoint_value }}{% else %}0{% endif %}" min="0" max="359" style="margin-bottom:5px;" onchange="update_label();" oninput="update_label();"> <!-- onchange- IE, oninput-Everything Else -->
        <div class="row-custom-expand">
          <div class="col-custom-span col-custom-span-9"><span class="glyphicon glyphicon-arrow-left"            ></span></div>
          <div class="col-custom-span col-custom-span-9"><span class="glyphicon glyphicon-arrow-down rotate-45"  ></span></div>
          <div class="col-custom-span col-custom-span-9"><span class="glyphicon glyphicon-arrow-down"            ></span></div>
          <div class="col-custom-span col-custom-span-9"><span class="glyphicon glyphicon-arrow-right rotate-45"  ></span></div>
          <div class="col-custom-span col-custom-span-9"><span class="glyphicon glyphicon-arrow-right"           ></span></div>
          <div class="col-custom-span col-custom-span-9"><span class="glyphicon glyphicon-arrow-up rotate-45" ></span></div>
          <div class="col-custom-span col-custom-span-9"><span class="glyphicon glyphicon-arrow-up"              ></span></div>
          <div class="col-custom-span col-custom-span-9"><span class="glyphicon glyphicon-arrow-left rotate-45"    ></span></div>
        </div>
        <br/>
        <div class="row">
          <div class="col-lg-6 col-md-6 col-sm-6">
            Quality: <span id="ia-quality-label-value"></span> | Label: <span id="ia-quality-label-text"></span>
            <input id="ia-detection-annotation-quality" class="ia-detection-form-annotation-value" type="range" name="ia-quality-value" value="{% if quality_value %}{{ quality_value }}{% else %}2{% endif %}" min="1" max="2" style="margin-bottom:5px;" onchange="update_label();" oninput="update_label();"> <!-- onchange- IE, oninput-Everything Else -->
            <div class="row-custom-expand">
              <div class="col-custom-span col-custom-span-2">
                <span class="glyphicon glyphicon-remove"></span>
              </div>
              <div class="col-custom-span col-custom-span-2">
                <span class="glyphicon glyphicon-ok"></span>
              </div>
            </div>
          </div>
          <div class="col-lg-6 col-md-6 col-sm-6">
              <div class="checkbox pull-right">
                <label>
                  <input id="ia-detection-annotation-multiple" class="ia-detection-form-annotation-value" name="ia-multiple-value" type="checkbox"> Multiple animals in image
                  <br/>
                  <input id="ia-detection-annotation-interest" class="ia-detection-form-annotation-value" name="ia-interest-value" type="checkbox"> Object of Interest
                </label>
              </div>
          </div>
        </div>

        <div class="row" style="margin-top: 20px;">
          <div class="col-lg-4">
            Species:
            <select id="ia-detection-annotation-class"  class="form-control ia-detection-form-annotation-value" name="ia-species-value" style="width: 200px;">
              {% for species_nice, species_text in species_list %}
                <option value="{{ species_text }}">{{ species_nice }}</option>
              {% endfor %}
            </select>
            <span class="pull-left" data-toggle="modal" data-target="#species-add" style="color: #aaa; cursor: pointer;"><i>Add Species</i></span>
            <br/>
          </div>

          <div class="col-lg-4"></div>
          <div class="col-lg-4"></div>
        </div>
      </div>

      <div id="ia-metadata-panel-part" style="position: absolute; width: 100%;">
        <div class="row">
          <div class="col-lg-6 col-md-6 col-sm-6">
            Quality: <span id="ia-quality-label-value"></span> | Label: <span id="ia-quality-label-text"></span>
            <input id="ia-detection-part-quality" class="ia-detection-form-part-value" type="range" name="ia-quality-value" value="{% if quality_value %}{{ quality_value }}{% else %}2{% endif %}" min="1" max="2" style="margin-bottom:5px;" onchange="update_label();" oninput="update_label();"> <!-- onchange- IE, oninput-Everything Else -->
            <div class="row-custom-expand">
              <div class="col-custom-span col-custom-span-2">
                <span class="glyphicon glyphicon-remove"></span>
              </div>
              <div class="col-custom-span col-custom-span-2">
                <span class="glyphicon glyphicon-ok"></span>
              </div>
            </div>
          </div>
          <div class="col-lg-6 col-md-6 col-sm-6">
            <span id="ia-detection-form-part-warning" class="pull-right" style="color: #ac2925;"><i>focus a part to edit these values</i></span>
          </div>
        </div>

        <div class="row" style="margin-top: 20px;">
          <div class="col-lg-4">
            Part:
            <select id="ia-detection-part-class" class="form-control ia-detection-form-part-value"  name="ia-part-value" style="width: 200px;">
              {% for species_nice, species_text in species_list %}
                <option value="{{ species_text }}">{{ species_nice }}</option>
              {% endfor %}
            </select>
            <span class="pull-left" data-toggle="modal" data-target="#part-add" style="color: #aaa; cursor: pointer;"><i>Add Part</i></span>
          </div>

          <div class="col-lg-4"></div>

          <div class="col-lg-4"></div>
        </div>
      </div>
    </div>

    <textarea id="ia-detection-data" name="detection-annotations" style="font-family:monospace; margin-top:30px;width: 100%; height: 100px; display: none;" readonly="" form="ia-detection-form"></textarea>
  </form>

  {% if EMBEDDED_JAVASCRIPT %}
    {{ EMBEDDED_JAVASCRIPT|safe }}
  {% else %}
    <script src="{{ url_for('static', filename='javascript/turk-detection.js') }}" ia-dependency="javascript"></script>
    <script src="{{ url_for('static', filename='include/bbox_annotator_percent.js') }}" ia-dependency="javascript"></script>
  {% endif %}

  <script type="text/javascript" ia-dependency="javascript">
    var bba

    function check_form(){
        if(bba.entries.length == 0) {
          return true
        }
        for (var index = 0; index < bba.entries.length; index++) {
            if(bba.entries[index].highlighted) {
              return true
            }
        }
        alert('There are no highlighted annotations.\nPlease select at least one annotation of interest')
        return false
    }

    function update_metadata_panel(state) {
        var css_active, css_inactive

        css_active = {
          "background-color": "#286090",
          "color": "#FFFFFF",
          "border": "1px solid #286090",
        }
        css_inactive = {
          "background-color": "#FFFFFF",
          "color": "#333333",
          "border": "1px solid #333333",
        }

        if (state == "annotation") {
          active_ids = ["#ia-metadata-badge-annotation"]
          inactive_ids = ["#ia-metadata-badge-part"]
          visible_ids = ['#ia-metadata-panel-annotation']
          hidden_ids = ['#ia-metadata-panel-part']
        } else if(state == "part") {
          active_ids = ["#ia-metadata-badge-part"]
          inactive_ids = ["#ia-metadata-badge-annotation"]
          visible_ids = ['#ia-metadata-panel-part']
          hidden_ids = ['#ia-metadata-panel-annotation']
        } else {
          active_ids = []
          inactive_ids = ["#ia-metadata-badge-annotation", "#ia-metadata-badge-part"]
          visible_ids = []
          hidden_ids = ['#ia-metadata-panel-annotation', '#ia-metadata-panel-part']
        }

        for(var index = 0; index < active_ids.length; index++) {
         $(active_ids[index]).css(css_active)
        }
        for(var index = 0; index < inactive_ids.length; index++) {
         $(inactive_ids[index]).css(css_inactive)
        }
        for(var index = 0; index < visible_ids.length; index++) {
         $(visible_ids[index]).show()
        }
        for(var index = 0; index < hidden_ids.length; index++) {
         $(hidden_ids[index]).hide()
        }

        fix_metadata_panels();
    }

    function enable_metadata_annotations() {
      $('#ia-detection-annotation-viewpoint').prop("disabled", false);
      $('#ia-detection-annotation-quality').prop("disabled", false);
      $('#ia-detection-annotation-multiple').prop("disabled", false);
      $('#ia-detection-annotation-interest').prop("disabled", false);
      $('#ia-detection-class').prop("disabled", false);
      $('span[data-target="#species-add"]').css("visibility", "visible");
      $("#ia-metadata-panel-annotation").css("color", "#000");
      $("#ia-detection-form-annotation-warning").css("visibility", "hidden");
    }

    function disable_metadata_annotations() {
      $('#ia-detection-annotation-viewpoint').prop("disabled", true);
      $('#ia-detection-annotation-quality').prop("disabled", true);
      $('#ia-detection-annotation-multiple').prop("disabled", true);
      $('#ia-detection-annotation-interest').prop("disabled", true);
      $('#ia-detection-class').prop("disabled", true);
      $('span[data-target="#species-add"]').css("visibility", "hidden");
      $("#ia-metadata-panel-annotation").css("color", "#777");
      $("#ia-detection-form-annotation-warning").css("visibility", "visible");
    }

    function enable_metadata_parts() {
      $('#ia-detection-part-quality').prop("disabled", false);
      $('#ia-detection-part').prop("disabled", false);
      $('span[data-target="#part-add"]').css("visibility", "visible");
      $("#ia-metadata-panel-part").css("color", "#000");
      $("#ia-detection-form-part-warning").css("visibility", "hidden");
    }

    function disable_metadata_parts() {
      $('#ia-detection-part-quality').prop("disabled", true);
      $('#ia-detection-part').prop("disabled", true);
      $('span[data-target="#part-add"]').css("visibility", "hidden");
      $("#ia-metadata-panel-part").css("color", "#777");
      $("#ia-detection-form-part-warning").css("visibility", "visible");
    }

    function show_annotation_metadata(entry) {
      console.log('ANNOTATION METADATA')
      console.log(entry)
      if(entry.metadata.viewpoint != -1) {
        $('#ia-detection-annotation-viewpoint').val(entry.metadata.viewpoint);
      }
      if(entry.metadata.quality != -1) {
        $('#ia-detection-annotation-quality').val(entry.metadata.quality);
      }
      $('#ia-detection-annotation-class option[value="' + entry.metadata.species + '"]').prop("selected", true);
      $('#ia-detection-annotation-multiple').prop("checked", entry.metadata.multiple);
      $('#ia-detection-annotation-interest').prop("checked", entry.highlighted);
      update_label();
    }

    function fix_metadata_panels() {
      x = $('#ia-metadata-panel-annotation').height()
      y = $('#ia-metadata-panel-part').height()
      height = Math.max(x, y)
      $('#ia-metadata-panel-container').css({
        "height": height,
      })
    }

    $(document).ready(function() {
      var toggle;
      var states;

      states = {
        annotations: false,
        parts: true,
      }

      $(window).bind("resize", function() {
          fix_metadata_panels()
      })

      // Initialize the bounding-box annotator.
      bba = new BBoxAnnotator("{{ image_src }}", {
        prefix: "ia-",
        colors: {
          anchor: "#FFFFFF",
        },
        subentries: {
          assignments: true,
        },
        onchange: function(entries) {
          $('#ia-detection-data').text(JSON.stringify(entries, null, "  "));
        },
        onhover: function(index, entry) {
          if(index == null || entry == null) {
            hotkeys_disabled = true;
            update_metadata_panel();
            return
          }
          if(entry.parent == null) {
            update_metadata_panel("annotation");
            show_annotation_metadata(entry)
          } else {
            update_metadata_panel("part");
          }
          hotkeys_disabled = false;
        },
        onselector: function() {
          if(bba.state.focus == null) {
            update_metadata_panel("annotation");
          } else {
            update_metadata_panel("part");
          }
        },
        onfocus: function(index, entry) {
          // if(index == null || entry == null) {
          //   return
          // }

          if(entry == null) {
            disable_metadata_annotations()
            disable_metadata_parts()
          } else {
            if (entry.parent == null) {
              enable_metadata_annotations()
              disable_metadata_parts()
            } else {
              enable_metadata_parts()
            }
          }

          checked_mode = $("#ia-detection-annotation-mode-toggle").prop("checked");

          if(bba.state.focus == null) {
            $("#ia-detection-annotation-mode-toggle-label").html("Annotations")
            wanted_mode = states.annotations
          } else {
            $("#ia-detection-annotation-mode-toggle-label").html("Parts")
            wanted_mode = states.parts
          }

          if(wanted_mode) {
            $('#ia-detection-annotation-mode-toggle').bootstrapToggle('on')
          } else {
            $('#ia-detection-annotation-mode-toggle').bootstrapToggle('off')
          }
        },
      });

      // Add pre-existing annotations as entries
      {% for annot in annotation_list %}
        bba.add_entry({
          label:    '{{ annot['id'] }}',
          percent:  {
            left:      {{ annot['left'] }},
            top:       {{ annot['top'] }},
            width:     {{ annot['width'] }},
            height:    {{ annot['height'] }},
          },
          angles:   {
            theta:     {{ annot['theta'] }},
          },
          metadata: {
            species:   '{{ annot['species'] }}',
            viewpoint: {{ annot['viewpoint'] }},
            quality:   {{ annot['quality'] }},
            multiple:  {{ annot['multiple'] }},
          },
        });
      {% endfor %}

      // Add pre-existing annotations as entries
      {% for annot in annotation_list %}
        bba.add_entry({
          parent:   {{ annotation_list.index(annot) }},
          percent:  {
            left:      {{   5 + annot['left'] }},
            top:       {{   5 + annot['top'] }},
            width:     {{ 0.5 * annot['width'] }},
            height:    {{ 0.5 * annot['height'] }},
          },
          angles:   {
            theta:     {{ annot['theta'] }},
          },
          metadata: {},
        });
      {% endfor %}

      // Update metadata labels for form inputs
      update_label();
      disable_metadata_annotations();
      disable_metadata_parts();
      update_metadata_panel();
      fix_metadata_panels();

      // Create the toggle's user interaction
      toggle = $('#ia-detection-annotation-mode-toggle');

      toggle.bootstrapToggle({
        on: 'Axis-to-Axis',
        off: 'Corner-to-Corner',
        onstyle: 'primary',
        offstyle: 'primary'
      });

      $("#ia-detection-annotation-mode-toggle").change(function() {
        var checked_mode, checked_tag;
        checked_mode = $(this).prop("checked");

        // Save the mode
        if(bba.state.focus == null) {
          states.annotations = checked_mode
        } else {
          states.parts = checked_mode
        }

        console.log(states)

        checked_tag = checked_mode ? "diagonal": "rectangle";
        bba.update_mode(checked_tag);
      });

      $("#ia-detection-annotation-mode-parts-assignments").change(function() {
        var checked_mode, checked_tag;

        checked_mode = $(this).prop("checked");
        checked_tag = checked_mode ? true : null;
        bba.update_subentries_assignments(checked_tag);
      });

      $("#ia-detection-annotation-mode-parts-show").change(function() {
        var checked_mode, checked_tag

        checked_mode = $(this).prop("checked");
        if(checked_mode) {
          $('#ia-detection-annotation-mode-parts-hide').prop('checked', false);
        }
        checked_tag = checked_mode ? true : null;
        bba.update_subentries_visible(checked_tag);
      });

      $("#ia-detection-annotation-mode-parts-hide").change(function() {
        var checked_mode, checked_tag

        checked_mode = $(this).prop("checked");
        if(checked_mode) {
          $('#ia-detection-annotation-mode-parts-show').prop('checked', false);
        }
        checked_tag = checked_mode ? false : null;
        bba.update_subentries_visible(checked_tag);
      });

      $(".ia-detection-form-annotation-value").change(function(e)
      {
        metadata = bba.get_metadata()
        if(metadata == null) {
          return
        }
        metadata.viewpoint = $('#ia-detection-annotation-viewpoint').val();
        metadata.quality   = $('#ia-detection-annotation-quality').val();
        metadata.species   = $('#ia-detection-annotation-class').find("option:selected").val();
        metadata.multiple  = $('#ia-detection-annotation-multiple').is(":checked")
        bba.set_metadata(metadata)
        // Set highlighted
        bba.set_highlighted($('#ia-detection-annotation-interest').is(":checked"))
      });

      $(".ia-detection-form-part-value").change(function(e)
      {
        metadata = bba.get_metadata()
        if(metadata == null) {
          return
        }
        metadata.quality   = $('#ia-detection-part-quality').val();
        metadata.part      = $('#ia-detection-part-class').find("option:selected").val();
        bba.set_metadata(metadata)
      });

      {% if display_instructions %}
        // $('#turk-instructions').modal('show');
      {% endif %}

      {% if display_species_examples %}
        // $('#turk-class-examples').modal('show');
      {% endif %}
    });
  </script>
</div>