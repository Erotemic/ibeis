<div class="ia-container">

  {% if EMBEDDED_CSS %}
    {{ EMBEDDED_CSS|safe }}
  {% endif %}

  <div style="text-align: center; margin: 10px 0px;">
    <!-- <input type="checkbox" id="ia-detection-annotation-mode-toggle" checked> -->
    <input type="checkbox" id="ia-detection-annotation-mode-toggle">
  </div>
  <form class="ia-form" method="{{ callback_method }}" action="{{ callback_url }}{% if REFER_DST_STR %}&refer={{ REFER_DST_ENCODED }}{% endif %}" id="ia-detection-form">
    <div id="ia-bbox-annotator-container"></div>
    <div style="text-align: center; color: #aaa;">
      <span>hover to highlight (orange) an annotation, press <b>b</b> to send an annotation to the back, click the dark X button, <b>Esc</b>, <b>k</b>, or the <b>Delete</b> key to delete</a></span>
      <br/>
      <span>click to focus (red) an annotation and edit its metadata below, click the green check button or press the delete keys to unfocus</span>
    </div>
    <br/>
    <input type="text" name="detection-gid" value="{{ gid }}" style="display: none;" readonly>
    <input type="text" name="detection-image-uuid" value="{{ image_uuid }}" style="display: none;" readonly>
    <div class="row">
      <div class="col-lg-2"></div>
      <div class="col-lg-8" style="text-align:center;">
        {% if REFER_DST_STR and refer_aid %}
          <a href="/{{ REFER_DST_STR }}&aid={{ refer_aid }}" class="btn btn-default" style="margin-left:auto; margin-right: auto;">Nevermind, take me back...</a>
        {% endif %}
      </div>
      <div class="col-lg-2"></div>
    </div>

    <span class="ia-detection-form-label">
      Viewpoint: <span id="ia-viewpoint-label-degrees"></span> Degrees | Radians: <span id="ia-viewpoint-label-radians1"></span> (&pi; * <span id="ia-viewpoint-label-radians2"></span>) | Label: <span id="ia-viewpoint-label-text"></span>
      <span id="ia-detection-form-warning" class="pull-right" style="color: #ac2925;"><i>click to focus an annotation and edit these values</i></span>
      <br/>
      <input id="ia-detection-viewpoint" class="ia-detection-form-value" type="range" name="ia-viewpoint-value" value="{% if viewpoint_value %}{{ viewpoint_value }}{% else %}0{% endif %}" min="0" max="359" style="margin-bottom:5px;" onchange="update_label();" oninput="update_label();"> <!-- onchange- IE, oninput-Everything Else -->
      <div class="row-custom-expand">
        <div class="col-custom-span col-custom-span-9"><span class="glyphicon glyphicon-arrow-left"            ></span></div>
        <div class="col-custom-span col-custom-span-9"><span class="glyphicon glyphicon-arrow-down rotate-45"  ></span></div>
        <div class="col-custom-span col-custom-span-9"><span class="glyphicon glyphicon-arrow-down"            ></span></div>
        <div class="col-custom-span col-custom-span-9"><span class="glyphicon glyphicon-arrow-right rotate-45"  ></span></div>
        <div class="col-custom-span col-custom-span-9"><span class="glyphicon glyphicon-arrow-right"           ></span></div>
        <div class="col-custom-span col-custom-span-9"><span class="glyphicon glyphicon-arrow-up rotate-45" ></span></div>
        <div class="col-custom-span col-custom-span-9"><span class="glyphicon glyphicon-arrow-up"              ></span></div>
        <div class="col-custom-span col-custom-span-9"><span class="glyphicon glyphicon-arrow-left rotate-45"    ></span></div>
      </div>
      <br/>
      <div class="row">
        <div class="col-lg-6 col-md-6 col-sm-6">
          Quality: <span id="ia-quality-label-value"></span> | Label: <span id="ia-quality-label-text"></span>
          <input id="ia-detection-quality" class="ia-detection-form-value" type="range" name="ia-quality-value" value="{% if quality_value %}{{ quality_value }}{% else %}2{% endif %}" min="1" max="2" style="margin-bottom:5px;" onchange="update_label();" oninput="update_label();"> <!-- onchange- IE, oninput-Everything Else -->
          <div class="row-custom-expand">
            <div class="col-custom-span col-custom-span-2">
              <span class="glyphicon glyphicon-remove"></span>
            </div>
            <div class="col-custom-span col-custom-span-2">
              <span class="glyphicon glyphicon-ok"></span>
            </div>
          </div>
        </div>
        <div class="col-lg-6 col-md-6 col-sm-6">
            <div class="checkbox pull-right">
              <label>
                <input id="ia-detection-multiple" class="ia-detection-form-value" name="ia-multiple-value" type="checkbox"> Multiple animals in image
                <br/>
                <input id="ia-detection-interest" class="ia-detection-form-value" name="ia-interest-value" type="checkbox"> Object of Interest
                <br/>
                <input type="checkbox" class="context_menu_checkbox"> DEBUG
              </label>
            </div>
        </div>
      </div>

      <div class="row" style="margin-top: 20px;">
        <div class="col-lg-4">
          Species:
          <select class="form-control ia-detection-form-value" name="ia-detection-species" style="width: 200px;">
            {% for species_nice, species_text in species_list %}
              <option value="{{ species_text }}">{{ species_nice }}</option>
            {% endfor %}
          </select>
          <span class="pull-left" data-toggle="modal" data-target="#species-add" style="color: #aaa; cursor: pointer;"><i>Add Species</i></span>
          <br/>
        </div>

        <div class="col-lg-4">
          Part:
          <select class="form-control ia-detection-form-value" name="ia-detection-species" style="width: 200px;">
            {% for species_nice, species_text in species_list %}
              <option value="{{ species_text }}">{{ species_nice }}</option>
            {% endfor %}
          </select>
          <span class="pull-left" data-toggle="modal" data-target="#species-add" style="color: #aaa; cursor: pointer;"><i>Add Part</i></span>
        </div>

        <div class="col-lg-4" style="margin-top:19px;">
          {% if previous %}
            <a class="btn btn-default pull-left" id="ia-turk-previous" href="{{ url_for('turk_detection') }}?imgsetid={{ imgsetid }}&gid={{ previous }}">Previous {{ previous }}</a>
          {% endif %}
          <input type="submit" name="detection-submit" id="ia-turk-submit-accept" class="btn btn-primary pull-right" value="Accept">
          {% if not EMBEDDED_JAVASCRIPT %}
            <input type="submit" name="detection-submit" id="ia-turk-submit-clear"  class="btn btn-warning pull-right" value="Clear" style="margin-right: 15px;">
            <!-- <input type="submit" name="detection-submit" id="ia-turk-submit-delete" class="btn btn-danger pull-right" value="Delete" style="margin-right: 15px;" onclick="return confirm('Are you sure you want to delete this image?')"> -->
          {% endif %}
        </div>
      </div>
    </span>

    <textarea id="ia-detection-data" name="detection-annotations" style="font-family:monospace; margin-top:30px;width: 100%; height: 100px; display: none;" readonly="" form="ia-detection-form"></textarea>
  </form>

  {% if EMBEDDED_JAVASCRIPT %}
    {{ EMBEDDED_JAVASCRIPT|safe }}
  {% else %}
    <script src="{{ url_for('static', filename='javascript/turk-detection.js') }}" ia-dependency="javascript"></script>
    <script src="{{ url_for('static', filename='include/bbox_annotator_percent.js') }}" ia-dependency="javascript"></script>
  {% endif %}

  <script type="text/javascript" ia-dependency="javascript">

    $(document).ready(function() {
      var toggle;

      // Initialize the bounding-box annotator.
      var bba = new BBoxAnnotator("{{ image_src }}", {
        onchange: function(entries) {
          $('#ia-detection-data').text(JSON.stringify(entries, null, "  "));
        }
      });

      // Add pre-existing annotations as entries
      {% for annot in annotation_list %}
        bba.add_entry({
          pixels:   {},
          percent:  {
            left:      {{ annot['left'] }},
            top:       {{ annot['top'] }},
            width:     {{ annot['width'] }},
            height:    {{ annot['height'] }},
          },
          angles:   {
            theta:     {{ annot['theta'] }},
          },
          metadata: {
            species:   '{{ annot['species'] }}',
            viewpoint: {{ annot['viewpoint'] }},
            quality:   {{ annot['quality'] }},
            multiple:  {{ annot['multiple'] }},
            id:        '{{ annot['id'] }}',
          },
        });
      {% endfor %}

      // Update metadata labels for form inputs
      update_label();

      // Create the toggle's user interaction
      toggle = $('#ia-detection-annotation-mode-toggle');

      toggle.bootstrapToggle({
        on: 'Drag-Rotate',
        off: 'Three Point',
        onstyle: 'primary',
        offstyle: 'primary'
      });

      $("#ia-detection-annotation-mode-toggle").change(function() {
        var checked_mode;

        checked_mode = $(this).prop("checked");
        checked_tag = checked_mode ? "rectangle" : "diagonal";
        bba.update_mode(checked_tag);
      });

      {% if display_instructions %}
        // $('#turk-instructions').modal('show');
      {% endif %}

      {% if display_species_examples %}
        // $('#turk-species-examples').modal('show');
      {% endif %}
    });
  </script>
</div>