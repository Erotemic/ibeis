<div class="ia-container">

  {% if EMBEDDED_CSS %}
    {{ EMBEDDED_CSS|safe }}
  {% endif %}

  <div class="row">

    <div class="col-lg-4 col-md-4 col-sm-4">
        <div style="text-align: left; margin-top: 8px;">
          <input type="checkbox" id="ia-detection-annotation-mode-orientation" {% if settings['ia-detection-annotation-mode-orientation'] %}checked{% endif %}>
          <i> Axis-to-Axis Mid-line</i>
          <br/>
          <input type="checkbox" id="ia-detection-annotation-mode-parts-assignments" {% if settings['ia-detection-annotation-mode-parts-assignments'] %}checked{% endif %}>
          <i> Show Part Assignments</i>
        </div>
    </div>
    <div class="col-lg-4 col-md-4 col-sm-4">
        <div style="text-align: center; margin-top: 10px; margin-bottom: 2px;">
          <!-- <input type="checkbox" id="ia-detection-annotation-mode-toggle" checked> -->
          <input type="checkbox" id="ia-detection-annotation-mode-toggle" data-width="150" {% if settings['ia-detection-annotation-mode-toggle-annotations'] %}checked{% endif %}>
          <br/>
          <div id="ia-detection-annotation-mode-toggle-label" style="font-size: 10px; margin: 0px; line-height: 10px;">Annotation</div>
        </div>
    </div>
    <div class="col-lg-4 col-md-4 col-sm-4">
        <div style="text-align: right; margin-top: 8px;">
          <i>Always Show Parts</i>
          <input type="checkbox" id="ia-detection-annotation-mode-parts-show" {% if settings['ia-detection-annotation-mode-parts-show'] %}checked{% endif %}><br/>
          <i>Always Hide Parts</i>
          <input type="checkbox" id="ia-detection-annotation-mode-parts-hide" {% if settings['ia-detection-annotation-mode-parts-hide'] %}checked{% endif %}>
        </div>
    </div>
  </div>

  <form class="ia-form" method="{{ callback_method }}" action="{{ callback_url }}{% if REFER_DST_STR %}&refer={{ REFER_DST_ENCODED }}{% endif %}" onsubmit="return check_form();" id="ia-detection-form">
    <div id="ia-bbox-annotator-container"></div>
    <div style="text-align: center; color: #aaa;">
      <span>hover to highlight (in orange), press <b>B</b> to send a box to the back, press <b>Delete</b> to delete</a> and press <b>Esc</b> to cancel any action</span>
      <br/>
      <span>right-click or press <b>F</b> to focus (in red) where parts can be added and metadata can be changed below</span>
    </div>
    <br/>
    <input type="text" name="detection-gid" value="{{ gid }}" style="display: none;" readonly>
    <input type="text" name="detection-image-uuid" value="{{ image_uuid }}" style="display: none;" readonly>
    <div class="row">
      <div class="col-lg-2"></div>
      <div class="col-lg-8" style="text-align:center;">
        {% if REFER_DST_STR and refer_aid %}
          <a href="/{{ REFER_DST_STR }}&aid={{ refer_aid }}" class="btn btn-default" style="margin-left:auto; margin-right: auto;">Nevermind, take me back...</a>
        {% endif %}
      </div>
      <div class="col-lg-2"></div>
    </div>

    <div class="row" style="margin-top: 20px;">
      <div class="col-lg-12" style="text-align: center;">
        <div style="margin-top: -27px;">
          {% if previous %}
            <a class="btn btn-default pull-left" id="ia-turk-previous" href="{{ url_for('turk_detection') }}?imgsetid={{ imgsetid }}&gid={{ previous }}">Previous {{ previous }}</a>
          {% endif %}
        </div>

        <span id="ia-metadata-badge-annotation" class="badge" style="margin-right: -5px; border-top-right-radius: 0; border-bottom-right-radius: 0;">Annotation</span>
        <span id="ia-metadata-badge-part" class="badge" style="border-top-left-radius: 0;border-bottom-left-radius: 0;">Part</span>

        <div style="margin-top: -27px;">
          <input type="submit" name="detection-submit" id="ia-turk-submit-accept" class="btn btn-primary pull-right" value="Accept">
          {% if not EMBEDDED_JAVASCRIPT %}
            <input type="submit" name="detection-submit" id="ia-turk-submit-clear"  class="btn btn-warning pull-right" value="Clear" style="margin-right: 15px;">
            <!-- <input type="submit" name="detection-submit" id="ia-turk-submit-delete" class="btn btn-danger pull-right" value="Delete" style="margin-right: 15px;" onclick="return confirm('Are you sure you want to delete this image?')"> -->
          {% endif %}
        </div>
      </div>
    </div>

    <div id="ia-metadata-panel-container" style="position: relative; width: 100%;">
      <div id="ia-metadata-panel-annotation" style="position: absolute; width: 100%;">

        Viewpoint: <span id="ia-viewpoint-label-text"></span>
        <br/>
        <div class="ia-viewpoint-axis-1">
          Axis 1 (&#8679 / Shift)
          <span id="ia-detection-form-annotation-warning" class="pull-right" style="color: #ac2925;"><i>focus an annotation to edit these values</i></span>
          <br/>
          <input id="ia-detection-annotation-viewpoint-1" class="ia-detection-form-annotation-value" type="range" name="ia-viewpoint-value-1" value="{% if viewpoint_value %}{{ viewpoint_value }}{% else %}-1{% endif %}" min="-1" max="5" style="margin-bottom:5px;" onchange="update_label();" oninput="update_label();">
          <div class="row-custom-expand">
            <div class="col-custom-span col-custom-span-7"><i>null</i></div>
            <div class="col-custom-span col-custom-span-7">up</div>
            <div class="col-custom-span col-custom-span-7">down</div>
            <div class="col-custom-span col-custom-span-7">front</div>
            <div class="col-custom-span col-custom-span-7">back</div>
            <div class="col-custom-span col-custom-span-7">left</div>
            <div class="col-custom-span col-custom-span-7">right</div>
          </div>
          <br/>
        </div>
        <div class="ia-viewpoint-axis-2">
          Axis 2 (&#8997; / Alt / Option)
          <br/>
          <input id="ia-detection-annotation-viewpoint-2" class="ia-detection-form-annotation-value" type="range" name="ia-viewpoint-value-2" value="{% if viewpoint_value %}{{ viewpoint_value }}{% else %}-1{% endif %}" min="-1" max="5" style="margin-bottom:5px;" onchange="update_label();" oninput="update_label();">
          <div class="row-custom-expand">
            <div id="col-viewpoint-ticks-2-0" class="col-custom-span col-custom-span-7"><i>null</i></div>
            <div id="col-viewpoint-ticks-2-1" class="col-custom-span col-custom-span-7">up</div>
            <div id="col-viewpoint-ticks-2-2" class="col-custom-span col-custom-span-7">down</div>
            <div id="col-viewpoint-ticks-2-3" class="col-custom-span col-custom-span-7">front</div>
            <div id="col-viewpoint-ticks-2-4" class="col-custom-span col-custom-span-7">back</div>
            <div id="col-viewpoint-ticks-2-5" class="col-custom-span col-custom-span-7">left</div>
            <div id="col-viewpoint-ticks-2-6" class="col-custom-span col-custom-span-7">right</div>
          </div>
          <br/>
        </div>
        <div class="ia-viewpoint-axis-3">
          Axis 3
          <br/>
          <input id="ia-detection-annotation-viewpoint-3" class="ia-detection-form-annotation-value" type="range" name="ia-viewpoint-value-3" value="{% if viewpoint_value %}{{ viewpoint_value }}{% else %}-1{% endif %}" min="-1" max="5"style="margin-bottom:5px;" onchange="update_label();" oninput="update_label();">
          <div class="row-custom-expand">
            <div id="col-viewpoint-ticks-3-0" class="col-custom-span col-custom-span-7"><i>null</i></div>
            <div id="col-viewpoint-ticks-3-1" class="col-custom-span col-custom-span-7">up</div>
            <div id="col-viewpoint-ticks-3-2" class="col-custom-span col-custom-span-7">down</div>
            <div id="col-viewpoint-ticks-3-3" class="col-custom-span col-custom-span-7">front</div>
            <div id="col-viewpoint-ticks-3-4" class="col-custom-span col-custom-span-7">back</div>
            <div id="col-viewpoint-ticks-3-5" class="col-custom-span col-custom-span-7">left</div>
            <div id="col-viewpoint-ticks-3-6" class="col-custom-span col-custom-span-7">right</div>
          </div>
        </div>

        <div class="row">
          <div class="col-lg-6 col-md-6 col-sm-6">
            Quality: <span id="ia-quality-label-value"></span> | Label: <span id="ia-quality-label-text"></span>
            <input id="ia-detection-annotation-quality" class="ia-detection-form-annotation-value" type="range" name="ia-quality-value" value="{% if quality_value %}{{ quality_value }}{% else %}2{% endif %}" min="1" max="2" style="margin-bottom:5px;" onchange="update_label();" oninput="update_label();"> <!-- onchange- IE, oninput-Everything Else -->
            <div class="row-custom-expand">
              <div class="col-custom-span col-custom-span-2">
                <span class="glyphicon glyphicon-remove"></span>
              </div>
              <div class="col-custom-span col-custom-span-2">
                <span class="glyphicon glyphicon-ok"></span>
              </div>
            </div>
          </div>
          <div class="col-lg-6 col-md-6 col-sm-6">
              <div class="checkbox pull-right">
                <label>
                  <input id="ia-detection-annotation-multiple" class="ia-detection-form-annotation-value" name="ia-multiple-value" type="checkbox"> Multiple animals in image
                  <br/>
                  <input id="ia-detection-annotation-interest" class="ia-detection-form-annotation-value" name="ia-interest-value" type="checkbox"> Object of Interest
                </label>
              </div>
          </div>
        </div>

        <div class="row" style="margin-top: 20px;">
          <div class="col-lg-4">
            Species:
            <select id="ia-detection-annotation-class"  class="form-control ia-detection-form-annotation-value" name="ia-species-value" style="width: 200px;">
              {% for species_nice, species_text in species_list %}
                <option value="{{ species_text }}">{{ species_nice }}</option>
              {% endfor %}
            </select>
            <span class="pull-left" data-toggle="modal" data-target="#species-add" style="color: #aaa; cursor: pointer;"><i>Add Species</i></span>
            <br/>
          </div>

          <div class="col-lg-4"></div>
          <div class="col-lg-4"></div>
        </div>
      </div>

      <div id="ia-metadata-panel-part" style="position: absolute; width: 100%;">
        Viewpoint: <span id="ia-viewpoint-label-text"></span>
        <br/>
        <div class="ia-viewpoint-axis-1">
          Axis 1 (&#8679 / Shift)
          <span id="ia-detection-form-part-warning" class="pull-right" style="color: #ac2925;"><i>focus a part to edit these values</i></span>
          <br/>
          <input id="ia-detection-part-viewpoint-1" class="ia-detection-form-part-value" type="range" name="ia-viewpoint-value-1" value="{% if viewpoint_value %}{{ viewpoint_value }}{% else %}-1{% endif %}" min="-1" max="5" style="margin-bottom:5px;" onchange="update_label();" oninput="update_label();">
          <div class="row-custom-expand">
            <div class="col-custom-span col-custom-span-7"><i>null</i></div>
            <div class="col-custom-span col-custom-span-7">up</div>
            <div class="col-custom-span col-custom-span-7">down</div>
            <div class="col-custom-span col-custom-span-7">front</div>
            <div class="col-custom-span col-custom-span-7">back</div>
            <div class="col-custom-span col-custom-span-7">left</div>
            <div class="col-custom-span col-custom-span-7">right</div>
          </div>
          <br/>
        </div>

        <div class="row">
          <div class="col-lg-6 col-md-6 col-sm-6">
            Quality: <span id="ia-quality-label-text"></span>
            <input id="ia-detection-part-quality" class="ia-detection-form-part-value" type="range" name="ia-quality-value" value="{% if quality_value %}{{ quality_value }}{% else %}2{% endif %}" min="1" max="2" style="margin-bottom:5px;" onchange="update_label();" oninput="update_label();"> <!-- onchange- IE, oninput-Everything Else -->
            <div class="row-custom-expand">
              <div class="col-custom-span col-custom-span-2">
                <span class="glyphicon glyphicon-remove"></span>
              </div>
              <div class="col-custom-span col-custom-span-2">
                <span class="glyphicon glyphicon-ok"></span>
              </div>
            </div>
          </div>
          <div class="col-lg-6 col-md-6 col-sm-6"></div>
        </div>

        <div class="row" style="margin-top: 20px;">
          <div class="col-lg-4">
            Part:
            <select id="ia-detection-part-class" class="form-control ia-detection-form-part-value"  name="ia-part-value" style="width: 200px;">
              {% for species_nice, species_text in species_list %}
                <option value="{{ species_text }}">{{ species_nice }}</option>
              {% endfor %}
            </select>
            <span class="pull-left" data-toggle="modal" data-target="#part-add" style="color: #aaa; cursor: pointer;"><i>Add Part</i></span>
          </div>

          <div class="col-lg-4"></div>

          <div class="col-lg-4"></div>
        </div>
      </div>
    </div>

    <textarea id="ia-detection-data" name="detection-annotations" style="font-family:monospace; margin-top:30px;width: 100%; height: 100px; display: none;" readonly="" form="ia-detection-form"></textarea>
  </form>

  {% if EMBEDDED_JAVASCRIPT %}
    {{ EMBEDDED_JAVASCRIPT|safe }}
  {% else %}
    <script src="{{ url_for('static', filename='javascript/turk-detection.js') }}" ia-dependency="javascript"></script>
    <script src="{{ url_for('static', filename='include/bbox_annotator_percent.js') }}" ia-dependency="javascript"></script>
  {% endif %}

  <script type="text/javascript" ia-dependency="javascript">
    var bba, axis2, axis3

    $(document).ready(function() {
      var toggle;
      var states;

      states = {
        annotations: {% if settings['ia-detection-annotation-mode-toggle-annotations'] %}true{% else %}false{% endif %},
        parts: {% if settings['ia-detection-annotation-mode-toggle-parts'] %}true{% else %}false{% endif %},
      }

      axis2 = true;
      axis3 = false;

      if( ! axis2) {
        hide_viewpoint_2_axis_panel(2)
      }
      if( ! axis3) {
        hide_viewpoint_2_axis_panel(3)
      }

      $(window).bind("resize", function() {
          fix_metadata_panels()
      })

      visible = {% if settings['ia-detection-annotation-mode-parts-show'] %}true{% else %}{% if settings['ia-detection-annotation-mode-parts-hide'] %}false{% else %}null{% endif %}{% endif %}
      assignments = {% if settings['ia-detection-annotation-mode-parts-assignments'] %}true{% else %}false{% endif %}

      // Initialize the bounding-box annotator.
      bba = new BBoxAnnotator("{{ image_src }}", {
        prefix: "ia-",
        colors: {
          anchor: "#FFFFFF",
        },
        subentries: {
          visible: visible,
          assignments: assignments,
        },
        onchange: function(entries) {
          $('#ia-detection-data').text(JSON.stringify(entries, null, "  "));
        },
        onhover: function(index, entry) {
          if(index == null || entry == null) {
            hotkeys_disabled = true;
            update_metadata_panel();
            return
          }
          if(entry.parent == null) {
            update_metadata_panel("annotation");
            show_annotation_metadata(entry)
          } else {
            update_metadata_panel("part");
          }
          hotkeys_disabled = false;
        },
        onselector: function() {
          if(bba.state.focus == null) {
            update_metadata_panel("annotation");
          } else {
            update_metadata_panel("part");
          }
        },
        onfocus: function(index, entry) {
          // if(index == null || entry == null) {
          //   return
          // }

          if(entry == null) {
            disable_metadata_annotations()
            disable_metadata_parts()
          } else {
            if (entry.parent == null) {
              enable_metadata_annotations()
              disable_metadata_parts()
            } else {
              enable_metadata_parts()
            }
          }

          checked_mode = $("#ia-detection-annotation-mode-toggle").prop("checked");

          if(bba.state.focus == null) {
            $("#ia-detection-annotation-mode-toggle-label").html("Annotations")
            wanted_mode = states.annotations
          } else {
            $("#ia-detection-annotation-mode-toggle-label").html("Parts")
            wanted_mode = states.parts
          }

          if(wanted_mode) {
            $('#ia-detection-annotation-mode-toggle').bootstrapToggle('on')
          } else {
            $('#ia-detection-annotation-mode-toggle').bootstrapToggle('off')
          }
        },
      });

      // Add pre-existing annotations as entries
      {% for annot in annotation_list %}
        bba.add_entry({
          label:    '{{ annot['id'] }}',
          percent:  {
            left:      {{ annot['left'] }},
            top:       {{ annot['top'] }},
            width:     {{ annot['width'] }},
            height:    {{ annot['height'] }},
          },
          angles:   {
            theta:     {{ annot['theta'] }},
          },
          metadata: {
            species:   '{{ annot['species'] }}',
            viewpoint: {{ annot['viewpoint'] }},
            quality:   {{ annot['quality'] }},
            multiple:  {{ annot['multiple'] }},
          },
        });
      {% endfor %}

      // Add pre-existing annotations as entries
      {% for annot in annotation_list %}
        bba.add_entry({
          parent:   {{ annotation_list.index(annot) }},
          percent:  {
            left:      {{   5 + annot['left'] }},
            top:       {{   5 + annot['top'] }},
            width:     {{ 0.5 * annot['width'] }},
            height:    {{ 0.5 * annot['height'] }},
          },
          angles:   {
            theta:     {{ annot['theta'] }},
          },
          metadata: {},
        });
      {% endfor %}

      // Create the toggle's user interaction
      toggle = $('#ia-detection-annotation-mode-toggle');

      toggle.bootstrapToggle({
        on: 'Axis-to-Axis',
        off: 'Corner-to-Corner',
        onstyle: 'primary',
        offstyle: 'primary'
      });

      $("#ia-detection-annotation-mode-toggle,#ia-detection-annotation-mode-orientation").change(function() {
        var checked_mode, diagonal_mode, checked_tag;
        checked_mode = $("#ia-detection-annotation-mode-toggle").prop("checked");
        diagonal_mode = $("#ia-detection-annotation-mode-orientation").prop("checked");

        // Save the mode
        if(bba.state.focus == null) {
          states.annotations = checked_mode
        } else {
          states.parts = checked_mode
        }

        submit_cookie('ia-detection-annotation-mode-toggle-annotations', states.annotations ? '1' : '0');
        submit_cookie('ia-detection-annotation-mode-toggle-parts', states.parts ? '1' : '0');
        submit_cookie('ia-detection-annotation-mode-orientation', diagonal_mode ? '1' : '0');

        if (diagonal_mode) {
          diagonal_tag = "diagonal"
        } else {
          diagonal_tag = "diagonal2"
        }

        checked_tag = checked_mode ? diagonal_tag : "rectangle";
        bba.update_mode(checked_tag);
      });

      $("#ia-detection-annotation-mode-parts-assignments").change(function() {
        var checked_mode, checked_tag;
        checked_mode = $(this).prop("checked");

        submit_cookie('ia-detection-annotation-mode-parts-assignments', checked_mode ? '1' : '0');

        checked_tag = checked_mode ? true : null;
        bba.update_subentries_assignments(checked_tag);
      });

      $("#ia-detection-annotation-mode-parts-show").change(function() {
        var checked_mode, checked_tag
        checked_mode = $(this).prop("checked");

        submit_cookie('ia-detection-annotation-mode-parts-show', checked_mode ? '1' : '0');

        if(checked_mode) {
          $('#ia-detection-annotation-mode-parts-hide').prop('checked', false);
          submit_cookie('ia-detection-annotation-mode-parts-hide', '0');
        }
        checked_tag = checked_mode ? true : null;
        bba.update_subentries_visible(checked_tag);
      });

      $("#ia-detection-annotation-mode-parts-hide").change(function() {
        var checked_mode, checked_tag
        checked_mode = $(this).prop("checked");

        submit_cookie('ia-detection-annotation-mode-parts-hide', checked_mode ? '1' : '0');

        if(checked_mode) {
          $('#ia-detection-annotation-mode-parts-show').prop('checked', false);
          submit_cookie('ia-detection-annotation-mode-parts-show', '0');
        }
        checked_tag = checked_mode ? false : null;
        bba.update_subentries_visible(checked_tag);
      });

      $(".ia-detection-form-annotation-value").change(function(e)
      {
        metadata = bba.get_metadata()
        if(metadata == null) {
          return
        }
        metadata.viewpoint = $('#ia-detection-annotation-viewpoint').val();
        metadata.quality   = $('#ia-detection-annotation-quality').val();
        metadata.species   = $('#ia-detection-annotation-class').find("option:selected").val();
        metadata.multiple  = $('#ia-detection-annotation-multiple').is(":checked")
        bba.set_metadata(metadata)
        // Set highlighted
        bba.set_highlighted($('#ia-detection-annotation-interest').is(":checked"))
      });

      $(".ia-detection-form-part-value").change(function(e)
      {
        metadata = bba.get_metadata()
        if(metadata == null) {
          return
        }
        metadata.quality   = $('#ia-detection-part-quality').val();
        metadata.part      = $('#ia-detection-part-class').find("option:selected").val();
        bba.set_metadata(metadata)
      });

      // Update metadata labels for form inputs
      update_label();
      disable_metadata_annotations();
      disable_metadata_parts();
      update_metadata_panel();
      fix_metadata_panels();

      {% if display_instructions %}
        // $('#turk-instructions').modal('show');
      {% endif %}

      {% if display_species_examples %}
        // $('#turk-class-examples').modal('show');
      {% endif %}
    });
  </script>
</div>