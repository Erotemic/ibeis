<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ibeis.ibsfuncs &mdash; ibeis 0.1.0.dev1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1.0.dev1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="ibeis 0.1.0.dev1 documentation" href="../../index.html" />
    <link rel="up" title="ibeis" href="../ibeis.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">ibeis 0.1.0.dev1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../ibeis.html" accesskey="U">ibeis</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for ibeis.ibsfuncs</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">python -c &quot;import doctest, ibeis; print(doctest.testmod(ibeis.ibsfuncs))&quot;</span>
<span class="sd">python -m doctest -v ibeis/model/hots/hots_nn_index.py</span>
<span class="sd">python -m doctest ibeis/model/hots/hots_nn_index.py</span>

<span class="sd">rob gp &quot;ibsfuncs\..*\(ibs, &quot;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c"># developer convenience functions for ibs</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="c">#import uuid</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">zip</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">map</span>
<span class="kn">from</span> <span class="nn">utool._internal.meta_util_six</span> <span class="kn">import</span> <span class="n">get_funcname</span><span class="p">,</span> <span class="n">get_imfunc</span><span class="p">,</span> <span class="n">set_funcname</span>
<span class="c">#from functools import partial  # NOQA</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">split</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">commonprefix</span>
<span class="kn">import</span> <span class="nn">utool</span>
<span class="kn">import</span> <span class="nn">ibeis</span>
<span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">detecttools.pypascalmarkup</span> <span class="kn">import</span> <span class="n">PascalVOC_Markup_Annotation</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="s">&#39;COMMIT TO DETECTTOOLS&#39;</span><span class="p">)</span>
    <span class="k">pass</span>
<span class="c">#from ibeis import constants</span>
<span class="kn">from</span> <span class="nn">ibeis.control.accessor_decors</span> <span class="kn">import</span> <span class="n">getter_1to1</span>
<span class="kn">from</span> <span class="nn">vtool</span> <span class="kn">import</span> <span class="n">linalg</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">image</span>
<span class="kn">import</span> <span class="nn">vtool.image</span> <span class="kn">as</span> <span class="nn">gtool</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="c"># Inject utool functions</span>
<span class="p">(</span><span class="k">print</span><span class="p">,</span> <span class="n">print_</span><span class="p">,</span> <span class="n">printDBG</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span>
    <span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;[ibsfuncs]&#39;</span><span class="p">,</span> <span class="n">DEBUG</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="n">__INJECTABLE_FUNCS__</span> <span class="o">=</span> <span class="p">[]</span>


<span class="c">#def __injectable(input_):</span>
<span class="c">#    def closure_injectable(func, indent=True):</span>
<span class="c">#        global __INJECTABLE_FUNCS__</span>
<span class="c">#        if indent:</span>
<span class="c">#            func_ = utool.indent_func(func)</span>
<span class="c">#        else:</span>
<span class="c">#            func_ = func</span>
<span class="c">#        __INJECTABLE_FUNCS__.append(func_)</span>
<span class="c">#        return func_</span>
<span class="c">#    if utool.is_funclike(input_):</span>
<span class="c">#        return closure_injectable(input_)</span>
<span class="c">#    else:</span>
<span class="c">#        return partial(closure_injectable, indent=input_)</span>
<span class="c">#__injectable(utool.inject_func_as_method)</span>


<span class="c">#def inject_ibeis(ibs):</span>
<span class="c">#    &quot;&quot;&quot; Injects custom functions into an IBEISController &quot;&quot;&quot;</span>
<span class="c">#    # Give the ibeis object the inject_func_as_method</span>
<span class="c">#    for func in __INJECTABLE_FUNCS__:</span>
<span class="c">#        utool.inject_func_as_method(ibs, func)</span>
<span class="c">#    postinject_func()</span>

<span class="c">#import ibeis</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>  <span class="c"># NOQA</span>

<span class="c"># Try to work around circular import</span>
<span class="c">#from ibeis.control.IBEISControl import IBEISController  # Must import class before injection</span>
<span class="n">__injectable</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_class_method_decorator</span><span class="p">(</span><span class="s">&#39;IBEISController&#39;</span><span class="p">)</span>


<span class="nd">@ut.make_class_postinject_decorator</span><span class="p">(</span><span class="s">&#39;IBEISController&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="postinject_func"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.postinject_func">[docs]</a><span class="k">def</span> <span class="nf">postinject_func</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># List of getters to _unflatten</span>
    <span class="n">to_unflatten</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_text</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_unixtime</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">,</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">flat_getter</span> <span class="ow">in</span> <span class="n">to_unflatten</span><span class="p">:</span>
        <span class="n">unflat_getter</span> <span class="o">=</span> <span class="n">_make_unflat_getter_func</span><span class="p">(</span><span class="n">flat_getter</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">inject_func_as_method</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">unflat_getter</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="refresh"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.refresh">[docs]</a><span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">ibsfuncs</span>
    <span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">all_imports</span>
    <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">rrr</span><span class="p">()</span>
    <span class="n">all_imports</span><span class="o">.</span><span class="n">reload_all</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">rrr</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="export_to_xml"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.export_to_xml">[docs]</a><span class="k">def</span> <span class="nf">export_to_xml</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">target_size</span> <span class="o">=</span> <span class="mi">900</span>
    <span class="n">information</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;database_name&#39;</span> <span class="p">:</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_ibsdb</span> <span class="o">+</span> <span class="s">&quot;/LearningData/&quot;</span>
    <span class="n">imagedir</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s">&#39;JPEGImages/&#39;</span>
    <span class="n">annotdir</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s">&#39;Annotations/&#39;</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">datadir</span><span class="p">)</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">imagedir</span><span class="p">)</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">annotdir</span><span class="p">)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">gid_list</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="n">image_uri</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uris</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fulldir</span> <span class="o">=</span> <span class="n">image_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">fulldir</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c"># NOQA</span>
            <span class="n">out_name</span> <span class="o">=</span> <span class="s">&quot;2014_</span><span class="si">%06d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">offset</span>
            <span class="n">out_img</span> <span class="o">=</span> <span class="n">out_name</span> <span class="o">+</span> <span class="s">&quot;.jpg&quot;</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="s">&quot;IBEIS&quot;</span>

            <span class="n">_image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">_image</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">height</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="n">width</span>
                <span class="n">decrease</span> <span class="o">=</span> <span class="n">target_size</span> <span class="o">/</span> <span class="n">width</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">target_size</span>
                <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_size</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">height</span>
                <span class="n">decrease</span> <span class="o">=</span> <span class="n">target_size</span> <span class="o">/</span> <span class="n">height</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">target_size</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_size</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>

            <span class="n">dst_img</span> <span class="o">=</span> <span class="n">imagedir</span> <span class="o">+</span> <span class="n">out_img</span>
            <span class="n">_image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">_image</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
            <span class="n">image</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">dst_img</span><span class="p">,</span> <span class="n">_image</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Copying:</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">dst_img</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="p">))</span>

            <span class="n">annotation</span> <span class="o">=</span> <span class="n">PascalVOC_Markup_Annotation</span><span class="p">(</span><span class="n">dst_img</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">out_img</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">image_uri</span><span class="p">,</span> <span class="o">**</span><span class="n">information</span><span class="p">)</span>
            <span class="n">bbox_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="n">theta_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">theta</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">):</span>
                <span class="c"># Transformation matrix</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">rotation_around_bbox_mat3x3</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">bbox</span><span class="p">)</span>
                <span class="c"># Get verticies of the annotation polygon</span>
                <span class="n">verts</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">verts_from_bbox</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="c"># Rotate and transform vertices</span>
                <span class="n">xyz_pts</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">homogonize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="n">trans_pts</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">unhomogonize</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xyz_pts</span><span class="p">))</span>
                <span class="n">new_verts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">trans_pts</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">x_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">new_verts</span><span class="p">]</span>
                <span class="n">y_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">new_verts</span><span class="p">]</span>
                <span class="n">xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">decrease</span><span class="p">)</span>
                <span class="n">xmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">decrease</span><span class="p">)</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">y_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">decrease</span><span class="p">)</span>
                <span class="n">ymax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">y_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">decrease</span><span class="p">)</span>
                <span class="c">#TODO: Change species_name to getter in IBEISControl once implemented</span>
                <span class="c">#species_name = &#39;grevys_zebra&#39;</span>
                <span class="n">species_name</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                <span class="n">viewpoint</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoints</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">viewpoint</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">[</span><span class="s">&#39;pose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%0.6f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">viewpoint</span>
                <span class="n">annotation</span><span class="o">.</span><span class="n">add_object</span><span class="p">(</span><span class="n">species_name</span><span class="p">,</span> <span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">),</span> <span class="o">**</span><span class="n">info</span><span class="p">)</span>
            <span class="n">dst_annot</span> <span class="o">=</span> <span class="n">annotdir</span> <span class="o">+</span> <span class="n">out_name</span>  <span class="o">+</span> <span class="s">&#39;.xml&#39;</span>
            <span class="c"># Write XML</span>
            <span class="n">xml_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dst_annot</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">xml_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">xml</span><span class="p">())</span>
            <span class="n">xml_data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Skipping:</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="export_to_hotspotter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.export_to_hotspotter">[docs]</a><span class="k">def</span> <span class="nf">export_to_hotspotter</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.dbio</span> <span class="kn">import</span> <span class="n">export_hsdb</span>
    <span class="n">export_hsdb</span><span class="o">.</span><span class="n">export_ibeis_to_hotspotter</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_image_annotation_bboxes"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_image_annotation_bboxes">[docs]</a><span class="k">def</span> <span class="nf">get_image_annotation_bboxes</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">bboxes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annotation_bboxes</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bboxes_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_image_annotation_thetas"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_image_annotation_thetas">[docs]</a><span class="k">def</span> <span class="nf">get_image_annotation_thetas</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">thetas_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_unflat_annotation_thetas</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thetas_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="compute_all_chips"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_all_chips">[docs]</a><span class="k">def</span> <span class="nf">compute_all_chips</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes lazy evaluation of all chips</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] compute_all_chips&#39;</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_chips</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="compute_all_features"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_all_features">[docs]</a><span class="k">def</span> <span class="nf">compute_all_features</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes lazy evaluation of all chips and features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] compute_all_features&#39;</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_cids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">fid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_feats</span><span class="p">(</span><span class="n">cid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="ensure_annotation_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.ensure_annotation_data">[docs]</a><span class="k">def</span> <span class="nf">ensure_annotation_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">chips</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">feats</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">chips</span> <span class="ow">or</span> <span class="n">feats</span><span class="p">:</span>
        <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_chips</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">feats</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">add_feats</span><span class="p">(</span><span class="n">cid_list</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_empty_gids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_empty_gids">[docs]</a><span class="k">def</span> <span class="nf">get_empty_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns gid list without any chips &quot;&quot;&quot;</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">(</span><span class="n">eid</span><span class="o">=</span><span class="n">eid</span><span class="p">)</span>
    <span class="n">nRois_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_num_annotations</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">empty_gids</span> <span class="o">=</span> <span class="p">[</span><span class="n">gid</span> <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">nRois</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">nRois_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">nRois</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">empty_gids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="convert_empty_images_to_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.convert_empty_images_to_annotations">[docs]</a><span class="k">def</span> <span class="nf">convert_empty_images_to_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; images without chips are given an ANNOTATION over the entire image &quot;&quot;&quot;</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_empty_gids</span><span class="p">()</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">use_images_as_annotations</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="use_images_as_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.use_images_as_annotations">[docs]</a><span class="k">def</span> <span class="nf">use_images_as_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">name_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                              <span class="n">notes_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">adjust_percent</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adds an annotation the size of the entire image to each image.</span>
<span class="sd">    adjust_percent - shrinks the ANNOTATION by percentage on each side</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pct</span> <span class="o">=</span> <span class="n">adjust_percent</span>  <span class="c"># Alias</span>
    <span class="n">gsize_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_sizes</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="c"># Build bounding boxes as images size minus padding</span>
    <span class="n">bbox_list</span>  <span class="o">=</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span> <span class="mi">0</span> <span class="o">+</span> <span class="p">(</span><span class="n">gw</span> <span class="o">*</span> <span class="n">pct</span><span class="p">)),</span>
                   <span class="nb">int</span><span class="p">(</span> <span class="mi">0</span> <span class="o">+</span> <span class="p">(</span><span class="n">gh</span> <span class="o">*</span> <span class="n">pct</span><span class="p">)),</span>
                   <span class="nb">int</span><span class="p">(</span><span class="n">gw</span> <span class="o">-</span> <span class="p">(</span><span class="n">gw</span> <span class="o">*</span> <span class="n">pct</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span>
                   <span class="nb">int</span><span class="p">(</span><span class="n">gh</span> <span class="o">-</span> <span class="p">(</span><span class="n">gh</span> <span class="o">*</span> <span class="n">pct</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                  <span class="k">for</span> <span class="p">(</span><span class="n">gw</span><span class="p">,</span> <span class="n">gh</span><span class="p">)</span> <span class="ow">in</span> <span class="n">gsize_list</span><span class="p">]</span>
    <span class="n">theta_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gsize_list</span><span class="p">))]</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_annots</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">,</span>
                                   <span class="n">name_list</span><span class="o">=</span><span class="n">name_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="o">=</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">notes_list</span><span class="o">=</span><span class="n">notes_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="assert_valid_species"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_valid_species">[docs]</a><span class="k">def</span> <span class="nf">assert_valid_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">species_list</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">species</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">VALID_SPECIES</span>
                    <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_list</span><span class="p">]),</span> <span class="s">&#39;invalid species added&#39;</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">utool</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="n">iswarning</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iswarning</span><span class="p">:</span>
            <span class="k">raise</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="assert_singleton_relationship"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_singleton_relationship">[docs]</a><span class="k">def</span> <span class="nf">assert_singleton_relationship</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">alrids_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">alrids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">alrids</span> <span class="ow">in</span> <span class="n">alrids_list</span><span class="p">]),</span>\
            <span class="s">&#39;must only have one relationship of a type&#39;</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">parent_locals</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">get_parent_locals</span><span class="p">()</span>
        <span class="n">utool</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;parent_locals=&#39;</span> <span class="o">+</span> <span class="n">utool</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">parent_locals</span><span class="p">),</span> <span class="n">key_list</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;alrids_list&#39;</span><span class="p">,</span> <span class="p">])</span>
        <span class="k">raise</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="assert_valid_aids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_valid_aids">[docs]</a><span class="k">def</span> <span class="nf">assert_valid_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">valid_aids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">())</span>
    <span class="c">#invalid_aids = [aid for aid in aid_list if aid not in valid_aids]</span>
    <span class="n">isinvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">aid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_aids</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">aid_list</span><span class="p">]</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">isinvalid_list</span><span class="p">),</span> <span class="s">&#39;invalid aids: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">isinvalid_list</span><span class="p">),)</span>
    <span class="n">isinvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">utool</span><span class="o">.</span><span class="n">VALID_INT_TYPES</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">aid_list</span><span class="p">]</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">isinvalid_list</span><span class="p">),</span> <span class="s">&#39;invalidly typed aids: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">isinvalid_list</span><span class="p">),)</span>

</div>
<div class="viewcode-block" id="assert_images_exist"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_images_exist">[docs]</a><span class="k">def</span> <span class="nf">assert_images_exist</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">exists_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">exists</span><span class="p">,</span> <span class="n">gpath_list</span><span class="p">))</span>
    <span class="n">bad_gids</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">exists_list</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_gids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;some images dont exist&#39;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[check] checked </span><span class="si">%d</span><span class="s"> images exist&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="check_image_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_image_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_image_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="c"># TODO: more consistency checks</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;check image consistency. len(gid_list)=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>
    <span class="n">assert_images_exist</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="check_image_uuid_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_image_uuid_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_image_uuid_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; VERY SLOW &quot;&quot;&quot;</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">guuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">ibeis.model.preproc.preproc_image</span> <span class="kn">as</span> <span class="nn">preproc_image</span>
    <span class="n">mark_</span><span class="p">,</span> <span class="n">end_</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">log_progress</span><span class="p">(</span><span class="s">&#39;checking uuids&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">)):</span>
        <span class="n">mark_</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
        <span class="n">gpath</span> <span class="o">=</span> <span class="n">gpath_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">guuid</span> <span class="o">=</span> <span class="n">guuid_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="c"># Test params</span>
        <span class="n">param_tup</span> <span class="o">=</span> <span class="n">preproc_image</span><span class="o">.</span><span class="n">parse_imageinfo</span><span class="p">(</span><span class="n">gpath</span><span class="p">)</span>
        <span class="n">guuid_target</span> <span class="o">=</span> <span class="n">param_tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">guuid</span> <span class="o">==</span> <span class="n">guuid_target</span><span class="p">,</span> <span class="s">&#39;image ix=</span><span class="si">%d</span><span class="s"> had a bad uuid&#39;</span> <span class="o">%</span> <span class="n">ix</span>
    <span class="n">end_</span><span class="p">()</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="check_annot_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_annot_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_annot_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="c"># TODO: more consistency checks</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;check annot consistency. len(aid_list)=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>
    <span class="n">annot_gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">assert_images_exist</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">annot_gid_list</span><span class="p">)</span>
    <span class="n">unique_gids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">annot_gid_list</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;num_unique_images=</span><span class="si">%r</span><span class="s"> / </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_gids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">annot_gid_list</span><span class="p">)))</span>
    <span class="n">cid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_cids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">cfpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_chip_paths</span><span class="p">(</span><span class="n">cid_list</span><span class="p">)</span>
    <span class="n">valid_chip_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">cfpath</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">exists</span><span class="p">(</span><span class="n">cfpath</span><span class="p">)</span> <span class="k">for</span> <span class="n">cfpath</span> <span class="ow">in</span> <span class="n">cfpath_list</span><span class="p">]</span>
    <span class="n">invalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag</span> <span class="ow">is</span> <span class="bp">False</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">valid_chip_list</span><span class="p">]</span>
    <span class="n">invalid_cids</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">cid_list</span><span class="p">,</span> <span class="n">invalid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_cids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;found </span><span class="si">%d</span><span class="s"> inconsistent chips attempting to fix&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_cids</span><span class="p">))</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_chips</span><span class="p">(</span><span class="n">invalid_cids</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="check_name_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_name_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_name_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="c">#aids_list = ibs.get_name_aids(nid_list)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;check name consistency. len(nid_list)=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">))</span>
    <span class="n">lbltype_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_lblannot_lbltypes_rowids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">individual_lbltype_rowid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">lbltype_ids</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">INDIVIDUAL_KEY</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">lbltype_rowid</span> <span class="ow">in</span> <span class="n">lbltype_rowid_list</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">lbltype_rowid</span> <span class="o">==</span> <span class="n">individual_lbltype_rowid</span><span class="p">,</span> <span class="s">&#39;non individual lbltype&#39;</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="check_annot_size"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_annot_size">[docs]</a><span class="k">def</span> <span class="nf">check_annot_size</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">desc_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">kpts_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_kpts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">vert_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_verts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(aid_list) = &#39;</span> <span class="o">+</span> <span class="n">utool</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(vert_list) = &#39;</span> <span class="o">+</span> <span class="n">utool</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">vert_list</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(uuid_list) = &#39;</span> <span class="o">+</span> <span class="n">utool</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">uuid_list</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(desc_list) = &#39;</span> <span class="o">+</span> <span class="n">utool</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">desc_list</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;size(kpts_list) = &#39;</span> <span class="o">+</span> <span class="n">utool</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">get_object_size</span><span class="p">(</span><span class="n">kpts_list</span><span class="p">)))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="check_consistency"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">embed</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] Checking consistency&#39;</span><span class="p">)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">()</span>
    <span class="n">check_image_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)</span>
    <span class="n">check_annot_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
    <span class="n">check_name_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>
    <span class="c"># Very slow check</span>
    <span class="n">check_image_uuid_consistency</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">embed</span><span class="p">:</span>
        <span class="n">utool</span><span class="o">.</span><span class="n">embed</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] Finshed consistency check&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="fix_exif_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.fix_exif_data">[docs]</a><span class="k">def</span> <span class="nf">fix_exif_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">vtool.exif</span> <span class="kn">as</span> <span class="nn">exif</span>
    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
    <span class="kn">import</span> <span class="nn">utool</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">mark_</span><span class="p">,</span> <span class="n">end_</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">log_progress</span><span class="p">(</span><span class="s">&#39;checking exif: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">))</span>
    <span class="n">exif_dict_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">)):</span>
        <span class="n">mark_</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
        <span class="n">gpath</span> <span class="o">=</span> <span class="n">gpath_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">pil_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gpath</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">exif_dict</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">get_exif_dict</span><span class="p">(</span><span class="n">pil_img</span><span class="p">)</span>
        <span class="n">exif_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">)</span>
        <span class="c">#if len(exif_dict) &gt; 0:</span>
        <span class="c">#    break</span>
    <span class="n">end_</span><span class="p">()</span>

    <span class="n">latlon_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">exif</span><span class="o">.</span><span class="n">get_lat_lon</span><span class="p">(</span><span class="n">_dict</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">_dict</span> <span class="ow">in</span> <span class="n">exif_dict_list</span><span class="p">]</span>
    <span class="n">haslatlon_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">latlon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">latlon</span> <span class="ow">in</span> <span class="n">latlon_list</span><span class="p">]</span>

    <span class="n">latlon_list_</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">latlon_list</span><span class="p">,</span> <span class="n">haslatlon_list</span><span class="p">)</span>
    <span class="n">gid_list_</span>    <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">haslatlon_list</span><span class="p">)</span>

    <span class="n">gps_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_gps</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span>
    <span class="n">needsupdate_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gps</span> <span class="o">==</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">gps</span> <span class="ow">in</span> <span class="n">gps_list</span><span class="p">]</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s"> / </span><span class="si">%d</span><span class="s"> need gps update&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">needsupdate_list</span><span class="p">),</span>
                                       <span class="nb">len</span><span class="p">(</span><span class="n">needsupdate_list</span><span class="p">)))</span>

    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">needsupdate_list</span><span class="p">)</span>  <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">sum</span><span class="p">(</span><span class="n">needsupdate_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">needsupdate_list</span><span class="p">),</span> <span class="s">&#39;safety. remove and evaluate if hit&#39;</span>
        <span class="c">#ibs.set_image_enctext(gid_list_, [&#39;HASGPS&#39;] * len(gid_list_))</span>
        <span class="n">latlon_list__</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">latlon_list_</span><span class="p">,</span> <span class="n">needsupdate_list</span><span class="p">)</span>
        <span class="n">gid_list__</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">,</span> <span class="n">needsupdate_list</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_gps</span><span class="p">(</span><span class="n">gid_list__</span><span class="p">,</span> <span class="n">latlon_list__</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="check_exif_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.check_exif_data">[docs]</a><span class="k">def</span> <span class="nf">check_exif_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">vtool.exif</span> <span class="kn">as</span> <span class="nn">exif</span>
    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
    <span class="kn">import</span> <span class="nn">utool</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">mark_</span><span class="p">,</span> <span class="n">end_</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">log_progress</span><span class="p">(</span><span class="s">&#39;checking exif: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">))</span>
    <span class="n">exif_dict_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">)):</span>
        <span class="n">mark_</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
        <span class="n">gpath</span> <span class="o">=</span> <span class="n">gpath_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">pil_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gpath</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">exif_dict</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">get_exif_dict</span><span class="p">(</span><span class="n">pil_img</span><span class="p">)</span>
        <span class="n">exif_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">)</span>
        <span class="c">#if len(exif_dict) &gt; 0:</span>
        <span class="c">#    break</span>

    <span class="n">has_latlon</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">exif_dict</span> <span class="ow">in</span> <span class="n">exif_dict_list</span><span class="p">:</span>
        <span class="n">latlon</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">get_lat_lon</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">latlon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">has_latlon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_latlon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s"> / </span><span class="si">%d</span><span class="s"> have gps info&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">has_latlon</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">has_latlon</span><span class="p">),))</span>

    <span class="n">key2_freq</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">num_tags_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">exif_dict</span> <span class="ow">in</span> <span class="n">exif_dict_list</span><span class="p">:</span>
        <span class="n">exif_dict2</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">make_exif_dict_human_readable</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">)</span>
        <span class="n">num_tags_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exif_dict</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">exif_dict2</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">key2_freq</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">utool</span><span class="o">.</span><span class="n">print_stats</span><span class="p">(</span><span class="n">num_tags_list</span><span class="p">,</span> <span class="s">&#39;num tags per image&#39;</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;tag frequency&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">key2_freq</span><span class="p">))</span>

    <span class="n">end_</span><span class="p">()</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_all_recomputable_data"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_recomputable_data">[docs]</a><span class="k">def</span> <span class="nf">delete_all_recomputable_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete all cached data including chips and encounters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_recomputable_data&#39;</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_cachedir</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_all_chips</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_all_encounters</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_recomputable_data&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_cache"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_cache">[docs]</a><span class="k">def</span> <span class="nf">delete_cache</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">delete_chips</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">delete_encounters</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the cache directory in the database directory.</span>
<span class="sd">    Can specify to delete encoutners and chips as well.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">ensure_directories</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_cachedir</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">ensure_directories</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">delete_chips</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_all_chips</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">delete_encounters</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">delete_all_encounters</span><span class="p">()</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_cachedir"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_cachedir">[docs]</a><span class="k">def</span> <span class="nf">delete_cachedir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the cache directory in the database directory.</span>

<span class="sd">    (does not remove chips)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_cachedir&#39;</span><span class="p">)</span>
    <span class="c"># Need to close dbcache before restarting</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">_close_sqldbcache</span><span class="p">()</span>
    <span class="n">cachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_cachedir</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] cachedir=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cachedir</span><span class="p">)</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete cachedir&#39;</span><span class="p">)</span>
    <span class="c"># Reinit cache</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">ensure_directories</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">_init_sqldbcache</span><span class="p">()</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_qres_cache"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_qres_cache">[docs]</a><span class="k">def</span> <span class="nf">delete_qres_cache</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete delete_qres_cache&#39;</span><span class="p">)</span>
    <span class="n">qreq_cachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_qres_cachedir</span><span class="p">()</span>
    <span class="n">qreq_bigcachedir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_big_cachedir</span><span class="p">()</span>
    <span class="c"># Preliminary-ensure</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">qreq_bigcachedir</span><span class="p">)</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">qreq_cachedir</span><span class="p">)</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">qreq_cachedir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">qreq_bigcachedir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="c"># Re-ensure</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">qreq_bigcachedir</span><span class="p">)</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">qreq_cachedir</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_qres_cache&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_all_features"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_features">[docs]</a><span class="k">def</span> <span class="nf">delete_all_features</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_features&#39;</span><span class="p">)</span>
    <span class="n">all_fids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_fids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_features</span><span class="p">(</span><span class="n">all_fids</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_features&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_all_chips"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_chips">[docs]</a><span class="k">def</span> <span class="nf">delete_all_chips</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_chips&#39;</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">chipdir</span><span class="p">)</span>
    <span class="n">all_cids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_cids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_chips</span><span class="p">(</span><span class="n">all_cids</span><span class="p">)</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">chipdir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">chipdir</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_chips&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_all_encounters"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_encounters">[docs]</a><span class="k">def</span> <span class="nf">delete_all_encounters</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_encounters&#39;</span><span class="p">)</span>
    <span class="n">all_eids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_eids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_encounters</span><span class="p">(</span><span class="n">all_eids</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_encounters&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_all_annotations"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_all_annotations">[docs]</a><span class="k">def</span> <span class="nf">delete_all_annotations</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Carefull with this function. Annotations are not recomputable &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] delete_all_annotations&#39;</span><span class="p">)</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">moves</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s">&#39;Are you sure you want to delete all annotations?&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ans</span> <span class="o">!=</span> <span class="s">&#39;yes&#39;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">all_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_aids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_annots</span><span class="p">(</span><span class="n">all_aids</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibs] finished delete_all_annotations&#39;</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="vd"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.vd">[docs]</a><span class="k">def</span> <span class="nf">vd</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">view_directory</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbdir</span><span class="p">())</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_vecs_cache"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_vecs_cache">[docs]</a><span class="k">def</span> <span class="nf">get_annot_vecs_cache</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; When you have a list with duplicates and you dont want to copy data</span>
<span class="sd">    creates a reference to each data object indexed by a dict &quot;&quot;&quot;</span>
    <span class="n">unique_aids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aids</span><span class="p">))</span>
    <span class="n">unique_desc</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">(</span><span class="n">unique_aids</span><span class="p">)</span>
    <span class="n">desc_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_aids</span><span class="p">,</span> <span class="n">unique_desc</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">desc_cache</span>


<span class="c"># TODO: move to constants</span>
</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_is_hard"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_is_hard">[docs]</a><span class="k">def</span> <span class="nf">get_annot_is_hard</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CmdLine:</span>
<span class="sd">        ./dev.py --cmd --db PZ_Mothers</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()  # NOQA</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">is_hard_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">HARD_NOTE_TAG</span> <span class="ow">in</span> <span class="n">notes</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="p">(</span><span class="n">notes</span><span class="p">)</span>
                    <span class="ow">in</span> <span class="n">notes_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">is_hard_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="set_annot_is_hard"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_annot_is_hard">[docs]</a><span class="k">def</span> <span class="nf">set_annot_is_hard</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hack to mark hard cases in the notes column</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; pz_mothers_hard_aids = [27, 43, 44, 49, 50, 51, 54, 66, 89, 97]</span>
<span class="sd">        &gt;&gt;&gt; aid_list = pz_mothers_hard_aids</span>
<span class="sd">        &gt;&gt;&gt; flag_list = [True] * len(aid_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">is_hard_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">HARD_NOTE_TAG</span> <span class="ow">in</span> <span class="n">notes</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="p">(</span><span class="n">notes</span><span class="p">)</span> <span class="ow">in</span> <span class="n">notes_list</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">fix_notes</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">is_hard</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="s">&quot; Adds or removes hard tag if needed &quot;</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="ow">and</span> <span class="n">is_hard</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">flag</span> <span class="ow">or</span> <span class="n">is_hard</span><span class="p">):</span>
            <span class="c"># do nothing</span>
            <span class="k">return</span> <span class="n">notes</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_hard</span> <span class="ow">and</span> <span class="n">flag</span><span class="p">:</span>
            <span class="c"># need to add flag</span>
            <span class="k">return</span> <span class="n">constants</span><span class="o">.</span><span class="n">HARD_NOTE_TAG</span> <span class="o">+</span> <span class="s">&#39; &#39;</span>  <span class="o">+</span> <span class="n">notes</span>
        <span class="k">elif</span> <span class="n">is_hard</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">:</span>
            <span class="c"># need to remove flag</span>
            <span class="k">return</span> <span class="n">notes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">HARD_NOTE_TAG</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;impossible state&#39;</span><span class="p">)</span>

    <span class="n">new_notes_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fix_notes</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">is_hard</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span> <span class="k">for</span> <span class="n">notes</span><span class="p">,</span> <span class="n">is_hard</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">notes_list</span><span class="p">,</span> <span class="n">is_hard_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)]</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_notes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">new_notes_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">is_hard_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_bbox_area"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_bbox_area">[docs]</a><span class="k">def</span> <span class="nf">get_annot_bbox_area</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">bbox_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">area_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="n">bbox_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">area_list</span>


<span class="c">#@__injectable</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="rebase_images"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.rebase_images">[docs]</a><span class="k">def</span> <span class="nf">rebase_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">new_path</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Moves the images into the ibeis image cache.</span>
<span class="sd">    Images are renamed to img_uuid.ext</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gid_list</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
        <span class="c">#new_path = &#39;G:\PZ_Ol_Pejeta_All&#39;</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">len_prefix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">commonprefix</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">))</span>
    <span class="c">#if common_prefix.rfind(&#39;/&#39;)</span>
    <span class="c"># assum</span>
    <span class="n">gname_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gpath</span><span class="p">[</span><span class="n">len_prefix</span><span class="p">:]</span> <span class="k">for</span> <span class="n">gpath</span> <span class="ow">in</span> <span class="n">gpath_list</span><span class="p">]</span>
    <span class="n">new_gpath_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">join</span><span class="p">(</span><span class="n">new_path</span><span class="p">,</span> <span class="n">gname</span><span class="p">)</span> <span class="k">for</span> <span class="n">gname</span> <span class="ow">in</span> <span class="n">gname_list</span><span class="p">]</span>
    <span class="n">new_gpath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">unixpath</span><span class="p">,</span> <span class="n">new_gpath_list</span><span class="p">))</span>
    <span class="c">#orig_exists = map(exists, gpath_list)</span>
    <span class="n">new_exists</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">exists</span><span class="p">,</span> <span class="n">new_gpath_list</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">new_exists</span><span class="p">),</span> <span class="s">&#39;some rebased images do not exist&#39;</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_uris</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">new_gpath_list</span><span class="p">)</span>
    <span class="k">assert</span>  <span class="s">&#39;not all images copied&#39;</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_invalid_nids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_invalid_nids">[docs]</a><span class="k">def</span> <span class="nf">delete_invalid_nids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Removes names that have no Rois from the database &quot;&quot;&quot;</span>
    <span class="n">invalid_nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_invalid_nids</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_names</span><span class="p">(</span><span class="n">invalid_nids</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="delete_invalid_eids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_invalid_eids">[docs]</a><span class="k">def</span> <span class="nf">delete_invalid_eids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Removes encounters without images &quot;&quot;&quot;</span>
    <span class="n">eid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_eids</span><span class="p">(</span><span class="n">min_num_gids</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">nGids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_num_gids</span><span class="p">(</span><span class="n">eid_list</span><span class="p">)</span>
    <span class="n">is_invalid</span> <span class="o">=</span> <span class="p">[</span><span class="n">nGids</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">nGids</span> <span class="ow">in</span> <span class="n">nGids_list</span><span class="p">]</span>
    <span class="n">invalid_eids</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">eid_list</span><span class="p">,</span> <span class="n">is_invalid</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_encounters</span><span class="p">(</span><span class="n">invalid_eids</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@getter_1to1</span>
<div class="viewcode-block" id="is_nid_unknown"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.is_nid_unknown">[docs]</a><span class="k">def</span> <span class="nf">is_nid_unknown</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span> <span class="n">nid</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">nid_list</span><span class="p">]</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_match_text"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_match_text">[docs]</a><span class="k">def</span> <span class="nf">get_match_text</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">):</span>
    <span class="n">truth</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_match_truth</span><span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;NEW Match &#39;</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">:</span> <span class="s">&#39;JOIN Match &#39;</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;SPLIT Match &#39;</span><span class="p">,</span>
    <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">truth</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_database_species"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_database_species">[docs]</a><span class="k">def</span> <span class="nf">get_database_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; #ibs = ibeis.opendb(&#39;GZ_ALL&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs.get_database_species()</span>
<span class="sd">        {&#39;____&#39;, u&#39;bear_polar&#39;, u&#39;zebra_grevys&#39;, u&#39;zebra_plains&#39;}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">unique_species</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">species_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">unique_species</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_database_species_count"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_database_species_count">[docs]</a><span class="k">def</span> <span class="nf">get_database_species_count</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; #print(ut.dict_str(ibeis.opendb(&#39;PZ_Master0&#39;).get_database_species_count()))</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs.get_database_species_count()</span>
<span class="sd">        {&#39;____&#39;: 3, u&#39;bear_polar&#39;: 2, u&#39;zebra_grevys&#39;: 2, u&#39;zebra_plains&#39;: 6}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">species_count_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">item_hist</span><span class="p">(</span><span class="n">species_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">species_count_dict</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="set_annot_names_to_next_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_annot_names_to_next_name">[docs]</a><span class="k">def</span> <span class="nf">set_annot_names_to_next_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">next_name</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">make_next_name</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_names</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">next_name</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<span class="k">def</span> <span class="nf">_overwrite_annot_species_to_plains</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">Species</span><span class="o">.</span><span class="n">ZEB_PLAIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)</span>


<span class="nd">@__injectable</span>
<span class="k">def</span> <span class="nf">_overwrite_annot_species_to_grevys</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">Species</span><span class="o">.</span><span class="n">ZEB_GREVY</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)</span>


<span class="nd">@__injectable</span>
<span class="k">def</span> <span class="nf">_overwrite_annot_species_to_giraffe</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">Species</span><span class="o">.</span><span class="n">GIR</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)</span>


<span class="nd">@__injectable</span>
<span class="k">def</span> <span class="nf">_overwrite_all_annot_species_to</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">species</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; THIS OVERWRITES A LOT OF INFO &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">VALID_SPECIES</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">species</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;is not in &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">VALID_SPECIES</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">)</span>


<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_match_truth"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_match_truth">[docs]</a><span class="k">def</span> <span class="nf">get_match_truth</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">):</span>
    <span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">((</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">))</span>
    <span class="n">isunknown_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">((</span><span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">isunknown_list</span><span class="p">):</span>
        <span class="n">truth</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c"># Unknown</span>
    <span class="k">elif</span> <span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span><span class="p">:</span>
        <span class="n">truth</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c"># True</span>
    <span class="k">elif</span> <span class="n">nid1</span> <span class="o">!=</span> <span class="n">nid2</span><span class="p">:</span>
        <span class="n">truth</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c"># False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;invalid_unknown_truth_state&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">truth</span>


<span class="c"># Use new invertable flatten functions</span></div>
<span class="n">_invertable_flatten</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">invertable_flatten2</span>
<span class="n">_unflatten</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">unflatten2</span>


<div class="viewcode-block" id="unflat_map"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.unflat_map">[docs]</a><span class="k">def</span> <span class="nf">unflat_map</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">unflat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses an ibeis lookup function with a non-flat rowid list.</span>
<span class="sd">    In essence this is equivilent to map(method, unflat_rowids).</span>
<span class="sd">    The utility of this function is that it only calls method once.</span>
<span class="sd">    This is more efficient for calls that can take a list of inputs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#utool.assert_unflat_level(unflat_rowids, level=1, basetype=(int, uuid.UUID))</span>
    <span class="c"># First flatten the list, and remember the original dimensions</span>
    <span class="n">flat_rowids</span><span class="p">,</span> <span class="n">reverse_list</span> <span class="o">=</span> <span class="n">_invertable_flatten</span><span class="p">(</span><span class="n">unflat_rowids</span><span class="p">)</span>
    <span class="c"># Then preform the lookup / implicit mapping</span>
    <span class="n">flat_vals</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">flat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c"># Then _unflatten the results to the original input dimensions</span>
    <span class="n">unflat_vals</span> <span class="o">=</span> <span class="n">_unflatten</span><span class="p">(</span><span class="n">flat_vals</span><span class="p">,</span> <span class="n">reverse_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unflat_vals</span>

</div>
<div class="viewcode-block" id="unflat_multimap"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.unflat_multimap">[docs]</a><span class="k">def</span> <span class="nf">unflat_multimap</span><span class="p">(</span><span class="n">method_list</span><span class="p">,</span> <span class="n">unflat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; unflat_map, but allows multiple methods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># First flatten the list, and remember the original dimensions</span>
    <span class="n">flat_rowids</span><span class="p">,</span> <span class="n">reverse_list</span> <span class="o">=</span> <span class="n">_invertable_flatten</span><span class="p">(</span><span class="n">unflat_rowids</span><span class="p">)</span>
    <span class="c"># Then preform the lookup / implicit mapping</span>
    <span class="n">flat_vals_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">method</span><span class="p">(</span><span class="n">flat_rowids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">method_list</span><span class="p">]</span>
    <span class="c"># Then _unflatten the results to the original input dimensions</span>
    <span class="n">unflat_vals_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_unflatten</span><span class="p">(</span><span class="n">flat_vals</span><span class="p">,</span> <span class="n">reverse_list</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">flat_vals</span> <span class="ow">in</span> <span class="n">flat_vals_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">unflat_vals_list</span>

<span class="c"># TODO: Depricate the lookup names</span></div>
<span class="n">unflat_lookup</span> <span class="o">=</span> <span class="n">unflat_map</span>


<span class="k">def</span> <span class="nf">_make_unflat_getter_func</span><span class="p">(</span><span class="n">flat_getter</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flat_getter</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">):</span>
        <span class="c"># Unwrap fmethods</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">get_imfunc</span><span class="p">(</span><span class="n">flat_getter</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">flat_getter</span>
    <span class="n">funcname</span> <span class="o">=</span> <span class="n">get_funcname</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">funcname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;get_&#39;</span><span class="p">),</span> <span class="s">&#39;only works on getters, not: &#39;</span> <span class="o">+</span> <span class="n">funcname</span>
    <span class="c"># Create new function</span>
    <span class="k">def</span> <span class="nf">unflat_getter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unflat_rowids</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># First flatten the list</span>
        <span class="n">flat_rowids</span><span class="p">,</span> <span class="n">reverse_list</span> <span class="o">=</span> <span class="n">_invertable_flatten</span><span class="p">(</span><span class="n">unflat_rowids</span><span class="p">)</span>
        <span class="c"># Then preform the lookup</span>
        <span class="n">flat_vals</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flat_rowids</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c"># Then _unflatten the list</span>
        <span class="n">unflat_vals</span> <span class="o">=</span> <span class="n">_unflatten</span><span class="p">(</span><span class="n">flat_vals</span><span class="p">,</span> <span class="n">reverse_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unflat_vals</span>
    <span class="n">set_funcname</span><span class="p">(</span><span class="n">unflat_getter</span><span class="p">,</span> <span class="n">funcname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;get_&#39;</span><span class="p">,</span> <span class="s">&#39;get_unflat_&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">unflat_getter</span>


<div class="viewcode-block" id="delete_ibeis_database"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_ibeis_database">[docs]</a><span class="k">def</span> <span class="nf">delete_ibeis_database</span><span class="p">(</span><span class="n">dbdir</span><span class="p">):</span>
    <span class="n">_ibsdb</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dbdir</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">PATH_NAMES</span><span class="o">.</span><span class="n">_ibsdb</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] DELETEING: _ibsdb=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">_ibsdb</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">_ibsdb</span><span class="p">):</span>
        <span class="n">utool</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">_ibsdb</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="assert_valid_names"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_valid_names">[docs]</a><span class="k">def</span> <span class="nf">assert_valid_names</span><span class="p">(</span><span class="n">name_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Asserts that user specified names do not conflict with</span>
<span class="sd">    the standard unknown name &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">def</span> <span class="nf">isconflict</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="n">valid_namecheck</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="n">isconflict</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">valid_namecheck</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;A name conflicts with UKNONWN Name. -- &#39;</span>
                                  <span class="s">&#39;cannot start a name with four underscores&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="assert_lblannot_rowids_are_type"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.assert_lblannot_rowids_are_type">[docs]</a><span class="k">def</span> <span class="nf">assert_lblannot_rowids_are_type</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">lblannot_rowid_list</span><span class="p">,</span> <span class="n">valid_lbltype_rowid</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">NO_ASSERTS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">lbltype_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_lblannot_lbltypes_rowids</span><span class="p">(</span><span class="n">lblannot_rowid_list</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># HACK: the unknown_lblannot_rowid will have a None type</span>
        <span class="c"># the unknown lblannot_rowid should be handled more gracefully</span>
        <span class="c"># this should just check the first condition (get rid of the or)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lbltype_rowid_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lbltype_rowid_list</span><span class="p">),</span> <span class="s">&#39;lens dont match&#39;</span>
        <span class="n">validtype_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">lbltype_rowid</span> <span class="o">==</span> <span class="n">valid_lbltype_rowid</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">lbltype_rowid</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">lblannot_rowid</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">UNKNOWN_LBLANNOT_ROWID</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">lbltype_rowid</span><span class="p">,</span> <span class="n">lblannot_rowid</span> <span class="ow">in</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">lbltype_rowid_list</span><span class="p">,</span> <span class="n">lblannot_rowid_list</span><span class="p">)]</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">validtype_list</span><span class="p">),</span> <span class="s">&#39;not all types match valid type&#39;</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">tup_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lbltype_rowid_list</span><span class="p">,</span> <span class="n">lblannot_rowid_list</span><span class="p">))))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[!!!] (lbltype_rowid, lblannot_rowid) = : &#39;</span> <span class="o">+</span> <span class="n">utool</span><span class="o">.</span><span class="n">indentjoin</span><span class="p">(</span><span class="n">tup_list</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[!!!] valid_lbltype_rowid: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">valid_lbltype_rowid</span><span class="p">,))</span>
        <span class="n">utool</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;not all types match valid type&#39;</span><span class="p">,</span>
                      <span class="n">key_list</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;valid_lbltype_rowid&#39;</span><span class="p">])</span>
        <span class="k">raise</span>

</div>
<div class="viewcode-block" id="ensure_unix_gpaths"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.ensure_unix_gpaths">[docs]</a><span class="k">def</span> <span class="nf">ensure_unix_gpaths</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asserts that all paths are given with forward slashes.</span>
<span class="sd">    If not it fixes them</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#if utool.NO_ASSERTS:</span>
    <span class="c">#    return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;gpath_list must be in unix format (no backslashes).&#39;</span>
               <span class="s">&#39;Failed on </span><span class="si">%d</span><span class="s">-th gpath=</span><span class="si">%r</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">gpath</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gpath_list</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">gpath</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">gpath</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">utool</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">gpath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">unixpath</span><span class="p">,</span> <span class="n">gpath_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gpath_list</span>

</div>
<div class="viewcode-block" id="aidstr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.aidstr">[docs]</a><span class="k">def</span> <span class="nf">aidstr</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Helper to make a string from an RID &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">notes</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;aid</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">name</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_names</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;aid</span><span class="si">%d</span><span class="s">-</span><span class="si">%r</span><span class="s">-</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">notes</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="vsstr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.vsstr">[docs]</a><span class="k">def</span> <span class="nf">vsstr</span><span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">lite</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">lite</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">-vs-</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">aid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;qaid</span><span class="si">%d</span><span class="s">-vs-aid</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">aid</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="list_images"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.list_images">[docs]</a><span class="k">def</span> <span class="nf">list_images</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">fullpath</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; lists images that are not in an internal cache &quot;&quot;&quot;</span>
    <span class="n">ignore_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;_hsdb&#39;</span><span class="p">,</span> <span class="s">&#39;.hs_internals&#39;</span><span class="p">,</span> <span class="s">&#39;_ibeis_cache&#39;</span><span class="p">,</span> <span class="s">&#39;_ibsdb&#39;</span><span class="p">]</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">list_images</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span>
                                   <span class="n">fullpath</span><span class="o">=</span><span class="n">fullpath</span><span class="p">,</span>
                                   <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
                                   <span class="n">ignore_list</span><span class="o">=</span><span class="n">ignore_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gpath_list</span>

</div>
<div class="viewcode-block" id="make_annotation_uuids"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.make_annotation_uuids">[docs]</a><span class="k">def</span> <span class="nf">make_annotation_uuids</span><span class="p">(</span><span class="n">image_uuid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">augment_uuid</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">util_hash</span><span class="o">.</span><span class="n">augment_uuid</span>
    <span class="n">random_uuid</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">util_hash</span><span class="o">.</span><span class="n">random_uuid</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Check to make sure bbox input is a tuple-list, not a list-list</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s">&#39;Bounding boxes must be tuples of ints!&#39;</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span> <span class="s">&#39;Bounding boxes must be tuples of ints!&#39;</span>
            <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">utool</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;bbox_list = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bbox_list</span><span class="p">,))</span>
                <span class="k">raise</span>
        <span class="n">annotation_uuid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">augment_uuid</span><span class="p">(</span><span class="n">img_uuid</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">img_uuid</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">theta</span>
                                <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image_uuid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deterministic</span><span class="p">:</span>
            <span class="c"># Augment determenistic uuid with a random uuid to ensure randomness</span>
            <span class="c"># (this should be ensured in all hardward situations)</span>
            <span class="n">annotation_uuid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">augment_uuid</span><span class="p">(</span><span class="n">random_uuid</span><span class="p">(),</span> <span class="n">_uuid</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">_uuid</span> <span class="ow">in</span> <span class="n">annotation_uuid_list</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">utool</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;Error building annotation_uuids&#39;</span><span class="p">,</span> <span class="s">&#39;[add_annot]&#39;</span><span class="p">,</span>
                      <span class="n">key_list</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;image_uuid_list&#39;</span><span class="p">])</span>
        <span class="k">raise</span>
    <span class="k">return</span> <span class="n">annotation_uuid_list</span>

</div>
<div class="viewcode-block" id="get_species_dbs"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_species_dbs">[docs]</a><span class="k">def</span> <span class="nf">get_species_dbs</span><span class="p">(</span><span class="n">species_prefix</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.dev</span> <span class="kn">import</span> <span class="n">sysres</span>
    <span class="n">ibs_dblist</span> <span class="o">=</span> <span class="n">sysres</span><span class="o">.</span><span class="n">get_ibsdb_list</span><span class="p">()</span>
    <span class="n">isvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">species_prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">ibs_dblist</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">ibs_dblist</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="merge_species_databases"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.merge_species_databases">[docs]</a><span class="k">def</span> <span class="nf">merge_species_databases</span><span class="p">(</span><span class="n">species_prefix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Build a merged database &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.control</span> <span class="kn">import</span> <span class="n">IBEISControl</span>
    <span class="kn">from</span> <span class="nn">ibeis.dev</span> <span class="kn">import</span> <span class="n">sysres</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] Merging species with prefix: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">species_prefix</span><span class="p">)</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">util_parallel</span><span class="o">.</span><span class="n">ensure_pool</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">utool</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s">&#39;    &#39;</span><span class="p">):</span>
        <span class="c"># Build / get target database</span>
        <span class="n">all_db</span> <span class="o">=</span> <span class="s">&#39;__ALL_&#39;</span> <span class="o">+</span> <span class="n">species_prefix</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span>
        <span class="n">all_dbdir</span> <span class="o">=</span> <span class="n">sysres</span><span class="o">.</span><span class="n">db_to_dbdir</span><span class="p">(</span><span class="n">all_db</span><span class="p">,</span> <span class="n">allow_newdir</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">ibs_target</span> <span class="o">=</span> <span class="n">IBEISControl</span><span class="o">.</span><span class="n">IBEISController</span><span class="p">(</span><span class="n">all_dbdir</span><span class="p">)</span>
        <span class="c"># Build list of databases to merge</span>
        <span class="n">species_dbdir_list</span> <span class="o">=</span> <span class="n">get_species_dbs</span><span class="p">(</span><span class="n">species_prefix</span><span class="p">)</span>
        <span class="n">ibs_source_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dbdir</span> <span class="ow">in</span> <span class="n">species_dbdir_list</span><span class="p">:</span>
            <span class="n">ibs_source</span> <span class="o">=</span> <span class="n">IBEISControl</span><span class="o">.</span><span class="n">IBEISController</span><span class="p">(</span><span class="n">dbdir</span><span class="p">)</span>
            <span class="n">ibs_source_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ibs_source</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] Destination database: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">all_db</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] Source databases:&#39;</span> <span class="o">+</span>
          <span class="n">utool</span><span class="o">.</span><span class="n">indentjoin</span><span class="p">(</span><span class="n">species_dbdir_list</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s"> *   &#39;</span><span class="p">))</span>
    <span class="c">#Merge the databases into ibs_target</span>
    <span class="n">merge_databases</span><span class="p">(</span><span class="n">ibs_target</span><span class="p">,</span> <span class="n">ibs_source_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ibs_target</span>

</div>
<div class="viewcode-block" id="merge_databases"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.merge_databases">[docs]</a><span class="k">def</span> <span class="nf">merge_databases</span><span class="p">(</span><span class="n">ibs_target</span><span class="p">,</span> <span class="n">ibs_source_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Merges a list of databases into a target</span>
<span class="sd">    This is OLD. use export_subset instead</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;Use transfer_subset instead&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">merge_images</span><span class="p">(</span><span class="n">ibs_target</span><span class="p">,</span> <span class="n">ibs_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; merge image helper &quot;&quot;&quot;</span>
        <span class="n">gid_list1</span>   <span class="o">=</span> <span class="n">ibs_source</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
        <span class="n">uuid_list1</span>  <span class="o">=</span> <span class="n">ibs_source</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">(</span><span class="n">gid_list1</span><span class="p">)</span>
        <span class="n">gpath_list1</span> <span class="o">=</span> <span class="n">ibs_source</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list1</span><span class="p">)</span>
        <span class="n">reviewed_list1</span> <span class="o">=</span> <span class="n">ibs_source</span><span class="o">.</span><span class="n">get_image_reviewed</span><span class="p">(</span><span class="n">gid_list1</span><span class="p">)</span>
        <span class="c"># Add images to target</span>
        <span class="n">ibs_target</span><span class="o">.</span><span class="n">add_images</span><span class="p">(</span><span class="n">gpath_list1</span><span class="p">)</span>
        <span class="c"># Merge properties</span>
        <span class="n">gid_list2</span>  <span class="o">=</span> <span class="n">ibs_target</span><span class="o">.</span><span class="n">get_image_gids_from_uuid</span><span class="p">(</span><span class="n">uuid_list1</span><span class="p">)</span>
        <span class="n">ibs_target</span><span class="o">.</span><span class="n">set_image_reviewed</span><span class="p">(</span><span class="n">gid_list2</span><span class="p">,</span> <span class="n">reviewed_list1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">merge_annotations</span><span class="p">(</span><span class="n">ibs_target</span><span class="p">,</span> <span class="n">ibs_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; merge annotations helper &quot;&quot;&quot;</span>
        <span class="n">aid_list1</span>   <span class="o">=</span> <span class="n">ibs_source</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
        <span class="n">uuid_list1</span>  <span class="o">=</span> <span class="n">ibs_source</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">(</span><span class="n">aid_list1</span><span class="p">)</span>
        <span class="c"># Get the images in target_db</span>
        <span class="n">gid_list1</span>   <span class="o">=</span> <span class="n">ibs_source</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">aid_list1</span><span class="p">)</span>
        <span class="n">bbox_list1</span>  <span class="o">=</span> <span class="n">ibs_source</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list1</span><span class="p">)</span>
        <span class="n">theta_list1</span> <span class="o">=</span> <span class="n">ibs_source</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">(</span><span class="n">aid_list1</span><span class="p">)</span>
        <span class="n">name_list1</span>  <span class="o">=</span> <span class="n">ibs_source</span><span class="o">.</span><span class="n">get_annot_names</span><span class="p">(</span><span class="n">aid_list1</span><span class="p">)</span>
        <span class="n">notes_list1</span> <span class="o">=</span> <span class="n">ibs_source</span><span class="o">.</span><span class="n">get_annot_notes</span><span class="p">(</span><span class="n">aid_list1</span><span class="p">)</span>

        <span class="n">image_uuid_list1</span> <span class="o">=</span> <span class="n">ibs_source</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">(</span><span class="n">gid_list1</span><span class="p">)</span>
        <span class="n">gid_list2</span>  <span class="o">=</span> <span class="n">ibs_target</span><span class="o">.</span><span class="n">get_image_gids_from_uuid</span><span class="p">(</span><span class="n">image_uuid_list1</span><span class="p">)</span>
        <span class="n">image_uuid_list2</span> <span class="o">=</span> <span class="n">ibs_target</span><span class="o">.</span><span class="n">get_image_uuids</span><span class="p">(</span><span class="n">gid_list2</span><span class="p">)</span>
        <span class="c"># Assert that the image uuids have not changed</span>
        <span class="k">assert</span> <span class="n">image_uuid_list1</span> <span class="o">==</span> <span class="n">image_uuid_list2</span><span class="p">,</span> <span class="s">&#39;error merging annotation image uuids&#39;</span>
        <span class="n">aid_list2</span> <span class="o">=</span> <span class="n">ibs_target</span><span class="o">.</span><span class="n">add_annots</span><span class="p">(</span><span class="n">gid_list2</span><span class="p">,</span>
                                          <span class="n">bbox_list1</span><span class="p">,</span>
                                          <span class="n">theta_list</span><span class="o">=</span><span class="n">theta_list1</span><span class="p">,</span>
                                          <span class="n">name_list</span><span class="o">=</span><span class="n">name_list1</span><span class="p">,</span>
                                          <span class="n">notes_list</span><span class="o">=</span><span class="n">notes_list1</span><span class="p">)</span>
        <span class="n">uuid_list2</span> <span class="o">=</span> <span class="n">ibs_target</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">(</span><span class="n">aid_list2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">uuid_list2</span> <span class="o">==</span> <span class="n">uuid_list1</span><span class="p">,</span> <span class="s">&#39;error merging annotation uuids&#39;</span>

    <span class="c"># Do the merging</span>
    <span class="k">for</span> <span class="n">ibs_source</span> <span class="ow">in</span> <span class="n">ibs_source_list</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Merging &#39;</span> <span class="o">+</span> <span class="n">ibs_source</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span> <span class="o">+</span>
                  <span class="s">&#39; into &#39;</span> <span class="o">+</span> <span class="n">ibs_target</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">())</span>
            <span class="n">merge_images</span><span class="p">(</span><span class="n">ibs_target</span><span class="p">,</span> <span class="n">ibs_source</span><span class="p">)</span>
            <span class="n">merge_annotations</span><span class="p">(</span><span class="n">ibs_target</span><span class="p">,</span> <span class="n">ibs_source</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">utool</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;error merging &#39;</span> <span class="o">+</span> <span class="n">ibs_source</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span> <span class="o">+</span>
                          <span class="s">&#39; into &#39;</span> <span class="o">+</span> <span class="n">ibs_target</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">())</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@utool.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="delete_non_exemplars"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.delete_non_exemplars">[docs]</a><span class="k">def</span> <span class="nf">delete_non_exemplars</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">flags_list</span> <span class="o">=</span> <span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_exemplar_flag</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="n">delete_gid_flag_list</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="k">for</span> <span class="n">flags</span> <span class="ow">in</span> <span class="n">flags_list</span><span class="p">]</span>
    <span class="n">delete_gid_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">delete_gid_flag_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">delete_images</span><span class="p">(</span><span class="n">delete_gid_list</span><span class="p">)</span>
    <span class="n">delete_invalid_eids</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>
    <span class="n">delete_invalid_nids</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@utool.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_exemplar_encounter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_exemplar_encounter">[docs]</a><span class="k">def</span> <span class="nf">update_exemplar_encounter</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">exemplar_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">EXEMPLAR_ENCTEXT</span><span class="p">)</span>
    <span class="c">#ibs.delete_encounters(exemplar_eid)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">unrelate_encounter_from_images</span><span class="p">(</span><span class="n">exemplar_eid</span><span class="p">)</span>
    <span class="c">#aid_list = ibs.get_valid_aids(is_exemplar=True)</span>
    <span class="c">#gid_list = utool.unique_ordered(ibs.get_annot_gids(aid_list))</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_get_exemplar_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">)))</span>
    <span class="c">#ibs.set_image_enctext(gid_list, [constants.EXEMPLAR_ENCTEXT] * len(gid_list))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">exemplar_eid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@utool.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_reviewed_unreviewed_image_encounter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_reviewed_unreviewed_image_encounter">[docs]</a><span class="k">def</span> <span class="nf">update_reviewed_unreviewed_image_encounter</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">unreviewed_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">UNREVIEWED_IMAGE_ENCTEXT</span><span class="p">)</span>
    <span class="n">reviewed_eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">REVIEWED_IMAGE_ENCTEXT</span><span class="p">)</span>
    <span class="c">#ibs.delete_encounters(eid)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">unrelate_encounter_from_images</span><span class="p">(</span><span class="n">unreviewed_eid</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">unrelate_encounter_from_images</span><span class="p">(</span><span class="n">reviewed_eid</span><span class="p">)</span>
    <span class="c">#gid_list = ibs.get_valid_gids(reviewed=False)</span>
    <span class="c">#ibs.set_image_enctext(gid_list, [constants.UNREVIEWED_IMAGE_ENCTEXT] * len(gid_list))</span>
    <span class="n">unreviewed_gids</span> <span class="o">=</span> <span class="n">_get_unreviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>  <span class="c"># hack</span>
    <span class="n">reviewed_gids</span>   <span class="o">=</span> <span class="n">_get_reviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>  <span class="c"># hack</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">(</span><span class="n">unreviewed_gids</span><span class="p">,</span> <span class="p">[</span><span class="n">unreviewed_eid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">unreviewed_gids</span><span class="p">))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">(</span><span class="n">reviewed_gids</span><span class="p">,</span> <span class="p">[</span><span class="n">reviewed_eid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">reviewed_gids</span><span class="p">))</span>


<span class="c">#@__injectable</span>
<span class="c">#@utool.time_func</span>
<span class="c">#@profile</span>
<span class="c">#def update_reviewed_image_encounter(ibs):</span>
<span class="c">#    # FIXME SLOW</span>
<span class="c">#    #ibs.delete_encounters(eid)</span>
<span class="c">#    ibs.unrelate_encounter_from_images(eid)</span>
<span class="c">#    #gid_list = ibs.get_valid_gids(reviewed=True)</span>
<span class="c">#    gid_list = _get_reviewed_gids(ibs)  # hack</span>
<span class="c">#    #ibs.set_image_enctext(gid_list, [constants.REVIEWED_IMAGE_ENCTEXT] * len(gid_list))</span>
<span class="c">#    ibs.set_image_eids(gid_list, [eid] * len(gid_list))</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@utool.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_all_image_encounter"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_all_image_encounter">[docs]</a><span class="k">def</span> <span class="nf">update_all_image_encounter</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">eid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_eids_from_text</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ALL_IMAGE_ENCTEXT</span><span class="p">)</span>
    <span class="c">#ibs.delete_encounters(eid)</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
    <span class="c">#ibs.set_image_enctext(gid_list, [constants.ALL_IMAGE_ENCTEXT] * len(gid_list))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_eids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="p">[</span><span class="n">eid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<span class="nd">@utool.time_func</span>
<span class="c">#@profile</span>
<div class="viewcode-block" id="update_special_encounters"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.update_special_encounters">[docs]</a><span class="k">def</span> <span class="nf">update_special_encounters</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># FIXME SLOW</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">update_exemplar_encounter</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">update_reviewed_unreviewed_image_encounter</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">update_all_image_encounter</span><span class="p">()</span>

</div>
<span class="k">def</span> <span class="nf">_get_unreviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># hack</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {IMAGE_TABLE}</span>
<span class="sd">        WHERE</span>
<span class="sd">        image_toggle_reviewed=0</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">constants</span><span class="o">.</span><span class="n">__dict__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="k">def</span> <span class="nf">_get_reviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c"># hack</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {IMAGE_TABLE}</span>
<span class="sd">        WHERE</span>
<span class="sd">        image_toggle_reviewed=1</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">constants</span><span class="o">.</span><span class="n">__dict__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="k">def</span> <span class="nf">_get_gids_in_eid</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid</span><span class="p">):</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {EG_RELATION_TABLE}</span>
<span class="sd">        WHERE</span>
<span class="sd">            encounter_rowid==?</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">constants</span><span class="o">.</span><span class="n">__dict__</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">eid</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="k">def</span> <span class="nf">_get_dirty_reviewed_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid</span><span class="p">):</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {EG_RELATION_TABLE}</span>
<span class="sd">        WHERE</span>
<span class="sd">            encounter_rowid==? AND</span>
<span class="sd">            image_rowid NOT IN (SELECT rowid FROM {IMAGE_TABLE} WHERE image_toggle_reviewed=1)</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">constants</span><span class="o">.</span><span class="n">__dict__</span><span class="p">),</span>
        <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">eid</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<span class="k">def</span> <span class="nf">_get_exemplar_gids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SELECT image_rowid</span>
<span class="sd">        FROM {ANNOTATION_TABLE}</span>
<span class="sd">        WHERE annot_exemplar_flag=1</span>
<span class="sd">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">constants</span><span class="o">.</span><span class="n">__dict__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gid_list</span>


<div class="viewcode-block" id="get_title"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_title">[docs]</a><span class="k">def</span> <span class="nf">get_title</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;IBEIS - No Database Directory Open&#39;</span>
    <span class="k">elif</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbdir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;IBEIS - !! INVALID DATABASE !!&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dbdir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbdir</span><span class="p">()</span>
        <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;IBEIS - </span><span class="si">%r</span><span class="s"> - Database Directory = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">title</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_stats"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_stats">[docs]</a><span class="k">def</span> <span class="nf">print_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.dev</span> <span class="kn">import</span> <span class="n">dbinfo</span>
    <span class="n">dbinfo</span><span class="o">.</span><span class="n">dbstats</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_dbinfo"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_dbinfo">[docs]</a><span class="k">def</span> <span class="nf">print_dbinfo</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ibeis.dev</span> <span class="kn">import</span> <span class="n">dbinfo</span>
    <span class="n">dbinfo</span><span class="o">.</span><span class="n">get_dbinfo</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_infostr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_infostr">[docs]</a><span class="k">def</span> <span class="nf">get_infostr</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns printable database information &quot;&quot;&quot;</span>
    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span>
    <span class="n">workdir</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">unixpath</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_workdir</span><span class="p">())</span>
    <span class="n">num_images</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_num_images</span><span class="p">()</span>
    <span class="n">num_annotations</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_num_annotations</span><span class="p">()</span>
    <span class="n">num_names</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_num_names</span><span class="p">()</span>
    <span class="n">infostr</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">    workdir = </span><span class="si">%r</span><span class="s"></span>
<span class="s">    dbname = </span><span class="si">%r</span><span class="s"></span>
<span class="s">    num_images = </span><span class="si">%r</span><span class="s"></span>
<span class="s">    num_annotations = </span><span class="si">%r</span><span class="s"></span>
<span class="s">    num_names = </span><span class="si">%r</span><span class="s"></span>
<span class="s">    &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">num_images</span><span class="p">,</span> <span class="n">num_annotations</span><span class="p">,</span> <span class="n">num_names</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">infostr</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_annotation_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_annotation_table">[docs]</a><span class="k">def</span> <span class="nf">print_annotation_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps annotation table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;annotation_uuid&#39;</span><span class="p">,</span> <span class="s">&#39;annotation_verts&#39;</span><span class="p">]))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_chip_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_chip_table">[docs]</a><span class="k">def</span> <span class="nf">print_chip_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">CHIP_TABLE</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_feat_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_feat_table">[docs]</a><span class="k">def</span> <span class="nf">print_feat_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">FEATURE_TABLE</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span>
        <span class="s">&#39;feature_keypoints&#39;</span><span class="p">,</span> <span class="s">&#39;feature_vecs&#39;</span><span class="p">]))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_image_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_image_table">[docs]</a><span class="k">def</span> <span class="nf">print_image_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">))</span>
    <span class="c">#, exclude_columns=[&#39;image_rowid&#39;]))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_lblannot_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_lblannot_table">[docs]</a><span class="k">def</span> <span class="nf">print_lblannot_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">LBLANNOT_TABLE</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_alr_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_alr_table">[docs]</a><span class="k">def</span> <span class="nf">print_alr_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">AL_RELATION_TABLE</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_config_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_config_table">[docs]</a><span class="k">def</span> <span class="nf">print_config_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">CONFIG_TABLE</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_encounter_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_encounter_table">[docs]</a><span class="k">def</span> <span class="nf">print_encounter_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ENCOUNTER_TABLE</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_egpairs_table"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_egpairs_table">[docs]</a><span class="k">def</span> <span class="nf">print_egpairs_table</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dumps chip table to stdout &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">EG_RELATION_TABLE</span><span class="p">))</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="print_tables"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.print_tables">[docs]</a><span class="k">def</span> <span class="nf">print_tables</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude_tables</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">exclude_columns</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">exclude_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;annot_uuid&#39;</span><span class="p">,</span> <span class="s">&#39;lblannot_uuid&#39;</span><span class="p">,</span> <span class="s">&#39;annot_verts&#39;</span><span class="p">,</span> <span class="s">&#39;feature_keypoints&#39;</span><span class="p">,</span>
                           <span class="s">&#39;feature_vecs&#39;</span><span class="p">,</span> <span class="s">&#39;image_uuid&#39;</span><span class="p">,</span> <span class="s">&#39;image_uri&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">exclude_tables</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">exclude_tables</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;masks&#39;</span><span class="p">,</span> <span class="s">&#39;recognitions&#39;</span><span class="p">,</span> <span class="s">&#39;chips&#39;</span><span class="p">,</span> <span class="s">&#39;features&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">exclude_tables</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">))</span>
    <span class="c">#ibs.print_image_table()</span>
    <span class="c">#ibs.print_annotation_table()</span>
    <span class="c">#ibs.print_lblannots_table()</span>
    <span class="c">#ibs.print_alr_table()</span>
    <span class="c">#ibs.print_config_table()</span>
    <span class="c">#ibs.print_chip_table()</span>
    <span class="c">#ibs.print_feat_table()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>


<span class="c">#@getter_1to1</span></div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="is_aid_unknown"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.is_aid_unknown">[docs]</a><span class="k">def</span> <span class="nf">is_aid_unknown</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="make_enctext_list"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.make_enctext_list">[docs]</a><span class="k">def</span> <span class="nf">make_enctext_list</span><span class="p">(</span><span class="n">eid_list</span><span class="p">,</span> <span class="n">enc_cfgstr</span><span class="p">):</span>
    <span class="c"># DEPRICATE</span>
    <span class="n">enctext_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span> <span class="o">+</span> <span class="n">enc_cfgstr</span> <span class="k">for</span> <span class="n">eid</span> <span class="ow">in</span> <span class="n">eid_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">enctext_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="make_next_name"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.make_next_name">[docs]</a><span class="k">def</span> <span class="nf">make_next_name</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Creates a number of names which are not in the database, but does not</span>
<span class="sd">    add them &quot;&quot;&quot;</span>
    <span class="n">num_names</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_num_names</span><span class="p">()</span>
    <span class="n">userid</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">get_user_name</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">(</span><span class="s">&#39;tag&#39;</span><span class="p">)</span>
    <span class="n">name_prefix</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="o">+</span> <span class="s">&#39;_TMP_&#39;</span> <span class="o">+</span> <span class="n">userid</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span>
    <span class="k">if</span> <span class="n">num</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">next_name</span> <span class="o">=</span> <span class="n">name_prefix</span> <span class="o">+</span> <span class="s">&#39;</span><span class="si">%04d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">num_names</span>
        <span class="k">return</span> <span class="n">next_name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">next_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name_prefix</span> <span class="o">+</span> <span class="s">&#39;</span><span class="si">%04d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_names</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">next_names</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="prune_exemplars"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.prune_exemplars">[docs]</a><span class="k">def</span> <span class="nf">prune_exemplars</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_nids</span><span class="p">()</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_exemplar_aids</span><span class="p">(</span><span class="n">nid_list</span><span class="p">)</span>
    <span class="n">MAX_EXEMPLAR</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">problem_aids</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_list</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_EXEMPLAR</span><span class="p">]</span>
    <span class="n">problem_bboxes</span> <span class="o">=</span> <span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">,</span> <span class="n">problem_aids</span><span class="p">)</span>
    <span class="c">#problem_gids   = unflat_map(ibs.get_annot_gids, problem_aids)</span>
    <span class="c">#problem_sizes  = unflat_map(ibs.get_image_sizes, problem_gids)</span>
    <span class="k">def</span> <span class="nf">bbox_area</span><span class="p">(</span><span class="n">bbox</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">bbox</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">bbox</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">bboxes_area</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">bbox_area</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">))</span>

    <span class="c"># Get area of annotations, area of parent images, and the ratio</span>

    <span class="n">problem_annot_areas</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">bboxes_area</span><span class="p">,</span> <span class="n">problem_bboxes</span><span class="p">))))</span>

    <span class="c">#problem_img_areas = list(map(np.array, list(map(bboxes_area, problem_sizes))))</span>

    <span class="c">#problem_ratios = [(annot_areas / img_areas) for annot_areas, img_areas in</span>
    <span class="c">#                  zip(problem_annot_areas, problem_img_areas)]</span>

    <span class="n">problem_sortx</span> <span class="o">=</span> <span class="p">[</span><span class="n">areas</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span> <span class="k">for</span> <span class="n">areas</span> <span class="ow">in</span> <span class="n">problem_annot_areas</span><span class="p">]</span>
    <span class="c"># Get aids with the smallest bounding boxes to unexemplar</span>
    <span class="n">small_aids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">aids</span><span class="p">[</span><span class="n">sortx</span><span class="p">][:</span><span class="o">-</span><span class="n">MAX_EXEMPLAR</span><span class="p">]</span> <span class="k">for</span> <span class="n">aids</span><span class="p">,</span> <span class="n">sortx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">problem_aids</span><span class="p">,</span> <span class="n">problem_sortx</span><span class="p">)]</span>
    <span class="n">small_aids</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">small_aids_list</span><span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_exemplar_flag</span><span class="p">(</span><span class="n">small_aids</span><span class="p">,</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">small_aids</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="draw_thumb_helper"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.draw_thumb_helper">[docs]</a><span class="k">def</span> <span class="nf">draw_thumb_helper</span><span class="p">(</span><span class="n">tup</span><span class="p">):</span>
    <span class="n">thumb_path</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">,</span> <span class="n">gpath</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span> <span class="o">=</span> <span class="n">tup</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">gtool</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">gpath</span><span class="p">)</span>  <span class="c"># time consuming</span>
    <span class="p">(</span><span class="n">gh</span><span class="p">,</span> <span class="n">gw</span><span class="p">)</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">img_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">gw</span><span class="p">,</span> <span class="n">gh</span><span class="p">)</span>
    <span class="n">max_dsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">thumbsize</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">)</span>
    <span class="n">dsize</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">gtool</span><span class="o">.</span><span class="n">resized_clamped_thumb_dims</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">max_dsize</span><span class="p">)</span>
    <span class="n">new_verts_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gtool</span><span class="o">.</span><span class="n">scale_bbox_to_verts_gen</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">))</span>
    <span class="c">#thumb = gtool.resize_thumb(img, max_dsize)</span>
    <span class="c"># -----------------</span>
    <span class="c"># Actual computation</span>
    <span class="n">thumb</span> <span class="o">=</span> <span class="n">gtool</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dsize</span><span class="p">)</span>
    <span class="n">orange_bgr</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">new_verts</span> <span class="ow">in</span> <span class="n">new_verts_list</span><span class="p">:</span>
        <span class="n">thumb</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">draw_verts</span><span class="p">(</span><span class="n">thumb</span><span class="p">,</span> <span class="n">new_verts</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">orange_bgr</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">gtool</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">,</span> <span class="n">thumb</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#return (thumb_path, thumb)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="preprocess_image_thumbs"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.preprocess_image_thumbs">[docs]</a><span class="k">def</span> <span class="nf">preprocess_image_thumbs</span><span class="p">(</span>
        <span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes thumbs of images in parallel based on kwargs &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">gid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">thumbsize</span> <span class="o">=</span> <span class="mi">128</span>
    <span class="n">thumbpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_thumbpath</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">thumbsize</span><span class="o">=</span><span class="n">thumbsize</span><span class="p">)</span>
    <span class="c">#use_cache = False</span>
    <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
        <span class="n">exists_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">exists</span><span class="p">,</span> <span class="n">thumbpath_list</span><span class="p">))</span>
        <span class="n">gid_list_</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">exists_list</span><span class="p">)</span>
        <span class="n">thumbpath_list_</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">thumbpath_list</span><span class="p">,</span> <span class="n">exists_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gid_list_</span> <span class="o">=</span> <span class="n">gid_list</span>
        <span class="n">thumbpath_list_</span> <span class="o">=</span> <span class="n">thumbpath_list</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span>

    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span>
    <span class="n">bboxes_list</span> <span class="o">=</span> <span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
    <span class="n">thetas_list</span> <span class="o">=</span> <span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>

    <span class="n">args_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">thumb_path</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">,</span> <span class="n">gpath</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">thumb_path</span><span class="p">,</span> <span class="n">gpath</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span> <span class="ow">in</span>
                 <span class="nb">zip</span><span class="p">(</span><span class="n">thumbpath_list_</span><span class="p">,</span> <span class="n">gpath_list</span><span class="p">,</span> <span class="n">bboxes_list</span><span class="p">,</span> <span class="n">thetas_list</span><span class="p">)]</span>

    <span class="c"># Execute all tasks in parallel</span>
    <span class="n">genkw</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;ordered&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&#39;chunksize&#39;</span><span class="p">:</span> <span class="n">chunksize</span><span class="p">,</span>
        <span class="c">#&#39;force_serial&#39;: True,</span>
    <span class="p">}</span>
    <span class="c">#genkw[&#39;force_serial&#39;] = True</span>
    <span class="c">#genkw[&#39;chunksize&#39;] = max(len(gid_list_) // 16, 1)</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">draw_thumb_helper</span><span class="p">,</span> <span class="n">args_list</span><span class="p">,</span> <span class="n">nTasks</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">args_list</span><span class="p">),</span> <span class="o">**</span><span class="n">genkw</span><span class="p">)</span>
    <span class="c">#for output in gen:</span>
    <span class="c">#    #with utool.Timer(&#39;gentime&#39;):</span>
    <span class="c">#    gtool.imwrite(output[0], output[1])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">six</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">pass</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="compute_all_thumbs"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.compute_all_thumbs">[docs]</a><span class="k">def</span> <span class="nf">compute_all_thumbs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">preprocess_image_thumbs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="group_annots_by_known_names_nochecks"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.group_annots_by_known_names_nochecks">[docs]</a><span class="k">def</span> <span class="nf">group_annots_by_known_names_nochecks</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">nid2_aids</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">nid2_aids</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="group_annots_by_known_names"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.group_annots_by_known_names">[docs]</a><span class="k">def</span> <span class="nf">group_annots_by_known_names</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">checks</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    #&gt;&gt;&gt; import ibeis</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from ibeis import ibsfuncst *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(db=&#39;testdb1&#39;) #doctest: +ELLIPSIS</span>
<span class="sd">        [main]...</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13]</span>
<span class="sd">        &gt;&gt;&gt; known_aids_list, unknown_aids = group_annots_by_known_names(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; print(known_aids_list)</span>
<span class="sd">        [[2, 3], [5, 6], [7], [8], [10], [12], [13]]</span>
<span class="sd">        &gt;&gt;&gt; print(unknown_aids)</span>
<span class="sd">        [11, 9, 4, 1]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">nid2_aids</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>
    <span class="n">aid_gen</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">)</span>
    <span class="n">isunknown_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">))</span>
    <span class="n">known_aids_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">ifilterfalse_items</span><span class="p">(</span><span class="n">aid_gen</span><span class="p">(),</span> <span class="n">isunknown_list</span><span class="p">))</span>
    <span class="n">unknown_aids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">iflatten</span><span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">ifilter_items</span><span class="p">(</span><span class="n">aid_gen</span><span class="p">(),</span> <span class="n">isunknown_list</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
        <span class="c"># http://stackoverflow.com/questions/482014/how-would-you-do-the-equivalent-of-preprocessor-directives-in-python</span>
        <span class="n">nidgroup_list</span> <span class="o">=</span> <span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">,</span> <span class="n">known_aids_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nidgroup</span> <span class="ow">in</span> <span class="n">nidgroup_list</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">utool</span><span class="o">.</span><span class="n">list_allsame</span><span class="p">(</span><span class="n">nidgroup</span><span class="p">),</span> <span class="s">&#39;bad name grouping&#39;</span>
    <span class="k">return</span> <span class="n">known_aids_list</span><span class="p">,</span> <span class="n">unknown_aids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_groundfalse_sample"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_groundfalse_sample">[docs]</a><span class="k">def</span> <span class="nf">get_annot_groundfalse_sample</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">per_name</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; per_name = 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Get valid names</span>
    <span class="n">valid_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">valid_nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">)</span>
    <span class="n">nid2_aids</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">,</span> <span class="n">valid_nids</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nid2_aids</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">ibs</span><span class="o">.</span><span class="n">is_nid_unknown</span><span class="p">(</span><span class="n">nid</span><span class="p">):</span>
            <span class="c"># Remove unknown</span>
            <span class="k">del</span> <span class="n">nid2_aids</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="c"># Cast into numpy arrays</span>
        <span class="n">aids</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">[</span><span class="n">nid</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Remove empties</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] name with 0 aids. need to clean database&#39;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">nid2_aids</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="n">nid2_aids</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">aids</span>
        <span class="c"># Shuffle known annotations in each name</span>
        <span class="c">#np.random.shuffle(aids)</span>
    <span class="c"># Get not beloning to input names</span>
    <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sample</span><span class="p">(</span><span class="n">nid_</span><span class="p">):</span>
        <span class="n">aids_iter</span> <span class="o">=</span> <span class="p">(</span><span class="n">aids</span> <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">)</span> <span class="k">if</span> <span class="n">nid</span> <span class="o">!=</span> <span class="n">nid_</span><span class="p">)</span>
        <span class="n">sample_gf_aids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">per_name</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">aids_iter</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">sample_gf_aids</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">gf_aids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_sample</span><span class="p">(</span><span class="n">nid_</span><span class="p">)</span> <span class="k">for</span> <span class="n">nid_</span> <span class="ow">in</span> <span class="n">nid_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">gf_aids_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_annot_groundtruth_sample"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_annot_groundtruth_sample">[docs]</a><span class="k">def</span> <span class="nf">get_annot_groundtruth_sample</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">per_name</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.all_imports import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.test_main(db=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; per_name = 1</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_trues_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_groundtruth</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">noself</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">is_exemplar</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">random_choice</span><span class="p">(</span><span class="n">aids</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="n">per_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">sample_trues_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">random_choice</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">all_trues_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sample_trues_list</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_aids_with_groundtruth"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_aids_with_groundtruth">[docs]</a><span class="k">def</span> <span class="nf">get_aids_with_groundtruth</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns aids with valid groundtruth &quot;&quot;&quot;</span>
    <span class="n">valid_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">has_gt_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_has_groundtruth</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">)</span>
    <span class="n">hasgt_aids</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">valid_aids</span><span class="p">,</span> <span class="n">has_gt_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hasgt_aids</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="export_encounters"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.export_encounters">[docs]</a><span class="k">def</span> <span class="nf">export_encounters</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">eid_list</span><span class="p">,</span> <span class="n">new_dbdir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_gids</span><span class="p">(</span><span class="n">eid_list</span><span class="p">))))</span>
    <span class="k">if</span> <span class="n">new_dbdir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">ibeis.dev</span> <span class="kn">import</span> <span class="n">sysres</span>
        <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span>
        <span class="n">enc_texts</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_encounter_enctext</span><span class="p">(</span><span class="n">eid_list</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">nimg_text</span> <span class="o">=</span> <span class="s">&#39;nImg=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">new_dbname</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">enc_texts</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">nimg_text</span>
        <span class="n">workdir</span> <span class="o">=</span> <span class="n">sysres</span><span class="o">.</span><span class="n">get_workdir</span><span class="p">()</span>
        <span class="n">new_dbdir_</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">new_dbname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_dbdir_</span> <span class="o">=</span> <span class="n">new_dbdir</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">export_images</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">new_dbdir_</span><span class="o">=</span><span class="n">new_dbdir_</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="export_images"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.export_images">[docs]</a><span class="k">def</span> <span class="nf">export_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">new_dbdir_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; See ibeis/tests/test_ibs_export.py &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.dbio</span> <span class="kn">import</span> <span class="n">export_subset</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] exporting to new_dbdir_=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">new_dbdir_</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] opening database&#39;</span><span class="p">)</span>
    <span class="n">ibs_dst</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="n">dbdir</span><span class="o">=</span><span class="n">new_dbdir_</span><span class="p">,</span> <span class="n">allow_newdir</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] begining transfer&#39;</span><span class="p">)</span>
    <span class="n">ibs_src</span> <span class="o">=</span> <span class="n">ibs</span>
    <span class="n">gid_list1</span> <span class="o">=</span> <span class="n">gid_list</span>
    <span class="n">aid_list1</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">include_image_annots</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">export_subset</span><span class="o">.</span><span class="n">execute_transfer</span><span class="p">(</span><span class="n">ibs_src</span><span class="p">,</span> <span class="n">ibs_dst</span><span class="p">,</span> <span class="n">gid_list1</span><span class="p">,</span>
                                            <span class="n">aid_list1</span><span class="p">,</span> <span class="n">include_image_annots</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="set_dbnotes"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.set_dbnotes">[docs]</a><span class="k">def</span> <span class="nf">set_dbnotes</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">notes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; sets notes for an entire database &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">IBEISControl</span><span class="o">.</span><span class="n">IBEISController</span><span class="p">)</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbnotes_fpath</span><span class="p">(),</span> <span class="n">notes</span><span class="p">)</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_dbnotes_fpath"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_dbnotes_fpath">[docs]</a><span class="k">def</span> <span class="nf">get_dbnotes_fpath</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">notes_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_ibsdir</span><span class="p">(),</span> <span class="s">&#39;dbnotes.txt&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ensure</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbnotes_fpath</span><span class="p">()):</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_dbnotes</span><span class="p">(</span><span class="s">&#39;None&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">notes_fpath</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="get_dbnotes"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.get_dbnotes">[docs]</a><span class="k">def</span> <span class="nf">get_dbnotes</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; sets notes for an entire database &quot;&quot;&quot;</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">read_from</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbnotes_fpath</span><span class="p">(),</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">notes</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_dbnotes</span><span class="p">(</span><span class="s">&#39;None&#39;</span><span class="p">)</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">read_from</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbnotes_fpath</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">notes</span>

</div>
<span class="nd">@__injectable</span>
<div class="viewcode-block" id="annotstr"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.annotstr">[docs]</a><span class="k">def</span> <span class="nf">annotstr</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;aid=</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">aid</span>

</div>
<div class="viewcode-block" id="redownload_detection_models"><a class="viewcode-back" href="../../ibeis.html#ibeis.ibsfuncs.redownload_detection_models">[docs]</a><span class="k">def</span> <span class="nf">redownload_detection_models</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">ibeis.model.detect</span> <span class="kn">import</span> <span class="n">grabmodels</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] redownload_detection_models&#39;</span><span class="p">)</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">get_app_resource_dir</span><span class="p">(</span><span class="s">&#39;ibeis&#39;</span><span class="p">,</span> <span class="s">&#39;detectmodels&#39;</span><span class="p">))</span>
    <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_models</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ibsfuncs] finished redownload_detection_models&#39;</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">ibeis 0.1.0.dev1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../ibeis.html" >ibeis</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Jon Crall.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>