

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ibeis.algo.hots.demobayes &mdash; ibeis 1.5.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ibeis 1.5.1 documentation" href="../../../../index.html"/>
        <link rel="up" title="ibeis.algo.hots" href="../hots.html"/> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> ibeis
          

          
          </a>

          
            
            
              <div class="version">
                1.5.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../ibeis.html">ibeis package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../index.html">ibeis</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      
          <li><a href="../../../ibeis.html">ibeis</a> &raquo;</li>
      
          <li><a href="../../algo.html">ibeis.algo</a> &raquo;</li>
      
          <li><a href="../hots.html">ibeis.algo.hots</a> &raquo;</li>
      
    <li>ibeis.algo.hots.demobayes</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ibeis.algo.hots.demobayes</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">six</span>  <span class="c"># NOQA</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">ibeis.algo.hots.bayes</span> <span class="kn">import</span> <span class="n">make_name_model</span><span class="p">,</span> <span class="n">test_model</span><span class="p">,</span> <span class="n">draw_tree_model</span>
<span class="k">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;[demobayes]&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="testdata_demo_cfgs"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.testdata_demo_cfgs">[docs]</a><span class="k">def</span> <span class="nf">testdata_demo_cfgs</span><span class="p">():</span>
    <span class="n">alias_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;nA&#39;</span><span class="p">:</span> <span class="s">&#39;num_annots&#39;</span><span class="p">,</span> <span class="s">&#39;nN&#39;</span><span class="p">:</span> <span class="s">&#39;num_names&#39;</span><span class="p">,</span> <span class="s">&#39;nS&#39;</span><span class="p">:</span> <span class="s">&#39;num_scores&#39;</span><span class="p">}</span>
    <span class="n">cfg_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">parse_argv_cfg</span><span class="p">(</span><span class="s">&#39;--ev&#39;</span><span class="p">,</span> <span class="n">alias_keys</span><span class="o">=</span><span class="n">alias_keys</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cfg_list</span>

</div>
<div class="viewcode-block" id="demo_bayesnet"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.demo_bayesnet">[docs]</a><span class="k">def</span> <span class="nf">demo_bayesnet</span><span class="p">(</span><span class="n">cfg</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Make a model that knows who the previous annots are and tries to classify a new annot</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis --tf demo_bayesnet --diskshow --verbose --save demo4.png --dpath . --figsize=20,10 --dpi=128 --clipwhite</span>

<span class="sd">        python -m ibeis --tf demo_bayesnet --ev :nA=3,Sab=0,Sac=0,Sbc=1</span>
<span class="sd">        python -m ibeis --tf demo_bayesnet --ev :nA=4,Sab=0,Sac=0,Sbc=1,Sbd=1 --show</span>
<span class="sd">        python -m ibeis --tf demo_bayesnet --ev :nA=4,Sab=0,Sac=0,Sbc=1,Scd=1 --show</span>
<span class="sd">        python -m ibeis --tf demo_bayesnet --ev :nA=4,Sab=0,Sac=0,Sbc=1,Sbd=1,Scd=1 --show</span>

<span class="sd">        python -m ibeis --tf demo_bayesnet --ev :nA=3,Sab=0,Sac=0,Sbc=1</span>
<span class="sd">        python -m ibeis --tf demo_bayesnet --ev :nA=5,rand_scores=True --show</span>

<span class="sd">        python -m ibeis --tf demo_bayesnet --ev :nA=4,nS=3,rand_scores=True --show --verbose</span>
<span class="sd">        python -m ibeis --tf demo_bayesnet --ev :nA=5,nS=2,Na=fred,rand_scores=True --show --verbose</span>
<span class="sd">        python -m ibeis --tf demo_bayesnet --ev :nA=5,nS=5,Na=fred,rand_scores=True --show --verbose</span>
<span class="sd">        python -m ibeis --tf demo_bayesnet --ev :nA=4,nS=2,Na=fred,rand_scores=True --show --verbose</span>

<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-demo_bayesnet \</span>
<span class="sd">                --ev =:nA=4,Sab=0,Sac=0,Sbc=1 \</span>
<span class="sd">                :Sbd=1 :Scd=1 :Sbd=1,Scd=1 :Sbd=1,Scd=1,Sad=0 \</span>
<span class="sd">                --show --present</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; cfg_list = testdata_demo_cfgs()</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;cfg_list = %r&#39; % (cfg_list,))</span>
<span class="sd">        &gt;&gt;&gt; for cfg in cfg_list:</span>
<span class="sd">        &gt;&gt;&gt;     demo_bayesnet(cfg)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">num_annots</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;num_annots&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">num_names</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;num_names&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">num_scores</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;num_scores&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">rand_scores</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;rand_scores&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;method&#39;</span><span class="p">,</span> <span class="s">&#39;bp&#39;</span><span class="p">)</span>
    <span class="n">other_evidence</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">rand_scores</span><span class="p">:</span>
        <span class="c">#import randomdotorg</span>
        <span class="c">#import sys</span>
        <span class="c">#r = randomdotorg.RandomDotOrg(&#39;ExampleCode&#39;)</span>
        <span class="c">#seed = int((1 - 2 * r.random()) * sys.maxint)</span>
        <span class="n">toy_data</span> <span class="o">=</span> <span class="n">get_toy_data_1v1</span><span class="p">(</span><span class="n">num_annots</span><span class="p">,</span> <span class="n">nid_sequence</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;toy_data = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">toy_data</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">diag_scores</span><span class="p">,</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span>
            <span class="n">toy_data</span><span class="p">,</span> <span class="s">&#39;diag_scores&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">))</span>
        <span class="n">discr_domain</span><span class="p">,</span> <span class="n">discr_p_same</span> <span class="o">=</span> <span class="n">learn_prob_score</span><span class="p">(</span><span class="n">num_scores</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">discretize_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
            <span class="c"># Assign continuous scores to discrete index</span>
            <span class="n">score_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">discr_domain</span> <span class="o">/</span> <span class="n">scores</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">]))</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">score_idxs</span>
        <span class="n">score_evidence</span> <span class="o">=</span> <span class="n">discretize_scores</span><span class="p">(</span><span class="n">diag_scores</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score_evidence</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">discr_p_same</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">discr_domain</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">evidence</span><span class="p">,</span> <span class="n">query_results</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span>
        <span class="n">num_annots</span><span class="o">=</span><span class="n">num_annots</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="n">num_names</span><span class="p">,</span>
        <span class="n">num_scores</span><span class="o">=</span><span class="n">num_scores</span><span class="p">,</span>
        <span class="n">score_evidence</span><span class="o">=</span><span class="n">score_evidence</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">other_evidence</span><span class="o">=</span><span class="n">other_evidence</span><span class="p">,</span>
        <span class="n">p_score_given_same</span><span class="o">=</span><span class="n">discr_p_same</span><span class="p">,</span>
        <span class="n">score_basis</span><span class="o">=</span><span class="n">discr_domain</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
    <span class="p">)</span>

</div>
<div class="viewcode-block" id="classify_k"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.classify_k">[docs]</a><span class="k">def</span> <span class="nf">classify_k</span><span class="p">(</span><span class="n">cfg</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-classify_k --show --ev :nA=3</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-classify_k --show --ev :nA=3,k=1</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-classify_k --show --ev :nA=3,k=0 --method=approx</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-classify_k --show --ev :nA=10,k=1 --method=approx</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; cfg_list = testdata_demo_cfgs()</span>
<span class="sd">        &gt;&gt;&gt; classify_k(cfg_list[0])</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">num_annots</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;num_annots&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">num_scores</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;num_scores&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">num_iter</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">nid_sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">toy_data</span> <span class="o">=</span> <span class="n">get_toy_data_1v1</span><span class="p">(</span><span class="n">num_annots</span><span class="p">,</span> <span class="n">nid_sequence</span><span class="o">=</span><span class="n">nid_sequence</span><span class="p">)</span>
    <span class="n">force_evidence</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">force_evidence</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">diag_scores</span><span class="p">,</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span>
        <span class="n">toy_data</span><span class="p">,</span> <span class="s">&#39;diag_scores&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">))</span>

    <span class="c">#print(&#39;diag_scores = %r&#39; % (diag_scores,))</span>
    <span class="c">#diag_labels = pairwise_matches.compress(is_diag)</span>
    <span class="c">#diag_pairs = ut.compress(pairwise_aidxs, is_diag)</span>

    <span class="n">discr_domain</span><span class="p">,</span> <span class="n">discr_p_same</span> <span class="o">=</span> <span class="n">learn_prob_score</span><span class="p">(</span><span class="n">num_scores</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">discretize_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
        <span class="c"># Assign continuous scores to closest discrete index</span>
        <span class="n">score_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">discr_domain</span> <span class="o">/</span> <span class="n">scores</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">]))</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">score_idxs</span>

    <span class="c"># Careful ordering is important here</span>
    <span class="n">score_evidence</span> <span class="o">=</span> <span class="n">discretize_scores</span><span class="p">(</span><span class="n">diag_scores</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">force_evidence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">score_evidence</span><span class="p">)):</span>
            <span class="n">score_evidence</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">model</span><span class="p">,</span> <span class="n">evidence</span><span class="p">,</span> <span class="n">query_results</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span>
        <span class="n">num_annots</span><span class="o">=</span><span class="n">num_annots</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="n">num_annots</span><span class="p">,</span>
        <span class="n">num_scores</span><span class="o">=</span><span class="n">num_scores</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">score_evidence</span><span class="o">=</span><span class="n">score_evidence</span><span class="p">,</span>
        <span class="n">p_score_given_same</span><span class="o">=</span><span class="n">discr_p_same</span><span class="p">,</span>
        <span class="n">score_basis</span><span class="o">=</span><span class="n">discr_domain</span><span class="p">,</span>
        <span class="c">#verbose=True</span>
    <span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">query_results</span><span class="p">[</span><span class="s">&#39;top_assignments&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">toy_data1</span> <span class="o">=</span> <span class="n">toy_data</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;toy_data1 = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">toy_data1</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">num_annots2</span> <span class="o">=</span> <span class="n">num_annots</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">score_evidence1</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">score_evidence</span><span class="p">)</span>
    <span class="n">full_evidence</span> <span class="o">=</span> <span class="n">score_evidence</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">factor_list</span> <span class="o">=</span> <span class="n">query_results</span><span class="p">[</span><span class="s">&#39;factor_list&#39;</span><span class="p">]</span>
    <span class="n">using_soft</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">using_soft</span><span class="p">:</span>
        <span class="n">soft_evidence1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">statenames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">factor_list</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iter</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s"> ---------- </span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="c">#toy_data1[&#39;all_nids&#39;].max() + 1</span>
        <span class="n">num_names_gen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">toy_data1</span><span class="p">[</span><span class="s">&#39;all_aids&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">num_names_gen</span> <span class="o">=</span> <span class="n">toy_data1</span><span class="p">[</span><span class="s">&#39;all_nids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">toy_data2</span> <span class="o">=</span> <span class="n">get_toy_data_1v1</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span> <span class="n">num_names_gen</span><span class="p">,</span>
            <span class="n">initial_aids</span><span class="o">=</span><span class="n">toy_data1</span><span class="p">[</span><span class="s">&#39;all_aids&#39;</span><span class="p">],</span>
            <span class="n">initial_nids</span><span class="o">=</span><span class="n">toy_data1</span><span class="p">[</span><span class="s">&#39;all_nids&#39;</span><span class="p">],</span>
            <span class="n">nid_sequence</span><span class="o">=</span><span class="n">nid_sequence</span><span class="p">)</span>
        <span class="n">diag_scores2</span><span class="p">,</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span>
            <span class="n">toy_data2</span><span class="p">,</span> <span class="s">&#39;diag_scores&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;toy_data2 = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">toy_data2</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">score_evidence2</span> <span class="o">=</span> <span class="n">discretize_scores</span><span class="p">(</span><span class="n">diag_scores2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">force_evidence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">score_evidence2</span><span class="p">)):</span>
                <span class="n">score_evidence2</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">force_evidence</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;score_evidence2 = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">score_evidence2</span><span class="p">,))</span>

        <span class="k">if</span> <span class="n">using_soft</span><span class="p">:</span>
            <span class="c"># Demo with soft evidence</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">evidence</span><span class="p">,</span> <span class="n">query_results2</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span>
                <span class="n">num_annots</span><span class="o">=</span><span class="n">num_annots2</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="n">num_annots2</span><span class="p">,</span>
                <span class="n">num_scores</span><span class="o">=</span><span class="n">num_scores</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">name_evidence</span><span class="o">=</span><span class="n">soft_evidence1</span><span class="p">,</span>
                <span class="c">#score_evidence=score_evidence1 + score_evidence2,</span>
                <span class="n">score_evidence</span><span class="o">=</span><span class="n">score_evidence2</span><span class="p">,</span>
                <span class="n">p_score_given_same</span><span class="o">=</span><span class="n">discr_p_same</span><span class="p">,</span>
                <span class="n">score_basis</span><span class="o">=</span><span class="n">discr_domain</span><span class="p">,</span>
                <span class="c">#verbose=True,</span>
                <span class="n">hack_score_only</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">score_evidence2</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># Demo with full evidence</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">evidence</span><span class="p">,</span> <span class="n">query_results2</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span>
                <span class="n">num_annots</span><span class="o">=</span><span class="n">num_annots2</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="n">num_annots2</span><span class="p">,</span>
                <span class="n">num_scores</span><span class="o">=</span><span class="n">num_scores</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">score_evidence</span><span class="o">=</span><span class="n">full_evidence</span> <span class="o">+</span> <span class="n">score_evidence2</span><span class="p">,</span>
                <span class="n">p_score_given_same</span><span class="o">=</span><span class="n">discr_p_same</span><span class="p">,</span>
                <span class="n">score_basis</span><span class="o">=</span><span class="n">discr_domain</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span>
            <span class="p">)</span>
        <span class="n">factor_list2</span> <span class="o">=</span> <span class="n">query_results2</span><span class="p">[</span><span class="s">&#39;factor_list&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">using_soft</span><span class="p">:</span>
            <span class="n">soft_evidence1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">statenames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">factor_list2</span><span class="p">]</span>
        <span class="n">score_evidence1</span> <span class="o">+=</span> <span class="p">([</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">score_evidence2</span><span class="p">))</span>
        <span class="n">full_evidence</span> <span class="o">=</span> <span class="n">full_evidence</span> <span class="o">+</span> <span class="n">score_evidence2</span>
        <span class="n">num_annots2</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">toy_data1</span> <span class="o">=</span> <span class="n">toy_data2</span>

</div>
<div class="viewcode-block" id="show_toy_distributions"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.show_toy_distributions">[docs]</a><span class="k">def</span> <span class="nf">show_toy_distributions</span><span class="p">(</span><span class="n">toy_params</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
    <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">ensure_pylab_qt4</span><span class="p">()</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">tp_pdf</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">gauss_func1d</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">**</span><span class="n">toy_params</span><span class="p">[</span><span class="bp">True</span><span class="p">])</span>
    <span class="n">fp_pdf</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">gauss_func1d</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">**</span><span class="n">toy_params</span><span class="p">[</span><span class="bp">False</span><span class="p">])</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">plot_probabilities</span><span class="p">(</span>
        <span class="p">[</span><span class="n">tp_pdf</span><span class="p">,</span> <span class="n">fp_pdf</span><span class="p">],</span> <span class="p">[</span><span class="s">&#39;TP&#39;</span><span class="p">,</span> <span class="s">&#39;TF&#39;</span><span class="p">],</span>
        <span class="n">prob_colors</span><span class="o">=</span><span class="p">[</span><span class="n">pt</span><span class="o">.</span><span class="n">TRUE_BLUE</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">FALSE_RED</span><span class="p">],</span>
        <span class="n">xdata</span><span class="o">=</span><span class="n">xdata</span><span class="p">,</span>
        <span class="n">figtitle</span><span class="o">=</span><span class="s">&#39;Toy Distributions&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="get_toy_data_1vM"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.get_toy_data_1vM">[docs]</a><span class="k">def</span> <span class="nf">get_toy_data_1vM</span><span class="p">(</span><span class="n">num_annots</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        num_annots (int):</span>
<span class="sd">        num_names (int): (default = None)</span>

<span class="sd">    Kwargs:</span>
<span class="sd">        initial_aids, initial_nids, nid_sequence, seed</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (pair_list, feat_list)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-get_toy_data_1vM --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; num_annots = 1000</span>
<span class="sd">        &gt;&gt;&gt; num_names = 40</span>
<span class="sd">        &gt;&gt;&gt; get_toy_data_1vM(num_annots, num_names)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
    <span class="n">tup_</span> <span class="o">=</span> <span class="n">get_toy_annots</span><span class="p">(</span><span class="n">num_annots</span><span class="p">,</span> <span class="n">num_names</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">aids</span><span class="p">,</span> <span class="n">nids</span><span class="p">,</span> <span class="n">aids1</span><span class="p">,</span> <span class="n">nids1</span><span class="p">,</span> <span class="n">all_aids</span><span class="p">,</span> <span class="n">all_nids</span> <span class="o">=</span> <span class="n">tup_</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ensure_rng</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

    <span class="c"># Test a simple SVM classifier</span>
    <span class="n">nid2_nexemp</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">nids1</span><span class="p">)</span>
    <span class="n">aid2_nid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">nids</span><span class="p">))</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">fix_embed_globals</span><span class="p">()</span>

    <span class="c">#def add_to_globals(globals_, subdict):</span>
    <span class="c">#    globals_.update(subdict)</span>

    <span class="n">unique_nids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nid2_nexemp</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">annot_to_class_feats2</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">aid2_nid</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">pair_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">score_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nexemplar_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">unique_nids</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">(</span><span class="n">aid2_nid</span><span class="p">[</span><span class="n">aid</span><span class="p">]</span> <span class="o">==</span> <span class="n">nid</span><span class="p">)</span>
            <span class="n">num_exemplars</span> <span class="o">=</span> <span class="n">nid2_nexemp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_exemplars</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">toy_params</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;mu&#39;</span><span class="p">,</span> <span class="s">&#39;sigma&#39;</span><span class="p">])</span>
            <span class="n">score_</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_exemplars</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">score_</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="n">pair_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">aid</span><span class="p">,</span> <span class="n">nid</span><span class="p">))</span>
            <span class="n">score_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
            <span class="n">nexemplar_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num_exemplars</span><span class="p">)</span>
        <span class="n">rank_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">score_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">feat_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">score_list</span><span class="p">,</span> <span class="n">rank_list</span><span class="p">,</span> <span class="n">nexemplar_list</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">rank_list</span><span class="p">)</span>
        <span class="n">feat_list</span> <span class="o">=</span> <span class="n">feat_list</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pair_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pair_list</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">top</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">feat_list</span> <span class="o">=</span> <span class="n">feat_list</span><span class="p">[:</span><span class="n">top</span><span class="p">]</span>
            <span class="n">pair_list</span> <span class="o">=</span> <span class="n">pair_list</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">top</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pair_list</span><span class="p">,</span> <span class="n">feat_list</span>

    <span class="n">toclass_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">annot_to_class_feats2</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">aid2_nid</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">aids</span><span class="p">]</span>
    <span class="n">aidnid_pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">toclass_features</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">feat_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">toclass_features</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">score_list</span> <span class="o">=</span> <span class="n">feat_list</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">lbl_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">aid2_nid</span><span class="p">[</span><span class="n">aid</span><span class="p">]</span> <span class="o">==</span> <span class="n">nid</span> <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">aidnid_pairs</span><span class="p">]</span>

    <span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">svm</span>
    <span class="c">#clf1 = svm.LinearSVC()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Learning classifiers&#39;</span><span class="p">)</span>

    <span class="n">clf3</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">clf3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">feat_list</span><span class="p">,</span> <span class="n">lbl_list</span><span class="p">)</span>
    <span class="c">#prob_true, prob_false = clf3.predict_proba(feat_list).T</span>

    <span class="n">clf1</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">LinearSVC</span><span class="p">()</span>
    <span class="n">clf1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">score_list</span><span class="p">,</span> <span class="n">lbl_list</span><span class="p">)</span>

    <span class="c"># Score new annots against the training database</span>
    <span class="n">tup_</span> <span class="o">=</span> <span class="n">get_toy_annots</span><span class="p">(</span><span class="n">num_annots</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">num_names</span><span class="p">,</span> <span class="n">initial_aids</span><span class="o">=</span><span class="n">all_aids</span><span class="p">,</span> <span class="n">initial_nids</span><span class="o">=</span><span class="n">all_nids</span><span class="p">)</span>
    <span class="n">aids</span><span class="p">,</span> <span class="n">nids</span><span class="p">,</span> <span class="n">aids1</span><span class="p">,</span> <span class="n">nids1</span><span class="p">,</span> <span class="n">all_aids</span><span class="p">,</span> <span class="n">all_nids</span> <span class="o">=</span> <span class="n">tup_</span>
    <span class="n">aid2_nid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">nids</span><span class="p">))</span>
    <span class="n">toclass_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">annot_to_class_feats2</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">aid2_nid</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">aids</span><span class="p">]</span>
    <span class="n">aidnid_pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">toclass_features</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">feat_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">toclass_features</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">lbl_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">aid2_nid</span><span class="p">[</span><span class="n">aid</span><span class="p">]</span> <span class="o">==</span> <span class="n">nid</span> <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">aidnid_pairs</span><span class="p">])</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Running tests&#39;</span><span class="p">)</span>

    <span class="n">score_list</span> <span class="o">=</span> <span class="n">feat_list</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

    <span class="n">tp_feat_list</span> <span class="o">=</span> <span class="n">feat_list</span><span class="p">[</span><span class="n">lbl_list</span><span class="p">]</span>
    <span class="n">tn_feat_list</span> <span class="o">=</span> <span class="n">feat_list</span><span class="p">[</span><span class="o">~</span><span class="n">lbl_list</span><span class="p">]</span>
    <span class="n">tp_lbls</span> <span class="o">=</span> <span class="n">lbl_list</span><span class="p">[</span><span class="n">lbl_list</span><span class="p">]</span>
    <span class="n">tn_lbls</span> <span class="o">=</span> <span class="n">lbl_list</span><span class="p">[</span><span class="o">~</span><span class="n">lbl_list</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;num tp: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">tp_lbls</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;num fp: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">tn_lbls</span><span class="p">))</span>

    <span class="n">tp_score_list</span> <span class="o">=</span> <span class="n">score_list</span><span class="p">[</span><span class="n">lbl_list</span><span class="p">]</span>
    <span class="n">tn_score_list</span> <span class="o">=</span> <span class="n">score_list</span><span class="p">[</span><span class="o">~</span><span class="n">lbl_list</span><span class="p">]</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;tp_feat&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">tp_feat_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;tp_feat&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">tn_feat_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;tp_score&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">tp_score_list</span><span class="p">),</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;tp_score&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">tn_score_list</span><span class="p">),</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">tp_pred3</span> <span class="o">=</span> <span class="n">clf3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tp_feat_list</span><span class="p">)</span>
    <span class="n">tn_pred3</span> <span class="o">=</span> <span class="n">clf3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tn_feat_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">((</span><span class="n">tp_pred3</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">tp_pred3</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">print</span><span class="p">((</span><span class="n">tn_pred3</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">tn_pred3</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="n">tp_score3</span> <span class="o">=</span> <span class="n">clf3</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">tp_feat_list</span><span class="p">,</span> <span class="n">tp_lbls</span><span class="p">)</span>
    <span class="n">tn_score3</span> <span class="o">=</span> <span class="n">clf3</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">tn_feat_list</span><span class="p">,</span> <span class="n">tn_lbls</span><span class="p">)</span>

    <span class="n">tp_pred1</span> <span class="o">=</span> <span class="n">clf1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tp_score_list</span><span class="p">)</span>
    <span class="n">tn_pred1</span> <span class="o">=</span> <span class="n">clf1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tn_score_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">((</span><span class="n">tp_pred1</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">tp_pred1</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">print</span><span class="p">((</span><span class="n">tn_pred1</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">tn_pred1</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="n">tp_score1</span> <span class="o">=</span> <span class="n">clf1</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">tp_score_list</span><span class="p">,</span> <span class="n">tp_lbls</span><span class="p">)</span>
    <span class="n">tn_score1</span> <span class="o">=</span> <span class="n">clf1</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">tn_score_list</span><span class="p">,</span> <span class="n">tn_lbls</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;tp score with rank    = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tp_score3</span><span class="p">,))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;tn score with rank    = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tn_score3</span><span class="p">,))</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;tp score without rank = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tp_score1</span><span class="p">,))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;tn score without rank = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tn_score1</span><span class="p">,))</span>
    <span class="n">toy_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">return</span> <span class="n">toy_data</span>

</div>
<div class="viewcode-block" id="get_toy_annots"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.get_toy_annots">[docs]</a><span class="k">def</span> <span class="nf">get_toy_annots</span><span class="p">(</span><span class="n">num_annots</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">initial_aids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">initial_nids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nid_sequence</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        num_annots (int):</span>
<span class="sd">        num_names (int): (default = None)</span>
<span class="sd">        initial_aids (None): (default = None)</span>
<span class="sd">        initial_nids (None): (default = None)</span>
<span class="sd">        nid_sequence (None): (default = None)</span>
<span class="sd">        seed (None): (default = None)</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (aids, nids, aids1, nids1, all_aids, all_nids)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-get_toy_annots</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; num_annots = 1</span>
<span class="sd">        &gt;&gt;&gt; num_names = 5</span>
<span class="sd">        &gt;&gt;&gt; initial_aids = np.array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9], dtype=np.int64)</span>
<span class="sd">        &gt;&gt;&gt; initial_nids = np.array([0, 0, 1, 2, 2, 1, 1, 1, 2, 3], dtype=np.int64)</span>
<span class="sd">        &gt;&gt;&gt; nid_sequence = np.array([0, 0, 1, 2, 2, 1, 1], dtype=np.int64)</span>
<span class="sd">        &gt;&gt;&gt; seed = 0</span>
<span class="sd">        &gt;&gt;&gt; (aids, nids, aids1, nids1, all_aids, all_nids) = get_toy_annots(num_annots, num_names, initial_aids, initial_nids, nid_sequence, seed)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;(aids, nids, aids1, nids1, all_aids, all_nids) = %s&#39; % (ut.repr2((aids, nids, aids1, nids1, all_aids, all_nids), nl=1),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
    <span class="k">if</span> <span class="n">num_names</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">num_names</span> <span class="o">=</span> <span class="n">num_annots</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Generating toy data with num_annots=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_annots</span><span class="p">,))</span>
    <span class="k">if</span> <span class="n">initial_aids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">initial_nids</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="n">first_step</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">initial_aids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">initial_nids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">first_step</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">assert</span> <span class="n">initial_nids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

    <span class="n">aids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">initial_aids</span><span class="p">),</span> <span class="n">num_annots</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_aids</span><span class="p">))</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ensure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nid_sequence</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">nids</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_names</span><span class="p">,</span> <span class="n">num_annots</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">unused_from_sequence</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nid_sequence</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_aids</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unused_from_sequence</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nids</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_names</span><span class="p">,</span> <span class="n">num_annots</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">unused_from_sequence</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">unused_from_sequence</span> <span class="o">&lt;</span> <span class="n">num_annots</span><span class="p">:</span>
            <span class="n">num_remain</span> <span class="o">=</span> <span class="n">num_annots</span> <span class="o">-</span> <span class="n">unused_from_sequence</span>
            <span class="n">nids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nid_sequence</span><span class="p">[</span><span class="o">-</span><span class="n">unused_from_sequence</span><span class="p">:],</span> <span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_names</span><span class="p">,</span> <span class="n">num_remain</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nids</span> <span class="o">=</span> <span class="n">nid_sequence</span><span class="p">[</span><span class="o">-</span><span class="n">unused_from_sequence</span><span class="p">]</span>
            <span class="n">nids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">nid_sequence</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">initial_aids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_aids</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_annots</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">first_step</span><span class="p">:</span>
        <span class="n">aids1</span> <span class="o">=</span> <span class="n">aids</span>
        <span class="n">nids1</span> <span class="o">=</span> <span class="n">nids</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aids1</span> <span class="o">=</span> <span class="n">initial_aids</span>
        <span class="n">nids1</span> <span class="o">=</span> <span class="n">initial_nids</span>

    <span class="n">all_nids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">initial_nids</span><span class="p">,</span> <span class="n">nids</span><span class="p">)</span>
    <span class="n">all_aids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">initial_aids</span><span class="p">,</span> <span class="n">aids</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">utool</span>
    <span class="k">with</span> <span class="n">utool</span><span class="o">.</span><span class="n">embed_on_exception_context</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">assert_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">nids</span><span class="p">),</span> <span class="s">&#39;len new&#39;</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">assert_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aids1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">nids1</span><span class="p">),</span> <span class="s">&#39;len comp&#39;</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">assert_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_aids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_nids</span><span class="p">),</span> <span class="s">&#39;len all&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aids</span><span class="p">,</span> <span class="n">nids</span><span class="p">,</span> <span class="n">aids1</span><span class="p">,</span> <span class="n">nids1</span><span class="p">,</span> <span class="n">all_aids</span><span class="p">,</span> <span class="n">all_nids</span>

</div>
<span class="n">toy_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="bp">True</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;mu&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s">&#39;sigma&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">},</span>
    <span class="bp">False</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;mu&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s">&#39;sigma&#39;</span><span class="p">:</span> <span class="o">.</span><span class="mi">4</span><span class="p">}</span>
    <span class="c">#True: {&#39;mu&#39;: 3.5, &#39;sigma&#39;: 1.1},</span>
    <span class="c">#False: {&#39;mu&#39;: .3, &#39;sigma&#39;: .7}</span>
    <span class="c">#&#39;p&#39;: .7},</span>
    <span class="c">#&#39;p&#39;: .2}</span>
<span class="p">}</span>


<span class="c">#@ut.cached_func(&#39;_toy_bayes_data3&#39;)</span>
<div class="viewcode-block" id="get_toy_data_1v1"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.get_toy_data_1v1">[docs]</a><span class="k">def</span> <span class="nf">get_toy_data_1v1</span><span class="p">(</span><span class="n">num_annots</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-get_toy_data_1v1 --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; toy_data = get_toy_data_1v1()</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; show_toy_distributions(toy_data[&#39;toy_params&#39;])</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>

<span class="sd">    Example1:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; toy_data = get_toy_data_1v1()</span>
<span class="sd">        &gt;&gt;&gt; kwargs = {}</span>
<span class="sd">        &gt;&gt;&gt; initial_aids = toy_data[&#39;aids&#39;]</span>
<span class="sd">        &gt;&gt;&gt; initial_nids = toy_data[&#39;nids&#39;]</span>
<span class="sd">        &gt;&gt;&gt; num_annots = 1</span>
<span class="sd">        &gt;&gt;&gt; num_names = 6</span>
<span class="sd">        &gt;&gt;&gt; toy_data2 = get_toy_data_1v1(num_annots, num_names, initial_aids=initial_aids, initial_nids=initial_nids)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; show_toy_distributions(toy_data[&#39;toy_params&#39;])</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>

<span class="sd">    Ignore:</span>
<span class="sd">        &gt;&gt;&gt; num_annots = 1000</span>
<span class="sd">        &gt;&gt;&gt; num_names = 400</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
    <span class="n">tup_</span> <span class="o">=</span> <span class="n">get_toy_annots</span><span class="p">(</span><span class="n">num_annots</span><span class="p">,</span> <span class="n">num_names</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">aids</span><span class="p">,</span> <span class="n">nids</span><span class="p">,</span> <span class="n">aids1</span><span class="p">,</span> <span class="n">nids1</span><span class="p">,</span> <span class="n">all_aids</span><span class="p">,</span> <span class="n">all_nids</span> <span class="o">=</span> <span class="n">tup_</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ensure_rng</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pairwise_feature</span><span class="p">(</span><span class="n">aidx1</span><span class="p">,</span> <span class="n">aidx2</span><span class="p">,</span> <span class="n">all_nids</span><span class="o">=</span><span class="n">all_nids</span><span class="p">,</span> <span class="n">toy_params</span><span class="o">=</span><span class="n">toy_params</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">aidx1</span> <span class="o">==</span> <span class="n">aidx2</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#rng = np.random.RandomState(int((aidx1 + 13) * (aidx2 + 13)))</span>
            <span class="n">nid1</span> <span class="o">=</span> <span class="n">all_nids</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">aidx1</span><span class="p">)]</span>
            <span class="n">nid2</span> <span class="o">=</span> <span class="n">all_nids</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">aidx2</span><span class="p">)]</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">toy_params</span><span class="p">[</span><span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span><span class="p">]</span>
            <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;mu&#39;</span><span class="p">,</span> <span class="s">&#39;sigma&#39;</span><span class="p">])</span>
            <span class="n">score_</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">score_</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">score</span>

    <span class="n">pairwise_nids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">tup</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">iprod</span><span class="p">(</span><span class="n">nids</span><span class="p">,</span> <span class="n">nids1</span><span class="p">)])</span>
    <span class="n">pairwise_matches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span> <span class="k">for</span> <span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span> <span class="ow">in</span> <span class="n">pairwise_nids</span><span class="p">])</span>

    <span class="n">pairwise_aidxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">tup</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">iprod</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">aids1</span><span class="p">)])</span>

    <span class="n">pairwise_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">pairwise_feature</span><span class="p">(</span><span class="n">aidx1</span><span class="p">,</span> <span class="n">aidx2</span><span class="p">)</span> <span class="k">for</span> <span class="n">aidx1</span><span class="p">,</span> <span class="n">aidx2</span> <span class="ow">in</span> <span class="n">pairwise_aidxs</span><span class="p">])</span>

    <span class="c">#pairwise_scores_mat = pairwise_scores.reshape(num_annots, num_annots)</span>
    <span class="n">is_diag</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">c</span> <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="ow">in</span> <span class="n">pairwise_aidxs</span><span class="p">]</span>
    <span class="n">diag_scores</span> <span class="o">=</span> <span class="n">pairwise_features</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">is_diag</span><span class="p">)</span>
    <span class="n">diag_aidxs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">pairwise_aidxs</span><span class="p">,</span> <span class="n">is_diag</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">utool</span>
    <span class="k">with</span> <span class="n">utool</span><span class="o">.</span><span class="n">embed_on_exception_context</span><span class="p">:</span>
        <span class="n">diag_nids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">pairwise_nids</span><span class="p">,</span> <span class="n">is_diag</span><span class="p">)</span>
    <span class="n">diag_labels</span> <span class="o">=</span> <span class="n">pairwise_matches</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">is_diag</span><span class="p">)</span>

    <span class="c">#import utool</span>
    <span class="c">#utool.embed()</span>

    <span class="n">toy_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;aids&#39;</span><span class="p">:</span> <span class="n">aids</span><span class="p">,</span>
        <span class="s">&#39;nids&#39;</span><span class="p">:</span> <span class="n">nids</span><span class="p">,</span>
        <span class="s">&#39;all_nids&#39;</span><span class="p">:</span> <span class="n">all_nids</span><span class="p">,</span>
        <span class="s">&#39;all_aids&#39;</span><span class="p">:</span> <span class="n">all_aids</span><span class="p">,</span>
        <span class="c">#&#39;pairwise_aidxs&#39;: pairwise_aidxs,</span>
        <span class="c">#&#39;pairwise_scores&#39;: pairwise_scores,</span>
        <span class="c">#&#39;pairwise_matches&#39;: pairwise_matches,</span>
        <span class="s">&#39;diag_labels&#39;</span><span class="p">:</span> <span class="n">diag_labels</span><span class="p">,</span>
        <span class="s">&#39;diag_scores&#39;</span><span class="p">:</span> <span class="n">diag_scores</span><span class="p">,</span>
        <span class="s">&#39;diag_nids&#39;</span><span class="p">:</span> <span class="n">diag_nids</span><span class="p">,</span>
        <span class="s">&#39;diag_aidxs&#39;</span><span class="p">:</span> <span class="n">diag_aidxs</span><span class="p">,</span>
        <span class="s">&#39;toy_params&#39;</span><span class="p">:</span> <span class="n">toy_params</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">toy_data</span>

</div>
<span class="nd">@ut.cached_func</span><span class="p">(</span><span class="s">&#39;_toy_learn_prob_score5&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="learn_prob_score"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.learn_prob_score">[docs]</a><span class="k">def</span> <span class="nf">learn_prob_score</span><span class="p">(</span><span class="n">num_scores</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">55</span><span class="p">,</span> <span class="n">ret_enc</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        num_scores (int): (default = 5)</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (discr_domain, discr_p_same)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-learn_prob_score --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; num_scores = 2</span>
<span class="sd">        &gt;&gt;&gt; (discr_domain, discr_p_same, encoder) = learn_prob_score(num_scores, ret_enc=True, use_cache=False)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;discr_p_same = %r&#39; % (discr_p_same,))</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; encoder.visualize()</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_annots_train</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">num_names_train</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">toy_data</span> <span class="o">=</span> <span class="n">get_toy_data_1v1</span><span class="p">(</span><span class="n">num_annots_train</span><span class="p">,</span> <span class="n">num_names_train</span><span class="p">)</span>
    <span class="c">#pairwise_aidxs, pairwise_scores, pairwise_matches = ut.dict_take(</span>
    <span class="c">#    toy_data, &#39;pairwise_aidxs, pairwise_scores, pairwise_matches&#39;.split(&#39;, &#39;))</span>

    <span class="n">diag_scores</span><span class="p">,</span> <span class="n">diag_labels</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span>
        <span class="n">toy_data</span><span class="p">,</span> <span class="s">&#39;diag_scores, diag_labels&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">))</span>
    <span class="c">#is_diag = [r &lt; c for r, c, in pairwise_aidxs]</span>
    <span class="c">#diag_scores = pairwise_scores.compress(is_diag)</span>
    <span class="c">#diag_labels = pairwise_matches.compress(is_diag)</span>

    <span class="c"># Learn P(S_{ij} | M_{ij})</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
    <span class="n">encoder</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ScoreNormalizer</span><span class="p">(</span>
        <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">monotonize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">adjust</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">diag_scores</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">diag_labels</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">ensure_pylab_qt4</span><span class="p">()</span>
        <span class="n">encoder</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>
        <span class="c">#show_toy_distributions()</span>

    <span class="k">def</span> <span class="nf">discretize_probs</span><span class="p">(</span><span class="n">encoder</span><span class="p">):</span>
        <span class="n">p_tp_given_score</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">p_tp_given_score</span> <span class="o">/</span> <span class="n">encoder</span><span class="o">.</span><span class="n">p_tp_given_score</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_tp_given_score</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">pad</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">stride</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">bins</span> <span class="o">/</span> <span class="n">num_scores</span><span class="p">))</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span> <span class="o">+</span> <span class="n">pad</span>
        <span class="n">discr_p_same</span> <span class="o">=</span> <span class="n">p_tp_given_score</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
        <span class="n">discr_p_same</span> <span class="o">=</span> <span class="n">discr_p_same</span> <span class="o">/</span> <span class="n">discr_p_same</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">discr_domain</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">score_domain</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">discr_domain</span><span class="p">,</span> <span class="n">discr_p_same</span>
    <span class="n">discr_domain</span><span class="p">,</span> <span class="n">discr_p_same</span> <span class="o">=</span> <span class="n">discretize_probs</span><span class="p">(</span><span class="n">encoder</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ret_enc</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">discr_domain</span><span class="p">,</span> <span class="n">discr_p_same</span><span class="p">,</span> <span class="n">encoder</span>
    <span class="k">return</span> <span class="n">discr_domain</span><span class="p">,</span> <span class="n">discr_p_same</span>

</div>
<div class="viewcode-block" id="classify_one_new_unknown"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.classify_one_new_unknown">[docs]</a><span class="k">def</span> <span class="nf">classify_one_new_unknown</span><span class="p">():</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Make a model that knows who the previous annots are and tries to classify a new annot</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-classify_one_new_unknown --verbose</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-classify_one_new_unknown --show --verbose --present</span>
<span class="sd">        python3 -m ibeis.algo.hots.demobayes --exec-classify_one_new_unknown --verbose</span>
<span class="sd">        python3 -m ibeis.algo.hots.demobayes --exec-classify_one_new_unknown --verbose --diskshow --verbose --present --save demo5.png --dpath . --figsize=20,10 --dpi=128 --clipwhite</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; result = classify_one_new_unknown()</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">constkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">num_annots</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">name_evidence</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c">#name_evidence=[0, 0, 1, 1, None],</span>
            <span class="c">#name_evidence=[{0: .99}, {0: .99}, {1: .99}, {1: .99}, None],</span>
            <span class="c">#name_evidence=[0, {0: .99}, {1: .99}, 1, None],</span>
        <span class="p">)</span>
        <span class="n">test_model</span><span class="p">(</span><span class="n">score_evidence</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>

    <span class="c">#from ibeis.algo.hots.demobayes import *</span>
    <span class="n">constkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">num_annots</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">evidence</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span>
        <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="c"># lll and llh have strikingly different</span>
        <span class="c"># probability of M marginals</span>
        <span class="n">score_evidence</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">other_evidence</span><span class="o">=</span><span class="p">{</span>
        <span class="p">},</span>
        <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="test_triangle_property"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.test_triangle_property">[docs]</a><span class="k">def</span> <span class="nf">test_triangle_property</span><span class="p">():</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-test_triangle_property --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; result = test_triangle_property()</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">constkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">num_annots</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">name_evidence</span><span class="o">=</span><span class="p">[],</span>
    <span class="p">)</span>
    <span class="n">test_model</span><span class="p">(</span>
        <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">other_evidence</span><span class="o">=</span><span class="p">{</span>
            <span class="s">&#39;Mab&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;Mac&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="c">#&#39;Na&#39;: &#39;fred&#39;,</span>
            <span class="c">#&#39;Nb&#39;: &#39;sue&#39;,</span>
        <span class="p">},</span>
        <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="demo_structure"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.demo_structure">[docs]</a><span class="k">def</span> <span class="nf">demo_structure</span><span class="p">():</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-demo_structure --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; result = demo_structure()</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">constkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">score_evidence</span><span class="o">=</span><span class="p">[],</span> <span class="n">name_evidence</span><span class="o">=</span><span class="p">[],</span> <span class="n">mode</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">model</span><span class="p">,</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span><span class="n">num_annots</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>
    <span class="n">draw_tree_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="make_bayes_notebook"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.make_bayes_notebook">[docs]</a><span class="k">def</span> <span class="nf">make_bayes_notebook</span><span class="p">():</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-make_bayes_notebook</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; result = make_bayes_notebook()</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.templates</span> <span class="kn">import</span> <span class="n">generate_notebook</span>
    <span class="n">initialize</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">codeblock</span><span class="p">(</span>
        <span class="sd">r&#39;&#39;&#39;</span>
<span class="sd">        # STARTBLOCK</span>
<span class="sd">        import os</span>
<span class="sd">        os.environ[&#39;UTOOL_NO_CNN&#39;] = &#39;True&#39;</span>
<span class="sd">        from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        # Matplotlib stuff</span>
<span class="sd">        import matplotlib as mpl</span>
<span class="sd">        %matplotlib inline</span>
<span class="sd">        %load_ext autoreload</span>
<span class="sd">        %autoreload</span>
<span class="sd">        from IPython.core.display import HTML</span>
<span class="sd">        HTML(&quot;&lt;style&gt;body .container { width:99% !important; }&lt;/style&gt;&quot;)</span>
<span class="sd">        # ENDBLOCK</span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="p">)</span>
    <span class="n">cell_list_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">initialize</span><span class="p">,</span>
        <span class="n">show_model_templates</span><span class="p">,</span>
        <span class="n">demo_modes</span><span class="p">,</span>
        <span class="n">demo_name_annot_complexity</span><span class="p">,</span>
        <span class="c">###demo_model_idependencies,</span>
        <span class="n">demo_single_add</span><span class="p">,</span>
        <span class="n">demo_ambiguity</span><span class="p">,</span>
        <span class="n">demo_conflicting_evidence</span><span class="p">,</span>
        <span class="n">demo_annot_idependence_overlap</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">def</span> <span class="nf">format_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_funclike</span><span class="p">(</span><span class="n">cell</span><span class="p">):</span>
            <span class="n">header</span> <span class="o">=</span> <span class="s">&#39;# &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">to_title_caps</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_funcname</span><span class="p">(</span><span class="n">cell</span><span class="p">))</span>
            <span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_func_sourcecode</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">stripdef</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stripret</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">generate_notebook</span><span class="o">.</span><span class="n">format_cells</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

    <span class="n">cell_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">format_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cell_list_def</span><span class="p">])</span>
    <span class="n">nbstr</span> <span class="o">=</span> <span class="n">generate_notebook</span><span class="o">.</span><span class="n">make_notebook</span><span class="p">(</span><span class="n">cell_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;nbstr = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nbstr</span><span class="p">,))</span>
    <span class="n">fpath</span> <span class="o">=</span> <span class="s">&#39;demobayes.ipynb&#39;</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">nbstr</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="show_model_templates"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.show_model_templates">[docs]</a><span class="k">def</span> <span class="nf">show_model_templates</span><span class="p">():</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-show_model_templates</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; result = show_model_templates()</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">make_name_model</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;-------------&#39;</span><span class="p">)</span>
    <span class="n">make_name_model</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="demo_single_add"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.demo_single_add">[docs]</a><span class="k">def</span> <span class="nf">demo_single_add</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This demo shows how a name is assigned to a new annotation.</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-demo_single_add --show --present --mode=1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; demo_single_add()</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Initially there are only two annotations that have a strong match</span>
    <span class="n">name_evidence</span> <span class="o">=</span> <span class="p">[{</span><span class="mi">0</span><span class="p">:</span> <span class="o">.</span><span class="mi">9</span><span class="p">}]</span>  <span class="c"># Soft label</span>
    <span class="n">name_evidence</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c"># Hard label</span>
    <span class="n">test_model</span><span class="p">(</span><span class="n">num_annots</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">score_evidence</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">name_evidence</span><span class="o">=</span><span class="n">name_evidence</span><span class="p">)</span>
    <span class="c"># Adding a new annotation does not change the original probabilites</span>
    <span class="n">test_model</span><span class="p">(</span><span class="n">num_annots</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">score_evidence</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">name_evidence</span><span class="o">=</span><span class="n">name_evidence</span><span class="p">)</span>
    <span class="c"># Adding evidence that Na matches Nc does not influence the probability</span>
    <span class="c"># that Na matches Nb. However the probability that Nb matches Nc goes up.</span>
    <span class="n">test_model</span><span class="p">(</span><span class="n">num_annots</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">score_evidence</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">name_evidence</span><span class="o">=</span><span class="n">name_evidence</span><span class="p">)</span>
    <span class="c"># However, once Nb is scored against Nb that does increase the likelihood</span>
    <span class="c"># that all 3 are fred goes up significantly.</span>
    <span class="n">test_model</span><span class="p">(</span><span class="n">num_annots</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">score_evidence</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
               <span class="n">name_evidence</span><span class="o">=</span><span class="n">name_evidence</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="demo_conflicting_evidence"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.demo_conflicting_evidence">[docs]</a><span class="k">def</span> <span class="nf">demo_conflicting_evidence</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Notice that the number of annotations in the graph does not affect the</span>
<span class="sd">    probability of names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Initialized with two annots. Each are pretty sure they are someone else</span>
    <span class="n">constkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">num_annots</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">score_evidence</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">test_model</span><span class="p">(</span><span class="n">name_evidence</span><span class="o">=</span><span class="p">[{</span><span class="mi">0</span><span class="p">:</span> <span class="o">.</span><span class="mi">9</span><span class="p">},</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="o">.</span><span class="mi">9</span><span class="p">}],</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>
    <span class="c"># Having evidence that they are different increases this confidence.</span>
    <span class="n">test_model</span><span class="p">(</span><span class="n">name_evidence</span><span class="o">=</span><span class="p">[{</span><span class="mi">0</span><span class="p">:</span> <span class="o">.</span><span class="mi">9</span><span class="p">},</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="o">.</span><span class="mi">9</span><span class="p">}],</span> <span class="n">other_evidence</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;Sab&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>
    <span class="c"># However,, confusion is introduced if there is evidence that they are the same</span>
    <span class="n">test_model</span><span class="p">(</span><span class="n">name_evidence</span><span class="o">=</span><span class="p">[{</span><span class="mi">0</span><span class="p">:</span> <span class="o">.</span><span class="mi">9</span><span class="p">},</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="o">.</span><span class="mi">9</span><span class="p">}],</span> <span class="n">other_evidence</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;Sab&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>
    <span class="c"># When Na is forced to be fred, this doesnt change Nbs evaulatation by more</span>
    <span class="c"># than a few points</span>
    <span class="n">test_model</span><span class="p">(</span><span class="n">name_evidence</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="o">.</span><span class="mi">9</span><span class="p">}],</span> <span class="n">other_evidence</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;Sab&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="demo_ambiguity"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.demo_ambiguity">[docs]</a><span class="k">def</span> <span class="nf">demo_ambiguity</span><span class="p">():</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Test what happens when an annotation need to choose between one of two</span>
<span class="sd">    names</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-demo_ambiguity --show --verbose --present</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; result = demo_ambiguity()</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">constkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">num_annots</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">name_evidence</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="c">#name_evidence=[],</span>
        <span class="c">#name_evidence=[{0: &#39;+eps&#39;}, {1: &#39;+eps&#39;}, {2: &#39;+eps&#39;}],</span>
    <span class="p">)</span>
    <span class="n">test_model</span><span class="p">(</span><span class="n">score_evidence</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
               <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="demo_annot_idependence_overlap"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.demo_annot_idependence_overlap">[docs]</a><span class="k">def</span> <span class="nf">demo_annot_idependence_overlap</span><span class="p">():</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Given:</span>
<span class="sd">        * an unknown annotation \d</span>
<span class="sd">        * three annots with the same name (Fred) \a, \b, and \c</span>
<span class="sd">        * \a and \b are near duplicates</span>
<span class="sd">        * (\a and \c) / (\b and \c) are novel views</span>

<span class="sd">    Goal:</span>
<span class="sd">        * If \d matches to \a and \b the probably that \d is Fred should not be</span>
<span class="sd">          much more than if \d matched only \a or only \b.</span>

<span class="sd">        * The probability that \d is Fred given it matches to any of the 3 annots</span>
<span class="sd">           alone should be equal</span>

<span class="sd">            P(\d is Fred | Mad=1) = P(\d is Fred | Mbd=1) = P(\d is Fred | Mcd=1)</span>

<span class="sd">        * The probability that \d is fred given two matches to any of those two annots</span>
<span class="sd">          should be greater than the probability given only one.</span>

<span class="sd">            P(\d is Fred | Mad=1, Mbd=1) &gt; P(\d is Fred | Mad=1)</span>
<span class="sd">            P(\d is Fred | Mad=1, Mcd=1) &gt; P(\d is Fred | Mad=1)</span>

<span class="sd">        * The probability that \d is fred given matches to two near duplicate</span>
<span class="sd">          matches should be less than</span>
<span class="sd">          if \d matches two non-duplicate matches.</span>

<span class="sd">            P(\d is Fred | Mad=1, Mcd=1) &gt; P(\d is Fred | Mad=1, Mbd=1)</span>

<span class="sd">        * The probability that \d is fred given two near duplicates should be only epsilon greater than</span>
<span class="sd">          a match to either one individually.</span>

<span class="sd">            P(\d is Fred | Mad=1, Mbd=1) = P(\d is Fred | Mad=1) + \epsilon</span>

<span class="sd">    Method:</span>

<span class="sd">        We need to model the fact that there are other causes that create the</span>
<span class="sd">        effect of a high score.  Namely, near duplicates.</span>
<span class="sd">        This can be done by adding an extra conditional that score depends on</span>
<span class="sd">        if they match as well as if they are near duplicates.</span>

<span class="sd">        P(S_ij | Mij) --&gt; P(S_ij | Mij, Dij)</span>

<span class="sd">        where</span>

<span class="sd">        Dij is a random variable indicating if the image is a near duplicate.</span>

<span class="sd">        We can model this as an independant variable</span>

<span class="sd">        P(Dij) = {True: .5, False: .5}</span>

<span class="sd">        or as depending on if the names match.</span>

<span class="sd">        P(Dij | Mij) = {&#39;same&#39;: {True: .5, False: .5} diff: {True: 0, False 1}}</span>



<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-demo_annot_idependence_overlap --verbose --present --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; result = demo_annot_idependence_overlap()</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># We will end up making annots a and b fred and c and d sue</span>
    <span class="n">constkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">num_annots</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">name_evidence</span><span class="o">=</span><span class="p">[{</span><span class="mi">0</span><span class="p">:</span> <span class="s">&#39;+eps&#39;</span><span class="p">},</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s">&#39;+eps&#39;</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="s">&#39;+eps&#39;</span><span class="p">},</span> <span class="p">{</span><span class="mi">3</span><span class="p">:</span> <span class="s">&#39;+eps&#39;</span><span class="p">}],</span>
        <span class="c">#name_evidence=[{0: .9}, None, None, {1: .9}]</span>
        <span class="c">#name_evidence=[0, None, None, None]</span>
        <span class="c">#name_evidence=[0, None, None, None]</span>
    <span class="p">)</span>
    <span class="n">test_model</span><span class="p">(</span><span class="n">score_evidence</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>
    <span class="n">test_model</span><span class="p">(</span><span class="n">score_evidence</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>
    <span class="n">test_model</span><span class="p">(</span><span class="n">score_evidence</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="demo_modes"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.demo_modes">[docs]</a><span class="k">def</span> <span class="nf">demo_modes</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Look at the last result of the different names demo under differet modes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">constkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">num_annots</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">score_evidence</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="c">#name_evidence=[{0: .9}, None, None, {1: .9}],</span>
        <span class="c">#name_evidence=[0, None, None, 1],</span>
        <span class="n">name_evidence</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>
        <span class="c">#other_evidence={</span>
        <span class="c">#    &#39;Sad&#39;: 0,</span>
        <span class="c">#    &#39;Sab&#39;: 1,</span>
        <span class="c">#    &#39;Scd&#39;: 1,</span>
        <span class="c">#    &#39;Sac&#39;: 0,</span>
        <span class="c">#    &#39;Sbc&#39;: 0,</span>
        <span class="c">#    &#39;Sbd&#39;: 0,</span>
        <span class="c">#}</span>
    <span class="p">)</span>
    <span class="c"># The first mode uses a hidden Match layer</span>
    <span class="n">test_model</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>
    <span class="c"># The second mode directly maps names to scores</span>
    <span class="n">test_model</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>
    <span class="n">test_model</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">noquery</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>
    <span class="n">test_model</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">noquery</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="demo_name_annot_complexity"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.demo_name_annot_complexity">[docs]</a><span class="k">def</span> <span class="nf">demo_name_annot_complexity</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This demo is meant to show the structure of the graph as more annotations</span>
<span class="sd">    and names are added.</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-demo_name_annot_complexity --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; demo_name_annot_complexity()</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">constkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">score_evidence</span><span class="o">=</span><span class="p">[],</span> <span class="n">name_evidence</span><span class="o">=</span><span class="p">[],</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c"># Initially there are 2 annots and 4 names</span>
    <span class="n">model</span><span class="p">,</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span><span class="n">num_annots</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>
    <span class="n">draw_tree_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="c"># Adding a name causes the probability of the other names to go down</span>
    <span class="n">model</span><span class="p">,</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span><span class="n">num_annots</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>
    <span class="n">draw_tree_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="c"># Adding an annotation wihtout matches dos not effect probabilities of</span>
    <span class="c"># names</span>
    <span class="n">model</span><span class="p">,</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span><span class="n">num_annots</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>
    <span class="n">draw_tree_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">model</span><span class="p">,</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span><span class="n">num_annots</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>
    <span class="n">draw_tree_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="c"># Given A annots, the number of score nodes is (A ** 2 - A) / 2</span>
    <span class="n">model</span><span class="p">,</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span><span class="n">num_annots</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">constkw</span><span class="p">)</span>
    <span class="n">draw_tree_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="c">#model, = test_model(num_annots=6, num_names=5, score_evidence=[], name_evidence=[], mode=1)</span>
    <span class="c">#draw_tree_model(model)</span>

</div>
<div class="viewcode-block" id="demo_model_idependencies"><a class="viewcode-back" href="../../../../ibeis.algo.hots.html#ibeis.algo.hots.demobayes.demo_model_idependencies">[docs]</a><span class="k">def</span> <span class="nf">demo_model_idependencies</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Independences of the 3 annot 3 name model</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-demo_model_idependencies --mode=1 --num-names=2 --show</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --exec-demo_model_idependencies --mode=2</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.algo.hots.demobayes import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; result = demo_model_idependencies()</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_names</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argval</span><span class="p">(</span><span class="s">&#39;--num-names&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span><span class="n">num_annots</span><span class="o">=</span><span class="n">num_names</span><span class="p">,</span> <span class="n">num_names</span><span class="o">=</span><span class="n">num_names</span><span class="p">,</span> <span class="n">score_evidence</span><span class="o">=</span><span class="p">[],</span> <span class="n">name_evidence</span><span class="o">=</span><span class="p">[])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c"># This model has the following independenceis</span>
    <span class="n">idens</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_independencies</span><span class="p">()</span>

    <span class="n">iden_strs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">iden</span><span class="o">.</span><span class="n">event1</span><span class="p">))</span> <span class="o">+</span>
                 <span class="s">&#39; _L &#39;</span> <span class="o">+</span>
                 <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">iden</span><span class="o">.</span><span class="n">event2</span><span class="p">))</span> <span class="o">+</span>
                 <span class="s">&#39; | &#39;</span> <span class="o">+</span>
                 <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">iden</span><span class="o">.</span><span class="n">event3</span><span class="p">))</span>
                 <span class="k">for</span> <span class="n">iden</span> <span class="ow">in</span> <span class="n">idens</span><span class="o">.</span><span class="n">independencies</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;general idependencies&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">iden_strs</span><span class="p">)),</span> <span class="s">&#39;_&#39;</span><span class="p">),</span> <span class="s">&#39;|&#39;</span><span class="p">))</span>
    <span class="c">#ut.embed()</span>
    <span class="c">#model.is_active_trail(&#39;Na&#39;, &#39;Nb&#39;, &#39;Sab&#39;)</span>

<span class="c"># Might not be valid, try and collapse S and M</span>
<span class="c">#xs = list(map(str, idens.independencies))</span>
<span class="c">#import re</span>
<span class="c">#xs = [re.sub(&#39;, M..&#39;, &#39;&#39;, x) for x in xs]</span>
<span class="c">#xs = [re.sub(&#39;M..,?&#39;, &#39;&#39;, x) for x in xs]</span>
<span class="c">#xs = [x for x in xs if not x.startswith(&#39;( _&#39;)]</span>
<span class="c">#xs = [x for x in xs if not x.endswith(&#39;| )&#39;)]</span>
<span class="c">#print(&#39;\n&#39;.join(sorted(list(set(xs)))))</span>

</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes</span>
<span class="sd">        python -m ibeis.algo.hots.demobayes --allexamples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[hs] demobayes&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>  <span class="c"># NOQA</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Jon Crall.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'1.5.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>